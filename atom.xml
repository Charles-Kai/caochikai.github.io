<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>天道酬勤</title>
  
  <subtitle>劳逸结合</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://caochikai.github.io/"/>
  <updated>2021-08-15T08:45:24.212Z</updated>
  <id>https://caochikai.github.io/</id>
  
  <author>
    <name>ChiKai</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>日志体系</title>
    <link href="https://caochikai.github.io/2021/08/15/%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB/"/>
    <id>https://caochikai.github.io/2021/08/15/%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB/</id>
    <published>2021-08-15T08:41:00.000Z</published>
    <updated>2021-08-15T08:45:24.212Z</updated>
    
    <content type="html"><![CDATA[<h1 id="日志体系"><a href="#日志体系" class="headerlink" title="日志体系"></a>日志体系</h1><table><thead><tr><th>主题</th><th>关注点</th></tr></thead><tbody><tr><td>公共日志库starter</td><td>初始化标准日志行为</td></tr><tr><td>基础日志框架</td><td>SLF4J作为日志门面。<br/>logback是spring提供的默认实现。<br/>Log4j2可以代替logback，通过依赖更新。</td></tr><tr><td>日志实现</td><td>SpringBoot可以配置细粒度日志配置。<br/>默认日志是INFO，包括打印WARN和ERROR级别。<br/>生成环境不可开启debug级别日志。<br/>TraceID必须在每个日志出现。</td></tr><tr><td>日志配置</td><td>公共库提供了common appender 配置。<br/>Debug和Error必须进入严格日志，INFO和WARN使用正常日志即可。</td></tr><tr><td>日志追踪</td><td>日志追踪支持Servlet阻塞式和异步模式，响应式reactive编程。</td></tr></tbody></table><h1 id="日志库"><a href="#日志库" class="headerlink" title="日志库"></a>日志库</h1><table><thead><tr><th>功能</th><th>描述</th></tr></thead><tbody><tr><td>自动配置</td><td>通过Springboot自动配置完成日志自动配置，提供给公共配置。</td></tr><tr><td>Logback</td><td>Logback应该使用，由springboot默认提供，是目前非常推荐的日志框架。</td></tr><tr><td>Code with SLF4J</td><td>SLF4J classes应该在平时开发作为日志门面，当我们切换日志实现框架，将不会影响代码。</td></tr><tr><td>TraceID</td><td>TraceID通过UUID生成，每一次打印日志自动带上，</td></tr><tr><td>打印日志格式</td><td>如果Http header没有携带TraceID，在filter里面自动生成到header。</td></tr><tr><td>默认日志过滤器</td><td>在公共库提供filter打印请求花费时间，记录聚合服务和调用基础服务的时间开销，调用开始记录时间start和traceId，调用结束时候记录finish结束时间和HTTP Status，同时支持Servlet和reactive。</td></tr><tr><td>MDC</td><td>MDC提供公共的日志信息在logging context，在线程的局部本地变量，跨线程或者异步多线程时候应复制上下文。</td></tr><tr><td></td><td></td></tr></tbody></table><h1 id="日志规范"><a href="#日志规范" class="headerlink" title="日志规范"></a>日志规范</h1><blockquote><p>Fitler中强制生成TraceID，并注入到MDC日志上下文，并调用时间统计。</p></blockquote><h3 id="前后端error-schema"><a href="#前后端error-schema" class="headerlink" title="前后端error schema"></a>前后端error schema</h3><blockquote><p>后端日志必须打印TraceId，但发生error接口返回TraceId，根据固定的error JSON schema给前端放在报错页面指导用户找客服反馈时候，一定要提供该TraceId和Code。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"errorInfo"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"traceId"</span>: <span class="string">"53cb73a6-f594-4af6-b406-172b3b4e9dd5"</span>,</span><br><span class="line">      <span class="attr">"code"</span>: <span class="string">"RAML_1002"</span>,</span><br><span class="line">      <span class="attr">"causes"</span>: [</span><br><span class="line">        <span class="string">"Missing 'version'"</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Servlet日志过滤器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.AsyncEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.AsyncListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletLoggingRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ServletLoggingRequestFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_TRACE_ID = <span class="string">"Request-Trace-Id"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        CacheHeaderHTTPServletRequest cacheHeaderHTTPServletRequest = <span class="keyword">new</span> CacheHeaderHTTPServletRequest(request);</span><br><span class="line">        LocalDateTime startTime = LocalDateTime.now();</span><br><span class="line">        String traceId = cacheHeaderHTTPServletRequest.getHeader(REQUEST_TRACE_ID);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (traceId == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//生成traceId </span></span><br><span class="line">            traceId = UUID.randomUUID().toString();</span><br><span class="line">            cacheHeaderHTTPServletRequest.putHeaders(REQUEST_TRACE_ID, traceId);;</span><br><span class="line">            MDC.put(REQUEST_TRACE_ID, traceId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">"start=&#123;&#125; traceId=&#123;&#125;"</span>, startTime, traceId);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, String&gt; contextMap = MDC.getCopyOfContextMap();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filterChain.doFilter(cacheHeaderHTTPServletRequest, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cacheHeaderHTTPServletRequest.isAsyncStarted() &amp;&amp; cacheHeaderHTTPServletRequest.isAsyncSupported()) &#123;</span><br><span class="line">                cacheHeaderHTTPServletRequest.getAsyncContext().addListener(<span class="keyword">new</span> AsyncListener() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        exitLog(contextMap, startTime, response);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeout</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        exitLog(contextMap, startTime, response);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        exitLog(contextMap, startTime, response);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartAsync</span><span class="params">(AsyncEvent event)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                exitLog(contextMap, startTime, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exitLog</span><span class="params">(Map&lt;String, String&gt; contextMap, LocalDateTime startTime, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        MDC.setContextMap(contextMap);</span><br><span class="line">        LocalDateTime endDateTime = LocalDateTime.now();</span><br><span class="line">        <span class="keyword">long</span> betweenTime = Duration.between(startTime, endDateTime).toMillis();</span><br><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(<span class="string">"finish=&#123;&#125; status=&#123;&#125;"</span>, betweenTime, response.getStatus());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Reactive日志过滤器"><a href="#Reactive日志过滤器" class="headerlink" title="Reactive日志过滤器"></a><strong>Reactive日志过滤器</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.WebFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactiveLoggingRequestFilter</span> <span class="keyword">implements</span> <span class="title">WebFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ReactiveLoggingRequestFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_TRACE_ID = <span class="string">"Request-Trace-Id"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> reactor.core.publisher.<span class="function">Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> </span>&#123;</span><br><span class="line">        LocalDateTime startTime = LocalDateTime.now();</span><br><span class="line">        List&lt;String&gt; traceIds = exchange.getRequest().getHeaders().get(REQUEST_TRACE_ID);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(traceIds)) &#123;</span><br><span class="line">            String traceId = UUID.randomUUID().toString();</span><br><span class="line">            traceIds = Collections.singletonList(traceId);</span><br><span class="line">            exchange.getRequest().getHeaders().put(REQUEST_TRACE_ID, traceIds);</span><br><span class="line">            MDC.put(REQUEST_TRACE_ID, traceId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; finalTraceIds = traceIds;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).doOnSubscribe(subscription -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">"start=&#123;&#125; traceId=&#123;&#125;"</span>, startTime, finalTraceIds.get(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).doFinally(signalType -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> status = Objects.requireNonNull(exchange.getResponse().getStatusCode()).value();</span><br><span class="line">            LocalDateTime endDateTime = LocalDateTime.now();</span><br><span class="line">            <span class="keyword">long</span> betweenTime = Duration.between(startTime, endDateTime).toMillis();</span><br><span class="line">            <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">                log.info(<span class="string">"finish=&#123;&#125; status=&#123;&#125;"</span>, betweenTime, status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="敏感数据日志"><a href="#敏感数据日志" class="headerlink" title="敏感数据日志"></a>敏感数据日志</h3><blockquote><p>敏感数据不能记录在WARN和INFO级别日志。用*星号代替敏感数据的打印。如果对排查故障没有任何帮助，开发人员一定要谨慎打印。</p></blockquote><h1 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h1><h3 id="日志模板"><a href="#日志模板" class="headerlink" title="日志模板"></a>日志模板</h3><table><thead><tr><th>格式</th><th>配置</th><th>例子值</th><th>目的</th></tr></thead><tbody><tr><td>${TIMESTAMP}</td><td>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint}</td><td>2021-08-15 15:58:51.772</td><td>执行时间戳</td></tr><tr><td>${LOG_LEVEL_PATTERN}</td><td>%clr(-%5p})</td><td>DEBUG</td><td>日志级别</td></tr><tr><td>${TraceId}</td><td>%clr(tId=%mdc{Request-Trace-Id})</td><td>7375176b-715d-408d-b255-eea662ee056</td><td>可追踪ID</td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="log-example"><a href="#log-example" class="headerlink" title="log example"></a>log example</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">36.552</span> DEBUG <span class="number">10896</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>]  tId=<span class="number">7375176</span>b-<span class="number">715</span>d-<span class="number">408</span>d-b255-eea662ee0565 Writing [com.example.demo.raml.ErrorPayload@<span class="number">793475</span>a7[]]</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">36.564</span> DEBUG <span class="number">10896</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>]  tId=<span class="number">7375176</span>b-<span class="number">715</span>d-<span class="number">408</span>d-b255-eea662ee0565 Resolved [com.example.demo.raml.RequestContextException: Missing <span class="string">'version'</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">36.564</span> DEBUG <span class="number">10896</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>]  tId=<span class="number">7375176</span>b-<span class="number">715</span>d-<span class="number">408</span>d-b255-eea662ee0565 Completed <span class="number">400</span> BAD_REQUEST</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">15</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">36.565</span>  INFO <span class="number">10896</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>]  tId=<span class="number">7375176</span>b-<span class="number">715</span>d-<span class="number">408</span>d-b255-eea662ee0565 finish=<span class="number">64</span> status=<span class="number">400</span>xml</span><br></pre></td></tr></table></figure><h4 id="logback-spring-xml"><a href="#logback-spring-xml" class="headerlink" title="logback-spring.xml"></a>logback-spring.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志级别从低到高分为TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL，如果设置为WARN，则低于WARN的信息都不会输出 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scan:当此属性设置为true时，配置文档如果发生改变，将会被重新加载，默认值为true --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scanPeriod:设置监测配置文档是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。</span></span><br><span class="line"><span class="comment">                 当scan为true时，此属性生效。默认的时间间隔为1分钟。 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- de<span class="doctag">bug:</span>当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>  <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"10 seconds"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>logback<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- name的值是变量的名称，value的值时变量定义的值。通过定义的值会被插入到logger上下文中。定义后，可以使“$&#123;&#125;”来使用变量。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"log.path"</span> <span class="attr">value</span>=<span class="string">"/logs"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--0. 日志格式和颜色渲染 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志依赖的渲染类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"clr"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.ColorConverter"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"wex"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"wEx"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"TraceId"</span> <span class="attr">value</span>=<span class="string">"%clr(tId=%mdc&#123;Request-Trace-Id&#125;)"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志格式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"CONSOLE_LOG_PATTERN"</span> <span class="attr">value</span>=<span class="string">"$&#123;CONSOLE_LOG_PATTERN:-%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125;  $&#123;TraceId&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125; &#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--1. 输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--此日志appender是为开发使用，只配置最底级别，控制台输出的日志级别是大于或等于此级别的日志信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--2. 输出到文档--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2.1 level为 DEBUG 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"DEBUG_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/web_debug.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 日志归档 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-debug-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录debug级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.2 level为 INFO 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"INFO_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/web_info.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 每天日志归档路径以及格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-info-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>info<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.3 level为 WARN 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"WARN_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/web_warn.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-warn-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录warn级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.4 level为 ERROR 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ERROR_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/web_error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-error-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录ERROR级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;logger&gt;用来设置某一个包或者具体的某一个类的日志打印级别、</span></span><br><span class="line"><span class="comment">        以及指定&lt;appender&gt;。&lt;logger&gt;仅有一个name属性，</span></span><br><span class="line"><span class="comment">        一个可选的level和一个可选的addtivity属性。</span></span><br><span class="line"><span class="comment">        name:用来指定受此logger约束的某一个包或者具体的某一个类。</span></span><br><span class="line"><span class="comment">        level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，</span></span><br><span class="line"><span class="comment">              还有一个特俗值INHERITED或者同义词NULL，代表强制执行上级的级别。</span></span><br><span class="line"><span class="comment">              如果未设置此属性，那么当前logger将会继承上级的级别。</span></span><br><span class="line"><span class="comment">        addtivity:是否向上级logger传递打印信息。默认是true。</span></span><br><span class="line"><span class="comment">        &lt;logger name="org.springframework.web" level="info"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;logger name="org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor" level="INFO"/&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        使用mybatis的时候，sql语句是debug下才会打印，而这里我们只配置了info，所以想要查看sql语句的话，有以下两种操作：</span></span><br><span class="line"><span class="comment">        第一种把&lt;root level="info"&gt;改成&lt;root level="DEBUG"&gt;这样就会打印sql，不过这样日志那边会出现很多其他消息</span></span><br><span class="line"><span class="comment">        第二种就是单独给dao下目录配置debug模式，代码如下，这样配置sql语句会打印，其他还是正常info级别：</span></span><br><span class="line"><span class="comment">        【logging.level.org.mybatis=debug logging.level.dao=debug】</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        root节点是必选节点，用来指定最基础的日志输出级别，只有一个level属性</span></span><br><span class="line"><span class="comment">        level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，</span></span><br><span class="line"><span class="comment">        不能设置为INHERITED或者同义词NULL。默认是DEBUG</span></span><br><span class="line"><span class="comment">        可以包含零个或多个元素，标识这个appender将会添加到这个logger。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4. 最终的策略 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 4.1 开发环境:打印控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.sdcm.pmp"</span> <span class="attr">level</span>=<span class="string">"debug"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"DEBUG_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"INFO_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"WARN_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR_FILE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4.2 生产环境:输出到文档</span></span><br><span class="line"><span class="comment">    &lt;springProfile name="pro"&gt;</span></span><br><span class="line"><span class="comment">        &lt;root level="info"&gt;</span></span><br><span class="line"><span class="comment">            &lt;appender-ref ref="CONSOLE" /&gt;</span></span><br><span class="line"><span class="comment">            &lt;appender-ref ref="DEBUG_FILE" /&gt;</span></span><br><span class="line"><span class="comment">            &lt;appender-ref ref="INFO_FILE" /&gt;</span></span><br><span class="line"><span class="comment">            &lt;appender-ref ref="ERROR_FILE" /&gt;</span></span><br><span class="line"><span class="comment">            &lt;appender-ref ref="WARN_FILE" /&gt;</span></span><br><span class="line"><span class="comment">        &lt;/root&gt;</span></span><br><span class="line"><span class="comment">    &lt;/springProfile&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://www.cnblogs.com/mahoshojo/p/12920473.html" target="_blank" rel="noopener">logback-spring.xml配置 - mahoshojo - 博客园</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener"><strong>配套代码</strong></a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;日志体系&quot;&gt;&lt;a href=&quot;#日志体系&quot; class=&quot;headerlink&quot; title=&quot;日志体系&quot;&gt;&lt;/a&gt;日志体系&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;主题&lt;/th&gt;
&lt;th&gt;关注点&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbo
      
    
    </summary>
    
    
      <category term="架构" scheme="https://caochikai.github.io/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="架构" scheme="https://caochikai.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot异常处理体系</title>
    <link href="https://caochikai.github.io/2021/08/14/SpringBoot%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%BD%93%E7%B3%BB/"/>
    <id>https://caochikai.github.io/2021/08/14/SpringBoot%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%BD%93%E7%B3%BB/</id>
    <published>2021-08-14T14:56:00.000Z</published>
    <updated>2021-08-14T15:09:07.806Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBoot异常处理体系"><a href="#SpringBoot异常处理体系" class="headerlink" title="SpringBoot异常处理体系"></a>SpringBoot异常处理体系</h1><blockquote><p>在SpringMVC中通过组合使用注解@ControllerAdvice、@ModelAttribute和@InitBinder(“b)，配合 HandlerExceptionResolver作为全局性的定制。包括 Handler 映射、数据绑定以及目标方法执行时发生的异<br>常。</p></blockquote><ul><li><code>@ExceptionHandler</code>：统一的异常处理控制器方法</li><li><code>@ModelAttribute</code>：共用方法添加渲染视图的数据模型属性</li><li><code>@InitBinder</code>：共用方法初始化控制器方法调用使用的数据绑定器</li></ul><h3 id="异常默认规则"><a href="#异常默认规则" class="headerlink" title="异常默认规则"></a>异常默认规则</h3><ul><li>默认情况下，Spring Boot提供<code>/error</code>处理所有错误的映射</li><li>对于机器客户端，它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息。对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据</li><li>要完全替换默认行为，可以实现 ErrorController 并注册该类型的Bean定义，或添加ErrorAttributes类型的组件以使用现有机制但替换其内容，或添加(templates/static)/error/(4xx|5xx)页面会被自动解析；我们内部就自定义实现了ErrorController</li></ul><p><strong>浏览器客户端：Content-Type: text/html;charset=UTF-8</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8080/api/xx</span><br><span class="line"></span><br><span class="line">HTTP/1.1 404 </span><br><span class="line">Vary: Origin</span><br><span class="line">Vary: Access-Control-Request-Method</span><br><span class="line">Vary: Access-Control-Request-Headers</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Content-Language: zh-CN</span><br><span class="line">Content-Length: 286</span><br><span class="line">Date: Sat, 14 Aug 2021 09:41:34 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;This application has no explicit mapping <span class="keyword">for</span> /error, so you are seeing this as a fallback.&lt;/p&gt;</span><br><span class="line">&lt;div id=<span class="string">'created'</span>&gt;Sat Aug 14 17:41:34 CST 2021&lt;/div&gt;</span><br><span class="line">&lt;div&gt;There was an unexpected error (<span class="built_in">type</span>=Not Found, status=404).&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><strong>机器客户端：Content-Type: application/json</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:8080/api/xx</span><br><span class="line"></span><br><span class="line">HTTP/1.1 404 </span><br><span class="line">Vary: Origin</span><br><span class="line">Vary: Access-Control-Request-Method</span><br><span class="line">Vary: Access-Control-Request-Headers</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, 14 Aug 2021 09:42:44 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"timestamp"</span>: <span class="string">"2021-08-14T09:42:44.755+00:00"</span>,</span><br><span class="line">  <span class="string">"status"</span>: 404,</span><br><span class="line">  <span class="string">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="string">"message"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"path"</span>: <span class="string">"/api/xx"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="异常处理自动配置原理"><a href="#异常处理自动配置原理" class="headerlink" title="异常处理自动配置原理"></a>异常处理自动配置原理</h2><ul><li>ErrorMvcAutoConfiguration 自动配置异常处理规则</li><li><strong>DefaultErrorAttributes</strong>定义错误页面中可以包含哪些数据。</li><li><strong>BasicErrorController</strong> 定义JSON（<strong>Content-Type: application/json</strong>）和白页Whitelabel Error Page（<strong>Content-Type: text/html</strong>）两种适配响应。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">**<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultErrorAttributes</span> <span class="keyword">implements</span> <span class="title">ErrorAttributes</span>**, **<span class="title">HandlerExceptionResolver</span></span>&#123;</span><br><span class="line">...**包含哪些数据。</span><br><span class="line">**<span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, ErrorAttributeOptions options)</span> </span>&#123;</span><br><span class="line">Map&lt;String, Object&gt; errorAttributes = getErrorAttributes(webRequest, options.isIncluded(Include.STACK_TRACE));</span><br><span class="line"><span class="keyword">if</span> (Boolean.TRUE.equals(<span class="keyword">this</span>.includeException)) &#123;</span><br><span class="line">options = options.including(Include.EXCEPTION);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!options.isIncluded(Include.EXCEPTION)) &#123;</span><br><span class="line">errorAttributes.remove(<span class="string">"exception"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!options.isIncluded(Include.STACK_TRACE)) &#123;</span><br><span class="line">errorAttributes.remove(<span class="string">"trace"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!options.isIncluded(Include.MESSAGE) &amp;&amp; errorAttributes.get(<span class="string">"message"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">errorAttributes.put(<span class="string">"message"</span>, <span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!options.isIncluded(Include.BINDING_ERRORS)) &#123;</span><br><span class="line">errorAttributes.remove(<span class="string">"errors"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> errorAttributes;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;**</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)<span class="comment">//server.error.path配置可自定义error路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span> </span>&#123;</span><br><span class="line">...定义白页（**Content-Type: text/html**）适配响应。</span><br><span class="line"><span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">HttpStatus status = getStatus(request);</span><br><span class="line">Map&lt;String, Object&gt; model = Collections</span><br><span class="line">.unmodifiableMap(getErrorAttributes(request, getErrorAttributeOptions(request, MediaType.TEXT_HTML)));</span><br><span class="line">response.setStatus(status.value());</span><br><span class="line">ModelAndView modelAndView = resolveErrorView(request, response, status, model);</span><br><span class="line"><span class="keyword">return</span> (modelAndView != <span class="keyword">null</span>) ? modelAndView : <span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">resolveErrorView</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HttpStatus status,</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line"><span class="comment">//org.springframework.boot.autoconfigure.web.servlet.error.DefaultErrorViewResolver是默认error视图解析器</span></span><br><span class="line"><span class="keyword">for</span> (ErrorViewResolver resolver : <span class="keyword">this</span>.errorViewResolvers) &#123;</span><br><span class="line">ModelAndView modelAndView = resolver.resolveErrorView(request, status, model);</span><br><span class="line"><span class="keyword">if</span> (modelAndView != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//json（**Content-Type: application/json**）适配响应。</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">HttpStatus status = getStatus(request);</span><br><span class="line"><span class="keyword">if</span> (status == HttpStatus.NO_CONTENT) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(status);</span><br><span class="line">&#125;</span><br><span class="line">Map&lt;String, Object&gt; body = getErrorAttributes(request, getErrorAttributeOptions(request, MediaType.ALL));</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(body, status);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration.StaticView：处理白页error内容来源</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">###Simple View implementation that writes a default HTML error page.</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticView</span> <span class="keyword">implements</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType TEXT_HTML_UTF8 = <span class="keyword">new</span> MediaType(<span class="string">"text"</span>, <span class="string">"html"</span>, StandardCharsets.UTF_8);</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">String message = getMessage(model);</span><br><span class="line">logger.error(message);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">response.setContentType(TEXT_HTML_UTF8.toString());</span><br><span class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">Object timestamp = model.get(<span class="string">"timestamp"</span>);</span><br><span class="line">Object message = model.get(<span class="string">"message"</span>);</span><br><span class="line">Object trace = model.get(<span class="string">"trace"</span>);</span><br><span class="line"><span class="keyword">if</span> (response.getContentType() == <span class="keyword">null</span>) &#123;</span><br><span class="line">response.setContentType(getContentType());</span><br><span class="line">&#125;</span><br><span class="line">builder.append(<span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;"</span>).append(</span><br><span class="line"><span class="string">"&lt;p&gt;This application has no explicit mapping for /error, so you are seeing this as a fallback.&lt;/p&gt;"</span>)</span><br><span class="line">.append(<span class="string">"&lt;div id='created'&gt;"</span>).append(timestamp).append(<span class="string">"&lt;/div&gt;"</span>)</span><br><span class="line">.append(<span class="string">"&lt;div&gt;There was an unexpected error (type="</span>).append(htmlEscape(model.get(<span class="string">"error"</span>)))</span><br><span class="line">.append(<span class="string">", status="</span>).append(htmlEscape(model.get(<span class="string">"status"</span>))).append(<span class="string">").&lt;/div&gt;"</span>);</span><br><span class="line"><span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">builder.append(<span class="string">"&lt;div&gt;"</span>).append(htmlEscape(message)).append(<span class="string">"&lt;/div&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (trace != <span class="keyword">null</span>) &#123;</span><br><span class="line">builder.append(<span class="string">"&lt;div style='white-space:pre-wrap;'&gt;"</span>).append(htmlEscape(trace)).append(<span class="string">"&lt;/div&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">builder.append(<span class="string">"&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line">response.getWriter().append(builder.toString());</span><br><span class="line">&#125;</span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure><ul><li>org.springframework.boot.autoconfigure.web.servlet.error.DefaultErrorViewResolver</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用status code和status series在'/error'下搜索模板和静态资产。</span></span><br><span class="line"><span class="comment">//例如， HTTP 404将搜索（按特定顺序）：</span></span><br><span class="line"><span class="comment">//'/&lt;templates&gt;/error/404.&lt;ext&gt;'</span></span><br><span class="line"><span class="comment">//'/&lt;static&gt;/error/404.html'</span></span><br><span class="line"><span class="comment">//'/&lt;templates&gt;/error/4xx.&lt;ext&gt;'</span></span><br><span class="line"><span class="comment">//'/&lt;static&gt;/error/4xx.html'</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultErrorViewResolver</span> <span class="keyword">implements</span> <span class="title">ErrorViewResolver</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveErrorView</span><span class="params">(HttpServletRequest request, HttpStatus status, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">ModelAndView modelAndView = resolve(String.valueOf(status.value()), model);</span><br><span class="line"><span class="keyword">if</span> (modelAndView == <span class="keyword">null</span> &amp;&amp; SERIES_VIEWS.containsKey(status.series())) &#123;</span><br><span class="line"><span class="comment">//处理不同状态码的视图</span></span><br><span class="line">modelAndView = resolve(SERIES_VIEWS.get(status.series()), model);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">resolve</span><span class="params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line"><span class="comment">//**拼接不同错误HTTP状态码的视图名称，比如error/500.html**</span></span><br><span class="line">String errorViewName = <span class="string">"error/"</span> + viewName;</span><br><span class="line">TemplateAvailabilityProvider provider = <span class="keyword">this</span>.templateAvailabilityProviders.getProvider(errorViewName,</span><br><span class="line"><span class="keyword">this</span>.applicationContext);</span><br><span class="line"><span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(errorViewName, model);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> resolveResource(errorViewName, model);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">resolveResource</span><span class="params">(String viewName, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (String location : <span class="keyword">this</span>.resources.getStaticLocations()) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//**获取静态资源返回**</span></span><br><span class="line">Resource resource = <span class="keyword">this</span>.applicationContext.getResource(location);</span><br><span class="line">resource = resource.createRelative(viewName + <span class="string">".html"</span>);</span><br><span class="line"><span class="keyword">if</span> (resource.exists()) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="keyword">new</span> HtmlResourceView(resource), model);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="异常处理步骤"><a href="#异常处理步骤" class="headerlink" title="异常处理步骤"></a>异常处理步骤</h2><ol><li>执行目标方法有任何异常都会被catch Exception和Throwable，并且用NestedServletException <strong>dispatchException</strong>包装异常</li><li>进入视图解析的<strong>processDispatchResult</strong>方法</li><li>执行异常处理#processHandlerException方法，找不到可处理的异常处理器，将会继续抛出异常，最终触发Servlet携带异常信息转发请求/error，进入上面提到的<strong>BasicErrorController</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">doInvoke:<span class="number">192</span>, InvocableHandlerMethod (org.springframework.web.method.support)</span><br><span class="line">invokeForRequest:<span class="number">141</span>, InvocableHandlerMethod (org.springframework.web.method.support)</span><br><span class="line">invokeAndHandle:<span class="number">106</span>, ServletInvocableHandlerMethod (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">invokeHandlerMethod:<span class="number">894</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handleInternal:<span class="number">808</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)</span><br><span class="line">handle:<span class="number">87</span>, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)</span><br><span class="line">doDispatch:<span class="number">1060</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:<span class="number">962</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:<span class="number">1006</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:<span class="number">898</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">626</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">883</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">733</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="DispatcherServlet"><a href="#DispatcherServlet" class="headerlink" title="DispatcherServlet"></a><strong>DispatcherServlet</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">FrameworkServlet</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// Determine handler for the current request.</span></span><br><span class="line">mappedHandler = getHandler(processedRequest);</span><br><span class="line"><span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">noHandlerFound(processedRequest, response);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//实际调用Controller</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">applyDefaultViewName(processedRequest, mv);</span><br><span class="line">mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//目标方法运行期间有任何异常都会被catch</span></span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">dispatchException = ex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line"><span class="comment">// As of 4.3, we're processing Errors thrown from handler methods as well,</span></span><br><span class="line"><span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">dispatchException = <span class="keyword">new</span> NestedServletException(<span class="string">"Handler dispatch failed"</span>, err);</span><br><span class="line">&#125;</span><br><span class="line">processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line"><span class="keyword">new</span> NestedServletException(<span class="string">"Handler processing failed"</span>, err));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="InvocableHandlerMethod"><a href="#InvocableHandlerMethod" class="headerlink" title="InvocableHandlerMethod"></a>InvocableHandlerMethod</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvocableHandlerMethod</span> <span class="keyword">extends</span> <span class="title">HandlerMethod</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doInvoke</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Method method = getBridgedMethod();</span><br><span class="line">ReflectionUtils.makeAccessible(method);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">...真正调用的地方</span><br><span class="line"><span class="keyword">return</span> method.invoke(getBean(), args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">assertTargetBean(method, getBean(), args);</span><br><span class="line">String text = (ex.getMessage() != <span class="keyword">null</span> ? ex.getMessage() : <span class="string">"Illegal argument"</span>);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(formatInvokeError(text, args), ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//**往上抛出异常给DispatcherServlet**</span></span><br><span class="line"><span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line"><span class="comment">// Unwrap for HandlerExceptionResolvers ...</span></span><br><span class="line">Throwable targetException = ex.getTargetException();</span><br><span class="line"><span class="keyword">if</span> (targetException <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line"><span class="keyword">throw</span> (RuntimeException) targetException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (targetException <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line"><span class="keyword">throw</span> (Error) targetException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (targetException <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line"><span class="keyword">throw</span> (Exception) targetException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(formatInvokeError(<span class="string">"Invocation failure"</span>, args), targetException);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>org.springframework.web.servlet.DispatcherServlet#processHandlerException</strong></p><blockquote><p><strong>默认注册了两种异常处理器，第一个执行是默认并且上面提到的DefaultErrorAttributes，把异常信息保存到request域，并且返回null；第二个是组合异常处理器集合下ExceptionHandlerExceptionResolver就是处理映射@ExceptionHandler注解方法。@Order调整遍历异常解析器优先级。</strong></p></blockquote><p><img src="/images/pasted-33.png" alt="所有注册的异常处理器集合"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">processHandlerException</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">@Nullable Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//成功和错误响应可能使用不同的内容类型,所以先remove</span></span><br><span class="line">request.removeAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查注册的 HandlerExceptionResolvers...</span></span><br><span class="line">ModelAndView exMv = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.handlerExceptionResolvers != <span class="keyword">null</span>) &#123;、</span><br><span class="line"><span class="comment">//遍历所有的 handlerExceptionResolvers集合，看谁能处理当前异常</span></span><br><span class="line"><span class="keyword">for</span> (HandlerExceptionResolver resolver : <span class="keyword">this</span>.handlerExceptionResolvers) &#123;</span><br><span class="line">exMv = resolver.resolveException(request, response, handler, ex);</span><br><span class="line"><span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (exMv != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (exMv.isEmpty()) &#123;</span><br><span class="line"><span class="comment">//如果上面的ModelAndView里view和model属性都是空，则返回null</span></span><br><span class="line">request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对于一个简单的错误模型，我们可能仍然需要视图名称转换......</span></span><br><span class="line"><span class="keyword">if</span> (!exMv.hasView()) &#123;</span><br><span class="line">String defaultViewName = getDefaultViewName(request);</span><br><span class="line"><span class="keyword">if</span> (defaultViewName != <span class="keyword">null</span>) &#123;</span><br><span class="line">exMv.setViewName(defaultViewName);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">logger.trace(<span class="string">"Using resolved error view: "</span> + exMv, ex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">logger.debug(<span class="string">"Using resolved error view: "</span> + exMv);</span><br><span class="line">&#125;</span><br><span class="line">WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class="line"><span class="keyword">return</span> exMv;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">throw</span> ex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ControllerAdvice注册ApplicationContext"><a href="#ControllerAdvice注册ApplicationContext" class="headerlink" title="@ControllerAdvice注册ApplicationContext"></a>@ControllerAdvice注册ApplicationContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过策略模式构建ApplicationContext属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">initMultipartResolver(context);</span><br><span class="line">initLocaleResolver(context);</span><br><span class="line">initThemeResolver(context);</span><br><span class="line">initHandlerMappings(context);</span><br><span class="line">initHandlerAdapters(context);</span><br><span class="line"><span class="comment">//构建以及注册HandlerExceptionResolvers</span></span><br><span class="line">initHandlerExceptionResolvers(context);</span><br><span class="line">initRequestToViewNameTranslator(context);</span><br><span class="line">initViewResolvers(context);</span><br><span class="line">initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ExceptionResolver继承体系："><a href="#ExceptionResolver继承体系：" class="headerlink" title="ExceptionResolver继承体系："></a>ExceptionResolver继承体系：</h2><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-34.png" alt="ExceptionResolver继承体系" title="">                </div>                <div class="image-caption">ExceptionResolver继承体系</div>            </figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://www.yuque.com/atguigu/springboot/vgzmgh#6ezTG" target="_blank" rel="noopener">springboot资料</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener"><strong>配套代码</strong></a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBoot异常处理体系&quot;&gt;&lt;a href=&quot;#SpringBoot异常处理体系&quot; class=&quot;headerlink&quot; title=&quot;SpringBoot异常处理体系&quot;&gt;&lt;/a&gt;SpringBoot异常处理体系&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;在
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Context-length跨服务超时</title>
    <link href="https://caochikai.github.io/2021/08/13/Context-length%E8%B7%A8%E6%9C%8D%E5%8A%A1%E8%B6%85%E6%97%B6/"/>
    <id>https://caochikai.github.io/2021/08/13/Context-length%E8%B7%A8%E6%9C%8D%E5%8A%A1%E8%B6%85%E6%97%B6/</id>
    <published>2021-08-13T15:13:00.000Z</published>
    <updated>2021-08-14T03:14:12.506Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Context-length跨服务超时"><a href="#Context-length跨服务超时" class="headerlink" title="Context-length跨服务超时"></a>Context-length跨服务超时</h1><h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><blockquote><p>今天被拉进远程会议，博主是热心提供疑难bug解决的顾问，情况是跨语言接口客户端调用超时并且服务端打印内部错误500，reactor-netty封装的DefaultWebClient调用Python flash接口，DefaultWebClient无论加大多少时间都会超时，Python接口只打印报错500，打印无提供更加详细信息。前端发送POST请求调用从聚合服务Process API（PAPI）中获取数据，PAPI通过DefaultWebClient发送GET请求到Python编写接口SAPI，因为调用SAPI时须要携带header（Context-length:64)，出问题地方就是Context-length原因，给team解释一下该header影响。其实本来公共封装DefaultWebClient库GET方法过滤了Context-length（驼峰命名），已经考虑到该现象，但是另一个公共库封装的RequestContext类getHeader方法全部小写化context-length（不符合http标准），这就闹了很大乌龙了，反馈给公共库贡献者修复该issue。</p></blockquote><h2 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length: "></a>Content-Length: <length></h2><blockquote><p>Content-Length 是一个实体消息首部，用来指明发送给接收方的消息主体的大小，即用十进制数字表示的八位字节的数目。Content-Length指示出报文中实体主体的字节大小，它包含了所有的编码内容； 比如， 对文本文件进行了gzip压缩的话，Content-Length指的就是压缩后的大小而不是原始大小。IETF（The Internet Engineering Task Force）发布了绝大多数国际互联网技术标准，规定HTTP发送方不得在任何消息中发送 Content-Length, 但是在微服务之间调用很容易造成误传。无论是SpringBoot内嵌的tomcat还是Python flash都实现了该http标准，Python暴露底层库error信息较少，只有个500；Tomcat NioEndpoint$NioSocketWrapper根据Content-Length读取Socket缓冲区，直到超时发现，缓冲区字节长度为-1，SpringMvc报错如下：</p></blockquote><p><strong>Content-Length与实际消息长度不一致, 程序会发生比较奇怪的异常:</strong></p><ul><li>过长则会导致无响应直到超时。</li><li>过短则会截断请求被截断, 而且下一个请求解析出现错乱（上一次请求将会将入下一次请求）。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###实际测试命令</span></span><br><span class="line">curl --location --request GET <span class="string">'http://localhost:8080/api/version?version=1.0'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--header <span class="string">'Content-Length: 64'</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">12.759</span> DEBUG <span class="number">13692</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>] o.s.web.servlet.DispatcherServlet        : GET <span class="string">"/api/version?version=1.0"</span>, parameters=&#123;masked&#125;</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">12.772</span> DEBUG <span class="number">13692</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>] o.a.coyote.http11.Http11InputBuffer      : <span class="function">Before <span class="title">fill</span><span class="params">()</span>: parsingHeader: [<span class="keyword">false</span>], parsingRequestLine: [<span class="keyword">false</span>], parsingRequestLinePhase: [0], parsingRequestLineStart: [0], byteBuffer.<span class="title">position</span><span class="params">()</span>: [301], byteBuffer.<span class="title">limit</span><span class="params">()</span>: [301], end: [301]</span></span><br><span class="line"><span class="function">2021-08-13 22:43:12.772 DEBUG 13692 --- [nio-8080-exec-1] o.a.tomcat.util.net.SocketWrapperBase    : Socket: [org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper@4166e5bd:org.apache.tomcat.util.net.NioChannel@2a06c6f5:java.nio.channels.SocketChannel[connected local</span>=/<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">1</span>:<span class="number">8080</span> remote=/<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">1</span>:<span class="number">52338</span>]], Read from buffer: [<span class="number">0</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">15.356</span> DEBUG <span class="number">13692</span> --- [(<span class="number">4</span>)-<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>] sun.rmi.transport.tcp                    : <span class="function">RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">4</span>)</span>-192.168.3.2: <span class="params">(port <span class="number">52325</span>)</span> connection closed</span></span><br><span class="line"><span class="function">2021-08-13 22:43:15.356 DEBUG 13692 --- [<span class="params">(<span class="number">4</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">4</span>)</span>-192.168.3.2: close connection</span></span><br><span class="line"><span class="function">2021-08-13 22:43:15.356 DEBUG 13692 --- [<span class="params">(<span class="number">3</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">3</span>)</span>-192.168.3.2: <span class="params">(port <span class="number">52325</span>)</span> connection closed</span></span><br><span class="line"><span class="function">2021-08-13 22:43:15.356 DEBUG 13692 --- [<span class="params">(<span class="number">3</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">3</span>)</span>-192.168.3.2: close connection</span></span><br><span class="line"><span class="function">2021-08-13 22:43:15.478 DEBUG 13692 --- [<span class="params">(<span class="number">5</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">5</span>)</span>-192.168.3.2: accepted socket from [192.168.3.2:52339]</span></span><br><span class="line"><span class="function">2021-08-13 22:43:15.478 DEBUG 13692 --- [<span class="params">(<span class="number">5</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">5</span>)</span>-192.168.3.2: <span class="params">(port <span class="number">52325</span>)</span> op </span>= <span class="number">80</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">37.896</span> DEBUG <span class="number">13692</span> --- [(<span class="number">2</span>)-<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>] sun.rmi.transport.tcp                    : <span class="function">RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">2</span>)</span>-192.168.3.2: <span class="params">(port <span class="number">52325</span>)</span> connection closed</span></span><br><span class="line"><span class="function">2021-08-13 22:43:37.896 DEBUG 13692 --- [<span class="params">(<span class="number">2</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">2</span>)</span>-192.168.3.2: close connection</span></span><br><span class="line"><span class="function">2021-08-13 22:43:38.563 DEBUG 13692 --- [<span class="params">(<span class="number">5</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">5</span>)</span>-192.168.3.2: <span class="params">(port <span class="number">52325</span>)</span> connection closed</span></span><br><span class="line"><span class="function">2021-08-13 22:43:38.563 DEBUG 13692 --- [<span class="params">(<span class="number">5</span>)</span>-192.168.3.2] sun.rmi.transport.tcp                    : RMI TCP <span class="title">Connection</span><span class="params">(<span class="number">5</span>)</span>-192.168.3.2: close connection</span></span><br><span class="line"><span class="function">2021-08-13 22:44:08.274 DEBUG 13692 --- [alina-utility-1] org.apache.catalina.session.ManagerBase  : Start expire sessions StandardManager at 1628865848274 sessioncount 0</span></span><br><span class="line"><span class="function">2021-08-13 22:44:08.274 DEBUG 13692 --- [alina-utility-1] org.apache.catalina.session.ManagerBase  : End expire sessions StandardManager processingTime 0 expired sessions: 0</span></span><br><span class="line"><span class="function">2021-08-13 22:44:12.776 DEBUG 13692 --- [nio-8080-exec-1] o.s.web.method.HandlerMethod             : Could not resolve parameter [0] in org.springframework.http.ResponseEntity&lt;com.example.demo.Greeting&gt; com.example.demo.TestController.<span class="title">test</span><span class="params">(com.example.demo.raml.RequestContext&lt;java.lang.Void&gt;)</span>: I/O error <span class="keyword">while</span> reading input message</span>; nested exception is org.apache.catalina.connector.ClientAbortException: java.net.SocketTimeoutException</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">44</span>:<span class="number">12.778</span>  WARN <span class="number">13692</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">1</span>] .w.s.m.s.DefaultHandlerExceptionResolver : Resolved [org.springframework.http.converter.HttpMessageNotReadableException: I/O error <span class="keyword">while</span> reading input message; nested exception is org.apache.catalina.connector.ClientAbortException: java.net.SocketTimeoutException]</span><br><span class="line"><span class="number">2021</span>-<span class="number">08</span>-<span class="number">13</span> <span class="number">22</span>:<span class="number">57</span>:<span class="number">36.398</span> DEBUG <span class="number">13692</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">5</span>] o.apache.coyote.http11.Http11Processor   : Error parsing HTTP request header</span><br><span class="line"></span><br><span class="line">java.io.EOFException: <span class="keyword">null</span></span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.fillReadBuffer(NioEndpoint.java:<span class="number">1345</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.read(NioEndpoint.java:<span class="number">1255</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11InputBuffer.fill(Http11InputBuffer.java:<span class="number">794</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11InputBuffer.parseRequestLine(Http11InputBuffer.java:<span class="number">359</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:<span class="number">261</span>) ~[tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:<span class="number">65</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:<span class="number">893</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:<span class="number">1707</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:<span class="number">49</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>) [na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>) [na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:<span class="number">61</span>) [tomcat-embed-core-<span class="number">9.0</span><span class="number">.45</span>.jar:<span class="number">9.0</span><span class="number">.45</span>]</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>) [na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br></pre></td></tr></table></figure><h3 id="堆栈源码细究"><a href="#堆栈源码细究" class="headerlink" title="堆栈源码细究"></a>堆栈源码细究</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">fillReadBuffer</span><span class="params">(<span class="keyword">boolean</span> block, ByteBuffer to)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nRead;</span><br><span class="line">    NioChannel socket = getSocket();</span><br><span class="line">    <span class="keyword">if</span> (socket == NioChannel.CLOSED_NIO_CHANNEL) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedChannelException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = pool.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nRead = pool.read(to, socket, selector, getReadTimeout());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pool.put(selector);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//从此通道读取字节序列到给定缓冲区。</span></span><br><span class="line"><span class="comment">//参数：to – 要传输字节的缓冲区</span></span><br><span class="line"><span class="comment">//返回：读取的字节数，可能为零，如果通道已到达流结束，则为 -1：</span></span><br><span class="line">        nRead = socket.read(to);</span><br><span class="line">        <span class="keyword">if</span> (nRead == -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">//满足nRead == -1，抛出该异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="提供Feign版本（内部代码无法公布，提供网络版本）"><a href="#提供Feign版本（内部代码无法公布，提供网络版本）" class="headerlink" title="提供Feign版本（内部代码无法公布，提供网络版本）"></a>提供Feign版本（内部代码无法公布，提供网络版本）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeginInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String,String&gt; headers = getHeaders();</span><br><span class="line">            <span class="keyword">for</span>(String headerName : headers.keySet())&#123;</span><br><span class="line">                requestTemplate.header(headerName, headers.get(headerName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getHeaders</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        Enumeration&lt;String&gt; enumeration = request.getHeaderNames();</span><br><span class="line">        <span class="keyword">while</span> (enumeration.hasMoreElements()) &#123;</span><br><span class="line">            String key = enumeration.nextElement();</span><br><span class="line">            String value = request.getHeader(key);</span><br><span class="line"><span class="comment">//改动优化使用标准HttpHeaders</span></span><br><span class="line">            <span class="keyword">if</span> (HttpHeaders.CONTENT_LENGTH.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Length" target="_blank" rel="noopener">MDN Content-Length</a></li><li><a href="https://datatracker.ietf.org/doc/html/rfc7230#section-3.3.2" target="_blank" rel="noopener">Http协议标准</a></li><li><a href="https://www.shangmayuan.com/a/d8d96b2efa0a4836b6b87f5b.html" target="_blank" rel="noopener">springCloud 使用feign复制请求头调用其余服务 content-length不一致致使调用失败</a></li><li><a href="https://blog.piaoruiqing.com/2019/09/08/do-you-know-content-length/" target="_blank" rel="noopener">用了这么久HTTP, 你是否了解Content-Length和Transfer-Encoding ?</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener"><strong>配套代码</strong></a></li></ul><p>字节的</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Context-length跨服务超时&quot;&gt;&lt;a href=&quot;#Context-length跨服务超时&quot; class=&quot;headerlink&quot; title=&quot;Context-length跨服务超时&quot;&gt;&lt;/a&gt;Context-length跨服务超时&lt;/h1&gt;&lt;h1 i
      
    
    </summary>
    
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Controller自定义参数类型</title>
    <link href="https://caochikai.github.io/2021/08/11/Controller%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B/"/>
    <id>https://caochikai.github.io/2021/08/11/Controller%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B/</id>
    <published>2021-08-11T14:15:00.000Z</published>
    <updated>2021-08-11T14:15:39.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Controller自定义参数类型"><a href="#Controller自定义参数类型" class="headerlink" title="Controller自定义参数类型"></a>Controller自定义参数类型</h1><h1 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h1><blockquote><p>RAML设计的接口如何确定每次请求都符合设计，可以通过自定义Controller参数来做解析和校验请求，首先自定义RequestContext，让Controller支持该类型参数，实现类似HttpServletRequest、HttpSession自动就赋值的效果。</p></blockquote><h2 id="HandlerMethodArgumentResolver"><a href="#HandlerMethodArgumentResolver" class="headerlink" title="HandlerMethodArgumentResolver"></a>HandlerMethodArgumentResolver</h2><blockquote><p>HandlerMethodArgumentResolver组件的作用主要是用来做参数解析及校验的，包含2个方法</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 是否是支持的类型 **/</span></span><br><span class="line">boolean supportsParameter(MethodParameter parameter);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 具体解析参数方法 **/</span></span><br><span class="line">Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">            NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception;</span><br></pre></td></tr></table></figure><h2 id="RequestContext"><a href="#RequestContext" class="headerlink" title="RequestContext"></a>RequestContext</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.raml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestContext</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">MultiValueMap&lt;String, String&gt; <span class="title">getHeaders</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Optional&lt;String&gt; <span class="title">getParamter</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Optional&lt;String&gt; <span class="title">getUrlPath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Optional&lt;T&gt; <span class="title">getBody</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;  getBodyClass();</span><br><span class="line"></span><br><span class="line">    <span class="function">HttpMethod <span class="title">getMethod</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MultiValueMap&lt;String, String&gt; <span class="title">getQueryParameterMap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MultiValueMap&lt;String, String&gt; <span class="title">getUrlParameterMap</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="继承AbstractMessageConverterMethodArgumentResolver"><a href="#继承AbstractMessageConverterMethodArgumentResolver" class="headerlink" title="继承AbstractMessageConverterMethodArgumentResolver"></a>继承AbstractMessageConverterMethodArgumentResolver</h3><blockquote><p>AbstractMessageConverterMethodArgumentResolver实现了HandlerMethodArgumentResolver，通过使用 HttpMessageConverters 从请求正文中读取来解析方法参数值的基类，利用HttpMessageConverter将输入流转换成对应的参数。</p></blockquote><h2 id="RequestContextProcessor-参数解析器"><a href="#RequestContextProcessor-参数解析器" class="headerlink" title="RequestContextProcessor 参数解析器"></a>RequestContextProcessor 参数解析器</h2><blockquote><p>通过继承AbstractMessageConverterMethodArgumentResolver，每次请求到Controller有RequestContext类型参数，supportsParameter方法就会返回为true，从而触发resolveArgument方法构建RequestContext。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.raml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.MethodParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServletServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.support.WebDataBinderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.NativeWebRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.ModelAndViewContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodArgumentResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestContextProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractMessageConverterMethodArgumentResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestContextProcessor</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(converters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter methodParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpRequestContext<span class="class">.<span class="keyword">class</span> </span>== methodParameter.getParameterType() | RequestContext<span class="class">.<span class="keyword">class</span> </span>== methodParameter.getParameterType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer, NativeWebRequest nativeWebRequest, WebDataBinderFactory webDataBinderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServletServerHttpRequest inputMessage = createInputMessage(nativeWebRequest);</span><br><span class="line">        HttpMethod httpMethod = inputMessage.getMethod();</span><br><span class="line">        String endpointPathPattern = (String) nativeWebRequest.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line"><span class="comment">//获取headers，queryParameterMap ，urlParameterHashMap，body </span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; headers = inputMessage.getHeaders();</span><br><span class="line">        Map&lt;String, String[]&gt; queryParameterMap = inputMessage.getServletRequest().getParameterMap();</span><br><span class="line">        MultiValueMap&lt;String, String&gt; parameterValueMap = MapUtil.convertArrayMapToParamMap(queryParameterMap);</span><br><span class="line">        Map&lt;String, String&gt; urlParameterHashMap = (Map&lt;String, String&gt;) nativeWebRequest.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; urlParameterMap = MapUtil.convertHashMapToParamMap(urlParameterHashMap);</span><br><span class="line"><span class="comment">//继承AbstractMessageConverterMethodArgumentResolver好处就是能方便拿到body</span></span><br><span class="line">        String body = (String) readWithMessageConverters(nativeWebRequest, methodParameter, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Object responseBody = <span class="keyword">null</span>;</span><br><span class="line">        Class&lt;?&gt; bodyClass = getClass(methodParameter);</span><br><span class="line">        <span class="keyword">if</span> (HttpMethod.POST == httpMethod || HttpMethod.PUT == httpMethod) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bodyClass.isAssignableFrom(String<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                responseBody = body;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    responseBody = objectMapper.readValue(body, bodyClass);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RequestContext&lt;?&gt; httpRequestContext = <span class="keyword">new</span> HttpRequestContext(headers, parameterValueMap, urlParameterMap, responseBody,</span><br><span class="line">                bodyClass, endpointPathPattern, httpMethod);</span><br><span class="line">        <span class="keyword">return</span> httpRequestContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClass(MethodParameter methodParameter) &#123;</span><br><span class="line">        Assert.isAssignable(RequestContext<span class="class">.<span class="keyword">class</span>, <span class="title">methodParameter</span>.<span class="title">getParameterType</span>())</span>;</span><br><span class="line">        Class&lt;?&gt; bodyClass = <span class="keyword">null</span>;</span><br><span class="line">        Type parameterType = methodParameter.getGenericParameterType();</span><br><span class="line">        <span class="keyword">if</span> (parameterType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            ParameterizedType parameterizedType = (ParameterizedType) parameterType;</span><br><span class="line">            <span class="keyword">if</span> (parameterizedType.getActualTypeArguments().length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (Class&lt;?&gt;) parameterizedType.getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterType <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            bodyClass = Object<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(bodyClass).orElseThrow(() -&gt; <span class="keyword">new</span> IllegalArgumentException(<span class="string">"can not find parameter type"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.raml.RequestContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/version"</span>)</span><br><span class="line">    <span class="function">ResponseEntity&lt;Greeting&gt; <span class="title">test</span><span class="params">(RequestContext&lt;Void&gt; requestContext)</span> </span>&#123;</span><br><span class="line">        String version = requestContext.getParamter(<span class="string">"version"</span>).orElseThrow(IllegalArgumentException::<span class="keyword">new</span>);</span><br><span class="line">        Greeting greeting = <span class="keyword">new</span> Greeting();</span><br><span class="line">        greeting.setFirstName(<span class="string">"Charles"</span>);</span><br><span class="line">        greeting.setLastName(<span class="string">"Cao"</span>);</span><br><span class="line">        greeting.setVersion(version);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(greeting);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如何注册springmvc参数解析器"><a href="#如何注册springmvc参数解析器" class="headerlink" title="如何注册springmvc参数解析器"></a>如何注册springmvc参数解析器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.raml.RequestContextProcessor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.support.HandlerMethodArgumentResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestMvcConfigureer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(RestMvcConfigureer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> RequestContextProcessor requestContextProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line"><span class="comment">//把自己参数解析器添加进去参数解析器的集合</span></span><br><span class="line">        log.info(<span class="string">"add RequestContextProcessor handlerMethodArgumentResolver"</span>);</span><br><span class="line">        resolvers.add(requestContextProcessor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestContextProcessor <span class="title">requestContextProcessor</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"create RequestContextProcessor bean"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestContextProcessor(converters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://blog.csdn.net/f641385712/article/details/100016055" target="_blank" rel="noopener">基于HttpMessageConverter消息转换器的参数解析器</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener"><strong>配套代码</strong></a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Controller自定义参数类型&quot;&gt;&lt;a href=&quot;#Controller自定义参数类型&quot; class=&quot;headerlink&quot; title=&quot;Controller自定义参数类型&quot;&gt;&lt;/a&gt;Controller自定义参数类型&lt;/h1&gt;&lt;h1 id=&quot;一、需求&quot;
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>RAML API生成器</title>
    <link href="https://caochikai.github.io/2021/08/08/RAML-API%E7%94%9F%E6%88%90%E5%99%A8/"/>
    <id>https://caochikai.github.io/2021/08/08/RAML-API%E7%94%9F%E6%88%90%E5%99%A8/</id>
    <published>2021-08-08T04:22:00.000Z</published>
    <updated>2021-08-08T04:23:02.952Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RAML-API生成器"><a href="#RAML-API生成器" class="headerlink" title="RAML API生成器"></a>RAML API生成器</h1><blockquote><p>springmvc-raml-plugin是一个Maven插件，用以从RAML文件生成Spring框架的Controller和POJO代码，结合mybatis-plus就能实现接口设计到数据库。后面就是结合<a href="http://start.spring.io/" target="_blank" rel="noopener"><strong>start.spring.io</strong></a>定制化的快速代码生成平台，国内阿里巴巴就定制化了<a href="https://start.aliyun.com/bootstrap.html" target="_blank" rel="noopener"><strong>Aliyun Java Initialize</strong></a> ，为所有开发者提供Springboot企业化代码平台。</p></blockquote><h3 id="从RAML文件生成Spring代码实现"><a href="#从RAML文件生成Spring代码实现" class="headerlink" title="从RAML文件生成Spring代码实现"></a>从RAML文件生成Spring代码实现</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.phoenixnap.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springmvc-raml-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ramlPath</span>&gt;</span>src/main/api/version.raml<span class="tag">&lt;/<span class="name">ramlPath</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">schemaLocation</span>&gt;</span>src/main/api/schemas<span class="tag">&lt;/<span class="name">schemaLocation</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">outputRelativePath</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">outputRelativePath</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">addTimestampFolder</span>&gt;</span>false<span class="tag">&lt;/<span class="name">addTimestampFolder</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">basePackage</span>&gt;</span>com.example.demo<span class="tag">&lt;/<span class="name">basePackage</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">baseUri</span>&gt;</span>/api<span class="tag">&lt;/<span class="name">baseUri</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">generateUnreferencedObjects</span>&gt;</span>true<span class="tag">&lt;/<span class="name">generateUnreferencedObjects</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">generationConfig</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">includeAdditionalProperties</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includeAdditionalProperties</span>&gt;</span></span><br><span class="line">              ...</span><br><span class="line">          <span class="tag">&lt;/<span class="name">generationConfig</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">seperateMethodsByContentType</span>&gt;</span>false<span class="tag">&lt;/<span class="name">seperateMethodsByContentType</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">rule</span>&gt;</span>com.phoenixnap.oss.ramlplugin.raml2code.rules.Spring4ControllerStubRule<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ruleConfiguration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">ruleConfiguration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>generate-springmvc-endpoints<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">phase</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate-springmvc-endpoints<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="RAML"><a href="#RAML" class="headerlink" title="RAML"></a>RAML</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#%RAML 1.0</span><br><span class="line">title: Hello world # required title</span><br><span class="line">baseUri: http:<span class="comment">//localhost:8080/api</span></span><br><span class="line">version: <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">schemas:</span><br><span class="line">  VersionInline: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">      <span class="string">"$schema"</span>: <span class="string">"http://json-schema.org/draft-03/schema"</span>,</span><br><span class="line">      <span class="string">"title"</span>: <span class="string">"Greeting"</span>,</span><br><span class="line">      <span class="string">"description"</span>: <span class="string">"Will greet you"</span>,</span><br><span class="line">      <span class="string">"properties"</span>: &#123;</span><br><span class="line">        <span class="string">"firstName"</span>: &#123;</span><br><span class="line">          <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="string">"description"</span>: <span class="string">"名字"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"lastName"</span>: &#123;</span><br><span class="line">          <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="string">"description"</span>: <span class="string">"姓"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"version"</span>: &#123;</span><br><span class="line">          <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="string">"description"</span>: <span class="string">"版本号"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/version: # optional resource</span><br><span class="line">  get: # HTTP method declaration</span><br><span class="line">    queryParameters:</span><br><span class="line">      version:</span><br><span class="line">        type: string</span><br><span class="line">        example: <span class="string">"1.0"</span></span><br><span class="line">    responses: # declare a response</span><br><span class="line">      200: # HTTP status code</span><br><span class="line">        body: # declare content of response</span><br><span class="line">          application/json: # media type</span><br><span class="line">            schema: VersionInline # can also be used with 'type'</span><br><span class="line">            example: !include example/version-example.json</span><br></pre></td></tr></table></figure><p><strong>example/version-example.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"firstName"</span>: <span class="string">"Charles"</span>,</span><br><span class="line">  <span class="attr">"lastName"</span>: <span class="string">"Cao"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="生成的Controller和POJO"><a href="#生成的Controller和POJO" class="headerlink" title="生成的Controller和POJO"></a>生成的Controller和POJO</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.VersionInline;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * No description</span></span><br><span class="line"><span class="comment"> * (Generated with springmvc-raml-parser v.2.0.5)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/version"</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * No description</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">""</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;VersionInline&gt; <span class="title">getVersionInlineByVersion</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        @RequestParam</span></span></span><br><span class="line"><span class="function"><span class="params">        String version)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">//TODO Autogenerated Method Stub. Implement me please.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonProperty;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonPropertyDescription;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonPropertyOrder;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.builder.EqualsBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.builder.HashCodeBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.builder.ToStringBuilder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Greeting</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Will greet you</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="meta">@JsonPropertyOrder</span>(&#123;</span><br><span class="line">    <span class="string">"firstName"</span>,</span><br><span class="line">    <span class="string">"lastName"</span>,</span><br><span class="line">    <span class="string">"version"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionInline</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"firstName"</span>)</span><br><span class="line">    <span class="meta">@JsonPropertyDescription</span>(<span class="string">"\u540d\u5b57"</span>)</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 姓</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"lastName"</span>)</span><br><span class="line">    <span class="meta">@JsonPropertyDescription</span>(<span class="string">"\u59d3"</span>)</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 版本号</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="meta">@JsonPropertyDescription</span>(<span class="string">"\u7248\u672c\u53f7"</span>)</span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"firstName"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFirstName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> firstName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"firstName"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirstName</span><span class="params">(String firstName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 姓</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"lastName"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLastName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 姓</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"lastName"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastName</span><span class="params">(String lastName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 版本号</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 版本号</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"version"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVersion</span><span class="params">(String version)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.version = version;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ToStringBuilder(<span class="keyword">this</span>).append(<span class="string">"firstName"</span>, firstName).append(<span class="string">"lastName"</span>, lastName).append(<span class="string">"version"</span>, version).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashCodeBuilder().append(firstName).append(lastName).append(version).toHashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (other == <span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((other <span class="keyword">instanceof</span> VersionInline) == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        VersionInline rhs = ((VersionInline) other);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EqualsBuilder().append(firstName, rhs.firstName).append(lastName, rhs.lastName).append(version, rhs.version).isEquals();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Maven-plugin-goals-generate-springmvc-endpoints"><a href="#Maven-plugin-goals-generate-springmvc-endpoints" class="headerlink" title="Maven plugin goals: generate-springmvc-endpoints"></a>Maven plugin goals: generate-springmvc-endpoints</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] -----------------&lt; com.example:cucumber-rest-assured &gt;------------------</span><br><span class="line">[INFO] Building demo <span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- springmvc-raml-plugin:<span class="number">2.0</span><span class="number">.5</span>:help (<span class="keyword">default</span>-cli) @ cucumber-rest-assured ---</span><br><span class="line">[INFO] RAML to Spring MVC code generator <span class="number">2.0</span><span class="number">.5</span></span><br><span class="line">  Component is Maven plugin that reads RAML documents and creates Spring MVC</span><br><span class="line">  endpoints</span><br><span class="line"></span><br><span class="line">This plugin has <span class="number">2</span> goals:</span><br><span class="line"></span><br><span class="line">springmvc-raml:generate-springmvc-endpoints</span><br><span class="line">  Maven Plugin MOJO specific to Generation of Spring MVC Endpoints from RAML</span><br><span class="line">  documents.</span><br><span class="line"></span><br><span class="line">springmvc-raml:help</span><br><span class="line">  Display help information on springmvc-raml-plugin.</span><br><span class="line">  Call mvn springmvc-raml:help -Ddetail=<span class="keyword">true</span> -Dgoal=&lt;goal-name&gt; to display</span><br><span class="line">  parameter details.</span><br><span class="line"></span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  <span class="number">0.843</span> s</span><br><span class="line">[INFO] Finished at: <span class="number">2021</span>-<span class="number">08</span>-<span class="number">08</span>T12:<span class="number">03</span>:<span class="number">21</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://github.com/phoenixnap/springmvc-raml-plugin" target="_blank" rel="noopener">springmvc-raml-plugin</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener"><strong>配套代码</strong></a></li><li><a href="https://blog.csdn.net/taiyangdao/article/details/75014027" target="_blank" rel="noopener">Spring MVC - RAML Spec Synchroniser简介</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;RAML-API生成器&quot;&gt;&lt;a href=&quot;#RAML-API生成器&quot; class=&quot;headerlink&quot; title=&quot;RAML API生成器&quot;&gt;&lt;/a&gt;RAML API生成器&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;springmvc-raml-plugin
      
    
    </summary>
    
    
    
      <category term="架构" scheme="https://caochikai.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>API设计语言之Raml</title>
    <link href="https://caochikai.github.io/2021/08/07/API%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80%E4%B9%8BRaml/"/>
    <id>https://caochikai.github.io/2021/08/07/API%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80%E4%B9%8BRaml/</id>
    <published>2021-08-07T14:06:00.000Z</published>
    <updated>2021-08-11T14:26:34.286Z</updated>
    
    <content type="html"><![CDATA[<h1 id="API设计语言之Raml"><a href="#API设计语言之Raml" class="headerlink" title="API设计语言之Raml"></a>API设计语言之Raml</h1><h1 id="RAML"><a href="#RAML" class="headerlink" title="RAML"></a>RAML</h1><blockquote><p>RAML的全称是RESTful API建模语言，这是一种基于YAML格式的新规范，在开始编写代码之前以一种全新的方式对<strong>API进行建模</strong>。接口设计不仅仅是高悬楼阁的概念，通过接口设计文档ATD到文档，再加上RAML完成API建模。有了RAML文件自定义spring.io代码（自行扩展）代码生成SpringBoot工程，真正实现从设计到代码落地！在国外大公司比较出名的商业产品，国内流行是Swagger，Swagger属于OpenAPI标准。</p></blockquote><ul><li>先API建模，通过raml文件提供给代码生成器生成设计好的接口，再加上mybatis-plus或者Spring JPA代码生成器，简直无敌！</li><li>配合定制化java公共库，提供SpringMVC Controller接口URL、方法、请求体和参数校验，在Raml没有新接口代码会校验失败。</li><li>代替PostMan做接口测试。</li><li>提供Mock服务。</li><li>提供API文档，有HTML，markdown格式（raml2html GitHub开源npm插件）。</li></ul><h3 id="Example"><a href="#Example" class="headerlink" title="Example:"></a>Example:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#%RAML 1.0</span><br><span class="line">title: Hello world # required title</span><br><span class="line"></span><br><span class="line">/greeting: # optional resource</span><br><span class="line">  get: # HTTP method declaration</span><br><span class="line">    responses: # declare a response</span><br><span class="line">      200: # HTTP status code</span><br><span class="line">        body: # declare content of response</span><br><span class="line">          application/json: # media type</span><br><span class="line">            # structural definition of a response (schema or type)</span><br><span class="line">            type: object</span><br><span class="line">            properties:</span><br><span class="line">              message: string</span><br><span class="line">            example: # example how a response looks like</span><br><span class="line">              message: <span class="string">"Hello world"</span></span><br></pre></td></tr></table></figure><h2 id="接口可视化设计"><a href="#接口可视化设计" class="headerlink" title="接口可视化设计"></a>接口可视化设计</h2><blockquote><p>API Designer 是本地设计npm插件，用 JavaScript 编写的 RAML（RESTful API 建模语言）的可视化编辑器。 默认情况下，编辑器使用存储在 HTML5 Localstorage 中的浏览器内文件系统。</p></blockquote><h3 id="本地安装"><a href="#本地安装" class="headerlink" title="本地安装"></a>本地安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g api-designer</span><br><span class="line">...</span><br><span class="line">+ api-designer@0.4.1</span><br><span class="line">added 152 packages from 132 contributors <span class="keyword">in</span> 28.413s</span><br><span class="line">$ npm install -g request</span><br><span class="line">+ request@2.88.2</span><br><span class="line">added 47 packages from 58 contributors <span class="keyword">in</span> 5.568s</span><br><span class="line">$ api-designer</span><br><span class="line">API designer running on port 3000...</span><br><span class="line">(node:6036) [DEP0066] DeprecationWarning: OutgoingMessage.prototype._headers is deprecated</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-31.png" alt="可视化设计插件安装" title="">                </div>                <div class="image-caption">可视化设计插件安装</div>            </figure><h3 id="version-raml-建议安装RAML-Plugin-For-IntelliJ"><a href="#version-raml-建议安装RAML-Plugin-For-IntelliJ" class="headerlink" title="version.raml(建议安装RAML Plugin For IntelliJ)"></a>version.raml<strong>(建议安装RAML Plugin For IntelliJ)</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#%RAML 1.0</span><br><span class="line">title: Hello world # required title</span><br><span class="line">baseUri: http:<span class="comment">//localhost:8080/api</span></span><br><span class="line">version: <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">/version: # optional resource</span><br><span class="line">  get: # HTTP method declaration</span><br><span class="line">    queryParameters:</span><br><span class="line">      version:</span><br><span class="line">        type: string</span><br><span class="line">        example: <span class="string">"1.0"</span></span><br><span class="line">    responses: # declare a response</span><br><span class="line">      200: # HTTP status code</span><br><span class="line">        body: # declare content of response</span><br><span class="line">          application/json: # media type</span><br><span class="line">            # structural definition of a response (schema or type)</span><br><span class="line">            type: object</span><br><span class="line">            properties:</span><br><span class="line">              firstName: string</span><br><span class="line">              lastName:  string</span><br><span class="line">              version: string</span><br><span class="line">            example: |</span><br><span class="line">             &#123;</span><br><span class="line">                <span class="string">"firstName"</span>: <span class="string">"Charles"</span>,</span><br><span class="line">                <span class="string">"lastName"</span>: <span class="string">"Cao"</span>,</span><br><span class="line">                <span class="string">"version"</span>: <span class="string">"1.0"</span></span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure><p><img src="/images/pasted-32.png" alt="本地完美实际例子"></p><p><strong>测试SpringMVC接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/version"</span>)</span><br><span class="line">    <span class="function">ResponseEntity <span class="title">test</span><span class="params">(@RequestParam String version)</span> </span>&#123;</span><br><span class="line">        Greeting greeting = <span class="keyword">new</span> Greeting();</span><br><span class="line">        greeting.setFirstName(<span class="string">"Charles"</span>);</span><br><span class="line">        greeting.setLastName(<span class="string">"Cao"</span>);</span><br><span class="line">        greeting.setVersion(version);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(greeting);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">###IDEA http editoer request</span><br><span class="line">GET http:<span class="comment">//localhost:8080/api/version?version=1.0</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> </span><br><span class="line">Content-Type: application/json</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sat, <span class="number">07</span> Aug <span class="number">2021</span> <span class="number">13</span>:<span class="number">14</span>:<span class="number">57</span> GMT</span><br><span class="line">Keep-Alive: timeout=<span class="number">60</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"firstName"</span>: <span class="string">"Charles"</span>,</span><br><span class="line">  <span class="string">"lastName"</span>: <span class="string">"Cao"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span>; Time: <span class="number">174</span>ms; Content length: <span class="number">56</span> bytes</span><br></pre></td></tr></table></figure><h2 id="生成mock服务"><a href="#生成mock服务" class="headerlink" title="生成mock服务"></a>生成mock服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g osprey-mock-service</span><br><span class="line">C:\Users\Administrator\AppData\Roaming\npm\osprey-mock-service -&gt; C:\Users\Administrator\AppData\Roaming\npm\node_modules\osprey-mock-service\bin\osprey-mock-service.js</span><br><span class="line">+ osprey-mock-service@1.0.0</span><br><span class="line">added 136 packages from 55 contributors <span class="keyword">in</span> 33.128s</span><br><span class="line"><span class="comment">###需要window管理员权限</span></span><br><span class="line"><span class="comment"># osprey-mock-service -f version.raml -p 8000</span></span><br><span class="line">Mock service running at http://localhost:8000</span><br><span class="line">::ffff:127.0.0.1 - - [07/Aug/2021:13:36:33 +0000] <span class="string">"GET /api/version?version=1.0 HTTP/1.1"</span> 200 - <span class="string">"-"</span> <span class="string">"Apache-HttpClient/4.5.13 (Java/11.0.11)"</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//localhost:8000/api/version?version=1.0</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Date: Sat, <span class="number">07</span> Aug <span class="number">2021</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">33</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"firstName"</span>: <span class="string">"Charles"</span>,</span><br><span class="line">  <span class="string">"lastName"</span>: <span class="string">"Cao"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: <span class="number">200</span> (OK); Time: <span class="number">228</span>ms; Content length: <span class="number">73</span> bytes</span><br></pre></td></tr></table></figure><h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><blockquote><p>测试用的工具有多重选择,选择了相对比较流行的<a href="https://github.com/cybertk/abao/" target="_blank" rel="noopener">Abao工具</a>，只支持RAML 0.8以下版本。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npm install -g abao</span></span><br><span class="line">...</span><br><span class="line">+ abao@0.5.0</span><br><span class="line">added 194 packages from 450 contributors <span class="keyword">in</span> 26.061s</span><br></pre></td></tr></table></figure><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://raml.org" target="_blank" rel="noopener">Raml官方文档</a></li><li><a href="https://raml.org/projects" target="_blank" rel="noopener">Raml各大工具</a></li><li><a href="https://github.com/mulesoft/api-designer" target="_blank" rel="noopener">Raml本地设计工具</a></li><li><a href="https://github.com/raml-org/raml-examples" target="_blank" rel="noopener">Raml例子</a></li><li><a href="https://www.jianshu.com/p/eb64fcfe38bc?winzoom=1" target="_blank" rel="noopener">Raml入门</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;API设计语言之Raml&quot;&gt;&lt;a href=&quot;#API设计语言之Raml&quot; class=&quot;headerlink&quot; title=&quot;API设计语言之Raml&quot;&gt;&lt;/a&gt;API设计语言之Raml&lt;/h1&gt;&lt;h1 id=&quot;RAML&quot;&gt;&lt;a href=&quot;#RAML&quot; cla
      
    
    </summary>
    
    
    
      <category term="架构" scheme="https://caochikai.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>API设计文档案例</title>
    <link href="https://caochikai.github.io/2021/08/07/API%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3%E6%A1%88%E4%BE%8B/"/>
    <id>https://caochikai.github.io/2021/08/07/API%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3%E6%A1%88%E4%BE%8B/</id>
    <published>2021-08-07T06:47:00.000Z</published>
    <updated>2021-08-08T02:16:07.187Z</updated>
    
    <content type="html"><![CDATA[<h1 id="API设计文档案例"><a href="#API设计文档案例" class="headerlink" title="API设计文档案例"></a>API设计文档案例</h1><h2 id="一、接口设计"><a href="#一、接口设计" class="headerlink" title="一、接口设计"></a>一、接口设计</h2><blockquote><p>在接口规范指导下，根据需求编写接口设计文档ATD（API Design Document），描述功能形成的聚合服务API，每个聚合服务PAPI（Process API）需要多少个基础服务SAPI（System API）；每个聚合服务需要编写接口技术文档，概要描述下用户接口应用场景，详细到请求方法和URL，数据字段映射关系和错误代码设计等；</p></blockquote><h2 id="二、接口设计文档ATD"><a href="#二、接口设计文档ATD" class="headerlink" title="二、接口设计文档ATD"></a>二、接口设计文档ATD</h2><blockquote><p>好的接口有高可阅读性，版本发布计划，全面的文档，安全性设计和所需资源性能计算，网络拓扑图，标准错误和日志处理，弹性可扩容等等特性。</p></blockquote><h3 id="ddd领域驱动设计"><a href="#ddd领域驱动设计" class="headerlink" title="ddd领域驱动设计"></a>ddd领域驱动设计</h3><blockquote><p>通过组件图描述形成逻辑建模，区分聚合服务和基础服务关系，以及是否缺少基础服务组件支持。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-29.png" alt="DDD" title="">                </div>                <div class="image-caption">DDD</div>            </figure><h3 id="网络拓扑图"><a href="#网络拓扑图" class="headerlink" title="网络拓扑图"></a>网络拓扑图</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-30.png" alt="拓扑" title="">                </div>                <div class="image-caption">拓扑</div>            </figure><h3 id="标准的公共错误处理"><a href="#标准的公共错误处理" class="headerlink" title="标准的公共错误处理"></a>标准的公共错误处理</h3><table><thead><tr><th>HTTP Code</th><th>Error Code</th><th>Description</th></tr></thead><tbody><tr><td>400</td><td>BERR_00001</td><td>请求参数校验失败</td></tr><tr><td>404</td><td>BERR_00002</td><td>基础功能不可用</td></tr></tbody></table><h2 id="三、接口技术文档ATD"><a href="#三、接口技术文档ATD" class="headerlink" title="三、接口技术文档ATD"></a>三、接口技术文档ATD</h2><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><blockquote><p>每个聚合服务PAPI（Process API）需要多少个基础服务SAPI（System API）</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/5/17/16ac539d23bcc707~tplv-t2oaga2asx-watermark.awebp" alt="image" title="">                </div>                <div class="image-caption">image</div>            </figure><h3 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h3><blockquote><p>如果是聚合服务Process API，提供聚合请求数据和基础服务之间字段映射；如果是基础服务System API，提供基础服务和表字段，MQ数据源字段之间映射关系；</p></blockquote><h4 id="请求Request"><a href="#请求Request" class="headerlink" title="请求Request"></a>请求Request</h4><table><thead><tr><th>URL</th><th>PAPI参数</th><th>SAPI参数</th><th>备注</th></tr></thead><tbody><tr><td>POST /favorites</td><td>functionId</td><td>funcId</td><td>菜单ID</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h5 id="请求体Request-JSON-example和schema"><a href="#请求体Request-JSON-example和schema" class="headerlink" title="请求体Request JSON example和schema"></a>请求体Request JSON example和schema</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">"USER_ADD"</span>,<span class="string">"USER_DEL"</span>]</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"array"</span>,</span><br><span class="line">    <span class="attr">"$schema"</span>: <span class="string">"http://json-schema.org/draft-03/schema"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"Greeting"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"update menu list"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"items"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"array"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"a list of menu id"</span>,</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"key"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">" menu id"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="响应Response"><a href="#响应Response" class="headerlink" title="响应Response"></a>响应Response</h4><table><thead><tr><th>PAPI字段名</th><th>SAPI字段名</th><th>是否为空</th><th>备注</th></tr></thead><tbody><tr><td>firstName</td><td>customerFirstName</td><td>no</td><td>名字</td></tr><tr><td>lastName</td><td>customerLastName</td><td>no</td><td>姓</td></tr><tr><td>menu</td><td>menu</td><td>no</td><td>菜单名称</td></tr></tbody></table><h5 id="响应体Request-JSON-example和schema"><a href="#响应体Request-JSON-example和schema" class="headerlink" title="响应体Request JSON example和schema"></a>响应体Request JSON example和schema</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"firstName"</span>: <span class="string">"Charles"</span>,</span><br><span class="line">    <span class="attr">"lastName"</span>: <span class="string">"Cao"</span>,</span><br><span class="line">    <span class="attr">"menu"</span>: <span class="string">"USER_ADD,USER_DEL"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">    <span class="attr">"$schema"</span>: <span class="string">"http://json-schema.org/draft-03/schema"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"Greeting"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"Will greet you"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>: &#123;</span><br><span class="line">        <span class="attr">"firstName"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"名字"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"lastName"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"姓"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"menu"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"菜单"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="错误匹配"><a href="#错误匹配" class="headerlink" title="错误匹配"></a>错误匹配</h4><table><thead><tr><th>HTTP Code</th><th>PAPI Error Code</th><th>SAPI Error Code</th><th>Description</th></tr></thead><tbody><tr><td>401</td><td>PERR_00003</td><td>SERR_00003</td><td>请求参数校验失败</td></tr><tr><td>400</td><td>PERR_00004</td><td></td><td>functionId不存在</td></tr></tbody></table><h3 id="关键技术决策"><a href="#关键技术决策" class="headerlink" title="关键技术决策"></a>关键技术决策</h3><table><thead><tr><th>发起人</th><th>描述</th><th>状态</th></tr></thead><tbody><tr><td>XXX</td><td>菜单信息需要关系型数据库Mysql存储</td><td>完成</td></tr><tr><td>XXX</td><td>通过MQ向XX队列发起消息通知</td><td>代完成</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h2 id="四、参考资料"><a href="#四、参考资料" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><p><a href="https://www.processon.com/view/56e784d0e4b009809b86f636?fromnew=1#pc" target="_blank" rel="noopener">ProcessOn模板社区-AWS </a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;API设计文档案例&quot;&gt;&lt;a href=&quot;#API设计文档案例&quot; class=&quot;headerlink&quot; title=&quot;API设计文档案例&quot;&gt;&lt;/a&gt;API设计文档案例&lt;/h1&gt;&lt;h2 id=&quot;一、接口设计&quot;&gt;&lt;a href=&quot;#一、接口设计&quot; class=&quot;head
      
    
    </summary>
    
    
    
      <category term="架构" scheme="https://caochikai.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>接口测试 Rest-assured</title>
    <link href="https://caochikai.github.io/2021/08/02/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-Rest-assured/"/>
    <id>https://caochikai.github.io/2021/08/02/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-Rest-assured/</id>
    <published>2021-08-02T14:31:00.000Z</published>
    <updated>2021-08-03T09:47:49.515Z</updated>
    
    <content type="html"><![CDATA[<h1 id="接口测试-Rest-assured"><a href="#接口测试-Rest-assured" class="headerlink" title="接口测试 Rest-assured"></a>接口测试 Rest-assured</h1><h1 id="一、如何确保-API-的稳定性与正确性呢？"><a href="#一、如何确保-API-的稳定性与正确性呢？" class="headerlink" title="一、如何确保 API 的稳定性与正确性呢？"></a>一、如何确保 API 的稳定性与正确性呢？</h1><blockquote><p>全面系统的测试是必不可少的。Java 开发者常常借助于 JUnit或者TestNg做单元测试！但是从REST API来讲，开发者知道正在测试的是哪个类、哪个方法，测试的是哪个 REST API，所以就需要由一套 Java 实现的 REST API 测试框架。虽然它不是从用户的角度出发，但是结合BDD行为驱动测试，就能保证接口的稳定性和功能的正确性！当然本章还是以rest-assured为主。</p></blockquote><h2 id="什么是Rest-assured"><a href="#什么是Rest-assured" class="headerlink" title="什么是Rest-assured?"></a>什么是Rest-assured?</h2><blockquote><p>Rest-Assured 是一套由 Java 实现的 REST API 测试框架，它是一个现代化轻量级的 REST API 客户端，可以简化HTTP Builder向服务器端发起 HTTP 请求，并验证和校对返回结果；它的语法非常简洁，是一种专为测试 REST API 而设计的 DSL（针对某一领域，具有受限表达性的一种计算机程序设计语言）。这套写测试代码方案适合复杂且不成熟的接口，另外还有一套以JSON测试方案适合成熟简洁的系统，后面再写。</p></blockquote><h1 id="二、Rest-assured好特性"><a href="#二、Rest-assured好特性" class="headerlink" title="二、Rest-assured好特性"></a>二、Rest-assured好特性</h1><ul><li>现代化简洁的语法，针对JSON、XML和身份认证有非常多的语法糖（疯狂链式调用，非常Groovy）。</li><li>JSON Schema Validation：特别是校验返回的JSON结构体，初期设计往往会落后于实际，最后需要做回归测试，同步修改初期的设计。</li><li>Spring Mock Mvc和Spring Web Test Client有集成模块，生态成熟。</li></ul><h1 id="三、集成"><a href="#三、集成" class="headerlink" title="三、集成"></a>三、集成</h1><h2 id="Cucumber-Report"><a href="#Cucumber-Report" class="headerlink" title="Cucumber Report"></a>Cucumber Report</h2><p><img src="/images/pasted-28.png" alt="Cucumber Report"></p><h2 id="Maven-Dependencies"><a href="#Maven-Dependencies" class="headerlink" title="Maven Dependencies"></a>Maven Dependencies</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-rest-assured<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for BDD Test<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rest-assured<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rest-assured<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rest-assured<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json-path<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rest-assured<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xml-path<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rest-assured<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json-schema-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rest-assured<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-mock-mvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>info.cukes<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="完整例子"><a href="#完整例子" class="headerlink" title="完整例子"></a>完整例子</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"object"</span>,</span><br><span class="line">  <span class="attr">"$schema"</span>: <span class="string">"http://json-schema.org/draft-03/schema"</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Greeting"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"Will greet you"</span>,</span><br><span class="line">  <span class="attr">"properties"</span>: &#123;</span><br><span class="line">    <span class="attr">"firstName"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"lastName"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"version"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.cucumber.junit.Cucumber;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.junit.CucumberOptions;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.spring.CucumberContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Work around. Surefire does not use JUnits Test Engine discovery</span></span><br><span class="line"><span class="comment"> * functionality. Alternatively execute the the</span></span><br><span class="line"><span class="comment"> * org.junit.platform.console.ConsoleLauncher with the maven-antrun-plugin.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(Cucumber<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">CucumberOptions</span>(</span></span><br><span class="line"><span class="class">        <span class="title">plugin</span> </span>= &#123;<span class="string">"html:target/results.html"</span>, <span class="string">"message:target/results.ndjson"</span>&#125;)</span><br><span class="line"><span class="meta">@CucumberContextConfiguration</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">webEnvironment</span> </span>= SpringBootTest.WebEnvironment.DEFINED_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunCucumberTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.Before;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.And;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.Given;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.Then;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.When;</span><br><span class="line"><span class="keyword">import</span> io.restassured.RestAssured;</span><br><span class="line"><span class="keyword">import</span> io.restassured.response.Response;</span><br><span class="line"><span class="keyword">import</span> org.hamcrest.Matchers;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> io.restassured.RestAssured.given;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> io.restassured.<span class="keyword">module</span>.jsv.JsonSchemaValidator.matchesJsonSchemaInClasspath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetStep</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;local.server.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Response response;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Given</span>(<span class="string">"the client provide version &#123;string&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">theClientProvideVersion</span><span class="params">(String version)</span> </span>&#123;</span><br><span class="line">        parameters.put(<span class="string">"version"</span>, version);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@When</span>(<span class="string">"the client calls &#123;string&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">theClientCalls</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        response = given().</span><br><span class="line">                when().</span><br><span class="line">                params(parameters).</span><br><span class="line">                get(url);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Then</span>(<span class="string">"^the client receives status code of (\\d+)$"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_receives_status_code_of</span><span class="params">(<span class="keyword">int</span> statusCode)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        response.then().statusCode(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@And</span>(<span class="string">"^the client receives server version (.+)$"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_receives_server_version_body</span><span class="params">(String version)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        response.then()</span><br><span class="line">                .body(matchesJsonSchemaInClasspath(<span class="string">"greeting-schema.json"</span>))</span><br><span class="line">                .body(<span class="string">"version"</span>, Matchers.equalTo(version));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestAssured.port = port;</span><br><span class="line">        RestAssured.basePath = <span class="string">"/api"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h1><ol><li><a href="https://rest-assured.io/" target="_blank" rel="noopener">官方文档</a></li><li><a href="https://github.com/rest-assured/rest-assured/wiki/Usage" target="_blank" rel="noopener">WIKI</a></li><li><a href="https://github.com/caochikai/cucumber-rest-assured" target="_blank" rel="noopener">配套代码</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;接口测试-Rest-assured&quot;&gt;&lt;a href=&quot;#接口测试-Rest-assured&quot; class=&quot;headerlink&quot; title=&quot;接口测试 Rest-assured&quot;&gt;&lt;/a&gt;接口测试 Rest-assured&lt;/h1&gt;&lt;h1 id=&quot;一、如何确
      
    
    </summary>
    
    
    
      <category term="Test" scheme="https://caochikai.github.io/tags/Test/"/>
    
  </entry>
  
  <entry>
    <title>API Standard</title>
    <link href="https://caochikai.github.io/2021/08/01/API-Standard/"/>
    <id>https://caochikai.github.io/2021/08/01/API-Standard/</id>
    <published>2021-08-01T07:30:00.000Z</published>
    <updated>2021-08-01T07:30:37.660Z</updated>
    
    <content type="html"><![CDATA[<h1 id="API-Standard"><a href="#API-Standard" class="headerlink" title="API Standard"></a>API Standard</h1><h1 id="一、意义"><a href="#一、意义" class="headerlink" title="一、意义"></a>一、意义</h1><blockquote><p><strong>API standard即接口标准，它提供了工程开发指南和最好的培训实现，能让API接口开发者自愿跟随共同的工程标准，技术解决方案，公共库管理，甚至是构建API的模板。</strong></p></blockquote><h2 id="二、各项标准"><a href="#二、各项标准" class="headerlink" title="二、各项标准"></a>二、各项标准</h2><blockquote><p><strong>项目标准涉及到方方面面，随着业务不断发展，持续演变进化，架构团队需要与各团队深度合作，成立架构评审委员会ARB，在不断配合业务部门支撑公司业务发展，勇于承担重任</strong>。</p></blockquote><table><thead><tr><th>分类</th><th>标准</th><th>文档名称</th><th>目的</th></tr></thead><tbody><tr><td>培训</td><td>开发者工具和权限申请</td><td>培训文档</td><td>使用免费的软件和工具是主要方向，应根据最小权限原则在必要时候申请。</td></tr><tr><td>培训</td><td>快速开始指引</td><td>新人指引<br/>离职指引<br/>技术经理指引<br/>数据库工程师指引</td><td>基于不同的团队角色提供开始文档，比如leader和developer</td></tr><tr><td>开发流程</td><td>代码标准</td><td>代码标准</td><td>在API开发中必须遵循代码标准</td></tr><tr><td>开发流程</td><td>分支策略</td><td>分支管理策略</td><td>提供分支、提交信息、拉请求和代码合并的命名规定。<br/>主分支是保护分支。理想情况下，开发完成才有主分支。<br/>feature功能分支合并后必须删除。</td></tr><tr><td>开发流程</td><td>CI/CD Pipeline</td><td>CI/CD Pipeline</td><td>在上生产之前必须审查扫描报告</td></tr><tr><td>接口设计</td><td>HTTP REST，API契约和JSON标准</td><td>接口设计</td><td>遵循OpenAPI 或者RAML规范。<br/>JSON schema和example由开发者必须提供。</td></tr><tr><td>应用基础</td><td>Spring Boot框架</td><td>应用基础</td><td>选型Spring Boot作为后端API开发基础框架。<br/>提供父POM和公共包推动API接口开发。</td></tr><tr><td>应用基础</td><td>依赖管理</td><td>源码依赖管理</td><td>提供parent-dependencies BOM统一依赖管理。<br/>提供两套父POM针对WebMvc和WebFlux标准给API开发。<br/>开发者可以根据需求选择其中一个父POM。</td></tr><tr><td>应用基础</td><td>仓库、包、类、文件夹结构的命名规范和代码规范</td><td>源码管理</td><td>开发者应当遵守包命名规范。<br/>为SpringBoot API提供了预定义的文件夹和文件结构。<br/>提供了编码规范，建议开发人员应遵循。</td></tr><tr><td>应用基础</td><td>公共库</td><td>公共库</td><td>提供公共库来推动API开发。<br/>logging<br/>error-handing<br/>raml-paser<br/>http-client</td></tr><tr><td>应用基础</td><td>模板和参考实现</td><td>模板和参考实现</td><td>提供简单和模板。<br/>提供代码生成器。</td></tr><tr><td>编码流程</td><td>业务流程和编排</td><td>业务流程和编排</td><td>对基础服务选择同步或者异步调用。<br/>对基础服务选择同步或者顺序调用。<br/>复杂编排规范分析。</td></tr><tr><td>编码流程</td><td>非阻塞IO和响应式模式</td><td>非阻塞IO和响应式模式</td><td>应当使用Reactor Reactive开发。</td></tr><tr><td>编码流程</td><td>数据校验</td><td>数据校验</td><td>输入数据必须要在业务处理之前校验。<br/>API规范中必须定义数据校验。</td></tr><tr><td>编码流程</td><td>数据转化和匹配</td><td>数据转化和匹配</td><td>MapStruct选型为mapping framework。<br/>Jackson选型为默认json和POJO 转化框架。<br/>Lombok禁止使用。</td></tr><tr><td>编码流程</td><td>限流熔断</td><td>限流熔断</td><td>在应用推荐使用resislence4j库。</td></tr><tr><td>编码流程</td><td>异常处理</td><td>异常处理</td><td>Error Schema必须遵守。<br/>自定义HTTP状态码和Error code不要冲突公共规范。<br/>提供公共全局异常处理库处理应用跑出的error。</td></tr><tr><td>协议支持</td><td>Http Server</td><td>Http Server</td><td>强制默认使用tomcat和8080端口或netty。</td></tr><tr><td>协议支持</td><td>HTTP Client</td><td>HTTP Client</td><td>Reactor Netty Client是核心http client库。<br/>公共库提供默认配置和扩展配置。如超时、代理等。</td></tr><tr><td>协议支持</td><td>数据加密和安全</td><td>数据加密和安全</td><td>提供公共库异步记录请求和响应到日志，保护敏感数据进行加密打印。</td></tr><tr><td>安全</td><td>鉴权</td><td>鉴权</td><td>强制开启Token校验。<br/>允许健康检查相关端点跳过。</td></tr><tr><td>安全</td><td>授权</td><td>授权</td><td>针对用户角色校验当前请求时候是否有权限。</td></tr><tr><td>安全</td><td>环境变量加密</td><td>环境变量加密</td><td>阿里云密钥管理服务（KMS）或者AWS Secret Mananger来存储环境变量。</td></tr><tr><td>安全</td><td>密钥管理</td><td>密钥管理</td><td>阿里云密钥管理服务（KMS）或者AWS Secret Mananger来管理秘钥，通过脚本定期更新服务密码。如数据库和redis。</td></tr><tr><td>安全</td><td>SSL强制校验</td><td>SSL强制校验</td><td>所有连接必须使用SSL加密。<br/>应用中通过Https FItler强制开启。</td></tr><tr><td>安全</td><td>参数加密解密</td><td>参数加密解密</td><td>公共库secure-data提供运行时重要参数加密解密。</td></tr><tr><td>安全</td><td>Client ID和Secret秘钥对</td><td>Client ID和Secret秘钥对</td><td>针对部分的外部第三应用授权和接口限流。</td></tr><tr><td>监控和故障排查</td><td>日志</td><td>日志</td><td>关键信息必须打印。<br/>提供公共包logging。</td></tr><tr><td>监控和故障排查</td><td>日志框架</td><td>日志框架</td><td>SF4J and logback选型为默认日志库。</td></tr><tr><td>监控和故障排查</td><td>日志规范</td><td>日志规范</td><td>INFO级别为默认配置。<br/>长时间处理任务必须打印日志。<br/>日志打印点和数据必须review。</td></tr><tr><td>监控和故障排查</td><td>日志配置和输出</td><td>日志配置和输出</td><td>提供公共日志配置和公共抽象接口，异常时将打印erro并返回规定error schema。</td></tr><tr><td>监控和故障排查</td><td>日志追踪</td><td>日志追踪</td><td>日志必须记录异常出现信息和Trace ID，不能吞掉异常信息。</td></tr><tr><td>监控和故障排查</td><td>Info和Health端点</td><td>Info和Health端点</td><td>提供公共库endpoint。<br/>info端点必须提供当前应用基础信息。<br/>health端点必须保护应用当前状态。</td></tr><tr><td>监控和故障排查</td><td>Splunk集成</td><td>Splunk集成</td><td>通过CICD pipeline配置namespace lable完成集成。<br/>在控制台必须符合监控规范。</td></tr><tr><td>监控和故障排查</td><td>AppDynamic集成</td><td>AppDynamic集成</td><td>在容器里配置JAVAOPS AppDynamic参数和agent集成。</td></tr><tr><td>支持</td><td>发布配置</td><td>发布配置</td><td>推荐发布配置不要参合到应用代码。<br/>通过属性外部化配置，如容器环境变量，通过不修改代码和重新部署情况下方便重新调整配置。</td></tr><tr><td>支持</td><td>多区域发布支持</td><td>多区域发布支持</td><td>同一套代码支持不同数据中心。</td></tr><tr><td>测试</td><td>单元测试和代码覆盖率</td><td>单元测试和代码覆盖率</td><td>使用Junit 5 单元测试框架。<br/>提供公共库完成API功能测试。<br/>行和分支测试覆盖率不能低于100%。</td></tr><tr><td>测试</td><td>集成测试</td><td>集成测试</td><td>做测试渗透率和压力测试。<br/>提供jemeter压测脚本和框架，通过Prometheus控制面板集成Jenkins报告和AppDynamic jvm性能指标。</td></tr><tr><td>审计</td><td>Checkmax, Nexus IQ,SonarQube和Jacoco</td><td>代码质量测量</td><td>Checkmax能检查应用代码漏洞，要求必须为零。<br/>Nexus IQ扫描安全和license法务风险，超低级必须低于5个，中高级风险必须为零，否则提供审计报告。<br/>SonarQube和jacoco测量代码和测试质量，漏洞和错误必须为零，测试覆盖必须100%。</td></tr><tr><td>审计</td><td>README.md</td><td>项目文档规范</td><td>READMED.md必须强制记录关键信息。</td></tr><tr><td>其他</td><td>架构演变历史</td><td>架构演变历史</td><td>记录架构随年度变化演变历史背景。</td></tr><tr><td>其他</td><td>支持插件</td><td>支持插件</td><td>提供插件支持根据预定义规则扫描Maven构建过程中的源码，上传到分析服务，生成对应报告，验证当前代码是否符合整套架构规范。</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;API-Standard&quot;&gt;&lt;a href=&quot;#API-Standard&quot; class=&quot;headerlink&quot; title=&quot;API Standard&quot;&gt;&lt;/a&gt;API Standard&lt;/h1&gt;&lt;h1 id=&quot;一、意义&quot;&gt;&lt;a href=&quot;#一、意义&quot; cla
      
    
    </summary>
    
    
    
      <category term="架构" scheme="https://caochikai.github.io/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>行为驱动测试BDD Cucumber方案</title>
    <link href="https://caochikai.github.io/2021/08/01/%E8%A1%8C%E4%B8%BA%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95BDD-Cucumber%E6%96%B9%E6%A1%88/"/>
    <id>https://caochikai.github.io/2021/08/01/%E8%A1%8C%E4%B8%BA%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95BDD-Cucumber%E6%96%B9%E6%A1%88/</id>
    <published>2021-07-31T16:19:00.000Z</published>
    <updated>2021-07-31T16:21:30.953Z</updated>
    
    <content type="html"><![CDATA[<h1 id="行为驱动测试BDD-Cucumber方案"><a href="#行为驱动测试BDD-Cucumber方案" class="headerlink" title="行为驱动测试BDD Cucumber方案"></a>行为驱动测试BDD Cucumber方案</h1><h1 id="一、什么是BDD"><a href="#一、什么是BDD" class="headerlink" title="一、什么是BDD"></a>一、什么是BDD</h1><blockquote><p>Behaviour-Driven Development既行为驱动开发，是构建Cucumber以支持的软件开发过程。</p></blockquote><h3 id="BDD是软件团队的一种工作方式，通过以下方式缩小业务人员和技术人员之间的差距"><a href="#BDD是软件团队的一种工作方式，通过以下方式缩小业务人员和技术人员之间的差距" class="headerlink" title="BDD是软件团队的一种工作方式，通过以下方式缩小业务人员和技术人员之间的差距:"></a>BDD是软件团队的一种工作方式，通过以下方式缩小业务人员和技术人员之间的差距:</h3><ul><li>鼓励跨角色的协作，以建立对要解决的问题的共享理解。</li><li>业务员根据用户的行为生成需求场景描述文档，比如行为条件和参数，相当于伪代码。</li><li>技术人员通过用户的行为场景设计测试用例，验收和驱动开发，并生成符合伪代码报告。<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-25.png" alt="敏捷流程" title="">                </div>                <div class="image-caption">敏捷流程</div>            </figure></li></ul><h1 id="二、Cucumber特性"><a href="#二、Cucumber特性" class="headerlink" title="二、Cucumber特性"></a>二、Cucumber特性</h1><blockquote><p>Cucumber是一种可以使用文本描述语言来执行自动测试用例的工具，使用的语言叫做Gherkin。Gherkin用于描述软件的行为而不需要了解具体的实现，主要有两个目的文档和自动测试用例（最好和手工测试用例统一）。 Gherkin支持超过40种语言，包括英文、中文。 Gherkin可以在任何地方新增注释，注释已#开头，都是以.feature结尾，在feature文件中输入功能描述、场景、步骤，当执行这个功能时每一个步骤都需要编写java代码块来实现具体的功能。当前cucumber支持多种语言，还可以使用java和spring、javascript和react。下面是Cucumber Ruby 官方截图：</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-26.png" alt="Ruby官方例子" title="">                </div>                <div class="image-caption">Ruby官方例子</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-27.png" alt="Cucumber Report截图" title="">                </div>                <div class="image-caption">Cucumber Report截图</div>            </figure><h2 id="Gherkin语言基本概念："><a href="#Gherkin语言基本概念：" class="headerlink" title="Gherkin语言基本概念："></a>Gherkin语言基本概念：</h2><h3 id="Features功能"><a href="#Features功能" class="headerlink" title="Features功能"></a>Features功能</h3><blockquote><p>一个feature文件对应一组集合功能，比如用户管理。</p></blockquote><h3 id="Scenario场景"><a href="#Scenario场景" class="headerlink" title="Scenario场景"></a>Scenario场景</h3><blockquote><p>一个feature文件对应一组Scenario场景，比如用户管理功能有新增用户，删除用户，修改用户和查询用户四个场景。Scenario Outline场景大纲必须包含一个示例Examples，Examples有多少行测试驱动数据，测试场景Scenario就执行多少次，以下面步骤第一步Given step的<day>参数变量，就来源于Examples下的day。</p></blockquote><h3 id="Step-denfinitions步骤"><a href="#Step-denfinitions步骤" class="headerlink" title="Step denfinitions步骤"></a>Step denfinitions步骤</h3><blockquote><p>Scenario场景下有多个Step步骤，每一Step步骤都以Given, When, Then, And, or But开始。</p></blockquote><h3 id="Given-When-then-假如-当-那么"><a href="#Given-When-then-假如-当-那么" class="headerlink" title="Given When then(假如 当 那么)"></a>Given When then(假如 当 那么)</h3><blockquote><p>每一步都以Given, When, Then, And, or But开始。java实现都有对应注解。</p></blockquote><ul><li>Given——@Given：用例开始执行前的一个前置条件，比如用户已经登录对应代码有jwt token。</li><li>When——@When：用例开始执行的一些关键操作步骤，类似修改用户性别等。</li><li>Then——@Then：观察结果，就是平时用例中的验证步骤，比如修改后验证数据库是否存入操作成功。</li></ul><h3 id="通过下列步骤介绍Cucumber流程："><a href="#通过下列步骤介绍Cucumber流程：" class="headerlink" title="通过下列步骤介绍Cucumber流程："></a>通过下列步骤介绍Cucumber流程：</h3><ul><li><p>第一步：通过Gherkin伪代码文本语言描述，写到feature文件。以官方10分钟体验为例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Feature: Is it Friday yet?</span><br><span class="line">  Everybody wants to know when it<span class="string">'s Friday</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Scenario Outline: Today is or is not Friday</span></span><br><span class="line"><span class="string">    Given today is "&lt;day&gt;"</span></span><br><span class="line"><span class="string">    When I ask whether it'</span>s Friday yet</span><br><span class="line">    Then I should be told <span class="string">"&lt;answer&gt;"</span></span><br><span class="line"></span><br><span class="line">  Examples:</span><br><span class="line">    | day            | answer |</span><br><span class="line">    | Friday         | TGIF   |</span><br><span class="line">    | Sunday         | Nope   |</span><br><span class="line">    | anything <span class="keyword">else</span>! | Nope   |</span><br></pre></td></tr></table></figure></li><li><p>使用java进行步骤定义。feature文件的step对应了每个java方法上的注解，而且注解双引号文本内容在所有feature中唯一且不可重复。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hellocucumber;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.Given;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.When;</span><br><span class="line"><span class="keyword">import</span> io.cucumber.java.en.Then;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsItFriday</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">isItFriday</span><span class="params">(String today)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Friday"</span>.equals(today) ? <span class="string">"TGIF"</span> : <span class="string">"Nope"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stepdefs</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String today;</span><br><span class="line">    <span class="keyword">private</span> String actualAnswer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Given</span>(<span class="string">"today is &#123;string&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">today_is</span><span class="params">(String today)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.today = today;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@When</span>(<span class="string">"I ask whether it's Friday yet"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">i_ask_whether_it_s_Friday_yet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        actualAnswer = IsItFriday.isItFriday(today);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Then</span>(<span class="string">"I should be told &#123;string&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">i_should_be_told</span><span class="params">(String expectedAnswer)</span> </span>&#123;</span><br><span class="line">        assertEquals(expectedAnswer, actualAnswer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Maven mvn test控制台输出:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------</span><br><span class="line"> T E S T S</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">Running hellocucumber.RunCucumberTest</span><br><span class="line">Feature: Is it Friday yet?</span><br><span class="line">  Everybody wants to know when it&#39;s Friday</span><br><span class="line"></span><br><span class="line">  Scenario Outline: Today is or is not Friday # hellocucumber&#x2F;is_it_friday_yet.feature:4</span><br><span class="line">    Given today is &quot;&lt;day&gt;&quot;</span><br><span class="line">    When I ask whether it&#39;s Friday yet</span><br><span class="line">    Then I should be told &quot;&lt;answer&gt;&quot;</span><br><span class="line"></span><br><span class="line">    Examples:</span><br><span class="line"></span><br><span class="line">  Scenario Outline: Today is or is not Friday # hellocucumber&#x2F;is_it_friday_yet.feature:11</span><br><span class="line">    Given today is &quot;Friday&quot;                   # Stepdefs.today_is(String)</span><br><span class="line">    When I ask whether it&#39;s Friday yet        # Stepdefs.i_ask_whether_it_s_Friday_yet()</span><br><span class="line">    Then I should be told &quot;TGIF&quot;              # Stepdefs.i_should_be_told(String)</span><br><span class="line"></span><br><span class="line">  Scenario Outline: Today is or is not Friday # hellocucumber&#x2F;is_it_friday_yet.feature:12</span><br><span class="line">    Given today is &quot;Sunday&quot;                   # Stepdefs.today_is(String)</span><br><span class="line">    When I ask whether it&#39;s Friday yet        # Stepdefs.i_ask_whether_it_s_Friday_yet()</span><br><span class="line">    Then I should be told &quot;Nope&quot;              # Stepdefs.i_should_be_told(String)</span><br><span class="line"></span><br><span class="line">  Scenario Outline: Today is or is not Friday # hellocucumber&#x2F;is_it_friday_yet.feature:13</span><br><span class="line">    Given today is &quot;anything else!&quot;           # Stepdefs.today_is(String)</span><br><span class="line">    When I ask whether it&#39;s Friday yet        # Stepdefs.i_ask_whether_it_s_Friday_yet()</span><br><span class="line">    Then I should be told &quot;Nope&quot;              # Stepdefs.i_should_be_told(String)</span><br><span class="line"></span><br><span class="line">3 Scenarios (3 passed)</span><br><span class="line">9 Steps (9 passed)</span><br><span class="line">0m0.255s</span><br></pre></td></tr></table></figure></li></ul><h1 id="三、集成Spring生成测试报告"><a href="#三、集成Spring生成测试报告" class="headerlink" title="三、集成Spring生成测试报告"></a>三、集成Spring生成测试报告</h1><h2 id="Maven-Dependencies"><a href="#Maven-Dependencies" class="headerlink" title="Maven Dependencies"></a>Maven Dependencies</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="REST-Controller"><a href="#REST-Controller" class="headerlink" title="REST Controller"></a>REST Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VersionController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/version"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1.0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Cucumber-Step-Definitions"><a href="#Cucumber-Step-Definitions" class="headerlink" title="Cucumber Step Definitions"></a>Cucumber Step Definitions</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单独跑Cucumber</span></span><br><span class="line"><span class="meta">@RunWith</span>(Cucumber<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">CucumberOptions</span>(<span class="title">features</span> </span>= <span class="string">"src/test/resources"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CucumberIntegrationTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Feature: the version can be retrieved</span><br><span class="line">  Scenario: client makes call to GET /version</span><br><span class="line">    When the client calls /version</span><br><span class="line">    Then the client receives status code of <span class="number">200</span></span><br><span class="line">    And the client receives server version <span class="number">1.0</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@When</span>(<span class="string">"^the client calls /version$"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_issues_GET_version</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">    executeGet(<span class="string">"http://localhost:8080/version"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Then</span>(<span class="string">"^the client receives status code of (\\d+)$"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_receives_status_code_of</span><span class="params">(<span class="keyword">int</span> statusCode)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    HttpStatus currentStatusCode = latestResponse.getTheResponse().getStatusCode();</span><br><span class="line">    assertThat(<span class="string">"status code is incorrect : "</span>+ </span><br><span class="line">    latestResponse.getBody(), currentStatusCode.value(), is(statusCode));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@And</span>(<span class="string">"^the client receives server version (.+)$"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_receives_server_version_body</span><span class="params">(String version)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    assertThat(latestResponse.getBody(), is(version));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//集成Springboot</span></span><br><span class="line"><span class="meta">@CucumberContextConfiguration</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringIntegrationTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// executeGet implementation</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//进行接口自动化测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StepDefs</span> <span class="keyword">extends</span> <span class="title">SpringIntegrationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@When</span>(<span class="string">"^the client calls /version$"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">the_client_issues_GET_version</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        executeGet(<span class="string">"http://localhost:8080/version"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="四、Moco-Server在集成测试和开发中应用"><a href="#四、Moco-Server在集成测试和开发中应用" class="headerlink" title="四、Moco Server在集成测试和开发中应用"></a>四、<a href="https://github.com/dreamhead/moco" target="_blank" rel="noopener">Moco Server</a>在集成测试和开发中应用</h1><blockquote><p>moco工具是在github开源的一个项目，可以搭一个简单的mock server方便我们进行开发调试，以及在单元测试中取消边界服务。有两种形式，第一种是集成到项目，随项目启动提供http mock服务。第二种是一个jar包，配合配置文件和命令启动http服务。</p></blockquote><h2 id="通过jar提供mock-http服务："><a href="#通过jar提供mock-http服务：" class="headerlink" title="通过jar提供mock http服务："></a>通过jar提供mock http服务：</h2><p>首先我们要编写一个config文件，把我们需要“模拟”的请求和响应写入这个配置文件，配置文件是json格式的访问 localhost:12306/hello 接口，返回一个纯文本“moco”。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"request"</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"uri"</span>:<span class="string">"/hello"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"response"</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"text"</span>:<span class="string">"moco"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>启动指令：</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar moco-runner-0.11.1-standalone.jar http -p 12306 -c config.json</span><br></pre></td></tr></table></figure><h2 id="集成到项目"><a href="#集成到项目" class="headerlink" title="集成到项目"></a>集成到项目</h2><h2 id="Maven-Dependencies-1"><a href="#Maven-Dependencies-1" class="headerlink" title="Maven Dependencies"></a>Maven Dependencies</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.dreamhead<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>moco-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="API-Test"><a href="#API-Test" class="headerlink" title="API Test"></a>API Test</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.github.dreamhead.moco.Moco.httpServer;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.github.dreamhead.moco.Runner.runner;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.CoreMatchers.is;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.MatcherAssert.assertThat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MocoRunnerTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Runner runner;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpServer server = httpServer(<span class="number">12306</span>);</span><br><span class="line">        server.response(<span class="string">"foo"</span>);</span><br><span class="line">        runner = runner(server);</span><br><span class="line">        runner.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        runner.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">should_response_as_expected</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Content content = Request.Get(<span class="string">"http://localhost:12306"</span>).execute().returnContent();</span><br><span class="line">        assertThat(content.asString(), is(<span class="string">"foo"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h1><ol><li><a href="https://cucumber.io/docs/guides/" target="_blank" rel="noopener">Cucumber官方文档</a></li><li><a href="https://reports.cucumber.io/" target="_blank" rel="noopener">Cucumber测试报告例子</a></li><li><a href="https://www.cnblogs.com/jarodzz/archive/2012/07/26/2610617.html" target="_blank" rel="noopener">Cucumber入门2 - 啥是BDD？</a></li><li><a href="https://github.com/dreamhead/moco/blob/master/moco-doc/usage.md" target="_blank" rel="noopener">Moco Server</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;行为驱动测试BDD-Cucumber方案&quot;&gt;&lt;a href=&quot;#行为驱动测试BDD-Cucumber方案&quot; class=&quot;headerlink&quot; title=&quot;行为驱动测试BDD Cucumber方案&quot;&gt;&lt;/a&gt;行为驱动测试BDD Cucumber方案&lt;/h1&gt;&lt;
      
    
    </summary>
    
    
    
      <category term="Test" scheme="https://caochikai.github.io/tags/Test/"/>
    
  </entry>
  
  <entry>
    <title>Netty Connection prematurely closed BEFORE response和connection reset by peer解决方案</title>
    <link href="https://caochikai.github.io/2021/07/31/Netty-Connection-prematurely-closed-BEFORE-response%E5%92%8Cconnection-reset-by-peer%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://caochikai.github.io/2021/07/31/Netty-Connection-prematurely-closed-BEFORE-response%E5%92%8Cconnection-reset-by-peer%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2021-07-31T03:50:00.000Z</published>
    <updated>2021-07-31T04:01:32.379Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Netty-Connection-prematurely-closed-BEFORE-response和connection-reset-by-peer解决方案"><a href="#Netty-Connection-prematurely-closed-BEFORE-response和connection-reset-by-peer解决方案" class="headerlink" title="Netty Connection prematurely closed BEFORE response和connection reset by peer解决方案"></a>Netty Connection prematurely closed BEFORE response和connection reset by peer解决方案</h1><h1 id="一、异常说明"><a href="#一、异常说明" class="headerlink" title="一、异常说明"></a>一、异常说明</h1><blockquote><p>在长达一年时间里面，由于云基础设施kubernetes经常升级更新，以及网络原因不定期出现。长期和云设施部门打交道，所有k8s集群都是Istio进行流量控制，Istio提供服务网格服务。如果要请求到容器外部网络，需要通过Egress Gateway的组件，从HTTPS代理Squid proxy请求外部网络。一个Squid proxy集群对应一个k8s，一个Squid集群十二个节点，部分节点出现故障就会造成整个集群出现概率性netty请求异常。作为踩雷先锋队和救火员，所以很多其他部门或者团队都有向我咨询反馈，首先从日志平台Splunk搜索到异常，进入容器通过curl -kv 测试外部请求，出现概率性连接异常，连接被重置了。概率问题通常会想到jemeter做接口压测，通过jemeter的聚合报告，大概有23%概率出现error，写报告申请云设施部门反馈，最终发现某个Squid节点故障，删除该节点再次压测，一切恢复正常。后面一段时间，遇到部署成功，第一次请求一定发生该上次问题，反馈之后短时间没解决，我们通过netty reactor retry策略，一旦发生该异常触发重试请求，从代码上解决问题。</p></blockquote><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CURL ERROR: Recv failure: Connection reset by peer</span><br></pre></td></tr></table></figure><h2 id="Splunk收集到的异常日志："><a href="#Splunk收集到的异常日志：" class="headerlink" title="Splunk收集到的异常日志："></a><a href="https://github.com/splunk/splunk-connect-for-kubernetes" target="_blank" rel="noopener">Splunk</a>收集到的异常日志：</h2><blockquote><p>Splunk是收集实时IT设施的数据日志平台，在国外非常流行，类似商业化的ELK。架构上通过splunk-connect-for-kubernetes开源项目，负责收集几个K8s集群的容器日志，每个集群大概200到300多个namespace，可以说性能非常给力。</p></blockquote><p>Connection prematurely closed BEFORE response</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reactor.core.ReactiveException: reactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response</span><br><span class="line">    at reactor.core.Exceptions.propagate(Exceptions.java:<span class="number">393</span>)</span><br><span class="line">    at reactor.core.publisher.BlockingSingleSubscriber.blockingGet(BlockingSingleSubscriber.java:<span class="number">97</span>)</span><br><span class="line">    at reactor.core.publisher.Mono.block(Mono.java:<span class="number">1678</span>)</span><br><span class="line">·······业务相关，省略</span><br></pre></td></tr></table></figure><p>connection reset by peer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java.io.IOException: Connection reset by peer</span><br><span class="line">    at sun.nio.ch.FileDispatcherImpl.read0(FileDispatcherImpl.java)</span><br><span class="line">    at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:<span class="number">39</span>)</span><br><span class="line">    at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:<span class="number">223</span>)</span><br><span class="line">    at sun.nio.ch.IOUtil.read(IOUtil.java:<span class="number">192</span>)</span><br><span class="line">    at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:<span class="number">380</span>)</span><br><span class="line">    at io.netty.buffer.PooledUnsafeDirectByteBuf.setBytes(PooledUnsafeDirectByteBuf.java:<span class="number">288</span>)</span><br><span class="line">    at io.netty.buffer.AbstractByteBuf.writeBytes(AbstractByteBuf.java:<span class="number">1108</span>)</span><br><span class="line">    at io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:<span class="number">345</span>)</span><br><span class="line">    at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:<span class="number">131</span>)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:<span class="number">645</span>)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:<span class="number">580</span>)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:<span class="number">497</span>)</span><br><span class="line">    at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:<span class="number">459</span>)</span><br><span class="line">    at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="number">5</span>.run(SingleThreadEventExecutor.java:<span class="number">886</span>)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure><h1 id="二、Retry策略解决第一次必定出现Connection-reset-by-peer"><a href="#二、Retry策略解决第一次必定出现Connection-reset-by-peer" class="headerlink" title="二、Retry策略解决第一次必定出现Connection reset by peer"></a>二、Retry策略解决第一次必定出现Connection reset by peer</h1><blockquote><p>在实际的开发中，可以请求重试的场景应该是：网络异常、请求超时异常，需根据实际应用场景的设计重试策略，防止重试带来接口幂等性问题。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Retry&lt;?&gt; retry = Retry.onlyIf(x -&gt; x.exception() <span class="keyword">instanceof</span> IOException)</span><br><span class="line">        .retryMax(<span class="number">3</span>) <span class="comment">// 重试3次</span></span><br><span class="line">        .backoff(Backoff.exponential(Duration.ofSeconds(<span class="number">5</span>),Duration.ofSeconds(<span class="number">60</span>),<span class="number">2</span>,<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">Mono&lt;String&gt; mono = webClient</span><br><span class="line">        .get()    <span class="comment">//GET 请求</span></span><br><span class="line">        .uri(<span class="string">"/posts/1"</span>)  <span class="comment">// 请求路径,这里的请求路径是正确的</span></span><br><span class="line">        .retrieve()</span><br><span class="line">        .bodyToMono(String<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        .<span class="title">retryWhen</span>(<span class="title">retry</span>)</span>;   <span class="comment">//满足Retry条件进行重试</span></span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"====="</span> + mono.block());</span><br></pre></td></tr></table></figure><h1 id="三、网络分析"><a href="#三、网络分析" class="headerlink" title="三、网络分析"></a>三、网络分析</h1><blockquote><p>网络异常原因从本质上网络连接，牵扯到TCP三次握手建立连接，又导致Socket套接字在读取数据时，服务器端因为某种原因提前关闭了Connection，而客户端依然用握手成功的旧连接在读写数据，此时服务器会返回复位标志“RST”，然后客户端就会提示“java.net.SocketException: Connection reset”。</p></blockquote><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="套接字Socket"><a href="#套接字Socket" class="headerlink" title="套接字Socket"></a>套接字Socket</h3><blockquote><p>以192.168.1.11:80为例子，TCP把连接作为最基本的对象，每一条TCP连接都有两个端点，这种端点我们叫作套接字（socket），它的定义为端口号拼接到IP地址即构成了套接字。</p></blockquote><h3 id="半连接队列和全连接队列"><a href="#半连接队列和全连接队列" class="headerlink" title="半连接队列和全连接队列"></a>半连接队列和全连接队列</h3><blockquote><p>在 TCP 三次握手的时候，Linux 内核会维护两个队列，分别是：半连接队列，也称 SYN 队列；全连接队列，也称 accepet 队列；</p></blockquote><blockquote><p>服务端收到客户端发起的 SYN 请求后，内核会把该连接存储到半连接队列，并向客户端响应 SYN+ACK，接着客户端会返回 ACK，服务端收到第三次握手的 ACK 后，内核会把连接从半连接队列移除，然后创建新的完全的连接，并将其添加到 accept 队列，等待进程调用 accept 函数时把连接取出来。</p></blockquote><h3 id="滑动窗口"><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3><blockquote><p>控制报文流量，用来告诉对方目前接收端缓冲器大小。当为0时标识缓冲器已满，需要停止发包，单位为byte。</p></blockquote><h3 id="SYN"><a href="#SYN" class="headerlink" title="SYN"></a>SYN</h3><blockquote><p>同步序列编号（Synchronize Sequence Numbers），在客户机和服务器之间建立正常的TCP网络连接时，客户机首先发出一个SYN消息。</p></blockquote><h3 id="ACK"><a href="#ACK" class="headerlink" title="ACK"></a>ACK</h3><blockquote><p>Acknowledge character即是确认字符，在数据通信中，接收站发给发送站的一种传输类控制字符。</p></blockquote><h3 id="RST"><a href="#RST" class="headerlink" title="RST"></a>RST</h3><blockquote><p>Reset the connection表示复位，关闭因某种原因引起出现的错误连接，也用来拒绝非法数据和请求。</p></blockquote><h3 id="FIN"><a href="#FIN" class="headerlink" title="FIN"></a>FIN</h3><blockquote><p>No more data from sender，用来释放连接，表明发送方已经没有数据发送了。</p></blockquote><h3 id="URG"><a href="#URG" class="headerlink" title="URG"></a>URG</h3><blockquote><p>Urgent Pointer field significant紧急指针。用到的时候值为1，用来处理避免TCP数据流中断。</p></blockquote><h3 id="PSH"><a href="#PSH" class="headerlink" title="PSH"></a>PSH</h3><blockquote><p>Push Function——PUSH标志的数据，置1时请求的数据段在接收方得到后就可直接送到应用程序，而不必等到缓冲区满时才传送。</p></blockquote><h3 id="wireshark网络抓包TCP三次握手到RST复位"><a href="#wireshark网络抓包TCP三次握手到RST复位" class="headerlink" title="wireshark网络抓包TCP三次握手到RST复位"></a>wireshark网络抓包TCP三次握手到RST复位</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-21.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h2 id="TCP协议：三次握手、四次挥手"><a href="#TCP协议：三次握手、四次挥手" class="headerlink" title="TCP协议：三次握手、四次挥手"></a>TCP协议：三次握手、四次挥手</h2><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-22.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="三次握手建立连接"><a href="#三次握手建立连接" class="headerlink" title="三次握手建立连接"></a>三次握手建立连接</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-23.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="四次握手关闭连接"><a href="#四次握手关闭连接" class="headerlink" title="四次握手关闭连接"></a>四次握手关闭连接</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-24.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h1 id="四、参考资料"><a href="#四、参考资料" class="headerlink" title="四、参考资料"></a>四、参考资料</h1><ol><li><a href="https://blog.csdn.net/hanxiaotongtong/article/details/108233421" target="_blank" rel="noopener">WebClient第6篇-请求失败自动重试机制</a></li><li><a href="https://github.com/reactor/reactor-netty/issues/388" target="_blank" rel="noopener">github netty: java.io.IOException: Connection reset by peer</a></li><li><a href="https://blog.csdn.net/a_tu_/article/details/80389878" target="_blank" rel="noopener">TCP中的RST标志(Reset)详解</a></li><li><a href="https://blog.csdn.net/qzcsu/article/details/72861891" target="_blank" rel="noopener">两张动图-彻底明白TCP的三次握手与四次挥手</a></li><li><a href="https://blog.51cto.com/zqxiang/1581776" target="_blank" rel="noopener">TCP协议中的6个重要标志位</a></li><li><a href="https://www.cnblogs.com/xiaolincoding/p/12995358.html" target="_blank" rel="noopener">TCP 半连接队列和全连接队列满了会发生什么？又该如何应对？</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Netty-Connection-prematurely-closed-BEFORE-response和connection-reset-by-peer解决方案&quot;&gt;&lt;a href=&quot;#Netty-Connection-prematurely-closed-BEFO
      
    
    </summary>
    
    
    
      <category term="Linux" scheme="https://caochikai.github.io/tags/Linux/"/>
    
      <category term="TCP" scheme="https://caochikai.github.io/tags/TCP/"/>
    
  </entry>
  
  <entry>
    <title>redis如何实现消息队列</title>
    <link href="https://caochikai.github.io/2020/06/06/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    <id>https://caochikai.github.io/2020/06/06/redis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</id>
    <published>2020-06-06T14:55:00.000Z</published>
    <updated>2020-06-06T15:05:37.202Z</updated>
    
    <content type="html"><![CDATA[<h1 id="redis如何实现消息队列"><a href="#redis如何实现消息队列" class="headerlink" title="redis如何实现消息队列"></a>redis如何实现消息队列</h1><h1 id="一、复盘面试"><a href="#一、复盘面试" class="headerlink" title="一、复盘面试"></a>一、复盘面试</h1><blockquote><p>遇到面试问到：如果我想在redis实现队列，会用到哪个命令？根据<a href="https://www.redis.net.cn/order/" target="_blank" rel="noopener">redis手册</a>关于Redis 列表(List) 命令主要操作有四种非阻塞版lpush/lpop/rpush/rpop，两种阻塞版本blpop/brpop，l和r代表左（left）和右（right）缩写，push代表添加也叫压入，pop代表弹出。基本满足先进入先出（FIFO）效果就完成了基本的队列，本次GitHub实验代码仓库。</p></blockquote><h3 id="通过命令模拟队列"><a href="#通过命令模拟队列" class="headerlink" title="通过命令模拟队列"></a>通过命令模拟队列</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RDM Redis Console</span><br><span class="line">连接中...</span><br><span class="line">已连接。</span><br><span class="line">localhost:0&gt;lpush mylist a b c d</span><br><span class="line"><span class="string">"4"</span></span><br><span class="line">localhost:0&gt;rpop mylist</span><br><span class="line"><span class="string">"a"</span></span><br><span class="line">localhost:0&gt;rpop mylist</span><br><span class="line"><span class="string">"b"</span></span><br><span class="line">localhost:0&gt;rpop mylist</span><br><span class="line"><span class="string">"c"</span></span><br><span class="line">localhost:0&gt;rpop mylist</span><br><span class="line"><span class="string">"d"</span></span><br><span class="line">localhost:0&gt;rpop mylist</span><br><span class="line">null</span><br><span class="line">localhost:0&gt;</span><br></pre></td></tr></table></figure><h1 id="二、java模拟队列实现生产者消费者模式"><a href="#二、java模拟队列实现生产者消费者模式" class="headerlink" title="二、java模拟队列实现生产者消费者模式"></a>二、java模拟队列实现生产者消费者模式</h1><h3 id="redis配置常量"><a href="#redis配置常量" class="headerlink" title="redis配置常量"></a>redis配置常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.charles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis链接地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String host = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis启动端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> port = <span class="number">6379</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正式队列列表名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String task_queue = <span class="string">"task-queue"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 临时队列列表名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String tmp_queue = <span class="string">"tmp-queue"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TaskProducer模拟生产者"><a href="#TaskProducer模拟生产者" class="headerlink" title="TaskProducer模拟生产者"></a>TaskProducer模拟生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.charles;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于模拟生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskProducer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis(Constant.host, Constant.port);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(random.nextInt(<span class="number">600</span>) + <span class="number">600</span>);</span><br><span class="line">                <span class="comment">// 模拟生成一个任务</span></span><br><span class="line">                UUID taskid = UUID.randomUUID();</span><br><span class="line">                <span class="comment">//将任务插入任务队列：task-queue</span></span><br><span class="line">                jedis.lpush(Constant.task_queue, taskid.toString());</span><br><span class="line">                System.out.println(<span class="string">"插入了一个新的任务： "</span> + taskid);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TaskConsumer模拟消费者"><a href="#TaskConsumer模拟消费者" class="headerlink" title="TaskConsumer模拟消费者"></a>TaskConsumer模拟消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.charles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskConsumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis(Constant.host, Constant.port);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从任务队列"task-queue"中获取一个任务，并将该任务放入临时队列"tmp-queue"</span></span><br><span class="line">            String taskid = jedis.rpoplpush(Constant.task_queue, Constant.tmp_queue);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模拟一下：睡觉</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//模拟成功和失败的偶然现象</span></span><br><span class="line">            <span class="keyword">if</span> (random.nextInt(<span class="number">13</span>) % <span class="number">7</span> == <span class="number">0</span>) &#123;<span class="comment">// 模拟失败的情况,概率为2/13</span></span><br><span class="line">                <span class="comment">//将本次处理失败的任务从临时队列"tmp-queue"中，弹回任务队列"task-queue"</span></span><br><span class="line">                jedis.rpoplpush(Constant.task_queue, Constant.tmp_queue);</span><br><span class="line">                System.out.println(taskid + <span class="string">"处理失败，被弹回任务队列"</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// 模拟成功的情况</span></span><br><span class="line">                <span class="comment">// 将本次任务从临时队列"tmp-queue"中清除</span></span><br><span class="line">                jedis.rpop(Constant.tmp_queue);</span><br><span class="line">                System.out.println(taskid + <span class="string">"处理成功，被清除"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TaskShedulerSystem启动生产者和消费者线程"><a href="#TaskShedulerSystem启动生产者和消费者线程" class="headerlink" title="TaskShedulerSystem启动生产者和消费者线程"></a>TaskShedulerSystem启动生产者和消费者线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.charles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskShedulerSystem</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动一个生产者线程，模拟任务的产生</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> TaskProducer()).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">15000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动一个线程者线程，模拟任务的处理</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> TaskConsumer()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="三、参考资料"><a href="#三、参考资料" class="headerlink" title="三、参考资料"></a>三、参考资料</h1><ol><li><a href="https://www.redis.net.cn/order/" target="_blank" rel="noopener">redis中文命令手册</a></li><li><a href="https://github.com/caochikai/java-examples/tree/master/redis%20queue" target="_blank" rel="noopener">GitHub实验代码仓库</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;redis如何实现消息队列&quot;&gt;&lt;a href=&quot;#redis如何实现消息队列&quot; class=&quot;headerlink&quot; title=&quot;redis如何实现消息队列&quot;&gt;&lt;/a&gt;redis如何实现消息队列&lt;/h1&gt;&lt;h1 id=&quot;一、复盘面试&quot;&gt;&lt;a href=&quot;#一、复
      
    
    </summary>
    
    
      <category term="redis" scheme="https://caochikai.github.io/categories/redis/"/>
    
    
      <category term="redis" scheme="https://caochikai.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>基于Seata实现分布式事务</title>
    <link href="https://caochikai.github.io/2020/05/31/%E5%9F%BA%E4%BA%8ESeata%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <id>https://caochikai.github.io/2020/05/31/%E5%9F%BA%E4%BA%8ESeata%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</id>
    <published>2020-05-31T03:24:00.000Z</published>
    <updated>2020-05-31T15:43:02.887Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、Seata简介"><a href="#一、Seata简介" class="headerlink" title="一、Seata简介"></a>一、Seata简介</h2><blockquote><p>2019 年 1 月，阿里巴巴中间件团队发起了开源项目 Fescar（Fast &amp; EaSy Commit And Rollback），蚂蚁金服后在Fescar 0.4.0 版本中贡献了 TCC 模式。后来更名为 Seata，意为：Simple Extensible Autonomous Transaction Architecture，是一套一站式分布式事务解决方案。</p></blockquote><h3 id="Seata三大基本组件："><a href="#Seata三大基本组件：" class="headerlink" title="Seata三大基本组件："></a>Seata三大基本组件：</h3><p><img src="/images/pasted-17.png" alt="upload successful"></p><p><strong>Transaction Coordinator (TC)：</strong> 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</p><p><strong>Transaction Manager (TM)：</strong> 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。</p><p><strong>Resource Manager (RM)：</strong> 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</p><h3 id="Seata官方调用流程图："><a href="#Seata官方调用流程图：" class="headerlink" title="Seata官方调用流程图："></a>Seata官方调用流程图：</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-18.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h2 id="二、Fescar相比XA二阶段优缺点："><a href="#二、Fescar相比XA二阶段优缺点：" class="headerlink" title="二、Fescar相比XA二阶段优缺点："></a>二、Fescar相比XA二阶段优缺点：</h2><h3 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h3><ul><li>基于SQL解析实现了自动补偿，降低业务侵入性。</li><li>第一阶段就本地事务就提交了 ，二阶段commit是异步操作相对XA两段全部持有资源更高效。</li><li>Fescar提供了两种模式，AT和MT。在AT模式下事务资源可以是任何支持ACID的数据库，在MT模式下事务资源没有限制，可以是缓存，可以是文件，可以是其他的等等。当然这两个模式也可以混用。</li><li>global lock全局锁实现了写隔离与读隔离。</li><li>Undolog日志自动清理</li></ul><h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><ul><li>代码入侵性体现为配置Fescar的数据代理和加个注解，每个业务库都需要一个Undolog表。</li><li>从调用图中开源看出性能损耗有：一条Update的SQL，获取全局事务xid（TC通讯）、before image（查询）、after image（查询）、insert undo log（Undolog表的blob字段数据量可不小）、before commit（TC通讯，判断锁冲突）；为了自动补偿在Undolog表花了不小开销，而且触发概率比较低。</li><li>二阶段commit也是需要占用系统资源。</li><li>二阶段回滚需要删除各节点的Undolog才能释放全局锁。</li></ul><h2 id="三、实验"><a href="#三、实验" class="headerlink" title="三、实验"></a>三、实验</h2><blockquote><p>本次实验使用的是官方提供的<a href="https://github.com/seata/seata-samples/tree/master/springcloud-eureka-feign-mybatis-seata" target="_blank" rel="noopener">springcloud-eureka-feign-mybatis-seata</a>工程，模拟远程调用超时异常；通过<a href="http://localhost:8180/order/create?userId=1&productId=1&count=10&money=100" target="_blank" rel="noopener">localhost:8180/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=100</a>触发流程，order本地创建订单调用，远程storage扣减库存，远程扣减账户余额时候模拟该超时异常。下面展示下异常情况下日志信息：</p></blockquote><h3 id="OrderServerApplication日志展示了事务增强拦截器GlobalTransactionalInterceptor"><a href="#OrderServerApplication日志展示了事务增强拦截器GlobalTransactionalInterceptor" class="headerlink" title="OrderServerApplication日志展示了事务增强拦截器GlobalTransactionalInterceptor"></a>OrderServerApplication日志展示了事务增强拦截器GlobalTransactionalInterceptor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">i.seata.tm.api.DefaultGlobalTransaction  : Begin <span class="keyword">new</span> global transaction [<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>]</span><br><span class="line"> i.seata.sample.service.OrderServiceImpl  : -------&gt;交易开始</span><br><span class="line"> i.seata.sample.service.OrderServiceImpl  : -------&gt;扣减账户开始order中</span><br><span class="line"> i.s.core.rpc.netty.RmMessageListener     : onMessage:xid=<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>,branchId=<span class="number">2044579202</span>,branchType=AT,resourceId=jdbc:mysql:<span class="comment">//127.0.0.1/seat-order,applicationData=null</span></span><br><span class="line"> io.seata.rm.AbstractRMHandler            : Branch Rollbacking: <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> <span class="number">2044579202</span> jdbc:mysql:<span class="comment">//127.0.0.1/seat-order</span></span><br><span class="line"> i.s.r.d.undo.AbstractUndoLogManager      : xid <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> branch <span class="number">2044579202</span>, undo_log deleted with GlobalFinished</span><br><span class="line"> io.seata.rm.AbstractRMHandler            : Branch Rollbacked result: PhaseTwo_Rollbacked</span><br><span class="line"> i.seata.tm.api.DefaultGlobalTransaction  : [<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>] rollback status: Rollbacked</span><br><span class="line"> o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() <span class="keyword">for</span> servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is feign.RetryableException: Read timed out executing GET http:<span class="comment">//account-server/account/decrease?userId=1&amp;money=100] with root cause</span></span><br><span class="line"></span><br><span class="line">java.net.SocketTimeoutException: Read timed out</span><br><span class="line">at java.net.SocketInputStream.socketRead0(Native Method) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.io.BufferedInputStream.fill(BufferedInputStream.java:<span class="number">246</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.io.BufferedInputStream.read1(BufferedInputStream.java:<span class="number">286</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.io.BufferedInputStream.read(BufferedInputStream.java:<span class="number">345</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:<span class="number">735</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:<span class="number">678</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:<span class="number">1593</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:<span class="number">1498</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:<span class="number">480</span>) ~[na:<span class="number">1.8</span><span class="number">.0_231</span>]</span><br><span class="line">at feign.Client$Default.convertResponse(Client.java:<span class="number">143</span>) ~[feign-core-<span class="number">10.2</span><span class="number">.3</span>.jar:na]</span><br><span class="line">at feign.Client$Default.execute(Client.java:<span class="number">68</span>) ~[feign-core-<span class="number">10.2</span><span class="number">.3</span>.jar:na]</span><br><span class="line">at com.alibaba.cloud.seata.feign.SeataFeignClient.execute(SeataFeignClient.java:<span class="number">57</span>) ~[spring-cloud-alibaba-seata-<span class="number">2.1</span><span class="number">.0</span>.RELEASE.jar:<span class="number">2.1</span><span class="number">.0</span>.RELEASE]</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.FeignLoadBalancer.execute(FeignLoadBalancer.java:<span class="number">93</span>) ~[spring-cloud-openfeign-core-<span class="number">2.1</span><span class="number">.2</span>.RELEASE.jar:<span class="number">2.1</span><span class="number">.2</span>.RELEASE]</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.FeignLoadBalancer.execute(FeignLoadBalancer.java:<span class="number">56</span>) ~[spring-cloud-openfeign-core-<span class="number">2.1</span><span class="number">.2</span>.RELEASE.jar:<span class="number">2.1</span><span class="number">.2</span>.RELEASE]</span><br><span class="line">at com.netflix.client.AbstractLoadBalancerAwareClient$<span class="number">1</span>.call(AbstractLoadBalancerAwareClient.java:<span class="number">104</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">3</span>$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">303</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">3</span>$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">287</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at rx.internal.util.ScalarSynchronousObservable$<span class="number">3</span>.call(ScalarSynchronousObservable.java:<span class="number">231</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.util.ScalarSynchronousObservable$<span class="number">3</span>.call(ScalarSynchronousObservable.java:<span class="number">228</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.drain(OnSubscribeConcatMap.java:<span class="number">286</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.onNext(OnSubscribeConcatMap.java:<span class="number">144</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">185</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">180</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:<span class="number">94</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:<span class="number">42</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10423</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10390</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.observables.BlockingObservable.blockForSingle(BlockingObservable.java:<span class="number">443</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at rx.observables.BlockingObservable.single(BlockingObservable.java:<span class="number">340</span>) ~[rxjava-<span class="number">1.3</span><span class="number">.8</span>.jar:<span class="number">1.3</span><span class="number">.8</span>]</span><br><span class="line">at com.netflix.client.AbstractLoadBalancerAwareClient.executeWithLoadBalancer(AbstractLoadBalancerAwareClient.java:<span class="number">112</span>) ~[ribbon-loadbalancer-<span class="number">2.3</span><span class="number">.0</span>.jar:<span class="number">2.3</span><span class="number">.0</span>]</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient.execute(LoadBalancerFeignClient.java:<span class="number">83</span>) ~[spring-cloud-openfeign-core-<span class="number">2.1</span><span class="number">.2</span>.RELEASE.jar:<span class="number">2.1</span><span class="number">.2</span>.RELEASE]</span><br><span class="line">at com.alibaba.cloud.seata.feign.SeataLoadBalancerFeignClient.execute(SeataLoadBalancerFeignClient.java:<span class="number">56</span>) ~[spring-cloud-alibaba-seata-<span class="number">2.1</span><span class="number">.0</span>.RELEASE.jar:<span class="number">2.1</span><span class="number">.0</span>.RELEASE]</span><br><span class="line">at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:<span class="number">108</span>) ~[feign-core-<span class="number">10.2</span><span class="number">.3</span>.jar:na]</span><br><span class="line">at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:<span class="number">78</span>) ~[feign-core-<span class="number">10.2</span><span class="number">.3</span>.jar:na]</span><br><span class="line">at feign.ReflectiveFeign$FeignInvocationHandler.invoke(ReflectiveFeign.java:<span class="number">103</span>) ~[feign-core-<span class="number">10.2</span><span class="number">.3</span>.jar:na]</span><br><span class="line">at com.sun.proxy.$Proxy111.decrease(Unknown Source) ~[na:na]</span><br><span class="line">at io.seata.sample.service.OrderServiceImpl.create(OrderServiceImpl.java:<span class="number">50</span>) ~[classes/:na]</span><br><span class="line">at io.seata.sample.service.OrderServiceImpl$$FastClassBySpringCGLIB$$<span class="number">3</span>d2d368a.invoke(&lt;generated&gt;) ~[classes/:na]</span><br><span class="line">at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>) ~[spring-core-<span class="number">5.1</span><span class="number">.9</span>.RELEASE.jar:<span class="number">5.1</span><span class="number">.9</span>.RELEASE]</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:<span class="number">749</span>) ~[spring-aop-<span class="number">5.1</span><span class="number">.9</span>.RELEASE.jar:<span class="number">5.1</span><span class="number">.9</span>.RELEASE]</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>) ~[spring-aop-<span class="number">5.1</span><span class="number">.9</span>.RELEASE.jar:<span class="number">5.1</span><span class="number">.9</span>.RELEASE]</span><br><span class="line">at io.seata.spring.annotation.GlobalTransactionalInterceptor$<span class="number">1</span>.execute(GlobalTransactionalInterceptor.java:<span class="number">109</span>) ~[seata-all-<span class="number">1.2</span><span class="number">.0</span>.jar:<span class="number">1.2</span><span class="number">.0</span>]</span><br><span class="line">at io.seata.tm.api.TransactionalTemplate.execute(TransactionalTemplate.java:<span class="number">104</span>) ~[seata-all-<span class="number">1.2</span><span class="number">.0</span>.jar:<span class="number">1.2</span><span class="number">.0</span>]</span><br><span class="line">at io.seata.spring.annotation.GlobalTransactionalInterceptor.handleGlobalTransaction(GlobalTransactionalInterceptor.java:<span class="number">106</span>) ~[seata-all-<span class="number">1.2</span><span class="number">.0</span>.jar:<span class="number">1.2</span><span class="number">.0</span>]</span><br><span class="line">at io.seata.spring.annotation.GlobalTransactionalInterceptor.invoke(GlobalTransactionalInterceptor.java:<span class="number">83</span>) ~[seata-all-<span class="number">1.2</span><span class="number">.0</span>.jar:<span class="number">1.2</span><span class="number">.0</span>]</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>) ~[spring-aop-<span class="number">5.1</span><span class="number">.9</span>.RELEASE.jar:<span class="number">5.1</span><span class="number">.9</span>.RELEASE]</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">688</span>) ~[spring-aop-<span class="number">5.1</span><span class="number">.9</span>.RELEASE.jar:<span class="number">5.1</span><span class="number">.9</span>.RELEASE]</span><br><span class="line">at io.seata.sample.service.OrderServiceImpl$$EnhancerBySpringCGLIB$$<span class="number">9</span>c1f4d2e.create(&lt;generated&gt;) ~[classes/:na]</span><br><span class="line">at io.seata.sample.controller.OrderController.create(OrderController.java:<span class="number">29</span>) ~[classes/:na]</span><br><span class="line">........省略异常</span><br></pre></td></tr></table></figure><h3 id="StorageServerApplication日志展示事务分支Branch-Rollbacked"><a href="#StorageServerApplication日志展示事务分支Branch-Rollbacked" class="headerlink" title="StorageServerApplication日志展示事务分支Branch Rollbacked"></a>StorageServerApplication日志展示事务分支Branch Rollbacked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i.s.sample.service.StorageServiceImpl    : -------&gt;扣减库存开始</span><br><span class="line">i.s.sample.service.StorageServiceImpl    : -------&gt;扣减库存结束</span><br><span class="line">c.a.c.seata.web.SeataHandlerInterceptor  : xid in change during RPC from <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> to <span class="keyword">null</span></span><br><span class="line">i.s.core.rpc.netty.RmMessageListener     : onMessage:xid=<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>,branchId=<span class="number">2044579204</span>,branchType=AT,resourceId=jdbc:mysql:<span class="comment">//127.0.0.1/seat-storage,applicationData=null</span></span><br><span class="line">io.seata.rm.AbstractRMHandler            : Branch Rollbacking: <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> <span class="number">2044579204</span> jdbc:mysql:<span class="comment">//127.0.0.1/seat-storage</span></span><br><span class="line">i.s.r.d.undo.AbstractUndoLogManager      : xid <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> branch <span class="number">2044579204</span>, undo_log deleted with GlobalFinished           : Branch Rollbacked result: PhaseTwo_Rollbacked</span><br></pre></td></tr></table></figure><h3 id="AccountServerApplication日志出现sql-exception"><a href="#AccountServerApplication日志出现sql-exception" class="headerlink" title="AccountServerApplication日志出现sql exception"></a>AccountServerApplication日志出现sql exception</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">i.s.sample.service.AccountServiceImpl    : -------&gt;扣减账户开始account中</span><br><span class="line">i.s.r.d.exec.AbstractDMLBaseExecutor     : execute executeAutoCommitTrue error:io.seata.core.exception.RmTransactionException: Response[ TransactionException[<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>] ]</span><br><span class="line">java.sql.SQLException: io.seata.core.exception.RmTransactionException: Response[ TransactionException[<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>] ]</span><br><span class="line">...省略一些重要异常堆栈信息</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">23</span>:<span class="number">31</span>:<span class="number">56.652</span>  WARN <span class="number">5960</span> --- [nio-<span class="number">8181</span>-exec-<span class="number">2</span>] c.a.c.seata.web.SeataHandlerInterceptor  : xid in change during RPC from <span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span> to <span class="keyword">null</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">23</span>:<span class="number">31</span>:<span class="number">56.654</span> ERROR <span class="number">5960</span> --- [nio-<span class="number">8181</span>-exec-<span class="number">2</span>] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() <span class="keyword">for</span> servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.jdbc.UncategorizedSQLException: </span><br><span class="line">### Error updating database.  Cause: java.sql.SQLException: io.seata.core.exception.RmTransactionException: Response[ TransactionException[192.168.3.2:8091:2044579200] ]</span><br><span class="line">### The error may exist in file [E:\document\GitHub\seata-samples-master\springcloud-eureka-feign-mybatis-seata\account-server\target\classes\mapper\AccountMapper.xml]</span><br><span class="line">### The error may involve defaultParameterMap</span><br><span class="line">### The error occurred while setting parameters</span><br><span class="line">### SQL: UPDATE account SET residue = residue - ?,used = used + ? where user_id = ?;</span><br><span class="line">### Cause: java.sql.SQLException: io.seata.core.exception.RmTransactionException: Response[ TransactionException[192.168.3.2:8091:2044579200] ]</span><br><span class="line">; uncategorized SQLException; SQL state [<span class="keyword">null</span>]; error code [<span class="number">0</span>]; io.seata.core.exception.RmTransactionException: Response[ TransactionException[<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>] ]; nested exception is java.sql.SQLException: io.seata.core.exception.RmTransactionException: Response[ TransactionException[<span class="number">192.168</span><span class="number">.3</span><span class="number">.2</span>:<span class="number">8091</span>:<span class="number">2044579200</span>] ]] with root cause</span><br></pre></td></tr></table></figure><h2 id="四、分布式事务公共模块"><a href="#四、分布式事务公共模块" class="headerlink" title="四、分布式事务公共模块"></a>四、分布式事务公共模块</h2><h3 id="1、创建工程common-fescar，引入依赖"><a href="#1、创建工程common-fescar，引入依赖" class="headerlink" title="1、创建工程common_fescar，引入依赖"></a>1、创建工程common_fescar，引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fescar.version</span>&gt;</span>0.4.2<span class="tag">&lt;/<span class="name">fescar.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fescar<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fescar-tm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fescar.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fescar<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fescar-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fescar.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、将fescar配置文件拷贝到resources工程下"><a href="#2、将fescar配置文件拷贝到resources工程下" class="headerlink" title="2、将fescar配置文件拷贝到resources工程下"></a>2、将<code>fescar配置文件</code>拷贝到resources工程下</h3><p><img src="/images/pasted-20.png" alt="upload successful"></p><h3 id="3、资源提供者每个线程绑定一个XID"><a href="#3、资源提供者每个线程绑定一个XID" class="headerlink" title="3、资源提供者每个线程绑定一个XID"></a>3、资源提供者每个线程绑定一个XID</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarRMRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = org.slf4j.LoggerFactory.getLogger( FescarRMRequestFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给每次线程请求绑定一个XID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filterChain</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String currentXID = request.getHeader( FescarAutoConfiguration.FESCAR_XID);</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(currentXID))&#123;</span><br><span class="line">            RootContext.bind(currentXID);</span><br><span class="line">            LOGGER.info(<span class="string">"当前线程绑定的XID :"</span> + currentXID);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            String unbindXID = RootContext.unbind();</span><br><span class="line">            <span class="keyword">if</span>(unbindXID != <span class="keyword">null</span>)&#123;</span><br><span class="line">                LOGGER.info(<span class="string">"当前线程从指定XID中解绑 XID :"</span> + unbindXID);</span><br><span class="line">                <span class="keyword">if</span>(!currentXID.equals(unbindXID))&#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"当前线程的XID发生变更"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(currentXID != <span class="keyword">null</span>)&#123;</span><br><span class="line">                LOGGER.info(<span class="string">"当前线程的XID发生变更"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、RestInterceptor过滤器，每次请求都将XID转发到其他微服务"><a href="#4、RestInterceptor过滤器，每次请求都将XID转发到其他微服务" class="headerlink" title="4、RestInterceptor过滤器，每次请求都将XID转发到其他微服务"></a>4、RestInterceptor过滤器，每次请求都将XID转发到其他微服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarRestInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span>, <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line">        String xid = RootContext.getXID();</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(xid))&#123;</span><br><span class="line">            requestTemplate.header( FescarAutoConfiguration.FESCAR_XID, xid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest request, <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String xid = RootContext.getXID();</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(xid))&#123;</span><br><span class="line">            HttpHeaders headers = request.getHeaders();</span><br><span class="line">            headers.put( FescarAutoConfiguration.FESCAR_XID, Collections.singletonList(xid));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> execution.execute(request, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、创建FescarAutoConfiguration类"><a href="#5、创建FescarAutoConfiguration类" class="headerlink" title="5、创建FescarAutoConfiguration类"></a>5、创建FescarAutoConfiguration类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  * 创建数据源</span></span><br><span class="line"><span class="comment"> *  * 定义全局事务管理器扫描对象</span></span><br><span class="line"><span class="comment"> *  * 给所有RestTemplate添加头信息防止微服务之间调用问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FESCAR_XID = <span class="string">"fescarXID"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 创建代理数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> environment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(Environment environment)</span></span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setUrl(environment.getProperty(<span class="string">"spring.datasource.url"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataSource.setDriver(DriverManager.getDriver(environment.getProperty(<span class="string">"spring.datasource.url"</span>)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can't recognize dataSource Driver"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dataSource.setUsername(environment.getProperty(<span class="string">"spring.datasource.username"</span>));</span><br><span class="line">        dataSource.setPassword(environment.getProperty(<span class="string">"spring.datasource.password"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxy(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 全局事务扫描器</span></span><br><span class="line"><span class="comment">     * 用来解析带有<span class="doctag">@GlobalTransactional</span>注解的方法，然后采用AOP的机制控制事务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> environment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GlobalTransactionScanner <span class="title">globalTransactionScanner</span><span class="params">(Environment environment)</span></span>&#123;</span><br><span class="line">        String applicationName = environment.getProperty(<span class="string">"spring.application.name"</span>);</span><br><span class="line">        String groupName = environment.getProperty(<span class="string">"fescar.group.name"</span>);</span><br><span class="line">        <span class="keyword">if</span>(applicationName == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GlobalTransactionScanner(groupName == <span class="keyword">null</span> ? <span class="string">"my_test_tx_group"</span> : groupName);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GlobalTransactionScanner(applicationName, groupName == <span class="keyword">null</span> ? <span class="string">"my_test_tx_group"</span> : groupName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 每次微服务和微服务之间相互调用</span></span><br><span class="line"><span class="comment">     * 要想控制全局事务，每次TM都会请求TC生成一个XID，每次执行下一个事务，也就是调用其他微服务的时候都需要将该XID传递过去</span></span><br><span class="line"><span class="comment">     * 所以我们可以每次请求的时候，都获取头中的XID，并将XID传递到下一个微服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplates</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean</span>(&#123;RestTemplate<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">Bean</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Object</span> <span class="title">addFescarInterceptor</span>(<span class="title">Collection</span>&lt;<span class="title">RestTemplate</span>&gt; <span class="title">restTemplates</span>)</span>&#123;</span><br><span class="line">        restTemplates.stream()</span><br><span class="line">                .forEach(restTemplate -&gt; &#123;</span><br><span class="line">                    List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();</span><br><span class="line">                    <span class="keyword">if</span>(interceptors != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        interceptors.add(fescarRestInterceptor());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Object();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FescarRMRequestFilter <span class="title">fescarRMRequestFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FescarRMRequestFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FescarRestInterceptor <span class="title">fescarRestInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FescarRestInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、记得将涉及到分布式事务的每个数据库都新建一个Undolog表"><a href="#6、记得将涉及到分布式事务的每个数据库都新建一个Undolog表" class="headerlink" title="6、记得将涉及到分布式事务的每个数据库都新建一个Undolog表"></a>6、记得将涉及到分布式事务的每个数据库都新建一个Undolog表</h3><h2 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><ol><li><a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener">官方实验Demo集合</a></li><li><a href="https://github.com/seata/seata-samples/tree/master/springcloud-eureka-feign-mybatis-seata" target="_blank" rel="noopener">本次博客实验所用Demo</a></li><li><a href="https://blog.csdn.net/zt_16kk/article/details/89105663" target="_blank" rel="noopener">分布式事务框架Fescar在SpringCloud环境下的应用实践</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一、Seata简介&quot;&gt;&lt;a href=&quot;#一、Seata简介&quot; class=&quot;headerlink&quot; title=&quot;一、Seata简介&quot;&gt;&lt;/a&gt;一、Seata简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;2019 年 1 月，阿里巴巴中间件团队发起了开源项目 F
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/categories/SpringCloud/"/>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>TX-LCN分布式事务实践</title>
    <link href="https://caochikai.github.io/2020/05/30/TX-LCN%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E8%B7%B5/"/>
    <id>https://caochikai.github.io/2020/05/30/TX-LCN%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E8%B7%B5/</id>
    <published>2020-05-30T10:11:00.000Z</published>
    <updated>2020-05-31T03:28:18.881Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TX-LCN分布式事务实践"><a href="#TX-LCN分布式事务实践" class="headerlink" title="TX-LCN分布式事务实践"></a>TX-LCN分布式事务实践</h1><h2 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h2><blockquote><p>扣减库存服务和生成订单服务对应不同数据库，Spring本地事务@Transactional并不能解决跨库跨服务保证数据一致性。分布式事务一般包含事务的发起者和参与者、关系型数据库资源服务以及事务管理器；Distributed Transaction Framework流行的主要有TX-LCN和阿里的seata框架，下一篇会调研下seata框架。</p></blockquote><blockquote><p>TX-LCN分布式事务框架是一款开源分布式事务框架，由两大模块组成TxClient和TxManager，TxClient扮演发起者和参与者，TxManager扮演事务管理器协调事务；从开发角度讲，TxClient指的是是我们自己的服务系统，TxManager是事务中心的协调系统；从Github RELEASE版本发布看，最新是5.0.2.RELEASE（支持LCN TXC TCC 三种事务模式），项目为了稳定使用v4.1.0（默认只支持LCN模式）；LCN模式基本原理是代理切面拦截所有数据库链接的提交和回滚，由代理连接对象控制本地事务的真正的提交、回滚和释放。若是存在与非关系型数据库redis，就需要TCC模式补偿操作，来保证非关系redis和关系mysql整体一致性。</p></blockquote><h2 id="二、开始准备"><a href="#二、开始准备" class="headerlink" title="二、开始准备"></a>二、开始准备</h2><h3 id="1、准备mysql和redis环境，通过spring-initializr快速准备eureka注册中心。"><a href="#1、准备mysql和redis环境，通过spring-initializr快速准备eureka注册中心。" class="headerlink" title="1、准备mysql和redis环境，通过spring initializr快速准备eureka注册中心。"></a>1、准备mysql和redis环境，通过<a href="https://start.spring.io/" target="_blank" rel="noopener">spring initializr</a>快速准备eureka注册中心。</h3><h3 id="2、下载v4-1-0版本，tx-lcn-4-1-0是spring-boot项目需要eureka注册中心服务和redis，运行启动类com-codingapi-tm-TxManagerApplication。"><a href="#2、下载v4-1-0版本，tx-lcn-4-1-0是spring-boot项目需要eureka注册中心服务和redis，运行启动类com-codingapi-tm-TxManagerApplication。" class="headerlink" title="2、下载v4.1.0版本，tx-lcn-4.1.0是spring boot项目需要eureka注册中心服务和redis，运行启动类com.codingapi.tm.TxManagerApplication。"></a>2、下载<a href="https://github.com/codingapi/tx-lcn/releases/tag/v4.1.0" target="_blank" rel="noopener">v4.1.0</a>版本，tx-lcn-4.1.0是spring boot项目需要eureka注册中心服务和redis，运行启动类com.codingapi.tm.TxManagerApplication。</h3><h3 id="3、访问http-127-0-0-1-8899-TxManager管理界面，注意两个属性负载均衡服务器地址的端口和当前连接数，这是实验成功的截图，一开始当前连接数应该是0。"><a href="#3、访问http-127-0-0-1-8899-TxManager管理界面，注意两个属性负载均衡服务器地址的端口和当前连接数，这是实验成功的截图，一开始当前连接数应该是0。" class="headerlink" title="3、访问http://127.0.0.1:8899/TxManager管理界面，注意两个属性负载均衡服务器地址的端口和当前连接数，这是实验成功的截图，一开始当前连接数应该是0。"></a>3、访问<a href="http://127.0.0.1:8899/" target="_blank" rel="noopener">http://127.0.0.1:8899/</a>TxManager管理界面，注意两个属性负载均衡服务器地址的端口和当前连接数，这是实验成功的截图，一开始当前连接数应该是0。</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-16.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="4、springcloud-LCN分布式事务v4-0-示例demo"><a href="#4、springcloud-LCN分布式事务v4-0-示例demo" class="headerlink" title="4、springcloud LCN分布式事务v4.0 示例demo"></a>4、<a href="https://github.com/codingapi/springcloud-lcn-demo/wiki" target="_blank" rel="noopener">springcloud LCN分布式事务v4.0 示例demo</a></h3><blockquote><p>根据教程引导创建相应的数据库和修改配置，重点标注重要配置。我们重点关系jdbc版本的springcloud-jdbc-demo，它涉及到了5个业务模块，工程从1到5对应端口port：8081到8085，控制器的接口前缀是localhost:port/demo，分list列表接口和save接口；在save方法中，在demo3（调用4和5，自己）和demo1（调用2和3，自己）是事务发起方，两者差别是demo3注释了异常能正常返回insert 3条数据，而demo1打开异常触发分布式事务回滚insert数据；demo2、demo4和demo5仅仅是事务参与方。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">feign.hystrix.enabled=<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">spring.datasource.driver-<span class="class"><span class="keyword">class</span>-<span class="title">name</span> </span>= com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url= jdbc:mysql:<span class="comment">//localhost:3306/test</span></span><br><span class="line">spring.datasource.username= root</span><br><span class="line">spring.datasource.password=root</span><br><span class="line">spring.datasource.initialize =  <span class="keyword">true</span></span><br><span class="line">init-db= <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">spring.application.name = demo3</span><br><span class="line">server.port = <span class="number">8083</span></span><br><span class="line">#$&#123;random.int[9000,9999]&#125;，注册中心端口要对应</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//127.0.0.1:8761/eureka/</span></span><br><span class="line"></span><br><span class="line">feign.hystrix.enabled=<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"># 关于**springcloud-hystrix机制，选择信号量隔离** http://www.jianshu.com/p/b8d21248c9b1</span><br><span class="line">hystrix.command.<span class="keyword">default</span>.execution.isolation.strategy= SEMAPHORE</span><br><span class="line">hystrix.command.<span class="keyword">default</span>.execution.isolation.thread.timeoutInMilliseconds=<span class="number">5000</span></span><br><span class="line"></span><br><span class="line">#Ribbon的负载均衡策略，重试次数为0</span><br><span class="line">ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule</span><br><span class="line">ribbon.MaxAutoRetriesNextServer=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">#**txmanager地址端口指的是TxManager管理界面的负载均衡服务器地址的端口**</span><br><span class="line">tm.manager.url=http:<span class="comment">//127.0.0.1:8899/tx/manager/</span></span><br><span class="line"></span><br><span class="line">logging.level.com.codingapi=debug</span><br></pre></td></tr></table></figure><blockquote><p>以demo1的DemoServiceImpl异常触发分布式为例，重点是@TxTransaction(<strong>isStart = true</strong>)标注事务发起方，否则ThreadLocal不会有groupid，那就不会有事务组，更不可能实现回滚事务。</p></blockquote><h3 id="未标记发起方出现异常则groupId为空情况："><a href="#未标记发起方出现异常则groupId为空情况：" class="headerlink" title="未标记发起方出现异常则groupId为空情况："></a>未标记发起方出现异常则groupId为空情况：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">06.387</span> DEBUG <span class="number">4964</span> --- [nio-<span class="number">8084</span>-exec-<span class="number">8</span>] c.c.t.s.interceptor.TransactionAspect    : annotation-TransactionRunning-start----&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">06.387</span> DEBUG <span class="number">4964</span> --- [nio-<span class="number">8084</span>-exec-<span class="number">8</span>] c.c.t.a.s.impl.AspectBeforeServiceImpl   : around--&gt; groupId-&gt; <span class="keyword">null</span>,txTransactionLocal-&gt;<span class="keyword">null</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">06.387</span> DEBUG <span class="number">4964</span> --- [nio-<span class="number">8084</span>-exec-<span class="number">8</span>] c.c.t.d.aspect.DataSourceAspect          : getConnection-start----&gt;</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">06.387</span> DEBUG <span class="number">4964</span> --- [nio-<span class="number">8084</span>-exec-<span class="number">8</span>] c.c.tx.datasource.AbstractResourceProxy  : loadConnection -&gt; <span class="keyword">null</span> !</span><br></pre></td></tr></table></figure><h3 id="DemoServiceImpl"><a href="#DemoServiceImpl" class="headerlink" title="DemoServiceImpl"></a>DemoServiceImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.client.Demo2Client;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.client.Demo3Client;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dao.TestDao;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.entity.Test;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.DemoService;</span><br><span class="line"><span class="keyword">import</span> com.codingapi.tx.annotation.TxTransaction;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by lorne on 2017/6/26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestDao testDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Demo2Client demo2Client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Demo3Client demo3Client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Test&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> testDao.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    **<span class="meta">@TxTransaction</span>(isStart = <span class="keyword">true</span>)**</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rs2 = demo2Client.save();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rs3 = demo3Client.save();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rs1 = testDao.save();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> v = <span class="number">100</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rs1+rs2+rs3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问demo1的save接口"><a href="#访问demo1的save接口" class="headerlink" title="访问demo1的save接口"></a>访问demo1的save接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//访问save接口：http://localhost:8081/demo/save，触发异常</span></span><br><span class="line">Whitelabel Error Page</span><br><span class="line">This application has no explicit mapping <span class="keyword">for</span> /error, so you are seeing <span class="keyword">this</span> as a fallback.</span><br><span class="line"></span><br><span class="line">Sat May <span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11</span> CST <span class="number">2020</span></span><br><span class="line"><span class="function">There was an unexpected <span class="title">error</span> <span class="params">(type=Internal Server Error, status=<span class="number">500</span>)</span>.</span></span><br><span class="line"><span class="function">Demo3Client#<span class="title">save</span><span class="params">()</span> failed and fallback failed.</span></span><br></pre></td></tr></table></figure><h3 id="触发回滚JdbcDemo2Application控制台正确日志："><a href="#触发回滚JdbcDemo2Application控制台正确日志：" class="headerlink" title="触发回滚JdbcDemo2Application控制台正确日志："></a>触发回滚JdbcDemo2Application控制台正确日志：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#触发回滚</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.654</span> DEBUG <span class="number">4468</span> --- [ntLoopGroup-<span class="number">2</span>-<span class="number">1</span>] c.c.tx.netty.handler.TransactionHandler  : TxManager-response-&gt;&#123;<span class="string">"a"</span>:<span class="string">"t"</span>,<span class="string">"c"</span>:<span class="number">0</span>,<span class="string">"t"</span>:<span class="string">"9Fxhh19M"</span>,<span class="string">"k"</span>:<span class="string">"62kQVGPh"</span>&#125;</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.654</span>  INFO <span class="number">4468</span> --- [ool-<span class="number">1</span>-thread-<span class="number">19</span>] c.c.t.c.service.impl.ActionTServiceImpl  : accept notify data -&gt;&#123;<span class="string">"a"</span>:<span class="string">"t"</span>,<span class="string">"c"</span>:<span class="number">0</span>,<span class="string">"t"</span>:<span class="string">"9Fxhh19M"</span>,<span class="string">"k"</span>:<span class="string">"62kQVGPh"</span>&#125;</span><br><span class="line">lcn transaction over, res -&gt; groupId:<span class="number">3</span>OBwlhvN and  state is rollback</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.657</span> DEBUG <span class="number">4468</span> --- [      Thread-<span class="number">28</span>] c.c.t.d.relational.LCNDBConnection       : lcnConnection closed groupId:<span class="number">3</span>OBwlhvN</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.658</span>  INFO <span class="number">4468</span> --- [ool-<span class="number">1</span>-thread-<span class="number">19</span>] c.c.t.c.service.impl.ActionTServiceImpl  : accept notify response res -&gt;<span class="number">1</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.658</span> DEBUG <span class="number">4468</span> --- [ool-<span class="number">1</span>-thread-<span class="number">19</span>] .c.t.c.s.i.TransactionControlServiceImpl : send notify data -&gt;&#123;<span class="string">"p"</span>:&#123;<span class="string">"d"</span>:<span class="string">"1"</span>&#125;,<span class="string">"a"</span>:<span class="string">"t"</span>,<span class="string">"k"</span>:<span class="string">"62kQVGPh"</span>&#125;</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">11.659</span> DEBUG <span class="number">4468</span> --- [ntLoopGroup-<span class="number">2</span>-<span class="number">1</span>] c.c.tx.netty.handler.TransactionHandler  : TxManager-response-&gt;&#123;<span class="string">"d"</span>:<span class="string">""</span>,<span class="string">"k"</span>:<span class="string">"62kQVGPh"</span>&#125;</span><br><span class="line"></span><br><span class="line">#clent和manager的心跳数据</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">26.659</span> DEBUG <span class="number">4468</span> --- [ntLoopGroup-<span class="number">2</span>-<span class="number">1</span>] c.c.tx.netty.handler.TransactionHandler  : hart data ---&gt;&#123;<span class="string">"p"</span>:<span class="string">"&#123;&#125;"</span>,<span class="string">"a"</span>:<span class="string">"h"</span>,<span class="string">"k"</span>:<span class="string">"h"</span>&#125;</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">26.659</span> DEBUG <span class="number">4468</span> --- [ntLoopGroup-<span class="number">2</span>-<span class="number">1</span>] c.c.tx.netty.handler.TransactionHandler  : TxManager-response-&gt;&#123;<span class="string">"d"</span>:<span class="string">"5"</span>,<span class="string">"k"</span>:<span class="string">"h"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="三、4-0与5-0版本差别"><a href="#三、4-0与5-0版本差别" class="headerlink" title="三、4.0与5.0版本差别"></a>三、4.0与5.0版本差别</h2><blockquote><p>5.0版本从1月份开始大量提交，并已经交由codingApi团队开发维护，两个版本的注解源码是不同的。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** **4.0版本**</span></span><br><span class="line"><span class="comment"> * Created by lorne on 2017/6/26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TxTransaction &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否LCN事务发起方</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 是:是发起方 false 否:是参与方</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isStart</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回滚异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不回滚异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****5.0版本**</span></span><br><span class="line"><span class="comment"> * Created by lorne on 2017/6/26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TxTransaction &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事务模式 transaction type</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> lcn, tcc, txc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> Transactions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">type</span><span class="params">()</span> <span class="keyword">default</span> Transactions.LCN</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分布式事务传播行为</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 传播行为</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> DTXPropagation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">DTXPropagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> DTXPropagation.REQUIRED</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、参考资料"><a href="#四、参考资料" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><ol><li><a href="https://www.codingapi.com/docs/txlcn-lesson01/" target="_blank" rel="noopener">分布式事务从0到1-认识分布式事务</a></li><li><a href="https://github.com/codingapi" target="_blank" rel="noopener">codingapi</a>/<strong><a href="https://github.com/codingapi/tx-lcn" target="_blank" rel="noopener">tx-lcn</a></strong></li><li><a href="https://github.com/codingapi/springcloud-lcn-demo/wiki" target="_blank" rel="noopener">springcloud LCN分布式事务v4.0 示例demo</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;TX-LCN分布式事务实践&quot;&gt;&lt;a href=&quot;#TX-LCN分布式事务实践&quot; class=&quot;headerlink&quot; title=&quot;TX-LCN分布式事务实践&quot;&gt;&lt;/a&gt;TX-LCN分布式事务实践&lt;/h1&gt;&lt;h2 id=&quot;一、需求&quot;&gt;&lt;a href=&quot;#一、需求&quot;
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/categories/SpringCloud/"/>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot canal数据同步解决方案</title>
    <link href="https://caochikai.github.io/2020/05/28/SpringBoot-canal%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://caochikai.github.io/2020/05/28/SpringBoot-canal%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2020-05-28T14:31:00.000Z</published>
    <updated>2020-05-28T08:32:32.288Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBoot-canal数据同步解决方案"><a href="#SpringBoot-canal数据同步解决方案" class="headerlink" title="SpringBoot canal数据同步解决方案"></a>SpringBoot canal数据同步解决方案</h1><h1 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h1><blockquote><p>微服务多数据库情况下可以使用canal替代触发器，canal是应阿里巴巴跨机房同步的业务需求而提出的，canal基于数据库的日志解析，获取变更进行增量订阅&amp;消费的业务。无论是canal实验需要还是为了增量备份、主从复制和恢复，都是需要开启mysql-binlog日志，数据目录设置到不同的磁盘分区可以降低io等待。</p></blockquote><h3 id="canal-工作原理"><a href="#canal-工作原理" class="headerlink" title="canal 工作原理"></a>canal 工作原理</h3><ol><li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump 协议</li><li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</li><li>canal 解析 binary log 对象(原始为 byte 流)</li></ol><h2 id="二、部署环境"><a href="#二、部署环境" class="headerlink" title="二、部署环境"></a>二、<a href="https://www.jb51.net/article/157187.htm" target="_blank" rel="noopener">部署环境</a></h2><h3 id="1、登录mysql查看是否开启binlog，标红的log-bin默认是OFF关"><a href="#1、登录mysql查看是否开启binlog，标红的log-bin默认是OFF关" class="headerlink" title="1、登录mysql查看是否开启binlog，标红的log_bin默认是OFF关"></a>1、登录mysql查看是否开启binlog，标红的log_bin默认是OFF关</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'log_%';</span><br><span class="line">+<span class="comment">----------------------------------------+-------------------------------------------------------+</span></span><br><span class="line">| Variable_name                          | Value                                                 |</span><br><span class="line">+<span class="comment">----------------------------------------+-------------------------------------------------------+</span></span><br><span class="line">| **log_bin                                | OFF**                                                   |</span><br><span class="line">| log_bin_basename                       |                                                       |</span><br><span class="line">| log_bin_index                          |                                                       |</span><br><span class="line">| log_bin_trust_function_creators        | OFF                                                   |</span><br><span class="line">| log_bin_use_v1_row_events              | OFF                                                   |</span><br><span class="line">| log_builtin_as_identified_by_password  | OFF                                                   |</span><br><span class="line">| log_error                              | F:\tools\mysql-5.7.28-winx64\Data\DESKTOP-C1LU9IQ.err |</span><br><span class="line">| log_error_verbosity                    | 3                                                     |</span><br><span class="line">| log_output                             | FILE                                                  |</span><br><span class="line">| log_queries_not_using_indexes          | OFF                                                   |</span><br><span class="line">| log_slave_updates                      | OFF                                                   |</span><br><span class="line">| log_slow_admin_statements              | OFF                                                   |</span><br><span class="line">| log_slow_slave_statements              | OFF                                                   |</span><br><span class="line">| log_statements_unsafe_for_binlog       | ON                                                    |</span><br><span class="line">| log_syslog                             | ON                                                    |</span><br><span class="line">| log_syslog_tag                         |                                                       |</span><br><span class="line">| log_throttle_queries_not_using_indexes | 0                                                     |</span><br><span class="line">| log_timestamps                         | UTC                                                   |</span><br><span class="line">| log_warnings                           | 2                                                     |</span><br><span class="line">+<span class="comment">----------------------------------------+-------------------------------------------------------+</span></span><br><span class="line">19 rows in <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2、编辑配置文件"><a href="#2、编辑配置文件" class="headerlink" title="2、编辑配置文件"></a>2、编辑配置文件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># 设置3306端口</span></span><br><span class="line">port=3306</span><br><span class="line"><span class="comment"># 设置mysql的安装目录，按照个人的实际需要改</span></span><br><span class="line">basedir=F:\\tools\\mysql-5.7.28-winx64   <span class="comment"># 切记此处一定要用双斜杠\\，单斜杠我这里会出错，不过看别人的教程，有的是单斜杠。自己尝试吧</span></span><br><span class="line"><span class="comment"># 设置mysql数据库的数据的存放目录</span></span><br><span class="line">datadir=F:\\tools\\mysql-5.7.28-winx64\\Data   <span class="comment"># 此处同上</span></span><br><span class="line"><span class="comment"># 允许最大连接数</span></span><br><span class="line">max_connections=200</span><br><span class="line"><span class="comment"># 允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统</span></span><br><span class="line">max_connect_errors=10</span><br><span class="line"><span class="comment"># 服务端使用的字符集默认为UTF8</span></span><br><span class="line">character-<span class="keyword">set</span>-<span class="keyword">server</span>=utf8</span><br><span class="line"><span class="comment"># 创建新表时将使用的默认存储引擎</span></span><br><span class="line"><span class="keyword">default</span>-<span class="keyword">storage</span>-<span class="keyword">engine</span>=<span class="keyword">INNODB</span></span><br><span class="line"><span class="comment"># 默认使用“mysql_native_password”插件认证</span></span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">lower_case_table_names=<span class="number">2</span></span><br><span class="line">sql_mode = STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line">max_connections=<span class="number">1000</span></span><br><span class="line"><span class="comment">#实验重点配置</span></span><br><span class="line"> <span class="comment"># 开启 binlog</span></span><br><span class="line"><span class="keyword">log</span>-<span class="keyword">bin</span>=mysql-<span class="keyword">bin</span></span><br><span class="line"><span class="comment"># 选择 ROW 模式</span></span><br><span class="line"><span class="keyword">binlog</span>-<span class="keyword">format</span>=<span class="keyword">ROW</span> </span><br><span class="line"><span class="comment"># 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span></span><br><span class="line">server_id=<span class="number">1</span> </span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"><span class="comment"># 设置mysql客户端默认字符集</span></span><br><span class="line"><span class="keyword">default</span>-<span class="built_in">character</span>-<span class="keyword">set</span>=utf8</span><br><span class="line">[<span class="keyword">client</span>]</span><br><span class="line"><span class="comment"># 设置mysql客户端连接服务端时默认使用的端口</span></span><br><span class="line">port=<span class="number">3306</span></span><br><span class="line"><span class="keyword">default</span>-<span class="built_in">character</span>-<span class="keyword">set</span>=utf8</span><br></pre></td></tr></table></figure><h3 id="3、创建MySQL-slave-的权限canal账户并且进行远程连接授权"><a href="#3、创建MySQL-slave-的权限canal账户并且进行远程连接授权" class="headerlink" title="3、创建MySQL slave 的权限canal账户并且进行远程连接授权"></a>3、创建MySQL slave 的权限canal账户并且进行远程连接授权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER canal IDENTIFIED BY <span class="string">'canal'</span>;  </span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="string">'canal'</span>@<span class="string">'%'</span>;</span><br><span class="line">-- GRANT ALL PRIVILEGES ON *.* TO <span class="string">'canal'</span>@<span class="string">'%'</span> ;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h3 id="4、记得重启mysql服务"><a href="#4、记得重启mysql服务" class="headerlink" title="4、记得重启mysql服务"></a>4、记得重启mysql服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Linux：</span><br><span class="line">systemctl restart mysqld</span><br><span class="line">Window:</span><br><span class="line">net stop mysql;</span><br><span class="line">net start mysql;</span><br></pre></td></tr></table></figure><h2 id="三、canal快速部署配置"><a href="#三、canal快速部署配置" class="headerlink" title="三、canal快速部署配置"></a>三、<a href="https://github.com/alibaba/canal/wiki/QuickStart" target="_blank" rel="noopener">canal快速部署配置</a></h2><h3 id="1、修改配置conf-example-instance-properties"><a href="#1、修改配置conf-example-instance-properties" class="headerlink" title="1、修改配置conf/example/instance.properties"></a>1、修改配置conf/example/instance.properties</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## mysql serverId</span></span><br><span class="line">canal.instance.mysql.slaveId = 1234</span><br><span class="line"><span class="comment">#position info，需要改成自己的数据库信息</span></span><br><span class="line">canal.instance.master.address = 127.0.0.1:3306 </span><br><span class="line">canal.instance.master.journal.name = </span><br><span class="line">canal.instance.master.position = </span><br><span class="line">canal.instance.master.timestamp = </span><br><span class="line"><span class="comment">#canal.instance.standby.address = </span></span><br><span class="line"><span class="comment">#canal.instance.standby.journal.name =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.position = </span></span><br><span class="line"><span class="comment">#canal.instance.standby.timestamp = </span></span><br><span class="line"><span class="comment">#username/password，需要改成自己的数据库信息</span></span><br><span class="line">canal.instance.dbUsername = canal  </span><br><span class="line">canal.instance.dbPassword = canal</span><br><span class="line">canal.instance.defaultDatabaseName =</span><br><span class="line">canal.instance.connectionCharset = UTF-8</span><br><span class="line"><span class="comment">#table regex</span></span><br><span class="line">canal.instance.filter.regex = .\*\\\\..\*</span><br></pre></td></tr></table></figure><h3 id="2、通过启动脚本运行：sh-bin-startup-sh"><a href="#2、通过启动脚本运行：sh-bin-startup-sh" class="headerlink" title="2、通过启动脚本运行：sh bin/startup.sh"></a>2、通过启动脚本运行：sh bin/startup.sh</h3><h3 id="3、查看-server-日志和instance-的日志"><a href="#3、查看-server-日志和instance-的日志" class="headerlink" title="3、查看 server 日志和instance 的日志"></a>3、查看 server 日志和instance 的日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ tail -f logs/canal/canal.log</span><br><span class="line">2020-05-28 13:52:03.037 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## set default uncaught exception handler</span></span><br><span class="line">2020-05-28 13:52:03.065 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="comment">## load canal configurations</span></span><br><span class="line">2020-05-28 13:52:03.072 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## start the canal server.</span></span><br><span class="line">2020-05-28 13:52:03.444 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - <span class="comment">## start the canal server[172.36.58.25(172.36.58.25):11111]</span></span><br><span class="line">2020-05-28 13:52:04.604 [main] INFO  com.alibaba.otter.canal.deployer.CanalStarter - <span class="comment">## the canal server is running now ......</span></span><br><span class="line">$ tail -f logs/example/example.log</span><br><span class="line">2020-05-28 13:52:04.238 [main] WARN  o.s.beans.GenericTypeAwarePropertyDescriptor - Invalid JavaBean property <span class="string">'connectionCharset'</span> being accessed! Ambiguous write methods found next to actually used [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.lang.String)]: [public void com.alibaba.otter.canal.parse.inbound.mysql.AbstractMysqlEventParser.setConnectionCharset(java.nio.charset.Charset)]</span><br><span class="line">2020-05-28 13:52:04.264 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br><span class="line">2020-05-28 13:52:04.265 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line">2020-05-28 13:52:04.568 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance <span class="keyword">for</span> 1-example</span><br><span class="line">2020-05-28 13:52:04.572 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table filter : ^.*\..*$</span><br><span class="line">2020-05-28 13:52:04.573 [main] WARN  c.a.o.canal.parse.inbound.mysql.dbsync.LogEventConvert - --&gt; init table black filter :</span><br><span class="line">2020-05-28 13:52:04.577 [main] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span><br><span class="line">2020-05-28 13:52:04.616 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; begin to find start position, it will be long time <span class="keyword">for</span> reset or first position</span><br><span class="line">2020-05-28 13:52:04.616 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - prepare to find start position just show master status</span><br><span class="line">2020-05-28 13:52:06.556 [destination = example , address = /127.0.0.1:3306 , EventParser] WARN  c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; find start position successfully, EntryPosition[included=<span class="literal">false</span>,journalName=mysql-bin.000001,position=4,serverId=1,gtid=&lt;null&gt;,timestamp=1590644973000] cost : 1935ms , the next step is binlog dump</span><br></pre></td></tr></table></figure><h2 id="四、初步监听实验"><a href="#四、初步监听实验" class="headerlink" title="四、初步监听实验"></a>四、初步监听实验</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.common.utils.AddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Column;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.Entry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EntryType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.EventType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowChange;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.RowData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCanalClientExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建链接</span></span><br><span class="line">        CanalConnector connector = CanalConnectors.newSingleConnector(<span class="keyword">new</span> InetSocketAddress(AddressUtils.getHostIp(),</span><br><span class="line">                <span class="number">11111</span>), <span class="string">"example"</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">int</span> batchSize = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> emptyCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line">            connector.subscribe(<span class="string">".*\\..*"</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="keyword">int</span> totalEmptyCount = <span class="number">120</span>;</span><br><span class="line">            <span class="keyword">while</span> (emptyCount &lt; totalEmptyCount) &#123;</span><br><span class="line">                Message message = connector.getWithoutAck(batchSize); <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="keyword">long</span> batchId = message.getId();</span><br><span class="line">                <span class="keyword">int</span> size = message.getEntries().size();</span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    emptyCount++;</span><br><span class="line">                    System.out.println(<span class="string">"empty count : "</span> + emptyCount);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    emptyCount = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">// System.out.printf("message[batchId=%s,size=%s] \n", batchId, size);</span></span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line">                <span class="comment">// connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"empty too many times, exit"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            RowChange rowChage = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ERROR ## parser of eromanga-event has an error , data:"</span> + entry.toString(),</span><br><span class="line">                        e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            EventType eventType = rowChage.getEventType();</span><br><span class="line">            System.out.println(String.format(<span class="string">"================&amp;gt; binlog[%s:%s] , name[%s,%s] , eventType : %s"</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(), entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(), entry.getHeader().getTableName(),</span><br><span class="line">                    eventType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"-------&amp;gt; before"</span>);</span><br><span class="line">                    printColumn(rowData.getBeforeColumnsList());</span><br><span class="line">                    System.out.println(<span class="string">"-------&amp;gt; after"</span>);</span><br><span class="line">                    printColumn(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printColumn</span><span class="params">(List&lt;Column&gt; columns)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">" : "</span> + column.getValue() + <span class="string">"    update="</span> + column.getUpdated());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="随便插入数据触发"><a href="#随便插入数据触发" class="headerlink" title="随便插入数据触发"></a>随便插入数据触发</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`demo`</span>.<span class="string">`tb_ad`</span>(<span class="string">`id`</span>, <span class="string">`url`</span>, <span class="string">`status`</span>, <span class="string">`position`</span>, <span class="string">`image`</span>, <span class="string">`start_time`</span>, <span class="string">`end_time`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'https://www.baidu.com/'</span>, <span class="string">'1'</span>, <span class="string">'web_index_lb'</span>, <span class="string">'https://pics1.baidu.com/feed/c83d70cf3bc79f3d5c30d358deb67a17738b29a6.jpeg?https://kins.oss-cn-shenzhen.aliyuncs.com/yhzb/2020-03-11/ca21b3b17d6f4757b991dd86b8cef3fa-VIP-680.jpeg'</span>, <span class="string">'2020-05-22 10:58:08'</span>, <span class="string">'2021-06-01 10:58:14'</span>);</span><br></pre></td></tr></table></figure><h3 id="从控制台中看到"><a href="#从控制台中看到" class="headerlink" title="从控制台中看到"></a>从控制台中看到</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">empty count : 66</span><br><span class="line">empty count : 67</span><br><span class="line">empty count : 68</span><br><span class="line">empty count : 69</span><br><span class="line">empty count : 70</span><br><span class="line">================&amp;gt; binlog[mysql-bin.000001:355] , name[demo,tb_ad] , eventType : <span class="keyword">INSERT</span></span><br><span class="line"><span class="keyword">id</span> : <span class="number">2</span>    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line"><span class="keyword">url</span> : https://www.baidu.com/    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line"><span class="keyword">status</span> : <span class="number">1</span>    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line"><span class="keyword">position</span> : web_index_lb    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line">image : https://pics1.baidu.com/feed/c83d70cf3bc79f3d5c30d358deb67a17738b29a6.jpeg?https://kins.oss-cn-shenzhen.aliyuncs.com/yhzb/<span class="number">2020</span><span class="number">-03</span><span class="number">-11</span>/ca21b3b17d6f4757b991dd86b8cef3fa-VIP<span class="number">-680.</span>jpeg    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line">start_time : <span class="number">2020</span><span class="number">-05</span><span class="number">-22</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">08</span>    <span class="keyword">update</span>=<span class="literal">true</span></span><br><span class="line">end_time : <span class="number">2021</span><span class="number">-06</span><span class="number">-01</span> <span class="number">10</span>:<span class="number">58</span>:<span class="number">14</span>    <span class="keyword">update</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="五、数据监控微服务"><a href="#五、数据监控微服务" class="headerlink" title="五、数据监控微服务"></a>五、数据监控微服务</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 第三方starter快速整合canal https://github.com/NormanGyllenhaal/canal-client--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/top.javatool/canal-spring-boot-starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.javatool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="订阅数据库的增删改操作"><a href="#订阅数据库的增删改操作" class="headerlink" title="订阅数据库的增删改操作"></a>订阅数据库的增删改操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.annotation.CanalTable;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.handler.EntryHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@CanalTable</span>(value = <span class="string">"t_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHandler</span> <span class="keyword">implements</span> <span class="title">EntryHandler</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(UserHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"insert message  &#123;&#125;"</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(User before, User after)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"update before &#123;&#125; "</span>, before);</span><br><span class="line">        logger.info(<span class="string">"update after &#123;&#125;"</span>, after);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"delete  &#123;&#125;"</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="启动数据监控微服务，修改user表，观察控制台输出。"><a href="#启动数据监控微服务，修改user表，观察控制台输出。" class="headerlink" title="启动数据监控微服务，修改user表，观察控制台输出。"></a>启动数据监控微服务，修改user表，观察控制台输出。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">22.667</span>  INFO <span class="number">24284</span> --- [l-client-thread] t.j.c.client.client.AbstractCanalClient  : 获取消息 Message[id=<span class="number">23</span>,entries=[header &#123;</span><br><span class="line">  version: <span class="number">1</span></span><br><span class="line">  logfileName: <span class="string">"mysql-bin.000001"</span></span><br><span class="line">  logfileOffset: <span class="number">18380</span></span><br><span class="line">  serverId: <span class="number">1</span></span><br><span class="line">  serverenCode: <span class="string">"UTF-8"</span></span><br><span class="line">  executeTime: <span class="number">1590654201000</span></span><br><span class="line">  sourceType: MYSQL</span><br><span class="line">  schemaName: <span class="string">""</span></span><br><span class="line">  tableName: <span class="string">""</span></span><br><span class="line">  eventLength: <span class="number">68</span></span><br><span class="line">&#125;</span><br><span class="line">entryType: TRANSACTIONBEGIN</span><br><span class="line">storeValue: <span class="string">" \025"</span></span><br><span class="line">, header &#123;</span><br><span class="line">  version: <span class="number">1</span></span><br><span class="line">  logfileName: <span class="string">"mysql-bin.000001"</span></span><br><span class="line">  logfileOffset: <span class="number">18505</span></span><br><span class="line">  serverId: <span class="number">1</span></span><br><span class="line">  serverenCode: <span class="string">"UTF-8"</span></span><br><span class="line">  executeTime: <span class="number">1590654201000</span></span><br><span class="line">  sourceType: MYSQL</span><br><span class="line">  schemaName: <span class="string">"demo"</span></span><br><span class="line">  tableName: <span class="string">"t_user"</span></span><br><span class="line">  eventLength: <span class="number">88</span></span><br><span class="line">  eventType: UPDATE</span><br><span class="line">  props &#123;</span><br><span class="line">    key: <span class="string">"rowsCount"</span></span><br><span class="line">    value: <span class="string">"1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">entryType: ROWDATA</span><br><span class="line">storeValue: <span class="string">"\b\210\002\020\002P\000b\370\003\n\033\b\000\020\004\032\002id \001(\0000\000B\00221R\aint(11)\n*\b\001\020\f\032\tuser_name \000(\0000\000B\005ZeldaR\fvarchar(255)\n*\b\002\020\372\377\377\377\377\377\377\377\377\001\032\006gender \000(\0000\000B\0010R\ntinyint(4)\n\"\b\003\020\004\032\ncountry_id \000(\0000\000B\0011R\aint(11)\n&amp;\b\004\020[\032\bbirthday \000(\0000\000B\n1998-04-18R\004date\n7\b\005\020]\032\vcreate_time \000(\0000\000B\0231991-01-10 05:45:50R\ttimestamp\022\033\b\000\020\004\032\002id \001(\0000\000B\00221R\aint(11)\022.\b\001\020\f\032\tuser_name \000(\0010\000B\tZelda1111R\fvarchar(255)\022*\b\002\020\372\377\377\377\377\377\377\377\377\001\032\006gender \000(\0000\000B\0010R\ntinyint(4)\022\"\b\003\020\004\032\ncountry_id \000(\0000\000B\0011R\aint(11)\022&amp;\b\004\020[\032\bbirthday \000(\0000\000B\n1998-04-18R\004date\0227\b\005\020]\032\vcreate_time \000(\0000\000B\0231991-01-10 05:45:50R\ttimestamp"</span></span><br><span class="line">, header &#123;</span><br><span class="line">  version: <span class="number">1</span></span><br><span class="line">  logfileName: <span class="string">"mysql-bin.000001"</span></span><br><span class="line">  logfileOffset: <span class="number">18593</span></span><br><span class="line">  serverId: <span class="number">1</span></span><br><span class="line">  serverenCode: <span class="string">"UTF-8"</span></span><br><span class="line">  executeTime: <span class="number">1590654201000</span></span><br><span class="line">  sourceType: MYSQL</span><br><span class="line">  schemaName: <span class="string">""</span></span><br><span class="line">  tableName: <span class="string">""</span></span><br><span class="line">  eventLength: <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line">entryType: TRANSACTIONEND</span><br><span class="line">storeValue: <span class="string">"\022\0041574"</span></span><br><span class="line">],raw=<span class="keyword">false</span>,rawEntries=[]]</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">22.668</span>  INFO <span class="number">24284</span> --- [xecute-thread-<span class="number">6</span>] t.j.canal.example.handler.UserHandler    : update before User&#123;id=<span class="keyword">null</span>, userName=<span class="string">'Zelda'</span>, gender=<span class="keyword">null</span>, countryId=<span class="keyword">null</span>, birthday=<span class="keyword">null</span>, createTime=<span class="keyword">null</span>&#125; </span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">22.668</span>  INFO <span class="number">24284</span> --- [xecute-thread-<span class="number">6</span>] t.j.canal.example.handler.UserHandler    : update after User&#123;id=<span class="number">21</span>, userName=<span class="string">'Zelda1111'</span>, gender=<span class="number">0</span>, countryId=<span class="number">1</span>, birthday=Sat Apr <span class="number">18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1998</span>, createTime=Thu Jan <span class="number">10</span> <span class="number">05</span>:<span class="number">45</span>:<span class="number">50</span> CST <span class="number">1991</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBoot-canal数据同步解决方案&quot;&gt;&lt;a href=&quot;#SpringBoot-canal数据同步解决方案&quot; class=&quot;headerlink&quot; title=&quot;SpringBoot canal数据同步解决方案&quot;&gt;&lt;/a&gt;SpringBoot can
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Springboot" scheme="https://caochikai.github.io/tags/Springboot/"/>
    
  </entry>
  
  <entry>
    <title>Swagger关于令牌校验</title>
    <link href="https://caochikai.github.io/2020/05/27/Swagger%E5%85%B3%E4%BA%8E%E4%BB%A4%E7%89%8C%E6%A0%A1%E9%AA%8C/"/>
    <id>https://caochikai.github.io/2020/05/27/Swagger%E5%85%B3%E4%BA%8E%E4%BB%A4%E7%89%8C%E6%A0%A1%E9%AA%8C/</id>
    <published>2020-05-27T14:56:00.000Z</published>
    <updated>2020-05-27T15:25:31.949Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Swagger关于令牌校验"><a href="#Swagger关于令牌校验" class="headerlink" title="Swagger关于令牌校验"></a>Swagger关于令牌校验</h1><h2 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h2><blockquote><p>微服务oauth2校验令牌，通过Swagger2的securitySchemes配置全局token参数，也可以创建一个默认测试用户默认启动时候登陆获取永久期限的令牌。</p></blockquote><h2 id="二、swagger配置实现"><a href="#二、swagger配置实现" class="headerlink" title="二、swagger配置实现"></a>二、swagger配置实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个Docket对象</span></span><br><span class="line"><span class="comment">     * 调用select()方法，</span></span><br><span class="line"><span class="comment">     * 生成ApiSelectorBuilder对象实例，该对象负责定义外漏的API入口</span></span><br><span class="line"><span class="comment">     * 通过使用RequestHandlerSelectors和PathSelectors来提供Predicate，在此我们使用any()方法，将所有API都通过Swagger进行文档管理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.xxx"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build()</span><br><span class="line">                .securitySchemes(securitySchemes())</span><br><span class="line">                .securityContexts(securityContexts())</span><br><span class="line">                .globalOperationParameters(globalOperationParameters());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Parameter&gt; <span class="title">globalOperationParameters</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//添加默认head参数Authorization</span></span><br><span class="line">        ParameterBuilder tokenPar = <span class="keyword">new</span> ParameterBuilder();</span><br><span class="line">        List&lt;Parameter&gt; pars = <span class="keyword">new</span> ArrayList&lt;Parameter&gt;();</span><br><span class="line">        tokenPar.name(<span class="string">"Authorization"</span>).defaultValue(<span class="string">"Bearer "</span>).description(<span class="string">"令牌"</span>).modelRef(<span class="keyword">new</span> ModelRef(<span class="string">"string"</span>)).parameterType(<span class="string">"header"</span>).required(<span class="keyword">false</span>).build();</span><br><span class="line">        pars.add(tokenPar.build());</span><br><span class="line">        <span class="keyword">return</span> pars;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ApiKey&gt; <span class="title">securitySchemes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;ApiKey&gt; apiKeyList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        apiKeyList.add(<span class="keyword">new</span> ApiKey(<span class="string">"Authorization"</span>, <span class="string">"Authorization"</span>, <span class="string">"header"</span>));</span><br><span class="line">        <span class="keyword">return</span> apiKeyList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;SecurityContext&gt; <span class="title">securityContexts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;SecurityContext&gt; securityContexts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//通过PathSelectors.regex("^(?!auth).*$")，排除包含"auth"的接口不需要使用securitySchemes</span></span><br><span class="line">        securityContexts.add(</span><br><span class="line">                SecurityContext.builder()</span><br><span class="line">                        .securityReferences(defaultAuth())</span><br><span class="line">                        .forPaths(PathSelectors.regex(<span class="string">"^(?!auth).*$"</span>))</span><br><span class="line">                        .build());</span><br><span class="line">        <span class="keyword">return</span> securityContexts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;SecurityReference&gt; <span class="title">defaultAuth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthorizationScope authorizationScope = <span class="keyword">new</span> AuthorizationScope(<span class="string">"global"</span>, <span class="string">"accessEverything"</span>);</span><br><span class="line">        AuthorizationScope[] authorizationScopes = <span class="keyword">new</span> AuthorizationScope[<span class="number">1</span>];</span><br><span class="line">        authorizationScopes[<span class="number">0</span>] = authorizationScope;</span><br><span class="line">        List&lt;SecurityReference&gt; securityReferences = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        securityReferences.add(<span class="keyword">new</span> SecurityReference(<span class="string">"Authorization"</span>, authorizationScopes));</span><br><span class="line">        <span class="keyword">return</span> securityReferences;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                <span class="comment">//标题</span></span><br><span class="line">                .title(<span class="string">"gold-mall-biz使用Swagger2构建RESTful APIs"</span>)</span><br><span class="line">                <span class="comment">//简介</span></span><br><span class="line">                .description(<span class="string">""</span>)</span><br><span class="line">                <span class="comment">//服务条款</span></span><br><span class="line">                .termsOfServiceUrl(<span class="string">""</span>)</span><br><span class="line">                <span class="comment">//作者个人信息</span></span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"xxx"</span>, <span class="string">""</span>, <span class="string">"xxx@163.com"</span>))</span><br><span class="line">                <span class="comment">//版本</span></span><br><span class="line">                .version(<span class="string">"1.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>设置完成后进入SwaggerUI，右上角出现“Authorization”按钮，输入令牌对于除上文所述的包含auth的接口结果都会带上token。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-14.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Swagger关于令牌校验&quot;&gt;&lt;a href=&quot;#Swagger关于令牌校验&quot; class=&quot;headerlink&quot; title=&quot;Swagger关于令牌校验&quot;&gt;&lt;/a&gt;Swagger关于令牌校验&lt;/h1&gt;&lt;h2 id=&quot;一、需求&quot;&gt;&lt;a href=&quot;#一、需求&quot;
      
    
    </summary>
    
    
      <category term="tool" scheme="https://caochikai.github.io/categories/tool/"/>
    
    
      <category term="swagger" scheme="https://caochikai.github.io/tags/swagger/"/>
    
  </entry>
  
  <entry>
    <title>postman测试脚本自定义token</title>
    <link href="https://caochikai.github.io/2020/05/26/postman%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E8%87%AA%E5%AE%9A%E4%B9%89token/"/>
    <id>https://caochikai.github.io/2020/05/26/postman%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC%E8%87%AA%E5%AE%9A%E4%B9%89token/</id>
    <published>2020-05-26T14:42:00.000Z</published>
    <updated>2020-05-26T06:56:40.247Z</updated>
    
    <content type="html"><![CDATA[<h1 id="postman测试脚本自定义token"><a href="#postman测试脚本自定义token" class="headerlink" title="postman测试脚本自定义token"></a>postman测试脚本自定义token</h1><h2 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h2><blockquote><p>postman在测试微服务需要携带oauth2校验令牌Authorization:Bearer ，通过environment variable环境和test Script脚本，针对单次请求或者整个Collections设置自定义请求，甚至可以编排测试流程做自动化测试。environment一般来说分开发、测试和生产环境，从variable角度分environment variable（环境变量）、gloab variable（全局变量）和Collections variable（集合变量），对应了多项目多环境的测试需求；当然postman不足地方不能做自动化UI测试，遇到bug自动截屏或者内部堆栈记录报告；此外，如何从流行的swagger导入postman，OpenAPI与swagger哪个更适合新需求，个人推荐OpenAPI，它与postman更为兼容。</p></blockquote><h2 id="二、设置token环境变量"><a href="#二、设置token环境变量" class="headerlink" title="二、设置token环境变量"></a>二、设置token环境变量</h2><h3 id="设置postman的环境变量，添加变量token和host"><a href="#设置postman的环境变量，添加变量token和host" class="headerlink" title="设置postman的环境变量，添加变量token和host"></a><a href="https://learning.postman.com/docs/postman/variables-and-environments/managing-environments/" target="_blank" rel="noopener">设置postman的环境变量</a>，添加变量token和host</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/managing-environments.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="在登录请求写test-Script脚本获取access-token设置环境变量token，参考官方API文档"><a href="#在登录请求写test-Script脚本获取access-token设置环境变量token，参考官方API文档" class="headerlink" title="在登录请求写test Script脚本获取access_token设置环境变量token，参考官方API文档"></a>在登录请求写test Script脚本获取access_token设置环境变量token，参考<a href="https://learning.postman.com/docs/postman/scripts/postman-sandbox-api-reference/" target="_blank" rel="noopener">官方API文档</a></h3><p><img src="/images/setting-environments.png" alt="upload successful"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var data = JSON.parse(responseBody);</span><br><span class="line">pm.environment.set(<span class="string">"token"</span>,data.access_token);</span><br></pre></td></tr></table></figure><h3 id="单次请求中一次性使用在Headers添加Authorization-Bearer-；如果想复用token，在下图右下角红框点击Prese进入Manage-Prese，header添加到Prese管理，在其他请求里选择是否使用该header（手动添加）。"><a href="#单次请求中一次性使用在Headers添加Authorization-Bearer-；如果想复用token，在下图右下角红框点击Prese进入Manage-Prese，header添加到Prese管理，在其他请求里选择是否使用该header（手动添加）。" class="headerlink" title="单次请求中一次性使用在Headers添加Authorization:Bearer ；如果想复用token，在下图右下角红框点击Prese进入Manage Prese，header添加到Prese管理，在其他请求里选择是否使用该header（手动添加）。"></a>单次请求中一次性使用在Headers添加Authorization:Bearer ；如果想复用token，在下图右下角红框点击Prese进入Manage Prese，header添加到Prese管理，在其他请求里选择是否使用该header（手动添加）。</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-7.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="Pre-request-Script全局Collections下所有请求使用该自定义请求头，右键Collections选择Edit进入编辑。"><a href="#Pre-request-Script全局Collections下所有请求使用该自定义请求头，右键Collections选择Edit进入编辑。" class="headerlink" title="Pre-request Script全局Collections下所有请求使用该自定义请求头，右键Collections选择Edit进入编辑。"></a>Pre-request Script全局Collections下所有请求使用该自定义请求头，右键Collections选择Edit进入编辑。</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/image.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-8.png" alt="filename already exists, renamed" title="">                </div>                <div class="image-caption">filename already exists, renamed</div>            </figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm.request.headers.upsert(&#123; key: <span class="string">"Authorization"</span>, value: <span class="string">"Bearer "</span> + pm.environment.get(<span class="string">"token"</span>), disabled: <span class="literal">false</span>&#125;);</span><br></pre></td></tr></table></figure><h2 id="三、通过console是否已经携带token，查看请求日志"><a href="#三、通过console是否已经携带token，查看请求日志" class="headerlink" title="三、通过console是否已经携带token，查看请求日志"></a>三、通过console是否已经携带token，查看请求日志</h2><p><img src="/images/pasted-9.png" alt="filename already exists, renamed"></p><h2 id="四、swagger导入postman诀窍"><a href="#四、swagger导入postman诀窍" class="headerlink" title="四、swagger导入postman诀窍"></a>四、swagger导入postman诀窍</h2><blockquote><p>无论通过<a href="http://localhost:9999/mall/v2/api-docs" target="_blank" rel="noopener">http://localhost:9999/v2/api-docs</a>下载成json再导入，还是通过链接导入都不能；因为postman目前只支持OpenAPI。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-10.png" alt="filename already exists, renamed" title="">                </div>                <div class="image-caption">filename already exists, renamed</div>            </figure><blockquote><p>正确做法是通过<a href="http://editor.swagger.io/" target="_blank" rel="noopener">swagger在线编辑器</a>导入swagger文档，点击File选择import  URL输入本地swagger url，导入成功点击Edit看见Cover to OpenAPI3，转化成openapi3后。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-11.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-12.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><blockquote><p>复制openapi脚本通过postman左上角import选择Raw Text导入，如下图所示</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-13.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h2 id="五、参考资料如下："><a href="#五、参考资料如下：" class="headerlink" title="五、参考资料如下："></a>五、参考资料如下：</h2><ol><li><a href="https://learning.postman.com/docs/postman/scripts/test-examples/" target="_blank" rel="noopener">Test examples</a></li><li><a href="https://blog.csdn.net/wuchenlhy/article/details/84316428?utm_medium=distribute.pc_relevant.none-task-blog-baidujs-3" target="_blank" rel="noopener">Postman之Pre-request Script 使用详解</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;postman测试脚本自定义token&quot;&gt;&lt;a href=&quot;#postman测试脚本自定义token&quot; class=&quot;headerlink&quot; title=&quot;postman测试脚本自定义token&quot;&gt;&lt;/a&gt;postman测试脚本自定义token&lt;/h1&gt;&lt;h2 i
      
    
    </summary>
    
    
      <category term="test" scheme="https://caochikai.github.io/categories/test/"/>
    
      <category term="tool" scheme="https://caochikai.github.io/categories/test/tool/"/>
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>Jmeter压力测试openresty多级缓存</title>
    <link href="https://caochikai.github.io/2020/05/25/Jmeter%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95openresty%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"/>
    <id>https://caochikai.github.io/2020/05/25/Jmeter%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95openresty%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/</id>
    <published>2020-05-25T12:32:00.000Z</published>
    <updated>2020-05-25T07:37:38.980Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Jmeter压力测试openresty多级缓存"><a href="#Jmeter压力测试openresty多级缓存" class="headerlink" title="Jmeter压力测试openresty多级缓存"></a>Jmeter压力测试openresty多级缓存</h1><h1 id="一、快速使用"><a href="#一、快速使用" class="headerlink" title="一、快速使用"></a>一、快速使用</h1><ol><li>从<a href="https://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="noopener">Jmeter官网</a>下载Apache JMeter 5.3 (Requires Java 8+)；</li><li>解压apache-jmeter-5.3.zip打开apache-jmeter-5.3\bin\jmeter.bat，前提是JDK环境变量配好和版本满足要求；</li><li>进入GUI界面后默认是英语，点击菜单栏【Options】按钮，依次单击【Choose language】&gt;【Chinese(simplified)】；</li><li>如果不喜欢黑暗主题，菜单栏【Options】下的选择第一个外观</li></ol><h1 id="二、新建压测实例"><a href="#二、新建压测实例" class="headerlink" title="二、新建压测实例"></a>二、新建压测实例</h1><blockquote><p>参照上一篇文章OpenResty+lua+redis实现多级缓存，我对多级缓存进行压测，先进行缓存预热，再对其进行压测；本地压测虽然不太标准，线程组200循环10次，普通tomcat的sql查询吞吐量TPS100/sec左右，加了redis缓存250/sec左右，OpenResty可以查看报告大概稳定9800/sec（线程2000，循环10次）；为了提升压测结果，可以选择增加数据库连接池和tomcat的最大连接数和初始连接数，以及缓冲区大小优化；先进方式就利用大量测试进行机器学习，找到相对优秀的配置组合。</p></blockquote><ul><li><p>添加本次测试计划 （Test Plan右键–&gt;添加–&gt;Threads（Users）–&gt;线程组）</p></li><li><p>设置线程数(并发用户数)和循环次数</p></li></ul><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/ThreadsGroup.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><ul><li>添加Http请求协议及相关配置信息（Thread Group右键–&gt;添加–&gt;取样器–&gt;Http请求）</li></ul><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/jemter-http.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><ul><li>为线程添加监听器——察看结果树、聚合报告和图形结果</li></ul><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/jmeter-report.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><ul><li>启动测试计划，查看测试报告</li></ul><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/jmeter-getReport.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h1 id="三、参考资料"><a href="#三、参考资料" class="headerlink" title="三、参考资料"></a>三、参考资料</h1><ol><li><a href="https://jingyan.baidu.com/article/b0b63dbf25733b4a4830708f.html" target="_blank" rel="noopener">jmeter如何设置语言为中文</a></li><li><a href="https://jingyan.baidu.com/article/afd8f4deb52cfc34e286e9d3.html" target="_blank" rel="noopener">分析JMeter聚合报告中的各项指标</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Jmeter压力测试openresty多级缓存&quot;&gt;&lt;a href=&quot;#Jmeter压力测试openresty多级缓存&quot; class=&quot;headerlink&quot; title=&quot;Jmeter压力测试openresty多级缓存&quot;&gt;&lt;/a&gt;Jmeter压力测试openres
      
    
    </summary>
    
    
      <category term="test" scheme="https://caochikai.github.io/categories/test/"/>
    
    
      <category term="jmeter" scheme="https://caochikai.github.io/tags/jmeter/"/>
    
  </entry>
  
  <entry>
    <title>OpenResty+lua+redis实现多级缓存</title>
    <link href="https://caochikai.github.io/2020/05/23/OpenResty-lua-redis%E5%AE%9E%E7%8E%B0%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98/"/>
    <id>https://caochikai.github.io/2020/05/23/OpenResty-lua-redis%E5%AE%9E%E7%8E%B0%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98/</id>
    <published>2020-05-23T10:59:00.000Z</published>
    <updated>2020-05-25T03:36:26.291Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OpenResty-lua-redis实现多级缓存"><a href="#OpenResty-lua-redis实现多级缓存" class="headerlink" title="OpenResty+lua+redis实现多级缓存"></a>OpenResty+lua+redis实现多级缓存</h1><h1 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h1><blockquote><p><a href="http://openresty.org/cn/" target="_blank" rel="noopener">ngx_openresty</a>是一个基于 NGINX的lua可编程模块，在性能方面有着出色的性能，配合redis做二级缓存效果，nginx开启一级本地缓存。</p></blockquote><h3 id="实验数据库sql"><a href="#实验数据库sql" class="headerlink" title="实验数据库sql"></a>实验数据库sql</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for tb_ad</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`tb_ad`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tb_ad`</span>  (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'广告主键'</span>,</span><br><span class="line">  <span class="string">`url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'URL'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0：无效  1:有效'</span>,</span><br><span class="line">  <span class="string">`position`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'广告位置'</span>,</span><br><span class="line">  <span class="string">`image`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片路径'</span>,</span><br><span class="line">  <span class="string">`start_time`</span> datetime(<span class="number">0</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'开始时间'</span>,</span><br><span class="line">  <span class="string">`end_time`</span> datetime(<span class="number">0</span>) <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'到期时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> AUTO_INCREMENT = <span class="number">2</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = utf8 <span class="keyword">COLLATE</span> = utf8_general_ci ROW_FORMAT = Dynamic;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of tb_ad</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`tb_ad`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'https://www.baidu.com/'</span>, <span class="string">'1'</span>, <span class="string">'web_index_lb'</span>, <span class="string">'https://kins.oss-cn-shenzhen.aliyuncs.com/yhzb/2020-03-11/ca21b3b17d6f4757b991dd86b8cef3fa-VIP-680.jpeg'</span>, <span class="string">'2020-05-22 10:58:08'</span>, <span class="string">'2021-06-01 10:58:14'</span>);</span><br></pre></td></tr></table></figure><h1 id="二、一二级缓存实现"><a href="#二、一二级缓存实现" class="headerlink" title="二、一二级缓存实现"></a>二、一二级缓存实现</h1><blockquote><p>查询mysql中上架的所有广告转换为json字符串，放入redis中作为二级缓存，等真正的第一次查询会把缓存加入一级本地缓存。当广告修改时候需要请求，需要请求预热接口。</p></blockquote><h3 id="nginx-conf文件配置"><a href="#nginx-conf文件配置" class="headerlink" title="nginx.conf文件配置"></a>nginx.conf文件配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">user</span> root root;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    <span class="comment">#包含redis初始化模块</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dis_cache <span class="number">5m</span>;  <span class="comment">#共享内存开启</span></span><br><span class="line">    </span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line">        <span class="comment"># 添加预热和读取接口</span></span><br><span class="line">        <span class="attribute">location</span> /ad_loading&#123;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/ad_loading.lua;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">location</span> /ad_read &#123;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> /root/lua/ad_read.lua;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ad-loading-lua预热脚本"><a href="#ad-loading-lua预热脚本" class="headerlink" title="ad_loading.lua预热脚本"></a>ad_loading.lua预热脚本</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ngx.header.content_type=<span class="string">"application/json;charset=utf8"</span></span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">"cjson"</span>)</span><br><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span>(<span class="string">"resty.mysql"</span>)</span><br><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args()</span><br><span class="line"><span class="keyword">local</span> position = uri_args[<span class="string">"position"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> db = mysql:new()</span><br><span class="line">db:set_timeout(<span class="number">1000</span>)  </span><br><span class="line"><span class="keyword">local</span> props = &#123;  </span><br><span class="line">    host = <span class="string">"127.0.0.1"</span>,  </span><br><span class="line">    port = <span class="number">3306</span>,  </span><br><span class="line">    database = <span class="string">"business"</span>,  </span><br><span class="line">    user = <span class="string">"root"</span>,  </span><br><span class="line">    password = <span class="string">"root"</span>  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res = db:connect(props)  </span><br><span class="line"><span class="keyword">local</span> select_sql = <span class="string">"select url,image from tb_ad where status ='1' and position='"</span>..position..<span class="string">"' and start_time&lt;= NOW() AND end_time&gt;= NOW()"</span>  </span><br><span class="line">res = db:query(select_sql)  </span><br><span class="line">db:<span class="built_in">close</span>()  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">"resty.redis"</span>)</span><br><span class="line"><span class="keyword">local</span> red = redis:new()</span><br><span class="line">red:set_timeout(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ip =<span class="string">"127.0.0.1"</span></span><br><span class="line"><span class="keyword">local</span> port = <span class="number">6379</span></span><br><span class="line">red:connect(ip,port)</span><br><span class="line"><span class="comment">--Redis Authentication</span></span><br><span class="line"><span class="keyword">local</span> result, err = red:auth(<span class="string">"redis"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">red:set(<span class="string">"ad_"</span>..position,cjson.encode(res))</span><br><span class="line">red:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">"&#123;flag:true&#125;"</span>)</span><br></pre></td></tr></table></figure><h3 id="ad-read-lua读取脚本"><a href="#ad-read-lua读取脚本" class="headerlink" title="ad_read.lua读取脚本"></a>ad_read.lua读取脚本</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--设置响应头类型</span></span><br><span class="line">ngx.header.content_type=<span class="string">"application/json;charset=utf8"</span></span><br><span class="line"><span class="comment">--获取请求中的参数ID</span></span><br><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args();</span><br><span class="line"><span class="keyword">local</span> position = uri_args[<span class="string">"position"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">--获取本地缓存</span></span><br><span class="line"><span class="keyword">local</span> cache_ngx = ngx.shared.dis_cache;</span><br><span class="line"><span class="comment">--根据ID 获取本地缓存数据</span></span><br><span class="line"><span class="keyword">local</span> adCache = cache_ngx:get(<span class="string">'ad_cache_'</span>..position);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> adCache == <span class="string">""</span> <span class="keyword">or</span> adCache == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">"resty.redis"</span>);</span><br><span class="line">    <span class="keyword">local</span> red = redis:new()</span><br><span class="line">    red:set_timeout(<span class="number">2000</span>)</span><br><span class="line">    <span class="keyword">local</span> ok, err = red:connect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>)</span><br><span class="line">    <span class="comment">--Redis Authentication</span></span><br><span class="line">    <span class="keyword">local</span> result, err = red:auth(<span class="string">"redis"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">"failed to authenticate: "</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> rescontent=red:get(<span class="string">"ad_"</span>..position)</span><br><span class="line">    ngx.say(rescontent)</span><br><span class="line">    red:<span class="built_in">close</span>()</span><br><span class="line">    <span class="comment">--将redis中获取到广告数据存入nginx本地缓存</span></span><br><span class="line">    cache_ngx:set(<span class="string">'ad_cache_'</span>..position, rescontent, <span class="number">10</span>*<span class="number">60</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">     <span class="comment">--nginx本地缓存中获取到数据直接输出</span></span><br><span class="line">     ngx.say(adCache)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h1 id="三、拓展方向"><a href="#三、拓展方向" class="headerlink" title="三、拓展方向"></a>三、拓展方向</h1><blockquote><p>lua + nginx可以作为网关进行限流、流控和多级缓存使用，内存小可用性也非常高，配合一些lua模块可以做一些深入拓展。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;OpenResty-lua-redis实现多级缓存&quot;&gt;&lt;a href=&quot;#OpenResty-lua-redis实现多级缓存&quot; class=&quot;headerlink&quot; title=&quot;OpenResty+lua+redis实现多级缓存&quot;&gt;&lt;/a&gt;OpenResty+l
      
    
    </summary>
    
    
      <category term="nginx" scheme="https://caochikai.github.io/categories/nginx/"/>
    
    
      <category term="nginx" scheme="https://caochikai.github.io/tags/nginx/"/>
    
      <category term="redis" scheme="https://caochikai.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>防止jenkins杀掉jar后台运行</title>
    <link href="https://caochikai.github.io/2020/05/22/%E9%98%B2%E6%AD%A2jenkins%E6%9D%80%E6%8E%89jar%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C/"/>
    <id>https://caochikai.github.io/2020/05/22/%E9%98%B2%E6%AD%A2jenkins%E6%9D%80%E6%8E%89jar%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C/</id>
    <published>2020-05-22T12:09:00.000Z</published>
    <updated>2020-05-27T15:24:54.867Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><blockquote><p>记录两年前jenkins持续集成遇到需要任务后台执行（nohup执行）结果发现jenkins的job执行完后，看不到运行的进程。shell启动脚本如下：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar /bootdo.jar &gt; bootdolog.file 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h1 id="二、解决方法"><a href="#二、解决方法" class="headerlink" title="二、解决方法"></a>二、解决方法</h1><blockquote><p>Jenkins任务结束时候默认使用processTreeKiller自动关掉了所有的子进程，通过下列两种方式都可以让其在后台运行。全局关闭，具体参考：<a href="https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/ProcessTreeKiller</a>。</p></blockquote><h3 id="全局启动参数"><a href="#全局启动参数" class="headerlink" title="全局启动参数"></a>全局启动参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dhudson.util.ProcessTree.disable=<span class="literal">true</span> -jar jenkins.war</span><br></pre></td></tr></table></figure><h3 id="Tomcat启动修改catalina-sh"><a href="#Tomcat启动修改catalina-sh" class="headerlink" title="Tomcat启动修改catalina.sh"></a>Tomcat启动修改catalina.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">"<span class="variable">$JAVA_OPTS</span> -Dhudson.util.ProcessTree.disable=true"</span>；</span><br></pre></td></tr></table></figure><h3 id="当前job便捷方式"><a href="#当前job便捷方式" class="headerlink" title="当前job便捷方式"></a>当前job便捷方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#BUILD_ID可以自定义环境变量名，下面只是举例</span></span><br><span class="line">BUILD_ID=dontKillMe /usr/apache/bin/httpd</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;一、背景&quot;&gt;&lt;a href=&quot;#一、背景&quot; class=&quot;headerlink&quot; title=&quot;一、背景&quot;&gt;&lt;/a&gt;一、背景&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;记录两年前jenkins持续集成遇到需要任务后台执行（nohup执行）结果发现jenkins的jo
      
    
    </summary>
    
    
      <category term="jenkins" scheme="https://caochikai.github.io/categories/jenkins/"/>
    
    
      <category term="jenkins" scheme="https://caochikai.github.io/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins常见技巧和插件加速</title>
    <link href="https://caochikai.github.io/2020/05/21/Jenkins%E5%B8%B8%E8%A7%81%E6%8A%80%E5%B7%A7%E5%92%8C%E6%8F%92%E4%BB%B6%E5%8A%A0%E9%80%9F/"/>
    <id>https://caochikai.github.io/2020/05/21/Jenkins%E5%B8%B8%E8%A7%81%E6%8A%80%E5%B7%A7%E5%92%8C%E6%8F%92%E4%BB%B6%E5%8A%A0%E9%80%9F/</id>
    <published>2020-05-21T06:53:00.000Z</published>
    <updated>2020-05-21T07:00:09.872Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Jenkins常见技巧和插件加速"><a href="#Jenkins常见技巧和插件加速" class="headerlink" title="Jenkins常见技巧和插件加速"></a>Jenkins常见技巧和插件加速</h1><h1 id="展望计划"><a href="#展望计划" class="headerlink" title="展望计划"></a>展望计划</h1><blockquote><p>在微服务单体仓库、GitLab和k8s环境下，如何配合测试、运维完成Devops。参数化自动和手动构建同时按需增量，同时多次更新合并到最后一次，成功失败发送邮件和信息到运维。包括静态代码检查、自动化测试和容器热更新，同时探讨JenkinsX和Gitlab CI提高构建效率。</p></blockquote><h1 id="一、如何快速启动、停止、重启、查看日志"><a href="#一、如何快速启动、停止、重启、查看日志" class="headerlink" title="一、如何快速启动、停止、重启、查看日志"></a>一、如何快速启动、停止、重启、查看日志</h1><blockquote><p>采用通用的URL方式，就可以实现Jenins的停止，重启和重载。启动java -jar jenkins.war方式，或者通过tomcat也可。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//[jenkins-server-address][:port]/[command] </span></span><br><span class="line">where [command] can be</span><br><span class="line">exit to shutdown jenkins</span><br><span class="line">restart to restart jenkins</span><br><span class="line">reload to reload the configuration</span><br></pre></td></tr></table></figure><blockquote><p>查看日志根据<a href="https://www.jenkins.io/doc/book/system-administration/viewing-logs/" target="_blank" rel="noopener">Jenkins官方文档</a>，tail -f 日志文件位置，遇到过由于docket插件造成日志文件爆磁盘。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Linux</span><br><span class="line">By <span class="keyword">default</span> logs should be made available in /<span class="keyword">var</span>/log/jenkins/jenkins.log, unless customized in /etc/<span class="keyword">default</span>/jenkins (<span class="keyword">for</span> *.deb) or via /etc/sysconfig/jenkins (<span class="keyword">for</span> */rpm)</span><br><span class="line">Windows</span><br><span class="line">By <span class="keyword">default</span> logs should be at %JENKINS_HOME%/jenkins.out and %JENKINS_HOME%/jenkins.err, unless customized in %JENKINS_HOME%/jenkins.xml</span><br><span class="line">Docker</span><br><span class="line">If you run Jenkins inside docker as a detached container, you can use docker logs containerId to view the Jenkins logs.</span><br></pre></td></tr></table></figure><blockquote><p>在Jenkins内部日志是可以设置logs级别和信息，默认使用java.util.logging输出INFO级别日志。插件日志可以添加log recorder，就可以查看到源码级别日志输出，如图所示：</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://www.jenkins.io/doc/book/resources/managing/logging-manage-screen.png" alt="https://www.jenkins.io/doc/book/resources/managing/logging-manage-screen.png" title="">                </div>                <div class="image-caption">https://www.jenkins.io/doc/book/resources/managing/logging-manage-screen.png</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://img2018.cnblogs.com/blog/692500/201908/692500-20190811165844377-1762367867.png" alt="https://img2018.cnblogs.com/blog/692500/201908/692500-20190811165844377-1762367867.png" title="">                </div>                <div class="image-caption">https://img2018.cnblogs.com/blog/692500/201908/692500-20190811165844377-1762367867.png</div>            </figure><h1 id="二、国内镜像加速插件和版本更新"><a href="#二、国内镜像加速插件和版本更新" class="headerlink" title="二、国内镜像加速插件和版本更新"></a>二、国内镜像加速插件和版本更新</h1><blockquote><p>官方镜像很慢几乎不可用，国内有两家镜像源：清华大学和华为，个人选择华为速度起飞︿(￣︶￣)︿。需要改动两个文件hudson.model.UpdateCenter.xml和/updates/default.json，更新完成通过<a href="http://localhost:8080/restart" target="_blank" rel="noopener">http://localhost:8080/restart</a>重启，下载插件速度飙升跑满宽带。</p></blockquote><h3 id="镜像列表"><a href="#镜像列表" class="headerlink" title="镜像列表"></a>镜像列表</h3><ol><li>清华大学镜像：<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></li><li>华为镜像：<a href="https://mirrors.huaweicloud.com/jenkins" target="_blank" rel="noopener">https://mirrors.huaweicloud.com/jenkins</a><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json" target="_blank" rel="noopener">/updates/update-center.json</a></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim hudson.model.UpdateCenter.xml</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sites</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://mirrors.huaweicloud.com/jenkins/updates/update-center.json<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sites</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim updates/default.json</span><br><span class="line">:1,<span class="variable">$s</span>/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.huaweicloud.com\/jenkins/g</span><br><span class="line">:1,<span class="variable">$s</span>/http:\/\/www.google.com/https:\/\/www.baidu.com/g</span><br></pre></td></tr></table></figure><h1 id="三、参考资料"><a href="#三、参考资料" class="headerlink" title="三、参考资料"></a>三、参考资料</h1><ol><li><a href="https://www.cnblogs.com/dzblog/p/6962810.html" target="_blank" rel="noopener">Jenkins技巧：如何启动、停止、重启、重载Jenkins</a></li><li><a href="https://www.jenkins.io/doc/book/system-administration/viewing-logs/" target="_blank" rel="noopener">Viewing logs Table of Contents Logs on the system</a></li><li><a href="https://www.cnblogs.com/shengulong/p/11335536.html" target="_blank" rel="noopener">Jenkins增加日志查看内容. 如何查看Jenkins插件的日志？</a></li><li><a href="https://benpaodewoniu.github.io/2020/03/03/jenkins1/" target="_blank" rel="noopener">jenkins | 使用镜像加速安装插件</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Jenkins常见技巧和插件加速&quot;&gt;&lt;a href=&quot;#Jenkins常见技巧和插件加速&quot; class=&quot;headerlink&quot; title=&quot;Jenkins常见技巧和插件加速&quot;&gt;&lt;/a&gt;Jenkins常见技巧和插件加速&lt;/h1&gt;&lt;h1 id=&quot;展望计划&quot;&gt;&lt;a 
      
    
    </summary>
    
    
      <category term="jenkins" scheme="https://caochikai.github.io/categories/jenkins/"/>
    
    
      <category term="jenkins" scheme="https://caochikai.github.io/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud Feign连接池okhttp EOF异常</title>
    <link href="https://caochikai.github.io/2020/05/18/Spring-Cloud-Feign%E8%BF%9E%E6%8E%A5%E6%B1%A0okhttp-EOF%E5%BC%82%E5%B8%B8/"/>
    <id>https://caochikai.github.io/2020/05/18/Spring-Cloud-Feign%E8%BF%9E%E6%8E%A5%E6%B1%A0okhttp-EOF%E5%BC%82%E5%B8%B8/</id>
    <published>2020-05-18T07:07:00.000Z</published>
    <updated>2020-05-18T07:15:10.111Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-Cloud-Feign连接池okhttp-EOF异常"><a href="#Spring-Cloud-Feign连接池okhttp-EOF异常" class="headerlink" title="Spring Cloud Feign连接池okhttp EOF异常"></a>Spring Cloud Feign连接池okhttp EOF异常</h1><h2 id="一、异常说明"><a href="#一、异常说明" class="headerlink" title="一、异常说明"></a>一、异常说明</h2><blockquote><p>所有中台服务有一定概率经常返回远程调用返回null情况，而且在我进入公司之前已经出现过很长一段时间都未曾解决。我第一怀疑的是远程调用时间开销过长，通过埋点FeignFallback记录系统日志记录，一段时间过后sys_log大量类似下面记录，证明我的猜想是错误的；通过Linux tail查看jar日志，追踪源码发现是Okhttp java.io.EOFException: \n not found: size=0 content= unexpected end，根据<a href="https://github.com/square/okhttp/issues/2738" target="_blank" rel="noopener">okhttp github issue</a>可以得出结论，由于连接池ConnectionPool 默认keep-alive超时时间是5min，超过时间server端会主动关闭这个连接，导致输入流中断，进而抛出EOF 异常；另一种情况就是网络不稳定抖动时候也会出现。</p></blockquote><h3 id="埋点系统日志"><a href="#埋点系统日志" class="headerlink" title="埋点系统日志"></a>埋点系统日志</h3><table><thead><tr><th>id</th><th>type</th><th>title</th><th>service_id</th><th>create_by</th><th>create_time</th><th>update_time</th><th>remote_addr</th><th>user_agent</th><th>request_uri</th><th>method</th><th>params</th><th>time</th><th>del_flag</th><th>exception</th></tr></thead><tbody><tr><td>5179</td><td>0</td><td>feign接口获取会员信息失败</td><td>pig</td><td>1868054xxxx</td><td>2020-05-15 13:40:17.0</td><td>2020-05-15 13:40:17.0</td><td>192.168.6.148</td><td>Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Mobile Safari/537.36</td><td>/user/info</td><td>GET</td><td></td><td>5</td><td>0</td><td></td></tr></tbody></table><h3 id="EOF-异常控制台日志："><a href="#EOF-异常控制台日志：" class="headerlink" title="EOF 异常控制台日志："></a>EOF 异常控制台日志：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">feign.RetryableException: unexpected end of stream on Connection&#123;<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">4000</span>, proxy=DIRECT hostAddress=/<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">4000</span> cipherSuite=none protocol=http/<span class="number">1.1</span>&#125; executing GET http:<span class="comment">//gold-admin/syssite/getSiteById/1</span></span><br><span class="line">at feign.FeignException.errorExecuting(FeignException.java:<span class="number">132</span>)</span><br><span class="line">at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:<span class="number">113</span>)</span><br><span class="line">at feign.SynchronousMethodHandler.invoke(SynchronousMethodHandler.java:<span class="number">78</span>)</span><br><span class="line">at feign.hystrix.HystrixInvocationHandler$<span class="number">1</span>.run(HystrixInvocationHandler.java:<span class="number">109</span>)</span><br><span class="line">at com.netflix.hystrix.HystrixCommand$<span class="number">2</span>.call(HystrixCommand.java:<span class="number">302</span>)</span><br><span class="line">at com.netflix.hystrix.HystrixCommand$<span class="number">2</span>.call(HystrixCommand.java:<span class="number">298</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">46</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">35</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">51</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">35</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">51</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">35</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeMap.call(OnSubscribeMap.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeMap.call(OnSubscribeMap.java:<span class="number">33</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">41</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">51</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:<span class="number">35</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10423</span>)</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10390</span>)</span><br><span class="line">at rx.internal.operators.BlockingOperatorToFuture.toFuture(BlockingOperatorToFuture.java:<span class="number">51</span>)</span><br><span class="line">at rx.observables.BlockingObservable.toFuture(BlockingObservable.java:<span class="number">410</span>)</span><br><span class="line">at com.netflix.hystrix.HystrixCommand.queue(HystrixCommand.java:<span class="number">378</span>)</span><br><span class="line">at com.netflix.hystrix.HystrixCommand.execute(HystrixCommand.java:<span class="number">344</span>)</span><br><span class="line">at feign.hystrix.HystrixInvocationHandler.invoke(HystrixInvocationHandler.java:<span class="number">170</span>)</span><br><span class="line">at com.sun.proxy.$Proxy289.getSiteById(Unknown Source)</span><br><span class="line">at com.gdjs.gold.business.controller.BusinessPortalController.info(BusinessPortalController.java:<span class="number">58</span>)</span><br><span class="line">at com.gdjs.gold.business.controller.BusinessPortalController$$FastClassBySpringCGLIB$$<span class="number">66</span>c8c0df.invoke(&lt;generated&gt;)</span><br><span class="line">at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:<span class="number">218</span>)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:<span class="number">749</span>)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">163</span>)</span><br><span class="line">at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:<span class="number">93</span>)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="number">186</span>)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:<span class="number">688</span>)</span><br><span class="line">at com.gdjs.gold.business.controller.BusinessPortalController$$EnhancerBySpringCGLIB$$<span class="number">261</span>d70.info(&lt;generated&gt;)</span><br><span class="line">at sun.reflect.GeneratedMethodAccessor1225.invoke(Unknown Source)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:<span class="number">190</span>)</span><br><span class="line">at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:<span class="number">138</span>)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:<span class="number">104</span>)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:<span class="number">892</span>)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:<span class="number">797</span>)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:<span class="number">87</span>)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:<span class="number">1039</span>)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:<span class="number">942</span>)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:<span class="number">1005</span>)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:<span class="number">897</span>)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">645</span>)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:<span class="number">882</span>)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">750</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletHandler.handleRequest(ServletHandler.java:<span class="number">74</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">129</span>)</span><br><span class="line">at org.springframework.boot.actuate.web.trace.servlet.HttpTraceFilter.doFilterInternal(HttpTraceFilter.java:<span class="number">88</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">320</span>)</span><br><span class="line">at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:<span class="number">127</span>)</span><br><span class="line">at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:<span class="number">91</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:<span class="number">119</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:<span class="number">137</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:<span class="number">111</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:<span class="number">170</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:<span class="number">63</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationProcessingFilter.doFilter(OAuth2AuthenticationProcessingFilter.java:<span class="number">176</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:<span class="number">116</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.header.HeaderWriterFilter.doFilterInternal(HeaderWriterFilter.java:<span class="number">74</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:<span class="number">105</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter.doFilterInternal(WebAsyncManagerIntegrationFilter.java:<span class="number">56</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:<span class="number">334</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:<span class="number">215</span>)</span><br><span class="line">at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:<span class="number">178</span>)</span><br><span class="line">at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:<span class="number">357</span>)</span><br><span class="line">at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:<span class="number">270</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:<span class="number">99</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:<span class="number">92</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:<span class="number">93</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.cloud.sleuth.instrument.web.ExceptionLoggingFilter.doFilter(ExceptionLoggingFilter.java:<span class="number">50</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at brave.servlet.TracingFilter.doFilter(TracingFilter.java:<span class="number">99</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:<span class="number">114</span>)</span><br><span class="line">at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:<span class="number">104</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:<span class="number">200</span>)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:<span class="number">109</span>)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:<span class="number">61</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:<span class="number">131</span>)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler.handleRequest(FilterHandler.java:<span class="number">84</span>)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:<span class="number">62</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletChain$<span class="number">1</span>.handleRequest(ServletChain.java:<span class="number">68</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:<span class="number">36</span>)</span><br><span class="line">at io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:<span class="number">132</span>)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletAuthenticationCallHandler.handleRequest(ServletAuthenticationCallHandler.java:<span class="number">57</span>)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:<span class="number">43</span>)</span><br><span class="line">at io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:<span class="number">46</span>)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:<span class="number">64</span>)</span><br><span class="line">at io.undertow.security.handlers.AuthenticationMechanismsHandler.handleRequest(AuthenticationMechanismsHandler.java:<span class="number">60</span>)</span><br><span class="line">at io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:<span class="number">77</span>)</span><br><span class="line">at io.undertow.security.handlers.AbstractSecurityContextAssociationHandler.handleRequest(AbstractSecurityContextAssociationHandler.java:<span class="number">43</span>)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:<span class="number">43</span>)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:<span class="number">43</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:<span class="number">292</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.access$<span class="number">100</span>(ServletInitialHandler.java:<span class="number">81</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$<span class="number">2</span>.call(ServletInitialHandler.java:<span class="number">138</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$<span class="number">2</span>.call(ServletInitialHandler.java:<span class="number">135</span>)</span><br><span class="line">at io.undertow.servlet.core.ServletRequestContextThreadSetupAction$<span class="number">1</span>.call(ServletRequestContextThreadSetupAction.java:<span class="number">48</span>)</span><br><span class="line">at io.undertow.servlet.core.ContextClassLoaderSetupAction$<span class="number">1</span>.call(ContextClassLoaderSetupAction.java:<span class="number">43</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:<span class="number">272</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.access$<span class="number">000</span>(ServletInitialHandler.java:<span class="number">81</span>)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$<span class="number">1</span>.handleRequest(ServletInitialHandler.java:<span class="number">104</span>)</span><br><span class="line">at io.undertow.server.Connectors.executeRootHandler(Connectors.java:<span class="number">364</span>)</span><br><span class="line">at io.undertow.server.HttpServerExchange$<span class="number">1</span>.run(HttpServerExchange.java:<span class="number">830</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Caused by: java.io.IOException: unexpected end of stream on Connection&#123;<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">4000</span>, proxy=DIRECT hostAddress=/<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">4000</span> cipherSuite=none protocol=http/<span class="number">1.1</span>&#125;</span><br><span class="line">at okhttp3.internal.http1.Http1Codec.readResponseHeaders(Http1Codec.java:<span class="number">208</span>)</span><br><span class="line">at okhttp3.internal.http.CallServerInterceptor.intercept(CallServerInterceptor.java:<span class="number">88</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">147</span>)</span><br><span class="line">at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.java:<span class="number">45</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">147</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">121</span>)</span><br><span class="line">at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.java:<span class="number">93</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">147</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">121</span>)</span><br><span class="line">at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.java:<span class="number">93</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">147</span>)</span><br><span class="line">at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.java:<span class="number">126</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">147</span>)</span><br><span class="line">at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:<span class="number">121</span>)</span><br><span class="line">at okhttp3.RealCall.getResponseWithInterceptorChain(RealCall.java:<span class="number">200</span>)</span><br><span class="line">at okhttp3.RealCall.execute(RealCall.java:<span class="number">77</span>)</span><br><span class="line">at feign.okhttp.OkHttpClient.execute(OkHttpClient.java:<span class="number">167</span>)</span><br><span class="line">at org.springframework.cloud.sleuth.instrument.web.client.feign.TracingFeignClient.execute(TracingFeignClient.java:<span class="number">100</span>)</span><br><span class="line">at org.springframework.cloud.sleuth.instrument.web.client.feign.LazyTracingFeignClient.execute(LazyTracingFeignClient.java:<span class="number">60</span>)</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.FeignLoadBalancer.execute(FeignLoadBalancer.java:<span class="number">93</span>)</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.FeignLoadBalancer.execute(FeignLoadBalancer.java:<span class="number">56</span>)</span><br><span class="line">at com.netflix.client.AbstractLoadBalancerAwareClient$<span class="number">1</span>.call(AbstractLoadBalancerAwareClient.java:<span class="number">104</span>)</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">3</span>$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">303</span>)</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">3</span>$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">287</span>)</span><br><span class="line">at rx.internal.util.ScalarSynchronousObservable$<span class="number">3</span>.call(ScalarSynchronousObservable.java:<span class="number">231</span>)</span><br><span class="line">at rx.internal.util.ScalarSynchronousObservable$<span class="number">3</span>.call(ScalarSynchronousObservable.java:<span class="number">228</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.drain(OnSubscribeConcatMap.java:<span class="number">286</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap$ConcatMapSubscriber.onNext(OnSubscribeConcatMap.java:<span class="number">144</span>)</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">185</span>)</span><br><span class="line">at com.netflix.loadbalancer.reactive.LoadBalancerCommand$<span class="number">1</span>.call(LoadBalancerCommand.java:<span class="number">180</span>)</span><br><span class="line">at rx.Observable.unsafeSubscribe(Observable.java:<span class="number">10327</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:<span class="number">94</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeConcatMap.call(OnSubscribeConcatMap.java:<span class="number">42</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">48</span>)</span><br><span class="line">at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:<span class="number">30</span>)</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10423</span>)</span><br><span class="line">at rx.Observable.subscribe(Observable.java:<span class="number">10390</span>)</span><br><span class="line">at rx.observables.BlockingObservable.blockForSingle(BlockingObservable.java:<span class="number">443</span>)</span><br><span class="line">at rx.observables.BlockingObservable.single(BlockingObservable.java:<span class="number">340</span>)</span><br><span class="line">at com.netflix.client.AbstractLoadBalancerAwareClient.executeWithLoadBalancer(AbstractLoadBalancerAwareClient.java:<span class="number">112</span>)</span><br><span class="line">at org.springframework.cloud.openfeign.ribbon.LoadBalancerFeignClient.execute(LoadBalancerFeignClient.java:<span class="number">83</span>)</span><br><span class="line">at org.springframework.cloud.sleuth.instrument.web.client.feign.TraceLoadBalancerFeignClient.execute(TraceLoadBalancerFeignClient.java:<span class="number">71</span>)</span><br><span class="line">at feign.SynchronousMethodHandler.executeAndDecode(SynchronousMethodHandler.java:<span class="number">108</span>)</span><br><span class="line">... <span class="number">181</span> common frames omitted</span><br><span class="line">Caused by: java.io.EOFException: \n not found: limit=<span class="number">0</span> content=…</span><br><span class="line">at okio.RealBufferedSource.readUtf8LineStrict(RealBufferedSource.java:<span class="number">237</span>)</span><br><span class="line">at okhttp3.internal.http1.Http1Codec.readHeaderLine(Http1Codec.java:<span class="number">215</span>)</span><br><span class="line">at okhttp3.internal.http1.Http1Codec.readResponseHeaders(Http1Codec.java:<span class="number">189</span>)</span><br><span class="line">... <span class="number">226</span> common frames omitted</span><br></pre></td></tr></table></figure><h2 id="二、如何埋点这种概率性异常呢？"><a href="#二、如何埋点这种概率性异常呢？" class="headerlink" title="二、如何埋点这种概率性异常呢？"></a>二、如何埋点这种概率性异常呢？</h2><blockquote><p>Feign的Fallback机制可以进行日志埋点，由于长时间接触这个异常，发现规律都是因为登录后长时间不进行请求。下面就是埋点日志代码实现：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统日志工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> caochikai</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysLogUtils</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> SysLog <span class="title">getSysLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">HttpServletRequest request = ((ServletRequestAttributes) Objects</span><br><span class="line">.requireNonNull(RequestContextHolder.getRequestAttributes())).getRequest();</span><br><span class="line">SysLog sysLog = <span class="keyword">new</span> SysLog();</span><br><span class="line"><span class="comment">//需要记录请求详细信息，根据需要改变细节</span></span><br><span class="line">sysLog.setCreateBy(Objects.requireNonNull(getUsername()));</span><br><span class="line">sysLog.setType(CommonConstants.STATUS_NORMAL);</span><br><span class="line">sysLog.setRemoteAddr(ServletUtil.getClientIP(request));</span><br><span class="line">sysLog.setRequestUri(URLUtil.getPath(request.getRequestURI()));</span><br><span class="line">sysLog.setMethod(request.getMethod());</span><br><span class="line">sysLog.setUserAgent(request.getHeader(<span class="string">"user-agent"</span>));</span><br><span class="line">sysLog.setParams(HttpUtil.toParams(request.getParameterMap()));</span><br><span class="line">sysLog.setServiceId(getClientId());</span><br><span class="line"><span class="keyword">return</span> sysLog;</span><br><span class="line">&#125;</span><br><span class="line">....省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallMemberFeignFallbackImpl</span> <span class="keyword">implements</span> <span class="title">MallMemberFeign</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> Throwable cause;</span><br><span class="line"><span class="comment">//Long startTime参数只是为了暂时记录远程调用的开始时间，会去掉</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R&lt;MallMember&gt; <span class="title">getMemberByUserId</span><span class="params">(String userId, Long startTime)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"通过userId获取会员详情失败&#123;&#125;"</span>,userId, cause);</span><br><span class="line">        SysLog logVo = SysLogUtils.getSysLog();</span><br><span class="line">        logVo.setTitle(<span class="string">"feign接口获取会员信息失败"</span>);</span><br><span class="line">        <span class="comment">// 发送异步日志事件</span></span><br><span class="line">        Long endTime = System.currentTimeMillis();</span><br><span class="line">        logVo.setTime(endTime - startTime);</span><br><span class="line"><span class="comment">//发送SysLogEvent事件</span></span><br><span class="line">        SpringContextHolder.publishEvent(<span class="keyword">new</span> SysLogEvent(logVo));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> caochikai</span></span><br><span class="line"><span class="comment"> * 异步监听日志事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysLogListener</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RemoteLogService remoteLogService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="meta">@Order</span></span><br><span class="line"><span class="meta">@EventListener</span>(SysLogEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">void</span> <span class="title">saveSysLog</span>(<span class="title">SysLogEvent</span> <span class="title">event</span>) </span>&#123;</span><br><span class="line">SysLog sysLog = (SysLog) event.getSource();</span><br><span class="line">remoteLogService.saveLog(sysLog);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、Okhttp源码分析"><a href="#三、Okhttp源码分析" class="headerlink" title="三、Okhttp源码分析"></a>三、Okhttp源码分析</h2><blockquote><p>在进行常规的breakpoint之后, 需要重点关注OkHttpLoadBalancingClient、RetryAndFollowUpInterceptor、Http1Codec和RealBufferedSource。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">spring-cloud-netflix-ribbon-<span class="number">2.0</span><span class="number">.0</span>.RELEASE-sources.jar!/org/springframework/cloud/netflix/ribbon/okhttp/OkHttpLoadBalancingClient.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpLoadBalancingClient</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractLoadBalancingClient</span>&lt;<span class="title">OkHttpRibbonRequest</span>, <span class="title">OkHttpRibbonResponse</span>, <span class="title">OkHttpClient</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OkHttpRibbonResponse <span class="title">execute</span><span class="params">(OkHttpRibbonRequest ribbonRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">final</span> IClientConfig configOverride)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> secure = isSecure(configOverride);</span><br><span class="line">        <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">            <span class="keyword">final</span> URI secureUri = UriComponentsBuilder.fromUri(ribbonRequest.getUri())</span><br><span class="line">                    .scheme(<span class="string">"https"</span>).build().toUri();</span><br><span class="line">            ribbonRequest = ribbonRequest.withNewUri(secureUri);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//Feign实际调用client</span></span><br><span class="line">        OkHttpClient httpClient = getOkHttpClient(configOverride, secure);</span><br><span class="line">        <span class="keyword">final</span> Request request = ribbonRequest.toRequest();</span><br><span class="line">        Response response = httpClient.newCall(request).execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpRibbonResponse(response, ribbonRequest.getUri());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">OkHttpClient <span class="title">getOkHttpClient</span><span class="params">(IClientConfig configOverride, <span class="keyword">boolean</span> secure)</span> </span>&#123;</span><br><span class="line">        IClientConfig config = configOverride != <span class="keyword">null</span> ? configOverride : <span class="keyword">this</span>.config;</span><br><span class="line">        RibbonProperties ribbon = RibbonProperties.from(config);</span><br><span class="line"><span class="comment">//建造者模式构建http请求</span></span><br><span class="line">        OkHttpClient.Builder builder = <span class="keyword">this</span>.delegate.newBuilder()</span><br><span class="line">                .connectTimeout(ribbon.connectTimeout(<span class="keyword">this</span>.connectTimeout), TimeUnit.MILLISECONDS)</span><br><span class="line">                .readTimeout(ribbon.readTimeout(<span class="keyword">this</span>.readTimeout), TimeUnit.MILLISECONDS)</span><br><span class="line">                .followRedirects(ribbon.isFollowRedirects(<span class="keyword">this</span>.followRedirects));</span><br><span class="line">        <span class="keyword">if</span> (secure) &#123;</span><br><span class="line">            builder.followSslRedirects(ribbon.isFollowRedirects(<span class="keyword">this</span>.followRedirects));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryAndFollowUpInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//....</span></span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            response = realChain.proceed(request, streamAllocation, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException) &#123;</span><br><span class="line">           <span class="comment">// An attempt to communicate with a server failed. The request may have been sent.</span></span><br><span class="line">        <span class="keyword">boolean</span> requestSendStarted = !(e <span class="keyword">instanceof</span> ConnectionShutdownException);</span><br><span class="line">        <span class="comment">// 此处非常重要，若不允许恢复，直接将异常向上抛出（调用方接收）,反之 循环继续执行realChain.proceed()方法</span></span><br><span class="line">        <span class="keyword">if</span> (!recover(e, streamAllocation, requestSendStarted, request)) <span class="keyword">throw</span> e;</span><br><span class="line">        releaseConnection = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;  </span><br><span class="line">      &#125;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">recover</span><span class="params">(IOException e, StreamAllocation streamAllocation,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> requestSendStarted, Request userRequest)</span> </span>&#123;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// ....</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">// The application layer has forbidden retries.</span></span><br><span class="line">        <span class="comment">// 若客户端配置 retryOnConnectionFailure 为false 则表明不允许重试，直接将异常抛给调用方</span></span><br><span class="line">        <span class="keyword">if</span> (!client.retryOnConnectionFailure()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>当执行realChain.proceed() ，将事件继续分发给各个拦截器，最终执行到 Http1Codec#readResponseHeaders 方法。Http1Codec 用于Encode Http Request 以及 解析 Http Response的，用于获取头信息相关参数。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Http1Codec.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Http1Codec</span> <span class="keyword">implements</span> <span class="title">HttpCodec</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Response.<span class="function">Builder <span class="title">readResponseHeaders</span><span class="params">(<span class="keyword">boolean</span> expectContinue)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">          StatusLine statusLine = StatusLine.parse(readHeaderLine());</span><br><span class="line">          <span class="comment">//后续代码根据statusLine 构造Response</span></span><br><span class="line">       &#125; <span class="keyword">catch</span>(EOFException e) &#123;</span><br><span class="line">           <span class="comment">// 原来异常信息就是从这里抛出来的，接下来需要重点关注下readHeaderLine方法</span></span><br><span class="line">           <span class="comment">// Provide more context if the server ends the stream before sending a response.</span></span><br><span class="line">           IOException exception = <span class="keyword">new</span> IOException(<span class="string">"unexpected end of stream on "</span> + streamAllocation);</span><br><span class="line">           exception.initCause(e);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">readHeaderLine</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 继续查看RealBufferedSource#readUtf8LineStrict方法</span></span><br><span class="line">        String line = source.readUtf8LineStrict(headerLimit);</span><br><span class="line">        headerLimit -= line.length();</span><br><span class="line">        <span class="keyword">return</span> line;</span><br><span class="line">    &#125;    </span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RealBufferedSource.java</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RealBufferedSource</span> <span class="keyword">implements</span> <span class="title">BufferedSource</span> </span>&#123;</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">   <span class="comment">// 由于server端已经closed，故buffer == null 将EOF异常向上抛出</span></span><br><span class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">readUtf8LineStrict</span><span class="params">(<span class="keyword">long</span> limit)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (limit &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"limit &lt; 0: "</span> + limit);</span><br><span class="line">    <span class="keyword">long</span> scanLength = limit == Long.MAX_VALUE ? Long.MAX_VALUE : limit + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">long</span> newline = indexOf((<span class="keyword">byte</span>) <span class="string">'\n'</span>, <span class="number">0</span>, scanLength);</span><br><span class="line">    <span class="keyword">if</span> (newline != -<span class="number">1</span>) <span class="keyword">return</span> buffer.readUtf8Line(newline);</span><br><span class="line">    <span class="keyword">if</span> (scanLength &lt; Long.MAX_VALUE</span><br><span class="line">        &amp;&amp; request(scanLength) &amp;&amp; buffer.getByte(scanLength - <span class="number">1</span>) == <span class="string">'\r'</span></span><br><span class="line">        &amp;&amp; request(scanLength + <span class="number">1</span>) &amp;&amp; buffer.getByte(scanLength) == <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> buffer.readUtf8Line(scanLength); <span class="comment">// The line was 'limit' UTF-8 bytes followed by \r\n.</span></span><br><span class="line">    &#125;</span><br><span class="line">    Buffer data = <span class="keyword">new</span> Buffer();</span><br><span class="line">    buffer.copyTo(data, <span class="number">0</span>, Math.min(<span class="number">32</span>, buffer.size()));</span><br><span class="line"><span class="comment">//实际抛出异常的栈点</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> EOFException(<span class="string">"\\n not found: limit="</span> + Math.min(buffer.size(), limit)</span><br><span class="line">        + <span class="string">" content="</span> + data.readByteString().hex() + <span class="string">'…'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、解决办法"><a href="#四、解决办法" class="headerlink" title="四、解决办法"></a>四、解决办法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.common.core.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> okhttp3.ConnectionPool;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.X509TrustManager;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置 okhttp 与连接池</span></span><br><span class="line"><span class="comment"> * Date 2019/12/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OkHttpClient <span class="title">okHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line"><span class="comment">//解决重点在这里，发送异常允许重试请求</span></span><br><span class="line">                **.retryOnConnectionFailure(<span class="keyword">true</span>)**</span><br><span class="line">                .connectionPool(pool())</span><br><span class="line"><span class="comment">//设置连接超时</span></span><br><span class="line">                .connectTimeout(<span class="number">3000</span>, TimeUnit.SECONDS)</span><br><span class="line"><span class="comment">//设置读超时</span></span><br><span class="line">                .readTimeout(<span class="number">3000</span>, TimeUnit.SECONDS)</span><br><span class="line"><span class="comment">//设置写超时</span></span><br><span class="line">                .writeTimeout(<span class="number">3000</span>,TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> X509TrustManager <span class="title">x509TrustManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> X509TrustManager() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> X509Certificate[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SSLSocketFactory <span class="title">sslSocketFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//信任任何链接</span></span><br><span class="line">            SSLContext sslContext = SSLContext.getInstance(<span class="string">"TLS"</span>);</span><br><span class="line">            sslContext.init(<span class="keyword">null</span>, <span class="keyword">new</span> TrustManager[]&#123;x509TrustManager()&#125;, <span class="keyword">new</span> SecureRandom());</span><br><span class="line">            <span class="keyword">return</span> sslContext.getSocketFactory();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyManagementException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionPool <span class="title">pool</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//ConnectionPool 每个地址的最大空闲连接数200，保持5分钟长连接</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConnectionPool(<span class="number">200</span>, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h2><ol><li><a href="https://www.jianshu.com/p/6a306115334c?utm_campaign=hugo" target="_blank" rel="noopener">Spring Cloud Feign 总结问题，注意点，性能调优，切换okhttp3</a></li><li><a href="https://juejin.im/post/5b5efedef265da0f6825e235" target="_blank" rel="noopener">Spring cloud 超时及重试配置【ribbon及其它http client】</a></li><li>[记录某次解决`Okhttp java.io.EOFException: \n not found: size=0 content= unexpected end](<a href="https://juejin.im/post/5b5efedef265da0f6825e235" target="_blank" rel="noopener">https://juejin.im/post/5b5efedef265da0f6825e235</a>)</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Spring-Cloud-Feign连接池okhttp-EOF异常&quot;&gt;&lt;a href=&quot;#Spring-Cloud-Feign连接池okhttp-EOF异常&quot; class=&quot;headerlink&quot; title=&quot;Spring Cloud Feign连接池okhtt
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/categories/SpringCloud/"/>
    
    
      <category term="SpringCloud" scheme="https://caochikai.github.io/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>SpringCloud之Wesocket双向通信</title>
    <link href="https://caochikai.github.io/2020/05/12/SpringBoot%E4%B9%8BWesocket%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1/"/>
    <id>https://caochikai.github.io/2020/05/12/SpringBoot%E4%B9%8BWesocket%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1/</id>
    <published>2020-05-12T06:47:00.000Z</published>
    <updated>2020-05-23T10:58:50.950Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringCloud之Wesocket双向通信"><a href="#SpringCloud之Wesocket双向通信" class="headerlink" title="SpringCloud之Wesocket双向通信"></a>SpringCloud之Wesocket双向通信</h1><h2 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h2><blockquote><p>运营中台向某个商家或者全部平台发送实时消息通知，websocket在微服务gateway网关和Oauth2鉴权的环境下，会遇到网关转发Authorization:Bearer 鉴权失败。由于websocket协议在握手时候是不支持Oauth2在header放置token，那么就有两种解决办法，第一种在网关处添加GlobalFilter转发header并且暴露websocket，第二种直接暴露websocket放开鉴权，登录之后直接链接websocket；有了双向通信功能就可以取代轮询，比如PC扫码支付后通知前端支付结果，具体实现参考Github Demo仓库在文章结尾。</p></blockquote><h2 id="二、第一种解决办法"><a href="#二、第一种解决办法" class="headerlink" title="二、第一种解决办法"></a>二、第一种解决办法</h2><blockquote><p>Websocket握手协商报文如下，SockJS注意端点跨域：</p></blockquote><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="string">101 Switching Protocols</span></span><br><span class="line"><span class="attr">Upgrade</span>: <span class="string">websocket</span></span><br><span class="line"><span class="attr">Connection</span>: <span class="string">Upgrade</span></span><br><span class="line"><span class="meta">Sec-WebSocket-Accept</span>: <span class="string">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span></span><br><span class="line"><span class="meta">Sec-WebSocket-Protocol</span>: <span class="string">chat</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketHandler</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_FILTER_PATH = <span class="string">"/user-service/info"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange ServerWebExchange是一个HTTP请求-响应交互的契约。提供对HTTP请求和响应的访问，</span></span><br><span class="line"><span class="comment">     *                 并公开额外的 服务器 端处理相关属性和特性，如请求属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String upgrade = exchange.getRequest().getHeaders().getUpgrade();</span><br><span class="line"></span><br><span class="line">        URI requestUrl = exchange.getRequiredAttribute(GATEWAY_REQUEST_URL_ATTR);</span><br><span class="line"></span><br><span class="line">        String scheme = requestUrl.getScheme();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"websocket"</span>.equals(upgrade)) &#123;</span><br><span class="line">            String queryParam = requestUrl.getRawQuery();</span><br><span class="line">            Map&lt;String, String&gt; paramMap = HttpUtil.decodeParamMap(queryParam, CharsetUtil.UTF_8);</span><br><span class="line">            String token = paramMap.get(<span class="string">"token"</span>);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(token)) &#123;</span><br><span class="line">                <span class="comment">//向headers中放token，记得build</span></span><br><span class="line">                ServerHttpRequest host = exchange.getRequest().mutate().header(<span class="string">"Authorization"</span>, <span class="string">"Bearer "</span> + token).build();</span><br><span class="line">                <span class="comment">//将现在的request 变成 change对象</span></span><br><span class="line">                ServerWebExchange build = exchange.mutate().request(host).build();</span><br><span class="line">                <span class="keyword">return</span> chain.filter(build);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"ws"</span>.equals(scheme) &amp;&amp; !<span class="string">"wss"</span>.equals(scheme)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEFAULT_FILTER_PATH.equals(requestUrl.getPath())) &#123;</span><br><span class="line">            String wsScheme = convertWsToHttp(scheme);</span><br><span class="line">            URI wsRequestUrl = UriComponentsBuilder.fromUri(requestUrl).scheme(wsScheme).build().toUri();</span><br><span class="line">            exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, wsRequestUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE - <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">convertWsToHttp</span><span class="params">(String scheme)</span> </span>&#123;</span><br><span class="line">        scheme = scheme.toLowerCase();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ws"</span>.equals(scheme) ? <span class="string">"http"</span> : <span class="string">"wss"</span>.equals(scheme) ? <span class="string">"https"</span> : scheme;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title">HandshakeInterceptor</span> </span>&#123;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * websocket握手认证在registry.addEndpoint("/websocket")添加</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                ServletServerHttpRequest req = (ServletServerHttpRequest) request;</span><br><span class="line">                <span class="comment">//获取token认证</span></span><br><span class="line">                String token = req.getServletRequest().getParameter(<span class="string">"token"</span>);</span><br><span class="line">                <span class="comment">//解析token获取用户信息</span></span><br><span class="line">                Principal user = parseToken(token);</span><br><span class="line">                <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;   <span class="comment">//如果token认证失败user为null，返回false拒绝握手</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//保存认证用户</span></span><br><span class="line">                attributes.put(<span class="string">"user"</span>, user);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">             <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 根据token认证授权</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="function"><span class="keyword">private</span> Principal <span class="title">parseToken</span><span class="params">(String token)</span></span>&#123;</span><br><span class="line">                <span class="comment">//TODO 解析token并获取认证用户信息，建议通过feight接口</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、第二种SockJS直接连接"><a href="#三、第二种SockJS直接连接" class="headerlink" title="三、第二种SockJS直接连接"></a>三、第二种SockJS直接连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketMessageBrokerConfigurer</span> </span>&#123;</span><br><span class="line"><span class="comment">//注入跨域配置默认是*</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommonConfig commonConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*类似mq的Broker主题，通常按中台设计有几大平台就有几类主题</span></span><br><span class="line"><span class="comment">         * This enables a simple (in-memory) message broker for our application.</span></span><br><span class="line"><span class="comment">         * The `/topic` designates that any destination prefixed with `/topic`</span></span><br><span class="line"><span class="comment">         * will be routed back to the client.</span></span><br><span class="line"><span class="comment">         * It's important to keep in mind, this will not work with more than one</span></span><br><span class="line"><span class="comment">         * application instance, and it does not support all of the features a</span></span><br><span class="line"><span class="comment">         * full message broker like RabbitMQ, ActiveMQ, etc... provide.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registry.enableSimpleBroker(Arrays.stream(ThemeEnum.values()).map(ThemeEnum::getTheme).toArray(String[]::<span class="keyword">new</span>));</span><br><span class="line">        <span class="comment">/*客户端发送消息开头</span></span><br><span class="line"><span class="comment">         * The application destination prefix `/app` designates the broker to send</span></span><br><span class="line"><span class="comment">         * messages prefixed with `/app` to our `@MessageMapping`s.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registry.setApplicationDestinationPrefixes(<span class="string">"/app"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This configures a STOMP (Simple Text Oriented Messaging Protocol)</span></span><br><span class="line"><span class="comment">         * endpoint for our websocket to be hosted on</span></span><br><span class="line"><span class="comment">        &#125;)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registry.addEndpoint(<span class="string">"/websocket"</span>).setAllowedOrigins(commonConfig.getOrigins()).withSockJS();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This configures an endpoint with a fallback for SockJS in case the</span></span><br><span class="line"><span class="comment">         * client (an old browser) doesn't support WebSockets natively</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        registry.addEndpoint(<span class="string">"/sockjs"</span>).setAllowedOrigins(commonConfig.getOrigins()).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、网页端测试Demo"><a href="#四、网页端测试Demo" class="headerlink" title="四、网页端测试Demo"></a>四、网页端测试Demo</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        body &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f5f5f5</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-id">#main-content</span> &#123;</span></span><br><span class="line">            max-width: 940px;</span><br><span class="line">            padding: 2em 3em;</span><br><span class="line">            margin: 0 auto 20px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#e5e5e5</span>;</span></span><br><span class="line">            -webkit-border-radius: 5px;</span><br><span class="line">            -moz-border-radius: 5px;</span><br><span class="line">            border-radius: 5px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.from</span> &#123;</span></span><br><span class="line">            width: 120px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.timeStamp</span> &#123;</span></span><br><span class="line">            width: 220px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> stompClient = <span class="literal">null</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//根据需要是否进行websocket配合oauth2进行鉴权</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> token = <span class="string">"754741bc-08c1-4433-ab05-c803c589b58f"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">setConnected</span><span class="params">(connected)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#connect"</span>).prop(<span class="string">"disabled"</span>, connected);</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#connectSockJS"</span>).prop(<span class="string">"disabled"</span>, connected);</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#disconnect"</span>).prop(<span class="string">"disabled"</span>, !connected);</span></span><br><span class="line">            if (connected) &#123;</span><br><span class="line"><span class="javascript">                $(<span class="string">"#responses"</span>).show();</span></span><br><span class="line"><span class="actionscript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                $(<span class="string">"#responses"</span>).hide();</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            $(<span class="string">"#messages"</span>).html(<span class="string">""</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">frameHandler</span><span class="params">(frame)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            setConnected(<span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'Connected: '</span> + frame);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">//SockJS订阅不同的主题，类似mq的消息队列模式</span></span></span><br><span class="line"><span class="actionscript">            stompClient.subscribe(<span class="string">'/topic'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> </span>&#123;</span></span><br><span class="line">                showMessage(message.body);</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            stompClient.subscribe(<span class="string">'/business'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> </span>&#123;</span></span><br><span class="line">                showMessage(message.body);</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            stompClient.subscribe(<span class="string">'/business/11'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> </span>&#123;</span></span><br><span class="line">                showMessage(message.body);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">onSocketClose</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (stompClient !== <span class="literal">null</span>) &#123;</span></span><br><span class="line">                stompClient.deactivate();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="actionscript">            setConnected(<span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"Socket was closed. Setting connected to false!"</span>)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            stompClient = <span class="keyword">new</span> <span class="built_in">window</span>.StompJs.Client(&#123;</span></span><br><span class="line"><span class="actionscript">                webSocketFactory: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span> <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:9999/common/websocket"</span>);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            stompClient.onConnect = <span class="function"><span class="keyword">function</span> <span class="params">(frame)</span> </span>&#123;</span></span><br><span class="line">                frameHandler(frame)</span><br><span class="line">            &#125;;</span><br><span class="line"><span class="actionscript">            stompClient.onWebsocketClose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line">                onSocketClose();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            stompClient.activate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">connectSockJs</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            stompClient = <span class="keyword">new</span> <span class="built_in">window</span>.StompJs.Client(&#123;</span></span><br><span class="line"><span class="actionscript">                webSocketFactory: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">window</span>.SockJS(<span class="string">"http://127.0.0.1:9999/common/sockjs"</span>);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            stompClient.onConnect = <span class="function"><span class="keyword">function</span> <span class="params">(frame)</span> </span>&#123;</span></span><br><span class="line">                frameHandler(frame)</span><br><span class="line">            &#125;;</span><br><span class="line"><span class="actionscript">            stompClient.onWebsocketClose = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line">                onSocketClose();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            stompClient.activate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (stompClient !== <span class="literal">null</span>) &#123;</span></span><br><span class="line">                stompClient.deactivate();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="actionscript">            setConnected(<span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"Disconnected"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line">            stompClient.publish(&#123;</span><br><span class="line"><span class="actionscript">                destination: <span class="string">"/app/send"</span>,</span></span><br><span class="line"><span class="javascript">                body: <span class="built_in">JSON</span>.stringify(&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="string">'from'</span>: $(<span class="string">"#from"</span>).val(),</span></span><br><span class="line"><span class="javascript">                    <span class="string">'message'</span>: $(<span class="string">"#message"</span>).val()</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">(message)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> msg = <span class="built_in">JSON</span>.parse(message);</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#responses"</span>).prepend(<span class="string">"&lt;tr&gt;"</span> +</span></span><br><span class="line"><span class="actionscript">                <span class="string">"&lt;td class='timeStamp'&gt;"</span> + msg[<span class="string">'timeStamp'</span>] + <span class="string">"&lt;/td&gt;"</span> +</span></span><br><span class="line"><span class="actionscript">                <span class="string">"&lt;td class='from'&gt;"</span> + msg[<span class="string">'from'</span>] + <span class="string">"&lt;/td&gt;"</span> +</span></span><br><span class="line"><span class="actionscript">                <span class="string">"&lt;td&gt;"</span> + msg[<span class="string">'message'</span>] + <span class="string">"&lt;/td&gt;"</span> +</span></span><br><span class="line"><span class="actionscript">                <span class="string">"&lt;/tr&gt;"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"form"</span>).on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line">                e.preventDefault();</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="javascript">            $(<span class="string">"#connect"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">                connect();</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="javascript">            $(<span class="string">"#connectSockJS"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">                connectSockJs();</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="javascript">            $(<span class="string">"#disconnect"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">                disconnect();</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="javascript">            $(<span class="string">"#send"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">                sendMessage();</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="javascript">            $(<span class="string">"document"</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">                disconnect();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span> <span class="attr">style</span>=<span class="string">"color: #ff0000"</span>&gt;</span>Seems your browser doesn't support Javascript! Websocket relies on Javascript being</span><br><span class="line">    enabled. Please enable</span><br><span class="line">    Javascript and reload this page!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main-content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-10"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-inline"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"connect"</span>&gt;</span>WebSocket connection:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">id</span>=<span class="string">"connect"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">id</span>=<span class="string">"connectSockJS"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>ConnectSockJS<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-2"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-inline"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">disabled</span>=<span class="string">"disabled"</span> <span class="attr">id</span>=<span class="string">"disconnect"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">                        Disconnect</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-inline"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"from"</span>&gt;</span>Username:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"from"</span> <span class="attr">placeholder</span>=<span class="string">"Username..."</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"message"</span>&gt;</span>Message:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">placeholder</span>=<span class="string">"Your message here..."</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> <span class="attr">id</span>=<span class="string">"send"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table table-striped"</span> <span class="attr">id</span>=<span class="string">"responses"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">th</span>&gt;</span>Messages<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tbody</span> <span class="attr">id</span>=<span class="string">"messages"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="五、参考Demo和资料"><a href="#五、参考Demo和资料" class="headerlink" title="五、参考Demo和资料"></a>五、参考Demo和资料</h2><ol><li><a href="https://github.com/jmlw/demo-projects" target="_blank" rel="noopener">https://github.com/jmlw/demo-projects</a></li><li><a href="https://blog.joshmlwood.com/websockets-with-spring-boot/" target="_blank" rel="noopener">https://blog.joshmlwood.com/websockets-with-spring-boot/</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringCloud之Wesocket双向通信&quot;&gt;&lt;a href=&quot;#SpringCloud之Wesocket双向通信&quot; class=&quot;headerlink&quot; title=&quot;SpringCloud之Wesocket双向通信&quot;&gt;&lt;/a&gt;SpringCloud之We
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot之Redis定时发送消息</title>
    <link href="https://caochikai.github.io/2020/05/09/SpringBoot%E4%B9%8BRedis%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/"/>
    <id>https://caochikai.github.io/2020/05/09/SpringBoot%E4%B9%8BRedis%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/</id>
    <published>2020-05-09T03:26:00.000Z</published>
    <updated>2020-05-09T03:28:40.720Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SpringBoot之Redis定时发送消息"><a href="#SpringBoot之Redis定时发送消息" class="headerlink" title="SpringBoot之Redis定时发送消息"></a>SpringBoot之Redis定时发送消息</h1><h2 id="一、需求"><a href="#一、需求" class="headerlink" title="一、需求"></a>一、需求</h2><blockquote><p>实时发送定时公告，倒计时功能通过监听Redis 缓存过期（Key 失效）事件。类似用途可以用于订单定时关闭，商品或活动上下架。</p></blockquote><h2 id="二、修改-redis-conf-文件，打开-notify-keyspace-events-Ex-的注释，开启过期通知功能"><a href="#二、修改-redis-conf-文件，打开-notify-keyspace-events-Ex-的注释，开启过期通知功能" class="headerlink" title="二、修改 redis.conf 文件，打开 notify-keyspace-events Ex 的注释，开启过期通知功能"></a>二、修改 redis.conf 文件，打开 notify-keyspace-events Ex 的注释，开启过期通知功能</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################# EVENT NOTIFICATION ##############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis can notify Pub/Sub clients about events happening in the key space.</span></span><br><span class="line"><span class="comment"># This feature is documented at http://redis.io/topics/notifications</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For instance if keyspace events notification is enabled, and a client</span></span><br><span class="line"><span class="comment"># performs a DEL operation on key "foo" stored in the Database 0, two</span></span><br><span class="line"><span class="comment"># messages will be published via Pub/Sub:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># PUBLISH __keyspace@0__:foo del</span></span><br><span class="line"><span class="comment"># PUBLISH __keyevent@0__:del foo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is possible to select the events that Redis will notify among a set</span></span><br><span class="line"><span class="comment"># of classes. Every class is identified by a single character:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="comment">#  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="comment">#  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</span></span><br><span class="line"><span class="comment">#  $     String commands</span></span><br><span class="line"><span class="comment">#  l     List commands</span></span><br><span class="line"><span class="comment">#  s     Set commands</span></span><br><span class="line"><span class="comment">#  h     Hash commands</span></span><br><span class="line"><span class="comment">#  z     Sorted set commands</span></span><br><span class="line"><span class="comment">#  x     Expired events (events generated every time a key expires)</span></span><br><span class="line"><span class="comment">#  e     Evicted events (events generated when a key is evicted for maxmemory)</span></span><br><span class="line"><span class="comment">#  A     Alias for g$lshzxe, so that the "AKE" string means all the events.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  The "notify-keyspace-events" takes as argument a string that is composed</span></span><br><span class="line"><span class="comment">#  of zero or multiple characters. The empty string means that notifications</span></span><br><span class="line"><span class="comment">#  are disabled.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Example: to enable list and generic events, from the point of view of the</span></span><br><span class="line"><span class="comment">#           event name, use:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  notify-keyspace-events Elg</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Example 2: to get the stream of the expired keys subscribing to channel</span></span><br><span class="line"><span class="comment">#             name __keyevent@0__:expired use:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  notify-keyspace-events Ex</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  By default all notifications are disabled because most users don't need</span></span><br><span class="line"><span class="comment">#  this feature and the feature has some overhead. Note that if you don't</span></span><br><span class="line"><span class="comment">#  specify at least one of K or E, no events will be delivered.</span></span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br></pre></td></tr></table></figure><h2 id="三、重启redis-测试监听事件是否开启"><a href="#三、重启redis-测试监听事件是否开启" class="headerlink" title="三、重启redis ,测试监听事件是否开启"></a>三、重启redis ,测试监听事件是否开启</h2><blockquote><p><strong>keyevent@*</strong>:expired其实是<em>指所有库，可以指定库下标监听16个默认数据库的某一个，比如*</em>keyevent@1指定壹号<strong>库。打开</strong>redisclientA**，PSUBSCRIBE指令订阅事件。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PSUBSCRIBE __keyevent@*__:expired</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">"psubscribe"</span></span><br><span class="line">2) <span class="string">"__keyevent@*__:expired"</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><blockquote><p>再开启另一个<strong>redisclientB</strong>，发送过期数据指定事件2秒。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setex <span class="built_in">test</span> 2 2</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><blockquote><p>redisclientA就会监听到redisclientB过期key</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PSUBSCRIBE __keyevent@*__:expired</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">"psubscribe"</span></span><br><span class="line">2) <span class="string">"__keyevent@*__:expired"</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line">1) <span class="string">"pmessage"</span></span><br><span class="line">2) <span class="string">"__keyevent@*__:expired"</span></span><br><span class="line">3) <span class="string">"__keyevent@0__:expired"</span></span><br><span class="line">4) <span class="string">"test"</span></span><br></pre></td></tr></table></figure><h2 id="四、监听器配置和实现"><a href="#四、监听器配置和实现" class="headerlink" title="四、监听器配置和实现"></a>四、监听器配置和实现</h2><blockquote><p>KeyExpirationEvent1MessageListener可参考org.springframework.data.redis.listener.KeyExpirationEventMessageListener源码实现的（默认订阅的是<strong>keyevent@*</strong>:expired），而我们目标是监听壹号库。因为0号库给限流和oauth2用了，里面存在很多短期key，会监听许多不相干的业务key缓存。此外，不能给KeyExpirationEvent1MessageListener加上@Component，因为存在bean循环依赖问题，可以通过SpringContextHolder解决。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyExpirationEvent1MessageListener</span> <span class="keyword">extends</span> <span class="title">KeyExpirationEventMessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Topic KEYEVENT1_EXPIRED_TOPIC = <span class="keyword">new</span> PatternTopic(<span class="string">"__keyevent@1__:expired"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listenerContainer must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KeyExpirationEvent1MessageListener</span><span class="params">(RedisMessageListenerContainer listenerContainer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(listenerContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(RedisMessageListenerContainer listenerContainer)</span> </span>&#123;</span><br><span class="line">        listenerContainer.addMessageListener(<span class="keyword">this</span>, KEYEVENT1_EXPIRED_TOPIC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message, <span class="keyword">byte</span>[] pattern)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取过期的key</span></span><br><span class="line">        String expireKey = message.toString();</span><br><span class="line">        <span class="comment">//设置监听频道</span></span><br><span class="line">        <span class="keyword">if</span> (expireKey.startsWith(RedisConstant.NOTIFY_RECEIVE)) &#123;</span><br><span class="line">            log.info(<span class="string">"过期的键值对的消息ID:"</span> + expireKey);</span><br><span class="line">            log.info(<span class="string">"消息监听频道topic:"</span> + <span class="keyword">new</span> String(message.getChannel()));</span><br><span class="line"><span class="comment">//获取消息发送id，通过</span></span><br><span class="line">            String sendId = expireKey.substring(RedisConstant.NOTIFY_RECEIVE.length());</span><br><span class="line">            SysNotifySendService sysNotifySendService =  SpringContextHolder.getBean(SysNotifySendService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//common服务提供websocket发送远程接口RemoteCommonService</span></span><br><span class="line">            RemoteCommonService remoteCommonService =  SpringContextHolder.getBean(RemoteCommonService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            SysNotifyReceiveService receiveService =  SpringContextHolder.getBean(SysNotifyReceiveService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            SysNotifySend sysNotifySend = sysNotifySendService.getOne(Wrappers.&lt;SysNotifySend&gt;lambdaQuery().eq(SysNotifySend::getSendId, sendId));</span><br><span class="line">            com.gdjs.gold.admin.api.dto.Message websocketMsg = <span class="keyword">new</span> com.gdjs.gold.admin.api.dto.Message();</span><br><span class="line">            websocketMsg.setSendId(sysNotifySend.getSendId());</span><br><span class="line">            websocketMsg.setFrom(sysNotifySend.getSendUserId());</span><br><span class="line">            websocketMsg.setDestination(ThemeEnum.BUSINESS.getTheme());</span><br><span class="line">            websocketMsg.setMessage(sysNotifySend.getContent());</span><br><span class="line">            remoteCommonService.sendMessage(websocketMsg);     </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisListenerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">container</span><span class="params">(RedisConnectionFactory connectionFactory, ApplicationContext context)</span> </span>&#123;</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(connectionFactory);</span><br><span class="line"><span class="comment">//通过new监听器，并且往RedisMessageListenerContainer注册监听器</span></span><br><span class="line">        KeyExpirationEvent1MessageListener listener = <span class="keyword">new</span> KeyExpirationEvent1MessageListener(container);</span><br><span class="line">        listener.doRegister(container);</span><br><span class="line">        listener.setApplicationEventPublisher(context);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="五、发送时候如何自定义切换指定redis库下标"><a href="#五、发送时候如何自定义切换指定redis库下标" class="headerlink" title="五、发送时候如何自定义切换指定redis库下标"></a>五、发送时候如何自定义切换指定redis库下标</h2><h3 id="SpringBoot-1-X之前的版本"><a href="#SpringBoot-1-X之前的版本" class="headerlink" title="SpringBoot 1.X之前的版本"></a>SpringBoot 1.X之前的版本</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JedisConnectionFactory jedisConnectionFactory = (JedisConnectionFactory) stringRedisTemplate.getConnectionFactory();</span><br><span class="line">jedisConnectionFactory.setDatabase(切换到指定的db上);</span><br><span class="line">stringRedisTemplate.setConnectionFactory(jedisConnectionFactory);</span><br></pre></td></tr></table></figure><blockquote><p>SpringBoot 2.X之后的版本，RedisConnectionFactory动态切换库必须是LettuceConnectionFactory，必须是配置RedisTemplate时候指定，下面看源码。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切换redis数据库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisTemplate springboot封装的redis对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index         数据库下标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(RedisTemplate redisTemplate, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        LettuceConnectionFactory lettuceConnectionFactory = (LettuceConnectionFactory) redisTemplate.getConnectionFactory();</span><br><span class="line">        <span class="keyword">if</span> (lettuceConnectionFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            lettuceConnectionFactory.setDatabase(index);</span><br><span class="line">            redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">            lettuceConnectionFactory.resetConnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> caochikai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/7/12</span></span><br><span class="line"><span class="comment"> * Redis 配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(RedisAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RedisTemplateConfig</span> </span>&#123;</span><br><span class="line"><span class="comment">//@AllArgsConstructor是构造器注入进来LettuceConnectionFactory</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LettuceConnectionFactory lcfactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// 关闭共享链接，动态切换的重点在这里</span></span><br><span class="line">**lcfactory.setShareNativeConnection(<span class="keyword">false</span>);**</span><br><span class="line">RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">redisTemplate.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">redisTemplate.setValueSerializer(<span class="keyword">new</span> JdkSerializationRedisSerializer());</span><br><span class="line">redisTemplate.setHashValueSerializer(<span class="keyword">new</span> JdkSerializationRedisSerializer());</span><br><span class="line">redisTemplate.setConnectionFactory(lcfactory);</span><br><span class="line"><span class="keyword">return</span> redisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HashOperations&lt;String, String, Object&gt; <span class="title">hashOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> redisTemplate.opsForHash();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ValueOperations&lt;String, String&gt; <span class="title">valueOperations</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> redisTemplate.opsForValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ListOperations&lt;String, Object&gt; <span class="title">listOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> redisTemplate.opsForList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SetOperations&lt;String, Object&gt; <span class="title">setOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> redisTemplate.opsForSet();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ZSetOperations&lt;String, Object&gt; <span class="title">zSetOperations</span><span class="params">(RedisTemplate&lt;String, Object&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> redisTemplate.opsForZSet();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="六、设置缓存时候技巧"><a href="#六、设置缓存时候技巧" class="headerlink" title="六、设置缓存时候技巧"></a>六、设置缓存时候技巧</h2><blockquote><p>key需要指定key命名规则前缀RedisConstant.NOTIFY_RECEIVE常量（通常取表名），随后加上表的主键。时间计算间距小技巧，博主业务使用的是LocalDateTime，Duration.between(LocalDateTime.now(), 指定发送时间).getSeconds()，过期时间单位使用的是TimeUnit枚举。切换到指定一号库后，记得切换回来零号库，减少对其他业务的影响</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis缓存过期监听</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sysNotifySend 定时发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">redisSetMsgKey</span><span class="params">(SysNotifySend sysNotifySend, Message message)</span> </span>&#123;</span><br><span class="line">        LocalDateTime sendTime = sysNotifySend.getSendTime();</span><br><span class="line">        String jsonString = JSONUtil.parseObj(message).toJSONString(<span class="number">0</span>);</span><br><span class="line">        RedisUtil.select(redisTemplate, <span class="number">1</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(RedisConstant.NOTIFY_RECEIVE + sysNotifySend.getSendId(), jsonString, Duration.between(LocalDateTime.now(), sendTime).getSeconds(), TimeUnit.SECONDS);</span><br><span class="line">        RedisUtil.select(redisTemplate, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="七、参考文章如下"><a href="#七、参考文章如下" class="headerlink" title="七、参考文章如下:"></a>七、参考文章如下:</h2><ol><li><a href="https://www.jianshu.com/p/efdd21d71a44" target="_blank" rel="noopener">SpringBoot2.0以上整合redis根据下标动态切换数据库</a></li><li><a href="https://blog.csdn.net/weixin_41497481/article/details/85322794" target="_blank" rel="noopener">redis缓存过期策略，监听redis缓存</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;SpringBoot之Redis定时发送消息&quot;&gt;&lt;a href=&quot;#SpringBoot之Redis定时发送消息&quot; class=&quot;headerlink&quot; title=&quot;SpringBoot之Redis定时发送消息&quot;&gt;&lt;/a&gt;SpringBoot之Redis定时发送
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Thread分析</title>
    <link href="https://caochikai.github.io/2020/03/24/Thread%E5%88%86%E6%9E%90/"/>
    <id>https://caochikai.github.io/2020/03/24/Thread%E5%88%86%E6%9E%90/</id>
    <published>2020-03-24T10:38:39.000Z</published>
    <updated>2020-03-24T10:38:42.962Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Thread分析"><a href="#Thread分析" class="headerlink" title="Thread分析"></a>Thread分析</h1><h2 id="一、多线程实现方式"><a href="#一、多线程实现方式" class="headerlink" title="一、多线程实现方式"></a>一、多线程实现方式</h2><ul><li>继承Thread</li><li>实现Runable</li><li>使用FutureTask</li><li>使用Executor框架</li></ul><h2 id="二、Thread-start方法源代码分析"><a href="#二、Thread-start方法源代码分析" class="headerlink" title="二、Thread start方法源代码分析"></a>二、Thread start方法源代码分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****start方法调用了start0方法，start0方法在JVM中，start0中的逻辑会调用run方法**。</span></span><br><span class="line"><span class="comment">***一旦线程开始执行，jvm就会调用run方法；**</span></span><br><span class="line"><span class="comment"> ***线程只能启动一次，结束后无法重启。**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span>  IllegalThreadStateException  if the thread was already</span></span><br><span class="line"><span class="comment">     *               started.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>        #run()</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>        #stop()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 0代表线程状态为NEW</span></span><br><span class="line"><span class="comment">         * A zero status value corresponds to state "NEW".</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 通知组该线程即将开始将其添加到组的线程列表*中，并且该组的未启动计数可以减少。/</span></span><br><span class="line"><span class="comment">        group.add(this);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        boolean started = false;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            start0();</span></span><br><span class="line"><span class="comment">            started = true;</span></span><br><span class="line"><span class="comment">        &#125; finally &#123;</span></span><br><span class="line"><span class="comment">            try &#123;</span></span><br><span class="line"><span class="comment">                if (!started) &#123;</span></span><br><span class="line"><span class="comment">//如果创建失败，线程数组将会删除该线程，未启动计数增加，具体看源码</span></span><br><span class="line"><span class="comment">                    group.threadStartFailed(this);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125; catch (Throwable ignore) &#123;</span></span><br><span class="line"><span class="comment">                /* 什么都不用做，直接被上层堆栈回调 */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//start0是一个native方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><h2 id="三、线程状态分析-6种"><a href="#三、线程状态分析-6种" class="headerlink" title="三、线程状态分析(6种)"></a>三、线程状态分析(6种)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**在同一时间只有一种状态，只能反映JVM状态却不能反映出系统状态。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span>   1.5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #getState</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</span><br><span class="line">        <span class="comment">/****线程还未开始，刚刚新建。**</span></span><br><span class="line"><span class="comment">         * Thread state for a thread which has not yet started.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        NEW,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/****可运行状态，正在Java虚拟机中执行，但可能正在等待来自操作系统的其他资源，例如处理器。**</span></span><br><span class="line"><span class="comment">         * Thread state for a runnable thread.  A thread in the runnable</span></span><br><span class="line"><span class="comment">         * state is executing in the Java virtual machine but it may</span></span><br><span class="line"><span class="comment">         * be waiting for other resources from the operating system</span></span><br><span class="line"><span class="comment">         * such as processor.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        RUNNABLE,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/****阻塞状态。等待锁资源进入同步代码块。**</span></span><br><span class="line"><span class="comment">         * Thread state for a thread blocked waiting for a monitor lock.</span></span><br><span class="line"><span class="comment">         * A thread in the blocked state is waiting for a monitor lock</span></span><br><span class="line"><span class="comment">         * to enter a synchronized block/method or</span></span><br><span class="line"><span class="comment">         * reenter a synchronized block/method after calling</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@link</span> Object#wait() Object.wait&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        BLOCKED,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/****等待状态。可能因为如下方法进入该状态：**</span></span><br><span class="line"><span class="comment">         * Thread state for a waiting thread.</span></span><br><span class="line"><span class="comment">         * A thread is in the waiting state due to calling one of the</span></span><br><span class="line"><span class="comment">         * following methods:</span></span><br><span class="line"><span class="comment">         * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> Object#wait() Object.wait&#125; with no timeout&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> #join() Thread.join&#125; with no timeout&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> LockSupport#park() LockSupport.park&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">         *下面例子很形象</span></span><br><span class="line"><span class="comment">         * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt;</span></span><br><span class="line"><span class="comment">         * on an object is waiting for another thread to call</span></span><br><span class="line"><span class="comment">         * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on</span></span><br><span class="line"><span class="comment">         * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;</span></span><br><span class="line"><span class="comment">         * is waiting for a specified thread to terminate.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        WAITING,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/****等待一定的时间状态。可能因为如下方法进入该状态：**</span></span><br><span class="line"><span class="comment">         * Thread state for a waiting thread with a specified waiting time.</span></span><br><span class="line"><span class="comment">         * A thread is in the timed waiting state due to calling one of</span></span><br><span class="line"><span class="comment">         * the following methods with a specified positive waiting time:</span></span><br><span class="line"><span class="comment">         * &lt;ul&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> #sleep Thread.sleep&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> Object#wait(long) Object.wait&#125; with timeout&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> #join(long) Thread.join&#125; with timeout&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> LockSupport#parkNanos LockSupport.parkNanos&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         *   &lt;li&gt;&#123;<span class="doctag">@link</span> LockSupport#parkUntil LockSupport.parkUntil&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">         * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TIMED_WAITING,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/****结束状态。**</span></span><br><span class="line"><span class="comment">         * Thread state for a terminated thread.</span></span><br><span class="line"><span class="comment">         * The thread has completed execution.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TERMINATED;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="四、最后Thread-Run方法分析-模版方法模式"><a href="#四、最后Thread-Run方法分析-模版方法模式" class="headerlink" title="四、最后Thread Run方法分析(模版方法模式)"></a>四、最后Thread Run方法分析(模版方法模式)</h2><blockquote><p>Runnable的实现对象通过构造函数传入Thread。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target)</span> </span>&#123;</span><br><span class="line">    init(<span class="keyword">null</span>, target, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Runnable实现作为target对象传递进来。再次调用了init方法。Thread的target被设置为你实现业务逻辑的Runnable实现。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> inheritThreadLocals)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">...省略其他过程</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>当你传入了target，则会执行target的run方法。</p></blockquote><pre><code>@Overridepublic void run() {    if (target != null) {        target.run();    }}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Thread分析&quot;&gt;&lt;a href=&quot;#Thread分析&quot; class=&quot;headerlink&quot; title=&quot;Thread分析&quot;&gt;&lt;/a&gt;Thread分析&lt;/h1&gt;&lt;h2 id=&quot;一、多线程实现方式&quot;&gt;&lt;a href=&quot;#一、多线程实现方式&quot; class=&quot;he
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>数据结构之稀疏数组</title>
    <link href="https://caochikai.github.io/2020/03/21/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E7%A8%80%E7%96%8F%E6%95%B0%E7%BB%84/"/>
    <id>https://caochikai.github.io/2020/03/21/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8B%E7%A8%80%E7%96%8F%E6%95%B0%E7%BB%84/</id>
    <published>2020-03-21T08:48:00.000Z</published>
    <updated>2020-03-21T08:50:06.732Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数据结构之稀疏数组"><a href="#数据结构之稀疏数组" class="headerlink" title="数据结构之稀疏数组"></a>数据结构之稀疏数组</h1><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><blockquote><p>稀疏数组可以简单的看作为是压缩，在开发中也会使用到。比如将数据序列化到磁盘上，减少数据量，在IO过程中提高效率等等。</p></blockquote><h2 id="二、压缩和恢复——稀疏数组"><a href="#二、压缩和恢复——稀疏数组" class="headerlink" title="二、压缩和恢复——稀疏数组"></a>二、压缩和恢复——稀疏数组</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 稀疏数组 ---&gt; 数组中有很多无效数据，压缩数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: Caochikai</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparseArrayMy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先初始化11 X 11 的二维数组代表棋盘，转化为稀疏数组的思路：</span></span><br><span class="line"><span class="comment">     * 1、先遍历二维数组 得到非0数据的有效个数sum</span></span><br><span class="line"><span class="comment">     * 2、根据sum有效个数创建对应的稀疏数组int[sum+1][3]</span></span><br><span class="line"><span class="comment">     * 3、一次读取有效A的位置x，y和值，存进稀疏数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个原始的二维数组 11 * 11</span></span><br><span class="line">        <span class="comment">// 0: 表示没有棋子， 1 表示 黑子 2 表蓝子</span></span><br><span class="line">        <span class="keyword">int</span> chessArr1[][] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">11</span>][<span class="number">11</span>];</span><br><span class="line">        chessArr1[<span class="number">1</span>][<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">        chessArr1[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">2</span>;</span><br><span class="line">        chessArr1[<span class="number">4</span>][<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 输出原始的二维数组</span></span><br><span class="line">        System.out.println(<span class="string">"原始的二维数组~~"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] row : chessArr1) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> data : row) &#123;</span><br><span class="line">                System.out.printf(<span class="string">"%d\t"</span>, data);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、先遍历二维数组 得到非0数据的有效个数sum</span></span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">11</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (chessArr1[i][j] != <span class="number">0</span>) &#123;</span><br><span class="line">                    sum++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"二维数组的有效个数sum = "</span> + sum);</span><br><span class="line">        <span class="comment">//2、根据sum有效个数创建对应的稀疏数组int[sum+1][3]</span></span><br><span class="line">        <span class="keyword">int</span> sparseArr[][] = <span class="keyword">new</span> <span class="keyword">int</span>[sum + <span class="number">1</span>][<span class="number">3</span>];</span><br><span class="line">        <span class="comment">//第一行按稀疏数组定义记录总行数、总列数、个数总数</span></span><br><span class="line">        sparseArr[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">11</span>;</span><br><span class="line">        sparseArr[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">11</span>;</span><br><span class="line">        sparseArr[<span class="number">0</span>][<span class="number">2</span>] = sum;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、一次读取有效A的位置x，y和值，存进稀疏数组</span></span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">11</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (chessArr1[i][j] != <span class="number">0</span>) &#123;</span><br><span class="line">                    index++;</span><br><span class="line">                    sparseArr[index][<span class="number">0</span>] = i;</span><br><span class="line">                    sparseArr[index][<span class="number">1</span>] = j;</span><br><span class="line">                    sparseArr[index][<span class="number">2</span>] = chessArr1[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] ints : sparseArr) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> anInt : ints) &#123;</span><br><span class="line">                System.out.printf(<span class="string">"%d\t"</span>, anInt);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 将稀疏数组恢复成二维数组思路：</span></span><br><span class="line"><span class="comment">         * 1、更具第一行的x，y创建二维数组</span></span><br><span class="line"><span class="comment">         * 2、遍历1到sum行，取得A有效数值的对应x，y，将值A存进对应二维数组位置</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="keyword">int</span>[][] oldArray = <span class="keyword">new</span> <span class="keyword">int</span>[sparseArr[<span class="number">0</span>][<span class="number">0</span>]][sparseArr[<span class="number">0</span>][<span class="number">1</span>]];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sparseArr[<span class="number">0</span>][<span class="number">2</span>]; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> x = sparseArr[i][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> y = sparseArr[i][<span class="number">1</span>];</span><br><span class="line">            oldArray[x][y] = sparseArr[i][<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出恢复后的二维数组</span></span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">"恢复后的二维数组"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>[] ints : oldArray) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> anInt : ints) &#123;</span><br><span class="line">                System.out.printf(<span class="string">"%d\t"</span>, anInt);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、输出结果"><a href="#三、输出结果" class="headerlink" title="三、输出结果"></a>三、输出结果</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">原始的二维数组~~</span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">2</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">2</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line">二维数组的有效个数sum = <span class="number">3</span></span><br><span class="line"><span class="number">11</span>    <span class="number">11</span>    <span class="number">3</span>    </span><br><span class="line"><span class="number">1</span>    <span class="number">2</span>    <span class="number">1</span>    </span><br><span class="line"><span class="number">2</span>    <span class="number">3</span>    <span class="number">2</span>    </span><br><span class="line"><span class="number">4</span>    <span class="number">5</span>    <span class="number">2</span>    </span><br><span class="line"></span><br><span class="line">恢复后的二维数组</span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">1</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">2</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">2</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"><span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    </span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;数据结构之稀疏数组&quot;&gt;&lt;a href=&quot;#数据结构之稀疏数组&quot; class=&quot;headerlink&quot; title=&quot;数据结构之稀疏数组&quot;&gt;&lt;/a&gt;数据结构之稀疏数组&lt;/h1&gt;&lt;h2 id=&quot;一、简介&quot;&gt;&lt;a href=&quot;#一、简介&quot; class=&quot;headerli
      
    
    </summary>
    
    
      <category term="DataStructures" scheme="https://caochikai.github.io/categories/DataStructures/"/>
    
    
  </entry>
  
  <entry>
    <title>Web协议详解与抓包实战简记</title>
    <link href="https://caochikai.github.io/2019/12/31/Web%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%8A%93%E5%8C%85%E5%AE%9E%E6%88%98%E7%AE%80%E8%AE%B0/"/>
    <id>https://caochikai.github.io/2019/12/31/Web%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%8A%93%E5%8C%85%E5%AE%9E%E6%88%98%E7%AE%80%E8%AE%B0/</id>
    <published>2019-12-31T08:45:34.000Z</published>
    <updated>2019-12-31T08:57:24.015Z</updated>
    
    <content type="html"><![CDATA[<h1 id="notion链接——Web协议详解简记"><a href="#notion链接——Web协议详解简记" class="headerlink" title="notion链接——Web协议详解简记"></a><a href="https://www.notion.so/Web-12262d9ac44c4aee96db272da65dd323" target="_blank" rel="noopener">notion链接——Web协议详解简记</a></h1>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;notion链接——Web协议详解简记&quot;&gt;&lt;a href=&quot;#notion链接——Web协议详解简记&quot; class=&quot;headerlink&quot; title=&quot;notion链接——Web协议详解简记&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.notion.s
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Sublime 配置记录</title>
    <link href="https://caochikai.github.io/2019/12/29/Sublime-%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/"/>
    <id>https://caochikai.github.io/2019/12/29/Sublime-%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/</id>
    <published>2019-12-29T03:07:00.000Z</published>
    <updated>2019-12-29T16:09:56.977Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Sublime-配置"><a href="#Sublime-配置" class="headerlink" title="Sublime 配置"></a>Sublime 配置</h1><blockquote><p>多行批量修改数据的必备工具，也是前端最喜欢的文本编辑器之一。下面快捷键配置推荐收藏。</p></blockquote><h1 id="SFTP-插件-配置文件-Demo"><a href="#SFTP-插件-配置文件-Demo" class="headerlink" title="[SFTP 插件] 配置文件 Demo"></a>[SFTP 插件] 配置文件 Demo</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"host"</span>: <span class="string">"jinghanco.com"</span>,</span><br><span class="line">    <span class="attr">"user"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="attr">"password"</span>: <span class="string">"***"</span>,</span><br><span class="line">    <span class="attr">"port"</span>: <span class="string">"21"</span>,</span><br><span class="line">    <span class="attr">"remote_path"</span>: <span class="string">"/jinghan_web/..."</span>,</span><br><span class="line">    <span class="attr">"ignore_regexes"</span>: [</span><br><span class="line">        <span class="string">"\\.sublime-(project|workspace)"</span>, <span class="string">"sftp-config(-alt\\d?)?\\.json"</span>,</span><br><span class="line">        <span class="string">"sftp-settings\\.json"</span>, <span class="string">"/venv/"</span>, <span class="string">"\\.svn/"</span>, <span class="string">"\\.hg/"</span>, <span class="string">"\\.git/"</span>,</span><br><span class="line">        <span class="string">"\\.bzr"</span>, <span class="string">"_darcs"</span>, <span class="string">"CVS"</span>, <span class="string">"\\.DS_Store"</span>, <span class="string">"Thumbs\\.db"</span>, <span class="string">"desktop\\.ini"</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">"/Runtime/"</span>, <span class="string">"\\/Upload"</span>,</span><br><span class="line">        <span class="string">"\\.backup"</span>, <span class="string">"\\.save"</span>, <span class="string">"\\.copy"</span>, <span class="string">"\\.test.php"</span>,</span><br><span class="line">        <span class="string">".gitignore"</span>, <span class="string">"index.php"</span></span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Sublime-用户配置"><a href="#Sublime-用户配置" class="headerlink" title="[Sublime] 用户配置"></a>[Sublime] 用户配置</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"always_show_minimap_viewport"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"auto_complete_commit_on_tab"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"auto_find_in_selection"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"auto_match_enabled"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"bold_folder_labels"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"caret_style"</span>: <span class="string">"phase"</span>,</span><br><span class="line"><span class="attr">"close_windows_when_empty"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="comment">// "color_scheme": "Packages/Color Scheme - Default/Monokai.tmTheme",</span></span><br><span class="line"><span class="attr">"default_encoding"</span>: <span class="string">"UTF-8"</span>,</span><br><span class="line"><span class="attr">"default_line_ending"</span>: <span class="string">"unix"</span>,</span><br><span class="line"><span class="attr">"detect_indentation"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"drag_text"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"draw_minimap_border"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"ensure_newline_at_eof_on_save"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"fallback_encoding"</span>: <span class="string">"UTF-8"</span>,</span><br><span class="line"><span class="attr">"font_family"</span>: <span class="string">"consolas"</span>,</span><br><span class="line"><span class="attr">"font_size"</span>: <span class="number">11</span>,</span><br><span class="line"><span class="attr">"highlight_line"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"highlight_modified_tabs"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"ignored_packages"</span>:</span><br><span class="line">[</span><br><span class="line"><span class="string">"ColorPicker"</span>,</span><br><span class="line"><span class="string">"ConvertToUTF8"</span>,</span><br><span class="line"><span class="string">"CSS Extended Completions"</span>,</span><br><span class="line"><span class="string">"DocBlockr"</span>,</span><br><span class="line"><span class="string">"git"</span>,</span><br><span class="line"><span class="string">"Makefile"</span>,</span><br><span class="line"><span class="string">"Markdown Preview"</span>,</span><br><span class="line"><span class="string">"MarkdownEditing"</span>,</span><br><span class="line"><span class="string">"Phpcs"</span>,</span><br><span class="line"><span class="string">"Quick File Move"</span>,</span><br><span class="line"><span class="string">"SideBarEnhancements"</span>,</span><br><span class="line"><span class="string">"Vintage"</span>,</span><br><span class="line"><span class="string">"Vintageous"</span></span><br><span class="line">],</span><br><span class="line"><span class="attr">"indent_guide_options"</span>:</span><br><span class="line">[</span><br><span class="line"><span class="string">"draw_active"</span>,</span><br><span class="line"><span class="string">"draw_normal"</span></span><br><span class="line">],</span><br><span class="line"><span class="attr">"indent_to_bracket"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"line_padding_bottom"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"line_padding_top"</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">"match_brackets"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"match_brackets_angle"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"match_brackets_braces"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"match_tags"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"preview_on_click"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"rulers"</span>:</span><br><span class="line">[</span><br><span class="line"><span class="number">80</span>,</span><br><span class="line"><span class="number">120</span></span><br><span class="line">],</span><br><span class="line"><span class="attr">"scroll_past_end"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"shift_tab_unindent"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"show_encoding"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"show_line_endings"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"show_tab_close_buttons"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"tab_size"</span>: <span class="number">4</span>,</span><br><span class="line"><span class="comment">// "theme": "SoDaReloaded Dark.sublime-theme",</span></span><br><span class="line"><span class="attr">"translate_spaces_to_tabs"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"translate_tabs_to_spaces"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"tree_animation_enabled"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"trim_automatic_white_space"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"trim_trailing_white_space_on_save"</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">"word_wrap"</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">"wrap_width"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Sublime-快捷键配置"><a href="#Sublime-快捷键配置" class="headerlink" title="[Sublime] 快捷键配置"></a>[Sublime] 快捷键配置</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    <span class="comment">// 保存所有文件</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+shift+s"</span>], <span class="attr">"command"</span>: <span class="string">"save_all"</span> &#125;,</span><br><span class="line">    <span class="comment">// 下一个视图</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+tab"</span>], <span class="attr">"command"</span>: <span class="string">"next_view"</span> &#125;,</span><br><span class="line">    <span class="comment">// 上一个视图</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+shift+tab"</span>], <span class="attr">"command"</span>: <span class="string">"prev_view"</span> &#125;,</span><br><span class="line">    <span class="comment">// 变为大写</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"alt+a"</span>], <span class="attr">"command"</span>: <span class="string">"upper_case"</span> &#125;,</span><br><span class="line">    <span class="comment">// 变为小写</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"alt+s"</span>], <span class="attr">"command"</span>: <span class="string">"lower_case"</span> &#125;,</span><br><span class="line">    <span class="comment">// 复制行</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+shift+d"</span>], <span class="attr">"command"</span>: <span class="string">"duplicate_line"</span> &#125;,</span><br><span class="line">    <span class="comment">// 选择下一个相同的被选字符</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+d"</span>], <span class="attr">"command"</span>: <span class="string">"find_under_expand"</span> &#125;,</span><br><span class="line">    <span class="comment">// 跳过选择</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+k"</span>, <span class="string">"ctrl+d"</span>], <span class="attr">"command"</span>: <span class="string">"find_under_expand_skip"</span> &#125;,</span><br><span class="line">    <span class="comment">// 显示隐藏</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"alt+x"</span><span class="comment">/*, "alt+z"*/</span>], <span class="attr">"command"</span>: <span class="string">"toggle_side_bar"</span> &#125;,</span><br><span class="line">    <span class="comment">// 快速打开hosts文件</span></span><br><span class="line">    &#123; <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+h"</span>], <span class="attr">"command"</span>: <span class="string">"prompt_open_file C:\\Windows\\System32\\drivers\\etc\\hosts"</span>&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"keys"</span>: [<span class="string">"ctrl+alt+j"</span>], <span class="attr">"command"</span>: <span class="string">"js_format"</span>,</span><br><span class="line">        <span class="attr">"context"</span>: [&#123;<span class="attr">"key"</span>: <span class="string">"selector"</span>, <span class="attr">"operator"</span>: <span class="string">"equal"</span>, <span class="attr">"operand"</span>: <span class="string">"source.js,source.json"</span>&#125;]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Sublime-配置&quot;&gt;&lt;a href=&quot;#Sublime-配置&quot; class=&quot;headerlink&quot; title=&quot;Sublime 配置&quot;&gt;&lt;/a&gt;Sublime 配置&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;多行批量修改数据的必备工具，也是前端最喜欢的文本编
      
    
    </summary>
    
    
      <category term="tool" scheme="https://caochikai.github.io/categories/tool/"/>
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>maven公共仓库推荐配置</title>
    <link href="https://caochikai.github.io/2019/12/28/maven%E5%85%AC%E5%85%B1%E4%BB%93%E5%BA%93%E6%8E%A8%E8%8D%90%E9%85%8D%E7%BD%AE/"/>
    <id>https://caochikai.github.io/2019/12/28/maven%E5%85%AC%E5%85%B1%E4%BB%93%E5%BA%93%E6%8E%A8%E8%8D%90%E9%85%8D%E7%BD%AE/</id>
    <published>2019-12-28T09:34:00.000Z</published>
    <updated>2019-12-28T09:37:04.285Z</updated>
    
    <content type="html"><![CDATA[<h1 id="maven公共仓库推荐配置"><a href="#maven公共仓库推荐配置" class="headerlink" title="maven公共仓库推荐配置"></a>maven公共仓库推荐配置</h1><blockquote><p>maven公共仓库毕竟是在国外，所以使用maven默认配置仓库地址，下载网络可能就几十KB。推荐在公司里面搭建一个nexus私服仓库，因为有些jar随着时间变化（特别是老项目），maven公服都会丢失，最惨的是莫过于在GitHub项目都没有了。下面是我个人对关于maven仓库配置的一点不成熟建议，为了配合IDEA和命令行，idea已经自带maven，且maven与idea版本做了适配的，通常情况下不建议单独另外下载maven；web项目通常分为三种，第一种常见的maven项目（pom.xml），第二种普通的WebRoot项目，第三种gradle（强大，题外话）。如果贵司有私服那建议maven项目，没有那就推荐WebRoot集成第三方库web-inf/lib。毕竟随着时间流逝，很多第三方库会被淘汰或者维护开发者已经消失在业界。</p></blockquote><ul><li><p>在onedriver或者云盘里，放置自己常用的开发工具，maven有个config文件夹，下面有个setting.xml，里面有       个mirror的标签，替换掉，IDE环境需要在idea配置maven指定setting地址（建议走下面默认配置，无需改动），项目的部分依赖包在webapp/web-inf/lib下！</p></li><li><p>默认推荐：在win系统开发环境下，本地仓库默认在C:\Users\cao.m2下repository，建议配置在固态硬盘，把下面推荐mirrors标签配置替换maven/config/settings.xml后直接放置在C:\Users\cao.m2（系统当前用户目录）。</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span>   </span><br><span class="line">     <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">maven.aliyun.com</span>/<span class="attr">nexus</span>/<span class="attr">content</span>/<span class="attr">groups</span>/<span class="attr">public</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven Repository Switchboard<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">repo1.maven.org</span>/<span class="attr">maven2</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">repo2.maven.org</span>/<span class="attr">maven2</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>ibiblio<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">mirrors.ibiblio.org</span>/<span class="attr">pub</span>/<span class="attr">mirrors</span>/<span class="attr">maven2</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jboss-public-repository-group<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>JBoss Public Repository Group<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">repository.jboss.org</span>/<span class="attr">nexus</span>/<span class="attr">content</span>/<span class="attr">groups</span>/<span class="attr">public</span>&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>google<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>google maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">https:</span>//<span class="attr">maven.google.com</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 中央仓库在中国的镜像 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven.net.cn<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>oneof the central mirrors in china<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span><span class="tag">&lt;<span class="name">http:</span>//<span class="attr">maven.net.cn</span>/<span class="attr">content</span>/<span class="attr">groups</span>/<span class="attr">public</span>/&gt;</span><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;maven公共仓库推荐配置&quot;&gt;&lt;a href=&quot;#maven公共仓库推荐配置&quot; class=&quot;headerlink&quot; title=&quot;maven公共仓库推荐配置&quot;&gt;&lt;/a&gt;maven公共仓库推荐配置&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;maven公共仓库毕竟是在
      
    
    </summary>
    
    
    
      <category term="maven" scheme="https://caochikai.github.io/tags/maven/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：缓存模块</title>
    <link href="https://caochikai.github.io/2019/12/27/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9D%97/"/>
    <id>https://caochikai.github.io/2019/12/27/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9D%97/</id>
    <published>2019-12-27T14:06:00.000Z</published>
    <updated>2019-12-27T14:24:17.404Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-9、缓存模块"><a href="#2-9、缓存模块" class="headerlink" title="2.9、缓存模块"></a>2.9、缓存模块</h1><blockquote><p>在Mybatis中，最常听见的就是mybatis的查询一二级缓存，本质都是org.apache.ibatis.cache缓存模块下Cache的实现。本文主要是对Cache接口以及实现类进行结束，并涉及到了装饰器模式。该接口实现类众多，只有PerpetualCache提供了Cache接口的基本实现，下面分析Cache接口后，接着PerpetualCache（超级简单）：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**缓存服务发现</span></span><br><span class="line"><span class="comment"> * SPI(service provider interface) for cache providers.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;一个缓存实例对应着一个namespace命名空间</span></span><br><span class="line"><span class="comment"> * One instance of cache will be created for each namespace.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The cache implementation must have a constructor that receives the cache id as an String parameter..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**缓存对象的唯一ID</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The identifier of this cache</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**向缓存里添加数据，key通常是CacheKey，value是查询的结果</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key Can be any object but usually it is a &#123;<span class="doctag">@link</span> CacheKey&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value The result of a select.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**根据key获取相应的缓存结果</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key The key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The object stored in the cache.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">getObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**从3.3.0开始在回滚rollback期间缓存的值可能会缓存丢失命中，</span></span><br><span class="line"><span class="comment"> * 为了防止缓存穿透直接命中数据库，可以往key先放null值（会上锁），设置上后就会释放锁。</span></span><br><span class="line"><span class="comment">   * As of 3.3.0 this method is only called during a rollback</span></span><br><span class="line"><span class="comment">   * for any previous value that was missing in the cache.</span></span><br><span class="line"><span class="comment">   * This lets any blocking cache to release the lock that</span></span><br><span class="line"><span class="comment">   * may have previously put on the key.</span></span><br><span class="line"><span class="comment">   * A blocking cache puts a lock when a value is null</span></span><br><span class="line"><span class="comment">   * and releases it when the value is back again.</span></span><br><span class="line"><span class="comment">   * This way other threads will wait for the value to be</span></span><br><span class="line"><span class="comment">   * available instead of hitting the database.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Object <span class="title">removeObject</span><span class="params">(Object key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**清空缓存</span></span><br><span class="line"><span class="comment">   * Clears this cache instance.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**可选实现，因为mybatis核心根本不会使用该方法</span></span><br><span class="line"><span class="comment">   * Optional. This method is not called by the core.</span></span><br><span class="line"><span class="comment">   *返回其元素个数，而不是容器总大小</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The number of elements stored in the cache (not its capacity).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**可选实现，从 3.2.6版本开始核心方法不再会使用改方法getReadWriteLock</span></span><br><span class="line"><span class="comment">   * Optional. As of 3.2.6 this method is no longer called by the core.</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;缓存所需的任何锁都必须​​由缓存提供内部实现</span></span><br><span class="line"><span class="comment">   * Any locking needed by the cache must be provided internally by the cache provider.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> ReadWriteLock <span class="title">getReadWriteLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.cache.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerpetualCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"><span class="comment">//缓存对象的唯一id</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line"><span class="comment">//用于记录缓存的容器</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">PerpetualCache</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//下面记录所有的方法都来自Map对象的相应方法</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>org.apache.ibatis.cache.decorators下是装饰器实现，以BlockingCache举例，支持阻塞版本的缓存装饰器，它通过ReentrantLock保证只有一个线程到数据库中查找指定的key对应的数据。可以从putObject和getObject方法入手，下面在源码里了解其具体实现：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.cache.decorators;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="comment">/**简单阻塞版本的缓存装饰器</span></span><br><span class="line"><span class="comment"> * Simple blocking decorator</span></span><br><span class="line"><span class="comment"> *简单而高效版本的EhCache阻塞装饰器，当找不到该缓存就会在key上锁</span></span><br><span class="line"><span class="comment"> * Simple and inefficient version of EhCache's BlockingCache decorator.</span></span><br><span class="line"><span class="comment"> * It sets a lock over a cache key when the element is not found in cache.</span></span><br><span class="line"><span class="comment"> * This way, other threads will wait until this element is filled instead of hitting the database.</span></span><br><span class="line"><span class="comment"> *这样，其他线程将等待直到该元素被填充，而不是直接命中访问数据库。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"><span class="comment">//阻塞超时时长</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> timeout;</span><br><span class="line"><span class="comment">//被装饰的底层对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">//线程安全的ConcurrentHashMap，每个key都有个重入锁ReentrantLock</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;Object, ReentrantLock&gt; locks;</span><br><span class="line">...省略构造器和一些属性geter\setter</span><br><span class="line"><span class="comment">//当查出该值放入该key下，就会释放该线程之前持有的锁</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      delegate.putObject(key, value);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      releaseLock(key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="comment">//获取key对应的锁</span></span><br><span class="line">    acquireLock(key);</span><br><span class="line"><span class="comment">//获取key对应的缓存项</span></span><br><span class="line">    Object value = delegate.getObject(key);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//释放改key持有的锁</span></span><br><span class="line">      releaseLock(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">removeObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这个方法虽然名字长成这样，但是依然还是只会调用releaseLock方法</span></span><br><span class="line">    releaseLock(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> ReentrantLock <span class="title">getLockForKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> locks.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> ReentrantLock());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">acquireLock</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="comment">//如果没有没有锁就创建</span></span><br><span class="line">    Lock lock = getLockForKey(key);</span><br><span class="line">    <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//在指定timeout时间内尝试获取锁，false代表超时</span></span><br><span class="line">        <span class="keyword">boolean</span> acquired = lock.tryLock(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!acquired) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Couldn't get a lock in "</span> + timeout + <span class="string">" for the key "</span> +  key + <span class="string">" at the cache "</span> + delegate.getId());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Got interrupted while trying to acquire lock for key "</span> + key, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//获取锁，不带超时时间</span></span><br><span class="line">      lock.lock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseLock</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="comment">//从缓存锁的集合中获取指定key对应的锁</span></span><br><span class="line">    ReentrantLock lock = locks.get(key);</span><br><span class="line"><span class="comment">//判断该锁是否被该线程持有</span></span><br><span class="line">    <span class="keyword">if</span> (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">      lock.unlock();<span class="comment">//那就释放掉，其他线程才能进行其他操作</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FifoCache-amp-LruCache"><a href="#FifoCache-amp-LruCache" class="headerlink" title="FifoCache&amp;LruCache"></a>FifoCache&amp;LruCache</h3><blockquote><p>上面提到那么多Cache接口实现类，有什么用处呢？在很多场景中，比如为了控制缓存的大小，系统需要通过一定策略清理缓存。FifoCache（Fist in，Fist Oout）是先入先出策略，当向缓存添加数据时，通过设置缓存项的个数上限控制进行清理的阈值。LruCache是最近最少使用（Least Recently Used，LRU）策略，在需要清理缓存时，它会清除最近最少使用的缓存项。下面简略介绍一些比较重要的核心代码：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**先入先出</span></span><br><span class="line"><span class="comment"> * FIFO (first in, first out) cache decorator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FifoCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"><span class="comment">//底层被装饰的缓存对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">//通过队列数据结构记录顺序，实际是LinkedList&lt;object&gt;类型的集合对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; keyList;</span><br><span class="line"><span class="comment">//缓存项的个数上限清理动作的阈值</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">...省略setter/getter</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line"><span class="comment">//检测是否到达阈值，并清理缓存</span></span><br><span class="line">    cycleKeyList(key);</span><br><span class="line">    delegate.putObject(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleKeyList</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="comment">//先记录该缓存</span></span><br><span class="line">    keyList.addLast(key);</span><br><span class="line"><span class="comment">//判断是达到上限</span></span><br><span class="line">    <span class="keyword">if</span> (keyList.size() &gt; size) &#123;</span><br><span class="line"><span class="comment">//清理最老的（排在队头的）</span></span><br><span class="line">      Object oldestKey = keyList.removeFirst();</span><br><span class="line">      delegate.removeObject(oldestKey);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**最近最少使用</span></span><br><span class="line"><span class="comment"> * Lru (least recently used) cache decorator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"><span class="comment">//底层被装饰的缓存对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">//实际LinkedHashMap&lt;object，object&gt;类型对象，用于记录key最近的使用情况</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;Object, Object&gt; keyMap;</span><br><span class="line"><span class="comment">//记录最少使用的key</span></span><br><span class="line">  <span class="keyword">private</span> Object eldestKey;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(Cache delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line"><span class="comment">//默认大小为1024</span></span><br><span class="line">    setSize(<span class="number">1024</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...省略setter/getter</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line"><span class="comment">//第三个参数控制是否记录其顺序，LinkedHashMap.get方法会改变其顺序（把该节点往最后位置放move node to last）</span></span><br><span class="line">    keyMap = <span class="keyword">new</span> LinkedHashMap&lt;Object, Object&gt;(size, .<span class="number">75F</span>, <span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//重写removeEldestEntry最终会被其put方法调用到</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Object, Object&gt; eldest)</span> </span>&#123;</span><br><span class="line"><span class="comment">//如果达到缓存上限则更新eldestKey </span></span><br><span class="line">        <span class="keyword">boolean</span> tooBig = size() &gt; size;</span><br><span class="line">        <span class="keyword">if</span> (tooBig) &#123;</span><br><span class="line">          eldestKey = eldest.getKey();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tooBig;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line"><span class="comment">//添加缓存项后删除最久未使用项</span></span><br><span class="line">    delegate.putObject(key, value);</span><br><span class="line">    cycleKeyList(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    keyMap.get(key); <span class="comment">//touch触发LinkedHashMap记录排序</span></span><br><span class="line">    <span class="keyword">return</span> delegate.getObject(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleKeyList</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    keyMap.put(key, key);</span><br><span class="line"><span class="comment">//eldestKey不是空代表到了上限，那就执行删除removeObject</span></span><br><span class="line">    <span class="keyword">if</span> (eldestKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">      delegate.removeObject(eldestKey);</span><br><span class="line">      eldestKey = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SoftCache-amp-WeakCache"><a href="#SoftCache-amp-WeakCache" class="headerlink" title="SoftCache&amp;WeakCache"></a>SoftCache&amp;WeakCache</h3><blockquote><p>这两个缓存实现主要应用场景在不重要且方便GC的需求下，这就不得不提及java的四种引用类型。下面引用从强到弱依次排列介绍：</p></blockquote><ul><li>强引用（Strong Reference）：最常见就是new对象被强引用，GC是不能绝不会回收该类型对象，当然引用类型会变化，并非一成不变。</li><li>软引用（Soft Reference）：当JVM内存不足时候，软引用指向的对象会被释放，需要通过Reference.get方法返回值，判断是否对象是否存活。</li><li>引用队列（ReferenceQueue）：在创建 SoftReference对象时，当被GC回收时，JVM就会将该SoftReference对象添加到关联的引用队列中。当需要检测时，就可以从引用队列中获取这些SoftReference对象。可参考java.util.WeakHashMap的代码。</li><li>弱引用（Weak Reference）：在发生GC检查到该对象的引用类型全是weak reference，就会被回收；参考java.util.WeakHashMap。</li><li>幽灵引用（Phantom Reference）：小名（虚引用），必须指定引用队列才能使用，当GC发生回收该引用对象会通知到该队列，作为Object.finalize()被废弃后的代替解决方案。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Soft Reference cache decorator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"><span class="comment">//该队列的缓存对象属于都有强引用存在，代表该部分缓存不会被回收</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;</span><br><span class="line"><span class="comment">//ReferenceQueue引用队列，记录被GC回收的缓存项（SoftEntry对象）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"><span class="comment">//强引用的数量，默认是256</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberOfHardLinks;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SoftCache</span><span class="params">(Cache delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line"><span class="comment">//初始化成员</span></span><br><span class="line">    <span class="keyword">this</span>.numberOfHardLinks = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">this</span>.hardLinksToAvoidGarbageCollection = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.queueOfGarbageCollectedEntries = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...省略setter/getter和简单方法</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line"><span class="comment">//清除已被GC的缓存</span></span><br><span class="line">    removeGarbageCollectedItems();</span><br><span class="line"><span class="comment">//添加新的缓存</span></span><br><span class="line">    delegate.putObject(key, <span class="keyword">new</span> SoftEntry(key, value, queueOfGarbageCollectedEntries));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Object result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// assumed delegate cache is totally managed by this cache</span></span><br><span class="line">    SoftReference&lt;Object&gt; softReference = (SoftReference&lt;Object&gt;) delegate.getObject(key);</span><br><span class="line"><span class="comment">//检查是否有缓存项</span></span><br><span class="line">    <span class="keyword">if</span> (softReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = softReference.get();</span><br><span class="line"><span class="comment">//已经被GC回收了</span></span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//从缓存也删除，与GC同步</span></span><br><span class="line">        delegate.removeObject(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//修改不仅仅需要读锁（那就是写锁也要） See #586 (and #335) modifications need more than a read lock</span></span><br><span class="line">        <span class="keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;</span><br><span class="line"><span class="comment">//重复获取证明属于强引用，记录到hardLinksToAvoidGarbageCollection</span></span><br><span class="line">          hardLinksToAvoidGarbageCollection.addFirst(result);</span><br><span class="line"><span class="comment">//类似先进先出，到达阈值清空老的</span></span><br><span class="line">          <span class="keyword">if</span> (hardLinksToAvoidGarbageCollection.size() &gt; numberOfHardLinks) &#123;</span><br><span class="line">            hardLinksToAvoidGarbageCollection.removeLast();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//先清空强引用该集合</span></span><br><span class="line">    <span class="keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;</span><br><span class="line">      hardLinksToAvoidGarbageCollection.clear();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//再清空被GC回收的缓存项</span></span><br><span class="line">    removeGarbageCollectedItems();</span><br><span class="line"><span class="comment">//清理底层缓存</span></span><br><span class="line">    delegate.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeGarbageCollectedItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SoftEntry sv;</span><br><span class="line"><span class="comment">//遍历queueOfGarbageCollectedEntries集合</span></span><br><span class="line">    <span class="keyword">while</span> ((sv = (SoftEntry) queueOfGarbageCollectedEntries.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//将已被GC的缓存也清除了（与GC同步）</span></span><br><span class="line">      delegate.removeObject(sv.key);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SoftEntry</span> <span class="keyword">extends</span> <span class="title">SoftReference</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123;</span><br><span class="line"><span class="comment">//指向value的是软引用，且关联了队列garbageCollectionQueue</span></span><br><span class="line">      <span class="keyword">super</span>(value, garbageCollectionQueue);</span><br><span class="line"><span class="comment">//强引用</span></span><br><span class="line">      <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ScheduledCache-amp-LoggingCache-amp-SynchronizedCache-amp-CacheSerializedCache"><a href="#ScheduledCache-amp-LoggingCache-amp-SynchronizedCache-amp-CacheSerializedCache" class="headerlink" title="ScheduledCache&amp;LoggingCache&amp;SynchronizedCache&amp;CacheSerializedCache"></a>ScheduledCache&amp;LoggingCache&amp;SynchronizedCache&amp;CacheSerializedCache</h3></li></ul><blockquote><p>最后提一下剩下的几个缓存装饰器，ScheduledCache看名字就知道是周期计划行清空缓存，默认是一小时；LoggingCache是带日志功能的缓存，主要用来统计缓存命中次数和访问次数，以及输出指定的格式；SynchronizedCache添加了同步功能，通过在每个方法上添加synchronized；CacheSerializedCache提供添加针对value进行序列化后byte[]存入缓存，而获取就对byte[]进行反序列化（一个全新对象），使用的是jdk原生序列化。</p></blockquote><h2 id="2-9-3-CacheKey"><a href="#2-9-3-CacheKey" class="headerlink" title="2.9.3 CacheKey"></a>2.9.3 CacheKey</h2><blockquote><p>这个key有点复杂啊，key可能不仅仅是个String，通过CacheKey就添加多个对象updateList影响缓存项key的唯一性。updateList包含MappedStatement的id、<br>指定查询结果集的范围——RowBounds.offset和RowBounds.limit、查询所使用的SQL语句、该SQL语句的实际参数值。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheKey</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MULTIPLIER = <span class="number">37</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_HASHCODE = <span class="number">17</span>;</span><br><span class="line"><span class="comment">//参与计算的hashcode，默认是DEFAULT_MULTIPLIER </span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> multiplier;</span><br><span class="line"><span class="comment">//CacheKey对象的hashcode，默认是DEFAULT_HASHCODE</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> hashcode;</span><br><span class="line"><span class="comment">//校验和</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> checksum;</span><br><span class="line"><span class="comment">//updateList集合个数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"><span class="comment">//由该集合中的所有对象共同决定两个CacheKey是否相同</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;Object&gt; updateList;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CacheKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.hashcode = DEFAULT_HASHCODE;</span><br><span class="line">    <span class="keyword">this</span>.multiplier = DEFAULT_MULTIPLIER;</span><br><span class="line">    <span class="keyword">this</span>.count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.updateList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">...省略setter/getter和简单方法</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line"><span class="comment">//根据不同类型获取其baseHashCode </span></span><br><span class="line">    <span class="keyword">int</span> baseHashCode = object == <span class="keyword">null</span> ? <span class="number">1</span> : ArrayUtil.hashCode(object);</span><br><span class="line">    count++;</span><br><span class="line">    checksum += baseHashCode;</span><br><span class="line">    baseHashCode *= count;</span><br><span class="line"><span class="comment">//重新计算hashcode </span></span><br><span class="line">    hashcode = multiplier * hashcode + baseHashCode;</span><br><span class="line">    updateList.add(object);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAll</span><span class="params">(Object[] objects)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Object o : objects) &#123;</span><br><span class="line">      update(o);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//重写equals</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == object) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> CacheKey)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> CacheKey cacheKey = (CacheKey) object;</span><br><span class="line"><span class="comment">//比较hashcode、checksum、count</span></span><br><span class="line">    <span class="keyword">if</span> (hashcode != cacheKey.hashcode) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (checksum != cacheKey.checksum) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count != cacheKey.count) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//比较updateList每一项</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; updateList.size(); i++) &#123;</span><br><span class="line">      Object thisObject = updateList.get(i);</span><br><span class="line">      Object thatObject = cacheKey.updateList.get(i);</span><br><span class="line">      <span class="keyword">if</span> (!ArrayUtil.equals(thisObject, thatObject)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>```</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-9、缓存模块&quot;&gt;&lt;a href=&quot;#2-9、缓存模块&quot; class=&quot;headerlink&quot; title=&quot;2.9、缓存模块&quot;&gt;&lt;/a&gt;2.9、缓存模块&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;在Mybatis中，最常听见的就是mybatis的查询一二级缓存，
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：参数和结果集处理</title>
    <link href="https://caochikai.github.io/2019/12/26/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8F%82%E6%95%B0%E5%92%8C%E7%BB%93%E6%9E%9C%E9%9B%86%E5%A4%84%E7%90%86/"/>
    <id>https://caochikai.github.io/2019/12/26/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8F%82%E6%95%B0%E5%92%8C%E7%BB%93%E6%9E%9C%E9%9B%86%E5%A4%84%E7%90%86/</id>
    <published>2019-12-26T10:28:00.000Z</published>
    <updated>2019-12-26T10:30:17.338Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-8、binding-模块"><a href="#2-8、binding-模块" class="headerlink" title="2.8、binding 模块"></a>2.8、binding 模块</h1><blockquote><p>org.apache.ibatis.binding模块是为了解决Mapper类接口和对应Xml配置文件之间映射，通常Mapper接口定义了SQL语句对应的方法，而xml里面配置了对应的SQL语句，所以在Mybatis初始化的时候编译器会检查配置Mapper和xml，并关联起来。特别在参数处理那块非常复杂，需要给位看官的耐心分析，下面就要先从核心组件关系入手：</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/MapperRegistry.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h2 id="2-8-1-MapperRegistry-amp-MapperProxyFactory"><a href="#2-8-1-MapperRegistry-amp-MapperProxyFactory" class="headerlink" title="2.8.1 MapperRegistry&amp;MapperProxyFactory"></a>2.8.1 MapperRegistry&amp;MapperProxyFactory</h2><blockquote><p>XXXRegistry看后缀命名风格就知道又是个注册类，MapperRegistry是Mapper接口及其对应的代理对象工厂的注册中心。Configuration是MyBatis 全局性的配置对象，在MyBatis初始化的过程中，所有配置信息会被解析成相应的对象并记录到Configuration对象中，后面介绍MyBatis初始化过程时会详细介绍Configuration。我重点要关注Configuration.mapperRegistry属性，它记录当前使用的MapperRegistry对象，下面就让就进行源码导读：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperRegistry</span> </span>&#123;</span><br><span class="line"><span class="comment">//Configuration对象全局唯一的配置对象，包含所有的配置信息</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Configuration config;</span><br><span class="line"><span class="comment">//记录Mapper接口与MapperProxyFactory之间的对应关系,</span></span><br><span class="line"><span class="comment">//key为Mapper接口Class，value对应的代理工厂对象MapperProxyFactory</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperRegistry</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过Class type获取MapperProxyFactory工厂对象</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//传入sqlSession为Mapper接口创建jdk动态代理对象，下面会详细分析mapperProxyFactory创建过程</span></span><br><span class="line">      <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Class类型判断knownMappers是否存在该Mapper接口</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">hasMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> knownMappers.containsKey(type);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//加载完配置文件和类上注解，将解析的mapper接口通过addMapper方法添加到MapperRegistry.knownMappers,</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line"><span class="comment">//判断是否是接口</span></span><br><span class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</span><br><span class="line"><span class="comment">//检查是否已经存在，避免重复读取</span></span><br><span class="line">      <span class="keyword">if</span> (hasMapper(type)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is already known to the MapperRegistry."</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//标志是否完成load加载</span></span><br><span class="line">      <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//将Mapper接口对应的Class对象和MapperproxyFactory对象添加到knownMappers集合</span></span><br><span class="line">        knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;&gt;(type));</span><br><span class="line">        <span class="comment">// It's important that the type is added before the parser is run</span></span><br><span class="line">        <span class="comment">// otherwise the binding may automatically be attempted by the</span></span><br><span class="line">        <span class="comment">// mapper parser. If the type is already known, it won't try.</span></span><br><span class="line"><span class="comment">//这个涉及到xml解析和注解方面的处理，后面再详细解答</span></span><br><span class="line">        MapperAnnotationBuilder parser = <span class="keyword">new</span> MapperAnnotationBuilder(config, type);</span><br><span class="line">        parser.parse();</span><br><span class="line">        loadCompleted = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!loadCompleted) &#123;</span><br><span class="line">          knownMappers.remove(type);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**通过knownMappers获取Class集合，该集合为不可变容器unmodifiableCollection，避免被修改只能被读取</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 3.2.2</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;Class&lt;?&gt;&gt; getMappers() &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableCollection(knownMappers.keySet());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**通过包名路径读取指定superType父类的mapper（包扫描）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@since</span> 3.2.2</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMappers</span><span class="params">(String packageName, Class&lt;?&gt; superType)</span> </span>&#123;</span><br><span class="line">    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="keyword">new</span> ResolverUtil&lt;&gt;();</span><br><span class="line">    resolverUtil.find(<span class="keyword">new</span> ResolverUtil.IsA(superType), packageName);</span><br><span class="line">    Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; mapperSet = resolverUtil.getClasses();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; mapperClass : mapperSet) &#123;</span><br><span class="line">      addMapper(mapperClass);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...addMappers重载</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxyFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//当前MapperProxyFactory工厂对应的产品mapperInterface接口</span></span><br><span class="line"><span class="comment">//换而言之就是一个工厂只能生产一种产品</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"><span class="comment">//该mapperInterface接口下对应的方法集合，key为java.lang.reflect.Method，value为MapperMethod对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//...geter/setter方法和构造器</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//创建实现了mapperInterface接口的代理对象</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-8-2-MapperProxy代理"><a href="#2-8-2-MapperProxy代理" class="headerlink" title="2.8.2 MapperProxy代理"></a>2.8.2 MapperProxy代理</h2><blockquote><p>MapperProxy实现了InvocationHandler接口，接口实现方法就是JDK动态代理的核心方法逻辑，下面认真分析针对mapper代理逻辑：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">//java.lang.invoke.MethodHandles.Lookup是被允许访问的成员类型（访问权限修饰符）</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOWED_MODES = MethodHandles.Lookup.PRIVATE | MethodHandles.Lookup.PROTECTED</span><br><span class="line">      | MethodHandles.Lookup.PACKAGE | MethodHandles.Lookup.PUBLIC;</span><br><span class="line"><span class="comment">//动态代理Constructor</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Constructor&lt;Lookup&gt; lookupConstructor;</span><br><span class="line"><span class="comment">//私有访问类型的方法</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Method privateLookupInMethod;</span><br><span class="line"><span class="comment">//全局引用的sqlSession对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</span><br><span class="line"><span class="comment">//接口对应的Class对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"><span class="comment">//methodCache缓存方法集合key为Method对象，value为对应的MapperMethod</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略构造器</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//如果目标方法继承自object，则直接调用目标方法</span></span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.isDefault()) &#123;<span class="comment">//是否的默认方法（public non-abstract）</span></span><br><span class="line">        <span class="keyword">if</span> (privateLookupInMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//针对jdk8版本默认方法处理</span></span><br><span class="line">          <span class="keyword">return</span> invokeDefaultMethodJava8(proxy, method, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//针对jdk9版本默认方法处理</span></span><br><span class="line">          <span class="keyword">return</span> invokeDefaultMethodJava9(proxy, method, args);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//优先在缓存中获取，如果没有就new一个，具体看下面cachedMapperMethod方法</span></span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//新版本的mybatis</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> MapperMethod <span class="title">cachedMapperMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> methodCache.computeIfAbsent(method,</span><br><span class="line">        k -&gt; <span class="keyword">new</span> MapperMethod(mapperInterface, method, sqlSession.getConfiguration()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略方法invokeDefaultMethodJava8和invokeDefaultMethodJava9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-8-3-MapperMethod"><a href="#2-8-3-MapperMethod" class="headerlink" title="2.8.3 MapperMethod"></a>2.8.3 MapperMethod</h2><blockquote><p>MapperMethod封装了接口中对应的方法的元信息，以及对应的SQL语句，与开发者息息相关。另一个比较重要的SqlCommand是MapperMethod中定义的内部类，它使用name字段记录了SQL语句的名称，使用type字段（SqlCommandType类型）记录了SQL语句的类型。SqlCommandType是枚举类型，有效取值为UNKNOWN、INSERT、UPDATE、DELETE、SELECT、FLUSH。MapperMethod源码比较复杂，先分析MapperMethod字段信息，后面会拆分SqlCommand、MethodSignature和ParamNameResolver分析：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">declaringClasspackage org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperMethod</span> </span>&#123;</span><br><span class="line"><span class="comment">//SqlCommand记录SQL语句的名称和类型</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlCommand command;</span><br><span class="line"><span class="comment">//Mapper接口中的方法签名和相关信息，MethodSignature也是MapperMethod的内部类</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MethodSignature method;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperMethod</span><span class="params">(Class&lt;?&gt; mapperInterface, Method method, Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.command = <span class="keyword">new</span> SqlCommand(config, mapperInterface, method);</span><br><span class="line">    <span class="keyword">this</span>.method = <span class="keyword">new</span> MethodSignature(config, mapperInterface, method);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlCommand</span> </span>&#123;</span><br><span class="line"><span class="comment">//SQL语句的名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"><span class="comment">//SqlCommandType枚举类型：UNKNOWN、INSERT、UPDATE、DELETE、SELECT、FLUSH</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SqlCommandType type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SqlCommand</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> </span>&#123;</span><br><span class="line"><span class="comment">//初步是先获取方法名称</span></span><br><span class="line">      <span class="keyword">final</span> String methodName = method.getName();</span><br><span class="line"><span class="comment">//方法的Method.clazz属性，主要用来判断是否为父接口信息</span></span><br><span class="line">      <span class="keyword">final</span> Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">      MappedStatement ms = resolveMappedStatement(mapperInterface, methodName, declaringClass,</span><br><span class="line">          configuration);</span><br><span class="line"><span class="comment">//检查MappedStatement是否创建成功</span></span><br><span class="line">      <span class="keyword">if</span> (ms == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//处理@Flush注解</span></span><br><span class="line">        <span class="keyword">if</span> (method.getAnnotation(Flush<span class="class">.<span class="keyword">class</span>) !</span>= <span class="keyword">null</span>) &#123;</span><br><span class="line">          name = <span class="keyword">null</span>;</span><br><span class="line">          type = SqlCommandType.FLUSH;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Invalid bound statement (not found): "</span></span><br><span class="line">              + mapperInterface.getName() + <span class="string">"."</span> + methodName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//初始化name和type</span></span><br><span class="line">        name = ms.getId();</span><br><span class="line">        type = ms.getSqlCommandType();</span><br><span class="line">        <span class="keyword">if</span> (type == SqlCommandType.UNKNOWN) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//解析创建MappedStatement（SQL语句全部具体信息），后面再重点介绍</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MappedStatement <span class="title">resolveMappedStatement</span><span class="params">(Class&lt;?&gt; mapperInterface, String methodName,</span></span></span><br><span class="line"><span class="function"><span class="params">        Class&lt;?&gt; declaringClass, Configuration configuration)</span> </span>&#123;</span><br><span class="line"><span class="comment">//SQL语句的名称是由Mapper接口的名称与对应的方法名称组成的</span></span><br><span class="line">      String statementId = mapperInterface.getName() + <span class="string">"."</span> + methodName;</span><br><span class="line"><span class="comment">//先从Configuration.mappedStatements集合查询缓存</span></span><br><span class="line">      <span class="keyword">if</span> (configuration.hasStatement(statementId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> configuration.getMappedStatement(statementId);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mapperInterface.equals(declaringClass)) &#123;</span><br><span class="line"><span class="comment">//如果没有父类接口，也没有该sql、方法记录，那就没有了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//MappperMethod在父接口里面</span></span><br><span class="line">      <span class="keyword">for</span> (Class&lt;?&gt; superInterface : mapperInterface.getInterfaces()) &#123;</span><br><span class="line"><span class="comment">//递归查找父接口类型是declaringClass的MappedStatement </span></span><br><span class="line">        <span class="keyword">if</span> (declaringClass.isAssignableFrom(superInterface)) &#123;</span><br><span class="line">          MappedStatement ms = resolveMappedStatement(superInterface, methodName,</span><br><span class="line">              declaringClass, configuration);</span><br><span class="line">          <span class="keyword">if</span> (ms != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ms;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...先省略具体方法后面再分析</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>MapperMethod另一个比较重要的内部类MethodSignature，通过ParamNameResolver处理接口方法的参数列表。ParamNameResolver的name字段（SortedMap&lt;Integer，String&gt;类型），其中key表示参数在参数列表中的索引位置，value 表示参数名称，参数名称可以通过<strong>@Param</strong>注解指定，如果没有指定<strong>@Param</strong>注解，则使用参数索引作为其名称。如果参数列表中包含RowBounds或ResultHandler类型的参数，则这两种类型的参数并不会被记录到name集合中，这就会导致参数的索引与名称不一致。下面源码导读中讲解到例子：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamNameResolver</span> </span>&#123;</span><br><span class="line"><span class="comment">//下标值的前缀名称</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GENERIC_NAME_PREFIX = <span class="string">"param"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;key为index索引（区别于真实索引，换而言之为按照真正的参数args下标来）</span></span><br><span class="line"><span class="comment">   * value为参数变量名(通过)</span></span><br><span class="line"><span class="comment">   * The key is the index and the value is the name of the parameter.&lt;br /&gt;</span></span><br><span class="line"><span class="comment">   * The name is obtained from &#123;<span class="doctag">@link</span> Param&#125; if specified. When &#123;<span class="doctag">@link</span> Param&#125; is not specified,</span></span><br><span class="line"><span class="comment">   * the parameter index is used. Note that this index could be different from the actual index</span></span><br><span class="line"><span class="comment">   * when the method has special parameters (i.e. &#123;<span class="doctag">@link</span> RowBounds&#125; or &#123;<span class="doctag">@link</span> ResultHandler&#125;).</span></span><br><span class="line"><span class="comment">   * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">   * &lt;ul&gt;官方的举例：</span></span><br><span class="line"><span class="comment">   * &lt;li&gt;aMethod(<span class="doctag">@Param</span>("M") int a, <span class="doctag">@Param</span>("N") int b) -&amp;gt; &#123;&#123;0, "M"&#125;, &#123;1, "N"&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">   * &lt;li&gt;aMethod(int a, int b) -&amp;gt; &#123;&#123;0, "0"&#125;, &#123;1, "1"&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">   * &lt;li&gt;aMethod(int a, **RowBounds rb**, int b) -&amp;gt; &#123;&#123;0, "0"&#125;, &#123;2, "1"&#125;&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="comment">   * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;Integer, String&gt; names;</span><br><span class="line"><span class="comment">//标志是否使用了**@Param注解**</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> hasParamAnnotation;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ParamNameResolver</span><span class="params">(Configuration config, Method method)</span> </span>&#123;</span><br><span class="line"><span class="comment">//通过反射获取参数类型数组</span></span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"><span class="comment">//获取方法上的二维数组注解</span></span><br><span class="line">    <span class="keyword">final</span> Annotation[][] paramAnnotations = method.getParameterAnnotations();</span><br><span class="line"><span class="comment">//这个map会在最后转化成不可变容器集合unmodifiableSortedMap</span></span><br><span class="line">    <span class="keyword">final</span> SortedMap&lt;Integer, String&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">int</span> paramCount = paramAnnotations.length;</span><br><span class="line">    <span class="comment">//遍历注解 get names from @Param annotations</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> paramIndex = <span class="number">0</span>; paramIndex &lt; paramCount; paramIndex++) &#123;</span><br><span class="line"><span class="comment">//判断特殊类型RowBounds或者ResultHandler，发现则直接跳过本次遍历</span></span><br><span class="line">      <span class="keyword">if</span> (isSpecialParameter(paramTypes[paramIndex])) &#123;</span><br><span class="line">        <span class="comment">// skip special parameters</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      String name = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (Annotation annotation : paramAnnotations[paramIndex]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Param) &#123;</span><br><span class="line"><span class="comment">//只要出现Param注解一次立刻设置标志hasParamAnnotation，结束遍历返回指定的name</span></span><br><span class="line">          hasParamAnnotation = <span class="keyword">true</span>;</span><br><span class="line">          name = ((Param) annotation).value();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//判断是否有特殊name</span></span><br><span class="line">      <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// @Param没有指定，根据Configuration.useActualParamName（默认true）是否使用实际名称</span></span><br><span class="line">        <span class="keyword">if</span> (config.isUseActualParamName()) &#123;</span><br><span class="line"><span class="comment">//getActualParamName在下面解析，ParamNameUtil.getParamNames(method).get(paramIndex);</span></span><br><span class="line">          name = getActualParamName(method, paramIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 使用索引值use the parameter index as the name ("0", "1", ...)</span></span><br><span class="line">          name = String.valueOf(map.size());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//记录到map集合</span></span><br><span class="line">      map.put(paramIndex, name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//初始化成不可变集合</span></span><br><span class="line">    names = Collections.unmodifiableSortedMap(map);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//判断是否是RowBounds和ResultHandler两种类型的参数</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSpecialParameter</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RowBounds<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>) || <span class="title">ResultHandler</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="comment">//获取参数名称的工具类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamNameUtil</span> </span>&#123;</span><br><span class="line"><span class="comment">//Method和Constructor的父类都是Executable</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getParamNames</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getParameterNames(method);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getParamNames</span><span class="params">(Constructor&lt;?&gt; constructor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getParameterNames(constructor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getParameterNames</span><span class="params">(Executable executable)</span> </span>&#123;</span><br><span class="line"><span class="comment">//通过父类Executable获取参数列表的名字集合</span></span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(executable.getParameters()).map(Parameter::getName).collect(Collectors.toList());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">ParamNameUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>解析完ParamNameResolver的功能，回到MethodSignature继续研究。MethodSignature也是MapperMethod中定义的内部类，其中封装了Mapper接口中定义的方法的相关信息：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSignature</span> </span>&#123;</span><br><span class="line"><span class="comment">//...省略字段下面介绍</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MethodSignature</span><span class="params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> </span>&#123;</span><br><span class="line"><span class="comment">//解析方法类型信息，具体在之前反射工具箱一章提及</span></span><br><span class="line">      Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface);</span><br><span class="line">      <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> Class&lt;?&gt;) &#123;</span><br><span class="line">        <span class="keyword">this</span>.returnType = (Class&lt;?&gt;) resolvedReturnType;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resolvedReturnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        <span class="keyword">this</span>.returnType = (Class&lt;?&gt;) ((ParameterizedType) resolvedReturnType).getRawType();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.returnType = method.getReturnType();</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//返回值类型是否为void</span></span><br><span class="line">      <span class="keyword">this</span>.returnsVoid = <span class="keyword">void</span><span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">returnType</span>)</span>;</span><br><span class="line"><span class="comment">//返回值类型是否为Collection或者数组</span></span><br><span class="line">      <span class="keyword">this</span>.returnsMany = configuration.getObjectFactory().isCollection(<span class="keyword">this</span>.returnType) || <span class="keyword">this</span>.returnType.isArray();</span><br><span class="line"><span class="comment">//返回值是否为Cursor类型</span></span><br><span class="line">      <span class="keyword">this</span>.returnsCursor = Cursor<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">returnType</span>)</span>;</span><br><span class="line"><span class="comment">//是否Optional值容器</span></span><br><span class="line">      <span class="keyword">this</span>.returnsOptional = Optional<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">this</span>.<span class="title">returnType</span>)</span>;</span><br><span class="line"><span class="comment">//若Methodsignature对应方法的返回值是Map且指定了@MapKey 注解，则使用getMapKey（）方法处理</span></span><br><span class="line">      <span class="keyword">this</span>.mapKey = getMapKey(method);</span><br><span class="line">      <span class="keyword">this</span>.returnsMap = <span class="keyword">this</span>.mapKey != <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//rowBoundsIndex(RowBounds参数位置)和 resultHandlerIndex（ResultHandler参数位置）字段</span></span><br><span class="line">      <span class="keyword">this</span>.rowBoundsIndex = getUniqueParamIndex(method, RowBounds<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">      <span class="keyword">this</span>.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//创建ParamNameResolver对象,后面会重点介绍getNamedParams方法</span></span><br><span class="line">      <span class="keyword">this</span>.paramNameResolver = <span class="keyword">new</span> ParamNameResolver(configuration, method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//getUniqueParamIndex主要功能是查找指定参数类型在方法参数的索引位置</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Integer <span class="title">getUniqueParamIndex</span><span class="params">(Method method, Class&lt;?&gt; paramType)</span> </span>&#123;</span><br><span class="line">      Integer index = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">final</span> Class&lt;?&gt;[] argTypes = method.getParameterTypes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramType.isAssignableFrom(argTypes[i])) &#123;</span><br><span class="line">          <span class="keyword">if</span> (index == <span class="keyword">null</span>) &#123;</span><br><span class="line">            index = i;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//RowBounds和ResultHandler类型的参数只能有一个，不能重复出现</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(method.getName() + <span class="string">" cannot have multiple "</span> + paramType.getSimpleName() + <span class="string">" parameters"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> index;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>与语法有重要关系过程就在这里，ParamNameResolver有一个非常重要的方法getNamedParams，负责将args[]数组（用户传入的实参列表）转换成SQL语句对应的参数列表。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * A single non-special parameter is returned without a name.</span></span><br><span class="line"><span class="comment">   * Multiple parameters are named using the naming rule.</span></span><br><span class="line"><span class="comment">   * In addition to the default names, this method also adds the generic names (param1, param2,</span></span><br><span class="line"><span class="comment">   * ...).</span></span><br><span class="line"><span class="comment">   * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getNamedParams</span><span class="params">(Object[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> paramCount = names.size();</span><br><span class="line"><span class="comment">//没有任何参数</span></span><br><span class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span> || paramCount == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//如果没有指定@Param或者参数只有一个，直接返回第一个参数</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasParamAnnotation &amp;&amp; paramCount == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> args[names.firstKey()];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> Map&lt;String, Object&gt; param = <span class="keyword">new</span> ParamMap&lt;&gt;();</span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;Integer, String&gt; entry : names.entrySet()) &#123;</span><br><span class="line"><span class="comment">//将names属性SortedMap&lt;Integer，String&gt;类型反转</span></span><br><span class="line"><span class="comment">//names的value（参数名）为param新集合的key，names的key（参数索引）为param新集合的value</span></span><br><span class="line">        param.put(entry.getValue(), args[entry.getKey()]);</span><br><span class="line">        <span class="comment">//参数索引添加前缀、并且从i + 1（1、2、3开始）</span></span><br><span class="line"><span class="comment">//例子：add generic param names (param1, param2, ...)</span></span><br><span class="line">        <span class="keyword">final</span> String genericParamName = GENERIC_NAME_PREFIX + String.valueOf(i + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// ensure not to overwrite parameter named with @Param</span></span><br><span class="line"><span class="comment">//确保不会覆盖@Param指定的特殊参数名，换而言之就是通过param1或者@Param都可以取到同样的参数</span></span><br><span class="line">        <span class="keyword">if</span> (!names.containsValue(genericParamName)) &#123;</span><br><span class="line">          param.put(genericParamName, args[entry.getKey()]);</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> param;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><blockquote><p>最后就是结果集处理，也是MapperMethod重要的方法execute，它会根据SQL语句的类型调用SqlSession对应的方法完成数据库操作。如果是是指定了ResultHandler，那就通过org.apache.ibatis.binding.MapperMethod#executeWithResultHandler处理结果集。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line"><span class="comment">//method.convertArgsToSqlCommandParam会调用上面解释到的ParamNameResolver.getNamedParams</span></span><br><span class="line"><span class="comment">//rowCountResult处理方法返回值影响行数rowCount，进行结果类型转换</span></span><br><span class="line">      <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SELECT:</span><br><span class="line">        <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//返回的是Collection接口实现类或者数组，由executeForMany方法处理</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line"><span class="comment">//返回的是Map集合结果，由executeForMap方法处理</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line"><span class="comment">//返回的是Cursor结果</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//最后查询结果只有一条</span></span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line"><span class="comment">//如果是Optional包装返回值</span></span><br><span class="line">          <span class="keyword">if</span> (method.returnsOptional()</span><br><span class="line">              &amp;&amp; (result == <span class="keyword">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class="line"><span class="comment">//那就进行Optional包装</span></span><br><span class="line">            result = Optional.ofNullable(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//边界检查</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Mapper method '"</span> + command.getName()</span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + method.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeWithResultHandler</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//获取SOL语句对应的MappedStatement对象，MappedStatement中记录了SQL语句相关信息，</span></span><br><span class="line">    MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(command.getName());</span><br><span class="line"><span class="comment">//StatementType不是存储过程（CALLABLE），并且没有指定ResultMap或ResultType，直接抛出BindingException</span></span><br><span class="line">    <span class="keyword">if</span> (!StatementType.CALLABLE.equals(ms.getStatementType())</span><br><span class="line">        &amp;&amp; <span class="keyword">void</span><span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">ms</span>.<span class="title">getResultMaps</span>().<span class="title">get</span>(0).<span class="title">getType</span>())) </span>&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"method "</span> + command.getName()</span><br><span class="line">          + <span class="string">" needs either a @ResultMap annotation, a @ResultType annotation,"</span></span><br><span class="line">          + <span class="string">" or a resultType attribute in XML so a ResultHandler can be used as a parameter."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line"><span class="comment">//该方法是否有RowBounds类型参数</span></span><br><span class="line">    <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line"><span class="comment">//获取指定RowBounds类型的参数</span></span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line"><span class="comment">//通过sqlSession.select查询方法指定查询，并由指定的ResultHandler处理结果对象</span></span><br><span class="line">      sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sqlSession.select(command.getName(), param, method.extractResultHandler(args));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Collection接口实现类或者数组处理过程</span></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">executeForMany</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    List&lt;E&gt; result;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line"><span class="comment">//参考上几句</span></span><br><span class="line">    <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      result = sqlSession.selectList(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = sqlSession.selectList(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//将结果集转换为数组或Collection集合 issue #510 Collections &amp; arrays support</span></span><br><span class="line">    <span class="keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (method.getReturnType().isArray()) &#123;</span><br><span class="line">        <span class="keyword">return</span> convertToArray(result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//根据Configuration对结果对象的转换类型</span></span><br><span class="line">        <span class="keyword">return</span> convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToDeclaredCollection</span><span class="params">(Configuration config, List&lt;E&gt; list)</span> </span>&#123;</span><br><span class="line"><span class="comment">//使用前面介绍的ObjectFactory对象工厂，通过反射方式创建集合对象</span></span><br><span class="line">    Object collection = config.getObjectFactory().create(method.getReturnType());</span><br><span class="line"><span class="comment">//创建collection集合反射对象MetaObject，实际上还是调用的CCollection接口的addAll方法</span></span><br><span class="line">    MetaObject metaObject = config.newMetaObject(collection);</span><br><span class="line">    metaObject.addAll(list);</span><br><span class="line">    <span class="keyword">return</span> collection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">private</span> &lt;E&gt; <span class="function">Object <span class="title">convertToArray</span><span class="params">(List&lt;E&gt; list)</span> </span>&#123;</span><br><span class="line"><span class="comment">//获取数组的元素类型</span></span><br><span class="line">    Class&lt;?&gt; arrayComponentType = method.getReturnType().getComponentType();</span><br><span class="line"><span class="comment">//创建数组对象</span></span><br><span class="line">    Object array = Array.newInstance(arrayComponentType, list.size());</span><br><span class="line"><span class="comment">//判断数组元素是否基本原始类型的</span></span><br><span class="line">    <span class="keyword">if</span> (arrayComponentType.isPrimitive()) &#123;</span><br><span class="line"><span class="comment">//将list每一项数据都放置到数组中</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">        Array.set(array, i, list.get(i));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> array;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//否直接转数组</span></span><br><span class="line">      <span class="keyword">return</span> list.toArray((E[])array);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//返回的是Map集合结果，由executeForMap方法处理，Cursor处理方法是sqlSession.selectCursor</span></span><br><span class="line"><span class="keyword">private</span> &lt;K, V&gt; <span class="function">Map&lt;K, V&gt; <span class="title">executeForMap</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Map&lt;K, V&gt; result;</span><br><span class="line"><span class="comment">//转化成实参</span></span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    <span class="keyword">if</span> (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line"><span class="comment">//调用selectMap方法返回结果就是Map类型</span></span><br><span class="line">      result = sqlSession.selectMap(command.getName(), param, method.getMapKey(), rowBounds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = sqlSession.selectMap(command.getName(), param, method.getMapKey());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-8、binding-模块&quot;&gt;&lt;a href=&quot;#2-8、binding-模块&quot; class=&quot;headerlink&quot; title=&quot;2.8、binding 模块&quot;&gt;&lt;/a&gt;2.8、binding 模块&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;org.apach
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：Transaction事务</title>
    <link href="https://caochikai.github.io/2019/12/25/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATransaction%E4%BA%8B%E5%8A%A1/"/>
    <id>https://caochikai.github.io/2019/12/25/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATransaction%E4%BA%8B%E5%8A%A1/</id>
    <published>2019-12-25T12:51:00.000Z</published>
    <updated>2019-12-25T12:52:55.969Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-7、Transaction事务"><a href="#2-7、Transaction事务" class="headerlink" title="2.7、Transaction事务"></a>2.7、Transaction事务</h1><blockquote><p>控制数据库事务是业务型操作（CRUD）的基本功，Mybatis本身通过Transaction(org.apache.ibatis.transaction)接口对数据库进行了抽象化，具体分析如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**包装数据库连接关于创建、预处理、提交/回滚和关闭的生命周期</span></span><br><span class="line"><span class="comment"> * Wraps a database connection.</span></span><br><span class="line"><span class="comment"> * Handles the connection lifecycle that comprises: </span></span><br><span class="line"><span class="comment"> * its creation, preparation, commit/rollback and close.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**获取数据库连接对象</span></span><br><span class="line"><span class="comment">   * Retrieve inner database connection.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> DataBase connection</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**提交事务</span></span><br><span class="line"><span class="comment">   * Commit inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**回滚事务</span></span><br><span class="line"><span class="comment">   * Rollback inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**关闭数据库连接</span></span><br><span class="line"><span class="comment">   * Close inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**获取事务的超时时间</span></span><br><span class="line"><span class="comment">   * Get transaction timeout if set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Transaction 接口有JdbcTransaction、ManagedTransaction两个实现。ManagedTransaction的实现非常简单，它同样依赖其中的dataSource字段获取连接，但其commit、rollback方法都是空实现，事务的提交和回滚都是依靠容器管理的，关闭方法通过closeConnection字段的值控制数据库连接。JdbcTransaction依赖JDBC Connection控制数据库事务，接下就要进入对JdbcTransaction的分析：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**下面操作方法都是直接使用java.sql.Connection直接进行操作事务，getTimeout是空实现</span></span><br><span class="line"><span class="comment"> *如果autocommit已经开启，那么commit和rollback方法就会被忽略掉</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Transaction&#125; that makes use of the JDBC commit and rollback facilities directly.</span></span><br><span class="line"><span class="comment"> * It relies on the connection retrieved from the dataSource to manage the scope of the transaction.</span></span><br><span class="line"><span class="comment"> * Delays connection retrieval until getConnection() is called.</span></span><br><span class="line"><span class="comment"> * Ignores commit or rollback requests when autocommit is on.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransaction</span> <span class="keyword">implements</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"><span class="comment">//事务对应的数据库连接</span></span><br><span class="line">  <span class="keyword">protected</span> Connection connection;</span><br><span class="line"><span class="comment">//数据库连接对应的数据源</span></span><br><span class="line">  <span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line"><span class="comment">//事务的隔离级别</span></span><br><span class="line">  <span class="keyword">protected</span> TransactionIsolationLevel level;</span><br><span class="line"><span class="comment">//是否自动提交</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">boolean</span> autoCommit;</span><br><span class="line"></span><br><span class="line"> ...省略下面方法和构造器</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>JdbcTransaction、ManagedTransaction两个实现，其对象分别由JdbcTransactionFactory 和Managed TransactionFactory负责创建。这里也使用了工厂方法模式。下面就分析工厂创建产品UML和接口规范：</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-5.png" alt="Transaction.png" title="">                </div>                <div class="image-caption">Transaction.png</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接口默认方法，通常在创建完Transaction后进行自定义配置事务</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NOP</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在指定Connection上创建Transaction</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从指定的DataSource获取数据库连接，并在此连接之上创建事务对象，后面就算配置TransactionIsolationLevel和autoCommit</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(DataSource dataSource, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在实践中，MyBatis通常会与Spring集成使用，数据库的事务是交给Spring进行管理的，以后会介绍Transaction接口的另一实现SpringManagedTransaction。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-7、Transaction事务&quot;&gt;&lt;a href=&quot;#2-7、Transaction事务&quot; class=&quot;headerlink&quot; title=&quot;2.7、Transaction事务&quot;&gt;&lt;/a&gt;2.7、Transaction事务&lt;/h1&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>idea插件第二弹推荐</title>
    <link href="https://caochikai.github.io/2019/12/24/idea%E6%8F%92%E4%BB%B6%E7%AC%AC%E4%BA%8C%E5%BC%B9%E6%8E%A8%E8%8D%90/"/>
    <id>https://caochikai.github.io/2019/12/24/idea%E6%8F%92%E4%BB%B6%E7%AC%AC%E4%BA%8C%E5%BC%B9%E6%8E%A8%E8%8D%90/</id>
    <published>2019-12-24T09:33:00.000Z</published>
    <updated>2019-12-24T09:34:33.622Z</updated>
    
    <content type="html"><![CDATA[<h1 id="idea插件第二弹推荐"><a href="#idea插件第二弹推荐" class="headerlink" title="idea插件第二弹推荐"></a>idea插件第二弹推荐</h1><h2 id="工具收藏——idea推荐插件"><a href="#工具收藏——idea推荐插件" class="headerlink" title="工具收藏——idea推荐插件"></a>工具收藏——idea推荐插件</h2><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><blockquote><p> 工欲善其事必先利其器，博主是个死忠工具派，为了解决一个大问题可能会收集多个工具和方案，然后求证对比出体验报告。后续文章有一大类就是工具类推荐，而本篇文章重点就是idea 安装插件记录，简要记录安装方法快速搭建个性化idea，还有一些关于UI方面插件可谓多不胜数，而且每个人口味不一，请各位自行选择——插件搜索技巧tags为Theme或者UI。</p></blockquote><hr><h2 id="插件列表"><a href="#插件列表" class="headerlink" title="插件列表"></a>插件列表</h2><h3 id="最强大插件卫冕之王——lambda表达式"><a href="#最强大插件卫冕之王——lambda表达式" class="headerlink" title="最强大插件卫冕之王——lambda表达式"></a>最强大插件卫冕之王——<strong>lambda表达式</strong></h3><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>JRebel</td><td>代替springboot dev热部署方案，最方便激活方式</td></tr><tr><td>Lombok</td><td>精简bean，各种功能强大又实用注解，搬砖人的MVP，结合Hutool实在完美</td></tr><tr><td>AceJump</td><td>光标跳跃，替代vim不二之选</td></tr><tr><td>CodeGlance</td><td>代码地图，方便查阅跳转</td></tr><tr><td>MavenHelper</td><td>快速分析maven 包冲突的问题，搜索包名</td></tr><tr><td>MyBatis Log Plugin</td><td>Restore the mybatis generate sql to original whole sql.（拼接完整sql）</td></tr><tr><td>Log Support 2</td><td>快速log.info()，结合Lombok插件注解@Slf4j可以说无敌</td></tr><tr><td>Grep Console</td><td>针对控制台日志不同等级进行染色高亮</td></tr><tr><td>MyBatisCodeHelperPro</td><td>对Mybatis支持非常强，请认真参考<a href="https://gejun123456.github.io/MyBatisCodeHelper-Pro/#/README，提高生产力的工具啊（收费可破解）！" target="_blank" rel="noopener">https://gejun123456.github.io/MyBatisCodeHelper-Pro/#/README，提高生产力的工具啊（收费可破解）！</a></td></tr><tr><td>Free Mybatis plugin</td><td>Mybaits支持跳转，有钱大爷请收费版Mybatis plugin强大破解较少，差评</td></tr><tr><td>Rainbow Brackets</td><td>彩虹括号，多层嵌套代码显示助手</td></tr><tr><td>String Manipulation</td><td>强大的字符串格式转化</td></tr><tr><td>GitToolBox</td><td>git的强大助手，定时拉取代码、代码逐行展示日志（各种辅助金手指）</td></tr><tr><td>RestfulToolkit</td><td>辅助通过URL定位Controller，简洁版的PostMan</td></tr><tr><td>Alibaba Cloud Toolkit</td><td>结合阿里云（非阿里也支持），多节点发布工具加强力linux客户端</td></tr><tr><td>stackoverflow</td><td>stackoverflow快速搜索bug插件</td></tr><tr><td>Translation</td><td>最强大的翻译插件，支持中文替换英文，解决起英文变量名难的重度患者</td></tr><tr><td>Key Promoter X</td><td>所有操作的快捷键提示，忘记鼠标真的</td></tr><tr><td>Cyan Light Theme</td><td>A light theme，偏青色对眼睛很柔和舒服，黑暗主题实在不适应</td></tr><tr><td>Hiberbee theme</td><td>黑暗主题的色彩分明版本</td></tr></tbody></table><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>2012年java程序员可以说非常吃香，今年2019从业人数暴增，职业发展挑战变得越来越大！现在流行自动构建和自动部署CI，开发运维一体化docker，整个互联网都在追求敏捷开发的今天。掌握一款追求效率功能的IDE非常重要，很多群和公众号对ide和Eclipse争议很大。但请记住斯大林名言——落后就要挨打，ide本身代表高效，但是插件也别装太多，免得启动还要半天哈哈哈😀</li><li>（首推）慕课网免费教程：<a href="http://www.imooc.com/learn/924" target="_blank" rel="noopener">IntelliJ IDEA神器使用技巧</a></li><li>（推荐）尚硅谷IDEA视频教程：链接：<a href="https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQ，密码：n7hn" target="_blank" rel="noopener">https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQ，密码：n7hn</a></li><li>看完上面两个教程，你会怀疑自己用的idea是假的，原来写代码还可以这样的。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;idea插件第二弹推荐&quot;&gt;&lt;a href=&quot;#idea插件第二弹推荐&quot; class=&quot;headerlink&quot; title=&quot;idea插件第二弹推荐&quot;&gt;&lt;/a&gt;idea插件第二弹推荐&lt;/h1&gt;&lt;h2 id=&quot;工具收藏——idea推荐插件&quot;&gt;&lt;a href=&quot;#工具收
      
    
    </summary>
    
    
      <category term="tool" scheme="https://caochikai.github.io/categories/tool/"/>
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
      <category term="plugin" scheme="https://caochikai.github.io/tags/plugin/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：DataSource数据源</title>
    <link href="https://caochikai.github.io/2019/12/23/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ADataSource%E6%95%B0%E6%8D%AE%E6%BA%90/"/>
    <id>https://caochikai.github.io/2019/12/23/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ADataSource%E6%95%B0%E6%8D%AE%E6%BA%90/</id>
    <published>2019-12-23T10:20:00.000Z</published>
    <updated>2020-03-21T08:55:38.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-6、DataSource数据源"><a href="#2-6、DataSource数据源" class="headerlink" title="2.6、DataSource数据源"></a>2.6、DataSource数据源</h1><blockquote><p>数据源组件都要实现javax.sql.DataSource接口，常见的有Druid、HikariCP和C3PO。Mybatis提供两个实现：PooledDataSource和UnpooledDataSource，通过工厂模式创建。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-4.png" alt="DataSourceFactory" title="">                </div>                <div class="image-caption">DataSourceFactory</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//通过Properties 配置数据源</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line"><span class="comment">//工厂获取数据源实例接口</span></span><br><span class="line">  <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-2-DataSourceFactory"><a href="#2-6-2-DataSourceFactory" class="headerlink" title="2.6.2 DataSourceFactory"></a>2.6.2 DataSourceFactory</h2><blockquote><p>数据源工厂接口的实现类是DataSourceFactory，UnpooledDataSourceFactory和PooledDataSource是具体产品实现类，JndiDataSourceFactory是依赖JNDI服务从容器中获取用户配置的DataSource，我们以UnpooledDataSourceFactory举例如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.unpooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.SystemMetaObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnpooledDataSourceFactory</span> <span class="keyword">implements</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//属性前缀为driver.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DRIVER_PROPERTY_PREFIX = <span class="string">"driver."</span>;</span><br><span class="line"><span class="comment">//driver.文字长度</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DRIVER_PROPERTY_PREFIX_LENGTH = DRIVER_PROPERTY_PREFIX.length();</span><br><span class="line"><span class="comment">//数据源属性</span></span><br><span class="line">  <span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">UnpooledDataSourceFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.dataSource = <span class="keyword">new</span> UnpooledDataSource();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    Properties driverProperties = <span class="keyword">new</span> Properties();</span><br><span class="line"><span class="comment">//根据dataSource创建MetaObject （反射获取该对象元数据）</span></span><br><span class="line">    MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);</span><br><span class="line">    <span class="keyword">for</span> (Object key : properties.keySet()) &#123;</span><br><span class="line">      String propertyName = (String) key;</span><br><span class="line"><span class="comment">//检查属性名称是否以driver.开头</span></span><br><span class="line">      <span class="keyword">if</span> (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123;</span><br><span class="line">        String value = properties.getProperty(propertyName);</span><br><span class="line"><span class="comment">//截取driver.后记录到driverProperties成员变量</span></span><br><span class="line">        driverProperties.setProperty(propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metaDataSource.hasSetter(propertyName)) &#123;</span><br><span class="line"><span class="comment">//判断是否有该对象set对应的属性名</span></span><br><span class="line">        String value = (String) properties.get(propertyName);</span><br><span class="line"><span class="comment">//根据属性类型进行转化</span></span><br><span class="line">        Object convertedValue = convertValue(metaDataSource, propertyName, value);</span><br><span class="line">        metaDataSource.setValue(propertyName, convertedValue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceException(<span class="string">"Unknown DataSource property: "</span> + propertyName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (driverProperties.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      metaDataSource.setValue(<span class="string">"driverProperties"</span>, driverProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//支持属性类型进行类型转换，主要是Integer、Long、Boolean三种类型的转换</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">convertValue</span><span class="params">(MetaObject metaDataSource, String propertyName, String value)</span> </span>&#123;</span><br><span class="line">    Object convertedValue = value;</span><br><span class="line">    Class&lt;?&gt; targetType = metaDataSource.getSetterType(propertyName);</span><br><span class="line">    <span class="keyword">if</span> (targetType == Integer<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Integer.valueOf(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetType == Long<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">long</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Long.valueOf(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetType == Boolean<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Boolean.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> convertedValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-3-UnpooledDataSource"><a href="#2-6-3-UnpooledDataSource" class="headerlink" title="2.6.3 UnpooledDataSource"></a>2.6.3 UnpooledDataSource</h2><blockquote><p>javax.sql.DataSource接口在数据源模块中扮演了产品接口的角色，MyBatis提供了两个DataSource 接口的实现类，分别是UnpooledDataSource和PooledDataSource，它们扮演着具体产品类的角色。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.unpooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnpooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"><span class="comment">//数据源类加载器</span></span><br><span class="line">  <span class="keyword">private</span> ClassLoader driverClassLoader;</span><br><span class="line"><span class="comment">//配置属性对象</span></span><br><span class="line">  <span class="keyword">private</span> Properties driverProperties;</span><br><span class="line"><span class="comment">//缓存注册过的数据源驱动</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Driver&gt; registeredDrivers = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//驱动</span></span><br><span class="line">  <span class="keyword">private</span> String driver;</span><br><span class="line"><span class="comment">//数据库URL</span></span><br><span class="line">  <span class="keyword">private</span> String url;</span><br><span class="line"><span class="comment">//用户名和密码 </span></span><br><span class="line"> <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line"><span class="comment">//是否自动提交</span></span><br><span class="line">  <span class="keyword">private</span> Boolean autoCommit;</span><br><span class="line"><span class="comment">//默认事务隔离等级</span></span><br><span class="line">  **<span class="keyword">private</span> Integer defaultTransactionIsolationLevel;</span><br><span class="line"><span class="comment">//网络超时时间</span></span><br><span class="line">  <span class="keyword">private</span> Integer defaultNetworkTimeout;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers();</span><br><span class="line">    <span class="keyword">while</span> (drivers.hasMoreElements()) &#123;</span><br><span class="line">      Driver driver = drivers.nextElement();</span><br><span class="line"><span class="comment">//向DriverManager添加JDBC驱动</span></span><br><span class="line">      registeredDrivers.put(driver.getClass().getName(), driver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">doGetConnection</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//初始化驱动Driver对象</span></span><br><span class="line">    initializeDriver();</span><br><span class="line"><span class="comment">//创建真正的数据库链接对象</span></span><br><span class="line">    Connection connection = DriverManager.getConnection(url, properties);</span><br><span class="line"><span class="comment">//配置autoCommit、defaultTransactionIsolationLevel和defaultNetworkTimeout</span></span><br><span class="line">    configureConnection(connection);</span><br><span class="line">    <span class="keyword">return</span> connection;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeDriver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//判断注册过，避免重复</span></span><br><span class="line">    <span class="keyword">if</span> (!registeredDrivers.containsKey(driver)) &#123;</span><br><span class="line">      Class&lt;?&gt; driverType;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//通过对应的类加载器获得对应的driverType </span></span><br><span class="line">        <span class="keyword">if</span> (driverClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">          driverType = Class.forName(driver, <span class="keyword">true</span>, driverClassLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          driverType = Resources.classForName(driver);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// DriverManager requires the driver to be loaded via the system ClassLoader.</span></span><br><span class="line">        <span class="comment">// http://www.kfu.com/~nsayer/Java/dyn-jdbc.html</span></span><br><span class="line"><span class="comment">//真正创建Driver过程</span></span><br><span class="line">        Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();</span><br><span class="line"><span class="comment">//DriverProxy是UnpooledDataSource的内部类，是Driver的静态代理类</span></span><br><span class="line">        DriverManager.registerDriver(<span class="keyword">new</span> DriverProxy(driverInstance));</span><br><span class="line">        registeredDrivers.put(driver, driverInstance);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Error setting driver on UnpooledDataSource. Cause: "</span> + e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-4-PooledDataSource"><a href="#2-6-4-PooledDataSource" class="headerlink" title="2.6.4 PooledDataSource"></a>2.6.4 PooledDataSource</h2><blockquote><p>PooledDataSource支持数据库连接池的数据源，依赖UnpooledDataSource创建数据库连接。而且PooledDataSource 并不会直接管理java.sql.Connection对象，而是管理PooledConnection对象。在PooledConnection中封装了真正的数据库连接对象（java.sql.Connection）以及其代理对象，这里的代理对象是通过JDK动态代理产生的。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PooledConnection</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"><span class="comment">//关闭的方法名称，并不是真正关闭而是返还到池子</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLOSE = <span class="string">"close"</span>;</span><br><span class="line"><span class="comment">//动态代理的类Class</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] IFACES = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; Connection<span class="class">.<span class="keyword">class</span> &#125;</span>;</span><br><span class="line"><span class="comment">//connection的哈希值</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> hashCode;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PooledDataSource dataSource;</span><br><span class="line"><span class="comment">//真正的数据库连接</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection realConnection;</span><br><span class="line"><span class="comment">//数据库连接的代理对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection proxyConnection;</span><br><span class="line"><span class="comment">//取出的时间戳</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> checkoutTimestamp;</span><br><span class="line"><span class="comment">//创建的时间戳</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> createdTimestamp;</span><br><span class="line"><span class="comment">//最近一次使用的时间戳</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> lastUsedTimestamp;</span><br><span class="line"><span class="comment">//由数据库URL、用户名和密码计算出来的hash值，可用于标识该连接所在的连接池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> connectionTypeCode;</span><br><span class="line"><span class="comment">//检查PooledConnection是否有效，防止归还依然使用该连接操作数据库</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> valid;</span><br><span class="line">...省略一大堆geter/seter方法</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Required for InvocationHandler implementation.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> proxy  - not used</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> method - the method to be executed</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args   - the parameters to be passed to the method</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> java.lang.reflect.InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[])</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String methodName = method.getName();</span><br><span class="line"><span class="comment">//如果是CLOSE方法就向dataSource归还连接池，而不是直接关闭</span></span><br><span class="line">    <span class="keyword">if</span> (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123;</span><br><span class="line">      dataSource.pushConnection(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="comment">// issue #579 toString() should never fail </span></span><br><span class="line">        <span class="comment">// throw an SQLException instead of a Runtime</span></span><br><span class="line"><span class="comment">//检查valid是否有效，无效直接抛出异常SQLException</span></span><br><span class="line">        checkConnection();</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//调用真正的数据库对象的方法</span></span><br><span class="line">      <span class="keyword">return</span> method.invoke(realConnection, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PoolState 管理PooledConnection对象状态的组件，它通过两个ArrayList<br><PooledConnection>集合分别管理<strong>空闲状态</strong>的连接和<strong>活跃状态</strong>的连接，定义如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolState</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> PooledDataSource dataSource;</span><br><span class="line"><span class="comment">//空闲状态的连接</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; idleConnections = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//**活跃状态**的连接</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; activeConnections = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//以下就是一些统计字段</span></span><br><span class="line"><span class="comment">//请求数据库次数</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> requestCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//获取连接累计的时间</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedRequestTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//checkoutTime表示应用从连接池中取出连接，到归还连接这段时长，</span></span><br><span class="line"><span class="comment">//accumulatedCheckoutTime记录了所有连接累积的checkoutTime时长</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//累计超时连接个数</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> claimedOverdueConnectionCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//累计超时时间</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTimeOfOverdueConnections = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//累计等待时间</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedWaitTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//等待次数</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> hadToWaitCount = <span class="number">0</span>;、</span><br><span class="line"><span class="comment">//无效的连接数</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> badConnectionCount = <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PooledDataSource中管理的真正的数据库连接对象是由PooledDataSource中封装的UnpooledDataSource对象创建的，并由PoolState管理所有连接的状态。PooledDataSource中核心字段如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a simple, synchronous, thread-safe database connection pool.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"><span class="comment">//管理连接池状态以及统计信息</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PoolState state = <span class="keyword">new</span> PoolState(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//UnpooledDataSource对象，用于生成真实的数据库连接对象，构造函数中会初始化该字段</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> UnpooledDataSource dataSource;</span><br><span class="line"><span class="comment">//默认的最大活跃连接数量</span></span><br><span class="line">  <span class="comment">// OPTIONAL CONFIGURATION FIELDS</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumActiveConnections = <span class="number">10</span>;、</span><br><span class="line"><span class="comment">//最大空闲连接数量</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumIdleConnections = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//最长的checkout等待时间</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumCheckoutTime = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">//在无法获取连接时候，线程的等待时长</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolTimeToWait = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">//最大容忍的本地无效连接数量，如果大于（最大活跃连接数量 + 最大空闲连接数量）,直接抛出异常</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumLocalBadConnectionTolerance = <span class="number">3</span>;</span><br><span class="line"><span class="comment">//检查数据库是否SQL语句</span></span><br><span class="line">  <span class="keyword">protected</span> String poolPingQuery = <span class="string">"NO PING QUERY SET"</span>;</span><br><span class="line"><span class="comment">//是否允许发送上面的poolPingQuery 测试SQL语句</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">boolean</span> poolPingEnabled;</span><br><span class="line"><span class="comment">//当连接超过poo1PingconnectionsNotUsedFor毫秒未使用时，会发送一次测试sQL语句，检测连接是否正常</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolPingConnectionsNotUsedFor;</span><br><span class="line"><span class="comment">//根据数据库的URL、用户名和密码生成的一个hash值，该哈希值用于标志着当前的连接池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> expectedConnectionTypeCode;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PooledDataSource.getConnection()方法首先会调用PooledDataSource.popConnection()方法获取PooledConnection对象，然后通过PooledConnection.getProxyConnection()方法获取数据库连接的代理对象。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">popConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> countedWait = <span class="keyword">false</span>;</span><br><span class="line">    PooledConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> localBadConnectionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (state) &#123;<span class="comment">//同步锁</span></span><br><span class="line"><span class="comment">//检测是否有空闲连接</span></span><br><span class="line">        <span class="keyword">if</span> (!state.idleConnections.isEmpty()) &#123;</span><br><span class="line">          <span class="comment">// Pool has available connection</span></span><br><span class="line"><span class="comment">//获取空闲连接</span></span><br><span class="line">          conn = state.idleConnections.remove(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Checked out connection "</span> + conn.getRealHashCode() + <span class="string">" from pool."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//没有空闲的 Pool does not have available connection</span></span><br><span class="line"><span class="comment">//判断当前活跃连接数量是否已经超过的最大活跃数量限制</span></span><br><span class="line">          <span class="keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</span><br><span class="line">            <span class="comment">// 没有就创建一个并封装成PooledConnection</span></span><br><span class="line">            conn = <span class="keyword">new</span> PooledConnection(dataSource.getConnection(), <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Created connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//超过了限制，获取最先创建的活跃连接</span></span><br><span class="line">            PooledConnection oldestActiveConnection = state.activeConnections.get(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//获取其超时时间，判断是否已经超时</span></span><br><span class="line">            <span class="keyword">long</span> longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</span><br><span class="line">            <span class="keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</span><br><span class="line"><span class="comment">// 对超时连接进行统计</span></span><br><span class="line">              state.claimedOverdueConnectionCount++;</span><br><span class="line">              state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</span><br><span class="line">              state.accumulatedCheckoutTime += longestCheckoutTime;</span><br><span class="line"><span class="comment">//并移出活跃连接集合</span></span><br><span class="line">              state.activeConnections.remove(oldestActiveConnection);</span><br><span class="line"><span class="comment">//如果连接超时且未提交，则自动回滚（省略try/catch代码块）</span></span><br><span class="line">              <span class="keyword">if</span> (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                  oldestActiveConnection.getRealConnection().rollback();</span><br><span class="line">              &#125;</span><br><span class="line"><span class="comment">//创建新Pooledconnection对象，但是真正的数据库连接并未创建新的</span></span><br><span class="line">              conn = <span class="keyword">new</span> PooledConnection(oldestActiveConnection.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">              conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp());</span><br><span class="line">              conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());</span><br><span class="line"><span class="comment">//将超时连接设置成为无效状态</span></span><br><span class="line">              oldestActiveConnection.invalidate();</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Claimed overdue connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//无空闲连接、无法创建新连接且无超时连接，则只能阻塞等待</span></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!countedWait) &#123;</span><br><span class="line">                  state.hadToWaitCount++;<span class="comment">//统计等待信息</span></span><br><span class="line">                  countedWait = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Waiting as long as "</span> + poolTimeToWait + <span class="string">" milliseconds for connection."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">long</span> wt = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//阻塞等待poolTimeToWait，下面就统计一下等待信息</span></span><br><span class="line">                state.wait(poolTimeToWait);</span><br><span class="line">                state.accumulatedWaitTime += System.currentTimeMillis() - wt;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// ping to server and check the connection is valid or not</span></span><br><span class="line">          <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">              conn.getRealConnection().rollback();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//配置PooledConnection的属性，connectionTypeCode由url + username + password组成后的hashCode</span></span><br><span class="line">            conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));</span><br><span class="line"><span class="comment">//记录checkout时间</span></span><br><span class="line">            conn.setCheckoutTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="comment">//最近一次使用的时间</span></span><br><span class="line">            conn.setLastUsedTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="comment">//进行相关统计</span></span><br><span class="line">            state.activeConnections.add(conn);</span><br><span class="line">            state.requestCount++;</span><br><span class="line">            state.accumulatedRequestTime += System.currentTimeMillis() - t;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"A bad connection ("</span> + conn.getRealHashCode() + <span class="string">") was returned from the pool, getting another connection."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//无效连接数量统计</span></span><br><span class="line">            state.badConnectionCount++;</span><br><span class="line">            localBadConnectionCount++;</span><br><span class="line">            conn = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (localBadConnectionCount &gt; (poolMaximumIdleConnections + poolMaximumLocalBadConnectionTolerance)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"PooledDataSource: Could not get a good connection to the database."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"PooledDataSource: Could not get a good connection to the database."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>看名字就知道（Pool）是支持连接池，那通过前面对PooledConnection.invoke方法的分析我们知道，当调用连接的代理对象的close方法时，并未关闭真正的数据连接，而是代理调用PooledDataSource.pushConnection方法将PooledConnection 对象归还给连接池。下面就分析归还规程是如何实现的：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pushConnection</span><span class="params">(PooledConnection conn)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//同步state</span></span><br><span class="line">    <span class="keyword">synchronized</span> (state) &#123;</span><br><span class="line"><span class="comment">//从activeConnections集合里面移除该对象</span></span><br><span class="line">      state.activeConnections.remove(conn);</span><br><span class="line"><span class="comment">//检查连接对象是否有效</span></span><br><span class="line">      <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line"><span class="comment">//若当前空闲连接集合数量小于最大空闲阈值，并且该连接的connectionTypeCode和数据源本身的hashCode一致</span></span><br><span class="line">        <span class="keyword">if</span> (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123;</span><br><span class="line"><span class="comment">//累计checkout时长</span></span><br><span class="line">          state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">          <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">            conn.getRealConnection().rollback();</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//为返还连接对象包装成PooledConnection </span></span><br><span class="line">          PooledConnection newConn = <span class="keyword">new</span> PooledConnection(conn.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">          state.idleConnections.add(newConn);<span class="comment">//添加到空闲集合idleConnections</span></span><br><span class="line">          newConn.setCreatedTimestamp(conn.getCreatedTimestamp());</span><br><span class="line">          newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());</span><br><span class="line"><span class="comment">//将原PooledConnection设置为无效</span></span><br><span class="line">          conn.invalidate();</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Returned connection "</span> + newConn.getRealHashCode() + <span class="string">" to pool."</span>);</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//唤醒通知其他等待阻塞的线程</span></span><br><span class="line">          state.notifyAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//空闲连接到达上限或者hashCode不匹配（意味着不属于该连接池）</span></span><br><span class="line">          state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">          <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">            conn.getRealConnection().rollback();</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//关闭真正的数据库连接</span></span><br><span class="line">          conn.getRealConnection().close();</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Closed connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//设置成无效</span></span><br><span class="line">          conn.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">"A bad connection ("</span> + conn.getRealHashCode() + <span class="string">") attempted to return to the pool, discarding connection."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//统计无效连接数量</span></span><br><span class="line">        state.badConnectionCount++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><blockquote><p>在上面代码分析当中，我们可以多次看见isValid()方法，除了校验PooledConnection.valid属性外，还会调用dataSource.pingConnection方法让数据库执行poolPingQuery的测试SQL数据库语句，下面让我讨论下关于校验连接有效的过程：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**检查连接有效性</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> True if the connection is usable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> valid &amp;&amp; realConnection != <span class="keyword">null</span> &amp;&amp; dataSource.pingConnection(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/**通过发送ping检查SQL判断当前数据库连接是否已经失效，毕竟数据库对长时间的链接也会做失效处理</span></span><br><span class="line"><span class="comment">   * Method to check to see if a connection is still usable</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> conn - the connection to check</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> True if the connection is still usable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">pingConnection</span><span class="params">(PooledConnection conn)</span> </span>&#123;</span><br><span class="line"><span class="comment">//ping操作成功的标志</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//先检查数据库连接是否已经关闭</span></span><br><span class="line">      result = !conn.getRealConnection().isClosed();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is BAD: "</span> + e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//1、如果没关闭进一步检查</span></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line"><span class="comment">//2、检查SQL检查的心跳开关</span></span><br><span class="line">      <span class="keyword">if</span> (poolPingEnabled) &#123;</span><br><span class="line"><span class="comment">//3、检查poolPingConnectionsNotUsedFor是否已经超过（当前时间距离最近一次使用的时间间距）</span></span><br><span class="line">        <span class="keyword">if</span> (poolPingConnectionsNotUsedFor &gt;= <span class="number">0</span> &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Testing connection "</span> + conn.getRealHashCode() + <span class="string">" ..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Connection realConn = conn.getRealConnection();</span><br><span class="line"><span class="comment">//下面是执行SQL测试语句</span></span><br><span class="line">            <span class="keyword">try</span> (Statement statement = realConn.createStatement()) &#123;</span><br><span class="line">              statement.executeQuery(poolPingQuery).close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!realConn.getAutoCommit()) &#123;</span><br><span class="line">              realConn.rollback();</span><br><span class="line">            &#125;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is GOOD!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">"Execution of ping query '"</span> + poolPingQuery + <span class="string">"' failed: "</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              conn.getRealConnection().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">              <span class="comment">//ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is BAD: "</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-6、DataSource数据源&quot;&gt;&lt;a href=&quot;#2-6、DataSource数据源&quot; class=&quot;headerlink&quot; title=&quot;2.6、DataSource数据源&quot;&gt;&lt;/a&gt;2.6、DataSource数据源&lt;/h1&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>设计模式原则</title>
    <link href="https://caochikai.github.io/2019/12/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8E%9F%E5%88%99/"/>
    <id>https://caochikai.github.io/2019/12/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8E%9F%E5%88%99/</id>
    <published>2019-12-22T15:43:00.000Z</published>
    <updated>2019-12-22T15:51:21.986Z</updated>
    
    <content type="html"><![CDATA[<h3 id="幕布：软件设计原则"><a href="#幕布：软件设计原则" class="headerlink" title="幕布：软件设计原则"></a><a href="https://mubu.com/doc/soIjHUAYIW" target="_blank" rel="noopener">幕布：软件设计原则</a></h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-3.png" alt="思维导图" title="">                </div>                <div class="image-caption">思维导图</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;幕布：软件设计原则&quot;&gt;&lt;a href=&quot;#幕布：软件设计原则&quot; class=&quot;headerlink&quot; title=&quot;幕布：软件设计原则&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://mubu.com/doc/soIjHUAYIW&quot; target=&quot;_blank&quot; r
      
    
    </summary>
    
    
      <category term="software engineering" scheme="https://caochikai.github.io/categories/software-engineering/"/>
    
    
      <category term="software engineering" scheme="https://caochikai.github.io/tags/software-engineering/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：资源加载</title>
    <link href="https://caochikai.github.io/2019/12/22/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/"/>
    <id>https://caochikai.github.io/2019/12/22/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/</id>
    <published>2019-12-22T06:10:00.000Z</published>
    <updated>2020-03-21T08:57:34.778Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-5、资源加载"><a href="#2-5、资源加载" class="headerlink" title="2.5、资源加载"></a>2.5、资源加载</h1><h2 id="2-5-1、类加载器"><a href="#2-5-1、类加载器" class="headerlink" title="2.5.1、类加载器"></a>2.5.1、类加载器</h2><blockquote><p>JVM类加载器（ClassLoader）负责加载各种资源（主要是class字节码文件)，来源比如文件系统、网络资源或者其他来源，且默认使用的是双亲委派模式。类加载器基本三大特性为延迟加载、职责分明、传递性。而JVM 中内置了三个重要的 ClassLoader： BootstrapClassLoader、ExtensionClassLoader 和 AppClassLoader。URLClassLoader 不但可以加载远程类库，还可以加载本地路径的类库，取决于构造器中不同的地址形式。ExtensionClassLoader 和 AppClassLoader 都是 URLClassLoader 的子类，它们都是从本地文件系统里加载类库。</p></blockquote><ul><li><p>BootstrapClassLoader（根加载器）：加载JVM核心类，比如$JAVA_HOME/lib/rt.jar；</p></li><li><p>ExtensionClassLoader（扩展加载器）：加载扩展类，以 javax 开头的swing 系列、内置的 js 引擎、xml 解析器等等；</p></li><li><p>AppClassLoader（用户加载器）：ClassLoader.getSystemClassLoader()获得，加载Classpath 环境变量下目录和jar；</p></li><li><p>Thread.contextClassLoader（线程上下文类加载器）：主要是类隔离或者共享；</p></li><li><p>双亲委派模式：简单了来说子类有个parent 属性指向它的父加载器（类似指针），先检查自己是否已经加载过了，如果没有加载过就优先让父类尝试加载（理解为很懒都坑爹），如果已经加载或者坑爹不成那就自己干。</p></li><li><p>自定义类加载器：继承java.lang.ClassLoader，比如Tomcat（WebAppClassLoader）、JBoss类加载器；</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="comment">// Note: VM hardcoded the offset of this field, thus all new fields</span></span><br><span class="line">    <span class="comment">// must be added *after* it.</span></span><br><span class="line"><span class="comment">//如果parent为空（比如ExtensionClassLoader），那默认null就是根加载器BootstrapClassLoader</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-5-2-ClassloaderWrapper"><a href="#2-5-2-ClassloaderWrapper" class="headerlink" title="2.5.2 ClassloaderWrapper"></a>2.5.2 ClassloaderWrapper</h2><blockquote><p>看名字就知道是ClassLoader的包装器，<a href="http://org.apache.ibatis.io/" target="_blank" rel="noopener">org.apache.ibatis.io</a>包就封装了资源加载文件的相关API，通过ClassloaderWrapper包装器就可以调整多个ClassLoader的使用顺序。ClassLoaderWrapper的主要方法可以分为三类，分别是getResourceAsURL方法、classForName方法、getResourceAsStream方法。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A class to wrap access to multiple class loaders making them work as one</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderWrapper</span> </span>&#123;</span><br><span class="line"><span class="comment">//指定的默认类加载器</span></span><br><span class="line">  ClassLoader defaultClassLoader;</span><br><span class="line"><span class="comment">//SecurityManager系统类加载器</span></span><br><span class="line">  ClassLoader systemClassLoader;</span><br><span class="line"></span><br><span class="line">  ClassLoaderWrapper() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//初始化类加载器</span></span><br><span class="line">      systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ignored) &#123;</span><br><span class="line">      <span class="comment">// AccessControlException on Google App Engine</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ClassLoader[]&#123;</span><br><span class="line">        classLoader,<span class="comment">//参数指定加载器</span></span><br><span class="line">        defaultClassLoader,<span class="comment">//默认加载器</span></span><br><span class="line">        Thread.currentThread().getContextClassLoader(),<span class="comment">//线程上下文类加载器</span></span><br><span class="line">        getClass().getClassLoader(),<span class="comment">//当前类所使用的类加载器</span></span><br><span class="line">        systemClassLoader&#125;;<span class="comment">//System ClassLoader</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...省略部分重载方法</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Try to get a resource from a group of classloaders</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resource    - the resource to get</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the classloaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the resource or null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">InputStream <span class="title">getResourceAsStream</span><span class="params">(String resource, ClassLoader[] classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="comment">// try to find the resource as passed</span></span><br><span class="line">        InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line">        <span class="comment">// now, some class loaders want this leading "/", so we'll add it and try again if we didn't find the resource</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == returnValue) &#123;</span><br><span class="line">          returnValue = cl.getResourceAsStream(<span class="string">"/"</span> + resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != returnValue) &#123;</span><br><span class="line">          <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get a resource as a URL using the current class path</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resource    - the resource to locate</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the class loaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the resource or null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">URL <span class="title">getResourceAsURL</span><span class="params">(String resource, ClassLoader[] classLoader)</span> </span>&#123;</span><br><span class="line">    URL url;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="comment">// look for the resource as passed in...</span></span><br><span class="line">        url = cl.getResource(resource);</span><br><span class="line">        <span class="comment">// ...but some class loaders want this leading "/", so we'll add it</span></span><br><span class="line">        <span class="comment">// and try again if we didn't find the resource</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == url) &#123;</span><br><span class="line">          url = cl.getResource(<span class="string">"/"</span> + resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// "It's always in the last place I look for it!"</span></span><br><span class="line">        <span class="comment">// ... because only an idiot would keep looking for it after finding it, so stop looking already.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != url) &#123;</span><br><span class="line">          <span class="keyword">return</span> url;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// didn't find it anywhere.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Attempt to load a class from a group of classloaders</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name        - the class to load</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the group of classloaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> ClassNotFoundException - Remember the wisdom of Judge Smails: Well, the world needs ditch diggers, too.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Class&lt;?&gt; classForName(String name, ClassLoader[] classLoader) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Class&lt;?&gt; c = Class.forName(name, <span class="keyword">true</span>, cl)</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          <span class="comment">// we'll ignore this until all classloaders fail to locate the class</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Cannot find class: "</span> + name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-3-ResolverUtil"><a href="#2-5-3-ResolverUtil" class="headerlink" title="2.5.3 ResolverUtil"></a>2.5.3 ResolverUtil</h2><blockquote><p>ResolverUtil根据指定的条件查找指定包下的类，其中条件由Test接口中定义了matches方法提供。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/Test.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ***</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolverUtil</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A simple interface that specifies how to test classes to determine if they</span></span><br><span class="line"><span class="comment">   * are to be included in the results produced by the ResolverUtil.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Will be called repeatedly with candidate classes. Must return True if a class</span></span><br><span class="line"><span class="comment">     * is to be included in the results, false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A Test that checks to see if each class is assignable to the provided class. Note</span></span><br><span class="line"><span class="comment">   * that this test will match the parent type itself if it is presented for matching.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IsA</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; parent;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...构造方法初始化parent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns true if type is assignable to the parent type supplied in the constructor. */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line"><span class="comment">//判断parent是否是type的父类（继承）</span></span><br><span class="line">      <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; parent.isAssignableFrom(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A Test that checks to see if each class is annotated with a specific annotation. If it</span></span><br><span class="line"><span class="comment">   * is, then the test returns true, otherwise false.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedWith</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Annotation&gt; annotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...构造方法初始化annotation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns true if the type is annotated with the class provided to the constructor. */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line"><span class="comment">//判断Type类上是否添加了annotation注解</span></span><br><span class="line">      <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; type.isAnnotationPresent(annotation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The set of matches being accumulated. */</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Class&lt;? extends T&gt;&gt; matches = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The ClassLoader to use when looking for classes. If null then the ClassLoader returned</span></span><br><span class="line"><span class="comment">   * by Thread.currentThread().getContextClassLoader() will be used.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> ClassLoader classloader;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Provides access to the classes discovered so far. If no calls have been made to</span></span><br><span class="line"><span class="comment">   * any of the &#123;<span class="doctag">@code</span> find()&#125; methods, **this set will be empty**.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> 匹配的类.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Set&lt;Class&lt;? extends T&gt;&gt; getClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> matches;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the classloader that will be used for scanning for classes. If no explicit</span></span><br><span class="line"><span class="comment">   * ClassLoader has been set by the calling,the context class loader will be used.</span></span><br><span class="line"><span class="comment">   *  默认是线程上下文类加载器</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> classloader == <span class="keyword">null</span> ? Thread.currentThread().getContextClassLoader() : classloader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassLoader</span><span class="params">(ClassLoader classloader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.classloader = classloader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Scans for classes starting at the package provided and descending into subpackages.</span></span><br><span class="line"><span class="comment">   * Each class is offered up to the Test as it is discovered, and if the Test returns</span></span><br><span class="line"><span class="comment">   * true the class is retained.  Accumulated classes can be fetched by calling</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> test an instance of &#123;<span class="doctag">@link</span> Test&#125; that will be used to filter classes</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> packageName the name of the package from which to start scanning for</span></span><br><span class="line"><span class="comment">   *        classes, e.g. </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResolverUtil&lt;T&gt; <span class="title">find</span><span class="params">(Test test, String packageName)</span> </span>&#123;</span><br><span class="line"><span class="comment">//根据包名获取对应的路径</span></span><br><span class="line">    String path = getPackagePath(packageName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//根据VFS结果集合查找上面path下的资源</span></span><br><span class="line">      List&lt;String&gt; children = VFS.getInstance().list(path);</span><br><span class="line">      <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child.endsWith(<span class="string">".class"</span>)) &#123;</span><br><span class="line"><span class="comment">//检查class是否符合结果</span></span><br><span class="line">          addIfMatching(test, child);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      log.error(<span class="string">"Could not read package: "</span> + packageName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>​    </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add the class designated by the fully qualified class name provided to the set of</span></span><br><span class="line"><span class="comment">   * resolved classes if and only if it is approved by the Test supplied.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> test the test used to determine if the class matches 查找条件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> fqn the fully qualified name of a class 类的完全限定名称</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addIfMatching</span><span class="params">(Test test, String fqn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String externalName = fqn.substring(<span class="number">0</span>, fqn.indexOf(<span class="string">'.'</span>)).replace(<span class="string">'/'</span>, <span class="string">'.'</span>);</span><br><span class="line">      ClassLoader loader = getClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Checking to see if class "</span> + externalName + <span class="string">" matches criteria ["</span> + test + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Class&lt;?&gt; type = loader.loadClass(externalName);<span class="comment">//加载指定的类</span></span><br><span class="line">      <span class="keyword">if</span> (test.matches(type)) &#123;</span><br><span class="line">     <span class="comment">//如果条件过滤在添加到匹配结果集合matches</span></span><br><span class="line">        matches.add((Class&lt;T&gt;) type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      log.warn(<span class="string">"Could not examine class '"</span> + fqn + <span class="string">"'"</span> + <span class="string">" due to a "</span> +</span><br><span class="line">          t.getClass().getName() + <span class="string">" with message: "</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用例子：在pkg1和pkg2这两个包下查找实现了ActionBean这个类</span></span><br><span class="line">ResolverUtil&lt;ActionBean&gt; resolver = <span class="keyword">new</span> ResolverUtil&lt;ActionBean&gt;();</span><br><span class="line">resolver.findImplementation(ActionBean<span class="class">.<span class="keyword">class</span>, <span class="title">pkg1</span>, <span class="title">pkg2</span>)</span>;</span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg1);</span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg2);</span><br><span class="line"><span class="comment">//获取上面三个方法三次查找的结果集</span></span><br><span class="line">Collection&lt;ActionBean&gt; beans = resolver.getClasses();</span><br></pre></td></tr></table></figure><h2 id="2-5-5-VFS（虚拟文件系统）"><a href="#2-5-5-VFS（虚拟文件系统）" class="headerlink" title="2.5.5 VFS（虚拟文件系统）"></a>2.5.5 VFS（虚拟文件系统）</h2><blockquote><p>VFS是Virtual File System缩写，用来查找指定路径下的资源。VFS也是一个抽象类，Mybatis在<a href="http://org.apache.ibatis.io/" target="_blank" rel="noopener">org.apache.ibatis.io</a>下有DefaultVFS和JBoss6VFS的实现，UML图如下：</p></blockquote><p><img src="/images/VFS.png" alt="upload successful"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides a very simple API for accessing resources within an application server.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ben Gunter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">VFS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The built-in implementations.记录了两个实现类 */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] IMPLEMENTATIONS = &#123; JBoss6VFS<span class="class">.<span class="keyword">class</span>, <span class="title">DefaultVFS</span>.<span class="title">class</span> &#125;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The list to which implementations are added by &#123;<span class="doctag">@link</span> #addImplClass(Class)&#125;.</span></span><br><span class="line"><span class="comment"> *用户自定义的VES实现类。addImplClass（）方法会将指定的VES实现Class对象添加到集合。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends VFS&gt;&gt; USER_IMPLEMENTATIONS = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="comment">/** Singleton instance holder.单例 */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VFSHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> VFS INSTANCE = createVFS();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">static</span> VFS <span class="title">createVFS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Try the user implementations first, then the built-ins</span></span><br><span class="line">      List&lt;Class&lt;? extends VFS&gt;&gt; impls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//优先使用用户定义的VFS的实现类</span></span><br><span class="line">      impls.addAll(USER_IMPLEMENTATIONS);</span><br><span class="line"><span class="comment">//随后使用Mybatis提供的JBoss6VFS.class, DefaultVFS.class</span></span><br><span class="line">      impls.addAll(Arrays.asList((Class&lt;? extends VFS&gt;[]) IMPLEMENTATIONS));</span><br><span class="line"><span class="comment">//遍历所有实现类，依次实例化VFS对象并判断是否可用，可用就返回对象结束循环</span></span><br><span class="line">      <span class="comment">// Try each implementation class until a valid one is found</span></span><br><span class="line">      VFS vfs = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; vfs == <span class="keyword">null</span> || !vfs.isValid(); i++) &#123;</span><br><span class="line">        Class&lt;? extends VFS&gt; impl = impls.get(i);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          vfs = impl.getDeclaredConstructor().newInstance();</span><br><span class="line">          <span class="keyword">if</span> (!vfs.isValid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"VFS implementation "</span> + impl.getName() +</span><br><span class="line">                  <span class="string">" is not valid in this environment."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">          log.error(<span class="string">"Failed to instantiate "</span> + impl, e);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Using VFS adapter "</span> + vfs.getClass().getName());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> vfs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**单例模式体现，通过静态类创建</span></span><br><span class="line"><span class="comment">   * Get the singleton &#123;<span class="doctag">@link</span> VFS&#125; instance. If no &#123;<span class="doctag">@link</span> VFS&#125; implementation can be found for the</span></span><br><span class="line"><span class="comment">   * current environment, then this method returns null.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VFS <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> VFSHolder.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//抽象方法</span></span><br><span class="line"><span class="comment">/*isValid()负责检测当前VFS对象在当前环境下是否有效</span></span><br><span class="line"><span class="comment">* Return true if the &#123;@link VFS&#125; implementation is valid for the current environment. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**负责查找指定的资源名称列表</span></span><br><span class="line"><span class="comment">   * Recursively list the full resource path of all the resources that are children of the</span></span><br><span class="line"><span class="comment">   * resource identified by a URL.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> url The URL that identifies the resource to list.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> forPath The path to the resource that is identified by the URL. Generally, this is the</span></span><br><span class="line"><span class="comment">   *            value passed to &#123;<span class="doctag">@link</span> #getResources(String)&#125; to get the resource URL.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A list containing the names of the child resources.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException If I/O errors occur</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">list</span><span class="params">(URL url, String forPath)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>VFS中定义了list（URL，String）和isValid()两个抽象方法，在ResolverUtil.find()方法查找类文件时会调用list()方法的重载方法，该重载最终会调用list（URL，String）这个重载。我们以DefaultVFS为例进行分析，实现如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">ackage org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ***</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**VFS的默认实现方法，适用于大多数的应用服务</span></span><br><span class="line"><span class="comment"> * A default implementation of &#123;<span class="doctag">@link</span> VFS&#125; that works for most application servers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ben Gunter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultVFS</span> <span class="keyword">extends</span> <span class="title">VFS</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(DefaultVFS<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//判断是否是jar文件的字节特征</span></span><br><span class="line">  <span class="comment">/** The magic header that indicates a JAR (ZIP) file. */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] JAR_MAGIC = &#123; <span class="string">'P'</span>, <span class="string">'K'</span>, <span class="number">3</span>, <span class="number">4</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">list</span><span class="params">(URL url, String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;String&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// First, try to find the URL of a JAR file containing the requested resource. If a JAR</span></span><br><span class="line">      <span class="comment">// file is found, then we'll list child resources by reading the JAR.</span></span><br><span class="line"><span class="comment">//尝试读取jar文件，返回对应的URL，如果为空那就代表不是jar资源</span></span><br><span class="line">      URL jarUrl = findJarForResource(url);</span><br><span class="line">      <span class="keyword">if</span> (jarUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        is = jarUrl.openStream();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//遍历jar包中以path开头的资源列表</span></span><br><span class="line">        resources = listResources(<span class="keyword">new</span> JarInputStream(is), path);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//遍历url的子目录并记录到children </span></span><br><span class="line">        List&lt;String&gt; children = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (isJar(url)) &#123;</span><br><span class="line">            <span class="comment">// Some versions of JBoss VFS might give a JAR stream even if the resource</span></span><br><span class="line">            <span class="comment">// referenced by the URL isn't actually a JAR</span></span><br><span class="line">            is = url.openStream();</span><br><span class="line">            <span class="keyword">try</span> (JarInputStream jarInput = <span class="keyword">new</span> JarInputStream(is)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">for</span> (JarEntry entry; (entry = jarInput.getNextJarEntry()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Jar entry: "</span> + entry.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                children.add(entry.getName());</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* 大意是部分应用是资源列表在文本文件的里，下面尝试逐行读取资源，</span></span><br><span class="line"><span class="comment">*路径为path + "/" + line（每行内容）若读取成功为文件，否则为文件夹</span></span><br><span class="line"><span class="comment">             * Some servlet containers allow reading from directory resources like a</span></span><br><span class="line"><span class="comment">             * text file, listing the child resources one per line. However, there is no</span></span><br><span class="line"><span class="comment">             * way to differentiate between directory and file resources just by reading</span></span><br><span class="line"><span class="comment">             * them. To work around that, as each line is read, try to look it up via</span></span><br><span class="line"><span class="comment">             * the class loader as a child of the current resource. If any line fails</span></span><br><span class="line"><span class="comment">             * then we assume the current resource is not a directory.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            is = url.openStream();</span><br><span class="line">            List&lt;String&gt; lines = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is))) &#123;</span><br><span class="line">              <span class="keyword">for</span> (String line; (line = reader.readLine()) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Reader entry: "</span> + line);</span><br><span class="line">                &#125;</span><br><span class="line">                lines.add(line);</span><br><span class="line">                <span class="keyword">if</span> (getResources(path + <span class="string">"/"</span> + line).isEmpty()) &#123;</span><br><span class="line">                  lines.clear();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!lines.isEmpty()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              children.addAll(lines);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">          <span class="comment">/*若读取URL失败则直接整个文件夹下所有的文件</span></span><br><span class="line"><span class="comment">           * For file URLs the openStream() call might fail, depending on the servlet</span></span><br><span class="line"><span class="comment">           * container, because directories can't be opened for reading. If that happens,</span></span><br><span class="line"><span class="comment">           * then list the directory directly instead.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">"file"</span>.equals(url.getProtocol())) &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing directory "</span> + file.getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              children = Arrays.asList(file.list());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No idea where the exception came from so rethrow it</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The URL prefix to use when recursively listing child resources</span></span><br><span class="line">        String prefix = url.toExternalForm();</span><br><span class="line">        <span class="keyword">if</span> (!prefix.endsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">          prefix = prefix + <span class="string">"/"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Iterate over immediate children, adding files and recursing into directories</span></span><br><span class="line">        <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">          String resourcePath = path + <span class="string">"/"</span> + child;</span><br><span class="line">          resources.add(resourcePath);</span><br><span class="line">          URL childUrl = <span class="keyword">new</span> URL(prefix + child);</span><br><span class="line">          resources.addAll(list(childUrl, resourcePath));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resources;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">...关闭流</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * List the names of the entries in the given &#123;<span class="doctag">@link</span> JarInputStream&#125; that begin with the</span></span><br><span class="line"><span class="comment">   * specified &#123;<span class="doctag">@code</span> path&#125;. Entries will match with or without a leading slash.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jar The JAR input stream</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> path The leading path to match</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The names of all the matching entries</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException If I/O errors occur</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">listResources</span><span class="params">(JarInputStream jar, String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Include the leading and trailing slash when matching names</span></span><br><span class="line"><span class="comment">//...如果path不是以/开始和结束，则在其开始和结束位置添加/（略）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate over the entries and collect those that begin with the requested path</span></span><br><span class="line">    List&lt;String&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//遍历jar包,将以path开头资源加入到resources 集合</span></span><br><span class="line">    <span class="keyword">for</span> (JarEntry entry; (entry = jar.getNextJarEntry()) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!entry.isDirectory()) &#123;</span><br><span class="line">        <span class="comment">// Add leading slash if it's missing</span></span><br><span class="line">        StringBuilder name = <span class="keyword">new</span> StringBuilder(entry.getName());</span><br><span class="line">        <span class="keyword">if</span> (name.charAt(<span class="number">0</span>) != <span class="string">'/'</span>) &#123;</span><br><span class="line">          name.insert(<span class="number">0</span>, <span class="string">'/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check file name-&gt;path开头</span></span><br><span class="line">        <span class="keyword">if</span> (name.indexOf(path) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Found resource: "</span> + name);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Trim leading slash</span></span><br><span class="line">          resources.add(name.substring(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resources;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul><li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/lang/resources.html" target="_blank" rel="noopener">Oracle Location-Independent Access to Resources</a></li><li><a href="https://juejin.im/post/5c04892351882516e70dcc9b" target="_blank" rel="noopener">老大难的 Java ClassLoader 再不理解就老了</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-5、资源加载&quot;&gt;&lt;a href=&quot;#2-5、资源加载&quot; class=&quot;headerlink&quot; title=&quot;2.5、资源加载&quot;&gt;&lt;/a&gt;2.5、资源加载&lt;/h1&gt;&lt;h2 id=&quot;2-5-1、类加载器&quot;&gt;&lt;a href=&quot;#2-5-1、类加载器&quot; class=&quot;
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：日志模块</title>
    <link href="https://caochikai.github.io/2019/12/21/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/"/>
    <id>https://caochikai.github.io/2019/12/21/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/</id>
    <published>2019-12-21T13:19:00.000Z</published>
    <updated>2020-03-21T08:56:26.088Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-4、日志模块"><a href="#2-4、日志模块" class="headerlink" title="2.4、日志模块"></a>2.4、日志模块</h1><blockquote><p>Mybatis日志模块使用了适配器模式，内部调用org.apache.ibatis.logging.Log 接口。为了整合第三方的日志组件Log4J2、Log4J，mybatis提供了多种Adapter适配这些日志组件的API，并遵守Log 接口标准。在日志级别支持中，Mybatis提供了trace、debug、warn、eror四个级别，只能说基本满足绝大多数场景的日志。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line"><span class="comment">//is开头方法为判断登记方法</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isDebugEnabled</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isTraceEnabled</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//下面四个分别支持四种等级日志调用</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, Throwable e)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">trace</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">warn</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>LogFactory负责创建对应的日志组件的适配器，其内部逻辑基本公共静态代码块加载支持的日志适配器，然后使用logConstructor集合记录所有支持的日志适配器。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Marker to be used by logging implementations that support markers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MARKER = <span class="string">"MYBATIS"</span>;</span><br><span class="line"><span class="comment">//第三方日志组件的集合</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Log&gt; logConstructor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    tryImplementation(LogFactory::useSlf4jLogging);</span><br><span class="line">    tryImplementation(LogFactory::useCommonsLogging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4J2Logging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4JLogging);</span><br><span class="line">    tryImplementation(LogFactory::useJdkLogging);</span><br><span class="line">    tryImplementation(LogFactory::useNoLogging);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">LogFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// disable construction</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Log <span class="title">getLog</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getLog(aClass.getName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Log <span class="title">getLog</span><span class="params">(String logger)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//返回logger对象</span></span><br><span class="line">      <span class="keyword">return</span> logConstructor.newInstance(logger);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LogException(<span class="string">"Error creating logger for logger "</span> + logger + <span class="string">".  Cause: "</span> + t, t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> ...use开头方法省略都会走下面方法setImplementation（对应适配器类）</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryImplementation</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        runnable.run();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImplementation</span><span class="params">(Class&lt;? extends Log&gt; implClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//获取指定适配器的构造方法</span></span><br><span class="line">      Constructor&lt;? extends Log&gt; candidate = implClass.getConstructor(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//实例化适配器</span></span><br><span class="line">      Log log = candidate.newInstance(LogFactory<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Logging initialized using '"</span> + implClass + <span class="string">"' adapter."</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//初始化logConstructor</span></span><br><span class="line">      logConstructor = candidate;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LogException(<span class="string">"Error setting Log implementation.  Cause: "</span> + t, t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-4、JDBC调试日志"><a href="#2-4-4、JDBC调试日志" class="headerlink" title="2.4.4、JDBC调试日志"></a>2.4.4、JDBC调试日志</h3><blockquote><p>org.apache.ibatis.logging.jdbc是Mybatis通过动态代理的方式，将JDBC操作通过指定的日志框架打印出来，输出内容包含sql语句、绑定参数、影响行数等等。BaseJdbcLogger是jdbc下所有logger类的父类，继承树如下：</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/jdbc_log.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...省略部分导入</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ArrayUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for proxies to do logging.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseJdbcLogger</span> </span>&#123;</span><br><span class="line"><span class="comment">//PreparedStatement接口中定义的常用的set*（）方法名</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;StrinSg&gt; SET_METHODS;</span><br><span class="line"><span class="comment">//Statement接口和PreparedStatement接口中与执行SQL语句相关的方法名</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; EXECUTE_METHODS = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"><span class="comment">//PreparedStatement.set*（）方法设置的键值对，key为parameterIndex下标，value为列值</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; columnMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//parameterIndex集合</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; columnNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//value集合</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; columnValues = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//当前支持的适配器实例</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Log statementLog;</span><br><span class="line"><span class="comment">//Sql层数，用于格式化sql，buffer堆栈的深度-&gt;char[] buffer = new char[queryStack * 2 + 2];</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> queryStack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Default constructor，传入适配器实例</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BaseJdbcLogger</span><span class="params">(Log log, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.statementLog = log;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.queryStack = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.queryStack = queryStack;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//lambada获取PreparedStatement开通setXXX方法名称集合</span></span><br><span class="line">    SET_METHODS = Arrays.stream(PreparedStatement<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredMethods</span>())</span></span><br><span class="line">            .filter(method -&gt; method.getName().startsWith("set"))</span><br><span class="line">            .filter(method -&gt; method.getParameterCount() &gt; <span class="number">1</span>)</span><br><span class="line">            .map(Method::getName)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line"><span class="comment">//执行方法代理目标</span></span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"execute"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeUpdate"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeQuery"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"addBatch"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//往SET_METHODS集合添加记录</span></span><br><span class="line">    SET_METHODS.add(<span class="string">"setString"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNString"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setInt"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setByte"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setShort"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setLong"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setDouble"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setFloat"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setTimestamp"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setDate"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setTime"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setArray"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBigDecimal"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setAsciiStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBinaryStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBlob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBoolean"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBytes"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setCharacterStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNCharacterStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setClob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNClob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setObject"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNull"</span>);</span><br><span class="line"></span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"execute"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeUpdate"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeQuery"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"addBatch"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setColumn</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    columnMap.put(key, value);</span><br><span class="line">    columnNames.add(key);</span><br><span class="line">    columnValues.add(value);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PreparedStatementLogger继承了BaseJdbcLogger并实现了InvocationHandler接口。PreparedStatementLogger.invoke方法会为EXECUTE_METHODS集合中的方法、SET_METHODS集合中的方法、getResultSet等方法提供代理，具体代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PreparedStatement proxy to add logging.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementLogger</span> <span class="keyword">extends</span> <span class="title">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PreparedStatement statement;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PreparedStatementLogger</span><span class="params">(PreparedStatement stmt, Log statementLog, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(statementLog, queryStack);</span><br><span class="line">    <span class="keyword">this</span>.statement = stmt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, params);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//调用了EXECUTE_METHODS集合中的方法</span></span><br><span class="line">      <span class="keyword">if</span> (EXECUTE_METHODS.contains(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isDebugEnabled()) &#123;</span><br><span class="line"><span class="comment">//日志输出，输出的是参数值以及参数类型-&gt;()</span></span><br><span class="line">          debug(<span class="string">"Parameters: "</span> + getParameterValueString(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clearColumnInfo();<span class="comment">//清空BaseJdbcLogger中定义的三个column*集合</span></span><br><span class="line"><span class="comment">//如果是executeQuery方法，则为ResultSet创建代理对象，不是则直接返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"executeQuery"</span>.equals(method.getName())) &#123;</span><br><span class="line">          ResultSet rs = (ResultSet) method.invoke(statement, params);</span><br><span class="line">          <span class="keyword">return</span> rs == <span class="keyword">null</span> ? <span class="keyword">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SET_METHODS.contains(method.getName())) &#123;</span><br><span class="line"><span class="comment">//如果是SET_METHODS集合中的方法，则通过setColumn记录到</span></span><br><span class="line"><span class="comment">//BaseJdbcLogger的三个column*集合</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"setNull"</span>.equals(method.getName())) &#123;</span><br><span class="line">          setColumn(params[<span class="number">0</span>], <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          setColumn(params[<span class="number">0</span>], params[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getResultSet"</span>.equals(method.getName())) &#123;</span><br><span class="line"><span class="comment">//如果调用getResultSet（）方法，则为ResultSet创建代理对象</span></span><br><span class="line">        ResultSet rs = (ResultSet) method.invoke(statement, params);</span><br><span class="line">        <span class="keyword">return</span> rs == <span class="keyword">null</span> ? <span class="keyword">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getUpdateCount"</span>.equals(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">int</span> updateCount = (Integer) method.invoke(statement, params);</span><br><span class="line">        <span class="keyword">if</span> (updateCount != -<span class="number">1</span>) &#123;</span><br><span class="line">          debug(<span class="string">"   Updates: "</span> + updateCount, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//返回影响条数</span></span><br><span class="line">        <span class="keyword">return</span> updateCount;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a logging version of a PreparedStatement.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> stmt - the statement</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> statementLog - the statement log</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> queryStack - the query stack</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> - the proxy 使用JDK动态代理的方式创建代理对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PreparedStatement <span class="title">newInstance</span><span class="params">(PreparedStatement stmt, Log statementLog, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    InvocationHandler handler = <span class="keyword">new</span> PreparedStatementLogger(stmt, statementLog, queryStack);</span><br><span class="line">    ClassLoader cl = PreparedStatement<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">    <span class="keyword">return</span> (PreparedStatement) Proxy.newProxyInstance(cl, <span class="keyword">new</span> Class[]&#123;PreparedStatement<span class="class">.<span class="keyword">class</span>, <span class="title">CallableStatement</span>.<span class="title">class</span>&#125;, <span class="title">handler</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Return the wrapped prepared statement.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the PreparedStatement</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">getPreparedStatement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ResultSetLogger 中封装了ResultSet对象，也继承了BaseldbcLogger抽象类并实现了InvocationHandler 接口。ResultSetLogger中定义的字段如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSetMetaData;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Types;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ResultSet proxy to add logging</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultSetLogger</span> <span class="keyword">extends</span> <span class="title">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"><span class="comment">//记录了超大长度的类型</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; BLOB_TYPES = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"><span class="comment">//是否是ResultSet结果集的第一行</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//统计行数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> rows;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ResultSet rs;</span><br><span class="line"><span class="comment">//记录了超大字段的列编号</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; blobColumns = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//所有超大长度的类型</span></span><br><span class="line">    BLOB_TYPES.add(Types.BINARY);</span><br><span class="line">    BLOB_TYPES.add(Types.BLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.CLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGNVARCHAR);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGVARBINARY);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGVARCHAR);</span><br><span class="line">    BLOB_TYPES.add(Types.NCLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.VARBINARY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, params);</span><br><span class="line">      &#125;</span><br><span class="line">      Object o = method.invoke(rs, params);</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"next"</span>.equals(method.getName())) &#123;</span><br><span class="line"><span class="comment">//是否还有下一行</span></span><br><span class="line">        <span class="keyword">if</span> ((Boolean) o) &#123;</span><br><span class="line">          rows++;</span><br><span class="line">          <span class="keyword">if</span> (isTraceEnabled()) &#123;</span><br><span class="line">            ResultSetMetaData rsmd = rs.getMetaData();</span><br><span class="line"><span class="comment">//获取数据集的列数</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> columnCount = rsmd.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (first) &#123;</span><br><span class="line">              first = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//输出表头，并填充超大长度的类型到集合中</span></span><br><span class="line">              printColumnHeaders(rsmd, columnCount);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//输出该行记录，注意会过滤掉blobColumns中记录的列，</span></span><br><span class="line"><span class="comment">//这些列的数据较大，不会输出到日志</span></span><br><span class="line">            printColumnValues(columnCount);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//遍历ResultSet之后输出总，完例子：Total: 1</span></span><br><span class="line">          debug(<span class="string">"     Total: "</span> + rows, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      clearColumnInfo();<span class="comment">//清空BaseJdbcLogger的三个column*集合</span></span><br><span class="line">      <span class="keyword">return</span> o;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//例子：Header: [count(*)]</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printColumnHeaders</span><span class="params">(ResultSetMetaData rsmd, <span class="keyword">int</span> columnCount)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    StringBuilder row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    row.append(<span class="string">"   Columns: "</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (BLOB_TYPES.contains(rsmd.getColumnType(i))) &#123;</span><br><span class="line">        blobColumns.add(i);</span><br><span class="line">      &#125;</span><br><span class="line">      String colname = rsmd.getColumnLabel(i);</span><br><span class="line">      row.append(colname);</span><br><span class="line">      <span class="keyword">if</span> (i != columnCount) &#123;</span><br><span class="line">        row.append(<span class="string">", "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(row.toString(), <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//例子：Row: 39</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printColumnValues</span><span class="params">(<span class="keyword">int</span> columnCount)</span> </span>&#123;</span><br><span class="line">    StringBuilder row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    row.append(<span class="string">"       Row: "</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</span><br><span class="line">      String colname;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (blobColumns.contains(i)) &#123;</span><br><span class="line">          colname = <span class="string">"&lt;&lt;BLOB&gt;&gt;"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          colname = rs.getString(i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="comment">// generally can't call getString() on a BLOB column</span></span><br><span class="line">        colname = <span class="string">"&lt;&lt;Cannot Display&gt;&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      row.append(colname);</span><br><span class="line">      <span class="keyword">if</span> (i != columnCount) &#123;</span><br><span class="line">        row.append(<span class="string">", "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(row.toString(), <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-4、日志模块&quot;&gt;&lt;a href=&quot;#2-4、日志模块&quot; class=&quot;headerlink&quot; title=&quot;2.4、日志模块&quot;&gt;&lt;/a&gt;2.4、日志模块&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Mybatis日志模块使用了适配器模式，内部调用org.apach
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：类型转换</title>
    <link href="https://caochikai.github.io/2019/12/20/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A2-3%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/"/>
    <id>https://caochikai.github.io/2019/12/20/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A2-3%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/</id>
    <published>2019-12-20T12:40:00.000Z</published>
    <updated>2020-03-21T08:57:45.728Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-3、类型转换"><a href="#2-3、类型转换" class="headerlink" title="2.3、类型转换"></a>2.3、类型转换</h1><blockquote><p>JDBC数据类型与Java语言中的数据类型并不是完全对应的，所以在PreparedStatement为SOL语句绑定参数时，需要从Java类型转换成JDBC类型，而从结果集中获取数据时，则需要从JDBC类型转换成Java类型。MyBatis使用类型处理器完成上述两种转换。</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/myabtisTypehandle.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="2-3-1、TypeHandler"><a href="#2-3-1、TypeHandler" class="headerlink" title="2.3.1、TypeHandler"></a>2.3.1、TypeHandler</h3><blockquote><p>Mybatis当中所有类型转化器都继承BaseTypeHandler，而BaseTypeHandler又实现了TypeHandler接口。接口定义了四个方法，分成两类：setParameter()方法负责将数据由JdbcType 类型转换成Java类型；getResult()方法及其重载负责将数据由Java类型转换成JdbcType类型。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line">import java.sql.CallableStatement;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface TypeHandler&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;在通过Preparedstatement为SQL语句绑定参数时，会将数据由JdbcType类型转换成Java类型</span><br><span class="line">  void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * @param columnName Colunm name, when configuration &lt;code&gt;useColumnLabel&lt;&#x2F;code&gt; is &lt;code&gt;false&lt;&#x2F;code&gt;</span><br><span class="line">   *&#x2F;</span><br><span class="line">&#x2F;&#x2F;从ResultSet中获取数据，通过字段名称将数据由Java类型转换成JdbcType类型</span><br><span class="line">  T getResult(ResultSet rs, String columnName) throws SQLException;</span><br><span class="line">&#x2F;&#x2F;从ResultSet中获取数据，通过字段下标（同上面getResult）</span><br><span class="line">  T getResult(ResultSet rs, int columnIndex) throws SQLException;</span><br><span class="line">&#x2F;&#x2F;CallableStatement中通过下标获取结果</span><br><span class="line">  T getResult(CallableStatement cs, int columnIndex) throws SQLException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>一般类型转换器适用于单个参数或者单个列值完成类型转换，大多数是直接调用PreparedStatement、ResultSet、CallableStatement的对应方法， 以org.apache.ibatis.type.StringTypeHandler为例子如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTypeHandler</span> <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, String parameter, JdbcType jdbcType)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//调用PreparedStatement.setXXX(Type)绑定参数</span></span><br><span class="line">    ps.setString(i, parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//ResultSet.getXXX(Type)(列名称)获取列值</span></span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">//ResultSet.getXXX(Type)(列下标)获取列值</span></span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-2、TypeHandlerRegistry"><a href="#2-3-2、TypeHandlerRegistry" class="headerlink" title="2.3.2、TypeHandlerRegistry"></a>2.3.2、TypeHandlerRegistry</h3><blockquote><p>TypeHandlerRegistry管理所有的类型转化器，register()方法实现了注册功能，过程中会向下述字段集合添加TypeHandler。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Kazuki Shimizu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeHandlerRegistry</span> </span>&#123;</span><br><span class="line"><span class="comment">//在读取结果数据时候，依靠该集合映射从jdbcType转换成javaType，</span></span><br><span class="line"><span class="comment">//而JdbcType类型为org.apache.ibatis.type.JdbcType枚举类型</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;  jdbcTypeHandlerMap = <span class="keyword">new</span> EnumMap&lt;&gt;(JdbcType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">//记录了Java类型向指定Jdbcrype转换时，需要使用的TypeHandler对象。例如；Java类型中的string可能</span></span><br><span class="line"><span class="comment">//转换成教据库的 char、varchar等多种类型，所以存在一对多关系</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; typeHandlerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">  <span class="comment">//Object类型TypeHandler处理类</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeHandler&lt;Object&gt; unknownTypeHandler = <span class="keyword">new</span> UnknownTypeHandler(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">//全部Java类型以及对应的TypeHandler</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; allTypeHandlersMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//空TypeHandler集合的标识</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; NULL_TYPE_HANDLER_MAP = Collections.emptyMap();</span><br><span class="line"><span class="comment">//枚举类型的TypeHandler集合</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;? extends TypeHandler&gt; defaultEnumTypeHandler = EnumTypeHandler<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-3、类型转换&quot;&gt;&lt;a href=&quot;#2-3、类型转换&quot; class=&quot;headerlink&quot; title=&quot;2.3、类型转换&quot;&gt;&lt;/a&gt;2.3、类型转换&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;JDBC数据类型与Java语言中的数据类型并不是完全对应的，所以在
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis技术内幕源码解析：反射工具箱</title>
    <link href="https://caochikai.github.io/2019/12/19/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%B1%82/"/>
    <id>https://caochikai.github.io/2019/12/19/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%B1%82/</id>
    <published>2019-12-19T13:24:00.000Z</published>
    <updated>2020-03-21T08:57:44.783Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：基础支持层"><a href="#第二章：基础支持层" class="headerlink" title="第二章：基础支持层"></a>第二章：基础支持层</h1><blockquote><p>Mybatis以SqlSessionFactory为核心，通过SqlSessionFactoryBuilder解析xml配置文件或Configration实例构建出SqlSessionFactory的实例。</p></blockquote><h2 id="一、重要概念"><a href="#一、重要概念" class="headerlink" title="一、重要概念"></a>一、重要概念</h2><ul><li>命名空间（Namespaces）：通常包名加类目组成完全限定名（com.MyMapper.selectAll），实现语句隔离确定唯一性。</li><li>作用域（Scope）和生命周期</li><li>SqlSessionFactoryBuilder：完成创建SqlSessionFactory后就不再需要。</li><li>SqlSessionFactory：最佳作用域是应用作用域，最优解是使用单例模式或者静态单例模式。</li><li>SqlSession：最佳的作用域是请求或方法作用域</li></ul><h1 id="2-2、反射工具箱"><a href="#2-2、反射工具箱" class="headerlink" title="2.2、反射工具箱"></a>2.2、反射工具箱</h1><blockquote><p>Mybatis进行参数处理、结果映射会涉及到大量的反射操作。Java反射功能虽然强大，但是代码复杂易错，所以在mybaits源码包org.apache.ibatis.reflection有专门的反射模块。</p></blockquote><h3 id="2-2-1-Reflector-amp-ReflectorFactory"><a href="#2-2-1-Reflector-amp-ReflectorFactory" class="headerlink" title="2.2.1 Reflector&amp;ReflectorFactory"></a>2.2.1 Reflector&amp;ReflectorFactory</h3><blockquote><p>Reflector是反射模块的基础类，一个reflecotr实例对应一个类的元信息。根据Java Bean规范，封装的对getter、setter属性方法映射。</p></blockquote><p><strong>Reflector成员字段</strong>分析如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">import ....</span><br><span class="line">（省略导入类）</span><br><span class="line">&#x2F;**</span><br><span class="line"> * This class represents a cached set of class definition information that</span><br><span class="line"> * allows for easy mapping between property names and getter&#x2F;setter methods.</span><br><span class="line"> *</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Reflector &#123;</span><br><span class="line">  &#x2F;&#x2F;对应的class类型</span><br><span class="line">  private final Class&lt;?&gt; type;</span><br><span class="line">  &#x2F;&#x2F;getter方法对应的属性名称数组</span><br><span class="line">  private final String[] readablePropertyNames;</span><br><span class="line">  &#x2F;&#x2F;setter方法对应的属性名称数组</span><br><span class="line">  private final String[] writablePropertyNames;</span><br><span class="line">&#x2F;&#x2F;属性对应的setter方法集合，key是属性名称，value是Invoker对象</span><br><span class="line">  private final Map&lt;String, Invoker&gt; setMethods &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;属性对应的getter方法集合，key是属性名称，value是Invoker对象</span><br><span class="line">  private final Map&lt;String, Invoker&gt; getMethods &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;记录了属性相应的setter方法的参数值类型，key是属性名称，value是setter方法的参数类型</span><br><span class="line">  private final Map&lt;String, Class&lt;?&gt;&gt; setTypes &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;记录了属性相应的getter方法的参数值类型，key是属性名称，value是setter方法的参数类型</span><br><span class="line">  private final Map&lt;String, Class&lt;?&gt;&gt; getTypes &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;记录默认构造器</span><br><span class="line">  private Constructor&lt;?&gt; defaultConstructor;</span><br><span class="line">  &#x2F;&#x2F;所有属性名称集合</span><br><span class="line">  private Map&lt;String, String&gt; caseInsensitivePropertyMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>ReflectorFactory接口定义了Reflector对象创建或者缓存</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">public interface ReflectorFactory &#123;</span><br><span class="line">&#x2F;&#x2F;确定是否需要缓存该Reflector对象</span><br><span class="line">  boolean isClassCacheEnabled();</span><br><span class="line">&#x2F;&#x2F;设置是否缓存该Reflector对象</span><br><span class="line">  void setClassCacheEnabled(boolean classCacheEnabled);</span><br><span class="line">&#x2F;&#x2F;刘建指定Class对应的Reflector对象</span><br><span class="line">  Reflector findForClass(Class&lt;?&gt; type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>DefaultReflectorFactory默认实现ReflectorFactory，而CustomReflectorFactory继承DefaultReflectorFactory并且空实现，其关系图如下</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://mubu.com/document_image/b61624c1-2eaa-4e3f-9e21-904b98cce861-2286202.jpg" alt="DefaultReflectorFactory" title="">                </div>                <div class="image-caption">DefaultReflectorFactory</div>            </figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line">import java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line">public class DefaultReflectorFactory implements ReflectorFactory &#123;</span><br><span class="line">  &#x2F;&#x2F;该字段决定是否开启对Reflector对象</span><br><span class="line">  private boolean classCacheEnabled &#x3D; true;</span><br><span class="line">  &#x2F;&#x2F;使用ConcurrentMap集合实现对Reflector对象的缓存</span><br><span class="line">  private final ConcurrentMap&lt;Class&lt;?&gt;, Reflector&gt; reflectorMap &#x3D; new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  public DefaultReflectorFactory() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isClassCacheEnabled() &#123;</span><br><span class="line">    return classCacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void setClassCacheEnabled(boolean classCacheEnabled) &#123;</span><br><span class="line">    this.classCacheEnabled &#x3D; classCacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Reflector findForClass(Class&lt;?&gt; type) &#123;</span><br><span class="line">    if (classCacheEnabled) &#123;&#x2F;&#x2F;检测是否开启缓存</span><br><span class="line">      &#x2F;&#x2F; synchronized (type) removed see issue #461</span><br><span class="line">&#x2F;&#x2F;通过线程安全ConcurrentHashMap获取缓存Reflector，没有则通过lambada调用构造新建对象</span><br><span class="line">      return reflectorMap.computeIfAbsent(type, Reflector::new);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">&#x2F;&#x2F;未开启缓存则直接new Reflector对象</span><br><span class="line">      return new Reflector(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;第二章：基础支持层&quot;&gt;&lt;a href=&quot;#第二章：基础支持层&quot; class=&quot;headerlink&quot; title=&quot;第二章：基础支持层&quot;&gt;&lt;/a&gt;第二章：基础支持层&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Mybatis以SqlSessionFactory为核心，
      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>HttpServletRequest流重复读</title>
    <link href="https://caochikai.github.io/2019/12/18/HttpServletRequest%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB/"/>
    <id>https://caochikai.github.io/2019/12/18/HttpServletRequest%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB/</id>
    <published>2019-12-18T12:30:00.000Z</published>
    <updated>2019-12-19T13:46:05.626Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HttpServletRequest流重复读"><a href="#HttpServletRequest流重复读" class="headerlink" title="HttpServletRequest流重复读"></a>HttpServletRequest流重复读</h1><blockquote><p>springmvc controller @RequestBody接受参数报错，原因为http POST请求报文体为二进制流，在HttpServletRequest.getInputStream()中流只能被读取一次，重复读取会报如下：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getRead() has already been called for this request&#x2F;getInputStream() has already been called for this request</span><br></pre></td></tr></table></figure><h2 id="一、解决方式"><a href="#一、解决方式" class="headerlink" title="一、解决方式"></a>一、解决方式</h2><blockquote><p>第一种方式：重写HttpServletRequestWrapper 将InputStream 替换成可重复读的ByteArrayInputStream，原理就是在Filter或者springmvc的interceptor中通过构造器包装HttpServletRequest，并且把当前流缓存起来。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义HttpServletRequestWrapper</span></span><br><span class="line"><span class="comment"> * 解决InputStream不能重复读问题</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    BufferedServletRequestWrapper(HttpServletRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        String sessionStream = getBodyString(request);</span><br><span class="line">        body = sessionStream.getBytes(Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取请求Body</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getBodyString</span><span class="params">(<span class="keyword">final</span> ServletRequest request)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = cloneInputStream(request.getInputStream());</span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">            String line = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    reader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 复制输入流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">cloneInputStream</span><span class="params">(ServletInputStream inputStream)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(buffer)) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            byteArrayOutputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(body);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bais.read();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>第二种方式：Springmvc提供了解决方案ContentCachingRequestWrapper，思路也是一样，只不过代码更加严谨点。源码我就不贴了，开头注释说明贴一下，然后需要注意事项和正确的使用方式如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *ContentCachingRequestWrapper源码注释如下</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125; wrapper that caches all content read from</span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@linkplain</span> #getInputStream() input stream&#125; and &#123;<span class="doctag">@linkplain</span> #getReader() reader&#125;,</span></span><br><span class="line"><span class="comment"> * and allows this content to be retrieved via a &#123;<span class="doctag">@link</span> #getContentAsByteArray() byte array&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Used e.g. by &#123;<span class="doctag">@link</span> org.springframework.web.filter.AbstractRequestLoggingFilter&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Brian Clozel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.1.3</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ContentCachingResponseWrapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.qm.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.ContentCachingRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置哪些请求可以进行重复读数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cachingRequestBodyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 防止流读取一次后就没有了, 所以需要将流继续写出去</span></span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) request;</span><br><span class="line">        String requestURI = httpServletRequest.getRequestURI();</span><br><span class="line">        <span class="comment">// 这里将原始request传入，读出流并存储</span></span><br><span class="line">        <span class="comment">//PATH 为可重复读的路径开始或者接受部分 例如：caching.do</span></span><br><span class="line">        <span class="keyword">if</span> (requestURI.endsWith(<span class="string">"caching.do"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 这里将原始request传入，读出流并存储</span></span><br><span class="line">            ContentCachingRequestWrapper requestWrapper = <span class="keyword">new</span> ContentCachingRequestWrapper(httpServletRequest);</span><br><span class="line">            <span class="comment">// 这里将原始request替换为包装后的request，此后所有进入controller的request均为包装后的request</span></span><br><span class="line">            chain.doFilter(requestWrapper, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//          不要覆盖所有的请求，防止覆盖其他人请求</span></span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="二、参考如下："><a href="#二、参考如下：" class="headerlink" title="二、参考如下："></a>二、参考如下：</h2><p><a href="https://www.itmotui.com/2019/01/16/spring/web/HttpServletRequest%E6%95%B0%E6%8D%AE%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB%E9%97%AE%E9%A2%98/index.html" target="_blank" rel="noopener">HttpServletRequest数据流重复读问题</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;HttpServletRequest流重复读&quot;&gt;&lt;a href=&quot;#HttpServletRequest流重复读&quot; class=&quot;headerlink&quot; title=&quot;HttpServletRequest流重复读&quot;&gt;&lt;/a&gt;HttpServletRequest流重
      
    
    </summary>
    
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>BigDecimal金额计算</title>
    <link href="https://caochikai.github.io/2019/12/17/BigDecimal%E9%87%91%E9%A2%9D%E8%AE%A1%E7%AE%97/"/>
    <id>https://caochikai.github.io/2019/12/17/BigDecimal%E9%87%91%E9%A2%9D%E8%AE%A1%E7%AE%97/</id>
    <published>2019-12-16T16:26:58.000Z</published>
    <updated>2019-12-17T15:30:40.899Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>关于金额计算，通常有加减乘除，四舍五入等。</p></blockquote><ol><li>add()加法函数：要注意BigDecimal加法得到的结果为零，因为BigDecimal的加法需要一个值去接收，加法不会改变调用者自身的值。</li><li>subtract()减法函数：同加法；</li><li>multiply()乘法函数：注意Double转BigDecimal，尽量用字符串的形式初始化。因为使用BigDecimal类构造方法传入double类型时，计算的结果是不精确的！</li><li>divide()除法函数：避免抛出除零异常，方式将除运算尽量转换成等价的乘运算。</li><li>保留两位小数且四舍五入：value.setScale(2, BigDecimal.ROUND_HALF_UP);</li><li>BigDecimal静态常量值，比如BigDecimal.ZERO等；</li></ol><h2 id="例子刨析："><a href="#例子刨析：" class="headerlink" title="例子刨析："></a>例子刨析：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal num1 = <span class="keyword">new</span> BigDecimal(<span class="number">0.005</span>);</span><br><span class="line">     BigDecimal num2 = <span class="keyword">new</span> BigDecimal(<span class="number">1000000</span>);</span><br><span class="line">     BigDecimal num3 = <span class="keyword">new</span> BigDecimal(-<span class="number">1000000</span>);</span><br><span class="line">     <span class="comment">//尽量用字符串的形式初始化</span></span><br><span class="line">     BigDecimal num12 = <span class="keyword">new</span> BigDecimal(<span class="string">"0.005"</span>);</span><br><span class="line">     BigDecimal num22 = <span class="keyword">new</span> BigDecimal(<span class="string">"1000000"</span>);</span><br><span class="line">     BigDecimal num32 = <span class="keyword">new</span> BigDecimal(<span class="string">"-1000000"</span>);</span><br><span class="line"><span class="comment">//加法</span></span><br><span class="line">     BigDecimal result1 = num1.add(num2);</span><br><span class="line">     BigDecimal result12 = num12.add(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//减法</span></span><br><span class="line">     BigDecimal result2 = num1.subtract(num2);</span><br><span class="line">     BigDecimal result22 = num12.subtract(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//乘法</span></span><br><span class="line">     BigDecimal result3 = num1.multiply(num2);</span><br><span class="line">     BigDecimal result32 = num12.multiply(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//绝对值</span></span><br><span class="line">     BigDecimal result4 = num3.abs();</span><br><span class="line">     BigDecimal result42 = num32.abs();</span><br><span class="line"></span><br><span class="line">     <span class="comment">//除法</span></span><br><span class="line">     BigDecimal result5 = num2.divide(num1,<span class="number">20</span>,BigDecimal.ROUND_HALF_UP);</span><br><span class="line">     BigDecimal result52 = num22.divide(num12,<span class="number">20</span>,BigDecimal.ROUND_HALF_UP);</span><br></pre></td></tr></table></figure><h2 id="result全部输出结果，初始化建议使用String"><a href="#result全部输出结果，初始化建议使用String" class="headerlink" title="result全部输出结果，初始化建议使用String"></a>result全部输出结果，初始化建议使用String</h2><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9ede2a28-4e0a-43fb-9e48-8a4c019d1adc%2FUntitled.png?table=block&id=426c6e13-75fc-475e-93a9-f5a320222905&width=1390&cache=v2" alt="结果" title="">                </div>                <div class="image-caption">结果</div>            </figure><h3 id="参考如下"><a href="#参考如下" class="headerlink" title="参考如下"></a>参考如下</h3><p><a href="https://blog.csdn.net/shadow_zed/article/details/73522157" target="_blank" rel="noopener">BigDecimal加减乘除计算</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;关于金额计算，通常有加减乘除，四舍五入等。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;add()加法函数：要注意BigDecimal加法得到的结果为零，因为BigDecimal的加法需要一个值去接收，加法不会改变调用者自身的值。&lt;/li
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Springboot+vue部署路由404</title>
    <link href="https://caochikai.github.io/2019/12/15/hello-world/"/>
    <id>https://caochikai.github.io/2019/12/15/hello-world/</id>
    <published>2019-12-15T08:32:00.000Z</published>
    <updated>2019-12-15T10:10:20.253Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>vue单页面路由，刷新地址或者请求链接，都会404</p><pre><code>user  www;worker_processes  auto;error_log  /var/log/nginx/error.log;pid /run/nginx.pid;events {    worker_connections  51200;    multi_accept on;}http {    include       mime.types;    default_type  application/octet-stream;    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;    access_log  /var/log/nginx/access.log  main;    sendfile        on;    tcp_nopush          on;    tcp_nodelay         on;    keepalive_timeout  65;    types_hash_max_size 2048;    #gzip  on;    gzip on;  server {        listen        80;        root        /www/app/;        server_name  gdhxy.cn;        try_files $uri $uri/ /index.html;    }    server {        listen        80;        root        /www/app/;        server_name  www.gdhxy.cn;        try_files $uri $uri/ /index.html;    }     server {        listen       80;        server_name  admin.gdhxy.cn;        try_files $uri $uri/ /index.html;        location / {                proxy_redirect off;                  proxy_pass http://127.0.0.1:38806;        }    }}</code></pre><h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><blockquote><p>1、nginx配置：try_files $uri $uri/ /index.html；2、springboot指定404到index.html.</p></blockquote><pre><code>import org.springframework.boot.web.servlet.error.ErrorController;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import javax.servlet.http.HttpServletRequest;@Controllerpublic class MyErrorController implements ErrorController {    @RequestMapping(&quot;/error&quot;)    public String handleError(HttpServletRequest request) {        //获取statusCode:404,重定向到首页        Integer statusCode = (Integer) request.getAttribute(&quot;javax.servlet.error.status_code&quot;);        if (statusCode == 404) {            return &quot;/index.html&quot;;        } else {            return &quot;/500&quot;;        }    }    @Override    public String getErrorPath() {        return &quot;/error&quot;;    }}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题背景&quot;&gt;&lt;a href=&quot;#问题背景&quot; class=&quot;headerlink&quot; title=&quot;问题背景&quot;&gt;&lt;/a&gt;问题背景&lt;/h2&gt;&lt;p&gt;vue单页面路由，刷新地址或者请求链接，都会404&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;user  www;
worker_pro
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>服务器配置记录</title>
    <link href="https://caochikai.github.io/2019/09/28/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/"/>
    <id>https://caochikai.github.io/2019/09/28/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/</id>
    <published>2019-09-27T16:48:12.000Z</published>
    <updated>2019-09-27T16:49:50.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="服务器配置记录"><a href="#服务器配置记录" class="headerlink" title="服务器配置记录"></a>服务器配置记录</h1><h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><blockquote><p>真实生产环境部署：nginx、tomcat配置https证书</p></blockquote><h2 id="二、nginx"><a href="#二、nginx" class="headerlink" title="二、nginx"></a>二、nginx</h2><h3 id="安装过程："><a href="#安装过程：" class="headerlink" title="安装过程："></a>安装过程：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//一键安装上面四个依赖</span><br><span class="line">yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel</span><br><span class="line">//下载tar包</span><br><span class="line">wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">tar xzf nginx-1.16.1.tar.gz -C /usr/local</span><br><span class="line">//文件名改nginx-1.16.1成nginx</span><br><span class="line">//进入nginx目录</span><br><span class="line">cd /usr/local/nginx</span><br><span class="line">//关联编译https模块</span><br><span class="line"> ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br><span class="line">//执行make命令编译源码</span><br><span class="line">make</span><br><span class="line">//执行make install安装可执行bin</span><br><span class="line">make install</span><br><span class="line">//新建logs（日志）和ssl（证书）文件夹</span><br></pre></td></tr></table></figure><h3 id="https浏览器影响——混合内容"><a href="#https浏览器影响——混合内容" class="headerlink" title="https浏览器影响——混合内容"></a>https浏览器影响——混合内容</h3><blockquote><p>解决Nginx反代Tomcat Http、Https混合内容报错，浏览器认为https请求中资源是http的css、js和图片都无法正常加载，造成无法双协议兼容！</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">浏览器访问后开发者模式看到的报错信息：</span><br><span class="line">Mixed Content: The page at &#39;https:&#x2F;&#x2F;dashboard.domain.com&#x2F;wire&#39; was loaded over HTTPS, but requested an insecure stylesheet &#39;http:&#x2F;&#x2F;dashboard.domain.com&#x2F;static&#x2F;css&#x2F;flickity.css&#39;. This request has been blocked; the content must be served over HTTPS.</span><br></pre></td></tr></table></figure><h3 id="nginx解决配置"><a href="#nginx解决配置" class="headerlink" title="nginx解决配置"></a>nginx解决配置</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">user  www;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  51200;</span><br><span class="line">    multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">gzip on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  chinaffxz.com;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        </span><br><span class="line">         ssl_certificate      /usr/local/nginx/ssl/2879444_chinagzhxy.com.pem;</span><br><span class="line">         ssl_certificate_key  /usr/local/nginx/ssl/2879444_chinagzhxy.com.key;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:xxxx/;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #解决兼容配置要点</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Tomcat配置"><a href="#Tomcat配置" class="headerlink" title="Tomcat配置"></a>Tomcat配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8006"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span> <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span> <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span> <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span> <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"38080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">maxThreads</span>=<span class="string">"1000"</span> <span class="attr">minSpareThreads</span>=<span class="string">"20"</span> <span class="attr">acceptCount</span>=<span class="string">"1000"</span> <span class="attr">maxHttpHeaderSize</span>=<span class="string">"65536"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">disableUploadTimeout</span>=<span class="string">"true"</span> <span class="attr">useBodyEncodingForURI</span>=<span class="string">"true"</span> <span class="attr">enableLookups</span>=<span class="string">"false"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 解决兼容要点--&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.RemoteIpValve"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">remoteIpHeader</span>=<span class="string">"X-Forwarded-For"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">protocolHeader</span>=<span class="string">"X-Forwarded-Proto"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">protocolHeaderHttpsValue</span>=<span class="string">"https"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">             Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">             <span class="doctag">Note:</span> The pattern used is equivalent to using pattern="common" --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span> =<span class="string">"mall"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">crossContext</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="git持续部署shell脚本"><a href="#git持续部署shell脚本" class="headerlink" title="git持续部署shell脚本"></a>git持续部署shell脚本</h3><blockquote><p>解决Linux CentOS中cp -f 复制强制覆盖的命令无效的方法，系统默认使用cp -i使用交互方式避免误操作，但在自动脚本中应当避免，推荐<strong>\cp</strong>。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">update code</span></span><br><span class="line">cd /root/dowload/mall/duoshanghu</span><br><span class="line">git fetch origin </span><br><span class="line">git pull &gt; /root/dowload/mall/logs/mall_git.log &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash">package </span></span><br><span class="line">mvn package -Dmaven.test.skip=true</span><br><span class="line">sleep 2s</span><br><span class="line"><span class="meta">#</span><span class="bash">cp war to tomcat webapp</span></span><br><span class="line">\cp -fr /root/dowload/mall/duoshanghu/target/mall.war /usr/local/env/tomcat/webapps/mall.war</span><br><span class="line">sleep 1s</span><br><span class="line"><span class="meta">#</span><span class="bash">restart.sh</span></span><br><span class="line">sh /usr/local/env/tomcat/bin/restart.sh</span><br></pre></td></tr></table></figure><h3 id="tomcat重启脚本"><a href="#tomcat重启脚本" class="headerlink" title="tomcat重启脚本"></a>tomcat重启脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">初始化全局环境变量</span></span><br><span class="line">. /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">set</span> java environment</span></span><br><span class="line">export CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查找tomcat的pid</span></span><br><span class="line">pid=`ps aux | grep tomcat | grep -v grep | grep -v Restart | grep -v restart | awk '&#123;print $2&#125;'`</span><br><span class="line">echo "the tomcat pid is $pid"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">判断tomcat进程是否存在</span></span><br><span class="line">if [ -n "$pid" ];then</span><br><span class="line">   sleep 1</span><br><span class="line">   pid=`ps aux | grep tomcat | grep -v grep | grep -v restart | grep -v Restart | awk '&#123;print $2&#125;'`</span><br><span class="line">   if [ -n "$pid" ]; then</span><br><span class="line">      sleep 1</span><br><span class="line">      echo "tomcat进程将被杀?"</span><br><span class="line">      kill -9 $pid</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line">   sleep 1</span><br><span class="line"></span><br><span class="line">   echo "tomcat进程已经被杀死，先重新启动tomcat."</span><br><span class="line">   service tomcat status</span><br><span class="line">   sleep 1s</span><br><span class="line">   service tomcat start</span><br><span class="line">else</span><br><span class="line">    echo "tomcat进程不存在，先重新启动tomcat."</span><br><span class="line">    service tomcat status</span><br><span class="line">    sleep 1s</span><br><span class="line">    service tomcat start</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="maven编译完整依赖管理"><a href="#maven编译完整依赖管理" class="headerlink" title="maven编译完整依赖管理"></a>maven编译完整依赖管理</h3><h4 id="1、来源"><a href="#1、来源" class="headerlink" title="1、来源"></a>1、来源</h4><blockquote><p>解决webapp/WEB-INF/lib目录下的jar包无法用maven打包，且在linuxMaven编译报错[ERROR] Fatal Error: Unable to find package java.lang in classpath or bootclasspath，致命错误: 在类路径或引导类路径中找不到程序包 java.lang</p></blockquote><h4 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h4><p>Linux解决办法，使用maven自带的变量${path.separator}路径分隔符，原因是在Windows下是分号;，在linux下是冒号:</p><p>同时配置导入webapp/WEB-INF/lib和jdk的rt.jar、jce.jar，完美解决环境配置带来的无法package找不到依赖问题。</p><h4 id="pom-xml："><a href="#pom-xml：" class="headerlink" title="pom.xml："></a>pom.xml：</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">verbose</span> /&gt;</span>                    <span class="tag">&lt;<span class="name">bootclasspath</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar$&#123;path.separator&#125;$&#123;java.home&#125;/lib/jce.jar<span class="tag">&lt;/<span class="name">bootclasspath</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">extdirs</span>&gt;</span>$&#123;basedir&#125;/src/main/webapp/WEB-INF/lib<span class="tag">&lt;/<span class="name">extdirs</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://spex.top/archives/nginx-tomcat-http-https.html" target="_blank" rel="noopener">解决Nginx反代Tomcat Http、Https混合内容报错</a></p><p><a href="https://blog.csdn.net/u012204058/article/details/54974053" target="_blank" rel="noopener">解决WEB-INF/lib目录下的jar包无法用maven打包</a></p><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>当了组长面试加运维，对接一堆支付和物流、短信和推送账号，今天记录一下面向DevOps！</li><li>markdown原文件在github里面，感谢各位大佬看官star，面试我要往脸上贴金哈哈哈😂。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a>，有问题发邮件。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;服务器配置记录&quot;&gt;&lt;a href=&quot;#服务器配置记录&quot; class=&quot;headerlink&quot; title=&quot;服务器配置记录&quot;&gt;&lt;/a&gt;服务器配置记录&lt;/h1&gt;&lt;h2 id=&quot;一、背景&quot;&gt;&lt;a href=&quot;#一、背景&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
    
    
      <category term="Linux" scheme="https://caochikai.github.io/tags/Linux/"/>
    
      <category term="nginx" scheme="https://caochikai.github.io/tags/nginx/"/>
    
      <category term="maven" scheme="https://caochikai.github.io/tags/maven/"/>
    
      <category term="tomcat" scheme="https://caochikai.github.io/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>JVM记录</title>
    <link href="https://caochikai.github.io/2019/09/14/JVM%E8%AE%B0%E5%BD%95/"/>
    <id>https://caochikai.github.io/2019/09/14/JVM%E8%AE%B0%E5%BD%95/</id>
    <published>2019-09-14T04:32:49.000Z</published>
    <updated>2019-09-14T04:34:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JVM记录"><a href="#JVM记录" class="headerlink" title="JVM记录"></a>JVM记录</h1><h2 id="一、错误"><a href="#一、错误" class="headerlink" title="一、错误"></a>一、错误</h2><ol><li>背景：<a href="https://github.com/caochikai/webmagicForPros" target="_blank" rel="noopener">自动答题爬虫</a>由于买的腾讯云1核2G1M，Jenkins、springboot爬虫和火狐浏览器驱动。</li><li>知识背景：<a href="https://www.jianshu.com/p/134bd5b913c5" target="_blank" rel="noopener">JDWP</a>：调试网络协议(Java Debug Wire Protocol)；调试线协议；<a href="https://juejin.im/post/5b0925ec51882538aa1ee248" target="_blank" rel="noopener">jvmti</a>：（Java Virtual Machine Tool Interface）jvm代理；</li><li>猜测：Selenium通过driver驱动Firefox浏览器，多次无法关闭浏览器造成内存无法释放最后溢出； </li><li>引用文章（有兴趣可深入了解）：<a href="https://blog.csdn.net/duqi_2009/article/details/94518203" target="_blank" rel="noopener">jvmti agent黑科技</a>，阿里云云监控；</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR in native method: JDWP Can&#39;t allocate jvmti memory, jvmtiError&#x3D;JVMTI_ERROR_OUT_OF_MEMORY(110)</span><br></pre></td></tr></table></figure><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>立个flag：不定期更新，一更一周。</li><li>markdown原文件在github里面，感谢各位大佬看官star，面试我要往脸上贴金哈哈哈😂。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a>，有问题发邮件。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;JVM记录&quot;&gt;&lt;a href=&quot;#JVM记录&quot; class=&quot;headerlink&quot; title=&quot;JVM记录&quot;&gt;&lt;/a&gt;JVM记录&lt;/h1&gt;&lt;h2 id=&quot;一、错误&quot;&gt;&lt;a href=&quot;#一、错误&quot; class=&quot;headerlink&quot; title=&quot;一、错误&quot;
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="JVM" scheme="https://caochikai.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>工具收藏——idea推荐插件</title>
    <link href="https://caochikai.github.io/2019/05/22/%E5%B7%A5%E5%85%B7%E6%94%B6%E8%97%8F%E2%80%94%E2%80%94idea%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6/"/>
    <id>https://caochikai.github.io/2019/05/22/%E5%B7%A5%E5%85%B7%E6%94%B6%E8%97%8F%E2%80%94%E2%80%94idea%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6/</id>
    <published>2019-05-22T12:34:48.000Z</published>
    <updated>2019-05-22T13:25:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="工具收藏——idea推荐插件"><a href="#工具收藏——idea推荐插件" class="headerlink" title="工具收藏——idea推荐插件"></a>工具收藏——idea推荐插件</h2><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><blockquote><p>​    工欲善其事必先利其器，博主是个死忠工具派，为了解决一个大问题可能会收集多个工具和方案，然后求证对比出体验报告。后续文章有一大类就是工具类推荐，而本篇文章重点就是idea 安装插件记录，简要记录安装方法快速搭建个性化idea，还有一些关于UI方面插件可谓多不胜数，而且每个人口味不一，请各位自行选择——插件搜索技巧tags为<a href="https://plugins.jetbrains.com/search?correctionAllowed=true&pr=&orderBy=relevance&&tags=Theme" target="_blank" rel="noopener">Theme或者UI</a>。</p></blockquote><hr><h2 id="插件列表"><a href="#插件列表" class="headerlink" title="插件列表"></a>插件列表</h2><h4 id="最强大插件卫冕之王——lambda表达式"><a href="#最强大插件卫冕之王——lambda表达式" class="headerlink" title="最强大插件卫冕之王——lambda表达式"></a>最强大插件卫冕之王——<strong>lambda表达式</strong></h4><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td><strong>JRebel</strong></td><td>代替springboot dev热部署方案，<a href="https://blog.csdn.net/qq_40110871/article/details/83420125" target="_blank" rel="noopener">最方便激活方式</a></td></tr><tr><td>Lombok</td><td>精简bean，各种功能强大又实用注解，搬砖人的MVP，结合<a href="https://www.hutool.club/docs/#/" target="_blank" rel="noopener">Hutool</a>实在完美</td></tr><tr><td>AceJump</td><td>光标跳跃，替代vim不二之选</td></tr><tr><td>MavenHelper</td><td>快速分析maven 包冲突的问题，搜索包名</td></tr><tr><td>MyBatis Log Plugin</td><td>Restore the mybatis generate sql to original whole sql.（拼接完整sql）</td></tr><tr><td>Log Support 2</td><td>快速log.info()，结合Lombok插件注解@Slf4j可以说无敌</td></tr><tr><td>Free Mybatis plugin</td><td>Mybaits支持跳转，有钱大爷请收费版Mybatis plugin强大破解较少，<a href="https://plugins.jetbrains.com/plugin/7293-mybatis-plugin/reviews" target="_blank" rel="noopener"><strong>差评</strong></a></td></tr><tr><td>Rainbow Brackets</td><td>彩虹括号，多层嵌套代码显示助手</td></tr><tr><td>String Manipulation</td><td>各种各样字符串格式转化</td></tr><tr><td>RestfulToolkit</td><td>一套 RESTful 服务开发辅助工具集</td></tr><tr><td>Alibaba Cloud Toolkit</td><td>结合阿里云（非阿里也支持），多节点发布工具加强力linux客户端</td></tr><tr><td>stackoverflow</td><td>stackoverflow快速搜索bug插件</td></tr><tr><td>Translation</td><td>最强大的翻译插件，支持中文替换英文，解决起英文变量名难的重度患者</td></tr><tr><td>Key Promoter X</td><td>所有操作的快捷键提示，忘记鼠标真的</td></tr><tr><td><strong>Cyan Light Theme</strong></td><td>A light theme，偏青色对眼睛很柔和舒服，黑暗主题实在不适应</td></tr></tbody></table><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>2012年java程序员可以说非常吃香，今年2019从业人数暴增，职业发展挑战变得越来越大！现在流行自动构建和自动部署CI，开发运维一体化docker，整个互联网都在追求敏捷开发的今天。掌握一款追求效率功能的IDE非常重要，很多群和公众号对ide和Eclipse争议很大。但请记住斯大林名言——落后就要挨打，ide本身代表高效，但是插件也别装太多，免得启动还要半天哈哈哈😀</li><li>（首推）慕课网免费教程：<a href="http://www.imooc.com/learn/924" target="_blank" rel="noopener">IntelliJ IDEA神器使用技巧</a></li><li>（推荐）尚硅谷IDEA视频教程：链接：<a href="https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQ，密码：n7hn" target="_blank" rel="noopener">https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQ，密码：n7hn</a></li><li>看完上面两个教程，你会怀疑自己用的idea是假的，原来写代码还可以这样的。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;工具收藏——idea推荐插件&quot;&gt;&lt;a href=&quot;#工具收藏——idea推荐插件&quot; class=&quot;headerlink&quot; title=&quot;工具收藏——idea推荐插件&quot;&gt;&lt;/a&gt;工具收藏——idea推荐插件&lt;/h2&gt;&lt;h2 id=&quot;一、概念&quot;&gt;&lt;a href=&quot;#一
      
    
    </summary>
    
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
      <category term="plugin" scheme="https://caochikai.github.io/tags/plugin/"/>
    
      <category term="idea" scheme="https://caochikai.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>springboot整合elasticsearch</title>
    <link href="https://caochikai.github.io/2019/05/21/springboot%E6%95%B4%E5%90%88elasticsearch/"/>
    <id>https://caochikai.github.io/2019/05/21/springboot%E6%95%B4%E5%90%88elasticsearch/</id>
    <published>2019-05-21T13:40:31.000Z</published>
    <updated>2019-05-22T12:40:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="springboot整合elasticsearch"><a href="#springboot整合elasticsearch" class="headerlink" title="springboot整合elasticsearch"></a>springboot整合elasticsearch</h2><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><blockquote><p><a href="https://www.elastic.co/cn/" target="_blank" rel="noopener">elasticsearch官网</a>是一个分布式多用户能力的全文搜索引擎，也是一个具有RESTful web接口的java应用。目前开源软件商业比较不错的例子，与Solr一样都是基于Lucene，大数据hadoop也是脱胎于Lucene。Solr开源而且生态比较成熟，elasticsearch目前最火也是商业应用方面非常好的搜索引擎。</p></blockquote><h3 id="3w原则："><a href="#3w原则：" class="headerlink" title="3w原则："></a>3w原则：</h3><ol><li>question what：常见站内/app内搜索服务需求：商品文章的模糊搜索，精确搜索，拼音搜索 。</li><li>question why：借助elasticsearch和analysis-ik中文分词器，快速实现搜索服务功能。</li><li>how：在微服务当中，通常利用mq消息中间件来同步数据集群搜索服务（脚手架里没有mq），借助ElasticsearchTemplate（spring 模板工具类强大）API维护索引和搜索查询。</li></ol><h2 id="二、落地实现"><a href="#二、落地实现" class="headerlink" title="二、落地实现"></a>二、落地实现</h2><blockquote><p>根据<a href="https://gitee.com/11230595/springboot-elasticsearch" target="_blank" rel="noopener">码云企业级搜索脚手架</a>的文档可知，注意版本为Springboot2.1.1+elasticsearch6.5.3，elasticsearch和analysis-ik插件版本必须统一，而且新版本elasticsearch 7不适用于该工程。这个参考工程的中文分词搜索效果不太理想，一般富文本的内容进入索引之前要利用字符过滤器清洗不正常的字符。通常为了保证索引时覆盖度和搜索时准确度,索引分词器采用ik_max_word,搜索分析器采用ik_smart模式。具体elasticsearch6.5.3的安装过程请参考码云的README.md，目前正在在公司项目使用请放心，单元测试的效果也非常nice。</p></blockquote><h4 id="1、添加依赖"><a href="#1、添加依赖" class="headerlink" title="1、添加依赖"></a>1、添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2、配置引导类"><a href="#2、配置引导类" class="headerlink" title="2、配置引导类"></a>2、配置引导类</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#============================</span></span><br><span class="line"><span class="comment"># 默认的节点名称elasticsearch</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-name</span>=<span class="string">my-application</span></span><br><span class="line"><span class="comment"># elasticsearch 调用地址，多个使用“,”隔开</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-nodes</span>=<span class="string">localhost:9300</span></span><br></pre></td></tr></table></figure><h4 id="3、DWMQSender包装rabbitTemplate发送消息同步数据"><a href="#3、DWMQSender包装rabbitTemplate发送消息同步数据" class="headerlink" title="3、DWMQSender包装rabbitTemplate发送消息同步数据"></a>3、DWMQSender包装rabbitTemplate发送消息同步数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务类的简写如下</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//注入sender    </span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DWMQSender sender;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送写法ArticlesMessage extends DWMQMessage&lt;消息内容类型&gt;</span></span><br><span class="line">JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(articles));</span><br><span class="line"> jsonObject.put(Groups.ACTION, Groups.ADD);</span><br><span class="line"> sender.sendMessage(<span class="keyword">new</span> ArticlesMessage(jsonObject));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//封装发送mq message</span></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.exception.EU;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.mq.mto.DWMQMessage;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.utils.SU;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.AmqpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.support.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息成功发送到MQ服务器后的回调确认</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DWMQSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DWMQRetry retry;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(DWMQMessage mto)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( mto.getObj()==<span class="keyword">null</span> ) &#123;</span><br><span class="line">            EU.te(<span class="string">"消息内容为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( SU.isNull( mto.getRoutingKey()) ) &#123;</span><br><span class="line">            EU.te(<span class="string">"路由规则为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">"准备发送【%s】"</span>, mto.getInfo()));</span><br><span class="line"></span><br><span class="line">        mto.setId(retry.generateId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( SU.isNull(mto.getExchange()) &amp;&amp; mto.getExpire()&lt;<span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">//默认的没有交换器，则直接发送到指定的队列</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mto.getExpire()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//经过交换器，按路由规则匹配队列</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getExchange(), mto.getRoutingKey(), mto.getObj(), <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//默认的没有交换器，则直接发送到指定的队列，发送延迟消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), message -&gt; &#123;</span><br><span class="line">                message.getMessageProperties().setExpiration(mto.getExpire()+<span class="string">""</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;, <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mto.setCtime(System.currentTimeMillis());</span><br><span class="line">        retry.add(mto, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、RabbitListener接收到消息同步数据"><a href="#4、RabbitListener接收到消息同步数据" class="headerlink" title="4、RabbitListener接收到消息同步数据"></a>4、RabbitListener接收到消息同步数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索服务接收到管理后台用户修改文章同步消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="comment">//配置mq消息队列，接收文件同步消息</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = DirectMQConfig.DIRECT_ARTICLES_ELASTIC_QUEUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticlesReceiver</span> <span class="keyword">extends</span> <span class="title">DWMQBaseReceiver</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleETOService etoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">getClazz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processMessage</span><span class="params">(String mto)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Received 管理后台用户-修改文章同步消息接收:&#123;&#125;"</span>, mto);</span><br><span class="line">        JSONObject jsonObject = JSON.parseObject(mto);</span><br><span class="line">        String action = jsonObject.getString(Groups.ACTION);</span><br><span class="line">        <span class="comment">//删除操作要删除索引，更新操作先删除后</span></span><br><span class="line">        ArticleETO articles = JSON.parseObject(jsonObject.toJSONString(), ArticleETO<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String articlesId = articles.getId();</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> Groups.ADD:</span><br><span class="line">                etoService.save(articles);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Groups.UPDATE:</span><br><span class="line">                etoService.delete(articlesId);</span><br><span class="line">                etoService.save(articles);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Groups.DELETE:</span><br><span class="line">                etoService.delete(articlesId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、公共搜索方法"><a href="#5、公共搜索方法" class="headerlink" title="5、公共搜索方法"></a>5、公共搜索方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 高亮显示，返回分页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@auther</span>: zhoudong</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span>: 2018/12/18 10:29</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IPage&lt;Map&lt;String, Object&gt;&gt; queryHitByPage(<span class="keyword">int</span> pageNo, <span class="keyword">int</span> pageSize, String keyword, String indexName, String... fieldNames) &#123;</span><br><span class="line">        <span class="comment">// 构造查询条件,使用标准分词器.</span></span><br><span class="line">        QueryBuilder matchQuery = createQueryBuilder(keyword, fieldNames);</span><br><span class="line">        <span class="comment">// 设置高亮,使用默认的highlighter高亮器</span></span><br><span class="line">        HighlightBuilder highlightBuilder = createHighlightBuilder(fieldNames);</span><br><span class="line">        <span class="comment">// 设置查询字段</span></span><br><span class="line">        SearchResponse response = elasticsearchTemplate.getClient().prepareSearch(indexName)</span><br><span class="line">                .setQuery(bool)</span><br><span class="line">                .highlighter(highlightBuilder)</span><br><span class="line">                .setFrom((pageNo - <span class="number">1</span>) * pageSize)</span><br><span class="line">                .setSize(pageNo * pageSize) <span class="comment">// 设置一次返回的文档数量，最大值：10000</span></span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回搜索结果</span></span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line"></span><br><span class="line">        Long totalCount = hits.getTotalHits();</span><br><span class="line">        IPage&lt;Map&lt;String, Object&gt;&gt; page = <span class="keyword">new</span> Page&lt;&gt;(pageNo, pageSize, totalCount);</span><br><span class="line">        page.setRecords(getHitList(hits));</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>今天终于出了elasticsearch文章，以后我会在对应专题的文章放出相关的百度云资源，这些都是网上流传比较广的资源，想找好的学习资源也可以与我合伙买绝版视频，有钱买正版吧（作者很穷，找工作从来没有造假包装，只能混成这个卵样😭，世道维艰，如果不是感觉做码农还算有点天赋，早就转行了）。</li><li>百度云 :<a href="https://pan.baidu.com/s/1d2adCgJMuwt6UmAxEMRYxA#list/path=%2F" target="_blank" rel="noopener">下载街/01.Elasticsearch顶尖高手系列课程</a>，密码：iw7f</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;springboot整合elasticsearch&quot;&gt;&lt;a href=&quot;#springboot整合elasticsearch&quot; class=&quot;headerlink&quot; title=&quot;springboot整合elasticsearch&quot;&gt;&lt;/a&gt;springboot整
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="elasticsearch" scheme="https://caochikai.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Springboot整合Quartz定时器</title>
    <link href="https://caochikai.github.io/2019/05/20/Spring%20boot%E6%95%B4%E5%90%88Quartz%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
    <id>https://caochikai.github.io/2019/05/20/Spring%20boot%E6%95%B4%E5%90%88Quartz%E5%AE%9A%E6%97%B6%E5%99%A8/</id>
    <published>2019-05-20T12:25:37.000Z</published>
    <updated>2019-05-21T13:26:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-boot整合Quartz定时器"><a href="#Spring-boot整合Quartz定时器" class="headerlink" title="Spring boot整合Quartz定时器"></a>Spring boot整合Quartz定时器</h1><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><blockquote><p><a href="http://www.quartz-scheduler.org" target="_blank" rel="noopener">quartz官网</a>是一个完全由 Java 编写的开源作业调度框架，结合数据库甚至可以做到分布式调度。目前参考的<a href="https://gitee.com/y_project/RuoYi" target="_blank" rel="noopener">RuoYi后台脚手架</a>的定时任务模块，支持在线（添加、修改、删除)任务调度，并记录执行日志作业结果。</p></blockquote><h3 id="3w原则："><a href="#3w原则：" class="headerlink" title="3w原则："></a>3w原则：</h3><ol><li>question what：定时任务，比如定时答题、商家结算等需求，并且支持立即运行、暂停和禁止。</li><li>question why：借助quartz springboot生态和后台脚手架，快速实现定时调度功能。</li><li>how：实现<strong>JobDetail</strong>运行任务详情，<strong>Trigger</strong> 触发器定义触发规则，<strong>Scheduler</strong> 调度中心/容器注册多个 JobDetail 和 Trigger。Trigger 与 JobDetail 组合即可被Scheduler调用。</li></ol><h2 id="二、落地实现"><a href="#二、落地实现" class="headerlink" title="二、落地实现"></a>二、落地实现</h2><blockquote><p>根据<a href="http://doc.ruoyi.vip/#/standard/htsc?id=定时任务" target="_blank" rel="noopener">若依脚手架</a>的文档可知，定时任务工程模块为ruoyi-quartz，结合sql/quartz.sql导入关于定时器数据库表。当然这种做法需要数据库和bootstrap，为了简化，我采取的替代方案是保留定时和立即执行功能，抛弃手动在代码硬编码新加定时器，web管理面板则通过swagger触发任务调度立即执行一次。极端偷懒方式，@Scheduled(cron = “”)放在在cotroller方法，同事推荐给我的😀。</p></blockquote><h4 id="1、添加依赖"><a href="#1、添加依赖" class="headerlink" title="1、添加依赖"></a>1、添加依赖</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="2、配置引导类"><a href="#2、配置引导类" class="headerlink" title="2、配置引导类"></a>2、配置引导类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模块加载</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinApplication</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、注册JobDetail和Trigger"><a href="#3、注册JobDetail和Trigger" class="headerlink" title="3、注册JobDetail和Trigger"></a>3、注册JobDetail和Trigger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在线表达式：http://cron.qqe2.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TASK_CLASS_NAME = <span class="string">"reportNowTask"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">reportNowTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(reportNowTask<span class="class">.<span class="keyword">class</span>).<span class="title">withIdentity</span>(<span class="title">TASK_CLASS_NAME</span>).<span class="title">storeDurably</span>().<span class="title">build</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">reportNowTaskTrigger</span><span class="params">(JobDetail reportNowTask)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//cronSchedule等于@Scheduled(cron = ""),但是通过注解无法配置jobkey</span></span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(reportNowTask)</span><br><span class="line">                .withIdentity(<span class="string">"reportNowTaskTrigger"</span>)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"9 0 19 * * ?"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、任务详情继承QuartzJobBean或者实现Job接口"><a href="#4、任务详情继承QuartzJobBean或者实现Job接口" class="headerlink" title="4、任务详情继承QuartzJobBean或者实现Job接口"></a>4、任务详情继承QuartzJobBean或者实现Job接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">reportNowTask</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        ......<span class="comment">//任务内容</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、立即执行"><a href="#5、立即执行" class="headerlink" title="5、立即执行"></a>5、立即执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"问题模块"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"question"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuestionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务调度立即执行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/run"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">        <span class="comment">//api秘诀就在这里根据QuartzConfig jobKey触发作业调度</span></span><br><span class="line">        scheduler.triggerJob(JobKey.jobKey(QuartzConfig.TASK_CLASS_NAME));</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"执行成功！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>今天粗略简易版的定时任务,功能强大的请查看若依后台脚手架,github和码云有很多类似脚手架,但是我们有选择性copy学习才是重点😊。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Spring-boot整合Quartz定时器&quot;&gt;&lt;a href=&quot;#Spring-boot整合Quartz定时器&quot; class=&quot;headerlink&quot; title=&quot;Spring boot整合Quartz定时器&quot;&gt;&lt;/a&gt;Spring boot整合Quartz定
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="quartz" scheme="https://caochikai.github.io/tags/quartz/"/>
    
  </entry>
  
  <entry>
    <title>springboot源码分析之启动过程</title>
    <link href="https://caochikai.github.io/2019/05/19/springboot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>https://caochikai.github.io/2019/05/19/springboot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</id>
    <published>2019-05-19T13:50:35.000Z</published>
    <updated>2019-05-20T13:23:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="springboot源码分析之启动过程"><a href="#springboot源码分析之启动过程" class="headerlink" title="springboot源码分析之启动过程"></a>springboot源码分析之启动过程</h1><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><blockquote><p>计划写一波springboot 2.x源码分析，只写实用性比较高的特性，从<a href="https://github.com/spring-projects/spring-boot/tags?after=v1.0.0.RC3" target="_blank" rel="noopener">GitHub</a>上看出更新频率在一个月左右，更新极快非常活跃。</p></blockquote><h4 id="版本发行"><a href="#版本发行" class="headerlink" title="版本发行:"></a>版本发行:</h4><table><thead><tr><th>版本</th><th>时间线</th><th>说明</th></tr></thead><tbody><tr><td>v0.5.0.M1</td><td>2013-08-06</td><td>第一个版本</td></tr><tr><td>v2.2.0.M3</td><td>2019-05-15</td><td>当前最新版本</td></tr></tbody></table><h2 id="二、源码分析"><a href="#二、源码分析" class="headerlink" title="二、源码分析"></a>二、源码分析</h2><blockquote><p>SpringBoot的启动引导类写法多样，标记了@SpringBootApplication的class作为源类，代码如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//简易版</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">             SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过 SpringApplicationBuilder API</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiveInSpringBootApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> SpringApplicationBuilder(DiveInSpringBootApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">bannerMode</span>(<span class="title">Banner</span>.<span class="title">Mode</span>.<span class="title">CONSOLE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line">                .profiles("prod")</span><br><span class="line">                .headless(<span class="keyword">true</span>)</span><br><span class="line">                .run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明new</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationBootstrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        SpringApplication.run(ApplicationConfiguration.class,args);</span></span><br><span class="line"></span><br><span class="line">        Set sources = <span class="keyword">new</span> HashSet();</span><br><span class="line">        <span class="comment">// 配置Class 名称</span></span><br><span class="line">        sources.add(ApplicationConfiguration<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication();</span><br><span class="line">        <span class="comment">//配置源</span></span><br><span class="line">        springApplication.setSources(sources);</span><br><span class="line">        <span class="comment">//配置控制台banner</span></span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.CONSOLE);</span><br><span class="line">        <span class="comment">//声明web类型</span></span><br><span class="line">        springApplication.setWebApplicationType(WebApplicationType.NONE);</span><br><span class="line">        <span class="comment">//多环境配置激活</span></span><br><span class="line">        springApplication.setAdditionalProfiles(<span class="string">"prod"</span>);</span><br><span class="line">        <span class="comment">//java.awt.headless禁用模式</span></span><br><span class="line">        springApplication.setHeadless(<span class="keyword">true</span>);</span><br><span class="line">        springApplication.run(args);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpringBootApplication</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>从代码上可以看出，调用了SpringApplication的静态方法run。这个run方法会构造一个SpringApplication的实例，然后再调用这里实例的run方法就表示启动SpringBoot。因此，想要分析SpringBoot的启动过程，我们需要熟悉SpringApplication的构造过程以及SpringApplication的run方法执行过程即可。</p></blockquote><h3 id="SpringApplication的准备过程"><a href="#SpringApplication的准备过程" class="headerlink" title="SpringApplication的准备过程"></a>SpringApplication的准备过程</h3><ul><li><p>配置 Spring Boot Bean 源：Java 配置 Class 或 XML 上下文配置文件集合，用于 Spring Boot BeanDefinitionLoader 读取 ，并且将配置源解析加载为Spring Bean 定义。</p></li><li><p>推断 Web 应用类型：根据当前应用 ClassPath 中是否存在相关实现类来推断 Web 应用的类型。参考方法：org.springframework.boot.SpringApplication#deduceWebApplicationType。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> WebApplicationType <span class="title">deduceWebApplicationType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, <span class="keyword">null</span>)</span><br><span class="line">    &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, <span class="keyword">null</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : WEB_ENVIRONMENT_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>推断引导类（Main Class）：根据 Main 线程执行堆栈判断实际的引导类。参考方法： org.springframework.boot.SpringApplication#deduceMainApplicationClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Class <span class="title">deduceMainApplicationClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//获取堆栈输出方法名称</span></span><br><span class="line">            StackTraceElement[] stackTrace = <span class="keyword">new</span> RuntimeException().getStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement stackTraceElement : stackTrace) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"main"</span>.equals(stackTraceElement.getMethodName())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Class.forName(stackTraceElement.getClassName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="comment">// Swallow and continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>加载应用上下文初始器 （ ApplicationContextInitializer ）：利用 Spring 工厂加载机制，实例化 ApplicationContextInitializer 实现类，并排序对象集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现类： org.springframework.core.io.support.SpringFactoriesLoader</span></span><br><span class="line"><span class="comment">//配置资源： META-INF/spring.factories</span></span><br><span class="line"><span class="comment">//排序： AnnotationAwareOrderComparator#sort</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>  Collection <span class="title">getSpringFactoriesInstances</span><span class="params">(Class type,</span></span></span><br><span class="line"><span class="function"><span class="params">            Class[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">        Set names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(</span><br><span class="line">                SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">        List instances = createSpringFactoriesInstances(type, parameterTypes,</span><br><span class="line">                classLoader, args, names);</span><br><span class="line">        AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">        <span class="keyword">return</span> instances;</span><br><span class="line">    &#125;·</span><br></pre></td></tr></table></figure></li><li><p>加载应用事件监听器（ ApplicationListener ）：利用 Spring 工厂加载机制，实例化 ApplicationListener 实现类，并排序对象集合。</p></li></ul><h3 id="SpringApplication-运行阶段"><a href="#SpringApplication-运行阶段" class="headerlink" title="SpringApplication 运行阶段"></a>SpringApplication 运行阶段</h3><ul><li><p>加载 SpringApplication 运行监听器（ SpringApplicationRunListeners ）：利用 Spring 工厂加载机制，读取 SpringApplicationRunListener 对象集合，并且封装到组合类SpringApplicationRunListeners。</p></li><li><p>运行 SpringApplication 运行监听器（ SpringApplicationRunListeners ）：</p><ol><li>started(run方法执行的时候立马执行；对应事件的类型是ApplicationStartedEvent)</li><li>environmentPrepared(ApplicationContext创建之前并且环境信息准备好的时候调用；对应事件的类型是ApplicationEnvironmentPreparedEvent)</li><li>contextPrepared(ApplicationContext创建好并且在source加载之前调用一次；没有具体的对应事件)</li><li>contextLoaded(ApplicationContext创建并加载之后并在refresh之前调用；对应事件的类型是ApplicationPreparedEvent)</li><li>finished(run方法结束之前调用；对应事件的类型是ApplicationReadyEvent或ApplicationFailedEvent)</li></ol></li><li><p>创建 Spring 应用上下文（ ConfigurableApplicationContext ）:根据准备阶段的推断 Web 应用类型创建对应ConfigurableApplicationContext 实例：</p><ul><li>Web Reactive： AnnotationConfigReactiveWebServerApplicationContext</li><li>Web Servlet： AnnotationConfigServletWebServerApplicationContext</li><li>非 Web： AnnotationConfigApplicationContext</li></ul></li><li><p>创建 Environment：根据准备阶段的推断 Web 应用类型创建对应的 ConfigurableEnvironment 实例。</p><ul><li>Web Reactive： StandardEnvironment</li><li>Web Servlet： StandardServletEnvironment</li><li>非 Web： StandardEnvironment</li></ul></li></ul><h3 id="run方法分析"><a href="#run方法分析" class="headerlink" title="run方法分析"></a>run方法分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  StopWatch stopWatch = <span class="keyword">new</span> StopWatch(); <span class="comment">// 构造一个任务执行观察器</span></span><br><span class="line">  stopWatch.start(); <span class="comment">// 开始执行，记录开始时间</span></span><br><span class="line">  ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">  configureHeadlessProperty();</span><br><span class="line">  <span class="comment">// 获取SpringApplicationRunListeners，内部只有一个EventPublishingRunListener</span></span><br><span class="line">  SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">  <span class="comment">// 上面分析过，会封装成SpringApplicationEvent事件然后广播出去给SpringApplication中的listeners所监听</span></span><br><span class="line">  <span class="comment">// 这里接受ApplicationStartedEvent事件的listener会执行相应的操作</span></span><br><span class="line">  listeners.started();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 构造一个应用程序参数持有类</span></span><br><span class="line">    ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">        args);</span><br><span class="line">    <span class="comment">// 创建Spring容器</span></span><br><span class="line">    context = createAndRefreshContext(listeners, applicationArguments);</span><br><span class="line">    <span class="comment">// 容器创建完成之后执行额外一些操作</span></span><br><span class="line">    afterRefresh(context, applicationArguments);</span><br><span class="line">    <span class="comment">// 广播出ApplicationReadyEvent事件给相应的监听器执行</span></span><br><span class="line">    listeners.finished(context, <span class="keyword">null</span>);</span><br><span class="line">    stopWatch.stop(); <span class="comment">// 执行结束，记录执行时间</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">      <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">          .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context; <span class="comment">// 返回Spring容器</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    handleRunFailure(context, listeners, ex); <span class="comment">// 这个过程报错的话会执行一些异常操作、然后广播出ApplicationFailedEvent事件给相应的监听器执行</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h2><ul><li>为了快大多分析的不好写的很乱，凑合看下我以后改下排版😂。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;springboot源码分析之启动过程&quot;&gt;&lt;a href=&quot;#springboot源码分析之启动过程&quot; class=&quot;headerlink&quot; title=&quot;springboot源码分析之启动过程&quot;&gt;&lt;/a&gt;springboot源码分析之启动过程&lt;/h1&gt;&lt;h2 i
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="quartz" scheme="https://caochikai.github.io/tags/quartz/"/>
    
  </entry>
  
  <entry>
    <title>地理定位业务实现</title>
    <link href="https://caochikai.github.io/2019/05/18/%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0/"/>
    <id>https://caochikai.github.io/2019/05/18/%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0/</id>
    <published>2019-05-18T12:19:01.000Z</published>
    <updated>2019-05-18T13:44:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="地理定位业务实现"><a href="#地理定位业务实现" class="headerlink" title="地理定位业务实现"></a>地理定位业务实现</h1><h2 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h2><h4 id="3w原则："><a href="#3w原则：" class="headerlink" title="3w原则："></a>3w原则：</h4><ol><li><p>question what：a、附近一定范围的目标（电子围栏）；b、该经纬度的地理位置名称（省市县街道）。</p></li><li><p>why：解决上述问题的本质是获得经纬度，途径为硬件、<strong>GPS定位服务</strong>、基站定位，地理位置通过百度、谷歌、腾讯地图，基本所有地图免费版都有日访问量限制。</p></li><li><p>how：通过安卓或者IOS获取经纬度，再借助百度地图接口获取地理位置，距离也可通过接口或者谷歌地图算法。</p></li></ol><blockquote><p>GPS是英文Global Positioning System（全球定位系统）的简称。</p></blockquote><h2 id="二、解决方式"><a href="#二、解决方式" class="headerlink" title="二、解决方式"></a>二、解决方式</h2><ol><li><p>场景：小程序获取附近的好友，<a href="https://developers.weixin.qq.com/miniprogram/dev/api/wx.getLocation.html" target="_blank" rel="noopener">微信官方文档</a> wx.getLocation(Object object)。</p></li><li><p>现象：需要用户授权，前端获得gps 坐标通过接口传数据后台，保存到用户表（1：1关系）。</p></li><li><p>地图选择：其实纯前端基本也能解决基本问题，腾讯地图对小程序支持最好，根据<a href="https://lbs.qq.com/qqmap_wx_jssdk/method-reverseGeocoder.html" target="_blank" rel="noopener">JavaScript SDK文档</a>可以拥有如下功能：绘制地图，地点搜索，关键词输入提示，逆地址解析（坐标位置描述），地址解析（地址转坐标，路线规划，距离计算，获取城市列表，获取城市区县。</p></li><li><p>业务前提：用户必须授权才能使用该功能，当拥有所有用户经纬度，通过数据库语句获取当前用户经纬度在一定距离，并且可以排行。</p></li></ol><h3 id="三、落地编码"><a href="#三、落地编码" class="headerlink" title="三、落地编码"></a>三、落地编码</h3><h4 id="sql版例子："><a href="#sql版例子：" class="headerlink" title="sql版例子："></a>sql版例子：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql版，根据谷歌地图公式计算点歌经纬度之间距离，单位为m（米）</span></span><br><span class="line"><span class="keyword">select</span> e.id,</span><br><span class="line">       e.longitude,</span><br><span class="line">       e.latitude,</span><br><span class="line">       <span class="keyword">ROUND</span>(</span><br><span class="line">                   <span class="number">6378.138</span> * <span class="number">2</span> * <span class="keyword">ASIN</span>(</span><br><span class="line">                       <span class="keyword">SQRT</span>(</span><br><span class="line">                                   <span class="keyword">POW</span>(</span><br><span class="line">                                           <span class="keyword">SIN</span>(</span><br><span class="line">                                                       (</span><br><span class="line">                                                           e.latitude * <span class="keyword">PI</span>() / <span class="number">180</span> - <span class="number">23.12463</span> * <span class="keyword">PI</span>() / <span class="number">180</span></span><br><span class="line">                                                           ) / <span class="number">2</span></span><br><span class="line">                                               ),</span><br><span class="line">                                           <span class="number">2</span></span><br><span class="line">                                       ) + <span class="keyword">COS</span>(e.latitude * <span class="keyword">PI</span>() / <span class="number">180</span>) * <span class="keyword">COS</span>(<span class="number">23.12463</span> * <span class="keyword">PI</span>() / <span class="number">180</span>) * <span class="keyword">POW</span>(</span><br><span class="line">                                       <span class="keyword">SIN</span>(</span><br><span class="line">                                                   (</span><br><span class="line">                                                       e.longitude * <span class="keyword">PI</span>() / <span class="number">180</span> - <span class="number">113.36189</span> * <span class="keyword">PI</span>() / <span class="number">180</span></span><br><span class="line">                                                       ) / <span class="number">2</span></span><br><span class="line">                                           ),</span><br><span class="line">                                       <span class="number">2</span></span><br><span class="line">                                   )</span><br><span class="line">                           )</span><br><span class="line">                   ) * <span class="number">1000</span></span><br><span class="line">           ) <span class="keyword">AS</span> distance</span><br><span class="line"><span class="keyword">FROM</span> dw_dbei_user e</span><br><span class="line"><span class="keyword">having</span> distance &lt; <span class="number">4000</span></span><br></pre></td></tr></table></figure><h4 id="工具类（获取两点距离）："><a href="#工具类（获取两点距离）：" class="headerlink" title="工具类（获取两点距离）："></a>工具类（获取两点距离）：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">//private static double EARTH_RADIUS = 6378.137;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> EARTH_RADIUS = <span class="number">6371.393</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">rad</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算两个经纬度之间的距离</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat1 纬度1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng1 经度1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat2 纬度2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng2 经度2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 计算结果单位：米</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">GetDistance</span><span class="params">(<span class="keyword">double</span> lat1, <span class="keyword">double</span> lng1, <span class="keyword">double</span> lat2, <span class="keyword">double</span> lng2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> radLat1 = rad(lat1);</span><br><span class="line">        <span class="keyword">double</span> radLat2 = rad(lat2);</span><br><span class="line">        <span class="keyword">double</span> a = radLat1 - radLat2;</span><br><span class="line">        <span class="keyword">double</span> b = rad(lng1) - rad(lng2);</span><br><span class="line">        <span class="keyword">double</span> s = <span class="number">2</span> * Math.asin(Math.sqrt(Math.pow(Math.sin(a / <span class="number">2</span>), <span class="number">2</span>) +</span><br><span class="line">                Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / <span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line">        s = s * EARTH_RADIUS;</span><br><span class="line">        s = Math.round(s * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> v = GetDistance(<span class="number">113.36199</span>, <span class="number">23.12463</span>, <span class="number">113.36189</span>, <span class="number">23.12463</span>);</span><br><span class="line">        System.out.println(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h3><ul><li>尽量每天不断更，做个自律者，markdown原文件在github里面，感谢各位大佬看官star，面试我要往脸上贴金哈哈哈😂。</li><li>邮箱：<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;地理定位业务实现&quot;&gt;&lt;a href=&quot;#地理定位业务实现&quot; class=&quot;headerlink&quot; title=&quot;地理定位业务实现&quot;&gt;&lt;/a&gt;地理定位业务实现&lt;/h1&gt;&lt;h2 id=&quot;一、概念&quot;&gt;&lt;a href=&quot;#一、概念&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
    
      <category term="sql" scheme="https://caochikai.github.io/tags/sql/"/>
    
      <category term="im" scheme="https://caochikai.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>初探缓存</title>
    <link href="https://caochikai.github.io/2019/05/17/%E5%88%9D%E6%8E%A2%E7%BC%93%E5%AD%98/"/>
    <id>https://caochikai.github.io/2019/05/17/%E5%88%9D%E6%8E%A2%E7%BC%93%E5%AD%98/</id>
    <published>2019-05-17T15:34:21.000Z</published>
    <updated>2019-05-17T15:46:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="多级缓存架构"><a href="#多级缓存架构" class="headerlink" title="多级缓存架构"></a>多级缓存架构</h2><h3 id="缓存设计理念："><a href="#缓存设计理念：" class="headerlink" title="缓存设计理念："></a>缓存设计理念：</h3><blockquote><p> 缓存常用的对象或者数据，减少系统开销提高效率。</p></blockquote><h3 id="缓存命中率"><a href="#缓存命中率" class="headerlink" title="缓存命中率"></a>缓存命中率</h3><blockquote><p>即从缓存中读取数据的次数 与 总读取次数的比率，命中率越高越好：</p></blockquote><h3 id="缓存策略："><a href="#缓存策略：" class="headerlink" title="缓存策略："></a>缓存策略：</h3><ol><li><p>移除策略：FIFO（First In First Out），LRU（Least Recently Used），LFU（Least Frequently Used）。</p></li><li><p>TTL（Time To Live）：缓存存活期</p></li><li><p>TTI（Time To Idle）：空闲存活期</p></li></ol><h1 id="spring-cache"><a href="#spring-cache" class="headerlink" title="spring cache"></a>spring cache</h1><hr><h3 id="一、概念"><a href="#一、概念" class="headerlink" title="一、概念"></a>一、概念</h3><blockquote><p>自Spring 3.1起，提供注解缓存，并且提供事务回滚时也自动回滚缓存，并且支持SPEL表达式。</p></blockquote><h3 id="二、入门代码"><a href="#二、入门代码" class="headerlink" title="二、入门代码"></a>二、入门代码</h3><p>1、添加依赖，例如maven的pom.xml(Springboot);</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-cache&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><p>2、添加一种cacheManager的bean实现类，常见ConcurrentMapCache、EhCacheCache、RedisCache；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public CacheManager cacheManager() &#123;</span><br><span class="line">    SimpleCacheManager cacheManager &#x3D; new SimpleCacheManager();</span><br><span class="line">    cacheManager.setCaches(Collections.singletonList(new ConcurrentMapCache(&quot;models&quot;)));</span><br><span class="line">    return cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、配置模块加载注解@EnableCaching</p><h3 id="三、主要注解"><a href="#三、主要注解" class="headerlink" title="三、主要注解"></a>三、主要注解</h3><p>1、@Cacheable：将方法返回值作为缓存</p><ul><li><p>value (也可使用 cacheNames) : 可看做命名空间，表示存到哪个缓存里了。</p></li><li><p>key : 表示命名空间下缓存唯一key,使用Spring Expression Language(简称SpEL,详见参考文献[5])生成。</p></li><li><p>condition : 表示在哪种情况下才缓存结果(对应的还有unless,哪种情况不缓存),同样使用SpEL</p></li></ul><p>2、@CacheEvict：删除缓存注解</p><p>3、@CachePut：刷新注解</p><h1 id="ehcache"><a href="#ehcache" class="headerlink" title="ehcache"></a>ehcache</h1><hr><h3 id="一、概念-1"><a href="#一、概念-1" class="headerlink" title="一、概念"></a>一、概念</h3><h3 id="二、入门代码-1"><a href="#二、入门代码-1" class="headerlink" title="二、入门代码"></a>二、入门代码</h3><p>1、缓存分组，要对分组进行全新CacheConfiguration ，为了高效使用配置自定义属性提取器。默认的属性处理器是JavaBeanAttributeExtractor。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public EhCacheGroupBeanPostProcessor addCache() &#123;</span><br><span class="line">        System.out.println(&quot;.......添加缓存组........&quot;);</span><br><span class="line">        return new EhCacheGroupBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">        &#x2F;&#x2F;后置处理器</span><br><span class="line">    public static class EhCacheGroupBeanPostProcessor implements BeanPostProcessor &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">                      &#x2F;&#x2F;根据前面初始化完成的beanName进一步操作</span><br><span class="line">           if(beanName.equals(&quot;appEhCacheCacheManager&quot;) ) &#123;</span><br><span class="line">                EhCacheCacheManager manager &#x3D; (EhCacheCacheManager)bean;</span><br><span class="line">                CacheManager cacheManager &#x3D; manager.getCacheManager();</span><br><span class="line">&#x2F;&#x2F;              文章缓存命中配置needUpdate</span><br><span class="line">                CacheConfiguration configuration &#x3D; new CacheConfiguration(ReadCacheNames.文章缓存,10000);</span><br><span class="line">                Searchable searchable &#x3D; new Searchable();</span><br><span class="line">                searchable.setKeys(false);</span><br><span class="line">                searchable.setValues(false);</span><br><span class="line">                                &#x2F;&#x2F;动态索引</span><br><span class="line">                searchable.setAllowDynamicIndexing(true);</span><br><span class="line">                searchable.addSearchAttribute(new SearchAttribute().name(&quot;needUpdate&quot;).className(&quot;com.dwalk.social.common.util.ArticlesAttributeExtractor&quot;));</span><br><span class="line">                configuration.eternal(true).addSearchable(searchable);</span><br><span class="line">                Cache articlesCache &#x3D; new Cache(configuration);</span><br><span class="line">                cacheManager.addCache(articlesCache);</span><br><span class="line">                cacheManager.addCache(ReadCacheNames.热点文章缓存);</span><br><span class="line">            &#125;</span><br><span class="line">            return bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>2、使用spring内置定时器，并使用ehcache查询api进行缓存查询。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">        @Scheduled(cron &#x3D; &quot;0 0&#x2F;1 * * * ?&quot;)</span><br><span class="line">    private void synchronize() &#123;</span><br><span class="line">        Cache cache &#x3D; cacheManager.getCache(ReadCacheNames.文章缓存);</span><br><span class="line">        int size &#x3D; cache.getSize();</span><br><span class="line">        if (size &gt; 0) &#123;</span><br><span class="line">            Query query &#x3D; cache.createQuery();</span><br><span class="line">            Attribute searchAttribute &#x3D; cache.getSearchAttribute(&quot;needUpdate&quot;);</span><br><span class="line">                        &#x2F;&#x2F;指定查询的</span><br><span class="line">            query.includeAttribute(searchAttribute);</span><br><span class="line">            query.includeValues();</span><br><span class="line">            Results execute &#x3D; query.addCriteria(searchAttribute.eq(true)).execute();</span><br><span class="line">            List all &#x3D; execute.all();</span><br><span class="line">            log.info(&quot;查询文章缓存的大小：&#123;&#125;&quot;, all.size());</span><br><span class="line">            for (Result result : all) &#123;</span><br><span class="line">                ArticlesDTO articles &#x3D; (ArticlesDTO) result.getValue();</span><br><span class="line">                articles.setNeedUpdate(false);</span><br><span class="line">                Articles target &#x3D; new Articles();</span><br><span class="line">&#x2F;&#x2F;              同步浏览量、视频播放量、评论数、点赞数、收藏数</span><br><span class="line">                target.setVisitorNum(articles.getVisitorNum()).setCommentNum(articles.getCommentNum()).</span><br><span class="line">                        setPlayNum(articles.getPlayNum()).setLikeNum(articles.getLikeNum()).setCollectNum(articles.getCollectNum());</span><br><span class="line">                articlesService.updateById(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h3><p>1、需要熟悉spring接口设计，以接口使用框架，要不然官方api使用需了解诸多细节。</p><h3 id="四、一二级缓存"><a href="#四、一二级缓存" class="headerlink" title="四、一二级缓存"></a>四、一二级缓存</h3><blockquote><p>当遇到@Cacheable返回为null记录，为了成功序列化null，使用了org.springframework.cache.support.NullValue对象代替null。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONException: autoType is not support. org.springframework.cache.support.NullValue</span><br><span class="line">1、起源一二级缓存重写get()方法</span><br><span class="line">public class EhRedisCache extends AbstractValueAdaptingCache &#123;</span><br><span class="line">            部分代码省略……</span><br><span class="line">        @Override</span><br><span class="line">    public  T get(Object key, Callable valueLoader) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                value &#x3D; lookup(key);</span><br><span class="line">                if(value !&#x3D; null) &#123;</span><br><span class="line">                    return (T) value;</span><br><span class="line">                &#125;</span><br><span class="line">                value &#x3D; valueLoader.call();</span><br><span class="line">                        &#x2F;&#x2F;toStoreValue是AbstractValueAdaptingCache抽象类的方法</span><br><span class="line">                Object storeValue &#x3D; toStoreValue(value);</span><br><span class="line">                put(key, storeValue);</span><br><span class="line">                return (T) value;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new ValueRetrievalException(key, valueLoader, e.getCause());</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">2、toStoreValue判断userValue &#x3D;&#x3D; null 则return NullValue.INSTANCE </span><br><span class="line">-&gt; public static final Object INSTANCE &#x3D; new NullValue();</span><br><span class="line"></span><br><span class="line">public abstract class AbstractValueAdaptingCache implements Cache &#123;</span><br><span class="line">    protected Object toStoreValue(@Nullable Object userValue) &#123;</span><br><span class="line">        if (userValue &#x3D;&#x3D; null) &#123;</span><br><span class="line">            if (this.allowNullValues) &#123;</span><br><span class="line">                return NullValue.INSTANCE;</span><br><span class="line">            &#125;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                    &quot;Cache &#39;&quot; + getName() + &quot;&#39; is configured to not allow null values but null was provided&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return userValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">3、序列化反序列化</span><br><span class="line">public class FastJsonRedisSerializer implements RedisSerializer &#123;</span><br><span class="line">        @Override</span><br><span class="line">    public T deserialize(byte[] bytes) throws SerializationException &#123;</span><br><span class="line">        if (null &#x3D;&#x3D; bytes || bytes.length &lt;&#x3D; 0) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        String str &#x3D; new String(bytes, DEFAULT_CHARSET);</span><br><span class="line">        return (T) JSON.parseObject(str, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">4、jsonParser解析类型</span><br><span class="line">public class com.alibaba.fastjson.parser.DefaultJSONParser implements Closeable &#123;</span><br><span class="line">    public final Object parseObject(final Map object, Object fieldName) &#123;</span><br><span class="line">                    部分代码省略……</span><br><span class="line">                                            Class clazz &#x3D; null;</span><br><span class="line">                        if (object !&#x3D; null</span><br><span class="line">                                &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">                            clazz &#x3D; object.getClass();</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;com.alibaba.fastjson.parser.DefaultJSONParser#config执行</span><br><span class="line">                            clazz &#x3D; config.checkAutoType(typeName, null, lexer.getFeatures());</span><br><span class="line">                        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">5、异常抛出点TypeUtils.getClassFromMapping(typeName) -》 typeName为org.springframework.cache.support.NullValue</span><br><span class="line">public Class checkAutoType(String typeName, Class expectClass, int features) &#123;</span><br><span class="line">    if (Arrays.binarySearch(denyHashCodes, hash) &gt;&#x3D; 0 &amp;&amp; TypeUtils.getClassFromMapping(typeName) &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">6、TypeUtils的getClassFromMapping方法返回null</span><br><span class="line">        public static Class getClassFromMapping(String className)&#123;</span><br><span class="line">        return mappings.get(className);</span><br><span class="line">    &#125;</span><br><span class="line">7、TypeUtils不支持org.springframework.cache.support.NullValue</span><br><span class="line">private static ConcurrentMap&gt; mappings &#x3D; new ConcurrentHashMap&gt;(16, 0.75f, 1);</span><br><span class="line">&#x2F;&#x2F;mappings类型白名单</span><br><span class="line">private static void addBaseClassMappings()&#123;</span><br><span class="line">        mappings.put(&quot;byte&quot;, byte.class);</span><br><span class="line">        mappings.put(&quot;short&quot;, short.class);</span><br><span class="line">        mappings.put(&quot;int&quot;, int.class);</span><br><span class="line">        mappings.put(&quot;long&quot;, long.class);</span><br><span class="line">        mappings.put(&quot;float&quot;, float.class);</span><br><span class="line">        mappings.put(&quot;double&quot;, double.class);</span><br><span class="line">        mappings.put(&quot;boolean&quot;, boolean.class);</span><br><span class="line">                部分代码省略……</span><br><span class="line">                fastJson官方没有支持org.springframework.cache.support.NullValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h2><ul><li>今天复出写博客，一是感觉懒了期望进步，二是为了积累知识方便copy😂。</li><li>邮箱：<a href="mailto:&#99;&#x61;&#x6f;&#99;&#x68;&#x69;&#x6b;&#x61;&#x69;&#64;&#x71;&#x71;&#46;&#99;&#x6f;&#109;">&#99;&#x61;&#x6f;&#99;&#x68;&#x69;&#x6b;&#x61;&#x69;&#64;&#x71;&#x71;&#46;&#99;&#x6f;&#109;</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;多级缓存架构&quot;&gt;&lt;a href=&quot;#多级缓存架构&quot; class=&quot;headerlink&quot; title=&quot;多级缓存架构&quot;&gt;&lt;/a&gt;多级缓存架构&lt;/h2&gt;&lt;h3 id=&quot;缓存设计理念：&quot;&gt;&lt;a href=&quot;#缓存设计理念：&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>AndroidAdb</title>
    <link href="https://caochikai.github.io/2017/02/05/AndroidAdb/"/>
    <id>https://caochikai.github.io/2017/02/05/AndroidAdb/</id>
    <published>2017-02-05T12:49:09.000Z</published>
    <updated>2017-02-05T13:27:22.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android-adb调试工具–清除锁屏密码误解"><a href="#Android-adb调试工具–清除锁屏密码误解" class="headerlink" title="Android adb调试工具–清除锁屏密码误解"></a>Android adb调试工具–清除锁屏密码误解</h1><p>@(Android)[调试工具|实用教程|adb命令]</p><p><a href="https://developer.android.com/studio/command-line/adb.html" target="_blank" rel="noopener">Android Studio ADB官方文档</a></p><p><strong>ADB</strong>全称为 Android Debug Bridge, 是android 里的一个调试工具, 用这个工具可以直接操作管理android模拟器或者真实的andriod设备手机。如果你安装了<strong>Android SDK</strong>（或者下载adb工具包，体积小）,存放sdk的platform-tools目录下，在 命令行cmd使用需要配置路径（<strong>android_sdk/platform-tools/adb.exe</strong> ）到环境变量里。它可为各种设备操作提供便利，如安装和调试应用，例如查看android中的数据库，提供对 Unix shell（可用来在模拟器或连接的设备上运行各种命令）的访问。该工具作为一个客户端-服务器程序，包括三个组件：</p><ul><li><strong>客户端</strong> ：该组件发送命令。客户端在开发计算机上运行。您可以通过发出 adb 命令从命令行终端调用客户端；</li><li><strong>后台程序</strong> ：该组件在设备上运行命令。后台程序在每个模拟器或设备实例上作为后台进程运行；</li><li><strong>服务器</strong> ：该组件管理客户端和后台程序之间的通信。服务器在开发计算机上作为后台进程运行。</li></ul><h3 id="关于清除解锁图案"><a href="#关于清除解锁图案" class="headerlink" title="关于清除解锁图案"></a>关于清除解锁图案</h3><blockquote><p>用户相关的文件accounts.db（gmail账号管理），gesture.key（手势识别文件），password.key（密码文件）。<br>不同品牌手机系统相关文件名也会不同,例如我的手机，华为4x文件为locksettings.db（数据库文件）。<br>修理店里的师傅使用一个工具叫星海神器（高通平台强刷），功能超乎想象，几乎支持所有手机品牌（特别是苹果）<br>淘宝上有卖，网上大部分加密过！小米手机叫丢失解锁神器！</p></blockquote><h4 id="1-破解条件"><a href="#1-破解条件" class="headerlink" title="1. 破解条件"></a>1. 破解条件</h4><ul><li><strong>手机打开USB并连接电脑</strong> </li><li><strong>手机被ROOT，并且ADB可以直接升级为ROOT用户</strong> </li><li><strong>配置adb路径到环境变量或者直接在cmd命令行里面切换到adb所在路径</strong> </li></ul><h4 id="2-破解步骤"><a href="#2-破解步骤" class="headerlink" title="2. 破解步骤"></a>2. 破解步骤</h4><ul><li>*<em>打开cmd命令行，用【adb shell】命令进入shell *</em> </li><li><strong>利用su命令将adb提升为root用户，如果成功，行首由$变成 #，#表示root用户</strong> </li><li>*<em>进入data/system目录 *</em> </li><li>*<em>ls查看当前目录 *</em> </li><li>*<em>用ls命令查看密码文件 *</em>  </li><li><strong>用rm命令删除密码文件，若是$（不是root），则会提示”rm failed for … Permission denied”，权限不足</strong>   </li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line">$ su</span><br><span class="line"># cd /data/system</span><br><span class="line"># ls</span><br><span class="line"># rm locksettings.db</span><br></pre></td></tr></table></figure><p>输入reboot或手动重启手机生效。亲测华为荣耀4X有效，删除锁屏密码后，指纹解锁自动失效，所以此方法也可以破解指纹解锁！！重新设置锁屏密码后，以前设置的指纹解锁又可以用了。</p><h4 id="3-注意事项"><a href="#3-注意事项" class="headerlink" title="3. 注意事项"></a>3. 注意事项</h4><pre><code>看到这儿就明白了，即便手机Root+打开USB调试，也是无法通过ADB解锁手机的。因为想要想要解锁，就得删除/data/system 下的相关文件，可删除需要由Superuser或者kingroot授予ADB shell权限，而授权需要解锁打开手机后操作Superuser程序。即解锁需要用到解锁后的手机操作，就像春晚小品《开锁》中，业主黄宏要求开锁师傅林永健开锁，林永健要求黄宏出示有效证件，可证件就在锁着的箱子里头。  我进行了测试后发现，在授权过一次后，下次手机用USB数据线连接电脑，再次进行解锁，即便同台电脑，也是需要再次授权的。这就说明，即便你用你的电脑经过手机授权解锁过，过后想要在忘记密码时使用ADB方式解锁，也是不可能的。  我觉得这是高版本的安卓系统（eg. Android 4.2 Jelly Bean 安卓果冻豆）新有的安全特性，低版本的Android如安卓2.3.8是可以通过这种方法解锁的。因为我实际测试，我的固件版本为安卓2.3.8的三星S5570（已经Root，打开USB调试），执行命令rm gesture.key，无需授权，直接即可解锁。现在我有个问题，低版本安卓系统如 Android2.3.8的手机解锁屏幕锁定密码，是否的确必须Root，还是只要打开USB调试即可？我手头没有没Root的Android2.3手机，也懒得折腾了，就不管它了。 这样看来，高版本的安卓系统也就不存在被非手机所有者恶意解锁的BUG了。</code></pre><h4 id="4-题外话（今年好东西都挂了）"><a href="#4-题外话（今年好东西都挂了）" class="headerlink" title="4. 题外话（今年好东西都挂了）"></a>4. 题外话（今年好东西都挂了）</h4><p><a href="http://itwusun.com/offer.html" target="_blank" rel="noopener">收费音乐神器官网</a>，<a href="http://www.btjson.com/index.html" target="_blank" rel="noopener">服务器接口平台AnyListen</a></p><p><strong>音乐间谍</strong>为window PC版，<strong>音乐助手</strong>Android版，<a href="http://weibo.com/shelher?is_hot=1" target="_blank" rel="noopener">Shelher微博</a>分享出来3.3版源码<a href="https://pan.baidu.com/share/init?shareid=976327165&uk=4145536040" target="_blank" rel="noopener">百度云 ​​​​</a>密码gria！尴尬的是朋友云免流量也不干了！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Android-adb调试工具–清除锁屏密码误解&quot;&gt;&lt;a href=&quot;#Android-adb调试工具–清除锁屏密码误解&quot; class=&quot;headerlink&quot; title=&quot;Android adb调试工具–清除锁屏密码误解&quot;&gt;&lt;/a&gt;Android adb调试工
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>SpiderWebMagic</title>
    <link href="https://caochikai.github.io/2017/01/30/SpiderWebMagic/"/>
    <id>https://caochikai.github.io/2017/01/30/SpiderWebMagic/</id>
    <published>2017-01-30T12:50:27.000Z</published>
    <updated>2017-01-30T12:57:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WebMagic爬虫框架–京东图书"><a href="#WebMagic爬虫框架–京东图书" class="headerlink" title="WebMagic爬虫框架–京东图书"></a>WebMagic爬虫框架–京东图书</h1><p>@(爬虫)[框架|爬虫|Demo总结]</p><p><strong>WebMagic</strong>!项目代码分为核心(webmagic-core)和扩展(webmagic-extension)两部分(jar包)。Downloader、PageProcessor、Scheduler、Pipeline这四大组件对应爬虫生命周期中的下载、处理、管理和持久化等功能。</p><table><thead><tr><th>名称</th><th align="center">功能</th></tr></thead><tbody><tr><td>Downloader</td><td align="center">基础。利用httpClient作为下载工具，下载页面内容便于后续处理解析;</td></tr><tr><td>Page</td><td align="center">网页内容对象。 指根据url下载到的页面内容，包括页面dom元素，css样式，javascript等;</td></tr><tr><td>Pageprocess</td><td align="center">爬虫的核心。 负责解析页面，抽取有用信息，可采用css(),$(),xpath()方法对特定页面元素进行抽取;</td></tr><tr><td>Site</td><td align="center">网站设置。设置网站domain，cookies,header,重试次数,访问间隔时间等;</td></tr><tr><td>Scheduler</td><td align="center">抓取页面队列。 管理待抓取的URL，以及一些去重的工作，将目标url内容push到抓取队列中;</td></tr><tr><td>Pipeline</td><td align="center">输出，收尾。 负责抽取结果的处理，包括计算、持久化到文件、数据库;</td></tr><tr><td>Spider</td><td align="center">爬虫的入口类 采用链式设计，通过它来设定多线程，页面解析器，调度以及输出方式等。</td></tr></tbody></table><h3 id="WebMagic官方链接："><a href="#WebMagic官方链接：" class="headerlink" title="WebMagic官方链接："></a>WebMagic官方链接：</h3><ul><li><a href="http://webmagic.io/" target="_blank" rel="noopener">官网</a> 包含官方文档和源码,以及相应的实例；</li><li><a href="https://github.com/code4craft/webmagic" target="_blank" rel="noopener">github</a> 仓库保存最新版本；</li><li><a href="http://git.oschina.net/flashsword20/webmagic" target="_blank" rel="noopener">oschinamayun码云</a> 包含所有编译好的依赖包；</li></ul><h4 id="爬取京东图书-https-book-jd-com"><a href="#爬取京东图书-https-book-jd-com" class="headerlink" title="爬取京东图书(https://book.jd.com/)"></a>爬取京东图书(<a href="https://book.jd.com/" target="_blank" rel="noopener">https://book.jd.com/</a>)</h4><h5 id="在商品列表网页抓取如下商品信息"><a href="#在商品列表网页抓取如下商品信息" class="headerlink" title="在商品列表网页抓取如下商品信息"></a>在商品列表网页抓取如下商品信息</h5><ul><li>商品名：商品名称</li><li>商品网页：显示商品详细信息的网页地址。</li><li>市场价格：京东给出的市面价格</li><li>京东价格：京东的优惠价。</li></ul><h5 id="关于ajax价格链接地址格式：http-p-3-cn-prices-mgets-skuIds-J-商品ID，抓取格式为json。"><a href="#关于ajax价格链接地址格式：http-p-3-cn-prices-mgets-skuIds-J-商品ID，抓取格式为json。" class="headerlink" title="关于ajax价格链接地址格式：http://p.3.cn/prices/mgets?skuIds=J_ + 商品ID，抓取格式为json。"></a>关于ajax价格链接地址格式：<a href="http://p.3.cn/prices/mgets?skuIds=J" target="_blank" rel="noopener">http://p.3.cn/prices/mgets?skuIds=J</a>_ + 商品ID，抓取格式为json。</h5><ul><li><a href="https://item.jd.com/12087016.html" target="_blank" rel="noopener">https://item.jd.com/12087016.html</a> ：图书详情页；</li><li><a href="http://p.3.cn/prices/mgets?skuIds=J_12087016" target="_blank" rel="noopener">http://p.3.cn/prices/mgets?skuIds=J_12087016</a>  （例）价格ajax请求链接；</li><li>[{“id”:”J_12087016”,”p”:”60.80”,”m”:”90.00”,”op”:”60.80”}]  抓取结果 id + 京东实际价格+市场价格</li></ul><hr><h3 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Page;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Site;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Spider;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.processor.PageProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDPageProcesser</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me().setRetryTimes(<span class="number">3</span>).setSleepTime(<span class="number">3000</span>).setCharset(<span class="string">"GBK"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> size = <span class="number">0</span>;<span class="comment">// 共抓取到的图书数量</span></span><br><span class="line">    <span class="comment">//抓取商品信息集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; name = <span class="keyword">new</span> ArrayList&lt;String&gt;();<span class="comment">//所有的书名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; author = <span class="keyword">new</span> ArrayList&lt;String&gt;();<span class="comment">//所有的作者</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Double&gt; prices = <span class="keyword">new</span> ArrayList&lt;Double&gt;();<span class="comment">//所有的价格</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//图书主页</span></span><br><span class="line"><span class="comment">// https://item.jd.com/12004057.html</span></span><br><span class="line">        <span class="keyword">if</span> (!page.getUrl().regex(<span class="string">"https://item.jd.com/\\d&#123;8&#125;.html"</span>).match()&amp;!page.getUrl().regex(<span class="string">"p.3.cn/prices/mgets"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">// 主页中添加商品详情页到计划url</span></span><br><span class="line">            List&lt;String&gt; detail = page.getHtml().links().regex(<span class="string">"//item.jd.com/\\d&#123;8&#125;.html"</span>).replace(<span class="string">"//"</span>, <span class="string">"https://"</span>).all();</span><br><span class="line">            <span class="comment">//控制抓取商品的数量</span></span><br><span class="line">            <span class="keyword">if</span> (detail.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                    String url = detail.get(i);</span><br><span class="line">                    System.out.println(<span class="string">"url:"</span> + url.replace(<span class="string">"https://item.jd.com"</span>, <span class="string">""</span>).replace(<span class="string">"/"</span>, <span class="string">"http://p.3.cn/prices/mgets?skuIds=J_"</span>).replace(<span class="string">".html"</span>, <span class="string">""</span>));</span><br><span class="line">                    <span class="comment">//列队添加一条详情页后面追加一条价格ajax链接</span></span><br><span class="line">                    page.addTargetRequest(url);</span><br><span class="line">                    page.addTargetRequest(url.replace(<span class="string">"https://item.jd.com"</span>, <span class="string">""</span>).replace(<span class="string">"/"</span>, <span class="string">"http://p.3.cn/prices/mgets?skuIds=J_"</span>).replace(<span class="string">".html"</span>, <span class="string">""</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (page.getUrl().regex(<span class="string">"https://item.jd.com/\\d&#123;8&#125;.html"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">// 商品详情页</span></span><br><span class="line">            size++;</span><br><span class="line">            name.add(page.getHtml().xpath(<span class="string">"//div[@id=name]/h1/text()"</span>).get());<span class="comment">//添加书名</span></span><br><span class="line">            author.add(page.getHtml().xpath(<span class="string">"//div[@id=p-author]/a/text()"</span>).get());<span class="comment">//添加作者</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (page.getUrl().regex(<span class="string">"p.3.cn/prices/mgets"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">//ajax商品id对应价格json接口</span></span><br><span class="line">            prices.add(Double.parseDouble(page.getHtml().replace(<span class="string">"&amp;quot"</span>, <span class="string">""</span>).regex(<span class="string">"p;:;.+;,;m"</span>).regex(<span class="string">"\\d+\\.\\d+"</span>).get()));<span class="comment">//添加价格</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取所有信息导入DAO,持久化层待实现</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Size"</span>  + name.size() + author.size() + prices.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; name.size(); i++) &#123;</span><br><span class="line">            JDLog model = <span class="keyword">new</span> JDLog();</span><br><span class="line">            model.setName(name.get(i));</span><br><span class="line">            model.setAuthor(author.get(i));</span><br><span class="line">            model.setPrices(prices.get(i));</span><br><span class="line">            System.out.println(<span class="string">"书名:"</span> + model.getName());</span><br><span class="line">            System.out.println(<span class="string">"作者:"</span> + model.getAuthor());</span><br><span class="line">            System.out.println(<span class="string">"价格:"</span> + model.getPrices());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime, endTime;</span><br><span class="line">        System.out.println(<span class="string">"【爬虫开始】请耐心等待一大波数据到你碗里来..."</span>);</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 从京东图书开始抓，开启5个线程，启动爬虫</span></span><br><span class="line">        Spider.create(<span class="keyword">new</span> JDPageProcesser()).addUrl(<span class="string">"https://book.jd.com/"</span>).thread(<span class="number">3</span>).run();</span><br><span class="line">        endTime = System.currentTimeMillis();</span><br><span class="line">        getAll();</span><br><span class="line">        System.out.println(<span class="string">"【爬虫结束】共抓取"</span> + size + <span class="string">"本图书，耗时约"</span> + ((endTime - startTime) / <span class="number">1000</span>) + <span class="string">"秒，已保存到数据库，请查收！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="以后将会坚持更新"><a href="#以后将会坚持更新" class="headerlink" title="以后将会坚持更新!"></a>以后将会坚持更新!</h2><h2 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h2><ul><li>邮箱：<a href="mailto:&#x63;&#97;&#111;&#99;&#x68;&#105;&#x6b;&#x61;&#x69;&#x40;&#113;&#113;&#46;&#99;&#111;&#109;">&#x63;&#97;&#111;&#99;&#x68;&#105;&#x6b;&#x61;&#x69;&#x40;&#113;&#113;&#46;&#99;&#111;&#109;</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;WebMagic爬虫框架–京东图书&quot;&gt;&lt;a href=&quot;#WebMagic爬虫框架–京东图书&quot; class=&quot;headerlink&quot; title=&quot;WebMagic爬虫框架–京东图书&quot;&gt;&lt;/a&gt;WebMagic爬虫框架–京东图书&lt;/h1&gt;&lt;p&gt;@(爬虫)[框架|爬
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>My New Post</title>
    <link href="https://caochikai.github.io/2016/12/24/First%20Wirte/"/>
    <id>https://caochikai.github.io/2016/12/24/First%20Wirte/</id>
    <published>2016-12-24T13:46:06.000Z</published>
    <updated>2016-12-24T15:11:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Markdown初次使用"><a href="#Markdown初次使用" class="headerlink" title="Markdown初次使用"></a>Markdown初次使用</h1><p><strong>Markdown</strong>是一门轻量级语法,仅仅需要5分钟你就能搞懂!</p><h2 id="期末刷jsp作业心得"><a href="#期末刷jsp作业心得" class="headerlink" title="期末刷jsp作业心得"></a>期末刷jsp作业心得</h2><ul><li><strong>DAO层封装成工具类</strong> ：持久层处理业务,尽量把变化东西采用数组遍历,约定成俗简化成配置化写；</li><li><strong>登陆注册模块重用</strong> ：前端样式变化,但尽量不要修改提交参数名称和个数；</li><li><strong>单元测试类</strong> ：使用 junit测试框架检查逻辑是否有误,方便部署调试 。</li></ul><hr><h3 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行更新操作----带预编译参数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">excuteUpdate</span><span class="params">(String sql, String[] params)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">pstmt = getCon().prepareStatement(sql);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">pstmt.setString(i + <span class="number">1</span>, params[i]);</span><br><span class="line">&#125;</span><br><span class="line">result = pstmt.executeUpdate();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">pstmtClose();</span><br><span class="line">conClose();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##以后将会持续更新,预告 webmagic 框架爬虫下次出</p><h2 id="反馈与建议"><a href="#反馈与建议" class="headerlink" title="反馈与建议"></a>反馈与建议</h2><ul><li>邮箱：<a href="mailto:&#x63;&#x61;&#111;&#x63;&#x68;&#x69;&#107;&#x61;&#105;&#64;&#x71;&#x71;&#x2e;&#x63;&#111;&#109;">&#x63;&#x61;&#111;&#x63;&#x68;&#x69;&#107;&#x61;&#105;&#64;&#x71;&#x71;&#x2e;&#x63;&#111;&#109;</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Markdown初次使用&quot;&gt;&lt;a href=&quot;#Markdown初次使用&quot; class=&quot;headerlink&quot; title=&quot;Markdown初次使用&quot;&gt;&lt;/a&gt;Markdown初次使用&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Markdown&lt;/strong&gt;是一门轻量
      
    
    </summary>
    
    
    
  </entry>
  
</feed>

<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å¤©é“é…¬å‹¤</title>
  
  <subtitle>åŠ³é€¸ç»“åˆ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://caochikai.github.io/"/>
  <updated>2019-12-25T12:52:55.969Z</updated>
  <id>https://caochikai.github.io/</id>
  
  <author>
    <name>ChiKai</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šTransactionäº‹åŠ¡</title>
    <link href="https://caochikai.github.io/2019/12/25/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATransaction%E4%BA%8B%E5%8A%A1/"/>
    <id>https://caochikai.github.io/2019/12/25/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATransaction%E4%BA%8B%E5%8A%A1/</id>
    <published>2019-12-25T12:51:00.000Z</published>
    <updated>2019-12-25T12:52:55.969Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-7ã€Transactionäº‹åŠ¡"><a href="#2-7ã€Transactionäº‹åŠ¡" class="headerlink" title="2.7ã€Transactionäº‹åŠ¡"></a>2.7ã€Transactionäº‹åŠ¡</h1><blockquote><p>æ§åˆ¶æ•°æ®åº“äº‹åŠ¡æ˜¯ä¸šåŠ¡å‹æ“ä½œï¼ˆCRUDï¼‰çš„åŸºæœ¬åŠŸï¼ŒMybatisæœ¬èº«é€šè¿‡Transaction(org.apache.ibatis.transaction)æ¥å£å¯¹æ•°æ®åº“è¿›è¡Œäº†æŠ½è±¡åŒ–ï¼Œå…·ä½“åˆ†æå¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**åŒ…è£…æ•°æ®åº“è¿æ¥å…³äºåˆ›å»ºã€é¢„å¤„ç†ã€æäº¤/å›æ»šå’Œå…³é—­çš„ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="comment"> * Wraps a database connection.</span></span><br><span class="line"><span class="comment"> * Handles the connection lifecycle that comprises: </span></span><br><span class="line"><span class="comment"> * its creation, preparation, commit/rollback and close.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡</span></span><br><span class="line"><span class="comment">   * Retrieve inner database connection.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> DataBase connection</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="comment">   * Commit inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**å›æ»šäº‹åŠ¡</span></span><br><span class="line"><span class="comment">   * Rollback inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**å…³é—­æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="comment">   * Close inner database connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**è·å–äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">   * Get transaction timeout if set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Transaction æ¥å£æœ‰JdbcTransactionã€ManagedTransactionä¸¤ä¸ªå®ç°ã€‚ManagedTransactionçš„å®ç°éå¸¸ç®€å•ï¼Œå®ƒåŒæ ·ä¾èµ–å…¶ä¸­çš„dataSourceå­—æ®µè·å–è¿æ¥ï¼Œä½†å…¶commitã€rollbackæ–¹æ³•éƒ½æ˜¯ç©ºå®ç°ï¼Œäº‹åŠ¡çš„æäº¤å’Œå›æ»šéƒ½æ˜¯ä¾é å®¹å™¨ç®¡ç†çš„ï¼Œå…³é—­æ–¹æ³•é€šè¿‡closeConnectionå­—æ®µçš„å€¼æ§åˆ¶æ•°æ®åº“è¿æ¥ã€‚JdbcTransactionä¾èµ–JDBC Connectionæ§åˆ¶æ•°æ®åº“äº‹åŠ¡ï¼Œæ¥ä¸‹å°±è¦è¿›å…¥å¯¹JdbcTransactionçš„åˆ†æï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**ä¸‹é¢æ“ä½œæ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨java.sql.Connectionç›´æ¥è¿›è¡Œæ“ä½œäº‹åŠ¡ï¼ŒgetTimeoutæ˜¯ç©ºå®ç°</span></span><br><span class="line"><span class="comment"> *å¦‚æœautocommitå·²ç»å¼€å¯ï¼Œé‚£ä¹ˆcommitå’Œrollbackæ–¹æ³•å°±ä¼šè¢«å¿½ç•¥æ‰</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Transaction&#125; that makes use of the JDBC commit and rollback facilities directly.</span></span><br><span class="line"><span class="comment"> * It relies on the connection retrieved from the dataSource to manage the scope of the transaction.</span></span><br><span class="line"><span class="comment"> * Delays connection retrieval until getConnection() is called.</span></span><br><span class="line"><span class="comment"> * Ignores commit or rollback requests when autocommit is on.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransaction</span> <span class="keyword">implements</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"><span class="comment">//äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line">  <span class="keyword">protected</span> Connection connection;</span><br><span class="line"><span class="comment">//æ•°æ®åº“è¿æ¥å¯¹åº”çš„æ•°æ®æº</span></span><br><span class="line">  <span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line"><span class="comment">//äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></span><br><span class="line">  <span class="keyword">protected</span> TransactionIsolationLevel level;</span><br><span class="line"><span class="comment">//æ˜¯å¦è‡ªåŠ¨æäº¤</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">boolean</span> autoCommit;</span><br><span class="line"></span><br><span class="line"> ...çœç•¥ä¸‹é¢æ–¹æ³•å’Œæ„é€ å™¨</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>JdbcTransactionã€ManagedTransactionä¸¤ä¸ªå®ç°ï¼Œå…¶å¯¹è±¡åˆ†åˆ«ç”±JdbcTransactionFactory å’ŒManaged TransactionFactoryè´Ÿè´£åˆ›å»ºã€‚è¿™é‡Œä¹Ÿä½¿ç”¨äº†å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚ä¸‹é¢å°±åˆ†æå·¥å‚åˆ›å»ºäº§å“UMLå’Œæ¥å£è§„èŒƒï¼š</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-5.png" alt="Transaction.png" title="">                </div>                <div class="image-caption">Transaction.png</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¥å£é»˜è®¤æ–¹æ³•ï¼Œé€šå¸¸åœ¨åˆ›å»ºå®ŒTransactionåè¿›è¡Œè‡ªå®šä¹‰é…ç½®äº‹åŠ¡</span></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NOP</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨æŒ‡å®šConnectionä¸Šåˆ›å»ºTransaction</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»æŒ‡å®šçš„DataSourceè·å–æ•°æ®åº“è¿æ¥ï¼Œå¹¶åœ¨æ­¤è¿æ¥ä¹‹ä¸Šåˆ›å»ºäº‹åŠ¡å¯¹è±¡ï¼Œåé¢å°±ç®—é…ç½®TransactionIsolationLevelå’ŒautoCommit</span></span><br><span class="line">  <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(DataSource dataSource, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨å®è·µä¸­ï¼ŒMyBatisé€šå¸¸ä¼šä¸Springé›†æˆä½¿ç”¨ï¼Œæ•°æ®åº“çš„äº‹åŠ¡æ˜¯äº¤ç»™Springè¿›è¡Œç®¡ç†çš„ï¼Œä»¥åä¼šä»‹ç»Transactionæ¥å£çš„å¦ä¸€å®ç°SpringManagedTransactionã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-7ã€Transactionäº‹åŠ¡&quot;&gt;&lt;a href=&quot;#2-7ã€Transactionäº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;2.7ã€Transactionäº‹åŠ¡&quot;&gt;&lt;/a&gt;2.7ã€Transactionäº‹åŠ¡&lt;/h1&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/categories/Mybatis/"/>
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è</title>
    <link href="https://caochikai.github.io/2019/12/24/idea%E6%8F%92%E4%BB%B6%E7%AC%AC%E4%BA%8C%E5%BC%B9%E6%8E%A8%E8%8D%90/"/>
    <id>https://caochikai.github.io/2019/12/24/idea%E6%8F%92%E4%BB%B6%E7%AC%AC%E4%BA%8C%E5%BC%B9%E6%8E%A8%E8%8D%90/</id>
    <published>2019-12-24T09:33:00.000Z</published>
    <updated>2019-12-24T09:34:33.622Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è"><a href="#ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è" class="headerlink" title="ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è"></a>ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è</h1><h2 id="å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶"><a href="#å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶" class="headerlink" title="å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶"></a>å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶</h2><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><blockquote><p> å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œåšä¸»æ˜¯ä¸ªæ­»å¿ å·¥å…·æ´¾ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªå¤§é—®é¢˜å¯èƒ½ä¼šæ”¶é›†å¤šä¸ªå·¥å…·å’Œæ–¹æ¡ˆï¼Œç„¶åæ±‚è¯å¯¹æ¯”å‡ºä½“éªŒæŠ¥å‘Šã€‚åç»­æ–‡ç« æœ‰ä¸€å¤§ç±»å°±æ˜¯å·¥å…·ç±»æ¨èï¼Œè€Œæœ¬ç¯‡æ–‡ç« é‡ç‚¹å°±æ˜¯idea å®‰è£…æ’ä»¶è®°å½•ï¼Œç®€è¦è®°å½•å®‰è£…æ–¹æ³•å¿«é€Ÿæ­å»ºä¸ªæ€§åŒ–ideaï¼Œè¿˜æœ‰ä¸€äº›å…³äºUIæ–¹é¢æ’ä»¶å¯è°“å¤šä¸èƒœæ•°ï¼Œè€Œä¸”æ¯ä¸ªäººå£å‘³ä¸ä¸€ï¼Œè¯·å„ä½è‡ªè¡Œé€‰æ‹©â€”â€”æ’ä»¶æœç´¢æŠ€å·§tagsä¸ºThemeæˆ–è€…UIã€‚</p></blockquote><hr><h2 id="æ’ä»¶åˆ—è¡¨"><a href="#æ’ä»¶åˆ—è¡¨" class="headerlink" title="æ’ä»¶åˆ—è¡¨"></a>æ’ä»¶åˆ—è¡¨</h2><h3 id="æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼"><a href="#æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼" class="headerlink" title="æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼"></a>æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”<strong>lambdaè¡¨è¾¾å¼</strong></h3><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>JRebel</td><td>ä»£æ›¿springboot devçƒ­éƒ¨ç½²æ–¹æ¡ˆï¼Œæœ€æ–¹ä¾¿æ¿€æ´»æ–¹å¼</td></tr><tr><td>Lombok</td><td>ç²¾ç®€beanï¼Œå„ç§åŠŸèƒ½å¼ºå¤§åˆå®ç”¨æ³¨è§£ï¼Œæ¬ç –äººçš„MVPï¼Œç»“åˆHutoolå®åœ¨å®Œç¾</td></tr><tr><td>AceJump</td><td>å…‰æ ‡è·³è·ƒï¼Œæ›¿ä»£vimä¸äºŒä¹‹é€‰</td></tr><tr><td>CodeGlance</td><td>ä»£ç åœ°å›¾ï¼Œæ–¹ä¾¿æŸ¥é˜…è·³è½¬</td></tr><tr><td>MavenHelper</td><td>å¿«é€Ÿåˆ†æmaven åŒ…å†²çªçš„é—®é¢˜ï¼Œæœç´¢åŒ…å</td></tr><tr><td>MyBatis Log Plugin</td><td>Restore the mybatis generate sql to original whole sql.ï¼ˆæ‹¼æ¥å®Œæ•´sqlï¼‰</td></tr><tr><td>Log Support 2</td><td>å¿«é€Ÿlog.info()ï¼Œç»“åˆLombokæ’ä»¶æ³¨è§£@Slf4jå¯ä»¥è¯´æ— æ•Œ</td></tr><tr><td>Grep Console</td><td>é’ˆå¯¹æ§åˆ¶å°æ—¥å¿—ä¸åŒç­‰çº§è¿›è¡ŒæŸ“è‰²é«˜äº®</td></tr><tr><td>MyBatisCodeHelperPro</td><td>å¯¹Mybatisæ”¯æŒéå¸¸å¼ºï¼Œè¯·è®¤çœŸå‚è€ƒ<a href="https://gejun123456.github.io/MyBatisCodeHelper-Pro/#/READMEï¼Œæé«˜ç”Ÿäº§åŠ›çš„å·¥å…·å•Šï¼ˆæ”¶è´¹å¯ç ´è§£ï¼‰ï¼" target="_blank" rel="noopener">https://gejun123456.github.io/MyBatisCodeHelper-Pro/#/READMEï¼Œæé«˜ç”Ÿäº§åŠ›çš„å·¥å…·å•Šï¼ˆæ”¶è´¹å¯ç ´è§£ï¼‰ï¼</a></td></tr><tr><td>Free Mybatis plugin</td><td>Mybaitsæ”¯æŒè·³è½¬ï¼Œæœ‰é’±å¤§çˆ·è¯·æ”¶è´¹ç‰ˆMybatis pluginå¼ºå¤§ç ´è§£è¾ƒå°‘ï¼Œå·®è¯„</td></tr><tr><td>Rainbow Brackets</td><td>å½©è™¹æ‹¬å·ï¼Œå¤šå±‚åµŒå¥—ä»£ç æ˜¾ç¤ºåŠ©æ‰‹</td></tr><tr><td>String Manipulation</td><td>å¼ºå¤§çš„å­—ç¬¦ä¸²æ ¼å¼è½¬åŒ–</td></tr><tr><td>GitToolBox</td><td>gitçš„å¼ºå¤§åŠ©æ‰‹ï¼Œå®šæ—¶æ‹‰å–ä»£ç ã€ä»£ç é€è¡Œå±•ç¤ºæ—¥å¿—ï¼ˆå„ç§è¾…åŠ©é‡‘æ‰‹æŒ‡ï¼‰</td></tr><tr><td>RestfulToolkit</td><td>è¾…åŠ©é€šè¿‡URLå®šä½Controllerï¼Œç®€æ´ç‰ˆçš„PostMan</td></tr><tr><td>Alibaba Cloud Toolkit</td><td>ç»“åˆé˜¿é‡Œäº‘ï¼ˆéé˜¿é‡Œä¹Ÿæ”¯æŒï¼‰ï¼Œå¤šèŠ‚ç‚¹å‘å¸ƒå·¥å…·åŠ å¼ºåŠ›linuxå®¢æˆ·ç«¯</td></tr><tr><td>stackoverflow</td><td>stackoverflowå¿«é€Ÿæœç´¢bugæ’ä»¶</td></tr><tr><td>Translation</td><td>æœ€å¼ºå¤§çš„ç¿»è¯‘æ’ä»¶ï¼Œæ”¯æŒä¸­æ–‡æ›¿æ¢è‹±æ–‡ï¼Œè§£å†³èµ·è‹±æ–‡å˜é‡åéš¾çš„é‡åº¦æ‚£è€…</td></tr><tr><td>Key Promoter X</td><td>æ‰€æœ‰æ“ä½œçš„å¿«æ·é”®æç¤ºï¼Œå¿˜è®°é¼ æ ‡çœŸçš„</td></tr><tr><td>Cyan Light Theme</td><td>A light themeï¼Œåé’è‰²å¯¹çœ¼ç›å¾ˆæŸ”å’Œèˆ’æœï¼Œé»‘æš—ä¸»é¢˜å®åœ¨ä¸é€‚åº”</td></tr><tr><td>Hiberbee theme</td><td>é»‘æš—ä¸»é¢˜çš„è‰²å½©åˆ†æ˜ç‰ˆæœ¬</td></tr></tbody></table><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>2012å¹´javaç¨‹åºå‘˜å¯ä»¥è¯´éå¸¸åƒé¦™ï¼Œä»Šå¹´2019ä»ä¸šäººæ•°æš´å¢ï¼ŒèŒä¸šå‘å±•æŒ‘æˆ˜å˜å¾—è¶Šæ¥è¶Šå¤§ï¼ç°åœ¨æµè¡Œè‡ªåŠ¨æ„å»ºå’Œè‡ªåŠ¨éƒ¨ç½²CIï¼Œå¼€å‘è¿ç»´ä¸€ä½“åŒ–dockerï¼Œæ•´ä¸ªäº’è”ç½‘éƒ½åœ¨è¿½æ±‚æ•æ·å¼€å‘çš„ä»Šå¤©ã€‚æŒæ¡ä¸€æ¬¾è¿½æ±‚æ•ˆç‡åŠŸèƒ½çš„IDEéå¸¸é‡è¦ï¼Œå¾ˆå¤šç¾¤å’Œå…¬ä¼—å·å¯¹ideå’ŒEclipseäº‰è®®å¾ˆå¤§ã€‚ä½†è¯·è®°ä½æ–¯å¤§æ—åè¨€â€”â€”è½åå°±è¦æŒ¨æ‰“ï¼Œideæœ¬èº«ä»£è¡¨é«˜æ•ˆï¼Œä½†æ˜¯æ’ä»¶ä¹Ÿåˆ«è£…å¤ªå¤šï¼Œå…å¾—å¯åŠ¨è¿˜è¦åŠå¤©å“ˆå“ˆå“ˆğŸ˜€</li><li>ï¼ˆé¦–æ¨ï¼‰æ…•è¯¾ç½‘å…è´¹æ•™ç¨‹ï¼š<a href="http://www.imooc.com/learn/924" target="_blank" rel="noopener">IntelliJ IDEAç¥å™¨ä½¿ç”¨æŠ€å·§</a></li><li>ï¼ˆæ¨èï¼‰å°šç¡…è°·IDEAè§†é¢‘æ•™ç¨‹ï¼šé“¾æ¥ï¼š<a href="https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn" target="_blank" rel="noopener">https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn</a></li><li>çœ‹å®Œä¸Šé¢ä¸¤ä¸ªæ•™ç¨‹ï¼Œä½ ä¼šæ€€ç–‘è‡ªå·±ç”¨çš„ideaæ˜¯å‡çš„ï¼ŒåŸæ¥å†™ä»£ç è¿˜å¯ä»¥è¿™æ ·çš„ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è&quot;&gt;&lt;a href=&quot;#ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è&quot; class=&quot;headerlink&quot; title=&quot;ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è&quot;&gt;&lt;/a&gt;ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è&lt;/h1&gt;&lt;h2 id=&quot;å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶&quot;&gt;&lt;a href=&quot;#å·¥å…·æ”¶
      
    
    </summary>
    
    
      <category term="tool" scheme="https://caochikai.github.io/categories/tool/"/>
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
      <category term="plugin" scheme="https://caochikai.github.io/tags/plugin/"/>
    
  </entry>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šDataSourceæ•°æ®æº</title>
    <link href="https://caochikai.github.io/2019/12/23/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ADataSource%E6%95%B0%E6%8D%AE%E6%BA%90/"/>
    <id>https://caochikai.github.io/2019/12/23/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ADataSource%E6%95%B0%E6%8D%AE%E6%BA%90/</id>
    <published>2019-12-23T10:20:00.000Z</published>
    <updated>2019-12-23T10:22:46.499Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-6ã€DataSourceæ•°æ®æº"><a href="#2-6ã€DataSourceæ•°æ®æº" class="headerlink" title="2.6ã€DataSourceæ•°æ®æº"></a>2.6ã€DataSourceæ•°æ®æº</h1><blockquote><p>æ•°æ®æºç»„ä»¶éƒ½è¦å®ç°javax.sql.DataSourceæ¥å£ï¼Œå¸¸è§çš„æœ‰Druidã€HikariCPå’ŒC3POã€‚Mybatisæä¾›ä¸¤ä¸ªå®ç°ï¼šPooledDataSourceå’ŒUnpooledDataSourceï¼Œé€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»ºã€‚</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-4.png" alt="DataSourceFactory" title="">                </div>                <div class="image-caption">DataSourceFactory</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//é€šè¿‡Properties é…ç½®æ•°æ®æº</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line"><span class="comment">//å·¥å‚è·å–æ•°æ®æºå®ä¾‹æ¥å£</span></span><br><span class="line">  <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-2-DataSourceFactory"><a href="#2-6-2-DataSourceFactory" class="headerlink" title="2.6.2 DataSourceFactory"></a>2.6.2 DataSourceFactory</h2><blockquote><p>æ•°æ®æºå·¥å‚æ¥å£çš„å®ç°ç±»æ˜¯DataSourceFactoryï¼ŒUnpooledDataSourceFactoryå’ŒPooledDataSourceæ˜¯å…·ä½“äº§å“å®ç°ç±»ï¼ŒJndiDataSourceFactoryæ˜¯ä¾èµ–JNDIæœåŠ¡ä»å®¹å™¨ä¸­è·å–ç”¨æˆ·é…ç½®çš„DataSourceï¼Œæˆ‘ä»¬ä»¥UnpooledDataSourceFactoryä¸¾ä¾‹å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.unpooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceException;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.datasource.DataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.SystemMetaObject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnpooledDataSourceFactory</span> <span class="keyword">implements</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line"><span class="comment">//å±æ€§å‰ç¼€ä¸ºdriver.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DRIVER_PROPERTY_PREFIX = <span class="string">"driver."</span>;</span><br><span class="line"><span class="comment">//driver.æ–‡å­—é•¿åº¦</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DRIVER_PROPERTY_PREFIX_LENGTH = DRIVER_PROPERTY_PREFIX.length();</span><br><span class="line"><span class="comment">//æ•°æ®æºå±æ€§</span></span><br><span class="line">  <span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">UnpooledDataSourceFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.dataSource = <span class="keyword">new</span> UnpooledDataSource();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    Properties driverProperties = <span class="keyword">new</span> Properties();</span><br><span class="line"><span class="comment">//æ ¹æ®dataSourceåˆ›å»ºMetaObject ï¼ˆåå°„è·å–è¯¥å¯¹è±¡å…ƒæ•°æ®ï¼‰</span></span><br><span class="line">    MetaObject metaDataSource = SystemMetaObject.forObject(dataSource);</span><br><span class="line">    <span class="keyword">for</span> (Object key : properties.keySet()) &#123;</span><br><span class="line">      String propertyName = (String) key;</span><br><span class="line"><span class="comment">//æ£€æŸ¥å±æ€§åç§°æ˜¯å¦ä»¥driver.å¼€å¤´</span></span><br><span class="line">      <span class="keyword">if</span> (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123;</span><br><span class="line">        String value = properties.getProperty(propertyName);</span><br><span class="line"><span class="comment">//æˆªå–driver.åè®°å½•åˆ°driverPropertiesæˆå‘˜å˜é‡</span></span><br><span class="line">        driverProperties.setProperty(propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metaDataSource.hasSetter(propertyName)) &#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰è¯¥å¯¹è±¡setå¯¹åº”çš„å±æ€§å</span></span><br><span class="line">        String value = (String) properties.get(propertyName);</span><br><span class="line"><span class="comment">//æ ¹æ®å±æ€§ç±»å‹è¿›è¡Œè½¬åŒ–</span></span><br><span class="line">        Object convertedValue = convertValue(metaDataSource, propertyName, value);</span><br><span class="line">        metaDataSource.setValue(propertyName, convertedValue);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceException(<span class="string">"Unknown DataSource property: "</span> + propertyName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (driverProperties.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      metaDataSource.setValue(<span class="string">"driverProperties"</span>, driverProperties);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//æ”¯æŒå±æ€§ç±»å‹è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸»è¦æ˜¯Integerã€Longã€Booleanä¸‰ç§ç±»å‹çš„è½¬æ¢</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">convertValue</span><span class="params">(MetaObject metaDataSource, String propertyName, String value)</span> </span>&#123;</span><br><span class="line">    Object convertedValue = value;</span><br><span class="line">    Class&lt;?&gt; targetType = metaDataSource.getSetterType(propertyName);</span><br><span class="line">    <span class="keyword">if</span> (targetType == Integer<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Integer.valueOf(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetType == Long<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">long</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Long.valueOf(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetType == Boolean<span class="class">.<span class="keyword">class</span> || <span class="title">targetType</span> </span>== <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">      convertedValue = Boolean.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> convertedValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-3-UnpooledDataSource"><a href="#2-6-3-UnpooledDataSource" class="headerlink" title="2.6.3 UnpooledDataSource"></a>2.6.3 UnpooledDataSource</h2><blockquote><p>javax.sql.DataSourceæ¥å£åœ¨æ•°æ®æºæ¨¡å—ä¸­æ‰®æ¼”äº†äº§å“æ¥å£çš„è§’è‰²ï¼ŒMyBatisæä¾›äº†ä¸¤ä¸ªDataSource æ¥å£çš„å®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯UnpooledDataSourceå’ŒPooledDataSourceï¼Œå®ƒä»¬æ‰®æ¼”ç€å…·ä½“äº§å“ç±»çš„è§’è‰²ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.unpooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnpooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"><span class="comment">//æ•°æ®æºç±»åŠ è½½å™¨</span></span><br><span class="line">  <span class="keyword">private</span> ClassLoader driverClassLoader;</span><br><span class="line"><span class="comment">//é…ç½®å±æ€§å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> Properties driverProperties;</span><br><span class="line"><span class="comment">//ç¼“å­˜æ³¨å†Œè¿‡çš„æ•°æ®æºé©±åŠ¨</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Driver&gt; registeredDrivers = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//é©±åŠ¨</span></span><br><span class="line">  <span class="keyword">private</span> String driver;</span><br><span class="line"><span class="comment">//æ•°æ®åº“URL</span></span><br><span class="line">  <span class="keyword">private</span> String url;</span><br><span class="line"><span class="comment">//ç”¨æˆ·åå’Œå¯†ç  </span></span><br><span class="line"> <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line"><span class="comment">//æ˜¯å¦è‡ªåŠ¨æäº¤</span></span><br><span class="line">  <span class="keyword">private</span> Boolean autoCommit;</span><br><span class="line"><span class="comment">//é»˜è®¤äº‹åŠ¡éš”ç¦»ç­‰çº§</span></span><br><span class="line">  **<span class="keyword">private</span> Integer defaultTransactionIsolationLevel;</span><br><span class="line"><span class="comment">//ç½‘ç»œè¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">private</span> Integer defaultNetworkTimeout;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers();</span><br><span class="line">    <span class="keyword">while</span> (drivers.hasMoreElements()) &#123;</span><br><span class="line">      Driver driver = drivers.nextElement();</span><br><span class="line"><span class="comment">//å‘DriverManageræ·»åŠ JDBCé©±åŠ¨</span></span><br><span class="line">      registeredDrivers.put(driver.getClass().getName(), driver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">doGetConnection</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–é©±åŠ¨Driverå¯¹è±¡</span></span><br><span class="line">    initializeDriver();</span><br><span class="line"><span class="comment">//åˆ›å»ºçœŸæ­£çš„æ•°æ®åº“é“¾æ¥å¯¹è±¡</span></span><br><span class="line">    Connection connection = DriverManager.getConnection(url, properties);</span><br><span class="line"><span class="comment">//é…ç½®autoCommitã€defaultTransactionIsolationLevelå’ŒdefaultNetworkTimeout</span></span><br><span class="line">    configureConnection(connection);</span><br><span class="line">    <span class="keyword">return</span> connection;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeDriver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ³¨å†Œè¿‡ï¼Œé¿å…é‡å¤</span></span><br><span class="line">    <span class="keyword">if</span> (!registeredDrivers.containsKey(driver)) &#123;</span><br><span class="line">      Class&lt;?&gt; driverType;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//é€šè¿‡å¯¹åº”çš„ç±»åŠ è½½å™¨è·å¾—å¯¹åº”çš„driverType </span></span><br><span class="line">        <span class="keyword">if</span> (driverClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">          driverType = Class.forName(driver, <span class="keyword">true</span>, driverClassLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          driverType = Resources.classForName(driver);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// DriverManager requires the driver to be loaded via the system ClassLoader.</span></span><br><span class="line">        <span class="comment">// http://www.kfu.com/~nsayer/Java/dyn-jdbc.html</span></span><br><span class="line"><span class="comment">//çœŸæ­£åˆ›å»ºDriverè¿‡ç¨‹</span></span><br><span class="line">        Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();</span><br><span class="line"><span class="comment">//DriverProxyæ˜¯UnpooledDataSourceçš„å†…éƒ¨ç±»ï¼Œæ˜¯Driverçš„é™æ€ä»£ç†ç±»</span></span><br><span class="line">        DriverManager.registerDriver(<span class="keyword">new</span> DriverProxy(driverInstance));</span><br><span class="line">        registeredDrivers.put(driver, driverInstance);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Error setting driver on UnpooledDataSource. Cause: "</span> + e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-6-4-PooledDataSource"><a href="#2-6-4-PooledDataSource" class="headerlink" title="2.6.4 PooledDataSource"></a>2.6.4 PooledDataSource</h2><blockquote><p>PooledDataSourceæ”¯æŒæ•°æ®åº“è¿æ¥æ± çš„æ•°æ®æºï¼Œä¾èµ–UnpooledDataSourceåˆ›å»ºæ•°æ®åº“è¿æ¥ã€‚è€Œä¸”PooledDataSource å¹¶ä¸ä¼šç›´æ¥ç®¡ç†java.sql.Connectionå¯¹è±¡ï¼Œè€Œæ˜¯ç®¡ç†PooledConnectionå¯¹è±¡ã€‚åœ¨PooledConnectionä¸­å°è£…äº†çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼ˆjava.sql.Connectionï¼‰ä»¥åŠå…¶ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œçš„ä»£ç†å¯¹è±¡æ˜¯é€šè¿‡JDKåŠ¨æ€ä»£ç†äº§ç”Ÿçš„ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PooledConnection</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"><span class="comment">//å…³é—­çš„æ–¹æ³•åç§°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£å…³é—­è€Œæ˜¯è¿”è¿˜åˆ°æ± å­</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLOSE = <span class="string">"close"</span>;</span><br><span class="line"><span class="comment">//åŠ¨æ€ä»£ç†çš„ç±»Class</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] IFACES = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; Connection<span class="class">.<span class="keyword">class</span> &#125;</span>;</span><br><span class="line"><span class="comment">//connectionçš„å“ˆå¸Œå€¼</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> hashCode;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PooledDataSource dataSource;</span><br><span class="line"><span class="comment">//çœŸæ­£çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection realConnection;</span><br><span class="line"><span class="comment">//æ•°æ®åº“è¿æ¥çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection proxyConnection;</span><br><span class="line"><span class="comment">//å–å‡ºçš„æ—¶é—´æˆ³</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> checkoutTimestamp;</span><br><span class="line"><span class="comment">//åˆ›å»ºçš„æ—¶é—´æˆ³</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> createdTimestamp;</span><br><span class="line"><span class="comment">//æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´æˆ³</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> lastUsedTimestamp;</span><br><span class="line"><span class="comment">//ç”±æ•°æ®åº“URLã€ç”¨æˆ·åå’Œå¯†ç è®¡ç®—å‡ºæ¥çš„hashå€¼ï¼Œå¯ç”¨äºæ ‡è¯†è¯¥è¿æ¥æ‰€åœ¨çš„è¿æ¥æ± </span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> connectionTypeCode;</span><br><span class="line"><span class="comment">//æ£€æŸ¥PooledConnectionæ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢å½’è¿˜ä¾ç„¶ä½¿ç”¨è¯¥è¿æ¥æ“ä½œæ•°æ®åº“</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> valid;</span><br><span class="line">...çœç•¥ä¸€å¤§å †geter/seteræ–¹æ³•</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Required for InvocationHandler implementation.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> proxy  - not used</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> method - the method to be executed</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args   - the parameters to be passed to the method</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see</span> java.lang.reflect.InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[])</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String methodName = method.getName();</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯CLOSEæ–¹æ³•å°±å‘dataSourceå½’è¿˜è¿æ¥æ± ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123;</span><br><span class="line">      dataSource.pushConnection(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="comment">// issue #579 toString() should never fail </span></span><br><span class="line">        <span class="comment">// throw an SQLException instead of a Runtime</span></span><br><span class="line"><span class="comment">//æ£€æŸ¥validæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆç›´æ¥æŠ›å‡ºå¼‚å¸¸SQLException</span></span><br><span class="line">        checkConnection();</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//è°ƒç”¨çœŸæ­£çš„æ•°æ®åº“å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">return</span> method.invoke(realConnection, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PoolState ç®¡ç†PooledConnectionå¯¹è±¡çŠ¶æ€çš„ç»„ä»¶ï¼Œå®ƒé€šè¿‡ä¸¤ä¸ªArrayList<br><PooledConnection>é›†åˆåˆ†åˆ«ç®¡ç†<strong>ç©ºé—²çŠ¶æ€</strong>çš„è¿æ¥å’Œ<strong>æ´»è·ƒçŠ¶æ€</strong>çš„è¿æ¥ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolState</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> PooledDataSource dataSource;</span><br><span class="line"><span class="comment">//ç©ºé—²çŠ¶æ€çš„è¿æ¥</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; idleConnections = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//**æ´»è·ƒçŠ¶æ€**çš„è¿æ¥</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;PooledConnection&gt; activeConnections = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//ä»¥ä¸‹å°±æ˜¯ä¸€äº›ç»Ÿè®¡å­—æ®µ</span></span><br><span class="line"><span class="comment">//è¯·æ±‚æ•°æ®åº“æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> requestCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//è·å–è¿æ¥ç´¯è®¡çš„æ—¶é—´</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedRequestTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//checkoutTimeè¡¨ç¤ºåº”ç”¨ä»è¿æ¥æ± ä¸­å–å‡ºè¿æ¥ï¼Œåˆ°å½’è¿˜è¿æ¥è¿™æ®µæ—¶é•¿ï¼Œ</span></span><br><span class="line"><span class="comment">//accumulatedCheckoutTimeè®°å½•äº†æ‰€æœ‰è¿æ¥ç´¯ç§¯çš„checkoutTimeæ—¶é•¿</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç´¯è®¡è¶…æ—¶è¿æ¥ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> claimedOverdueConnectionCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç´¯è®¡è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedCheckoutTimeOfOverdueConnections = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç´¯è®¡ç­‰å¾…æ—¶é—´</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> accumulatedWaitTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç­‰å¾…æ¬¡æ•°</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> hadToWaitCount = <span class="number">0</span>;ã€</span><br><span class="line"><span class="comment">//æ— æ•ˆçš„è¿æ¥æ•°</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">long</span> badConnectionCount = <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PooledDataSourceä¸­ç®¡ç†çš„çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¯¹è±¡æ˜¯ç”±PooledDataSourceä¸­å°è£…çš„UnpooledDataSourceå¯¹è±¡åˆ›å»ºçš„ï¼Œå¹¶ç”±PoolStateç®¡ç†æ‰€æœ‰è¿æ¥çš„çŠ¶æ€ã€‚PooledDataSourceä¸­æ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource.pooled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a simple, synchronous, thread-safe database connection pool.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"><span class="comment">//ç®¡ç†è¿æ¥æ± çŠ¶æ€ä»¥åŠç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PoolState state = <span class="keyword">new</span> PoolState(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//UnpooledDataSourceå¯¹è±¡ï¼Œç”¨äºç”ŸæˆçœŸå®çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–è¯¥å­—æ®µ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> UnpooledDataSource dataSource;</span><br><span class="line"><span class="comment">//é»˜è®¤çš„æœ€å¤§æ´»è·ƒè¿æ¥æ•°é‡</span></span><br><span class="line">  <span class="comment">// OPTIONAL CONFIGURATION FIELDS</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumActiveConnections = <span class="number">10</span>;ã€</span><br><span class="line"><span class="comment">//æœ€å¤§ç©ºé—²è¿æ¥æ•°é‡</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumIdleConnections = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//æœ€é•¿çš„checkoutç­‰å¾…æ—¶é—´</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumCheckoutTime = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">//åœ¨æ— æ³•è·å–è¿æ¥æ—¶å€™ï¼Œçº¿ç¨‹çš„ç­‰å¾…æ—¶é•¿</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolTimeToWait = <span class="number">20000</span>;</span><br><span class="line"><span class="comment">//æœ€å¤§å®¹å¿çš„æœ¬åœ°æ— æ•ˆè¿æ¥æ•°é‡ï¼Œå¦‚æœå¤§äºï¼ˆæœ€å¤§æ´»è·ƒè¿æ¥æ•°é‡ + æœ€å¤§ç©ºé—²è¿æ¥æ•°é‡ï¼‰,ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolMaximumLocalBadConnectionTolerance = <span class="number">3</span>;</span><br><span class="line"><span class="comment">//æ£€æŸ¥æ•°æ®åº“æ˜¯å¦SQLè¯­å¥</span></span><br><span class="line">  <span class="keyword">protected</span> String poolPingQuery = <span class="string">"NO PING QUERY SET"</span>;</span><br><span class="line"><span class="comment">//æ˜¯å¦å…è®¸å‘é€ä¸Šé¢çš„poolPingQuery æµ‹è¯•SQLè¯­å¥</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">boolean</span> poolPingEnabled;</span><br><span class="line"><span class="comment">//å½“è¿æ¥è¶…è¿‡poo1PingconnectionsNotUsedForæ¯«ç§’æœªä½¿ç”¨æ—¶ï¼Œä¼šå‘é€ä¸€æ¬¡æµ‹è¯•sQLè¯­å¥ï¼Œæ£€æµ‹è¿æ¥æ˜¯å¦æ­£å¸¸</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> poolPingConnectionsNotUsedFor;</span><br><span class="line"><span class="comment">//æ ¹æ®æ•°æ®åº“çš„URLã€ç”¨æˆ·åå’Œå¯†ç ç”Ÿæˆçš„ä¸€ä¸ªhashå€¼ï¼Œè¯¥å“ˆå¸Œå€¼ç”¨äºæ ‡å¿—ç€å½“å‰çš„è¿æ¥æ± </span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> expectedConnectionTypeCode;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PooledDataSource.getConnection()æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨PooledDataSource.popConnection()æ–¹æ³•è·å–PooledConnectionå¯¹è±¡ï¼Œç„¶åé€šè¿‡PooledConnection.getProxyConnection()æ–¹æ³•è·å–æ•°æ®åº“è¿æ¥çš„ä»£ç†å¯¹è±¡ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">popConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> countedWait = <span class="keyword">false</span>;</span><br><span class="line">    PooledConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> localBadConnectionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (state) &#123;<span class="comment">//åŒæ­¥é”</span></span><br><span class="line"><span class="comment">//æ£€æµ‹æ˜¯å¦æœ‰ç©ºé—²è¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> (!state.idleConnections.isEmpty()) &#123;</span><br><span class="line">          <span class="comment">// Pool has available connection</span></span><br><span class="line"><span class="comment">//è·å–ç©ºé—²è¿æ¥</span></span><br><span class="line">          conn = state.idleConnections.remove(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Checked out connection "</span> + conn.getRealHashCode() + <span class="string">" from pool."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//æ²¡æœ‰ç©ºé—²çš„ Pool does not have available connection</span></span><br><span class="line"><span class="comment">//åˆ¤æ–­å½“å‰æ´»è·ƒè¿æ¥æ•°é‡æ˜¯å¦å·²ç»è¶…è¿‡çš„æœ€å¤§æ´»è·ƒæ•°é‡é™åˆ¶</span></span><br><span class="line">          <span class="keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªå¹¶å°è£…æˆPooledConnection</span></span><br><span class="line">            conn = <span class="keyword">new</span> PooledConnection(dataSource.getConnection(), <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Created connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//è¶…è¿‡äº†é™åˆ¶ï¼Œè·å–æœ€å…ˆåˆ›å»ºçš„æ´»è·ƒè¿æ¥</span></span><br><span class="line">            PooledConnection oldestActiveConnection = state.activeConnections.get(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//è·å–å…¶è¶…æ—¶æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¶…æ—¶</span></span><br><span class="line">            <span class="keyword">long</span> longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</span><br><span class="line">            <span class="keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</span><br><span class="line"><span class="comment">// å¯¹è¶…æ—¶è¿æ¥è¿›è¡Œç»Ÿè®¡</span></span><br><span class="line">              state.claimedOverdueConnectionCount++;</span><br><span class="line">              state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</span><br><span class="line">              state.accumulatedCheckoutTime += longestCheckoutTime;</span><br><span class="line"><span class="comment">//å¹¶ç§»å‡ºæ´»è·ƒè¿æ¥é›†åˆ</span></span><br><span class="line">              state.activeConnections.remove(oldestActiveConnection);</span><br><span class="line"><span class="comment">//å¦‚æœè¿æ¥è¶…æ—¶ä¸”æœªæäº¤ï¼Œåˆ™è‡ªåŠ¨å›æ»šï¼ˆçœç•¥try/catchä»£ç å—ï¼‰</span></span><br><span class="line">              <span class="keyword">if</span> (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                  oldestActiveConnection.getRealConnection().rollback();</span><br><span class="line">              &#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºæ–°Pooledconnectionå¯¹è±¡ï¼Œä½†æ˜¯çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¹¶æœªåˆ›å»ºæ–°çš„</span></span><br><span class="line">              conn = <span class="keyword">new</span> PooledConnection(oldestActiveConnection.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">              conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp());</span><br><span class="line">              conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());</span><br><span class="line"><span class="comment">//å°†è¶…æ—¶è¿æ¥è®¾ç½®æˆä¸ºæ— æ•ˆçŠ¶æ€</span></span><br><span class="line">              oldestActiveConnection.invalidate();</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Claimed overdue connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//æ— ç©ºé—²è¿æ¥ã€æ— æ³•åˆ›å»ºæ–°è¿æ¥ä¸”æ— è¶…æ—¶è¿æ¥ï¼Œåˆ™åªèƒ½é˜»å¡ç­‰å¾…</span></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!countedWait) &#123;</span><br><span class="line">                  state.hadToWaitCount++;<span class="comment">//ç»Ÿè®¡ç­‰å¾…ä¿¡æ¯</span></span><br><span class="line">                  countedWait = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Waiting as long as "</span> + poolTimeToWait + <span class="string">" milliseconds for connection."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">long</span> wt = System.currentTimeMillis();</span><br><span class="line"><span class="comment">//é˜»å¡ç­‰å¾…poolTimeToWaitï¼Œä¸‹é¢å°±ç»Ÿè®¡ä¸€ä¸‹ç­‰å¾…ä¿¡æ¯</span></span><br><span class="line">                state.wait(poolTimeToWait);</span><br><span class="line">                state.accumulatedWaitTime += System.currentTimeMillis() - wt;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// ping to server and check the connection is valid or not</span></span><br><span class="line">          <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">              conn.getRealConnection().rollback();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//é…ç½®PooledConnectionçš„å±æ€§ï¼ŒconnectionTypeCodeç”±url + username + passwordç»„æˆåçš„hashCode</span></span><br><span class="line">            conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));</span><br><span class="line"><span class="comment">//è®°å½•checkoutæ—¶é—´</span></span><br><span class="line">            conn.setCheckoutTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="comment">//æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´</span></span><br><span class="line">            conn.setLastUsedTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="comment">//è¿›è¡Œç›¸å…³ç»Ÿè®¡</span></span><br><span class="line">            state.activeConnections.add(conn);</span><br><span class="line">            state.requestCount++;</span><br><span class="line">            state.accumulatedRequestTime += System.currentTimeMillis() - t;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"A bad connection ("</span> + conn.getRealHashCode() + <span class="string">") was returned from the pool, getting another connection."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//æ— æ•ˆè¿æ¥æ•°é‡ç»Ÿè®¡</span></span><br><span class="line">            state.badConnectionCount++;</span><br><span class="line">            localBadConnectionCount++;</span><br><span class="line">            conn = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (localBadConnectionCount &gt; (poolMaximumIdleConnections + poolMaximumLocalBadConnectionTolerance)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"PooledDataSource: Could not get a good connection to the database."</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"PooledDataSource: Could not get a good connection to the database."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>çœ‹åå­—å°±çŸ¥é“ï¼ˆPoolï¼‰æ˜¯æ”¯æŒè¿æ¥æ± ï¼Œé‚£é€šè¿‡å‰é¢å¯¹PooledConnection.invokeæ–¹æ³•çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œå½“è°ƒç”¨è¿æ¥çš„ä»£ç†å¯¹è±¡çš„closeæ–¹æ³•æ—¶ï¼Œå¹¶æœªå…³é—­çœŸæ­£çš„æ•°æ®è¿æ¥ï¼Œè€Œæ˜¯ä»£ç†è°ƒç”¨PooledDataSource.pushConnectionæ–¹æ³•å°†PooledConnection å¯¹è±¡å½’è¿˜ç»™è¿æ¥æ± ã€‚ä¸‹é¢å°±åˆ†æå½’è¿˜è§„ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pushConnection</span><span class="params">(PooledConnection conn)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//åŒæ­¥state</span></span><br><span class="line">    <span class="keyword">synchronized</span> (state) &#123;</span><br><span class="line"><span class="comment">//ä»activeConnectionsé›†åˆé‡Œé¢ç§»é™¤è¯¥å¯¹è±¡</span></span><br><span class="line">      state.activeConnections.remove(conn);</span><br><span class="line"><span class="comment">//æ£€æŸ¥è¿æ¥å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">      <span class="keyword">if</span> (conn.isValid()) &#123;</span><br><span class="line"><span class="comment">//è‹¥å½“å‰ç©ºé—²è¿æ¥é›†åˆæ•°é‡å°äºæœ€å¤§ç©ºé—²é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥è¿æ¥çš„connectionTypeCodeå’Œæ•°æ®æºæœ¬èº«çš„hashCodeä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123;</span><br><span class="line"><span class="comment">//ç´¯è®¡checkoutæ—¶é•¿</span></span><br><span class="line">          state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">          <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">            conn.getRealConnection().rollback();</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//ä¸ºè¿”è¿˜è¿æ¥å¯¹è±¡åŒ…è£…æˆPooledConnection </span></span><br><span class="line">          PooledConnection newConn = <span class="keyword">new</span> PooledConnection(conn.getRealConnection(), <span class="keyword">this</span>);</span><br><span class="line">          state.idleConnections.add(newConn);<span class="comment">//æ·»åŠ åˆ°ç©ºé—²é›†åˆidleConnections</span></span><br><span class="line">          newConn.setCreatedTimestamp(conn.getCreatedTimestamp());</span><br><span class="line">          newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());</span><br><span class="line"><span class="comment">//å°†åŸPooledConnectionè®¾ç½®ä¸ºæ— æ•ˆ</span></span><br><span class="line">          conn.invalidate();</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Returned connection "</span> + newConn.getRealHashCode() + <span class="string">" to pool."</span>);</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//å”¤é†’é€šçŸ¥å…¶ä»–ç­‰å¾…é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">          state.notifyAll();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//ç©ºé—²è¿æ¥åˆ°è¾¾ä¸Šé™æˆ–è€…hashCodeä¸åŒ¹é…ï¼ˆæ„å‘³ç€ä¸å±äºè¯¥è¿æ¥æ± ï¼‰</span></span><br><span class="line">          state.accumulatedCheckoutTime += conn.getCheckoutTime();</span><br><span class="line">          <span class="keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">            conn.getRealConnection().rollback();</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//å…³é—­çœŸæ­£çš„æ•°æ®åº“è¿æ¥</span></span><br><span class="line">          conn.getRealConnection().close();</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Closed connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">//è®¾ç½®æˆæ— æ•ˆ</span></span><br><span class="line">          conn.invalidate();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">"A bad connection ("</span> + conn.getRealHashCode() + <span class="string">") attempted to return to the pool, discarding connection."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//ç»Ÿè®¡æ— æ•ˆè¿æ¥æ•°é‡</span></span><br><span class="line">        state.badConnectionCount++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ä¸Šé¢ä»£ç åˆ†æå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šæ¬¡çœ‹è§isValid()æ–¹æ³•ï¼Œé™¤äº†æ ¡éªŒPooledConnection.validå±æ€§å¤–ï¼Œè¿˜ä¼šè°ƒç”¨dataSource.pingConnectionæ–¹æ³•è®©æ•°æ®åº“æ‰§è¡ŒpoolPingQueryçš„æµ‹è¯•SQLæ•°æ®åº“è¯­å¥ï¼Œä¸‹é¢è®©æˆ‘è®¨è®ºä¸‹å…³äºæ ¡éªŒè¿æ¥æœ‰æ•ˆçš„è¿‡ç¨‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> True if the connection is usable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> valid &amp;&amp; realConnection != <span class="keyword">null</span> &amp;&amp; dataSource.pingConnection(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/**é€šè¿‡å‘é€pingæ£€æŸ¥SQLåˆ¤æ–­å½“å‰æ•°æ®åº“è¿æ¥æ˜¯å¦å·²ç»å¤±æ•ˆï¼Œæ¯•ç«Ÿæ•°æ®åº“å¯¹é•¿æ—¶é—´çš„é“¾æ¥ä¹Ÿä¼šåšå¤±æ•ˆå¤„ç†</span></span><br><span class="line"><span class="comment">   * Method to check to see if a connection is still usable</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> conn - the connection to check</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> True if the connection is still usable</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">pingConnection</span><span class="params">(PooledConnection conn)</span> </span>&#123;</span><br><span class="line"><span class="comment">//pingæ“ä½œæˆåŠŸçš„æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//å…ˆæ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦å·²ç»å…³é—­</span></span><br><span class="line">      result = !conn.getRealConnection().isClosed();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is BAD: "</span> + e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//1ã€å¦‚æœæ²¡å…³é—­è¿›ä¸€æ­¥æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line"><span class="comment">//2ã€æ£€æŸ¥SQLæ£€æŸ¥çš„å¿ƒè·³å¼€å…³</span></span><br><span class="line">      <span class="keyword">if</span> (poolPingEnabled) &#123;</span><br><span class="line"><span class="comment">//3ã€æ£€æŸ¥poolPingConnectionsNotUsedForæ˜¯å¦å·²ç»è¶…è¿‡ï¼ˆå½“å‰æ—¶é—´è·ç¦»æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´é—´è·ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (poolPingConnectionsNotUsedFor &gt;= <span class="number">0</span> &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Testing connection "</span> + conn.getRealHashCode() + <span class="string">" ..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Connection realConn = conn.getRealConnection();</span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯æ‰§è¡ŒSQLæµ‹è¯•è¯­å¥</span></span><br><span class="line">            <span class="keyword">try</span> (Statement statement = realConn.createStatement()) &#123;</span><br><span class="line">              statement.executeQuery(poolPingQuery).close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!realConn.getAutoCommit()) &#123;</span><br><span class="line">              realConn.rollback();</span><br><span class="line">            &#125;</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is GOOD!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">"Execution of ping query '"</span> + poolPingQuery + <span class="string">"' failed: "</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              conn.getRealConnection().close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">              <span class="comment">//ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"Connection "</span> + conn.getRealHashCode() + <span class="string">" is BAD: "</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-6ã€DataSourceæ•°æ®æº&quot;&gt;&lt;a href=&quot;#2-6ã€DataSourceæ•°æ®æº&quot; class=&quot;headerlink&quot; title=&quot;2.6ã€DataSourceæ•°æ®æº&quot;&gt;&lt;/a&gt;2.6ã€DataSourceæ•°æ®æº&lt;/h1&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼åŸåˆ™</title>
    <link href="https://caochikai.github.io/2019/12/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8E%9F%E5%88%99/"/>
    <id>https://caochikai.github.io/2019/12/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%8E%9F%E5%88%99/</id>
    <published>2019-12-22T15:43:00.000Z</published>
    <updated>2019-12-22T15:51:21.986Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™"><a href="#å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™" class="headerlink" title="å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™"></a><a href="https://mubu.com/doc/soIjHUAYIW" target="_blank" rel="noopener">å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™</a></h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/pasted-3.png" alt="æ€ç»´å¯¼å›¾" title="">                </div>                <div class="image-caption">æ€ç»´å¯¼å›¾</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™&quot;&gt;&lt;a href=&quot;#å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™&quot; class=&quot;headerlink&quot; title=&quot;å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://mubu.com/doc/soIjHUAYIW&quot; target=&quot;_blank&quot; r
      
    
    </summary>
    
    
      <category term="software engineering" scheme="https://caochikai.github.io/categories/software-engineering/"/>
    
    
      <category term="software engineering" scheme="https://caochikai.github.io/tags/software-engineering/"/>
    
  </entry>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šèµ„æºåŠ è½½</title>
    <link href="https://caochikai.github.io/2019/12/22/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/"/>
    <id>https://caochikai.github.io/2019/12/22/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD/</id>
    <published>2019-12-22T06:10:00.000Z</published>
    <updated>2019-12-22T06:15:40.679Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-5ã€èµ„æºåŠ è½½"><a href="#2-5ã€èµ„æºåŠ è½½" class="headerlink" title="2.5ã€èµ„æºåŠ è½½"></a>2.5ã€èµ„æºåŠ è½½</h1><h2 id="2-5-1ã€ç±»åŠ è½½å™¨"><a href="#2-5-1ã€ç±»åŠ è½½å™¨" class="headerlink" title="2.5.1ã€ç±»åŠ è½½å™¨"></a>2.5.1ã€ç±»åŠ è½½å™¨</h2><blockquote><p>JVMç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰è´Ÿè´£åŠ è½½å„ç§èµ„æºï¼ˆä¸»è¦æ˜¯classå­—èŠ‚ç æ–‡ä»¶)ï¼Œæ¥æºæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œèµ„æºæˆ–è€…å…¶ä»–æ¥æºï¼Œä¸”é»˜è®¤ä½¿ç”¨çš„æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚ç±»åŠ è½½å™¨åŸºæœ¬ä¸‰å¤§ç‰¹æ€§ä¸ºå»¶è¿ŸåŠ è½½ã€èŒè´£åˆ†æ˜ã€ä¼ é€’æ€§ã€‚è€ŒJVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ ClassLoaderï¼š BootstrapClassLoaderã€ExtensionClassLoader å’Œ AppClassLoaderã€‚URLClassLoader ä¸ä½†å¯ä»¥åŠ è½½è¿œç¨‹ç±»åº“ï¼Œè¿˜å¯ä»¥åŠ è½½æœ¬åœ°è·¯å¾„çš„ç±»åº“ï¼Œå–å†³äºæ„é€ å™¨ä¸­ä¸åŒçš„åœ°å€å½¢å¼ã€‚ExtensionClassLoader å’Œ AppClassLoader éƒ½æ˜¯ URLClassLoader çš„å­ç±»ï¼Œå®ƒä»¬éƒ½æ˜¯ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé‡ŒåŠ è½½ç±»åº“ã€‚</p></blockquote><ul><li><p>BootstrapClassLoaderï¼ˆæ ¹åŠ è½½å™¨ï¼‰ï¼šåŠ è½½JVMæ ¸å¿ƒç±»ï¼Œæ¯”å¦‚$JAVA_HOME/lib/rt.jarï¼›</p></li><li><p>ExtensionClassLoaderï¼ˆæ‰©å±•åŠ è½½å™¨ï¼‰ï¼šåŠ è½½æ‰©å±•ç±»ï¼Œä»¥ javax å¼€å¤´çš„swing ç³»åˆ—ã€å†…ç½®çš„ js å¼•æ“ã€xml è§£æå™¨ç­‰ç­‰ï¼›</p></li><li><p>AppClassLoaderï¼ˆç”¨æˆ·åŠ è½½å™¨ï¼‰ï¼šClassLoader.getSystemClassLoader()è·å¾—ï¼ŒåŠ è½½Classpath ç¯å¢ƒå˜é‡ä¸‹ç›®å½•å’Œjarï¼›</p></li><li><p>Thread.contextClassLoaderï¼ˆçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼‰ï¼šä¸»è¦æ˜¯ç±»éš”ç¦»æˆ–è€…å…±äº«ï¼›</p></li><li><p>åŒäº²å§”æ´¾æ¨¡å¼ï¼šç®€å•äº†æ¥è¯´å­ç±»æœ‰ä¸ªparent å±æ€§æŒ‡å‘å®ƒçš„çˆ¶åŠ è½½å™¨ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰ï¼Œå…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½è¿‡å°±ä¼˜å…ˆè®©çˆ¶ç±»å°è¯•åŠ è½½ï¼ˆç†è§£ä¸ºå¾ˆæ‡’éƒ½å‘çˆ¹ï¼‰ï¼Œå¦‚æœå·²ç»åŠ è½½æˆ–è€…å‘çˆ¹ä¸æˆé‚£å°±è‡ªå·±å¹²ã€‚</p></li><li><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šç»§æ‰¿java.lang.ClassLoaderï¼Œæ¯”å¦‚Tomcatï¼ˆWebAppClassLoaderï¼‰ã€JBossç±»åŠ è½½å™¨ï¼›</p>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="comment">// Note: VM hardcoded the offset of this field, thus all new fields</span></span><br><span class="line">    <span class="comment">// must be added *after* it.</span></span><br><span class="line"><span class="comment">//å¦‚æœparentä¸ºç©ºï¼ˆæ¯”å¦‚ExtensionClassLoaderï¼‰ï¼Œé‚£é»˜è®¤nullå°±æ˜¯æ ¹åŠ è½½å™¨BootstrapClassLoader</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="2-5-2-ClassloaderWrapper"><a href="#2-5-2-ClassloaderWrapper" class="headerlink" title="2.5.2 ClassloaderWrapper"></a>2.5.2 ClassloaderWrapper</h2><blockquote><p>çœ‹åå­—å°±çŸ¥é“æ˜¯ClassLoaderçš„åŒ…è£…å™¨ï¼Œ<a href="http://org.apache.ibatis.io/" target="_blank" rel="noopener">org.apache.ibatis.io</a>åŒ…å°±å°è£…äº†èµ„æºåŠ è½½æ–‡ä»¶çš„ç›¸å…³APIï¼Œé€šè¿‡ClassloaderWrapperåŒ…è£…å™¨å°±å¯ä»¥è°ƒæ•´å¤šä¸ªClassLoaderçš„ä½¿ç”¨é¡ºåºã€‚ClassLoaderWrapperçš„ä¸»è¦æ–¹æ³•å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯getResourceAsURLæ–¹æ³•ã€classForNameæ–¹æ³•ã€getResourceAsStreamæ–¹æ³•ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A class to wrap access to multiple class loaders making them work as one</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderWrapper</span> </span>&#123;</span><br><span class="line"><span class="comment">//æŒ‡å®šçš„é»˜è®¤ç±»åŠ è½½å™¨</span></span><br><span class="line">  ClassLoader defaultClassLoader;</span><br><span class="line"><span class="comment">//SecurityManagerç³»ç»Ÿç±»åŠ è½½å™¨</span></span><br><span class="line">  ClassLoader systemClassLoader;</span><br><span class="line"></span><br><span class="line">  ClassLoaderWrapper() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–ç±»åŠ è½½å™¨</span></span><br><span class="line">      systemClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ignored) &#123;</span><br><span class="line">      <span class="comment">// AccessControlException on Google App Engine</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ClassLoader[]&#123;</span><br><span class="line">        classLoader,<span class="comment">//å‚æ•°æŒ‡å®šåŠ è½½å™¨</span></span><br><span class="line">        defaultClassLoader,<span class="comment">//é»˜è®¤åŠ è½½å™¨</span></span><br><span class="line">        Thread.currentThread().getContextClassLoader(),<span class="comment">//çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨</span></span><br><span class="line">        getClass().getClassLoader(),<span class="comment">//å½“å‰ç±»æ‰€ä½¿ç”¨çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">        systemClassLoader&#125;;<span class="comment">//System ClassLoader</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...çœç•¥éƒ¨åˆ†é‡è½½æ–¹æ³•</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Try to get a resource from a group of classloaders</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resource    - the resource to get</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the classloaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the resource or null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">InputStream <span class="title">getResourceAsStream</span><span class="params">(String resource, ClassLoader[] classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="comment">// try to find the resource as passed</span></span><br><span class="line">        InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line">        <span class="comment">// now, some class loaders want this leading "/", so we'll add it and try again if we didn't find the resource</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == returnValue) &#123;</span><br><span class="line">          returnValue = cl.getResourceAsStream(<span class="string">"/"</span> + resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != returnValue) &#123;</span><br><span class="line">          <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get a resource as a URL using the current class path</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resource    - the resource to locate</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the class loaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the resource or null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">URL <span class="title">getResourceAsURL</span><span class="params">(String resource, ClassLoader[] classLoader)</span> </span>&#123;</span><br><span class="line">    URL url;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="comment">// look for the resource as passed in...</span></span><br><span class="line">        url = cl.getResource(resource);</span><br><span class="line">        <span class="comment">// ...but some class loaders want this leading "/", so we'll add it</span></span><br><span class="line">        <span class="comment">// and try again if we didn't find the resource</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == url) &#123;</span><br><span class="line">          url = cl.getResource(<span class="string">"/"</span> + resource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// "It's always in the last place I look for it!"</span></span><br><span class="line">        <span class="comment">// ... because only an idiot would keep looking for it after finding it, so stop looking already.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != url) &#123;</span><br><span class="line">          <span class="keyword">return</span> url;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// didn't find it anywhere.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Attempt to load a class from a group of classloaders</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> name        - the class to load</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> classLoader - the group of classloaders to examine</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> ClassNotFoundException - Remember the wisdom of Judge Smails: Well, the world needs ditch diggers, too.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Class&lt;?&gt; classForName(String name, ClassLoader[] classLoader) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">for</span> (ClassLoader cl : classLoader) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != cl) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Class&lt;?&gt; c = Class.forName(name, <span class="keyword">true</span>, cl)</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">          <span class="comment">// we'll ignore this until all classloaders fail to locate the class</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Cannot find class: "</span> + name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5-3-ResolverUtil"><a href="#2-5-3-ResolverUtil" class="headerlink" title="2.5.3 ResolverUtil"></a>2.5.3 ResolverUtil</h2><blockquote><p>ResolverUtilæ ¹æ®æŒ‡å®šçš„æ¡ä»¶æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„ç±»ï¼Œå…¶ä¸­æ¡ä»¶ç”±Testæ¥å£ä¸­å®šä¹‰äº†matchesæ–¹æ³•æä¾›ã€‚</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/Test.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ***</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolverUtil</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A simple interface that specifies how to test classes to determine if they</span></span><br><span class="line"><span class="comment">   * are to be included in the results produced by the ResolverUtil.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Will be called repeatedly with candidate classes. Must return True if a class</span></span><br><span class="line"><span class="comment">     * is to be included in the results, false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A Test that checks to see if each class is assignable to the provided class. Note</span></span><br><span class="line"><span class="comment">   * that this test will match the parent type itself if it is presented for matching.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IsA</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; parent;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...æ„é€ æ–¹æ³•åˆå§‹åŒ–parent</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns true if type is assignable to the parent type supplied in the constructor. */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­parentæ˜¯å¦æ˜¯typeçš„çˆ¶ç±»ï¼ˆç»§æ‰¿ï¼‰</span></span><br><span class="line">      <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; parent.isAssignableFrom(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A Test that checks to see if each class is annotated with a specific annotation. If it</span></span><br><span class="line"><span class="comment">   * is, then the test returns true, otherwise false.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotatedWith</span> <span class="keyword">implements</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Annotation&gt; annotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...æ„é€ æ–¹æ³•åˆå§‹åŒ–annotation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns true if the type is annotated with the class provided to the constructor. */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class="line"><span class="comment">//åˆ¤æ–­Typeç±»ä¸Šæ˜¯å¦æ·»åŠ äº†annotationæ³¨è§£</span></span><br><span class="line">      <span class="keyword">return</span> type != <span class="keyword">null</span> &amp;&amp; type.isAnnotationPresent(annotation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The set of matches being accumulated. */</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Class&lt;? extends T&gt;&gt; matches = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The ClassLoader to use when looking for classes. If null then the ClassLoader returned</span></span><br><span class="line"><span class="comment">   * by Thread.currentThread().getContextClassLoader() will be used.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> ClassLoader classloader;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Provides access to the classes discovered so far. If no calls have been made to</span></span><br><span class="line"><span class="comment">   * any of the &#123;<span class="doctag">@code</span> find()&#125; methods, **this set will be empty**.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> åŒ¹é…çš„ç±».</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Set&lt;Class&lt;? extends T&gt;&gt; getClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> matches;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the classloader that will be used for scanning for classes. If no explicit</span></span><br><span class="line"><span class="comment">   * ClassLoader has been set by the calling,the context class loader will be used.</span></span><br><span class="line"><span class="comment">   *  é»˜è®¤æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> classloader == <span class="keyword">null</span> ? Thread.currentThread().getContextClassLoader() : classloader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClassLoader</span><span class="params">(ClassLoader classloader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.classloader = classloader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Scans for classes starting at the package provided and descending into subpackages.</span></span><br><span class="line"><span class="comment">   * Each class is offered up to the Test as it is discovered, and if the Test returns</span></span><br><span class="line"><span class="comment">   * true the class is retained.  Accumulated classes can be fetched by calling</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> test an instance of &#123;<span class="doctag">@link</span> Test&#125; that will be used to filter classes</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> packageName the name of the package from which to start scanning for</span></span><br><span class="line"><span class="comment">   *        classes, e.g. </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResolverUtil&lt;T&gt; <span class="title">find</span><span class="params">(Test test, String packageName)</span> </span>&#123;</span><br><span class="line"><span class="comment">//æ ¹æ®åŒ…åè·å–å¯¹åº”çš„è·¯å¾„</span></span><br><span class="line">    String path = getPackagePath(packageName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//æ ¹æ®VFSç»“æœé›†åˆæŸ¥æ‰¾ä¸Šé¢pathä¸‹çš„èµ„æº</span></span><br><span class="line">      List&lt;String&gt; children = VFS.getInstance().list(path);</span><br><span class="line">      <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child.endsWith(<span class="string">".class"</span>)) &#123;</span><br><span class="line"><span class="comment">//æ£€æŸ¥classæ˜¯å¦ç¬¦åˆç»“æœ</span></span><br><span class="line">          addIfMatching(test, child);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      log.error(<span class="string">"Could not read package: "</span> + packageName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>â€‹    </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add the class designated by the fully qualified class name provided to the set of</span></span><br><span class="line"><span class="comment">   * resolved classes if and only if it is approved by the Test supplied.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> test the test used to determine if the class matches æŸ¥æ‰¾æ¡ä»¶</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> fqn the fully qualified name of a class ç±»çš„å®Œå…¨é™å®šåç§°</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addIfMatching</span><span class="params">(Test test, String fqn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String externalName = fqn.substring(<span class="number">0</span>, fqn.indexOf(<span class="string">'.'</span>)).replace(<span class="string">'/'</span>, <span class="string">'.'</span>);</span><br><span class="line">      ClassLoader loader = getClassLoader();</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Checking to see if class "</span> + externalName + <span class="string">" matches criteria ["</span> + test + <span class="string">"]"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Class&lt;?&gt; type = loader.loadClass(externalName);<span class="comment">//åŠ è½½æŒ‡å®šçš„ç±»</span></span><br><span class="line">      <span class="keyword">if</span> (test.matches(type)) &#123;</span><br><span class="line">     <span class="comment">//å¦‚æœæ¡ä»¶è¿‡æ»¤åœ¨æ·»åŠ åˆ°åŒ¹é…ç»“æœé›†åˆmatches</span></span><br><span class="line">        matches.add((Class&lt;T&gt;) type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      log.warn(<span class="string">"Could not examine class '"</span> + fqn + <span class="string">"'"</span> + <span class="string">" due to a "</span> +</span><br><span class="line">          t.getClass().getName() + <span class="string">" with message: "</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨ä¾‹å­ï¼šåœ¨pkg1å’Œpkg2è¿™ä¸¤ä¸ªåŒ…ä¸‹æŸ¥æ‰¾å®ç°äº†ActionBeanè¿™ä¸ªç±»</span></span><br><span class="line">ResolverUtil&lt;ActionBean&gt; resolver = <span class="keyword">new</span> ResolverUtil&lt;ActionBean&gt;();</span><br><span class="line">resolver.findImplementation(ActionBean<span class="class">.<span class="keyword">class</span>, <span class="title">pkg1</span>, <span class="title">pkg2</span>)</span>;</span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg1);</span><br><span class="line">resolver.find(<span class="keyword">new</span> CustomTest(), pkg2);</span><br><span class="line"><span class="comment">//è·å–ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•ä¸‰æ¬¡æŸ¥æ‰¾çš„ç»“æœé›†</span></span><br><span class="line">Collection&lt;ActionBean&gt; beans = resolver.getClasses();</span><br></pre></td></tr></table></figure><h2 id="2-5-5-VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰"><a href="#2-5-5-VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰" class="headerlink" title="2.5.5 VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰"></a>2.5.5 VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰</h2><blockquote><p>VFSæ˜¯Virtual File Systemç¼©å†™ï¼Œç”¨æ¥æŸ¥æ‰¾æŒ‡å®šè·¯å¾„ä¸‹çš„èµ„æºã€‚VFSä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒMybatisåœ¨<a href="http://org.apache.ibatis.io/" target="_blank" rel="noopener">org.apache.ibatis.io</a>ä¸‹æœ‰DefaultVFSå’ŒJBoss6VFSçš„å®ç°ï¼ŒUMLå›¾å¦‚ä¸‹ï¼š</p></blockquote><p><img src="/images/VFS.png" alt="upload successful"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides a very simple API for accessing resources within an application server.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ben Gunter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">VFS</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The built-in implementations.è®°å½•äº†ä¸¤ä¸ªå®ç°ç±» */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] IMPLEMENTATIONS = &#123; JBoss6VFS<span class="class">.<span class="keyword">class</span>, <span class="title">DefaultVFS</span>.<span class="title">class</span> &#125;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** The list to which implementations are added by &#123;<span class="doctag">@link</span> #addImplClass(Class)&#125;.</span></span><br><span class="line"><span class="comment"> *ç”¨æˆ·è‡ªå®šä¹‰çš„VESå®ç°ç±»ã€‚addImplClassï¼ˆï¼‰æ–¹æ³•ä¼šå°†æŒ‡å®šçš„VESå®ç°Classå¯¹è±¡æ·»åŠ åˆ°é›†åˆã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends VFS&gt;&gt; USER_IMPLEMENTATIONS = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="comment">/** Singleton instance holder.å•ä¾‹ */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VFSHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> VFS INSTANCE = createVFS();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">static</span> VFS <span class="title">createVFS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Try the user implementations first, then the built-ins</span></span><br><span class="line">      List&lt;Class&lt;? extends VFS&gt;&gt; impls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„VFSçš„å®ç°ç±»</span></span><br><span class="line">      impls.addAll(USER_IMPLEMENTATIONS);</span><br><span class="line"><span class="comment">//éšåä½¿ç”¨Mybatisæä¾›çš„JBoss6VFS.class, DefaultVFS.class</span></span><br><span class="line">      impls.addAll(Arrays.asList((Class&lt;? extends VFS&gt;[]) IMPLEMENTATIONS));</span><br><span class="line"><span class="comment">//éå†æ‰€æœ‰å®ç°ç±»ï¼Œä¾æ¬¡å®ä¾‹åŒ–VFSå¯¹è±¡å¹¶åˆ¤æ–­æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨å°±è¿”å›å¯¹è±¡ç»“æŸå¾ªç¯</span></span><br><span class="line">      <span class="comment">// Try each implementation class until a valid one is found</span></span><br><span class="line">      VFS vfs = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; vfs == <span class="keyword">null</span> || !vfs.isValid(); i++) &#123;</span><br><span class="line">        Class&lt;? extends VFS&gt; impl = impls.get(i);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          vfs = impl.getDeclaredConstructor().newInstance();</span><br><span class="line">          <span class="keyword">if</span> (!vfs.isValid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">              log.debug(<span class="string">"VFS implementation "</span> + impl.getName() +</span><br><span class="line">                  <span class="string">" is not valid in this environment."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">          log.error(<span class="string">"Failed to instantiate "</span> + impl, e);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Using VFS adapter "</span> + vfs.getClass().getName());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> vfs;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**å•ä¾‹æ¨¡å¼ä½“ç°ï¼Œé€šè¿‡é™æ€ç±»åˆ›å»º</span></span><br><span class="line"><span class="comment">   * Get the singleton &#123;<span class="doctag">@link</span> VFS&#125; instance. If no &#123;<span class="doctag">@link</span> VFS&#125; implementation can be found for the</span></span><br><span class="line"><span class="comment">   * current environment, then this method returns null.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VFS <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> VFSHolder.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//æŠ½è±¡æ–¹æ³•</span></span><br><span class="line"><span class="comment">/*isValid()è´Ÿè´£æ£€æµ‹å½“å‰VFSå¯¹è±¡åœ¨å½“å‰ç¯å¢ƒä¸‹æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">* Return true if the &#123;@link VFS&#125; implementation is valid for the current environment. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**è´Ÿè´£æŸ¥æ‰¾æŒ‡å®šçš„èµ„æºåç§°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">   * Recursively list the full resource path of all the resources that are children of the</span></span><br><span class="line"><span class="comment">   * resource identified by a URL.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> url The URL that identifies the resource to list.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> forPath The path to the resource that is identified by the URL. Generally, this is the</span></span><br><span class="line"><span class="comment">   *            value passed to &#123;<span class="doctag">@link</span> #getResources(String)&#125; to get the resource URL.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> A list containing the names of the child resources.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException If I/O errors occur</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;String&gt; <span class="title">list</span><span class="params">(URL url, String forPath)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>VFSä¸­å®šä¹‰äº†listï¼ˆURLï¼ŒStringï¼‰å’ŒisValid()ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåœ¨ResolverUtil.find()æ–¹æ³•æŸ¥æ‰¾ç±»æ–‡ä»¶æ—¶ä¼šè°ƒç”¨list()æ–¹æ³•çš„é‡è½½æ–¹æ³•ï¼Œè¯¥é‡è½½æœ€ç»ˆä¼šè°ƒç”¨listï¼ˆURLï¼ŒStringï¼‰è¿™ä¸ªé‡è½½ã€‚æˆ‘ä»¬ä»¥DefaultVFSä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œå®ç°å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">ackage org.apache.ibatis.io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ***</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.LogFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**VFSçš„é»˜è®¤å®ç°æ–¹æ³•ï¼Œé€‚ç”¨äºå¤§å¤šæ•°çš„åº”ç”¨æœåŠ¡</span></span><br><span class="line"><span class="comment"> * A default implementation of &#123;<span class="doctag">@link</span> VFS&#125; that works for most application servers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ben Gunter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultVFS</span> <span class="keyword">extends</span> <span class="title">VFS</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(DefaultVFS<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯jaræ–‡ä»¶çš„å­—èŠ‚ç‰¹å¾</span></span><br><span class="line">  <span class="comment">/** The magic header that indicates a JAR (ZIP) file. */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] JAR_MAGIC = &#123; <span class="string">'P'</span>, <span class="string">'K'</span>, <span class="number">3</span>, <span class="number">4</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">list</span><span class="params">(URL url, String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;String&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// First, try to find the URL of a JAR file containing the requested resource. If a JAR</span></span><br><span class="line">      <span class="comment">// file is found, then we'll list child resources by reading the JAR.</span></span><br><span class="line"><span class="comment">//å°è¯•è¯»å–jaræ–‡ä»¶ï¼Œè¿”å›å¯¹åº”çš„URLï¼Œå¦‚æœä¸ºç©ºé‚£å°±ä»£è¡¨ä¸æ˜¯jarèµ„æº</span></span><br><span class="line">      URL jarUrl = findJarForResource(url);</span><br><span class="line">      <span class="keyword">if</span> (jarUrl != <span class="keyword">null</span>) &#123;</span><br><span class="line">        is = jarUrl.openStream();</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">          log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//éå†jaråŒ…ä¸­ä»¥pathå¼€å¤´çš„èµ„æºåˆ—è¡¨</span></span><br><span class="line">        resources = listResources(<span class="keyword">new</span> JarInputStream(is), path);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//éå†urlçš„å­ç›®å½•å¹¶è®°å½•åˆ°children </span></span><br><span class="line">        List&lt;String&gt; children = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (isJar(url)) &#123;</span><br><span class="line">            <span class="comment">// Some versions of JBoss VFS might give a JAR stream even if the resource</span></span><br><span class="line">            <span class="comment">// referenced by the URL isn't actually a JAR</span></span><br><span class="line">            is = url.openStream();</span><br><span class="line">            <span class="keyword">try</span> (JarInputStream jarInput = <span class="keyword">new</span> JarInputStream(is)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">for</span> (JarEntry entry; (entry = jarInput.getNextJarEntry()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Jar entry: "</span> + entry.getName());</span><br><span class="line">                &#125;</span><br><span class="line">                children.add(entry.getName());</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* å¤§æ„æ˜¯éƒ¨åˆ†åº”ç”¨æ˜¯èµ„æºåˆ—è¡¨åœ¨æ–‡æœ¬æ–‡ä»¶çš„é‡Œï¼Œä¸‹é¢å°è¯•é€è¡Œè¯»å–èµ„æºï¼Œ</span></span><br><span class="line"><span class="comment">*è·¯å¾„ä¸ºpath + "/" + lineï¼ˆæ¯è¡Œå†…å®¹ï¼‰è‹¥è¯»å–æˆåŠŸä¸ºæ–‡ä»¶ï¼Œå¦åˆ™ä¸ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">             * Some servlet containers allow reading from directory resources like a</span></span><br><span class="line"><span class="comment">             * text file, listing the child resources one per line. However, there is no</span></span><br><span class="line"><span class="comment">             * way to differentiate between directory and file resources just by reading</span></span><br><span class="line"><span class="comment">             * them. To work around that, as each line is read, try to look it up via</span></span><br><span class="line"><span class="comment">             * the class loader as a child of the current resource. If any line fails</span></span><br><span class="line"><span class="comment">             * then we assume the current resource is not a directory.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            is = url.openStream();</span><br><span class="line">            List&lt;String&gt; lines = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is))) &#123;</span><br><span class="line">              <span class="keyword">for</span> (String line; (line = reader.readLine()) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Reader entry: "</span> + line);</span><br><span class="line">                &#125;</span><br><span class="line">                lines.add(line);</span><br><span class="line">                <span class="keyword">if</span> (getResources(path + <span class="string">"/"</span> + line).isEmpty()) &#123;</span><br><span class="line">                  lines.clear();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!lines.isEmpty()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              children.addAll(lines);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">          <span class="comment">/*è‹¥è¯»å–URLå¤±è´¥åˆ™ç›´æ¥æ•´ä¸ªæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment">           * For file URLs the openStream() call might fail, depending on the servlet</span></span><br><span class="line"><span class="comment">           * container, because directories can't be opened for reading. If that happens,</span></span><br><span class="line"><span class="comment">           * then list the directory directly instead.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">"file"</span>.equals(url.getProtocol())) &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Listing directory "</span> + file.getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                  log.debug(<span class="string">"Listing "</span> + url);</span><br><span class="line">              &#125;</span><br><span class="line">              children = Arrays.asList(file.list());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No idea where the exception came from so rethrow it</span></span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The URL prefix to use when recursively listing child resources</span></span><br><span class="line">        String prefix = url.toExternalForm();</span><br><span class="line">        <span class="keyword">if</span> (!prefix.endsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">          prefix = prefix + <span class="string">"/"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Iterate over immediate children, adding files and recursing into directories</span></span><br><span class="line">        <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">          String resourcePath = path + <span class="string">"/"</span> + child;</span><br><span class="line">          resources.add(resourcePath);</span><br><span class="line">          URL childUrl = <span class="keyword">new</span> URL(prefix + child);</span><br><span class="line">          resources.addAll(list(childUrl, resourcePath));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resources;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">...å…³é—­æµ</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * List the names of the entries in the given &#123;<span class="doctag">@link</span> JarInputStream&#125; that begin with the</span></span><br><span class="line"><span class="comment">   * specified &#123;<span class="doctag">@code</span> path&#125;. Entries will match with or without a leading slash.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jar The JAR input stream</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> path The leading path to match</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The names of all the matching entries</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException If I/O errors occur</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">listResources</span><span class="params">(JarInputStream jar, String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Include the leading and trailing slash when matching names</span></span><br><span class="line"><span class="comment">//...å¦‚æœpathä¸æ˜¯ä»¥/å¼€å§‹å’Œç»“æŸï¼Œåˆ™åœ¨å…¶å¼€å§‹å’Œç»“æŸä½ç½®æ·»åŠ /ï¼ˆç•¥ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate over the entries and collect those that begin with the requested path</span></span><br><span class="line">    List&lt;String&gt; resources = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//éå†jaråŒ…,å°†ä»¥pathå¼€å¤´èµ„æºåŠ å…¥åˆ°resources é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (JarEntry entry; (entry = jar.getNextJarEntry()) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!entry.isDirectory()) &#123;</span><br><span class="line">        <span class="comment">// Add leading slash if it's missing</span></span><br><span class="line">        StringBuilder name = <span class="keyword">new</span> StringBuilder(entry.getName());</span><br><span class="line">        <span class="keyword">if</span> (name.charAt(<span class="number">0</span>) != <span class="string">'/'</span>) &#123;</span><br><span class="line">          name.insert(<span class="number">0</span>, <span class="string">'/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check file name-&gt;pathå¼€å¤´</span></span><br><span class="line">        <span class="keyword">if</span> (name.indexOf(path) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Found resource: "</span> + name);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Trim leading slash</span></span><br><span class="line">          resources.add(name.substring(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resources;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><ul><li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/lang/resources.html" target="_blank" rel="noopener">Oracle Location-Independent Access to Resources</a></li><li><a href="https://juejin.im/post/5c04892351882516e70dcc9b" target="_blank" rel="noopener">è€å¤§éš¾çš„ Java ClassLoader å†ä¸ç†è§£å°±è€äº†</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-5ã€èµ„æºåŠ è½½&quot;&gt;&lt;a href=&quot;#2-5ã€èµ„æºåŠ è½½&quot; class=&quot;headerlink&quot; title=&quot;2.5ã€èµ„æºåŠ è½½&quot;&gt;&lt;/a&gt;2.5ã€èµ„æºåŠ è½½&lt;/h1&gt;&lt;h2 id=&quot;2-5-1ã€ç±»åŠ è½½å™¨&quot;&gt;&lt;a href=&quot;#2-5-1ã€ç±»åŠ è½½å™¨&quot; class=&quot;
      
    
    </summary>
    
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šæ—¥å¿—æ¨¡å—</title>
    <link href="https://caochikai.github.io/2019/12/21/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/"/>
    <id>https://caochikai.github.io/2019/12/21/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97/</id>
    <published>2019-12-21T13:19:00.000Z</published>
    <updated>2019-12-21T13:23:59.656Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-4ã€æ—¥å¿—æ¨¡å—"><a href="#2-4ã€æ—¥å¿—æ¨¡å—" class="headerlink" title="2.4ã€æ—¥å¿—æ¨¡å—"></a>2.4ã€æ—¥å¿—æ¨¡å—</h1><blockquote><p>Mybatisæ—¥å¿—æ¨¡å—ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œå†…éƒ¨è°ƒç”¨org.apache.ibatis.logging.Log æ¥å£ã€‚ä¸ºäº†æ•´åˆç¬¬ä¸‰æ–¹çš„æ—¥å¿—ç»„ä»¶Log4J2ã€Log4Jï¼Œmybatisæä¾›äº†å¤šç§Adapteré€‚é…è¿™äº›æ—¥å¿—ç»„ä»¶çš„APIï¼Œå¹¶éµå®ˆLog æ¥å£æ ‡å‡†ã€‚åœ¨æ—¥å¿—çº§åˆ«æ”¯æŒä¸­ï¼ŒMybatisæä¾›äº†traceã€debugã€warnã€erorå››ä¸ªçº§åˆ«ï¼Œåªèƒ½è¯´åŸºæœ¬æ»¡è¶³ç»å¤§å¤šæ•°åœºæ™¯çš„æ—¥å¿—ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line"><span class="comment">//iså¼€å¤´æ–¹æ³•ä¸ºåˆ¤æ–­ç™»è®°æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isDebugEnabled</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isTraceEnabled</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//ä¸‹é¢å››ä¸ªåˆ†åˆ«æ”¯æŒå››ç§ç­‰çº§æ—¥å¿—è°ƒç”¨</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s, Throwable e)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">trace</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">warn</span><span class="params">(String s)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>LogFactoryè´Ÿè´£åˆ›å»ºå¯¹åº”çš„æ—¥å¿—ç»„ä»¶çš„é€‚é…å™¨ï¼Œå…¶å†…éƒ¨é€»è¾‘åŸºæœ¬å…¬å…±é™æ€ä»£ç å—åŠ è½½æ”¯æŒçš„æ—¥å¿—é€‚é…å™¨ï¼Œç„¶åä½¿ç”¨logConstructoré›†åˆè®°å½•æ‰€æœ‰æ”¯æŒçš„æ—¥å¿—é€‚é…å™¨ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Marker to be used by logging implementations that support markers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MARKER = <span class="string">"MYBATIS"</span>;</span><br><span class="line"><span class="comment">//ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶çš„é›†åˆ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Log&gt; logConstructor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    tryImplementation(LogFactory::useSlf4jLogging);</span><br><span class="line">    tryImplementation(LogFactory::useCommonsLogging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4J2Logging);</span><br><span class="line">    tryImplementation(LogFactory::useLog4JLogging);</span><br><span class="line">    tryImplementation(LogFactory::useJdkLogging);</span><br><span class="line">    tryImplementation(LogFactory::useNoLogging);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">LogFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// disable construction</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Log <span class="title">getLog</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getLog(aClass.getName());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Log <span class="title">getLog</span><span class="params">(String logger)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è¿”å›loggerå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">return</span> logConstructor.newInstance(logger);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LogException(<span class="string">"Error creating logger for logger "</span> + logger + <span class="string">".  Cause: "</span> + t, t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> ...useå¼€å¤´æ–¹æ³•çœç•¥éƒ½ä¼šèµ°ä¸‹é¢æ–¹æ³•setImplementationï¼ˆå¯¹åº”é€‚é…å™¨ç±»ï¼‰</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryImplementation</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        runnable.run();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImplementation</span><span class="params">(Class&lt;? extends Log&gt; implClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è·å–æŒ‡å®šé€‚é…å™¨çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">      Constructor&lt;? extends Log&gt; candidate = implClass.getConstructor(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="comment">//å®ä¾‹åŒ–é€‚é…å™¨</span></span><br><span class="line">      Log log = candidate.newInstance(LogFactory<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">      <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Logging initialized using '"</span> + implClass + <span class="string">"' adapter."</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–logConstructor</span></span><br><span class="line">      logConstructor = candidate;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LogException(<span class="string">"Error setting Log implementation.  Cause: "</span> + t, t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-4ã€JDBCè°ƒè¯•æ—¥å¿—"><a href="#2-4-4ã€JDBCè°ƒè¯•æ—¥å¿—" class="headerlink" title="2.4.4ã€JDBCè°ƒè¯•æ—¥å¿—"></a>2.4.4ã€JDBCè°ƒè¯•æ—¥å¿—</h3><blockquote><p>org.apache.ibatis.logging.jdbcæ˜¯Mybatisé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå°†JDBCæ“ä½œé€šè¿‡æŒ‡å®šçš„æ—¥å¿—æ¡†æ¶æ‰“å°å‡ºæ¥ï¼Œè¾“å‡ºå†…å®¹åŒ…å«sqlè¯­å¥ã€ç»‘å®šå‚æ•°ã€å½±å“è¡Œæ•°ç­‰ç­‰ã€‚BaseJdbcLoggeræ˜¯jdbcä¸‹æ‰€æœ‰loggerç±»çš„çˆ¶ç±»ï¼Œç»§æ‰¿æ ‘å¦‚ä¸‹ï¼š</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/jdbc_log.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...çœç•¥éƒ¨åˆ†å¯¼å…¥</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ArrayUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base class for proxies to do logging.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseJdbcLogger</span> </span>&#123;</span><br><span class="line"><span class="comment">//PreparedStatementæ¥å£ä¸­å®šä¹‰çš„å¸¸ç”¨çš„set*ï¼ˆï¼‰æ–¹æ³•å</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;StrinSg&gt; SET_METHODS;</span><br><span class="line"><span class="comment">//Statementæ¥å£å’ŒPreparedStatementæ¥å£ä¸­ä¸æ‰§è¡ŒSQLè¯­å¥ç›¸å…³çš„æ–¹æ³•å</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; EXECUTE_METHODS = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"><span class="comment">//PreparedStatement.set*ï¼ˆï¼‰æ–¹æ³•è®¾ç½®çš„é”®å€¼å¯¹ï¼Œkeyä¸ºparameterIndexä¸‹æ ‡ï¼Œvalueä¸ºåˆ—å€¼</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; columnMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//parameterIndexé›†åˆ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; columnNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//valueé›†åˆ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; columnValues = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//å½“å‰æ”¯æŒçš„é€‚é…å™¨å®ä¾‹</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Log statementLog;</span><br><span class="line"><span class="comment">//Sqlå±‚æ•°ï¼Œç”¨äºæ ¼å¼åŒ–sqlï¼Œbufferå †æ ˆçš„æ·±åº¦-&gt;char[] buffer = new char[queryStack * 2 + 2];</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> queryStack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Default constructorï¼Œä¼ å…¥é€‚é…å™¨å®ä¾‹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BaseJdbcLogger</span><span class="params">(Log log, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.statementLog = log;</span><br><span class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.queryStack = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.queryStack = queryStack;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//lambadaè·å–PreparedStatementå¼€é€šsetXXXæ–¹æ³•åç§°é›†åˆ</span></span><br><span class="line">    SET_METHODS = Arrays.stream(PreparedStatement<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredMethods</span>())</span></span><br><span class="line">            .filter(method -&gt; method.getName().startsWith("set"))</span><br><span class="line">            .filter(method -&gt; method.getParameterCount() &gt; <span class="number">1</span>)</span><br><span class="line">            .map(Method::getName)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line"><span class="comment">//æ‰§è¡Œæ–¹æ³•ä»£ç†ç›®æ ‡</span></span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"execute"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeUpdate"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeQuery"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"addBatch"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//å¾€SET_METHODSé›†åˆæ·»åŠ è®°å½•</span></span><br><span class="line">    SET_METHODS.add(<span class="string">"setString"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNString"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setInt"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setByte"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setShort"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setLong"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setDouble"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setFloat"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setTimestamp"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setDate"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setTime"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setArray"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBigDecimal"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setAsciiStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBinaryStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBlob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBoolean"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setBytes"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setCharacterStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNCharacterStream"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setClob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNClob"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setObject"</span>);</span><br><span class="line">    SET_METHODS.add(<span class="string">"setNull"</span>);</span><br><span class="line"></span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"execute"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeUpdate"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"executeQuery"</span>);</span><br><span class="line">    EXECUTE_METHODS.add(<span class="string">"addBatch"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setColumn</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    columnMap.put(key, value);</span><br><span class="line">    columnNames.add(key);</span><br><span class="line">    columnValues.add(value);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>PreparedStatementLoggerç»§æ‰¿äº†BaseJdbcLoggerå¹¶å®ç°äº†InvocationHandleræ¥å£ã€‚PreparedStatementLogger.invokeæ–¹æ³•ä¼šä¸ºEXECUTE_METHODSé›†åˆä¸­çš„æ–¹æ³•ã€SET_METHODSé›†åˆä¸­çš„æ–¹æ³•ã€getResultSetç­‰æ–¹æ³•æä¾›ä»£ç†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.sql.CallableStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PreparedStatement proxy to add logging.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementLogger</span> <span class="keyword">extends</span> <span class="title">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PreparedStatement statement;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">PreparedStatementLogger</span><span class="params">(PreparedStatement stmt, Log statementLog, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(statementLog, queryStack);</span><br><span class="line">    <span class="keyword">this</span>.statement = stmt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, params);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//è°ƒç”¨äº†EXECUTE_METHODSé›†åˆä¸­çš„æ–¹æ³•</span></span><br><span class="line">      <span class="keyword">if</span> (EXECUTE_METHODS.contains(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isDebugEnabled()) &#123;</span><br><span class="line"><span class="comment">//æ—¥å¿—è¾“å‡ºï¼Œè¾“å‡ºçš„æ˜¯å‚æ•°å€¼ä»¥åŠå‚æ•°ç±»å‹-&gt;()</span></span><br><span class="line">          debug(<span class="string">"Parameters: "</span> + getParameterValueString(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clearColumnInfo();<span class="comment">//æ¸…ç©ºBaseJdbcLoggerä¸­å®šä¹‰çš„ä¸‰ä¸ªcolumn*é›†åˆ</span></span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯executeQueryæ–¹æ³•ï¼Œåˆ™ä¸ºResultSetåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä¸æ˜¯åˆ™ç›´æ¥è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"executeQuery"</span>.equals(method.getName())) &#123;</span><br><span class="line">          ResultSet rs = (ResultSet) method.invoke(statement, params);</span><br><span class="line">          <span class="keyword">return</span> rs == <span class="keyword">null</span> ? <span class="keyword">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SET_METHODS.contains(method.getName())) &#123;</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯SET_METHODSé›†åˆä¸­çš„æ–¹æ³•ï¼Œåˆ™é€šè¿‡setColumnè®°å½•åˆ°</span></span><br><span class="line"><span class="comment">//BaseJdbcLoggerçš„ä¸‰ä¸ªcolumn*é›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"setNull"</span>.equals(method.getName())) &#123;</span><br><span class="line">          setColumn(params[<span class="number">0</span>], <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          setColumn(params[<span class="number">0</span>], params[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getResultSet"</span>.equals(method.getName())) &#123;</span><br><span class="line"><span class="comment">//å¦‚æœè°ƒç”¨getResultSetï¼ˆï¼‰æ–¹æ³•ï¼Œåˆ™ä¸ºResultSetåˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line">        ResultSet rs = (ResultSet) method.invoke(statement, params);</span><br><span class="line">        <span class="keyword">return</span> rs == <span class="keyword">null</span> ? <span class="keyword">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getUpdateCount"</span>.equals(method.getName())) &#123;</span><br><span class="line">        <span class="keyword">int</span> updateCount = (Integer) method.invoke(statement, params);</span><br><span class="line">        <span class="keyword">if</span> (updateCount != -<span class="number">1</span>) &#123;</span><br><span class="line">          debug(<span class="string">"   Updates: "</span> + updateCount, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//è¿”å›å½±å“æ¡æ•°</span></span><br><span class="line">        <span class="keyword">return</span> updateCount;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(statement, params);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a logging version of a PreparedStatement.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> stmt - the statement</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> statementLog - the statement log</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> queryStack - the query stack</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> - the proxy ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„æ–¹å¼åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PreparedStatement <span class="title">newInstance</span><span class="params">(PreparedStatement stmt, Log statementLog, <span class="keyword">int</span> queryStack)</span> </span>&#123;</span><br><span class="line">    InvocationHandler handler = <span class="keyword">new</span> PreparedStatementLogger(stmt, statementLog, queryStack);</span><br><span class="line">    ClassLoader cl = PreparedStatement<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">    <span class="keyword">return</span> (PreparedStatement) Proxy.newProxyInstance(cl, <span class="keyword">new</span> Class[]&#123;PreparedStatement<span class="class">.<span class="keyword">class</span>, <span class="title">CallableStatement</span>.<span class="title">class</span>&#125;, <span class="title">handler</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Return the wrapped prepared statement.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the PreparedStatement</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">getPreparedStatement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ResultSetLogger ä¸­å°è£…äº†ResultSetå¯¹è±¡ï¼Œä¹Ÿç»§æ‰¿äº†BaseldbcLoggeræŠ½è±¡ç±»å¹¶å®ç°äº†InvocationHandler æ¥å£ã€‚ResultSetLoggerä¸­å®šä¹‰çš„å­—æ®µå¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.logging.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSetMetaData;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Types;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.logging.Log;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ResultSet proxy to add logging</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eduardo Macarron</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultSetLogger</span> <span class="keyword">extends</span> <span class="title">BaseJdbcLogger</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"><span class="comment">//è®°å½•äº†è¶…å¤§é•¿åº¦çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Integer&gt; BLOB_TYPES = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"><span class="comment">//æ˜¯å¦æ˜¯ResultSetç»“æœé›†çš„ç¬¬ä¸€è¡Œ</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//ç»Ÿè®¡è¡Œæ•°</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> rows;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ResultSet rs;</span><br><span class="line"><span class="comment">//è®°å½•äº†è¶…å¤§å­—æ®µçš„åˆ—ç¼–å·</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; blobColumns = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line"><span class="comment">//æ‰€æœ‰è¶…å¤§é•¿åº¦çš„ç±»å‹</span></span><br><span class="line">    BLOB_TYPES.add(Types.BINARY);</span><br><span class="line">    BLOB_TYPES.add(Types.BLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.CLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGNVARCHAR);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGVARBINARY);</span><br><span class="line">    BLOB_TYPES.add(Types.LONGVARCHAR);</span><br><span class="line">    BLOB_TYPES.add(Types.NCLOB);</span><br><span class="line">    BLOB_TYPES.add(Types.VARBINARY);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Object<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">method</span>.<span class="title">getDeclaringClass</span>())) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, params);</span><br><span class="line">      &#125;</span><br><span class="line">      Object o = method.invoke(rs, params);</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"next"</span>.equals(method.getName())) &#123;</span><br><span class="line"><span class="comment">//æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> ((Boolean) o) &#123;</span><br><span class="line">          rows++;</span><br><span class="line">          <span class="keyword">if</span> (isTraceEnabled()) &#123;</span><br><span class="line">            ResultSetMetaData rsmd = rs.getMetaData();</span><br><span class="line"><span class="comment">//è·å–æ•°æ®é›†çš„åˆ—æ•°</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> columnCount = rsmd.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (first) &#123;</span><br><span class="line">              first = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//è¾“å‡ºè¡¨å¤´ï¼Œå¹¶å¡«å……è¶…å¤§é•¿åº¦çš„ç±»å‹åˆ°é›†åˆä¸­</span></span><br><span class="line">              printColumnHeaders(rsmd, columnCount);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//è¾“å‡ºè¯¥è¡Œè®°å½•ï¼Œæ³¨æ„ä¼šè¿‡æ»¤æ‰blobColumnsä¸­è®°å½•çš„åˆ—ï¼Œ</span></span><br><span class="line"><span class="comment">//è¿™äº›åˆ—çš„æ•°æ®è¾ƒå¤§ï¼Œä¸ä¼šè¾“å‡ºåˆ°æ—¥å¿—</span></span><br><span class="line">            printColumnValues(columnCount);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//éå†ResultSetä¹‹åè¾“å‡ºæ€»ï¼Œå®Œä¾‹å­ï¼šTotal: 1</span></span><br><span class="line">          debug(<span class="string">"     Total: "</span> + rows, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      clearColumnInfo();<span class="comment">//æ¸…ç©ºBaseJdbcLoggerçš„ä¸‰ä¸ªcolumn*é›†åˆ</span></span><br><span class="line">      <span class="keyword">return</span> o;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//ä¾‹å­ï¼šHeader: [count(*)]</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printColumnHeaders</span><span class="params">(ResultSetMetaData rsmd, <span class="keyword">int</span> columnCount)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    StringBuilder row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    row.append(<span class="string">"   Columns: "</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (BLOB_TYPES.contains(rsmd.getColumnType(i))) &#123;</span><br><span class="line">        blobColumns.add(i);</span><br><span class="line">      &#125;</span><br><span class="line">      String colname = rsmd.getColumnLabel(i);</span><br><span class="line">      row.append(colname);</span><br><span class="line">      <span class="keyword">if</span> (i != columnCount) &#123;</span><br><span class="line">        row.append(<span class="string">", "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(row.toString(), <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¾‹å­ï¼šRow: 39</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printColumnValues</span><span class="params">(<span class="keyword">int</span> columnCount)</span> </span>&#123;</span><br><span class="line">    StringBuilder row = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    row.append(<span class="string">"       Row: "</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</span><br><span class="line">      String colname;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (blobColumns.contains(i)) &#123;</span><br><span class="line">          colname = <span class="string">"&lt;&lt;BLOB&gt;&gt;"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          colname = rs.getString(i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="comment">// generally can't call getString() on a BLOB column</span></span><br><span class="line">        colname = <span class="string">"&lt;&lt;Cannot Display&gt;&gt;"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      row.append(colname);</span><br><span class="line">      <span class="keyword">if</span> (i != columnCount) &#123;</span><br><span class="line">        row.append(<span class="string">", "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(row.toString(), <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-4ã€æ—¥å¿—æ¨¡å—&quot;&gt;&lt;a href=&quot;#2-4ã€æ—¥å¿—æ¨¡å—&quot; class=&quot;headerlink&quot; title=&quot;2.4ã€æ—¥å¿—æ¨¡å—&quot;&gt;&lt;/a&gt;2.4ã€æ—¥å¿—æ¨¡å—&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Mybatisæ—¥å¿—æ¨¡å—ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œå†…éƒ¨è°ƒç”¨org.apach
      
    
    </summary>
    
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šç±»å‹è½¬æ¢</title>
    <link href="https://caochikai.github.io/2019/12/20/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A2-3%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/"/>
    <id>https://caochikai.github.io/2019/12/20/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A2-3%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/</id>
    <published>2019-12-20T12:40:00.000Z</published>
    <updated>2019-12-21T13:28:32.042Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2-3ã€ç±»å‹è½¬æ¢"><a href="#2-3ã€ç±»å‹è½¬æ¢" class="headerlink" title="2.3ã€ç±»å‹è½¬æ¢"></a>2.3ã€ç±»å‹è½¬æ¢</h1><blockquote><p>JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨PreparedStatementä¸ºSOLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œéœ€è¦ä»Javaç±»å‹è½¬æ¢æˆJDBCç±»å‹ï¼Œè€Œä»ç»“æœé›†ä¸­è·å–æ•°æ®æ—¶ï¼Œåˆ™éœ€è¦ä»JDBCç±»å‹è½¬æ¢æˆJavaç±»å‹ã€‚MyBatisä½¿ç”¨ç±»å‹å¤„ç†å™¨å®Œæˆä¸Šè¿°ä¸¤ç§è½¬æ¢ã€‚</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="/images/myabtisTypehandle.png" alt="upload successful" title="">                </div>                <div class="image-caption">upload successful</div>            </figure><h3 id="2-3-1ã€TypeHandler"><a href="#2-3-1ã€TypeHandler" class="headerlink" title="2.3.1ã€TypeHandler"></a>2.3.1ã€TypeHandler</h3><blockquote><p>Mybatiså½“ä¸­æ‰€æœ‰ç±»å‹è½¬åŒ–å™¨éƒ½ç»§æ‰¿BaseTypeHandlerï¼Œè€ŒBaseTypeHandleråˆå®ç°äº†TypeHandleræ¥å£ã€‚æ¥å£å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼Œåˆ†æˆä¸¤ç±»ï¼šsetParameter()æ–¹æ³•è´Ÿè´£å°†æ•°æ®ç”±JdbcType ç±»å‹è½¬æ¢æˆJavaç±»å‹ï¼›getResult()æ–¹æ³•åŠå…¶é‡è½½è´Ÿè´£å°†æ•°æ®ç”±Javaç±»å‹è½¬æ¢æˆJdbcTypeç±»å‹ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line">import java.sql.CallableStatement;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface TypeHandler&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åœ¨é€šè¿‡Preparedstatementä¸ºSQLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œä¼šå°†æ•°æ®ç”±JdbcTypeç±»å‹è½¬æ¢æˆJavaç±»å‹</span><br><span class="line">  void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException;</span><br><span class="line"></span><br><span class="line">  &#x2F;**</span><br><span class="line">   * @param columnName Colunm name, when configuration &lt;code&gt;useColumnLabel&lt;&#x2F;code&gt; is &lt;code&gt;false&lt;&#x2F;code&gt;</span><br><span class="line">   *&#x2F;</span><br><span class="line">&#x2F;&#x2F;ä»ResultSetä¸­è·å–æ•°æ®ï¼Œé€šè¿‡å­—æ®µåç§°å°†æ•°æ®ç”±Javaç±»å‹è½¬æ¢æˆJdbcTypeç±»å‹</span><br><span class="line">  T getResult(ResultSet rs, String columnName) throws SQLException;</span><br><span class="line">&#x2F;&#x2F;ä»ResultSetä¸­è·å–æ•°æ®ï¼Œé€šè¿‡å­—æ®µä¸‹æ ‡ï¼ˆåŒä¸Šé¢getResultï¼‰</span><br><span class="line">  T getResult(ResultSet rs, int columnIndex) throws SQLException;</span><br><span class="line">&#x2F;&#x2F;CallableStatementä¸­é€šè¿‡ä¸‹æ ‡è·å–ç»“æœ</span><br><span class="line">  T getResult(CallableStatement cs, int columnIndex) throws SQLException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸€èˆ¬ç±»å‹è½¬æ¢å™¨é€‚ç”¨äºå•ä¸ªå‚æ•°æˆ–è€…å•ä¸ªåˆ—å€¼å®Œæˆç±»å‹è½¬æ¢ï¼Œå¤§å¤šæ•°æ˜¯ç›´æ¥è°ƒç”¨PreparedStatementã€ResultSetã€CallableStatementçš„å¯¹åº”æ–¹æ³•ï¼Œ ä»¥org.apache.ibatis.type.StringTypeHandlerä¸ºä¾‹å­å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTypeHandler</span> <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i, String parameter, JdbcType jdbcType)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨PreparedStatement.setXXX(Type)ç»‘å®šå‚æ•°</span></span><br><span class="line">    ps.setString(i, parameter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, String columnName)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"><span class="comment">//ResultSet.getXXX(Type)(åˆ—åç§°)è·å–åˆ—å€¼</span></span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(ResultSet rs, <span class="keyword">int</span> columnIndex)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">//ResultSet.getXXX(Type)(åˆ—ä¸‹æ ‡)è·å–åˆ—å€¼</span></span><br><span class="line">    <span class="keyword">return</span> rs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNullableResult</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> columnIndex)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cs.getString(columnIndex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-2ã€TypeHandlerRegistry"><a href="#2-3-2ã€TypeHandlerRegistry" class="headerlink" title="2.3.2ã€TypeHandlerRegistry"></a>2.3.2ã€TypeHandlerRegistry</h3><blockquote><p>TypeHandlerRegistryç®¡ç†æ‰€æœ‰çš„ç±»å‹è½¬åŒ–å™¨ï¼Œregister()æ–¹æ³•å®ç°äº†æ³¨å†ŒåŠŸèƒ½ï¼Œè¿‡ç¨‹ä¸­ä¼šå‘ä¸‹è¿°å­—æ®µé›†åˆæ·»åŠ TypeHandlerã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Clinton Begin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Kazuki Shimizu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeHandlerRegistry</span> </span>&#123;</span><br><span class="line"><span class="comment">//åœ¨è¯»å–ç»“æœæ•°æ®æ—¶å€™ï¼Œä¾é è¯¥é›†åˆæ˜ å°„ä»jdbcTypeè½¬æ¢æˆjavaTypeï¼Œ</span></span><br><span class="line"><span class="comment">//è€ŒJdbcTypeç±»å‹ä¸ºorg.apache.ibatis.type.JdbcTypeæšä¸¾ç±»å‹</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;  jdbcTypeHandlerMap = <span class="keyword">new</span> EnumMap&lt;&gt;(JdbcType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="comment">//è®°å½•äº†Javaç±»å‹å‘æŒ‡å®šJdbcrypeè½¬æ¢æ—¶ï¼Œéœ€è¦ä½¿ç”¨çš„TypeHandlerå¯¹è±¡ã€‚ä¾‹å¦‚ï¼›Javaç±»å‹ä¸­çš„stringå¯èƒ½</span></span><br><span class="line"><span class="comment">//è½¬æ¢æˆæ•™æ®åº“çš„ charã€varcharç­‰å¤šç§ç±»å‹ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å¯¹å¤šå…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; typeHandlerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">  <span class="comment">//Objectç±»å‹TypeHandlerå¤„ç†ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeHandler&lt;Object&gt; unknownTypeHandler = <span class="keyword">new</span> UnknownTypeHandler(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">//å…¨éƒ¨Javaç±»å‹ä»¥åŠå¯¹åº”çš„TypeHandler</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; allTypeHandlersMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//ç©ºTypeHandleré›†åˆçš„æ ‡è¯†</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; NULL_TYPE_HANDLER_MAP = Collections.emptyMap();</span><br><span class="line"><span class="comment">//æšä¸¾ç±»å‹çš„TypeHandleré›†åˆ</span></span><br><span class="line">  <span class="keyword">private</span> Class&lt;? extends TypeHandler&gt; defaultEnumTypeHandler = EnumTypeHandler<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2-3ã€ç±»å‹è½¬æ¢&quot;&gt;&lt;a href=&quot;#2-3ã€ç±»å‹è½¬æ¢&quot; class=&quot;headerlink&quot; title=&quot;2.3ã€ç±»å‹è½¬æ¢&quot;&gt;&lt;/a&gt;2.3ã€ç±»å‹è½¬æ¢&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨
      
    
    </summary>
    
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šåå°„å·¥å…·ç®±</title>
    <link href="https://caochikai.github.io/2019/12/19/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%B1%82/"/>
    <id>https://caochikai.github.io/2019/12/19/Mybatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95-%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%B1%82/</id>
    <published>2019-12-19T13:24:00.000Z</published>
    <updated>2019-12-21T13:16:03.331Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚"><a href="#ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚" class="headerlink" title="ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚"></a>ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚</h1><blockquote><p>Mybatisä»¥SqlSessionFactoryä¸ºæ ¸å¿ƒï¼Œé€šè¿‡SqlSessionFactoryBuilderè§£æxmlé…ç½®æ–‡ä»¶æˆ–Configrationå®ä¾‹æ„å»ºå‡ºSqlSessionFactoryçš„å®ä¾‹ã€‚</p></blockquote><h2 id="ä¸€ã€é‡è¦æ¦‚å¿µ"><a href="#ä¸€ã€é‡è¦æ¦‚å¿µ" class="headerlink" title="ä¸€ã€é‡è¦æ¦‚å¿µ"></a>ä¸€ã€é‡è¦æ¦‚å¿µ</h2><ul><li>å‘½åç©ºé—´ï¼ˆNamespacesï¼‰ï¼šé€šå¸¸åŒ…ååŠ ç±»ç›®ç»„æˆå®Œå…¨é™å®šåï¼ˆcom.MyMapper.selectAllï¼‰ï¼Œå®ç°è¯­å¥éš”ç¦»ç¡®å®šå”¯ä¸€æ€§ã€‚</li><li>ä½œç”¨åŸŸï¼ˆScopeï¼‰å’Œç”Ÿå‘½å‘¨æœŸ</li><li>SqlSessionFactoryBuilderï¼šå®Œæˆåˆ›å»ºSqlSessionFactoryåå°±ä¸å†éœ€è¦ã€‚</li><li>SqlSessionFactoryï¼šæœ€ä½³ä½œç”¨åŸŸæ˜¯åº”ç”¨ä½œç”¨åŸŸï¼Œæœ€ä¼˜è§£æ˜¯ä½¿ç”¨å•ä¾‹æ¨¡å¼æˆ–è€…é™æ€å•ä¾‹æ¨¡å¼ã€‚</li><li>SqlSessionï¼šæœ€ä½³çš„ä½œç”¨åŸŸæ˜¯è¯·æ±‚æˆ–æ–¹æ³•ä½œç”¨åŸŸ</li></ul><h1 id="2-2ã€åå°„å·¥å…·ç®±"><a href="#2-2ã€åå°„å·¥å…·ç®±" class="headerlink" title="2.2ã€åå°„å·¥å…·ç®±"></a>2.2ã€åå°„å·¥å…·ç®±</h1><blockquote><p>Mybatisè¿›è¡Œå‚æ•°å¤„ç†ã€ç»“æœæ˜ å°„ä¼šæ¶‰åŠåˆ°å¤§é‡çš„åå°„æ“ä½œã€‚Javaåå°„åŠŸèƒ½è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯ä»£ç å¤æ‚æ˜“é”™ï¼Œæ‰€ä»¥åœ¨mybaitsæºç åŒ…org.apache.ibatis.reflectionæœ‰ä¸“é—¨çš„åå°„æ¨¡å—ã€‚</p></blockquote><h3 id="2-2-1-Reflector-amp-ReflectorFactory"><a href="#2-2-1-Reflector-amp-ReflectorFactory" class="headerlink" title="2.2.1 Reflector&amp;ReflectorFactory"></a>2.2.1 Reflector&amp;ReflectorFactory</h3><blockquote><p>Reflectoræ˜¯åå°„æ¨¡å—çš„åŸºç¡€ç±»ï¼Œä¸€ä¸ªreflecotrå®ä¾‹å¯¹åº”ä¸€ä¸ªç±»çš„å…ƒä¿¡æ¯ã€‚æ ¹æ®Java Beanè§„èŒƒï¼Œå°è£…çš„å¯¹getterã€setterå±æ€§æ–¹æ³•æ˜ å°„ã€‚</p></blockquote><p><strong>Reflectoræˆå‘˜å­—æ®µ</strong>åˆ†æå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">import ....</span><br><span class="line">ï¼ˆçœç•¥å¯¼å…¥ç±»ï¼‰</span><br><span class="line">&#x2F;**</span><br><span class="line"> * This class represents a cached set of class definition information that</span><br><span class="line"> * allows for easy mapping between property names and getter&#x2F;setter methods.</span><br><span class="line"> *</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Reflector &#123;</span><br><span class="line">  &#x2F;&#x2F;å¯¹åº”çš„classç±»å‹</span><br><span class="line">  private final Class&lt;?&gt; type;</span><br><span class="line">  &#x2F;&#x2F;getteræ–¹æ³•å¯¹åº”çš„å±æ€§åç§°æ•°ç»„</span><br><span class="line">  private final String[] readablePropertyNames;</span><br><span class="line">  &#x2F;&#x2F;setteræ–¹æ³•å¯¹åº”çš„å±æ€§åç§°æ•°ç»„</span><br><span class="line">  private final String[] writablePropertyNames;</span><br><span class="line">&#x2F;&#x2F;å±æ€§å¯¹åº”çš„setteræ–¹æ³•é›†åˆï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯Invokerå¯¹è±¡</span><br><span class="line">  private final Map&lt;String, Invoker&gt; setMethods &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;å±æ€§å¯¹åº”çš„getteræ–¹æ³•é›†åˆï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯Invokerå¯¹è±¡</span><br><span class="line">  private final Map&lt;String, Invoker&gt; getMethods &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;è®°å½•äº†å±æ€§ç›¸åº”çš„setteræ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯setteræ–¹æ³•çš„å‚æ•°ç±»å‹</span><br><span class="line">  private final Map&lt;String, Class&lt;?&gt;&gt; setTypes &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;è®°å½•äº†å±æ€§ç›¸åº”çš„getteræ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯setteræ–¹æ³•çš„å‚æ•°ç±»å‹</span><br><span class="line">  private final Map&lt;String, Class&lt;?&gt;&gt; getTypes &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">  &#x2F;&#x2F;è®°å½•é»˜è®¤æ„é€ å™¨</span><br><span class="line">  private Constructor&lt;?&gt; defaultConstructor;</span><br><span class="line">  &#x2F;&#x2F;æ‰€æœ‰å±æ€§åç§°é›†åˆ</span><br><span class="line">  private Map&lt;String, String&gt; caseInsensitivePropertyMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote><p>ReflectorFactoryæ¥å£å®šä¹‰äº†Reflectorå¯¹è±¡åˆ›å»ºæˆ–è€…ç¼“å­˜</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">public interface ReflectorFactory &#123;</span><br><span class="line">&#x2F;&#x2F;ç¡®å®šæ˜¯å¦éœ€è¦ç¼“å­˜è¯¥Reflectorå¯¹è±¡</span><br><span class="line">  boolean isClassCacheEnabled();</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®æ˜¯å¦ç¼“å­˜è¯¥Reflectorå¯¹è±¡</span><br><span class="line">  void setClassCacheEnabled(boolean classCacheEnabled);</span><br><span class="line">&#x2F;&#x2F;åˆ˜å»ºæŒ‡å®šClasså¯¹åº”çš„Reflectorå¯¹è±¡</span><br><span class="line">  Reflector findForClass(Class&lt;?&gt; type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>DefaultReflectorFactoryé»˜è®¤å®ç°ReflectorFactoryï¼Œè€ŒCustomReflectorFactoryç»§æ‰¿DefaultReflectorFactoryå¹¶ä¸”ç©ºå®ç°ï¼Œå…¶å…³ç³»å›¾å¦‚ä¸‹</p></blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://mubu.com/document_image/b61624c1-2eaa-4e3f-9e21-904b98cce861-2286202.jpg" alt="DefaultReflectorFactory" title="">                </div>                <div class="image-caption">DefaultReflectorFactory</div>            </figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.ibatis.reflection;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line">import java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line">public class DefaultReflectorFactory implements ReflectorFactory &#123;</span><br><span class="line">  &#x2F;&#x2F;è¯¥å­—æ®µå†³å®šæ˜¯å¦å¼€å¯å¯¹Reflectorå¯¹è±¡</span><br><span class="line">  private boolean classCacheEnabled &#x3D; true;</span><br><span class="line">  &#x2F;&#x2F;ä½¿ç”¨ConcurrentMapé›†åˆå®ç°å¯¹Reflectorå¯¹è±¡çš„ç¼“å­˜</span><br><span class="line">  private final ConcurrentMap&lt;Class&lt;?&gt;, Reflector&gt; reflectorMap &#x3D; new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  public DefaultReflectorFactory() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public boolean isClassCacheEnabled() &#123;</span><br><span class="line">    return classCacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void setClassCacheEnabled(boolean classCacheEnabled) &#123;</span><br><span class="line">    this.classCacheEnabled &#x3D; classCacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Reflector findForClass(Class&lt;?&gt; type) &#123;</span><br><span class="line">    if (classCacheEnabled) &#123;&#x2F;&#x2F;æ£€æµ‹æ˜¯å¦å¼€å¯ç¼“å­˜</span><br><span class="line">      &#x2F;&#x2F; synchronized (type) removed see issue #461</span><br><span class="line">&#x2F;&#x2F;é€šè¿‡çº¿ç¨‹å®‰å…¨ConcurrentHashMapè·å–ç¼“å­˜Reflectorï¼Œæ²¡æœ‰åˆ™é€šè¿‡lambadaè°ƒç”¨æ„é€ æ–°å»ºå¯¹è±¡</span><br><span class="line">      return reflectorMap.computeIfAbsent(type, Reflector::new);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">&#x2F;&#x2F;æœªå¼€å¯ç¼“å­˜åˆ™ç›´æ¥new Reflectorå¯¹è±¡</span><br><span class="line">      return new Reflector(type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚&quot;&gt;&lt;a href=&quot;#ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚&quot;&gt;&lt;/a&gt;ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Mybatisä»¥SqlSessionFactoryä¸ºæ ¸å¿ƒï¼Œ
      
    
    </summary>
    
    
    
      <category term="Mybatis" scheme="https://caochikai.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>HttpServletRequestæµé‡å¤è¯»</title>
    <link href="https://caochikai.github.io/2019/12/18/HttpServletRequest%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB/"/>
    <id>https://caochikai.github.io/2019/12/18/HttpServletRequest%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB/</id>
    <published>2019-12-18T12:30:00.000Z</published>
    <updated>2019-12-19T13:46:05.626Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HttpServletRequestæµé‡å¤è¯»"><a href="#HttpServletRequestæµé‡å¤è¯»" class="headerlink" title="HttpServletRequestæµé‡å¤è¯»"></a>HttpServletRequestæµé‡å¤è¯»</h1><blockquote><p>springmvc controller @RequestBodyæ¥å—å‚æ•°æŠ¥é”™ï¼ŒåŸå› ä¸ºhttp POSTè¯·æ±‚æŠ¥æ–‡ä½“ä¸ºäºŒè¿›åˆ¶æµï¼Œåœ¨HttpServletRequest.getInputStream()ä¸­æµåªèƒ½è¢«è¯»å–ä¸€æ¬¡ï¼Œé‡å¤è¯»å–ä¼šæŠ¥å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getRead() has already been called for this request&#x2F;getInputStream() has already been called for this request</span><br></pre></td></tr></table></figure><h2 id="ä¸€ã€è§£å†³æ–¹å¼"><a href="#ä¸€ã€è§£å†³æ–¹å¼" class="headerlink" title="ä¸€ã€è§£å†³æ–¹å¼"></a>ä¸€ã€è§£å†³æ–¹å¼</h2><blockquote><p>ç¬¬ä¸€ç§æ–¹å¼ï¼šé‡å†™HttpServletRequestWrapper å°†InputStream æ›¿æ¢æˆå¯é‡å¤è¯»çš„ByteArrayInputStreamï¼ŒåŸç†å°±æ˜¯åœ¨Filteræˆ–è€…springmvcçš„interceptorä¸­é€šè¿‡æ„é€ å™¨åŒ…è£…HttpServletRequestï¼Œå¹¶ä¸”æŠŠå½“å‰æµç¼“å­˜èµ·æ¥ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ReadListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰HttpServletRequestWrapper</span></span><br><span class="line"><span class="comment"> * è§£å†³InputStreamä¸èƒ½é‡å¤è¯»é—®é¢˜</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line"></span><br><span class="line">    BufferedServletRequestWrapper(HttpServletRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        String sessionStream = getBodyString(request);</span><br><span class="line">        body = sessionStream.getBytes(Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–è¯·æ±‚Body</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getBodyString</span><span class="params">(<span class="keyword">final</span> ServletRequest request)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream = cloneInputStream(request.getInputStream());</span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">            String line = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    reader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤åˆ¶è¾“å…¥æµ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">cloneInputStream</span><span class="params">(ServletInputStream inputStream)</span> </span>&#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((len = inputStream.read(buffer)) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            byteArrayOutputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(body);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bais.read();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç¬¬äºŒç§æ–¹å¼ï¼šSpringmvcæä¾›äº†è§£å†³æ–¹æ¡ˆContentCachingRequestWrapperï¼Œæ€è·¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ä»£ç æ›´åŠ ä¸¥è°¨ç‚¹ã€‚æºç æˆ‘å°±ä¸è´´äº†ï¼Œå¼€å¤´æ³¨é‡Šè¯´æ˜è´´ä¸€ä¸‹ï¼Œç„¶åéœ€è¦æ³¨æ„äº‹é¡¹å’Œæ­£ç¡®çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *ContentCachingRequestWrapperæºç æ³¨é‡Šå¦‚ä¸‹</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> javax.servlet.http.HttpServletRequest&#125; wrapper that caches all content read from</span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@linkplain</span> #getInputStream() input stream&#125; and &#123;<span class="doctag">@linkplain</span> #getReader() reader&#125;,</span></span><br><span class="line"><span class="comment"> * and allows this content to be retrieved via a &#123;<span class="doctag">@link</span> #getContentAsByteArray() byte array&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Used e.g. by &#123;<span class="doctag">@link</span> org.springframework.web.filter.AbstractRequestLoggingFilter&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Brian Clozel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.1.3</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ContentCachingResponseWrapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.qm.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.ContentCachingRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é…ç½®å“ªäº›è¯·æ±‚å¯ä»¥è¿›è¡Œé‡å¤è¯»æ•°æ®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cachingRequestBodyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// é˜²æ­¢æµè¯»å–ä¸€æ¬¡åå°±æ²¡æœ‰äº†, æ‰€ä»¥éœ€è¦å°†æµç»§ç»­å†™å‡ºå»</span></span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) request;</span><br><span class="line">        String requestURI = httpServletRequest.getRequestURI();</span><br><span class="line">        <span class="comment">// è¿™é‡Œå°†åŸå§‹requestä¼ å…¥ï¼Œè¯»å‡ºæµå¹¶å­˜å‚¨</span></span><br><span class="line">        <span class="comment">//PATH ä¸ºå¯é‡å¤è¯»çš„è·¯å¾„å¼€å§‹æˆ–è€…æ¥å—éƒ¨åˆ† ä¾‹å¦‚ï¼šcaching.do</span></span><br><span class="line">        <span class="keyword">if</span> (requestURI.endsWith(<span class="string">"caching.do"</span>)) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œå°†åŸå§‹requestä¼ å…¥ï¼Œè¯»å‡ºæµå¹¶å­˜å‚¨</span></span><br><span class="line">            ContentCachingRequestWrapper requestWrapper = <span class="keyword">new</span> ContentCachingRequestWrapper(httpServletRequest);</span><br><span class="line">            <span class="comment">// è¿™é‡Œå°†åŸå§‹requestæ›¿æ¢ä¸ºåŒ…è£…åçš„requestï¼Œæ­¤åæ‰€æœ‰è¿›å…¥controllerçš„requestå‡ä¸ºåŒ…è£…åçš„request</span></span><br><span class="line">            chain.doFilter(requestWrapper, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//          ä¸è¦è¦†ç›–æ‰€æœ‰çš„è¯·æ±‚ï¼Œé˜²æ­¢è¦†ç›–å…¶ä»–äººè¯·æ±‚</span></span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äºŒã€å‚è€ƒå¦‚ä¸‹ï¼š"><a href="#äºŒã€å‚è€ƒå¦‚ä¸‹ï¼š" class="headerlink" title="äºŒã€å‚è€ƒå¦‚ä¸‹ï¼š"></a>äºŒã€å‚è€ƒå¦‚ä¸‹ï¼š</h2><p><a href="https://www.itmotui.com/2019/01/16/spring/web/HttpServletRequest%E6%95%B0%E6%8D%AE%E6%B5%81%E9%87%8D%E5%A4%8D%E8%AF%BB%E9%97%AE%E9%A2%98/index.html" target="_blank" rel="noopener">HttpServletRequestæ•°æ®æµé‡å¤è¯»é—®é¢˜</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;HttpServletRequestæµé‡å¤è¯»&quot;&gt;&lt;a href=&quot;#HttpServletRequestæµé‡å¤è¯»&quot; class=&quot;headerlink&quot; title=&quot;HttpServletRequestæµé‡å¤è¯»&quot;&gt;&lt;/a&gt;HttpServletRequestæµé‡
      
    
    </summary>
    
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>BigDecimalé‡‘é¢è®¡ç®—</title>
    <link href="https://caochikai.github.io/2019/12/17/BigDecimal%E9%87%91%E9%A2%9D%E8%AE%A1%E7%AE%97/"/>
    <id>https://caochikai.github.io/2019/12/17/BigDecimal%E9%87%91%E9%A2%9D%E8%AE%A1%E7%AE%97/</id>
    <published>2019-12-16T16:26:58.000Z</published>
    <updated>2019-12-17T15:30:40.899Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…³äºé‡‘é¢è®¡ç®—ï¼Œé€šå¸¸æœ‰åŠ å‡ä¹˜é™¤ï¼Œå››èˆäº”å…¥ç­‰ã€‚</p></blockquote><ol><li>add()åŠ æ³•å‡½æ•°ï¼šè¦æ³¨æ„BigDecimalåŠ æ³•å¾—åˆ°çš„ç»“æœä¸ºé›¶ï¼Œå› ä¸ºBigDecimalçš„åŠ æ³•éœ€è¦ä¸€ä¸ªå€¼å»æ¥æ”¶ï¼ŒåŠ æ³•ä¸ä¼šæ”¹å˜è°ƒç”¨è€…è‡ªèº«çš„å€¼ã€‚</li><li>subtract()å‡æ³•å‡½æ•°ï¼šåŒåŠ æ³•ï¼›</li><li>multiply()ä¹˜æ³•å‡½æ•°ï¼šæ³¨æ„Doubleè½¬BigDecimalï¼Œå°½é‡ç”¨å­—ç¬¦ä¸²çš„å½¢å¼åˆå§‹åŒ–ã€‚å› ä¸ºä½¿ç”¨BigDecimalç±»æ„é€ æ–¹æ³•ä¼ å…¥doubleç±»å‹æ—¶ï¼Œè®¡ç®—çš„ç»“æœæ˜¯ä¸ç²¾ç¡®çš„ï¼</li><li>divide()é™¤æ³•å‡½æ•°ï¼šé¿å…æŠ›å‡ºé™¤é›¶å¼‚å¸¸ï¼Œæ–¹å¼å°†é™¤è¿ç®—å°½é‡è½¬æ¢æˆç­‰ä»·çš„ä¹˜è¿ç®—ã€‚</li><li>ä¿ç•™ä¸¤ä½å°æ•°ä¸”å››èˆäº”å…¥ï¼švalue.setScale(2, BigDecimal.ROUND_HALF_UP);</li><li>BigDecimalé™æ€å¸¸é‡å€¼ï¼Œæ¯”å¦‚BigDecimal.ZEROç­‰ï¼›</li></ol><h2 id="ä¾‹å­åˆ¨æï¼š"><a href="#ä¾‹å­åˆ¨æï¼š" class="headerlink" title="ä¾‹å­åˆ¨æï¼š"></a>ä¾‹å­åˆ¨æï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal num1 = <span class="keyword">new</span> BigDecimal(<span class="number">0.005</span>);</span><br><span class="line">     BigDecimal num2 = <span class="keyword">new</span> BigDecimal(<span class="number">1000000</span>);</span><br><span class="line">     BigDecimal num3 = <span class="keyword">new</span> BigDecimal(-<span class="number">1000000</span>);</span><br><span class="line">     <span class="comment">//å°½é‡ç”¨å­—ç¬¦ä¸²çš„å½¢å¼åˆå§‹åŒ–</span></span><br><span class="line">     BigDecimal num12 = <span class="keyword">new</span> BigDecimal(<span class="string">"0.005"</span>);</span><br><span class="line">     BigDecimal num22 = <span class="keyword">new</span> BigDecimal(<span class="string">"1000000"</span>);</span><br><span class="line">     BigDecimal num32 = <span class="keyword">new</span> BigDecimal(<span class="string">"-1000000"</span>);</span><br><span class="line"><span class="comment">//åŠ æ³•</span></span><br><span class="line">     BigDecimal result1 = num1.add(num2);</span><br><span class="line">     BigDecimal result12 = num12.add(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//å‡æ³•</span></span><br><span class="line">     BigDecimal result2 = num1.subtract(num2);</span><br><span class="line">     BigDecimal result22 = num12.subtract(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//ä¹˜æ³•</span></span><br><span class="line">     BigDecimal result3 = num1.multiply(num2);</span><br><span class="line">     BigDecimal result32 = num12.multiply(num22);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//ç»å¯¹å€¼</span></span><br><span class="line">     BigDecimal result4 = num3.abs();</span><br><span class="line">     BigDecimal result42 = num32.abs();</span><br><span class="line"></span><br><span class="line">     <span class="comment">//é™¤æ³•</span></span><br><span class="line">     BigDecimal result5 = num2.divide(num1,<span class="number">20</span>,BigDecimal.ROUND_HALF_UP);</span><br><span class="line">     BigDecimal result52 = num22.divide(num12,<span class="number">20</span>,BigDecimal.ROUND_HALF_UP);</span><br></pre></td></tr></table></figure><h2 id="resultå…¨éƒ¨è¾“å‡ºç»“æœï¼Œåˆå§‹åŒ–å»ºè®®ä½¿ç”¨String"><a href="#resultå…¨éƒ¨è¾“å‡ºç»“æœï¼Œåˆå§‹åŒ–å»ºè®®ä½¿ç”¨String" class="headerlink" title="resultå…¨éƒ¨è¾“å‡ºç»“æœï¼Œåˆå§‹åŒ–å»ºè®®ä½¿ç”¨String"></a>resultå…¨éƒ¨è¾“å‡ºç»“æœï¼Œåˆå§‹åŒ–å»ºè®®ä½¿ç”¨String</h2><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F9ede2a28-4e0a-43fb-9e48-8a4c019d1adc%2FUntitled.png?table=block&id=426c6e13-75fc-475e-93a9-f5a320222905&width=1390&cache=v2" alt="ç»“æœ" title="">                </div>                <div class="image-caption">ç»“æœ</div>            </figure><h3 id="å‚è€ƒå¦‚ä¸‹"><a href="#å‚è€ƒå¦‚ä¸‹" class="headerlink" title="å‚è€ƒå¦‚ä¸‹"></a>å‚è€ƒå¦‚ä¸‹</h3><p><a href="https://blog.csdn.net/shadow_zed/article/details/73522157" target="_blank" rel="noopener">BigDecimalåŠ å‡ä¹˜é™¤è®¡ç®—</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;å…³äºé‡‘é¢è®¡ç®—ï¼Œé€šå¸¸æœ‰åŠ å‡ä¹˜é™¤ï¼Œå››èˆäº”å…¥ç­‰ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;add()åŠ æ³•å‡½æ•°ï¼šè¦æ³¨æ„BigDecimalåŠ æ³•å¾—åˆ°çš„ç»“æœä¸ºé›¶ï¼Œå› ä¸ºBigDecimalçš„åŠ æ³•éœ€è¦ä¸€ä¸ªå€¼å»æ¥æ”¶ï¼ŒåŠ æ³•ä¸ä¼šæ”¹å˜è°ƒç”¨è€…è‡ªèº«çš„å€¼ã€‚&lt;/li
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Springboot+vueéƒ¨ç½²è·¯ç”±404</title>
    <link href="https://caochikai.github.io/2019/12/15/hello-world/"/>
    <id>https://caochikai.github.io/2019/12/15/hello-world/</id>
    <published>2019-12-15T08:32:00.000Z</published>
    <updated>2019-12-15T10:10:20.253Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>vueå•é¡µé¢è·¯ç”±ï¼Œåˆ·æ–°åœ°å€æˆ–è€…è¯·æ±‚é“¾æ¥ï¼Œéƒ½ä¼š404</p><pre><code>user  www;worker_processes  auto;error_log  /var/log/nginx/error.log;pid /run/nginx.pid;events {    worker_connections  51200;    multi_accept on;}http {    include       mime.types;    default_type  application/octet-stream;    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;    access_log  /var/log/nginx/access.log  main;    sendfile        on;    tcp_nopush          on;    tcp_nodelay         on;    keepalive_timeout  65;    types_hash_max_size 2048;    #gzip  on;    gzip on;  server {        listen        80;        root        /www/app/;        server_name  gdhxy.cn;        try_files $uri $uri/ /index.html;    }    server {        listen        80;        root        /www/app/;        server_name  www.gdhxy.cn;        try_files $uri $uri/ /index.html;    }     server {        listen       80;        server_name  admin.gdhxy.cn;        try_files $uri $uri/ /index.html;        location / {                proxy_redirect off;                  proxy_pass http://127.0.0.1:38806;        }    }}</code></pre><h2 id="è§£å†³æ–¹å¼"><a href="#è§£å†³æ–¹å¼" class="headerlink" title="è§£å†³æ–¹å¼"></a>è§£å†³æ–¹å¼</h2><blockquote><p>1ã€nginxé…ç½®ï¼štry_files $uri $uri/ /index.htmlï¼›2ã€springbootæŒ‡å®š404åˆ°index.html.</p></blockquote><pre><code>import org.springframework.boot.web.servlet.error.ErrorController;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import javax.servlet.http.HttpServletRequest;@Controllerpublic class MyErrorController implements ErrorController {    @RequestMapping(&quot;/error&quot;)    public String handleError(HttpServletRequest request) {        //è·å–statusCode:404,é‡å®šå‘åˆ°é¦–é¡µ        Integer statusCode = (Integer) request.getAttribute(&quot;javax.servlet.error.status_code&quot;);        if (statusCode == 404) {            return &quot;/index.html&quot;;        } else {            return &quot;/500&quot;;        }    }    @Override    public String getErrorPath() {        return &quot;/error&quot;;    }}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;é—®é¢˜èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#é—®é¢˜èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜èƒŒæ™¯&quot;&gt;&lt;/a&gt;é—®é¢˜èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;vueå•é¡µé¢è·¯ç”±ï¼Œåˆ·æ–°åœ°å€æˆ–è€…è¯·æ±‚é“¾æ¥ï¼Œéƒ½ä¼š404&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;user  www;
worker_pro
      
    
    </summary>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://caochikai.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æœåŠ¡å™¨é…ç½®è®°å½•</title>
    <link href="https://caochikai.github.io/2019/09/28/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/"/>
    <id>https://caochikai.github.io/2019/09/28/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E8%AE%B0%E5%BD%95/</id>
    <published>2019-09-27T16:48:12.000Z</published>
    <updated>2019-09-27T16:49:50.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æœåŠ¡å™¨é…ç½®è®°å½•"><a href="#æœåŠ¡å™¨é…ç½®è®°å½•" class="headerlink" title="æœåŠ¡å™¨é…ç½®è®°å½•"></a>æœåŠ¡å™¨é…ç½®è®°å½•</h1><h2 id="ä¸€ã€èƒŒæ™¯"><a href="#ä¸€ã€èƒŒæ™¯" class="headerlink" title="ä¸€ã€èƒŒæ™¯"></a>ä¸€ã€èƒŒæ™¯</h2><blockquote><p>çœŸå®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼šnginxã€tomcaté…ç½®httpsè¯ä¹¦</p></blockquote><h2 id="äºŒã€nginx"><a href="#äºŒã€nginx" class="headerlink" title="äºŒã€nginx"></a>äºŒã€nginx</h2><h3 id="å®‰è£…è¿‡ç¨‹ï¼š"><a href="#å®‰è£…è¿‡ç¨‹ï¼š" class="headerlink" title="å®‰è£…è¿‡ç¨‹ï¼š"></a>å®‰è£…è¿‡ç¨‹ï¼š</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//ä¸€é”®å®‰è£…ä¸Šé¢å››ä¸ªä¾èµ–</span><br><span class="line">yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel</span><br><span class="line">//ä¸‹è½½taråŒ…</span><br><span class="line">wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">tar xzf nginx-1.16.1.tar.gz -C /usr/local</span><br><span class="line">//æ–‡ä»¶åæ”¹nginx-1.16.1æˆnginx</span><br><span class="line">//è¿›å…¥nginxç›®å½•</span><br><span class="line">cd /usr/local/nginx</span><br><span class="line">//å…³è”ç¼–è¯‘httpsæ¨¡å—</span><br><span class="line"> ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br><span class="line">//æ‰§è¡Œmakeå‘½ä»¤ç¼–è¯‘æºç </span><br><span class="line">make</span><br><span class="line">//æ‰§è¡Œmake installå®‰è£…å¯æ‰§è¡Œbin</span><br><span class="line">make install</span><br><span class="line">//æ–°å»ºlogsï¼ˆæ—¥å¿—ï¼‰å’Œsslï¼ˆè¯ä¹¦ï¼‰æ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure><h3 id="httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹"><a href="#httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹" class="headerlink" title="httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹"></a>httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹</h3><blockquote><p>è§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™ï¼Œæµè§ˆå™¨è®¤ä¸ºhttpsè¯·æ±‚ä¸­èµ„æºæ˜¯httpçš„cssã€jså’Œå›¾ç‰‡éƒ½æ— æ³•æ­£å¸¸åŠ è½½ï¼Œé€ æˆæ— æ³•åŒåè®®å…¼å®¹ï¼</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æµè§ˆå™¨è®¿é—®åå¼€å‘è€…æ¨¡å¼çœ‹åˆ°çš„æŠ¥é”™ä¿¡æ¯ï¼š</span><br><span class="line">Mixed Content: The page at &#39;https:&#x2F;&#x2F;dashboard.domain.com&#x2F;wire&#39; was loaded over HTTPS, but requested an insecure stylesheet &#39;http:&#x2F;&#x2F;dashboard.domain.com&#x2F;static&#x2F;css&#x2F;flickity.css&#39;. This request has been blocked; the content must be served over HTTPS.</span><br></pre></td></tr></table></figure><h3 id="nginxè§£å†³é…ç½®"><a href="#nginxè§£å†³é…ç½®" class="headerlink" title="nginxè§£å†³é…ç½®"></a>nginxè§£å†³é…ç½®</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">user  www;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  51200;</span><br><span class="line">    multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">gzip on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  chinaffxz.com;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        </span><br><span class="line">         ssl_certificate      /usr/local/nginx/ssl/2879444_chinagzhxy.com.pem;</span><br><span class="line">         ssl_certificate_key  /usr/local/nginx/ssl/2879444_chinagzhxy.com.key;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:xxxx/;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    #è§£å†³å…¼å®¹é…ç½®è¦ç‚¹</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Tomcaté…ç½®"><a href="#Tomcaté…ç½®" class="headerlink" title="Tomcaté…ç½®"></a>Tomcaté…ç½®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8006"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span> <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span> <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span> <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span> <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"38080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> <span class="attr">maxThreads</span>=<span class="string">"1000"</span> <span class="attr">minSpareThreads</span>=<span class="string">"20"</span> <span class="attr">acceptCount</span>=<span class="string">"1000"</span> <span class="attr">maxHttpHeaderSize</span>=<span class="string">"65536"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">disableUploadTimeout</span>=<span class="string">"true"</span> <span class="attr">useBodyEncodingForURI</span>=<span class="string">"true"</span> <span class="attr">enableLookups</span>=<span class="string">"false"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- è§£å†³å…¼å®¹è¦ç‚¹--&gt;</span>  </span><br><span class="line">         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.RemoteIpValve"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">remoteIpHeader</span>=<span class="string">"X-Forwarded-For"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">protocolHeader</span>=<span class="string">"X-Forwarded-Proto"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">protocolHeaderHttpsValue</span>=<span class="string">"https"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span> <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span> <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">             Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">             <span class="doctag">Note:</span> The pattern used is equivalent to using pattern="common" --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">""</span> <span class="attr">docBase</span> =<span class="string">"mall"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">crossContext</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="gitæŒç»­éƒ¨ç½²shellè„šæœ¬"><a href="#gitæŒç»­éƒ¨ç½²shellè„šæœ¬" class="headerlink" title="gitæŒç»­éƒ¨ç½²shellè„šæœ¬"></a>gitæŒç»­éƒ¨ç½²shellè„šæœ¬</h3><blockquote><p>è§£å†³Linux CentOSä¸­cp -f å¤åˆ¶å¼ºåˆ¶è¦†ç›–çš„å‘½ä»¤æ— æ•ˆçš„æ–¹æ³•ï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨cp -iä½¿ç”¨äº¤äº’æ–¹å¼é¿å…è¯¯æ“ä½œï¼Œä½†åœ¨è‡ªåŠ¨è„šæœ¬ä¸­åº”å½“é¿å…ï¼Œæ¨è<strong>\cp</strong>ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">update code</span></span><br><span class="line">cd /root/dowload/mall/duoshanghu</span><br><span class="line">git fetch origin </span><br><span class="line">git pull &gt; /root/dowload/mall/logs/mall_git.log &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash">package </span></span><br><span class="line">mvn package -Dmaven.test.skip=true</span><br><span class="line">sleep 2s</span><br><span class="line"><span class="meta">#</span><span class="bash">cp war to tomcat webapp</span></span><br><span class="line">\cp -fr /root/dowload/mall/duoshanghu/target/mall.war /usr/local/env/tomcat/webapps/mall.war</span><br><span class="line">sleep 1s</span><br><span class="line"><span class="meta">#</span><span class="bash">restart.sh</span></span><br><span class="line">sh /usr/local/env/tomcat/bin/restart.sh</span><br></pre></td></tr></table></figure><h3 id="tomcaté‡å¯è„šæœ¬"><a href="#tomcaté‡å¯è„šæœ¬" class="headerlink" title="tomcaté‡å¯è„šæœ¬"></a>tomcaté‡å¯è„šæœ¬</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">åˆå§‹åŒ–å…¨å±€ç¯å¢ƒå˜é‡</span></span><br><span class="line">. /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">set</span> java environment</span></span><br><span class="line">export CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">æŸ¥æ‰¾tomcatçš„pid</span></span><br><span class="line">pid=`ps aux | grep tomcat | grep -v grep | grep -v Restart | grep -v restart | awk '&#123;print $2&#125;'`</span><br><span class="line">echo "the tomcat pid is $pid"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">åˆ¤æ–­tomcatè¿›ç¨‹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">if [ -n "$pid" ];then</span><br><span class="line">   sleep 1</span><br><span class="line">   pid=`ps aux | grep tomcat | grep -v grep | grep -v restart | grep -v Restart | awk '&#123;print $2&#125;'`</span><br><span class="line">   if [ -n "$pid" ]; then</span><br><span class="line">      sleep 1</span><br><span class="line">      echo "tomcatè¿›ç¨‹å°†è¢«æ€?"</span><br><span class="line">      kill -9 $pid</span><br><span class="line">   fi</span><br><span class="line"></span><br><span class="line">   sleep 1</span><br><span class="line"></span><br><span class="line">   echo "tomcatè¿›ç¨‹å·²ç»è¢«æ€æ­»ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat."</span><br><span class="line">   service tomcat status</span><br><span class="line">   sleep 1s</span><br><span class="line">   service tomcat start</span><br><span class="line">else</span><br><span class="line">    echo "tomcatè¿›ç¨‹ä¸å­˜åœ¨ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat."</span><br><span class="line">    service tomcat status</span><br><span class="line">    sleep 1s</span><br><span class="line">    service tomcat start</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†"><a href="#mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†" class="headerlink" title="mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†"></a>mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†</h3><h4 id="1ã€æ¥æº"><a href="#1ã€æ¥æº" class="headerlink" title="1ã€æ¥æº"></a>1ã€æ¥æº</h4><blockquote><p>è§£å†³webapp/WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ…ï¼Œä¸”åœ¨linuxMavenç¼–è¯‘æŠ¥é”™[ERROR] Fatal Error: Unable to find package java.lang in classpath or bootclasspathï¼Œè‡´å‘½é”™è¯¯: åœ¨ç±»è·¯å¾„æˆ–å¼•å¯¼ç±»è·¯å¾„ä¸­æ‰¾ä¸åˆ°ç¨‹åºåŒ… java.lang</p></blockquote><h4 id="2ã€è§£å†³æ–¹æ³•"><a href="#2ã€è§£å†³æ–¹æ³•" class="headerlink" title="2ã€è§£å†³æ–¹æ³•"></a>2ã€è§£å†³æ–¹æ³•</h4><p>Linuxè§£å†³åŠæ³•ï¼Œä½¿ç”¨mavenè‡ªå¸¦çš„å˜é‡${path.separator}è·¯å¾„åˆ†éš”ç¬¦ï¼ŒåŸå› æ˜¯åœ¨Windowsä¸‹æ˜¯åˆ†å·;ï¼Œåœ¨linuxä¸‹æ˜¯å†’å·:</p><p>åŒæ—¶é…ç½®å¯¼å…¥webapp/WEB-INF/libå’Œjdkçš„rt.jarã€jce.jarï¼Œå®Œç¾è§£å†³ç¯å¢ƒé…ç½®å¸¦æ¥çš„æ— æ³•packageæ‰¾ä¸åˆ°ä¾èµ–é—®é¢˜ã€‚</p><h4 id="pom-xmlï¼š"><a href="#pom-xmlï¼š" class="headerlink" title="pom.xmlï¼š"></a>pom.xmlï¼š</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">verbose</span> /&gt;</span>                    <span class="tag">&lt;<span class="name">bootclasspath</span>&gt;</span>$&#123;java.home&#125;/lib/rt.jar$&#123;path.separator&#125;$&#123;java.home&#125;/lib/jce.jar<span class="tag">&lt;/<span class="name">bootclasspath</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">extdirs</span>&gt;</span>$&#123;basedir&#125;/src/main/webapp/WEB-INF/lib<span class="tag">&lt;/<span class="name">extdirs</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">compilerArguments</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://spex.top/archives/nginx-tomcat-http-https.html" target="_blank" rel="noopener">è§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™</a></p><p><a href="https://blog.csdn.net/u012204058/article/details/54974053" target="_blank" rel="noopener">è§£å†³WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ…</a></p><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>å½“äº†ç»„é•¿é¢è¯•åŠ è¿ç»´ï¼Œå¯¹æ¥ä¸€å †æ”¯ä»˜å’Œç‰©æµã€çŸ­ä¿¡å’Œæ¨é€è´¦å·ï¼Œä»Šå¤©è®°å½•ä¸€ä¸‹é¢å‘DevOpsï¼</li><li>markdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a>ï¼Œæœ‰é—®é¢˜å‘é‚®ä»¶ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;æœåŠ¡å™¨é…ç½®è®°å½•&quot;&gt;&lt;a href=&quot;#æœåŠ¡å™¨é…ç½®è®°å½•&quot; class=&quot;headerlink&quot; title=&quot;æœåŠ¡å™¨é…ç½®è®°å½•&quot;&gt;&lt;/a&gt;æœåŠ¡å™¨é…ç½®è®°å½•&lt;/h1&gt;&lt;h2 id=&quot;ä¸€ã€èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#ä¸€ã€èƒŒæ™¯&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
    
    
      <category term="Linux" scheme="https://caochikai.github.io/tags/Linux/"/>
    
      <category term="nginx" scheme="https://caochikai.github.io/tags/nginx/"/>
    
      <category term="tomcat" scheme="https://caochikai.github.io/tags/tomcat/"/>
    
      <category term="maven" scheme="https://caochikai.github.io/tags/maven/"/>
    
  </entry>
  
  <entry>
    <title>JVMè®°å½•</title>
    <link href="https://caochikai.github.io/2019/09/14/JVM%E8%AE%B0%E5%BD%95/"/>
    <id>https://caochikai.github.io/2019/09/14/JVM%E8%AE%B0%E5%BD%95/</id>
    <published>2019-09-14T04:32:49.000Z</published>
    <updated>2019-09-14T04:34:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JVMè®°å½•"><a href="#JVMè®°å½•" class="headerlink" title="JVMè®°å½•"></a>JVMè®°å½•</h1><h2 id="ä¸€ã€é”™è¯¯"><a href="#ä¸€ã€é”™è¯¯" class="headerlink" title="ä¸€ã€é”™è¯¯"></a>ä¸€ã€é”™è¯¯</h2><ol><li>èƒŒæ™¯ï¼š<a href="https://github.com/caochikai/webmagicForPros" target="_blank" rel="noopener">è‡ªåŠ¨ç­”é¢˜çˆ¬è™«</a>ç”±äºä¹°çš„è…¾è®¯äº‘1æ ¸2G1Mï¼ŒJenkinsã€springbootçˆ¬è™«å’Œç«ç‹æµè§ˆå™¨é©±åŠ¨ã€‚</li><li>çŸ¥è¯†èƒŒæ™¯ï¼š<a href="https://www.jianshu.com/p/134bd5b913c5" target="_blank" rel="noopener">JDWP</a>ï¼šè°ƒè¯•ç½‘ç»œåè®®(Java Debug Wire Protocol)ï¼›è°ƒè¯•çº¿åè®®ï¼›<a href="https://juejin.im/post/5b0925ec51882538aa1ee248" target="_blank" rel="noopener">jvmti</a>ï¼šï¼ˆJava Virtual Machine Tool Interfaceï¼‰jvmä»£ç†ï¼›</li><li>çŒœæµ‹ï¼šSeleniumé€šè¿‡driveré©±åŠ¨Firefoxæµè§ˆå™¨ï¼Œå¤šæ¬¡æ— æ³•å…³é—­æµè§ˆå™¨é€ æˆå†…å­˜æ— æ³•é‡Šæ”¾æœ€åæº¢å‡ºï¼› </li><li>å¼•ç”¨æ–‡ç« ï¼ˆæœ‰å…´è¶£å¯æ·±å…¥äº†è§£ï¼‰ï¼š<a href="https://blog.csdn.net/duqi_2009/article/details/94518203" target="_blank" rel="noopener">jvmti agenté»‘ç§‘æŠ€</a>ï¼Œé˜¿é‡Œäº‘äº‘ç›‘æ§ï¼›</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR in native method: JDWP Can&#39;t allocate jvmti memory, jvmtiError&#x3D;JVMTI_ERROR_OUT_OF_MEMORY(110)</span><br></pre></td></tr></table></figure><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>ç«‹ä¸ªflagï¼šä¸å®šæœŸæ›´æ–°ï¼Œä¸€æ›´ä¸€å‘¨ã€‚</li><li>markdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a>ï¼Œæœ‰é—®é¢˜å‘é‚®ä»¶ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;JVMè®°å½•&quot;&gt;&lt;a href=&quot;#JVMè®°å½•&quot; class=&quot;headerlink&quot; title=&quot;JVMè®°å½•&quot;&gt;&lt;/a&gt;JVMè®°å½•&lt;/h1&gt;&lt;h2 id=&quot;ä¸€ã€é”™è¯¯&quot;&gt;&lt;a href=&quot;#ä¸€ã€é”™è¯¯&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€é”™è¯¯&quot;
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="JVM" scheme="https://caochikai.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶</title>
    <link href="https://caochikai.github.io/2019/05/22/%E5%B7%A5%E5%85%B7%E6%94%B6%E8%97%8F%E2%80%94%E2%80%94idea%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6/"/>
    <id>https://caochikai.github.io/2019/05/22/%E5%B7%A5%E5%85%B7%E6%94%B6%E8%97%8F%E2%80%94%E2%80%94idea%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6/</id>
    <published>2019-05-22T12:34:48.000Z</published>
    <updated>2019-05-22T13:25:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶"><a href="#å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶" class="headerlink" title="å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶"></a>å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶</h2><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><blockquote><p>â€‹    å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œåšä¸»æ˜¯ä¸ªæ­»å¿ å·¥å…·æ´¾ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªå¤§é—®é¢˜å¯èƒ½ä¼šæ”¶é›†å¤šä¸ªå·¥å…·å’Œæ–¹æ¡ˆï¼Œç„¶åæ±‚è¯å¯¹æ¯”å‡ºä½“éªŒæŠ¥å‘Šã€‚åç»­æ–‡ç« æœ‰ä¸€å¤§ç±»å°±æ˜¯å·¥å…·ç±»æ¨èï¼Œè€Œæœ¬ç¯‡æ–‡ç« é‡ç‚¹å°±æ˜¯idea å®‰è£…æ’ä»¶è®°å½•ï¼Œç®€è¦è®°å½•å®‰è£…æ–¹æ³•å¿«é€Ÿæ­å»ºä¸ªæ€§åŒ–ideaï¼Œè¿˜æœ‰ä¸€äº›å…³äºUIæ–¹é¢æ’ä»¶å¯è°“å¤šä¸èƒœæ•°ï¼Œè€Œä¸”æ¯ä¸ªäººå£å‘³ä¸ä¸€ï¼Œè¯·å„ä½è‡ªè¡Œé€‰æ‹©â€”â€”æ’ä»¶æœç´¢æŠ€å·§tagsä¸º<a href="https://plugins.jetbrains.com/search?correctionAllowed=true&pr=&orderBy=relevance&&tags=Theme" target="_blank" rel="noopener">Themeæˆ–è€…UI</a>ã€‚</p></blockquote><hr><h2 id="æ’ä»¶åˆ—è¡¨"><a href="#æ’ä»¶åˆ—è¡¨" class="headerlink" title="æ’ä»¶åˆ—è¡¨"></a>æ’ä»¶åˆ—è¡¨</h2><h4 id="æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼"><a href="#æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼" class="headerlink" title="æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼"></a>æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”<strong>lambdaè¡¨è¾¾å¼</strong></h4><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>JRebel</strong></td><td>ä»£æ›¿springboot devçƒ­éƒ¨ç½²æ–¹æ¡ˆï¼Œ<a href="https://blog.csdn.net/qq_40110871/article/details/83420125" target="_blank" rel="noopener">æœ€æ–¹ä¾¿æ¿€æ´»æ–¹å¼</a></td></tr><tr><td>Lombok</td><td>ç²¾ç®€beanï¼Œå„ç§åŠŸèƒ½å¼ºå¤§åˆå®ç”¨æ³¨è§£ï¼Œæ¬ç –äººçš„MVPï¼Œç»“åˆ<a href="https://www.hutool.club/docs/#/" target="_blank" rel="noopener">Hutool</a>å®åœ¨å®Œç¾</td></tr><tr><td>AceJump</td><td>å…‰æ ‡è·³è·ƒï¼Œæ›¿ä»£vimä¸äºŒä¹‹é€‰</td></tr><tr><td>MavenHelper</td><td>å¿«é€Ÿåˆ†æmaven åŒ…å†²çªçš„é—®é¢˜ï¼Œæœç´¢åŒ…å</td></tr><tr><td>MyBatis Log Plugin</td><td>Restore the mybatis generate sql to original whole sql.ï¼ˆæ‹¼æ¥å®Œæ•´sqlï¼‰</td></tr><tr><td>Log Support 2</td><td>å¿«é€Ÿlog.info()ï¼Œç»“åˆLombokæ’ä»¶æ³¨è§£@Slf4jå¯ä»¥è¯´æ— æ•Œ</td></tr><tr><td>Free Mybatis plugin</td><td>Mybaitsæ”¯æŒè·³è½¬ï¼Œæœ‰é’±å¤§çˆ·è¯·æ”¶è´¹ç‰ˆMybatis pluginå¼ºå¤§ç ´è§£è¾ƒå°‘ï¼Œ<a href="https://plugins.jetbrains.com/plugin/7293-mybatis-plugin/reviews" target="_blank" rel="noopener"><strong>å·®è¯„</strong></a></td></tr><tr><td>Rainbow Brackets</td><td>å½©è™¹æ‹¬å·ï¼Œå¤šå±‚åµŒå¥—ä»£ç æ˜¾ç¤ºåŠ©æ‰‹</td></tr><tr><td>String Manipulation</td><td>å„ç§å„æ ·å­—ç¬¦ä¸²æ ¼å¼è½¬åŒ–</td></tr><tr><td>RestfulToolkit</td><td>ä¸€å¥— RESTful æœåŠ¡å¼€å‘è¾…åŠ©å·¥å…·é›†</td></tr><tr><td>Alibaba Cloud Toolkit</td><td>ç»“åˆé˜¿é‡Œäº‘ï¼ˆéé˜¿é‡Œä¹Ÿæ”¯æŒï¼‰ï¼Œå¤šèŠ‚ç‚¹å‘å¸ƒå·¥å…·åŠ å¼ºåŠ›linuxå®¢æˆ·ç«¯</td></tr><tr><td>stackoverflow</td><td>stackoverflowå¿«é€Ÿæœç´¢bugæ’ä»¶</td></tr><tr><td>Translation</td><td>æœ€å¼ºå¤§çš„ç¿»è¯‘æ’ä»¶ï¼Œæ”¯æŒä¸­æ–‡æ›¿æ¢è‹±æ–‡ï¼Œè§£å†³èµ·è‹±æ–‡å˜é‡åéš¾çš„é‡åº¦æ‚£è€…</td></tr><tr><td>Key Promoter X</td><td>æ‰€æœ‰æ“ä½œçš„å¿«æ·é”®æç¤ºï¼Œå¿˜è®°é¼ æ ‡çœŸçš„</td></tr><tr><td><strong>Cyan Light Theme</strong></td><td>A light themeï¼Œåé’è‰²å¯¹çœ¼ç›å¾ˆæŸ”å’Œèˆ’æœï¼Œé»‘æš—ä¸»é¢˜å®åœ¨ä¸é€‚åº”</td></tr></tbody></table><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>2012å¹´javaç¨‹åºå‘˜å¯ä»¥è¯´éå¸¸åƒé¦™ï¼Œä»Šå¹´2019ä»ä¸šäººæ•°æš´å¢ï¼ŒèŒä¸šå‘å±•æŒ‘æˆ˜å˜å¾—è¶Šæ¥è¶Šå¤§ï¼ç°åœ¨æµè¡Œè‡ªåŠ¨æ„å»ºå’Œè‡ªåŠ¨éƒ¨ç½²CIï¼Œå¼€å‘è¿ç»´ä¸€ä½“åŒ–dockerï¼Œæ•´ä¸ªäº’è”ç½‘éƒ½åœ¨è¿½æ±‚æ•æ·å¼€å‘çš„ä»Šå¤©ã€‚æŒæ¡ä¸€æ¬¾è¿½æ±‚æ•ˆç‡åŠŸèƒ½çš„IDEéå¸¸é‡è¦ï¼Œå¾ˆå¤šç¾¤å’Œå…¬ä¼—å·å¯¹ideå’ŒEclipseäº‰è®®å¾ˆå¤§ã€‚ä½†è¯·è®°ä½æ–¯å¤§æ—åè¨€â€”â€”è½åå°±è¦æŒ¨æ‰“ï¼Œideæœ¬èº«ä»£è¡¨é«˜æ•ˆï¼Œä½†æ˜¯æ’ä»¶ä¹Ÿåˆ«è£…å¤ªå¤šï¼Œå…å¾—å¯åŠ¨è¿˜è¦åŠå¤©å“ˆå“ˆå“ˆğŸ˜€</li><li>ï¼ˆé¦–æ¨ï¼‰æ…•è¯¾ç½‘å…è´¹æ•™ç¨‹ï¼š<a href="http://www.imooc.com/learn/924" target="_blank" rel="noopener">IntelliJ IDEAç¥å™¨ä½¿ç”¨æŠ€å·§</a></li><li>ï¼ˆæ¨èï¼‰å°šç¡…è°·IDEAè§†é¢‘æ•™ç¨‹ï¼šé“¾æ¥ï¼š<a href="https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn" target="_blank" rel="noopener">https://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn</a></li><li>çœ‹å®Œä¸Šé¢ä¸¤ä¸ªæ•™ç¨‹ï¼Œä½ ä¼šæ€€ç–‘è‡ªå·±ç”¨çš„ideaæ˜¯å‡çš„ï¼ŒåŸæ¥å†™ä»£ç è¿˜å¯ä»¥è¿™æ ·çš„ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶&quot;&gt;&lt;a href=&quot;#å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶&quot; class=&quot;headerlink&quot; title=&quot;å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶&quot;&gt;&lt;/a&gt;å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶&lt;/h2&gt;&lt;h2 id=&quot;ä¸€ã€æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#ä¸€
      
    
    </summary>
    
    
    
      <category term="tool" scheme="https://caochikai.github.io/tags/tool/"/>
    
      <category term="plugin" scheme="https://caochikai.github.io/tags/plugin/"/>
    
      <category term="idea" scheme="https://caochikai.github.io/tags/idea/"/>
    
  </entry>
  
  <entry>
    <title>springbootæ•´åˆelasticsearch</title>
    <link href="https://caochikai.github.io/2019/05/21/springboot%E6%95%B4%E5%90%88elasticsearch/"/>
    <id>https://caochikai.github.io/2019/05/21/springboot%E6%95%B4%E5%90%88elasticsearch/</id>
    <published>2019-05-21T13:40:31.000Z</published>
    <updated>2019-05-22T12:40:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="springbootæ•´åˆelasticsearch"><a href="#springbootæ•´åˆelasticsearch" class="headerlink" title="springbootæ•´åˆelasticsearch"></a>springbootæ•´åˆelasticsearch</h2><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><blockquote><p><a href="https://www.elastic.co/cn/" target="_blank" rel="noopener">elasticsearchå®˜ç½‘</a>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å¤šç”¨æˆ·èƒ½åŠ›çš„å…¨æ–‡æœç´¢å¼•æ“ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå…·æœ‰RESTful webæ¥å£çš„javaåº”ç”¨ã€‚ç›®å‰å¼€æºè½¯ä»¶å•†ä¸šæ¯”è¾ƒä¸é”™çš„ä¾‹å­ï¼Œä¸Solrä¸€æ ·éƒ½æ˜¯åŸºäºLuceneï¼Œå¤§æ•°æ®hadoopä¹Ÿæ˜¯è„±èƒäºLuceneã€‚Solrå¼€æºè€Œä¸”ç”Ÿæ€æ¯”è¾ƒæˆç†Ÿï¼Œelasticsearchç›®å‰æœ€ç«ä¹Ÿæ˜¯å•†ä¸šåº”ç”¨æ–¹é¢éå¸¸å¥½çš„æœç´¢å¼•æ“ã€‚</p></blockquote><h3 id="3wåŸåˆ™ï¼š"><a href="#3wåŸåˆ™ï¼š" class="headerlink" title="3wåŸåˆ™ï¼š"></a>3wåŸåˆ™ï¼š</h3><ol><li>question whatï¼šå¸¸è§ç«™å†…/appå†…æœç´¢æœåŠ¡éœ€æ±‚ï¼šå•†å“æ–‡ç« çš„æ¨¡ç³Šæœç´¢ï¼Œç²¾ç¡®æœç´¢ï¼Œæ‹¼éŸ³æœç´¢ ã€‚</li><li>question whyï¼šå€ŸåŠ©elasticsearchå’Œanalysis-ikä¸­æ–‡åˆ†è¯å™¨ï¼Œå¿«é€Ÿå®ç°æœç´¢æœåŠ¡åŠŸèƒ½ã€‚</li><li>howï¼šåœ¨å¾®æœåŠ¡å½“ä¸­ï¼Œé€šå¸¸åˆ©ç”¨mqæ¶ˆæ¯ä¸­é—´ä»¶æ¥åŒæ­¥æ•°æ®é›†ç¾¤æœç´¢æœåŠ¡ï¼ˆè„šæ‰‹æ¶é‡Œæ²¡æœ‰mqï¼‰ï¼Œå€ŸåŠ©ElasticsearchTemplateï¼ˆspring æ¨¡æ¿å·¥å…·ç±»å¼ºå¤§ï¼‰APIç»´æŠ¤ç´¢å¼•å’Œæœç´¢æŸ¥è¯¢ã€‚</li></ol><h2 id="äºŒã€è½åœ°å®ç°"><a href="#äºŒã€è½åœ°å®ç°" class="headerlink" title="äºŒã€è½åœ°å®ç°"></a>äºŒã€è½åœ°å®ç°</h2><blockquote><p>æ ¹æ®<a href="https://gitee.com/11230595/springboot-elasticsearch" target="_blank" rel="noopener">ç äº‘ä¼ä¸šçº§æœç´¢è„šæ‰‹æ¶</a>çš„æ–‡æ¡£å¯çŸ¥ï¼Œæ³¨æ„ç‰ˆæœ¬ä¸ºSpringboot2.1.1+elasticsearch6.5.3ï¼Œelasticsearchå’Œanalysis-ikæ’ä»¶ç‰ˆæœ¬å¿…é¡»ç»Ÿä¸€ï¼Œè€Œä¸”æ–°ç‰ˆæœ¬elasticsearch 7ä¸é€‚ç”¨äºè¯¥å·¥ç¨‹ã€‚è¿™ä¸ªå‚è€ƒå·¥ç¨‹çš„ä¸­æ–‡åˆ†è¯æœç´¢æ•ˆæœä¸å¤ªç†æƒ³ï¼Œä¸€èˆ¬å¯Œæ–‡æœ¬çš„å†…å®¹è¿›å…¥ç´¢å¼•ä¹‹å‰è¦åˆ©ç”¨å­—ç¬¦è¿‡æ»¤å™¨æ¸…æ´—ä¸æ­£å¸¸çš„å­—ç¬¦ã€‚é€šå¸¸ä¸ºäº†ä¿è¯ç´¢å¼•æ—¶è¦†ç›–åº¦å’Œæœç´¢æ—¶å‡†ç¡®åº¦,ç´¢å¼•åˆ†è¯å™¨é‡‡ç”¨ik_max_word,æœç´¢åˆ†æå™¨é‡‡ç”¨ik_smartæ¨¡å¼ã€‚å…·ä½“elasticsearch6.5.3çš„å®‰è£…è¿‡ç¨‹è¯·å‚è€ƒç äº‘çš„README.mdï¼Œç›®å‰æ­£åœ¨åœ¨å…¬å¸é¡¹ç›®ä½¿ç”¨è¯·æ”¾å¿ƒï¼Œå•å…ƒæµ‹è¯•çš„æ•ˆæœä¹Ÿéå¸¸niceã€‚</p></blockquote><h4 id="1ã€æ·»åŠ ä¾èµ–"><a href="#1ã€æ·»åŠ ä¾èµ–" class="headerlink" title="1ã€æ·»åŠ ä¾èµ–"></a>1ã€æ·»åŠ ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2ã€é…ç½®å¼•å¯¼ç±»"><a href="#2ã€é…ç½®å¼•å¯¼ç±»" class="headerlink" title="2ã€é…ç½®å¼•å¯¼ç±»"></a>2ã€é…ç½®å¼•å¯¼ç±»</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#============================</span></span><br><span class="line"><span class="comment"># é»˜è®¤çš„èŠ‚ç‚¹åç§°elasticsearch</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-name</span>=<span class="string">my-application</span></span><br><span class="line"><span class="comment"># elasticsearch è°ƒç”¨åœ°å€ï¼Œå¤šä¸ªä½¿ç”¨â€œ,â€éš”å¼€</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-nodes</span>=<span class="string">localhost:9300</span></span><br></pre></td></tr></table></figure><h4 id="3ã€DWMQSenderåŒ…è£…rabbitTemplateå‘é€æ¶ˆæ¯åŒæ­¥æ•°æ®"><a href="#3ã€DWMQSenderåŒ…è£…rabbitTemplateå‘é€æ¶ˆæ¯åŒæ­¥æ•°æ®" class="headerlink" title="3ã€DWMQSenderåŒ…è£…rabbitTemplateå‘é€æ¶ˆæ¯åŒæ­¥æ•°æ®"></a>3ã€DWMQSenderåŒ…è£…rabbitTemplateå‘é€æ¶ˆæ¯åŒæ­¥æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœåŠ¡ç±»çš„ç®€å†™å¦‚ä¸‹</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//æ³¨å…¥sender    </span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">DWMQSender sender;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘é€å†™æ³•ArticlesMessage extends DWMQMessage&lt;æ¶ˆæ¯å†…å®¹ç±»å‹&gt;</span></span><br><span class="line">JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(articles));</span><br><span class="line"> jsonObject.put(Groups.ACTION, Groups.ADD);</span><br><span class="line"> sender.sendMessage(<span class="keyword">new</span> ArticlesMessage(jsonObject));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å°è£…å‘é€mq message</span></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.exception.EU;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.mq.mto.DWMQMessage;</span><br><span class="line"><span class="keyword">import</span> com.dwalk.common.utils.SU;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.AmqpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.support.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯æˆåŠŸå‘é€åˆ°MQæœåŠ¡å™¨åçš„å›è°ƒç¡®è®¤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DWMQSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DWMQRetry retry;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(DWMQMessage mto)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( mto.getObj()==<span class="keyword">null</span> ) &#123;</span><br><span class="line">            EU.te(<span class="string">"æ¶ˆæ¯å†…å®¹ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( SU.isNull( mto.getRoutingKey()) ) &#123;</span><br><span class="line">            EU.te(<span class="string">"è·¯ç”±è§„åˆ™ä¸ºç©º"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(String.format(<span class="string">"å‡†å¤‡å‘é€ã€%sã€‘"</span>, mto.getInfo()));</span><br><span class="line"></span><br><span class="line">        mto.setId(retry.generateId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( SU.isNull(mto.getExchange()) &amp;&amp; mto.getExpire()&lt;<span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">//é»˜è®¤çš„æ²¡æœ‰äº¤æ¢å™¨ï¼Œåˆ™ç›´æ¥å‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mto.getExpire()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//ç»è¿‡äº¤æ¢å™¨ï¼ŒæŒ‰è·¯ç”±è§„åˆ™åŒ¹é…é˜Ÿåˆ—</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getExchange(), mto.getRoutingKey(), mto.getObj(), <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//é»˜è®¤çš„æ²¡æœ‰äº¤æ¢å™¨ï¼Œåˆ™ç›´æ¥å‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯</span></span><br><span class="line">            rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), message -&gt; &#123;</span><br><span class="line">                message.getMessageProperties().setExpiration(mto.getExpire()+<span class="string">""</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;, <span class="keyword">new</span> CorrelationData(mto.getId()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mto.setCtime(System.currentTimeMillis());</span><br><span class="line">        retry.add(mto, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4ã€RabbitListeneræ¥æ”¶åˆ°æ¶ˆæ¯åŒæ­¥æ•°æ®"><a href="#4ã€RabbitListeneræ¥æ”¶åˆ°æ¶ˆæ¯åŒæ­¥æ•°æ®" class="headerlink" title="4ã€RabbitListeneræ¥æ”¶åˆ°æ¶ˆæ¯åŒæ­¥æ•°æ®"></a>4ã€RabbitListeneræ¥æ”¶åˆ°æ¶ˆæ¯åŒæ­¥æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœç´¢æœåŠ¡æ¥æ”¶åˆ°ç®¡ç†åå°ç”¨æˆ·ä¿®æ”¹æ–‡ç« åŒæ­¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="comment">//é…ç½®mqæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥æ”¶æ–‡ä»¶åŒæ­¥æ¶ˆæ¯</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = DirectMQConfig.DIRECT_ARTICLES_ELASTIC_QUEUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticlesReceiver</span> <span class="keyword">extends</span> <span class="title">DWMQBaseReceiver</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleETOService etoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">getClazz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processMessage</span><span class="params">(String mto)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Received ç®¡ç†åå°ç”¨æˆ·-ä¿®æ”¹æ–‡ç« åŒæ­¥æ¶ˆæ¯æ¥æ”¶:&#123;&#125;"</span>, mto);</span><br><span class="line">        JSONObject jsonObject = JSON.parseObject(mto);</span><br><span class="line">        String action = jsonObject.getString(Groups.ACTION);</span><br><span class="line">        <span class="comment">//åˆ é™¤æ“ä½œè¦åˆ é™¤ç´¢å¼•ï¼Œæ›´æ–°æ“ä½œå…ˆåˆ é™¤å</span></span><br><span class="line">        ArticleETO articles = JSON.parseObject(jsonObject.toJSONString(), ArticleETO<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String articlesId = articles.getId();</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> Groups.ADD:</span><br><span class="line">                etoService.save(articles);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Groups.UPDATE:</span><br><span class="line">                etoService.delete(articlesId);</span><br><span class="line">                etoService.save(articles);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Groups.DELETE:</span><br><span class="line">                etoService.delete(articlesId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5ã€å…¬å…±æœç´¢æ–¹æ³•"><a href="#5ã€å…¬å…±æœç´¢æ–¹æ³•" class="headerlink" title="5ã€å…¬å…±æœç´¢æ–¹æ³•"></a>5ã€å…¬å…±æœç´¢æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é«˜äº®æ˜¾ç¤ºï¼Œè¿”å›åˆ†é¡µ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@auther</span>: zhoudong</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span>: 2018/12/18 10:29</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IPage&lt;Map&lt;String, Object&gt;&gt; queryHitByPage(<span class="keyword">int</span> pageNo, <span class="keyword">int</span> pageSize, String keyword, String indexName, String... fieldNames) &#123;</span><br><span class="line">        <span class="comment">// æ„é€ æŸ¥è¯¢æ¡ä»¶,ä½¿ç”¨æ ‡å‡†åˆ†è¯å™¨.</span></span><br><span class="line">        QueryBuilder matchQuery = createQueryBuilder(keyword, fieldNames);</span><br><span class="line">        <span class="comment">// è®¾ç½®é«˜äº®,ä½¿ç”¨é»˜è®¤çš„highlighteré«˜äº®å™¨</span></span><br><span class="line">        HighlightBuilder highlightBuilder = createHighlightBuilder(fieldNames);</span><br><span class="line">        <span class="comment">// è®¾ç½®æŸ¥è¯¢å­—æ®µ</span></span><br><span class="line">        SearchResponse response = elasticsearchTemplate.getClient().prepareSearch(indexName)</span><br><span class="line">                .setQuery(bool)</span><br><span class="line">                .highlighter(highlightBuilder)</span><br><span class="line">                .setFrom((pageNo - <span class="number">1</span>) * pageSize)</span><br><span class="line">                .setSize(pageNo * pageSize) <span class="comment">// è®¾ç½®ä¸€æ¬¡è¿”å›çš„æ–‡æ¡£æ•°é‡ï¼Œæœ€å¤§å€¼ï¼š10000</span></span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å›æœç´¢ç»“æœ</span></span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line"></span><br><span class="line">        Long totalCount = hits.getTotalHits();</span><br><span class="line">        IPage&lt;Map&lt;String, Object&gt;&gt; page = <span class="keyword">new</span> Page&lt;&gt;(pageNo, pageSize, totalCount);</span><br><span class="line">        page.setRecords(getHitList(hits));</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>ä»Šå¤©ç»ˆäºå‡ºäº†elasticsearchæ–‡ç« ï¼Œä»¥åæˆ‘ä¼šåœ¨å¯¹åº”ä¸“é¢˜çš„æ–‡ç« æ”¾å‡ºç›¸å…³çš„ç™¾åº¦äº‘èµ„æºï¼Œè¿™äº›éƒ½æ˜¯ç½‘ä¸Šæµä¼ æ¯”è¾ƒå¹¿çš„èµ„æºï¼Œæƒ³æ‰¾å¥½çš„å­¦ä¹ èµ„æºä¹Ÿå¯ä»¥ä¸æˆ‘åˆä¼™ä¹°ç»ç‰ˆè§†é¢‘ï¼Œæœ‰é’±ä¹°æ­£ç‰ˆå§ï¼ˆä½œè€…å¾ˆç©·ï¼Œæ‰¾å·¥ä½œä»æ¥æ²¡æœ‰é€ å‡åŒ…è£…ï¼Œåªèƒ½æ··æˆè¿™ä¸ªåµæ ·ğŸ˜­ï¼Œä¸–é“ç»´è‰°ï¼Œå¦‚æœä¸æ˜¯æ„Ÿè§‰åšç å†œè¿˜ç®—æœ‰ç‚¹å¤©èµ‹ï¼Œæ—©å°±è½¬è¡Œäº†ï¼‰ã€‚</li><li>ç™¾åº¦äº‘ :<a href="https://pan.baidu.com/s/1d2adCgJMuwt6UmAxEMRYxA#list/path=%2F" target="_blank" rel="noopener">ä¸‹è½½è¡—/01.Elasticsearché¡¶å°–é«˜æ‰‹ç³»åˆ—è¯¾ç¨‹</a>ï¼Œå¯†ç ï¼šiw7f</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;springbootæ•´åˆelasticsearch&quot;&gt;&lt;a href=&quot;#springbootæ•´åˆelasticsearch&quot; class=&quot;headerlink&quot; title=&quot;springbootæ•´åˆelasticsearch&quot;&gt;&lt;/a&gt;springbootæ•´
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="elasticsearch" scheme="https://caochikai.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Springbootæ•´åˆQuartzå®šæ—¶å™¨</title>
    <link href="https://caochikai.github.io/2019/05/20/Spring%20boot%E6%95%B4%E5%90%88Quartz%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
    <id>https://caochikai.github.io/2019/05/20/Spring%20boot%E6%95%B4%E5%90%88Quartz%E5%AE%9A%E6%97%B6%E5%99%A8/</id>
    <published>2019-05-20T12:25:37.000Z</published>
    <updated>2019-05-21T13:26:20.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-bootæ•´åˆQuartzå®šæ—¶å™¨"><a href="#Spring-bootæ•´åˆQuartzå®šæ—¶å™¨" class="headerlink" title="Spring bootæ•´åˆQuartzå®šæ—¶å™¨"></a>Spring bootæ•´åˆQuartzå®šæ—¶å™¨</h1><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><blockquote><p><a href="http://www.quartz-scheduler.org" target="_blank" rel="noopener">quartzå®˜ç½‘</a>æ˜¯ä¸€ä¸ªå®Œå…¨ç”± Java ç¼–å†™çš„å¼€æºä½œä¸šè°ƒåº¦æ¡†æ¶ï¼Œç»“åˆæ•°æ®åº“ç”šè‡³å¯ä»¥åšåˆ°åˆ†å¸ƒå¼è°ƒåº¦ã€‚ç›®å‰å‚è€ƒçš„<a href="https://gitee.com/y_project/RuoYi" target="_blank" rel="noopener">RuoYiåå°è„šæ‰‹æ¶</a>çš„å®šæ—¶ä»»åŠ¡æ¨¡å—ï¼Œæ”¯æŒåœ¨çº¿ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤)ä»»åŠ¡è°ƒåº¦ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¥å¿—ä½œä¸šç»“æœã€‚</p></blockquote><h3 id="3wåŸåˆ™ï¼š"><a href="#3wåŸåˆ™ï¼š" class="headerlink" title="3wåŸåˆ™ï¼š"></a>3wåŸåˆ™ï¼š</h3><ol><li>question whatï¼šå®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚å®šæ—¶ç­”é¢˜ã€å•†å®¶ç»“ç®—ç­‰éœ€æ±‚ï¼Œå¹¶ä¸”æ”¯æŒç«‹å³è¿è¡Œã€æš‚åœå’Œç¦æ­¢ã€‚</li><li>question whyï¼šå€ŸåŠ©quartz springbootç”Ÿæ€å’Œåå°è„šæ‰‹æ¶ï¼Œå¿«é€Ÿå®ç°å®šæ—¶è°ƒåº¦åŠŸèƒ½ã€‚</li><li>howï¼šå®ç°<strong>JobDetail</strong>è¿è¡Œä»»åŠ¡è¯¦æƒ…ï¼Œ<strong>Trigger</strong> è§¦å‘å™¨å®šä¹‰è§¦å‘è§„åˆ™ï¼Œ<strong>Scheduler</strong> è°ƒåº¦ä¸­å¿ƒ/å®¹å™¨æ³¨å†Œå¤šä¸ª JobDetail å’Œ Triggerã€‚Trigger ä¸ JobDetail ç»„åˆå³å¯è¢«Schedulerè°ƒç”¨ã€‚</li></ol><h2 id="äºŒã€è½åœ°å®ç°"><a href="#äºŒã€è½åœ°å®ç°" class="headerlink" title="äºŒã€è½åœ°å®ç°"></a>äºŒã€è½åœ°å®ç°</h2><blockquote><p>æ ¹æ®<a href="http://doc.ruoyi.vip/#/standard/htsc?id=å®šæ—¶ä»»åŠ¡" target="_blank" rel="noopener">è‹¥ä¾è„šæ‰‹æ¶</a>çš„æ–‡æ¡£å¯çŸ¥ï¼Œå®šæ—¶ä»»åŠ¡å·¥ç¨‹æ¨¡å—ä¸ºruoyi-quartzï¼Œç»“åˆsql/quartz.sqlå¯¼å…¥å…³äºå®šæ—¶å™¨æ•°æ®åº“è¡¨ã€‚å½“ç„¶è¿™ç§åšæ³•éœ€è¦æ•°æ®åº“å’Œbootstrapï¼Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘é‡‡å–çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ä¿ç•™å®šæ—¶å’Œç«‹å³æ‰§è¡ŒåŠŸèƒ½ï¼ŒæŠ›å¼ƒæ‰‹åŠ¨åœ¨ä»£ç ç¡¬ç¼–ç æ–°åŠ å®šæ—¶å™¨ï¼Œwebç®¡ç†é¢æ¿åˆ™é€šè¿‡swaggerè§¦å‘ä»»åŠ¡è°ƒåº¦ç«‹å³æ‰§è¡Œä¸€æ¬¡ã€‚æç«¯å·æ‡’æ–¹å¼ï¼Œ@Scheduled(cron = â€œâ€)æ”¾åœ¨åœ¨cotrolleræ–¹æ³•ï¼ŒåŒäº‹æ¨èç»™æˆ‘çš„ğŸ˜€ã€‚</p></blockquote><h4 id="1ã€æ·»åŠ ä¾èµ–"><a href="#1ã€æ·»åŠ ä¾èµ–" class="headerlink" title="1ã€æ·»åŠ ä¾èµ–"></a>1ã€æ·»åŠ ä¾èµ–</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h4 id="2ã€é…ç½®å¼•å¯¼ç±»"><a href="#2ã€é…ç½®å¼•å¯¼ç±»" class="headerlink" title="2ã€é…ç½®å¼•å¯¼ç±»"></a>2ã€é…ç½®å¼•å¯¼ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¨¡å—åŠ è½½</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinApplication</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3ã€æ³¨å†ŒJobDetailå’ŒTrigger"><a href="#3ã€æ³¨å†ŒJobDetailå’ŒTrigger" class="headerlink" title="3ã€æ³¨å†ŒJobDetailå’ŒTrigger"></a>3ã€æ³¨å†ŒJobDetailå’ŒTrigger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨çº¿è¡¨è¾¾å¼ï¼šhttp://cron.qqe2.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TASK_CLASS_NAME = <span class="string">"reportNowTask"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">reportNowTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(reportNowTask<span class="class">.<span class="keyword">class</span>).<span class="title">withIdentity</span>(<span class="title">TASK_CLASS_NAME</span>).<span class="title">storeDurably</span>().<span class="title">build</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">reportNowTaskTrigger</span><span class="params">(JobDetail reportNowTask)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//cronScheduleç­‰äº@Scheduled(cron = ""),ä½†æ˜¯é€šè¿‡æ³¨è§£æ— æ³•é…ç½®jobkey</span></span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(reportNowTask)</span><br><span class="line">                .withIdentity(<span class="string">"reportNowTaskTrigger"</span>)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"9 0 19 * * ?"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4ã€ä»»åŠ¡è¯¦æƒ…ç»§æ‰¿QuartzJobBeanæˆ–è€…å®ç°Jobæ¥å£"><a href="#4ã€ä»»åŠ¡è¯¦æƒ…ç»§æ‰¿QuartzJobBeanæˆ–è€…å®ç°Jobæ¥å£" class="headerlink" title="4ã€ä»»åŠ¡è¯¦æƒ…ç»§æ‰¿QuartzJobBeanæˆ–è€…å®ç°Jobæ¥å£"></a>4ã€ä»»åŠ¡è¯¦æƒ…ç»§æ‰¿QuartzJobBeanæˆ–è€…å®ç°Jobæ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">reportNowTask</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        ......<span class="comment">//ä»»åŠ¡å†…å®¹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5ã€ç«‹å³æ‰§è¡Œ"><a href="#5ã€ç«‹å³æ‰§è¡Œ" class="headerlink" title="5ã€ç«‹å³æ‰§è¡Œ"></a>5ã€ç«‹å³æ‰§è¡Œ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"é—®é¢˜æ¨¡å—"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"question"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuestionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»»åŠ¡è°ƒåº¦ç«‹å³æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/run"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">        <span class="comment">//apiç§˜è¯€å°±åœ¨è¿™é‡Œæ ¹æ®QuartzConfig jobKeyè§¦å‘ä½œä¸šè°ƒåº¦</span></span><br><span class="line">        scheduler.triggerJob(JobKey.jobKey(QuartzConfig.TASK_CLASS_NAME));</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"æ‰§è¡ŒæˆåŠŸï¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>ä»Šå¤©ç²—ç•¥ç®€æ˜“ç‰ˆçš„å®šæ—¶ä»»åŠ¡,åŠŸèƒ½å¼ºå¤§çš„è¯·æŸ¥çœ‹è‹¥ä¾åå°è„šæ‰‹æ¶,githubå’Œç äº‘æœ‰å¾ˆå¤šç±»ä¼¼è„šæ‰‹æ¶,ä½†æ˜¯æˆ‘ä»¬æœ‰é€‰æ‹©æ€§copyå­¦ä¹ æ‰æ˜¯é‡ç‚¹ğŸ˜Šã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Spring-bootæ•´åˆQuartzå®šæ—¶å™¨&quot;&gt;&lt;a href=&quot;#Spring-bootæ•´åˆQuartzå®šæ—¶å™¨&quot; class=&quot;headerlink&quot; title=&quot;Spring bootæ•´åˆQuartzå®šæ—¶å™¨&quot;&gt;&lt;/a&gt;Spring bootæ•´åˆQuartzå®š
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="quartz" scheme="https://caochikai.github.io/tags/quartz/"/>
    
  </entry>
  
  <entry>
    <title>springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹</title>
    <link href="https://caochikai.github.io/2019/05/19/springboot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>https://caochikai.github.io/2019/05/19/springboot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</id>
    <published>2019-05-19T13:50:35.000Z</published>
    <updated>2019-05-20T13:23:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹"><a href="#springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹"></a>springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹</h1><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><blockquote><p>è®¡åˆ’å†™ä¸€æ³¢springboot 2.xæºç åˆ†æï¼Œåªå†™å®ç”¨æ€§æ¯”è¾ƒé«˜çš„ç‰¹æ€§ï¼Œä»<a href="https://github.com/spring-projects/spring-boot/tags?after=v1.0.0.RC3" target="_blank" rel="noopener">GitHub</a>ä¸Šçœ‹å‡ºæ›´æ–°é¢‘ç‡åœ¨ä¸€ä¸ªæœˆå·¦å³ï¼Œæ›´æ–°æå¿«éå¸¸æ´»è·ƒã€‚</p></blockquote><h4 id="ç‰ˆæœ¬å‘è¡Œ"><a href="#ç‰ˆæœ¬å‘è¡Œ" class="headerlink" title="ç‰ˆæœ¬å‘è¡Œ:"></a>ç‰ˆæœ¬å‘è¡Œ:</h4><table><thead><tr><th>ç‰ˆæœ¬</th><th>æ—¶é—´çº¿</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>v0.5.0.M1</td><td>2013-08-06</td><td>ç¬¬ä¸€ä¸ªç‰ˆæœ¬</td></tr><tr><td>v2.2.0.M3</td><td>2019-05-15</td><td>å½“å‰æœ€æ–°ç‰ˆæœ¬</td></tr></tbody></table><h2 id="äºŒã€æºç åˆ†æ"><a href="#äºŒã€æºç åˆ†æ" class="headerlink" title="äºŒã€æºç åˆ†æ"></a>äºŒã€æºç åˆ†æ</h2><blockquote><p>SpringBootçš„å¯åŠ¨å¼•å¯¼ç±»å†™æ³•å¤šæ ·ï¼Œæ ‡è®°äº†@SpringBootApplicationçš„classä½œä¸ºæºç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç®€æ˜“ç‰ˆ</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">             SpringApplication.run(MyApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡ SpringApplicationBuilder API</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiveInSpringBootApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> SpringApplicationBuilder(DiveInSpringBootApplication<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">bannerMode</span>(<span class="title">Banner</span>.<span class="title">Mode</span>.<span class="title">CONSOLE</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">web</span>(<span class="title">WebApplicationType</span>.<span class="title">NONE</span>)</span></span><br><span class="line">                .profiles("prod")</span><br><span class="line">                .headless(<span class="keyword">true</span>)</span><br><span class="line">                .run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜new</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationBootstrap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        SpringApplication.run(ApplicationConfiguration.class,args);</span></span><br><span class="line"></span><br><span class="line">        Set sources = <span class="keyword">new</span> HashSet();</span><br><span class="line">        <span class="comment">// é…ç½®Class åç§°</span></span><br><span class="line">        sources.add(ApplicationConfiguration<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        SpringApplication springApplication = <span class="keyword">new</span> SpringApplication();</span><br><span class="line">        <span class="comment">//é…ç½®æº</span></span><br><span class="line">        springApplication.setSources(sources);</span><br><span class="line">        <span class="comment">//é…ç½®æ§åˆ¶å°banner</span></span><br><span class="line">        springApplication.setBannerMode(Banner.Mode.CONSOLE);</span><br><span class="line">        <span class="comment">//å£°æ˜webç±»å‹</span></span><br><span class="line">        springApplication.setWebApplicationType(WebApplicationType.NONE);</span><br><span class="line">        <span class="comment">//å¤šç¯å¢ƒé…ç½®æ¿€æ´»</span></span><br><span class="line">        springApplication.setAdditionalProfiles(<span class="string">"prod"</span>);</span><br><span class="line">        <span class="comment">//java.awt.headlessç¦ç”¨æ¨¡å¼</span></span><br><span class="line">        springApplication.setHeadless(<span class="keyword">true</span>);</span><br><span class="line">        springApplication.run(args);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpringBootApplication</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»ä»£ç ä¸Šå¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨äº†SpringApplicationçš„é™æ€æ–¹æ³•runã€‚è¿™ä¸ªrunæ–¹æ³•ä¼šæ„é€ ä¸€ä¸ªSpringApplicationçš„å®ä¾‹ï¼Œç„¶åå†è°ƒç”¨è¿™é‡Œå®ä¾‹çš„runæ–¹æ³•å°±è¡¨ç¤ºå¯åŠ¨SpringBootã€‚å› æ­¤ï¼Œæƒ³è¦åˆ†æSpringBootçš„å¯åŠ¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰SpringApplicationçš„æ„é€ è¿‡ç¨‹ä»¥åŠSpringApplicationçš„runæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å³å¯ã€‚</p></blockquote><h3 id="SpringApplicationçš„å‡†å¤‡è¿‡ç¨‹"><a href="#SpringApplicationçš„å‡†å¤‡è¿‡ç¨‹" class="headerlink" title="SpringApplicationçš„å‡†å¤‡è¿‡ç¨‹"></a>SpringApplicationçš„å‡†å¤‡è¿‡ç¨‹</h3><ul><li><p>é…ç½® Spring Boot Bean æºï¼šJava é…ç½® Class æˆ– XML ä¸Šä¸‹æ–‡é…ç½®æ–‡ä»¶é›†åˆï¼Œç”¨äº Spring Boot BeanDefinitionLoader è¯»å– ï¼Œå¹¶ä¸”å°†é…ç½®æºè§£æåŠ è½½ä¸ºSpring Bean å®šä¹‰ã€‚</p></li><li><p>æ¨æ–­ Web åº”ç”¨ç±»å‹ï¼šæ ¹æ®å½“å‰åº”ç”¨ ClassPath ä¸­æ˜¯å¦å­˜åœ¨ç›¸å…³å®ç°ç±»æ¥æ¨æ–­ Web åº”ç”¨çš„ç±»å‹ã€‚å‚è€ƒæ–¹æ³•ï¼šorg.springframework.boot.SpringApplication#deduceWebApplicationTypeã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> WebApplicationType <span class="title">deduceWebApplicationType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, <span class="keyword">null</span>)</span><br><span class="line">    &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, <span class="keyword">null</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String className : WEB_ENVIRONMENT_CLASSES) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¨æ–­å¼•å¯¼ç±»ï¼ˆMain Classï¼‰ï¼šæ ¹æ® Main çº¿ç¨‹æ‰§è¡Œå †æ ˆåˆ¤æ–­å®é™…çš„å¼•å¯¼ç±»ã€‚å‚è€ƒæ–¹æ³•ï¼š org.springframework.boot.SpringApplication#deduceMainApplicationClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Class <span class="title">deduceMainApplicationClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//è·å–å †æ ˆè¾“å‡ºæ–¹æ³•åç§°</span></span><br><span class="line">            StackTraceElement[] stackTrace = <span class="keyword">new</span> RuntimeException().getStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement stackTraceElement : stackTrace) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"main"</span>.equals(stackTraceElement.getMethodName())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Class.forName(stackTraceElement.getClassName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="comment">// Swallow and continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>åŠ è½½åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹å™¨ ï¼ˆ ApplicationContextInitializer ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œå®ä¾‹åŒ– ApplicationContextInitializer å®ç°ç±»ï¼Œå¹¶æ’åºå¯¹è±¡é›†åˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®ç°ç±»ï¼š org.springframework.core.io.support.SpringFactoriesLoader</span></span><br><span class="line"><span class="comment">//é…ç½®èµ„æºï¼š META-INF/spring.factories</span></span><br><span class="line"><span class="comment">//æ’åºï¼š AnnotationAwareOrderComparator#sort</span></span><br><span class="line"><span class="function"><span class="keyword">private</span>  Collection <span class="title">getSpringFactoriesInstances</span><span class="params">(Class type,</span></span></span><br><span class="line"><span class="function"><span class="params">            Class[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">        Set names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(</span><br><span class="line">                SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">        List instances = createSpringFactoriesInstances(type, parameterTypes,</span><br><span class="line">                classLoader, args, names);</span><br><span class="line">        AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">        <span class="keyword">return</span> instances;</span><br><span class="line">    &#125;Â·</span><br></pre></td></tr></table></figure></li><li><p>åŠ è½½åº”ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆ ApplicationListener ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œå®ä¾‹åŒ– ApplicationListener å®ç°ç±»ï¼Œå¹¶æ’åºå¯¹è±¡é›†åˆã€‚</p></li></ul><h3 id="SpringApplication-è¿è¡Œé˜¶æ®µ"><a href="#SpringApplication-è¿è¡Œé˜¶æ®µ" class="headerlink" title="SpringApplication è¿è¡Œé˜¶æ®µ"></a>SpringApplication è¿è¡Œé˜¶æ®µ</h3><ul><li><p>åŠ è½½ SpringApplication è¿è¡Œç›‘å¬å™¨ï¼ˆ SpringApplicationRunListeners ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œè¯»å– SpringApplicationRunListener å¯¹è±¡é›†åˆï¼Œå¹¶ä¸”å°è£…åˆ°ç»„åˆç±»SpringApplicationRunListenersã€‚</p></li><li><p>è¿è¡Œ SpringApplication è¿è¡Œç›‘å¬å™¨ï¼ˆ SpringApplicationRunListeners ï¼‰ï¼š</p><ol><li>started(runæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ç«‹é©¬æ‰§è¡Œï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationStartedEvent)</li><li>environmentPrepared(ApplicationContextåˆ›å»ºä¹‹å‰å¹¶ä¸”ç¯å¢ƒä¿¡æ¯å‡†å¤‡å¥½çš„æ—¶å€™è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationEnvironmentPreparedEvent)</li><li>contextPrepared(ApplicationContextåˆ›å»ºå¥½å¹¶ä¸”åœ¨sourceåŠ è½½ä¹‹å‰è°ƒç”¨ä¸€æ¬¡ï¼›æ²¡æœ‰å…·ä½“çš„å¯¹åº”äº‹ä»¶)</li><li>contextLoaded(ApplicationContextåˆ›å»ºå¹¶åŠ è½½ä¹‹åå¹¶åœ¨refreshä¹‹å‰è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationPreparedEvent)</li><li>finished(runæ–¹æ³•ç»“æŸä¹‹å‰è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationReadyEventæˆ–ApplicationFailedEvent)</li></ol></li><li><p>åˆ›å»º Spring åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆ ConfigurableApplicationContext ï¼‰:æ ¹æ®å‡†å¤‡é˜¶æ®µçš„æ¨æ–­ Web åº”ç”¨ç±»å‹åˆ›å»ºå¯¹åº”ConfigurableApplicationContext å®ä¾‹ï¼š</p><ul><li>Web Reactiveï¼š AnnotationConfigReactiveWebServerApplicationContext</li><li>Web Servletï¼š AnnotationConfigServletWebServerApplicationContext</li><li>é Webï¼š AnnotationConfigApplicationContext</li></ul></li><li><p>åˆ›å»º Environmentï¼šæ ¹æ®å‡†å¤‡é˜¶æ®µçš„æ¨æ–­ Web åº”ç”¨ç±»å‹åˆ›å»ºå¯¹åº”çš„ ConfigurableEnvironment å®ä¾‹ã€‚</p><ul><li>Web Reactiveï¼š StandardEnvironment</li><li>Web Servletï¼š StandardServletEnvironment</li><li>é Webï¼š StandardEnvironment</li></ul></li></ul><h3 id="runæ–¹æ³•åˆ†æ"><a href="#runæ–¹æ³•åˆ†æ" class="headerlink" title="runæ–¹æ³•åˆ†æ"></a>runæ–¹æ³•åˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  StopWatch stopWatch = <span class="keyword">new</span> StopWatch(); <span class="comment">// æ„é€ ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œè§‚å¯Ÿå™¨</span></span><br><span class="line">  stopWatch.start(); <span class="comment">// å¼€å§‹æ‰§è¡Œï¼Œè®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">  ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">  configureHeadlessProperty();</span><br><span class="line">  <span class="comment">// è·å–SpringApplicationRunListenersï¼Œå†…éƒ¨åªæœ‰ä¸€ä¸ªEventPublishingRunListener</span></span><br><span class="line">  SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">  <span class="comment">// ä¸Šé¢åˆ†æè¿‡ï¼Œä¼šå°è£…æˆSpringApplicationEventäº‹ä»¶ç„¶åå¹¿æ’­å‡ºå»ç»™SpringApplicationä¸­çš„listenersæ‰€ç›‘å¬</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œæ¥å—ApplicationStartedEventäº‹ä»¶çš„listenerä¼šæ‰§è¡Œç›¸åº”çš„æ“ä½œ</span></span><br><span class="line">  listeners.started();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ„é€ ä¸€ä¸ªåº”ç”¨ç¨‹åºå‚æ•°æŒæœ‰ç±»</span></span><br><span class="line">    ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">        args);</span><br><span class="line">    <span class="comment">// åˆ›å»ºSpringå®¹å™¨</span></span><br><span class="line">    context = createAndRefreshContext(listeners, applicationArguments);</span><br><span class="line">    <span class="comment">// å®¹å™¨åˆ›å»ºå®Œæˆä¹‹åæ‰§è¡Œé¢å¤–ä¸€äº›æ“ä½œ</span></span><br><span class="line">    afterRefresh(context, applicationArguments);</span><br><span class="line">    <span class="comment">// å¹¿æ’­å‡ºApplicationReadyEventäº‹ä»¶ç»™ç›¸åº”çš„ç›‘å¬å™¨æ‰§è¡Œ</span></span><br><span class="line">    listeners.finished(context, <span class="keyword">null</span>);</span><br><span class="line">    stopWatch.stop(); <span class="comment">// æ‰§è¡Œç»“æŸï¼Œè®°å½•æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">      <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">          .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context; <span class="comment">// è¿”å›Springå®¹å™¨</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    handleRunFailure(context, listeners, ex); <span class="comment">// è¿™ä¸ªè¿‡ç¨‹æŠ¥é”™çš„è¯ä¼šæ‰§è¡Œä¸€äº›å¼‚å¸¸æ“ä½œã€ç„¶åå¹¿æ’­å‡ºApplicationFailedEventäº‹ä»¶ç»™ç›¸åº”çš„ç›‘å¬å™¨æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h2><ul><li>ä¸ºäº†å¿«å¤§å¤šåˆ†æçš„ä¸å¥½å†™çš„å¾ˆä¹±ï¼Œå‡‘åˆçœ‹ä¸‹æˆ‘ä»¥åæ”¹ä¸‹æ’ç‰ˆğŸ˜‚ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;/a&gt;springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹&lt;/h1&gt;&lt;h2 i
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
      <category term="quartz" scheme="https://caochikai.github.io/tags/quartz/"/>
    
  </entry>
  
  <entry>
    <title>åœ°ç†å®šä½ä¸šåŠ¡å®ç°</title>
    <link href="https://caochikai.github.io/2019/05/18/%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0/"/>
    <id>https://caochikai.github.io/2019/05/18/%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0/</id>
    <published>2019-05-18T12:19:01.000Z</published>
    <updated>2019-05-18T13:44:42.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åœ°ç†å®šä½ä¸šåŠ¡å®ç°"><a href="#åœ°ç†å®šä½ä¸šåŠ¡å®ç°" class="headerlink" title="åœ°ç†å®šä½ä¸šåŠ¡å®ç°"></a>åœ°ç†å®šä½ä¸šåŠ¡å®ç°</h1><h2 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h2><h4 id="3wåŸåˆ™ï¼š"><a href="#3wåŸåˆ™ï¼š" class="headerlink" title="3wåŸåˆ™ï¼š"></a>3wåŸåˆ™ï¼š</h4><ol><li><p>question whatï¼šaã€é™„è¿‘ä¸€å®šèŒƒå›´çš„ç›®æ ‡ï¼ˆç”µå­å›´æ ï¼‰ï¼›bã€è¯¥ç»çº¬åº¦çš„åœ°ç†ä½ç½®åç§°ï¼ˆçœå¸‚å¿è¡—é“ï¼‰ã€‚</p></li><li><p>whyï¼šè§£å†³ä¸Šè¿°é—®é¢˜çš„æœ¬è´¨æ˜¯è·å¾—ç»çº¬åº¦ï¼Œé€”å¾„ä¸ºç¡¬ä»¶ã€<strong>GPSå®šä½æœåŠ¡</strong>ã€åŸºç«™å®šä½ï¼Œåœ°ç†ä½ç½®é€šè¿‡ç™¾åº¦ã€è°·æ­Œã€è…¾è®¯åœ°å›¾ï¼ŒåŸºæœ¬æ‰€æœ‰åœ°å›¾å…è´¹ç‰ˆéƒ½æœ‰æ—¥è®¿é—®é‡é™åˆ¶ã€‚</p></li><li><p>howï¼šé€šè¿‡å®‰å“æˆ–è€…IOSè·å–ç»çº¬åº¦ï¼Œå†å€ŸåŠ©ç™¾åº¦åœ°å›¾æ¥å£è·å–åœ°ç†ä½ç½®ï¼Œè·ç¦»ä¹Ÿå¯é€šè¿‡æ¥å£æˆ–è€…è°·æ­Œåœ°å›¾ç®—æ³•ã€‚</p></li></ol><blockquote><p>GPSæ˜¯è‹±æ–‡Global Positioning Systemï¼ˆå…¨çƒå®šä½ç³»ç»Ÿï¼‰çš„ç®€ç§°ã€‚</p></blockquote><h2 id="äºŒã€è§£å†³æ–¹å¼"><a href="#äºŒã€è§£å†³æ–¹å¼" class="headerlink" title="äºŒã€è§£å†³æ–¹å¼"></a>äºŒã€è§£å†³æ–¹å¼</h2><ol><li><p>åœºæ™¯ï¼šå°ç¨‹åºè·å–é™„è¿‘çš„å¥½å‹ï¼Œ<a href="https://developers.weixin.qq.com/miniprogram/dev/api/wx.getLocation.html" target="_blank" rel="noopener">å¾®ä¿¡å®˜æ–¹æ–‡æ¡£</a> wx.getLocation(Object object)ã€‚</p></li><li><p>ç°è±¡ï¼šéœ€è¦ç”¨æˆ·æˆæƒï¼Œå‰ç«¯è·å¾—gps åæ ‡é€šè¿‡æ¥å£ä¼ æ•°æ®åå°ï¼Œä¿å­˜åˆ°ç”¨æˆ·è¡¨ï¼ˆ1ï¼š1å…³ç³»ï¼‰ã€‚</p></li><li><p>åœ°å›¾é€‰æ‹©ï¼šå…¶å®çº¯å‰ç«¯åŸºæœ¬ä¹Ÿèƒ½è§£å†³åŸºæœ¬é—®é¢˜ï¼Œè…¾è®¯åœ°å›¾å¯¹å°ç¨‹åºæ”¯æŒæœ€å¥½ï¼Œæ ¹æ®<a href="https://lbs.qq.com/qqmap_wx_jssdk/method-reverseGeocoder.html" target="_blank" rel="noopener">JavaScript SDKæ–‡æ¡£</a>å¯ä»¥æ‹¥æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼šç»˜åˆ¶åœ°å›¾ï¼Œåœ°ç‚¹æœç´¢ï¼Œå…³é”®è¯è¾“å…¥æç¤ºï¼Œé€†åœ°å€è§£æï¼ˆåæ ‡ä½ç½®æè¿°ï¼‰ï¼Œåœ°å€è§£æï¼ˆåœ°å€è½¬åæ ‡ï¼Œè·¯çº¿è§„åˆ’ï¼Œè·ç¦»è®¡ç®—ï¼Œè·å–åŸå¸‚åˆ—è¡¨ï¼Œè·å–åŸå¸‚åŒºå¿ã€‚</p></li><li><p>ä¸šåŠ¡å‰æï¼šç”¨æˆ·å¿…é¡»æˆæƒæ‰èƒ½ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œå½“æ‹¥æœ‰æ‰€æœ‰ç”¨æˆ·ç»çº¬åº¦ï¼Œé€šè¿‡æ•°æ®åº“è¯­å¥è·å–å½“å‰ç”¨æˆ·ç»çº¬åº¦åœ¨ä¸€å®šè·ç¦»ï¼Œå¹¶ä¸”å¯ä»¥æ’è¡Œã€‚</p></li></ol><h3 id="ä¸‰ã€è½åœ°ç¼–ç "><a href="#ä¸‰ã€è½åœ°ç¼–ç " class="headerlink" title="ä¸‰ã€è½åœ°ç¼–ç "></a>ä¸‰ã€è½åœ°ç¼–ç </h3><h4 id="sqlç‰ˆä¾‹å­ï¼š"><a href="#sqlç‰ˆä¾‹å­ï¼š" class="headerlink" title="sqlç‰ˆä¾‹å­ï¼š"></a>sqlç‰ˆä¾‹å­ï¼š</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysqlç‰ˆï¼Œæ ¹æ®è°·æ­Œåœ°å›¾å…¬å¼è®¡ç®—ç‚¹æ­Œç»çº¬åº¦ä¹‹é—´è·ç¦»ï¼Œå•ä½ä¸ºmï¼ˆç±³ï¼‰</span></span><br><span class="line"><span class="keyword">select</span> e.id,</span><br><span class="line">       e.longitude,</span><br><span class="line">       e.latitude,</span><br><span class="line">       <span class="keyword">ROUND</span>(</span><br><span class="line">                   <span class="number">6378.138</span> * <span class="number">2</span> * <span class="keyword">ASIN</span>(</span><br><span class="line">                       <span class="keyword">SQRT</span>(</span><br><span class="line">                                   <span class="keyword">POW</span>(</span><br><span class="line">                                           <span class="keyword">SIN</span>(</span><br><span class="line">                                                       (</span><br><span class="line">                                                           e.latitude * <span class="keyword">PI</span>() / <span class="number">180</span> - <span class="number">23.12463</span> * <span class="keyword">PI</span>() / <span class="number">180</span></span><br><span class="line">                                                           ) / <span class="number">2</span></span><br><span class="line">                                               ),</span><br><span class="line">                                           <span class="number">2</span></span><br><span class="line">                                       ) + <span class="keyword">COS</span>(e.latitude * <span class="keyword">PI</span>() / <span class="number">180</span>) * <span class="keyword">COS</span>(<span class="number">23.12463</span> * <span class="keyword">PI</span>() / <span class="number">180</span>) * <span class="keyword">POW</span>(</span><br><span class="line">                                       <span class="keyword">SIN</span>(</span><br><span class="line">                                                   (</span><br><span class="line">                                                       e.longitude * <span class="keyword">PI</span>() / <span class="number">180</span> - <span class="number">113.36189</span> * <span class="keyword">PI</span>() / <span class="number">180</span></span><br><span class="line">                                                       ) / <span class="number">2</span></span><br><span class="line">                                           ),</span><br><span class="line">                                       <span class="number">2</span></span><br><span class="line">                                   )</span><br><span class="line">                           )</span><br><span class="line">                   ) * <span class="number">1000</span></span><br><span class="line">           ) <span class="keyword">AS</span> distance</span><br><span class="line"><span class="keyword">FROM</span> dw_dbei_user e</span><br><span class="line"><span class="keyword">having</span> distance &lt; <span class="number">4000</span></span><br></pre></td></tr></table></figure><h4 id="å·¥å…·ç±»ï¼ˆè·å–ä¸¤ç‚¹è·ç¦»ï¼‰ï¼š"><a href="#å·¥å…·ç±»ï¼ˆè·å–ä¸¤ç‚¹è·ç¦»ï¼‰ï¼š" class="headerlink" title="å·¥å…·ç±»ï¼ˆè·å–ä¸¤ç‚¹è·ç¦»ï¼‰ï¼š"></a>å·¥å…·ç±»ï¼ˆè·å–ä¸¤ç‚¹è·ç¦»ï¼‰ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">//private static double EARTH_RADIUS = 6378.137;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> EARTH_RADIUS = <span class="number">6371.393</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">rad</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—ä¸¤ä¸ªç»çº¬åº¦ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat1 çº¬åº¦1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng1 ç»åº¦1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat2 çº¬åº¦2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng2 ç»åº¦2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è®¡ç®—ç»“æœå•ä½ï¼šç±³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">GetDistance</span><span class="params">(<span class="keyword">double</span> lat1, <span class="keyword">double</span> lng1, <span class="keyword">double</span> lat2, <span class="keyword">double</span> lng2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> radLat1 = rad(lat1);</span><br><span class="line">        <span class="keyword">double</span> radLat2 = rad(lat2);</span><br><span class="line">        <span class="keyword">double</span> a = radLat1 - radLat2;</span><br><span class="line">        <span class="keyword">double</span> b = rad(lng1) - rad(lng2);</span><br><span class="line">        <span class="keyword">double</span> s = <span class="number">2</span> * Math.asin(Math.sqrt(Math.pow(Math.sin(a / <span class="number">2</span>), <span class="number">2</span>) +</span><br><span class="line">                Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / <span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line">        s = s * EARTH_RADIUS;</span><br><span class="line">        s = Math.round(s * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> v = GetDistance(<span class="number">113.36199</span>, <span class="number">23.12463</span>, <span class="number">113.36189</span>, <span class="number">23.12463</span>);</span><br><span class="line">        System.out.println(v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h3><ul><li>å°½é‡æ¯å¤©ä¸æ–­æ›´ï¼Œåšä¸ªè‡ªå¾‹è€…ï¼ŒmarkdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:caochikai@qq.com">caochikai@qq.com</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åœ°ç†å®šä½ä¸šåŠ¡å®ç°&quot;&gt;&lt;a href=&quot;#åœ°ç†å®šä½ä¸šåŠ¡å®ç°&quot; class=&quot;headerlink&quot; title=&quot;åœ°ç†å®šä½ä¸šåŠ¡å®ç°&quot;&gt;&lt;/a&gt;åœ°ç†å®šä½ä¸šåŠ¡å®ç°&lt;/h1&gt;&lt;h2 id=&quot;ä¸€ã€æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ¦‚å¿µ&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
    
      <category term="sql" scheme="https://caochikai.github.io/tags/sql/"/>
    
      <category term="im" scheme="https://caochikai.github.io/tags/im/"/>
    
  </entry>
  
  <entry>
    <title>åˆæ¢ç¼“å­˜</title>
    <link href="https://caochikai.github.io/2019/05/17/%E5%88%9D%E6%8E%A2%E7%BC%93%E5%AD%98/"/>
    <id>https://caochikai.github.io/2019/05/17/%E5%88%9D%E6%8E%A2%E7%BC%93%E5%AD%98/</id>
    <published>2019-05-17T15:34:21.000Z</published>
    <updated>2019-05-17T15:46:48.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¤šçº§ç¼“å­˜æ¶æ„"><a href="#å¤šçº§ç¼“å­˜æ¶æ„" class="headerlink" title="å¤šçº§ç¼“å­˜æ¶æ„"></a>å¤šçº§ç¼“å­˜æ¶æ„</h2><h3 id="ç¼“å­˜è®¾è®¡ç†å¿µï¼š"><a href="#ç¼“å­˜è®¾è®¡ç†å¿µï¼š" class="headerlink" title="ç¼“å­˜è®¾è®¡ç†å¿µï¼š"></a>ç¼“å­˜è®¾è®¡ç†å¿µï¼š</h3><blockquote><p> ç¼“å­˜å¸¸ç”¨çš„å¯¹è±¡æˆ–è€…æ•°æ®ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€æé«˜æ•ˆç‡ã€‚</p></blockquote><h3 id="ç¼“å­˜å‘½ä¸­ç‡"><a href="#ç¼“å­˜å‘½ä¸­ç‡" class="headerlink" title="ç¼“å­˜å‘½ä¸­ç‡"></a>ç¼“å­˜å‘½ä¸­ç‡</h3><blockquote><p>å³ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•° ä¸ æ€»è¯»å–æ¬¡æ•°çš„æ¯”ç‡ï¼Œå‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ï¼š</p></blockquote><h3 id="ç¼“å­˜ç­–ç•¥ï¼š"><a href="#ç¼“å­˜ç­–ç•¥ï¼š" class="headerlink" title="ç¼“å­˜ç­–ç•¥ï¼š"></a>ç¼“å­˜ç­–ç•¥ï¼š</h3><ol><li><p>ç§»é™¤ç­–ç•¥ï¼šFIFOï¼ˆFirst In First Outï¼‰ï¼ŒLRUï¼ˆLeast Recently Usedï¼‰ï¼ŒLFUï¼ˆLeast Frequently Usedï¼‰ã€‚</p></li><li><p>TTLï¼ˆTime To Liveï¼‰ï¼šç¼“å­˜å­˜æ´»æœŸ</p></li><li><p>TTIï¼ˆTime To Idleï¼‰ï¼šç©ºé—²å­˜æ´»æœŸ</p></li></ol><h1 id="spring-cache"><a href="#spring-cache" class="headerlink" title="spring cache"></a>spring cache</h1><hr><h3 id="ä¸€ã€æ¦‚å¿µ"><a href="#ä¸€ã€æ¦‚å¿µ" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h3><blockquote><p>è‡ªSpring 3.1èµ·ï¼Œæä¾›æ³¨è§£ç¼“å­˜ï¼Œå¹¶ä¸”æä¾›äº‹åŠ¡å›æ»šæ—¶ä¹Ÿè‡ªåŠ¨å›æ»šç¼“å­˜ï¼Œå¹¶ä¸”æ”¯æŒSPELè¡¨è¾¾å¼ã€‚</p></blockquote><h3 id="äºŒã€å…¥é—¨ä»£ç "><a href="#äºŒã€å…¥é—¨ä»£ç " class="headerlink" title="äºŒã€å…¥é—¨ä»£ç "></a>äºŒã€å…¥é—¨ä»£ç </h3><p>1ã€æ·»åŠ ä¾èµ–ï¼Œä¾‹å¦‚mavençš„pom.xml(Springboot);</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-cache&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><p>2ã€æ·»åŠ ä¸€ç§cacheManagerçš„beanå®ç°ç±»ï¼Œå¸¸è§ConcurrentMapCacheã€EhCacheCacheã€RedisCacheï¼›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public CacheManager cacheManager() &#123;</span><br><span class="line">    SimpleCacheManager cacheManager &#x3D; new SimpleCacheManager();</span><br><span class="line">    cacheManager.setCaches(Collections.singletonList(new ConcurrentMapCache(&quot;models&quot;)));</span><br><span class="line">    return cacheManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3ã€é…ç½®æ¨¡å—åŠ è½½æ³¨è§£@EnableCaching</p><h3 id="ä¸‰ã€ä¸»è¦æ³¨è§£"><a href="#ä¸‰ã€ä¸»è¦æ³¨è§£" class="headerlink" title="ä¸‰ã€ä¸»è¦æ³¨è§£"></a>ä¸‰ã€ä¸»è¦æ³¨è§£</h3><p>1ã€@Cacheableï¼šå°†æ–¹æ³•è¿”å›å€¼ä½œä¸ºç¼“å­˜</p><ul><li><p>value (ä¹Ÿå¯ä½¿ç”¨ cacheNames) : å¯çœ‹åšå‘½åç©ºé—´ï¼Œè¡¨ç¤ºå­˜åˆ°å“ªä¸ªç¼“å­˜é‡Œäº†ã€‚</p></li><li><p>key : è¡¨ç¤ºå‘½åç©ºé—´ä¸‹ç¼“å­˜å”¯ä¸€key,ä½¿ç”¨Spring Expression Language(ç®€ç§°SpEL,è¯¦è§å‚è€ƒæ–‡çŒ®[5])ç”Ÿæˆã€‚</p></li><li><p>condition : è¡¨ç¤ºåœ¨å“ªç§æƒ…å†µä¸‹æ‰ç¼“å­˜ç»“æœ(å¯¹åº”çš„è¿˜æœ‰unless,å“ªç§æƒ…å†µä¸ç¼“å­˜),åŒæ ·ä½¿ç”¨SpEL</p></li></ul><p>2ã€@CacheEvictï¼šåˆ é™¤ç¼“å­˜æ³¨è§£</p><p>3ã€@CachePutï¼šåˆ·æ–°æ³¨è§£</p><h1 id="ehcache"><a href="#ehcache" class="headerlink" title="ehcache"></a>ehcache</h1><hr><h3 id="ä¸€ã€æ¦‚å¿µ-1"><a href="#ä¸€ã€æ¦‚å¿µ-1" class="headerlink" title="ä¸€ã€æ¦‚å¿µ"></a>ä¸€ã€æ¦‚å¿µ</h3><h3 id="äºŒã€å…¥é—¨ä»£ç -1"><a href="#äºŒã€å…¥é—¨ä»£ç -1" class="headerlink" title="äºŒã€å…¥é—¨ä»£ç "></a>äºŒã€å…¥é—¨ä»£ç </h3><p>1ã€ç¼“å­˜åˆ†ç»„ï¼Œè¦å¯¹åˆ†ç»„è¿›è¡Œå…¨æ–°CacheConfiguration ï¼Œä¸ºäº†é«˜æ•ˆä½¿ç”¨é…ç½®è‡ªå®šä¹‰å±æ€§æå–å™¨ã€‚é»˜è®¤çš„å±æ€§å¤„ç†å™¨æ˜¯JavaBeanAttributeExtractorã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public EhCacheGroupBeanPostProcessor addCache() &#123;</span><br><span class="line">        System.out.println(&quot;.......æ·»åŠ ç¼“å­˜ç»„........&quot;);</span><br><span class="line">        return new EhCacheGroupBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">        &#x2F;&#x2F;åç½®å¤„ç†å™¨</span><br><span class="line">    public static class EhCacheGroupBeanPostProcessor implements BeanPostProcessor &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">                      &#x2F;&#x2F;æ ¹æ®å‰é¢åˆå§‹åŒ–å®Œæˆçš„beanNameè¿›ä¸€æ­¥æ“ä½œ</span><br><span class="line">           if(beanName.equals(&quot;appEhCacheCacheManager&quot;) ) &#123;</span><br><span class="line">                EhCacheCacheManager manager &#x3D; (EhCacheCacheManager)bean;</span><br><span class="line">                CacheManager cacheManager &#x3D; manager.getCacheManager();</span><br><span class="line">&#x2F;&#x2F;              æ–‡ç« ç¼“å­˜å‘½ä¸­é…ç½®needUpdate</span><br><span class="line">                CacheConfiguration configuration &#x3D; new CacheConfiguration(ReadCacheNames.æ–‡ç« ç¼“å­˜,10000);</span><br><span class="line">                Searchable searchable &#x3D; new Searchable();</span><br><span class="line">                searchable.setKeys(false);</span><br><span class="line">                searchable.setValues(false);</span><br><span class="line">                                &#x2F;&#x2F;åŠ¨æ€ç´¢å¼•</span><br><span class="line">                searchable.setAllowDynamicIndexing(true);</span><br><span class="line">                searchable.addSearchAttribute(new SearchAttribute().name(&quot;needUpdate&quot;).className(&quot;com.dwalk.social.common.util.ArticlesAttributeExtractor&quot;));</span><br><span class="line">                configuration.eternal(true).addSearchable(searchable);</span><br><span class="line">                Cache articlesCache &#x3D; new Cache(configuration);</span><br><span class="line">                cacheManager.addCache(articlesCache);</span><br><span class="line">                cacheManager.addCache(ReadCacheNames.çƒ­ç‚¹æ–‡ç« ç¼“å­˜);</span><br><span class="line">            &#125;</span><br><span class="line">            return bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨springå†…ç½®å®šæ—¶å™¨ï¼Œå¹¶ä½¿ç”¨ehcacheæŸ¥è¯¢apiè¿›è¡Œç¼“å­˜æŸ¥è¯¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">        @Scheduled(cron &#x3D; &quot;0 0&#x2F;1 * * * ?&quot;)</span><br><span class="line">    private void synchronize() &#123;</span><br><span class="line">        Cache cache &#x3D; cacheManager.getCache(ReadCacheNames.æ–‡ç« ç¼“å­˜);</span><br><span class="line">        int size &#x3D; cache.getSize();</span><br><span class="line">        if (size &gt; 0) &#123;</span><br><span class="line">            Query query &#x3D; cache.createQuery();</span><br><span class="line">            Attribute searchAttribute &#x3D; cache.getSearchAttribute(&quot;needUpdate&quot;);</span><br><span class="line">                        &#x2F;&#x2F;æŒ‡å®šæŸ¥è¯¢çš„</span><br><span class="line">            query.includeAttribute(searchAttribute);</span><br><span class="line">            query.includeValues();</span><br><span class="line">            Results execute &#x3D; query.addCriteria(searchAttribute.eq(true)).execute();</span><br><span class="line">            List all &#x3D; execute.all();</span><br><span class="line">            log.info(&quot;æŸ¥è¯¢æ–‡ç« ç¼“å­˜çš„å¤§å°ï¼š&#123;&#125;&quot;, all.size());</span><br><span class="line">            for (Result result : all) &#123;</span><br><span class="line">                ArticlesDTO articles &#x3D; (ArticlesDTO) result.getValue();</span><br><span class="line">                articles.setNeedUpdate(false);</span><br><span class="line">                Articles target &#x3D; new Articles();</span><br><span class="line">&#x2F;&#x2F;              åŒæ­¥æµè§ˆé‡ã€è§†é¢‘æ’­æ”¾é‡ã€è¯„è®ºæ•°ã€ç‚¹èµæ•°ã€æ”¶è—æ•°</span><br><span class="line">                target.setVisitorNum(articles.getVisitorNum()).setCommentNum(articles.getCommentNum()).</span><br><span class="line">                        setPlayNum(articles.getPlayNum()).setLikeNum(articles.getLikeNum()).setCollectNum(articles.getCollectNum());</span><br><span class="line">                articlesService.updateById(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h3><p>1ã€éœ€è¦ç†Ÿæ‚‰springæ¥å£è®¾è®¡ï¼Œä»¥æ¥å£ä½¿ç”¨æ¡†æ¶ï¼Œè¦ä¸ç„¶å®˜æ–¹apiä½¿ç”¨éœ€äº†è§£è¯¸å¤šç»†èŠ‚ã€‚</p><h3 id="å››ã€ä¸€äºŒçº§ç¼“å­˜"><a href="#å››ã€ä¸€äºŒçº§ç¼“å­˜" class="headerlink" title="å››ã€ä¸€äºŒçº§ç¼“å­˜"></a>å››ã€ä¸€äºŒçº§ç¼“å­˜</h3><blockquote><p>å½“é‡åˆ°@Cacheableè¿”å›ä¸ºnullè®°å½•ï¼Œä¸ºäº†æˆåŠŸåºåˆ—åŒ–nullï¼Œä½¿ç”¨äº†org.springframework.cache.support.NullValueå¯¹è±¡ä»£æ›¿nullã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONException: autoType is not support. org.springframework.cache.support.NullValue</span><br><span class="line">1ã€èµ·æºä¸€äºŒçº§ç¼“å­˜é‡å†™get()æ–¹æ³•</span><br><span class="line">public class EhRedisCache extends AbstractValueAdaptingCache &#123;</span><br><span class="line">            éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦</span><br><span class="line">        @Override</span><br><span class="line">    public  T get(Object key, Callable valueLoader) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                value &#x3D; lookup(key);</span><br><span class="line">                if(value !&#x3D; null) &#123;</span><br><span class="line">                    return (T) value;</span><br><span class="line">                &#125;</span><br><span class="line">                value &#x3D; valueLoader.call();</span><br><span class="line">                        &#x2F;&#x2F;toStoreValueæ˜¯AbstractValueAdaptingCacheæŠ½è±¡ç±»çš„æ–¹æ³•</span><br><span class="line">                Object storeValue &#x3D; toStoreValue(value);</span><br><span class="line">                put(key, storeValue);</span><br><span class="line">                return (T) value;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new ValueRetrievalException(key, valueLoader, e.getCause());</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">2ã€toStoreValueåˆ¤æ–­userValue &#x3D;&#x3D; null åˆ™return NullValue.INSTANCE </span><br><span class="line">-&gt; public static final Object INSTANCE &#x3D; new NullValue();</span><br><span class="line"></span><br><span class="line">public abstract class AbstractValueAdaptingCache implements Cache &#123;</span><br><span class="line">    protected Object toStoreValue(@Nullable Object userValue) &#123;</span><br><span class="line">        if (userValue &#x3D;&#x3D; null) &#123;</span><br><span class="line">            if (this.allowNullValues) &#123;</span><br><span class="line">                return NullValue.INSTANCE;</span><br><span class="line">            &#125;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                    &quot;Cache &#39;&quot; + getName() + &quot;&#39; is configured to not allow null values but null was provided&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return userValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">3ã€åºåˆ—åŒ–ååºåˆ—åŒ–</span><br><span class="line">public class FastJsonRedisSerializer implements RedisSerializer &#123;</span><br><span class="line">        @Override</span><br><span class="line">    public T deserialize(byte[] bytes) throws SerializationException &#123;</span><br><span class="line">        if (null &#x3D;&#x3D; bytes || bytes.length &lt;&#x3D; 0) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        String str &#x3D; new String(bytes, DEFAULT_CHARSET);</span><br><span class="line">        return (T) JSON.parseObject(str, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">4ã€jsonParserè§£æç±»å‹</span><br><span class="line">public class com.alibaba.fastjson.parser.DefaultJSONParser implements Closeable &#123;</span><br><span class="line">    public final Object parseObject(final Map object, Object fieldName) &#123;</span><br><span class="line">                    éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦</span><br><span class="line">                                            Class clazz &#x3D; null;</span><br><span class="line">                        if (object !&#x3D; null</span><br><span class="line">                                &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">                            clazz &#x3D; object.getClass();</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F;com.alibaba.fastjson.parser.DefaultJSONParser#configæ‰§è¡Œ</span><br><span class="line">                            clazz &#x3D; config.checkAutoType(typeName, null, lexer.getFeatures());</span><br><span class="line">                        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">5ã€å¼‚å¸¸æŠ›å‡ºç‚¹TypeUtils.getClassFromMapping(typeName) -ã€‹ typeNameä¸ºorg.springframework.cache.support.NullValue</span><br><span class="line">public Class checkAutoType(String typeName, Class expectClass, int features) &#123;</span><br><span class="line">    if (Arrays.binarySearch(denyHashCodes, hash) &gt;&#x3D; 0 &amp;&amp; TypeUtils.getClassFromMapping(typeName) &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        throw new JSONException(&quot;autoType is not support. &quot; + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">6ã€TypeUtilsçš„getClassFromMappingæ–¹æ³•è¿”å›null</span><br><span class="line">        public static Class getClassFromMapping(String className)&#123;</span><br><span class="line">        return mappings.get(className);</span><br><span class="line">    &#125;</span><br><span class="line">7ã€TypeUtilsä¸æ”¯æŒorg.springframework.cache.support.NullValue</span><br><span class="line">private static ConcurrentMap&gt; mappings &#x3D; new ConcurrentHashMap&gt;(16, 0.75f, 1);</span><br><span class="line">&#x2F;&#x2F;mappingsç±»å‹ç™½åå•</span><br><span class="line">private static void addBaseClassMappings()&#123;</span><br><span class="line">        mappings.put(&quot;byte&quot;, byte.class);</span><br><span class="line">        mappings.put(&quot;short&quot;, short.class);</span><br><span class="line">        mappings.put(&quot;int&quot;, int.class);</span><br><span class="line">        mappings.put(&quot;long&quot;, long.class);</span><br><span class="line">        mappings.put(&quot;float&quot;, float.class);</span><br><span class="line">        mappings.put(&quot;double&quot;, double.class);</span><br><span class="line">        mappings.put(&quot;boolean&quot;, boolean.class);</span><br><span class="line">                éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦</span><br><span class="line">                fastJsonå®˜æ–¹æ²¡æœ‰æ”¯æŒorg.springframework.cache.support.NullValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h2><ul><li>ä»Šå¤©å¤å‡ºå†™åšå®¢ï¼Œä¸€æ˜¯æ„Ÿè§‰æ‡’äº†æœŸæœ›è¿›æ­¥ï¼ŒäºŒæ˜¯ä¸ºäº†ç§¯ç´¯çŸ¥è¯†æ–¹ä¾¿copyğŸ˜‚ã€‚</li><li>é‚®ç®±ï¼š<a href="mailto:&#99;&#x61;&#111;&#x63;&#104;&#x69;&#x6b;&#97;&#105;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#109;">&#99;&#x61;&#111;&#x63;&#104;&#x69;&#x6b;&#97;&#105;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#109;</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¤šçº§ç¼“å­˜æ¶æ„&quot;&gt;&lt;a href=&quot;#å¤šçº§ç¼“å­˜æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;å¤šçº§ç¼“å­˜æ¶æ„&quot;&gt;&lt;/a&gt;å¤šçº§ç¼“å­˜æ¶æ„&lt;/h2&gt;&lt;h3 id=&quot;ç¼“å­˜è®¾è®¡ç†å¿µï¼š&quot;&gt;&lt;a href=&quot;#ç¼“å­˜è®¾è®¡ç†å¿µï¼š&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
    
      <category term="spring" scheme="https://caochikai.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>AndroidAdb</title>
    <link href="https://caochikai.github.io/2017/02/05/AndroidAdb/"/>
    <id>https://caochikai.github.io/2017/02/05/AndroidAdb/</id>
    <published>2017-02-05T12:49:09.000Z</published>
    <updated>2017-02-05T13:27:22.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android-adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£"><a href="#Android-adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£" class="headerlink" title="Android adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£"></a>Android adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£</h1><p>@(Android)[è°ƒè¯•å·¥å…·|å®ç”¨æ•™ç¨‹|adbå‘½ä»¤]</p><p><a href="https://developer.android.com/studio/command-line/adb.html" target="_blank" rel="noopener">Android Studio ADBå®˜æ–¹æ–‡æ¡£</a></p><p><strong>ADB</strong>å…¨ç§°ä¸º Android Debug Bridge, æ˜¯android é‡Œçš„ä¸€ä¸ªè°ƒè¯•å·¥å…·, ç”¨è¿™ä¸ªå·¥å…·å¯ä»¥ç›´æ¥æ“ä½œç®¡ç†androidæ¨¡æ‹Ÿå™¨æˆ–è€…çœŸå®çš„andriodè®¾å¤‡æ‰‹æœºã€‚å¦‚æœä½ å®‰è£…äº†<strong>Android SDK</strong>ï¼ˆæˆ–è€…ä¸‹è½½adbå·¥å…·åŒ…ï¼Œä½“ç§¯å°ï¼‰,å­˜æ”¾sdkçš„platform-toolsç›®å½•ä¸‹ï¼Œåœ¨ å‘½ä»¤è¡Œcmdä½¿ç”¨éœ€è¦é…ç½®è·¯å¾„ï¼ˆ<strong>android_sdk/platform-tools/adb.exe</strong> ï¼‰åˆ°ç¯å¢ƒå˜é‡é‡Œã€‚å®ƒå¯ä¸ºå„ç§è®¾å¤‡æ“ä½œæä¾›ä¾¿åˆ©ï¼Œå¦‚å®‰è£…å’Œè°ƒè¯•åº”ç”¨ï¼Œä¾‹å¦‚æŸ¥çœ‹androidä¸­çš„æ•°æ®åº“ï¼Œæä¾›å¯¹ Unix shellï¼ˆå¯ç”¨æ¥åœ¨æ¨¡æ‹Ÿå™¨æˆ–è¿æ¥çš„è®¾å¤‡ä¸Šè¿è¡Œå„ç§å‘½ä»¤ï¼‰çš„è®¿é—®ã€‚è¯¥å·¥å…·ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨ç¨‹åºï¼ŒåŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š</p><ul><li><strong>å®¢æˆ·ç«¯</strong> ï¼šè¯¥ç»„ä»¶å‘é€å‘½ä»¤ã€‚å®¢æˆ·ç«¯åœ¨å¼€å‘è®¡ç®—æœºä¸Šè¿è¡Œã€‚æ‚¨å¯ä»¥é€šè¿‡å‘å‡º adb å‘½ä»¤ä»å‘½ä»¤è¡Œç»ˆç«¯è°ƒç”¨å®¢æˆ·ç«¯ï¼›</li><li><strong>åå°ç¨‹åº</strong> ï¼šè¯¥ç»„ä»¶åœ¨è®¾å¤‡ä¸Šè¿è¡Œå‘½ä»¤ã€‚åå°ç¨‹åºåœ¨æ¯ä¸ªæ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡å®ä¾‹ä¸Šä½œä¸ºåå°è¿›ç¨‹è¿è¡Œï¼›</li><li><strong>æœåŠ¡å™¨</strong> ï¼šè¯¥ç»„ä»¶ç®¡ç†å®¢æˆ·ç«¯å’Œåå°ç¨‹åºä¹‹é—´çš„é€šä¿¡ã€‚æœåŠ¡å™¨åœ¨å¼€å‘è®¡ç®—æœºä¸Šä½œä¸ºåå°è¿›ç¨‹è¿è¡Œã€‚</li></ul><h3 id="å…³äºæ¸…é™¤è§£é”å›¾æ¡ˆ"><a href="#å…³äºæ¸…é™¤è§£é”å›¾æ¡ˆ" class="headerlink" title="å…³äºæ¸…é™¤è§£é”å›¾æ¡ˆ"></a>å…³äºæ¸…é™¤è§£é”å›¾æ¡ˆ</h3><blockquote><p>ç”¨æˆ·ç›¸å…³çš„æ–‡ä»¶accounts.dbï¼ˆgmailè´¦å·ç®¡ç†ï¼‰ï¼Œgesture.keyï¼ˆæ‰‹åŠ¿è¯†åˆ«æ–‡ä»¶ï¼‰ï¼Œpassword.keyï¼ˆå¯†ç æ–‡ä»¶ï¼‰ã€‚<br>ä¸åŒå“ç‰Œæ‰‹æœºç³»ç»Ÿç›¸å…³æ–‡ä»¶åä¹Ÿä¼šä¸åŒ,ä¾‹å¦‚æˆ‘çš„æ‰‹æœºï¼Œåä¸º4xæ–‡ä»¶ä¸ºlocksettings.dbï¼ˆæ•°æ®åº“æ–‡ä»¶ï¼‰ã€‚<br>ä¿®ç†åº—é‡Œçš„å¸ˆå‚…ä½¿ç”¨ä¸€ä¸ªå·¥å…·å«æ˜Ÿæµ·ç¥å™¨ï¼ˆé«˜é€šå¹³å°å¼ºåˆ·ï¼‰ï¼ŒåŠŸèƒ½è¶…ä¹æƒ³è±¡ï¼Œå‡ ä¹æ”¯æŒæ‰€æœ‰æ‰‹æœºå“ç‰Œï¼ˆç‰¹åˆ«æ˜¯è‹¹æœï¼‰<br>æ·˜å®ä¸Šæœ‰å–ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†åŠ å¯†è¿‡ï¼å°ç±³æ‰‹æœºå«ä¸¢å¤±è§£é”ç¥å™¨ï¼</p></blockquote><h4 id="1-ç ´è§£æ¡ä»¶"><a href="#1-ç ´è§£æ¡ä»¶" class="headerlink" title="1. ç ´è§£æ¡ä»¶"></a>1. ç ´è§£æ¡ä»¶</h4><ul><li><strong>æ‰‹æœºæ‰“å¼€USBå¹¶è¿æ¥ç”µè„‘</strong> </li><li><strong>æ‰‹æœºè¢«ROOTï¼Œå¹¶ä¸”ADBå¯ä»¥ç›´æ¥å‡çº§ä¸ºROOTç”¨æˆ·</strong> </li><li><strong>é…ç½®adbè·¯å¾„åˆ°ç¯å¢ƒå˜é‡æˆ–è€…ç›´æ¥åœ¨cmdå‘½ä»¤è¡Œé‡Œé¢åˆ‡æ¢åˆ°adbæ‰€åœ¨è·¯å¾„</strong> </li></ul><h4 id="2-ç ´è§£æ­¥éª¤"><a href="#2-ç ´è§£æ­¥éª¤" class="headerlink" title="2. ç ´è§£æ­¥éª¤"></a>2. ç ´è§£æ­¥éª¤</h4><ul><li>*<em>æ‰“å¼€cmdå‘½ä»¤è¡Œï¼Œç”¨ã€adb shellã€‘å‘½ä»¤è¿›å…¥shell *</em> </li><li><strong>åˆ©ç”¨suå‘½ä»¤å°†adbæå‡ä¸ºrootç”¨æˆ·ï¼Œå¦‚æœæˆåŠŸï¼Œè¡Œé¦–ç”±$å˜æˆ #ï¼Œ#è¡¨ç¤ºrootç”¨æˆ·</strong> </li><li>*<em>è¿›å…¥data/systemç›®å½• *</em> </li><li>*<em>lsæŸ¥çœ‹å½“å‰ç›®å½• *</em> </li><li>*<em>ç”¨lså‘½ä»¤æŸ¥çœ‹å¯†ç æ–‡ä»¶ *</em>  </li><li><strong>ç”¨rmå‘½ä»¤åˆ é™¤å¯†ç æ–‡ä»¶ï¼Œè‹¥æ˜¯$ï¼ˆä¸æ˜¯rootï¼‰ï¼Œåˆ™ä¼šæç¤ºâ€rm failed for â€¦ Permission deniedâ€ï¼Œæƒé™ä¸è¶³</strong>   </li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell</span><br><span class="line">$ su</span><br><span class="line"># cd /data/system</span><br><span class="line"># ls</span><br><span class="line"># rm locksettings.db</span><br></pre></td></tr></table></figure><p>è¾“å…¥rebootæˆ–æ‰‹åŠ¨é‡å¯æ‰‹æœºç”Ÿæ•ˆã€‚äº²æµ‹åä¸ºè£è€€4Xæœ‰æ•ˆï¼Œåˆ é™¤é”å±å¯†ç åï¼ŒæŒ‡çº¹è§£é”è‡ªåŠ¨å¤±æ•ˆï¼Œæ‰€ä»¥æ­¤æ–¹æ³•ä¹Ÿå¯ä»¥ç ´è§£æŒ‡çº¹è§£é”ï¼ï¼é‡æ–°è®¾ç½®é”å±å¯†ç åï¼Œä»¥å‰è®¾ç½®çš„æŒ‡çº¹è§£é”åˆå¯ä»¥ç”¨äº†ã€‚</p><h4 id="3-æ³¨æ„äº‹é¡¹"><a href="#3-æ³¨æ„äº‹é¡¹" class="headerlink" title="3. æ³¨æ„äº‹é¡¹"></a>3. æ³¨æ„äº‹é¡¹</h4><pre><code>çœ‹åˆ°è¿™å„¿å°±æ˜ç™½äº†ï¼Œå³ä¾¿æ‰‹æœºRoot+æ‰“å¼€USBè°ƒè¯•ï¼Œä¹Ÿæ˜¯æ— æ³•é€šè¿‡ADBè§£é”æ‰‹æœºçš„ã€‚å› ä¸ºæƒ³è¦æƒ³è¦è§£é”ï¼Œå°±å¾—åˆ é™¤/data/system ä¸‹çš„ç›¸å…³æ–‡ä»¶ï¼Œå¯åˆ é™¤éœ€è¦ç”±Superuseræˆ–è€…kingrootæˆäºˆADB shellæƒé™ï¼Œè€Œæˆæƒéœ€è¦è§£é”æ‰“å¼€æ‰‹æœºåæ“ä½œSuperuserç¨‹åºã€‚å³è§£é”éœ€è¦ç”¨åˆ°è§£é”åçš„æ‰‹æœºæ“ä½œï¼Œå°±åƒæ˜¥æ™šå°å“ã€Šå¼€é”ã€‹ä¸­ï¼Œä¸šä¸»é»„å®è¦æ±‚å¼€é”å¸ˆå‚…æ—æ°¸å¥å¼€é”ï¼Œæ—æ°¸å¥è¦æ±‚é»„å®å‡ºç¤ºæœ‰æ•ˆè¯ä»¶ï¼Œå¯è¯ä»¶å°±åœ¨é”ç€çš„ç®±å­é‡Œå¤´ã€‚  æˆ‘è¿›è¡Œäº†æµ‹è¯•åå‘ç°ï¼Œåœ¨æˆæƒè¿‡ä¸€æ¬¡åï¼Œä¸‹æ¬¡æ‰‹æœºç”¨USBæ•°æ®çº¿è¿æ¥ç”µè„‘ï¼Œå†æ¬¡è¿›è¡Œè§£é”ï¼Œå³ä¾¿åŒå°ç”µè„‘ï¼Œä¹Ÿæ˜¯éœ€è¦å†æ¬¡æˆæƒçš„ã€‚è¿™å°±è¯´æ˜ï¼Œå³ä¾¿ä½ ç”¨ä½ çš„ç”µè„‘ç»è¿‡æ‰‹æœºæˆæƒè§£é”è¿‡ï¼Œè¿‡åæƒ³è¦åœ¨å¿˜è®°å¯†ç æ—¶ä½¿ç”¨ADBæ–¹å¼è§£é”ï¼Œä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚  æˆ‘è§‰å¾—è¿™æ˜¯é«˜ç‰ˆæœ¬çš„å®‰å“ç³»ç»Ÿï¼ˆeg. Android 4.2 Jelly Bean å®‰å“æœå†»è±†ï¼‰æ–°æœ‰çš„å®‰å…¨ç‰¹æ€§ï¼Œä½ç‰ˆæœ¬çš„Androidå¦‚å®‰å“2.3.8æ˜¯å¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•è§£é”çš„ã€‚å› ä¸ºæˆ‘å®é™…æµ‹è¯•ï¼Œæˆ‘çš„å›ºä»¶ç‰ˆæœ¬ä¸ºå®‰å“2.3.8çš„ä¸‰æ˜ŸS5570ï¼ˆå·²ç»Rootï¼Œæ‰“å¼€USBè°ƒè¯•ï¼‰ï¼Œæ‰§è¡Œå‘½ä»¤rm gesture.keyï¼Œæ— éœ€æˆæƒï¼Œç›´æ¥å³å¯è§£é”ã€‚ç°åœ¨æˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œä½ç‰ˆæœ¬å®‰å“ç³»ç»Ÿå¦‚ Android2.3.8çš„æ‰‹æœºè§£é”å±å¹•é”å®šå¯†ç ï¼Œæ˜¯å¦çš„ç¡®å¿…é¡»Rootï¼Œè¿˜æ˜¯åªè¦æ‰“å¼€USBè°ƒè¯•å³å¯ï¼Ÿæˆ‘æ‰‹å¤´æ²¡æœ‰æ²¡Rootçš„Android2.3æ‰‹æœºï¼Œä¹Ÿæ‡’å¾—æŠ˜è…¾äº†ï¼Œå°±ä¸ç®¡å®ƒäº†ã€‚ è¿™æ ·çœ‹æ¥ï¼Œé«˜ç‰ˆæœ¬çš„å®‰å“ç³»ç»Ÿä¹Ÿå°±ä¸å­˜åœ¨è¢«éæ‰‹æœºæ‰€æœ‰è€…æ¶æ„è§£é”çš„BUGäº†ã€‚</code></pre><h4 id="4-é¢˜å¤–è¯ï¼ˆä»Šå¹´å¥½ä¸œè¥¿éƒ½æŒ‚äº†ï¼‰"><a href="#4-é¢˜å¤–è¯ï¼ˆä»Šå¹´å¥½ä¸œè¥¿éƒ½æŒ‚äº†ï¼‰" class="headerlink" title="4. é¢˜å¤–è¯ï¼ˆä»Šå¹´å¥½ä¸œè¥¿éƒ½æŒ‚äº†ï¼‰"></a>4. é¢˜å¤–è¯ï¼ˆä»Šå¹´å¥½ä¸œè¥¿éƒ½æŒ‚äº†ï¼‰</h4><p><a href="http://itwusun.com/offer.html" target="_blank" rel="noopener">æ”¶è´¹éŸ³ä¹ç¥å™¨å®˜ç½‘</a>ï¼Œ<a href="http://www.btjson.com/index.html" target="_blank" rel="noopener">æœåŠ¡å™¨æ¥å£å¹³å°AnyListen</a></p><p><strong>éŸ³ä¹é—´è°</strong>ä¸ºwindow PCç‰ˆï¼Œ<strong>éŸ³ä¹åŠ©æ‰‹</strong>Androidç‰ˆï¼Œ<a href="http://weibo.com/shelher?is_hot=1" target="_blank" rel="noopener">Shelherå¾®åš</a>åˆ†äº«å‡ºæ¥3.3ç‰ˆæºç <a href="https://pan.baidu.com/share/init?shareid=976327165&uk=4145536040" target="_blank" rel="noopener">ç™¾åº¦äº‘ â€‹â€‹â€‹â€‹</a>å¯†ç griaï¼å°´å°¬çš„æ˜¯æœ‹å‹äº‘å…æµé‡ä¹Ÿä¸å¹²äº†ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Android-adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£&quot;&gt;&lt;a href=&quot;#Android-adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£&quot; class=&quot;headerlink&quot; title=&quot;Android adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£&quot;&gt;&lt;/a&gt;Android adbè°ƒè¯•å·¥
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>SpiderWebMagic</title>
    <link href="https://caochikai.github.io/2017/01/30/SpiderWebMagic/"/>
    <id>https://caochikai.github.io/2017/01/30/SpiderWebMagic/</id>
    <published>2017-01-30T12:50:27.000Z</published>
    <updated>2017-01-30T12:57:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦"><a href="#WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦" class="headerlink" title="WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦"></a>WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦</h1><p>@(çˆ¬è™«)[æ¡†æ¶|çˆ¬è™«|Demoæ€»ç»“]</p><p><strong>WebMagic</strong>!é¡¹ç›®ä»£ç åˆ†ä¸ºæ ¸å¿ƒ(webmagic-core)å’Œæ‰©å±•(webmagic-extension)ä¸¤éƒ¨åˆ†(jaråŒ…)ã€‚Downloaderã€PageProcessorã€Schedulerã€Pipelineè¿™å››å¤§ç»„ä»¶å¯¹åº”çˆ¬è™«ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸‹è½½ã€å¤„ç†ã€ç®¡ç†å’ŒæŒä¹…åŒ–ç­‰åŠŸèƒ½ã€‚</p><table><thead><tr><th>åç§°</th><th align="center">åŠŸèƒ½</th></tr></thead><tbody><tr><td>Downloader</td><td align="center">åŸºç¡€ã€‚åˆ©ç”¨httpClientä½œä¸ºä¸‹è½½å·¥å…·ï¼Œä¸‹è½½é¡µé¢å†…å®¹ä¾¿äºåç»­å¤„ç†è§£æ;</td></tr><tr><td>Page</td><td align="center">ç½‘é¡µå†…å®¹å¯¹è±¡ã€‚ æŒ‡æ ¹æ®urlä¸‹è½½åˆ°çš„é¡µé¢å†…å®¹ï¼ŒåŒ…æ‹¬é¡µé¢domå…ƒç´ ï¼Œcssæ ·å¼ï¼Œjavascriptç­‰;</td></tr><tr><td>Pageprocess</td><td align="center">çˆ¬è™«çš„æ ¸å¿ƒã€‚ è´Ÿè´£è§£æé¡µé¢ï¼ŒæŠ½å–æœ‰ç”¨ä¿¡æ¯ï¼Œå¯é‡‡ç”¨css(),$(),xpath()æ–¹æ³•å¯¹ç‰¹å®šé¡µé¢å…ƒç´ è¿›è¡ŒæŠ½å–;</td></tr><tr><td>Site</td><td align="center">ç½‘ç«™è®¾ç½®ã€‚è®¾ç½®ç½‘ç«™domainï¼Œcookies,header,é‡è¯•æ¬¡æ•°,è®¿é—®é—´éš”æ—¶é—´ç­‰;</td></tr><tr><td>Scheduler</td><td align="center">æŠ“å–é¡µé¢é˜Ÿåˆ—ã€‚ ç®¡ç†å¾…æŠ“å–çš„URLï¼Œä»¥åŠä¸€äº›å»é‡çš„å·¥ä½œï¼Œå°†ç›®æ ‡urlå†…å®¹pushåˆ°æŠ“å–é˜Ÿåˆ—ä¸­;</td></tr><tr><td>Pipeline</td><td align="center">è¾“å‡ºï¼Œæ”¶å°¾ã€‚ è´Ÿè´£æŠ½å–ç»“æœçš„å¤„ç†ï¼ŒåŒ…æ‹¬è®¡ç®—ã€æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€æ•°æ®åº“;</td></tr><tr><td>Spider</td><td align="center">çˆ¬è™«çš„å…¥å£ç±» é‡‡ç”¨é“¾å¼è®¾è®¡ï¼Œé€šè¿‡å®ƒæ¥è®¾å®šå¤šçº¿ç¨‹ï¼Œé¡µé¢è§£æå™¨ï¼Œè°ƒåº¦ä»¥åŠè¾“å‡ºæ–¹å¼ç­‰ã€‚</td></tr></tbody></table><h3 id="WebMagicå®˜æ–¹é“¾æ¥ï¼š"><a href="#WebMagicå®˜æ–¹é“¾æ¥ï¼š" class="headerlink" title="WebMagicå®˜æ–¹é“¾æ¥ï¼š"></a>WebMagicå®˜æ–¹é“¾æ¥ï¼š</h3><ul><li><a href="http://webmagic.io/" target="_blank" rel="noopener">å®˜ç½‘</a> åŒ…å«å®˜æ–¹æ–‡æ¡£å’Œæºç ,ä»¥åŠç›¸åº”çš„å®ä¾‹ï¼›</li><li><a href="https://github.com/code4craft/webmagic" target="_blank" rel="noopener">github</a> ä»“åº“ä¿å­˜æœ€æ–°ç‰ˆæœ¬ï¼›</li><li><a href="http://git.oschina.net/flashsword20/webmagic" target="_blank" rel="noopener">oschinamayunç äº‘</a> åŒ…å«æ‰€æœ‰ç¼–è¯‘å¥½çš„ä¾èµ–åŒ…ï¼›</li></ul><h4 id="çˆ¬å–äº¬ä¸œå›¾ä¹¦-https-book-jd-com"><a href="#çˆ¬å–äº¬ä¸œå›¾ä¹¦-https-book-jd-com" class="headerlink" title="çˆ¬å–äº¬ä¸œå›¾ä¹¦(https://book.jd.com/)"></a>çˆ¬å–äº¬ä¸œå›¾ä¹¦(<a href="https://book.jd.com/" target="_blank" rel="noopener">https://book.jd.com/</a>)</h4><h5 id="åœ¨å•†å“åˆ—è¡¨ç½‘é¡µæŠ“å–å¦‚ä¸‹å•†å“ä¿¡æ¯"><a href="#åœ¨å•†å“åˆ—è¡¨ç½‘é¡µæŠ“å–å¦‚ä¸‹å•†å“ä¿¡æ¯" class="headerlink" title="åœ¨å•†å“åˆ—è¡¨ç½‘é¡µæŠ“å–å¦‚ä¸‹å•†å“ä¿¡æ¯"></a>åœ¨å•†å“åˆ—è¡¨ç½‘é¡µæŠ“å–å¦‚ä¸‹å•†å“ä¿¡æ¯</h5><ul><li>å•†å“åï¼šå•†å“åç§°</li><li>å•†å“ç½‘é¡µï¼šæ˜¾ç¤ºå•†å“è¯¦ç»†ä¿¡æ¯çš„ç½‘é¡µåœ°å€ã€‚</li><li>å¸‚åœºä»·æ ¼ï¼šäº¬ä¸œç»™å‡ºçš„å¸‚é¢ä»·æ ¼</li><li>äº¬ä¸œä»·æ ¼ï¼šäº¬ä¸œçš„ä¼˜æƒ ä»·ã€‚</li></ul><h5 id="å…³äºajaxä»·æ ¼é“¾æ¥åœ°å€æ ¼å¼ï¼šhttp-p-3-cn-prices-mgets-skuIds-J-å•†å“IDï¼ŒæŠ“å–æ ¼å¼ä¸ºjsonã€‚"><a href="#å…³äºajaxä»·æ ¼é“¾æ¥åœ°å€æ ¼å¼ï¼šhttp-p-3-cn-prices-mgets-skuIds-J-å•†å“IDï¼ŒæŠ“å–æ ¼å¼ä¸ºjsonã€‚" class="headerlink" title="å…³äºajaxä»·æ ¼é“¾æ¥åœ°å€æ ¼å¼ï¼šhttp://p.3.cn/prices/mgets?skuIds=J_ + å•†å“IDï¼ŒæŠ“å–æ ¼å¼ä¸ºjsonã€‚"></a>å…³äºajaxä»·æ ¼é“¾æ¥åœ°å€æ ¼å¼ï¼š<a href="http://p.3.cn/prices/mgets?skuIds=J" target="_blank" rel="noopener">http://p.3.cn/prices/mgets?skuIds=J</a>_ + å•†å“IDï¼ŒæŠ“å–æ ¼å¼ä¸ºjsonã€‚</h5><ul><li><a href="https://item.jd.com/12087016.html" target="_blank" rel="noopener">https://item.jd.com/12087016.html</a> ï¼šå›¾ä¹¦è¯¦æƒ…é¡µï¼›</li><li><a href="http://p.3.cn/prices/mgets?skuIds=J_12087016" target="_blank" rel="noopener">http://p.3.cn/prices/mgets?skuIds=J_12087016</a>  ï¼ˆä¾‹ï¼‰ä»·æ ¼ajaxè¯·æ±‚é“¾æ¥ï¼›</li><li>[{â€œidâ€:â€J_12087016â€,â€pâ€:â€60.80â€,â€mâ€:â€90.00â€,â€opâ€:â€60.80â€}]  æŠ“å–ç»“æœ id + äº¬ä¸œå®é™…ä»·æ ¼+å¸‚åœºä»·æ ¼</li></ul><hr><h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Page;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Site;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Spider;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.processor.PageProcessor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDPageProcesser</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me().setRetryTimes(<span class="number">3</span>).setSleepTime(<span class="number">3000</span>).setCharset(<span class="string">"GBK"</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> size = <span class="number">0</span>;<span class="comment">// å…±æŠ“å–åˆ°çš„å›¾ä¹¦æ•°é‡</span></span><br><span class="line">    <span class="comment">//æŠ“å–å•†å“ä¿¡æ¯é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; name = <span class="keyword">new</span> ArrayList&lt;String&gt;();<span class="comment">//æ‰€æœ‰çš„ä¹¦å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; author = <span class="keyword">new</span> ArrayList&lt;String&gt;();<span class="comment">//æ‰€æœ‰çš„ä½œè€…</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Double&gt; prices = <span class="keyword">new</span> ArrayList&lt;Double&gt;();<span class="comment">//æ‰€æœ‰çš„ä»·æ ¼</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å›¾ä¹¦ä¸»é¡µ</span></span><br><span class="line"><span class="comment">// https://item.jd.com/12004057.html</span></span><br><span class="line">        <span class="keyword">if</span> (!page.getUrl().regex(<span class="string">"https://item.jd.com/\\d&#123;8&#125;.html"</span>).match()&amp;!page.getUrl().regex(<span class="string">"p.3.cn/prices/mgets"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">// ä¸»é¡µä¸­æ·»åŠ å•†å“è¯¦æƒ…é¡µåˆ°è®¡åˆ’url</span></span><br><span class="line">            List&lt;String&gt; detail = page.getHtml().links().regex(<span class="string">"//item.jd.com/\\d&#123;8&#125;.html"</span>).replace(<span class="string">"//"</span>, <span class="string">"https://"</span>).all();</span><br><span class="line">            <span class="comment">//æ§åˆ¶æŠ“å–å•†å“çš„æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> (detail.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                    String url = detail.get(i);</span><br><span class="line">                    System.out.println(<span class="string">"url:"</span> + url.replace(<span class="string">"https://item.jd.com"</span>, <span class="string">""</span>).replace(<span class="string">"/"</span>, <span class="string">"http://p.3.cn/prices/mgets?skuIds=J_"</span>).replace(<span class="string">".html"</span>, <span class="string">""</span>));</span><br><span class="line">                    <span class="comment">//åˆ—é˜Ÿæ·»åŠ ä¸€æ¡è¯¦æƒ…é¡µåé¢è¿½åŠ ä¸€æ¡ä»·æ ¼ajaxé“¾æ¥</span></span><br><span class="line">                    page.addTargetRequest(url);</span><br><span class="line">                    page.addTargetRequest(url.replace(<span class="string">"https://item.jd.com"</span>, <span class="string">""</span>).replace(<span class="string">"/"</span>, <span class="string">"http://p.3.cn/prices/mgets?skuIds=J_"</span>).replace(<span class="string">".html"</span>, <span class="string">""</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (page.getUrl().regex(<span class="string">"https://item.jd.com/\\d&#123;8&#125;.html"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">// å•†å“è¯¦æƒ…é¡µ</span></span><br><span class="line">            size++;</span><br><span class="line">            name.add(page.getHtml().xpath(<span class="string">"//div[@id=name]/h1/text()"</span>).get());<span class="comment">//æ·»åŠ ä¹¦å</span></span><br><span class="line">            author.add(page.getHtml().xpath(<span class="string">"//div[@id=p-author]/a/text()"</span>).get());<span class="comment">//æ·»åŠ ä½œè€…</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (page.getUrl().regex(<span class="string">"p.3.cn/prices/mgets"</span>).match()) &#123;</span><br><span class="line">            <span class="comment">//ajaxå•†å“idå¯¹åº”ä»·æ ¼jsonæ¥å£</span></span><br><span class="line">            prices.add(Double.parseDouble(page.getHtml().replace(<span class="string">"&amp;quot"</span>, <span class="string">""</span>).regex(<span class="string">"p;:;.+;,;m"</span>).regex(<span class="string">"\\d+\\.\\d+"</span>).get()));<span class="comment">//æ·»åŠ ä»·æ ¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ‰€æœ‰ä¿¡æ¯å¯¼å…¥DAO,æŒä¹…åŒ–å±‚å¾…å®ç°</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Size"</span>  + name.size() + author.size() + prices.size());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; name.size(); i++) &#123;</span><br><span class="line">            JDLog model = <span class="keyword">new</span> JDLog();</span><br><span class="line">            model.setName(name.get(i));</span><br><span class="line">            model.setAuthor(author.get(i));</span><br><span class="line">            model.setPrices(prices.get(i));</span><br><span class="line">            System.out.println(<span class="string">"ä¹¦å:"</span> + model.getName());</span><br><span class="line">            System.out.println(<span class="string">"ä½œè€…:"</span> + model.getAuthor());</span><br><span class="line">            System.out.println(<span class="string">"ä»·æ ¼:"</span> + model.getPrices());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime, endTime;</span><br><span class="line">        System.out.println(<span class="string">"ã€çˆ¬è™«å¼€å§‹ã€‘è¯·è€å¿ƒç­‰å¾…ä¸€å¤§æ³¢æ•°æ®åˆ°ä½ ç¢—é‡Œæ¥..."</span>);</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// ä»äº¬ä¸œå›¾ä¹¦å¼€å§‹æŠ“ï¼Œå¼€å¯5ä¸ªçº¿ç¨‹ï¼Œå¯åŠ¨çˆ¬è™«</span></span><br><span class="line">        Spider.create(<span class="keyword">new</span> JDPageProcesser()).addUrl(<span class="string">"https://book.jd.com/"</span>).thread(<span class="number">3</span>).run();</span><br><span class="line">        endTime = System.currentTimeMillis();</span><br><span class="line">        getAll();</span><br><span class="line">        System.out.println(<span class="string">"ã€çˆ¬è™«ç»“æŸã€‘å…±æŠ“å–"</span> + size + <span class="string">"æœ¬å›¾ä¹¦ï¼Œè€—æ—¶çº¦"</span> + ((endTime - startTime) / <span class="number">1000</span>) + <span class="string">"ç§’ï¼Œå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¯·æŸ¥æ”¶ï¼"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä»¥åå°†ä¼šåšæŒæ›´æ–°"><a href="#ä»¥åå°†ä¼šåšæŒæ›´æ–°" class="headerlink" title="ä»¥åå°†ä¼šåšæŒæ›´æ–°!"></a>ä»¥åå°†ä¼šåšæŒæ›´æ–°!</h2><h2 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h2><ul><li>é‚®ç®±ï¼š<a href="mailto:&#99;&#x61;&#111;&#x63;&#x68;&#105;&#x6b;&#97;&#x69;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;">&#99;&#x61;&#111;&#x63;&#x68;&#105;&#x6b;&#97;&#x69;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦&quot;&gt;&lt;a href=&quot;#WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦&quot; class=&quot;headerlink&quot; title=&quot;WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦&quot;&gt;&lt;/a&gt;WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦&lt;/h1&gt;&lt;p&gt;@(çˆ¬è™«)[æ¡†æ¶|çˆ¬
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>My New Post</title>
    <link href="https://caochikai.github.io/2016/12/24/First%20Wirte/"/>
    <id>https://caochikai.github.io/2016/12/24/First%20Wirte/</id>
    <published>2016-12-24T13:46:06.000Z</published>
    <updated>2016-12-24T15:11:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Markdownåˆæ¬¡ä½¿ç”¨"><a href="#Markdownåˆæ¬¡ä½¿ç”¨" class="headerlink" title="Markdownåˆæ¬¡ä½¿ç”¨"></a>Markdownåˆæ¬¡ä½¿ç”¨</h1><p><strong>Markdown</strong>æ˜¯ä¸€é—¨è½»é‡çº§è¯­æ³•,ä»…ä»…éœ€è¦5åˆ†é’Ÿä½ å°±èƒ½ææ‡‚!</p><h2 id="æœŸæœ«åˆ·jspä½œä¸šå¿ƒå¾—"><a href="#æœŸæœ«åˆ·jspä½œä¸šå¿ƒå¾—" class="headerlink" title="æœŸæœ«åˆ·jspä½œä¸šå¿ƒå¾—"></a>æœŸæœ«åˆ·jspä½œä¸šå¿ƒå¾—</h2><ul><li><strong>DAOå±‚å°è£…æˆå·¥å…·ç±»</strong> ï¼šæŒä¹…å±‚å¤„ç†ä¸šåŠ¡,å°½é‡æŠŠå˜åŒ–ä¸œè¥¿é‡‡ç”¨æ•°ç»„éå†,çº¦å®šæˆä¿—ç®€åŒ–æˆé…ç½®åŒ–å†™ï¼›</li><li><strong>ç™»é™†æ³¨å†Œæ¨¡å—é‡ç”¨</strong> ï¼šå‰ç«¯æ ·å¼å˜åŒ–,ä½†å°½é‡ä¸è¦ä¿®æ”¹æäº¤å‚æ•°åç§°å’Œä¸ªæ•°ï¼›</li><li><strong>å•å…ƒæµ‹è¯•ç±»</strong> ï¼šä½¿ç”¨ junitæµ‹è¯•æ¡†æ¶æ£€æŸ¥é€»è¾‘æ˜¯å¦æœ‰è¯¯,æ–¹ä¾¿éƒ¨ç½²è°ƒè¯• ã€‚</li></ul><hr><h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œæ›´æ–°æ“ä½œ----å¸¦é¢„ç¼–è¯‘å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">excuteUpdate</span><span class="params">(String sql, String[] params)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">pstmt = getCon().prepareStatement(sql);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">pstmt.setString(i + <span class="number">1</span>, params[i]);</span><br><span class="line">&#125;</span><br><span class="line">result = pstmt.executeUpdate();</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">pstmtClose();</span><br><span class="line">conClose();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>##ä»¥åå°†ä¼šæŒç»­æ›´æ–°,é¢„å‘Š webmagic æ¡†æ¶çˆ¬è™«ä¸‹æ¬¡å‡º</p><h2 id="åé¦ˆä¸å»ºè®®"><a href="#åé¦ˆä¸å»ºè®®" class="headerlink" title="åé¦ˆä¸å»ºè®®"></a>åé¦ˆä¸å»ºè®®</h2><ul><li>é‚®ç®±ï¼š<a href="mailto:&#x63;&#x61;&#111;&#99;&#104;&#x69;&#x6b;&#97;&#105;&#64;&#x71;&#113;&#46;&#99;&#111;&#x6d;">&#x63;&#x61;&#111;&#99;&#104;&#x69;&#x6b;&#97;&#105;&#64;&#x71;&#113;&#46;&#99;&#111;&#x6d;</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Markdownåˆæ¬¡ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#Markdownåˆæ¬¡ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;Markdownåˆæ¬¡ä½¿ç”¨&quot;&gt;&lt;/a&gt;Markdownåˆæ¬¡ä½¿ç”¨&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Markdown&lt;/strong&gt;æ˜¯ä¸€é—¨è½»é‡
      
    
    </summary>
    
    
    
  </entry>
  
</feed>

[{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šå‚æ•°å’Œç»“æœé›†å¤„ç†","date":"2019-12-26T10:28:00.000Z","path":"2019/12/26/MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šå‚æ•°å’Œç»“æœé›†å¤„ç†/","text":"2.8ã€binding æ¨¡å— org.apache.ibatis.bindingæ¨¡å—æ˜¯ä¸ºäº†è§£å†³Mapperç±»æ¥å£å’Œå¯¹åº”Xmlé…ç½®æ–‡ä»¶ä¹‹é—´æ˜ å°„ï¼Œé€šå¸¸Mapperæ¥å£å®šä¹‰äº†SQLè¯­å¥å¯¹åº”çš„æ–¹æ³•ï¼Œè€Œxmlé‡Œé¢é…ç½®äº†å¯¹åº”çš„SQLè¯­å¥ï¼Œæ‰€ä»¥åœ¨Mybatisåˆå§‹åŒ–çš„æ—¶å€™ç¼–è¯‘å™¨ä¼šæ£€æŸ¥é…ç½®Mapperå’Œxmlï¼Œå¹¶å…³è”èµ·æ¥ã€‚ç‰¹åˆ«åœ¨å‚æ•°å¤„ç†é‚£å—éå¸¸å¤æ‚ï¼Œéœ€è¦ç»™ä½çœ‹å®˜çš„è€å¿ƒåˆ†æï¼Œä¸‹é¢å°±è¦å…ˆä»æ ¸å¿ƒç»„ä»¶å…³ç³»å…¥æ‰‹ï¼š upload successful 2.8.1 MapperRegistry&amp;MapperProxyFactory XXXRegistryçœ‹åç¼€å‘½åé£æ ¼å°±çŸ¥é“åˆæ˜¯ä¸ªæ³¨å†Œç±»ï¼ŒMapperRegistryæ˜¯Mapperæ¥å£åŠå…¶å¯¹åº”çš„ä»£ç†å¯¹è±¡å·¥å‚çš„æ³¨å†Œä¸­å¿ƒã€‚Configurationæ˜¯MyBatis å…¨å±€æ€§çš„é…ç½®å¯¹è±¡ï¼Œåœ¨MyBatisåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰é…ç½®ä¿¡æ¯ä¼šè¢«è§£ææˆç›¸åº”çš„å¯¹è±¡å¹¶è®°å½•åˆ°Configurationå¯¹è±¡ä¸­ï¼Œåé¢ä»‹ç»MyBatisåˆå§‹åŒ–è¿‡ç¨‹æ—¶ä¼šè¯¦ç»†ä»‹ç»Configurationã€‚æˆ‘é‡ç‚¹è¦å…³æ³¨Configuration.mapperRegistryå±æ€§ï¼Œå®ƒè®°å½•å½“å‰ä½¿ç”¨çš„MapperRegistryå¯¹è±¡ï¼Œä¸‹é¢å°±è®©å°±è¿›è¡Œæºç å¯¼è¯»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106package org.apache.ibatis.binding;import ...public class MapperRegistry &#123;//Configurationå¯¹è±¡å…¨å±€å”¯ä¸€çš„é…ç½®å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰çš„é…ç½®ä¿¡æ¯ private final Configuration config;//è®°å½•Mapperæ¥å£ä¸MapperProxyFactoryä¹‹é—´çš„å¯¹åº”å…³ç³»,//keyä¸ºMapperæ¥å£Classï¼Œvalueå¯¹åº”çš„ä»£ç†å·¥å‚å¯¹è±¡MapperProxyFactory private final Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = new HashMap&lt;&gt;(); public MapperRegistry(Configuration config) &#123; this.config = config; &#125;//é€šè¿‡Class typeè·å–MapperProxyFactoryå·¥å‚å¯¹è±¡ public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123; final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type); if (mapperProxyFactory == null) &#123; throw new BindingException(\"Type \" + type + \" is not known to the MapperRegistry.\"); &#125; try &#123;//ä¼ å…¥sqlSessionä¸ºMapperæ¥å£åˆ›å»ºjdkåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œä¸‹é¢ä¼šè¯¦ç»†åˆ†æmapperProxyFactoryåˆ›å»ºè¿‡ç¨‹ return mapperProxyFactory.newInstance(sqlSession); &#125; catch (Exception e) &#123; throw new BindingException(\"Error getting mapper instance. Cause: \" + e, e); &#125; &#125;//Classç±»å‹åˆ¤æ–­knownMappersæ˜¯å¦å­˜åœ¨è¯¥Mapperæ¥å£ public &lt;T&gt; boolean hasMapper(Class&lt;T&gt; type) &#123; return knownMappers.containsKey(type); &#125;//åŠ è½½å®Œé…ç½®æ–‡ä»¶å’Œç±»ä¸Šæ³¨è§£ï¼Œå°†è§£æçš„mapperæ¥å£é€šè¿‡addMapperæ–¹æ³•æ·»åŠ åˆ°MapperRegistry.knownMappers, public &lt;T&gt; void addMapper(Class&lt;T&gt; type) &#123;//åˆ¤æ–­æ˜¯å¦æ˜¯æ¥å£ if (type.isInterface()) &#123;//æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œé¿å…é‡å¤è¯»å– if (hasMapper(type)) &#123; throw new BindingException(\"Type \" + type + \" is already known to the MapperRegistry.\"); &#125;//æ ‡å¿—æ˜¯å¦å®ŒæˆloadåŠ è½½ boolean loadCompleted = false; try &#123;//å°†Mapperæ¥å£å¯¹åº”çš„Classå¯¹è±¡å’ŒMapperproxyFactoryå¯¹è±¡æ·»åŠ åˆ°knownMappersé›†åˆ knownMappers.put(type, new MapperProxyFactory&lt;&gt;(type)); // It's important that the type is added before the parser is run // otherwise the binding may automatically be attempted by the // mapper parser. If the type is already known, it won't try.//è¿™ä¸ªæ¶‰åŠåˆ°xmlè§£æå’Œæ³¨è§£æ–¹é¢çš„å¤„ç†ï¼Œåé¢å†è¯¦ç»†è§£ç­” MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type); parser.parse(); loadCompleted = true; &#125; finally &#123; if (!loadCompleted) &#123; knownMappers.remove(type); &#125; &#125; &#125; &#125; /**é€šè¿‡knownMappersè·å–Classé›†åˆï¼Œè¯¥é›†åˆä¸ºä¸å¯å˜å®¹å™¨unmodifiableCollectionï¼Œé¿å…è¢«ä¿®æ”¹åªèƒ½è¢«è¯»å– * @since 3.2.2 */ public Collection&lt;Class&lt;?&gt;&gt; getMappers() &#123; return Collections.unmodifiableCollection(knownMappers.keySet()); &#125; /**é€šè¿‡åŒ…åè·¯å¾„è¯»å–æŒ‡å®šsuperTypeçˆ¶ç±»çš„mapperï¼ˆåŒ…æ‰«æï¼‰ * @since 3.2.2 */ public void addMappers(String packageName, Class&lt;?&gt; superType) &#123; ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;&gt;(); resolverUtil.find(new ResolverUtil.IsA(superType), packageName); Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; mapperSet = resolverUtil.getClasses(); for (Class&lt;?&gt; mapperClass : mapperSet) &#123; addMapper(mapperClass); &#125; &#125; //...addMappersé‡è½½&#125;package org.apache.ibatis.binding;import ...public class MapperProxyFactory&lt;T&gt; &#123;//å½“å‰MapperProxyFactoryå·¥å‚å¯¹åº”çš„äº§å“mapperInterfaceæ¥å£//æ¢è€Œè¨€ä¹‹å°±æ˜¯ä¸€ä¸ªå·¥å‚åªèƒ½ç”Ÿäº§ä¸€ç§äº§å“ private final Class&lt;T&gt; mapperInterface;//è¯¥mapperInterfaceæ¥å£ä¸‹å¯¹åº”çš„æ–¹æ³•é›†åˆï¼Œkeyä¸ºjava.lang.reflect.Methodï¼Œvalueä¸ºMapperMethodå¯¹è±¡ private final Map&lt;Method, MapperMethod&gt; methodCache = new ConcurrentHashMap&lt;&gt;();//...geter/setteræ–¹æ³•å’Œæ„é€ å™¨ @SuppressWarnings(\"unchecked\") protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123; return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy); &#125;//åˆ›å»ºå®ç°äº†mapperInterfaceæ¥å£çš„ä»£ç†å¯¹è±¡ public T newInstance(SqlSession sqlSession) &#123; final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache); return newInstance(mapperProxy); &#125;&#125; 2.8.2 MapperProxyä»£ç† MapperProxyå®ç°äº†InvocationHandleræ¥å£ï¼Œæ¥å£å®ç°æ–¹æ³•å°±æ˜¯JDKåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ–¹æ³•é€»è¾‘ï¼Œä¸‹é¢è®¤çœŸåˆ†æé’ˆå¯¹mapperä»£ç†é€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package org.apache.ibatis.binding;import ...public class MapperProxy&lt;T&gt; implements InvocationHandler, Serializable &#123;//java.lang.invoke.MethodHandles.Lookupæ˜¯è¢«å…è®¸è®¿é—®çš„æˆå‘˜ç±»å‹ï¼ˆè®¿é—®æƒé™ä¿®é¥°ç¬¦ï¼‰ private static final int ALLOWED_MODES = MethodHandles.Lookup.PRIVATE | MethodHandles.Lookup.PROTECTED | MethodHandles.Lookup.PACKAGE | MethodHandles.Lookup.PUBLIC;//åŠ¨æ€ä»£ç†Constructor private static final Constructor&lt;Lookup&gt; lookupConstructor;//ç§æœ‰è®¿é—®ç±»å‹çš„æ–¹æ³• private static final Method privateLookupInMethod;//å…¨å±€å¼•ç”¨çš„sqlSessionå¯¹è±¡ private final SqlSession sqlSession;//æ¥å£å¯¹åº”çš„Classå¯¹è±¡ private final Class&lt;T&gt; mapperInterface;//methodCacheç¼“å­˜æ–¹æ³•é›†åˆkeyä¸ºMethodå¯¹è±¡ï¼Œvalueä¸ºå¯¹åº”çš„MapperMethod private final Map&lt;Method, MapperMethod&gt; methodCache;//...çœç•¥æ„é€ å™¨ @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123;//å¦‚æœç›®æ ‡æ–¹æ³•ç»§æ‰¿è‡ªobjectï¼Œåˆ™ç›´æ¥è°ƒç”¨ç›®æ ‡æ–¹æ³• if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, args); &#125; else if (method.isDefault()) &#123;//æ˜¯å¦çš„é»˜è®¤æ–¹æ³•ï¼ˆpublic non-abstractï¼‰ if (privateLookupInMethod == null) &#123;//é’ˆå¯¹jdk8ç‰ˆæœ¬é»˜è®¤æ–¹æ³•å¤„ç† return invokeDefaultMethodJava8(proxy, method, args); &#125; else &#123;//é’ˆå¯¹jdk9ç‰ˆæœ¬é»˜è®¤æ–¹æ³•å¤„ç† return invokeDefaultMethodJava9(proxy, method, args); &#125; &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125;//ä¼˜å…ˆåœ¨ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰å°±newä¸€ä¸ªï¼Œå…·ä½“çœ‹ä¸‹é¢cachedMapperMethodæ–¹æ³• final MapperMethod mapperMethod = cachedMapperMethod(method); return mapperMethod.execute(sqlSession, args); &#125;//æ–°ç‰ˆæœ¬çš„mybatis private MapperMethod cachedMapperMethod(Method method) &#123; return methodCache.computeIfAbsent(method, k -&gt; new MapperMethod(mapperInterface, method, sqlSession.getConfiguration())); &#125;//...çœç•¥æ–¹æ³•invokeDefaultMethodJava8å’ŒinvokeDefaultMethodJava9&#125; 2.8.3 MapperMethod MapperMethodå°è£…äº†æ¥å£ä¸­å¯¹åº”çš„æ–¹æ³•çš„å…ƒä¿¡æ¯ï¼Œä»¥åŠå¯¹åº”çš„SQLè¯­å¥ï¼Œä¸å¼€å‘è€…æ¯æ¯ç›¸å…³ã€‚å¦ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„SqlCommandæ˜¯MapperMethodä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œå®ƒä½¿ç”¨nameå­—æ®µè®°å½•äº†SQLè¯­å¥çš„åç§°ï¼Œä½¿ç”¨typeå­—æ®µï¼ˆSqlCommandTypeç±»å‹ï¼‰è®°å½•äº†SQLè¯­å¥çš„ç±»å‹ã€‚SqlCommandTypeæ˜¯æšä¸¾ç±»å‹ï¼Œæœ‰æ•ˆå–å€¼ä¸ºUNKNOWNã€INSERTã€UPDATEã€DELETEã€SELECTã€FLUSHã€‚MapperMethodæºç æ¯”è¾ƒå¤æ‚ï¼Œå…ˆåˆ†æMapperMethodå­—æ®µä¿¡æ¯ï¼Œåé¢ä¼šæ‹†åˆ†SqlCommandã€MethodSignatureå’ŒParamNameResolveråˆ†æï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273declaringClasspackage org.apache.ibatis.binding;import ...public class MapperMethod &#123;//SqlCommandè®°å½•SQLè¯­å¥çš„åç§°å’Œç±»å‹ private final SqlCommand command;//Mapperæ¥å£ä¸­çš„æ–¹æ³•ç­¾åå’Œç›¸å…³ä¿¡æ¯ï¼ŒMethodSignatureä¹Ÿæ˜¯MapperMethodçš„å†…éƒ¨ç±» private final MethodSignature method; public MapperMethod(Class&lt;?&gt; mapperInterface, Method method, Configuration config) &#123; this.command = new SqlCommand(config, mapperInterface, method); this.method = new MethodSignature(config, mapperInterface, method); &#125; public static class SqlCommand &#123;//SQLè¯­å¥çš„åç§° private final String name;//SqlCommandTypeæšä¸¾ç±»å‹ï¼šUNKNOWNã€INSERTã€UPDATEã€DELETEã€SELECTã€FLUSH private final SqlCommandType type; public SqlCommand(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;//åˆæ­¥æ˜¯å…ˆè·å–æ–¹æ³•åç§° final String methodName = method.getName();//æ–¹æ³•çš„Method.clazzå±æ€§ï¼Œä¸»è¦ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºçˆ¶æ¥å£ä¿¡æ¯ final Class&lt;?&gt; declaringClass = method.getDeclaringClass(); MappedStatement ms = resolveMappedStatement(mapperInterface, methodName, declaringClass, configuration);//æ£€æŸ¥MappedStatementæ˜¯å¦åˆ›å»ºæˆåŠŸ if (ms == null) &#123;//å¤„ç†@Flushæ³¨è§£ if (method.getAnnotation(Flush.class) != null) &#123; name = null; type = SqlCommandType.FLUSH; &#125; else &#123; throw new BindingException(\"Invalid bound statement (not found): \" + mapperInterface.getName() + \".\" + methodName); &#125; &#125; else &#123;//åˆå§‹åŒ–nameå’Œtype name = ms.getId(); type = ms.getSqlCommandType(); if (type == SqlCommandType.UNKNOWN) &#123; throw new BindingException(\"Unknown execution method for: \" + name); &#125; &#125; &#125;//è§£æåˆ›å»ºMappedStatementï¼ˆSQLè¯­å¥å…¨éƒ¨å…·ä½“ä¿¡æ¯ï¼‰ï¼Œåé¢å†é‡ç‚¹ä»‹ç» private MappedStatement resolveMappedStatement(Class&lt;?&gt; mapperInterface, String methodName, Class&lt;?&gt; declaringClass, Configuration configuration) &#123;//SQLè¯­å¥çš„åç§°æ˜¯ç”±Mapperæ¥å£çš„åç§°ä¸å¯¹åº”çš„æ–¹æ³•åç§°ç»„æˆçš„ String statementId = mapperInterface.getName() + \".\" + methodName;//å…ˆä»Configuration.mappedStatementsé›†åˆæŸ¥è¯¢ç¼“å­˜ if (configuration.hasStatement(statementId)) &#123; return configuration.getMappedStatement(statementId); &#125; else if (mapperInterface.equals(declaringClass)) &#123;//å¦‚æœæ²¡æœ‰çˆ¶ç±»æ¥å£ï¼Œä¹Ÿæ²¡æœ‰è¯¥sqlã€æ–¹æ³•è®°å½•ï¼Œé‚£å°±æ²¡æœ‰äº† return null; &#125;//MappperMethodåœ¨çˆ¶æ¥å£é‡Œé¢ for (Class&lt;?&gt; superInterface : mapperInterface.getInterfaces()) &#123;//é€’å½’æŸ¥æ‰¾çˆ¶æ¥å£ç±»å‹æ˜¯declaringClassçš„MappedStatement if (declaringClass.isAssignableFrom(superInterface)) &#123; MappedStatement ms = resolveMappedStatement(superInterface, methodName, declaringClass, configuration); if (ms != null) &#123; return ms; &#125; &#125; &#125; return null; &#125;//...å…ˆçœç•¥å…·ä½“æ–¹æ³•åé¢å†åˆ†æ&#125; MapperMethodå¦ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å†…éƒ¨ç±»MethodSignatureï¼Œé€šè¿‡ParamNameResolverå¤„ç†æ¥å£æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ã€‚ParamNameResolverçš„nameå­—æ®µï¼ˆSortedMap&lt;Integerï¼ŒString&gt;ç±»å‹ï¼‰ï¼Œå…¶ä¸­keyè¡¨ç¤ºå‚æ•°åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®ï¼Œvalue è¡¨ç¤ºå‚æ•°åç§°ï¼Œå‚æ•°åç§°å¯ä»¥é€šè¿‡@Paramæ³¨è§£æŒ‡å®šï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š@Paramæ³¨è§£ï¼Œåˆ™ä½¿ç”¨å‚æ•°ç´¢å¼•ä½œä¸ºå…¶åç§°ã€‚å¦‚æœå‚æ•°åˆ—è¡¨ä¸­åŒ…å«RowBoundsæˆ–ResultHandlerç±»å‹çš„å‚æ•°ï¼Œåˆ™è¿™ä¸¤ç§ç±»å‹çš„å‚æ•°å¹¶ä¸ä¼šè¢«è®°å½•åˆ°nameé›†åˆä¸­ï¼Œè¿™å°±ä¼šå¯¼è‡´å‚æ•°çš„ç´¢å¼•ä¸åç§°ä¸ä¸€è‡´ã€‚ä¸‹é¢æºç å¯¼è¯»ä¸­è®²è§£åˆ°ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798package org.apache.ibatis.reflection;import ...public class ParamNameResolver &#123;//ä¸‹æ ‡å€¼çš„å‰ç¼€åç§° private static final String GENERIC_NAME_PREFIX = \"param\"; /** * &lt;p&gt;keyä¸ºindexç´¢å¼•ï¼ˆåŒºåˆ«äºçœŸå®ç´¢å¼•ï¼Œæ¢è€Œè¨€ä¹‹ä¸ºæŒ‰ç…§çœŸæ­£çš„å‚æ•°argsä¸‹æ ‡æ¥ï¼‰ * valueä¸ºå‚æ•°å˜é‡å(é€šè¿‡) * The key is the index and the value is the name of the parameter.&lt;br /&gt; * The name is obtained from &#123;@link Param&#125; if specified. When &#123;@link Param&#125; is not specified, * the parameter index is used. Note that this index could be different from the actual index * when the method has special parameters (i.e. &#123;@link RowBounds&#125; or &#123;@link ResultHandler&#125;). * &lt;/p&gt; * &lt;ul&gt;å®˜æ–¹çš„ä¸¾ä¾‹ï¼š * &lt;li&gt;aMethod(@Param(\"M\") int a, @Param(\"N\") int b) -&amp;gt; &#123;&#123;0, \"M\"&#125;, &#123;1, \"N\"&#125;&#125;&lt;/li&gt; * &lt;li&gt;aMethod(int a, int b) -&amp;gt; &#123;&#123;0, \"0\"&#125;, &#123;1, \"1\"&#125;&#125;&lt;/li&gt; * &lt;li&gt;aMethod(int a, **RowBounds rb**, int b) -&amp;gt; &#123;&#123;0, \"0\"&#125;, &#123;2, \"1\"&#125;&#125;&lt;/li&gt; * &lt;/ul&gt; */ private final SortedMap&lt;Integer, String&gt; names;//æ ‡å¿—æ˜¯å¦ä½¿ç”¨äº†**@Paramæ³¨è§£** private boolean hasParamAnnotation; public ParamNameResolver(Configuration config, Method method) &#123;//é€šè¿‡åå°„è·å–å‚æ•°ç±»å‹æ•°ç»„ final Class&lt;?&gt;[] paramTypes = method.getParameterTypes();//è·å–æ–¹æ³•ä¸Šçš„äºŒç»´æ•°ç»„æ³¨è§£ final Annotation[][] paramAnnotations = method.getParameterAnnotations();//è¿™ä¸ªmapä¼šåœ¨æœ€åè½¬åŒ–æˆä¸å¯å˜å®¹å™¨é›†åˆunmodifiableSortedMap final SortedMap&lt;Integer, String&gt; map = new TreeMap&lt;&gt;(); int paramCount = paramAnnotations.length; //éå†æ³¨è§£ get names from @Param annotations for (int paramIndex = 0; paramIndex &lt; paramCount; paramIndex++) &#123;//åˆ¤æ–­ç‰¹æ®Šç±»å‹RowBoundsæˆ–è€…ResultHandlerï¼Œå‘ç°åˆ™ç›´æ¥è·³è¿‡æœ¬æ¬¡éå† if (isSpecialParameter(paramTypes[paramIndex])) &#123; // skip special parameters continue; &#125; String name = null; for (Annotation annotation : paramAnnotations[paramIndex]) &#123; if (annotation instanceof Param) &#123;//åªè¦å‡ºç°Paramæ³¨è§£ä¸€æ¬¡ç«‹åˆ»è®¾ç½®æ ‡å¿—hasParamAnnotationï¼Œç»“æŸéå†è¿”å›æŒ‡å®šçš„name hasParamAnnotation = true; name = ((Param) annotation).value(); break; &#125; &#125;//åˆ¤æ–­æ˜¯å¦æœ‰ç‰¹æ®Šname if (name == null) &#123; // @Paramæ²¡æœ‰æŒ‡å®šï¼Œæ ¹æ®Configuration.useActualParamNameï¼ˆé»˜è®¤trueï¼‰æ˜¯å¦ä½¿ç”¨å®é™…åç§° if (config.isUseActualParamName()) &#123;//getActualParamNameåœ¨ä¸‹é¢è§£æï¼ŒParamNameUtil.getParamNames(method).get(paramIndex); name = getActualParamName(method, paramIndex); &#125; if (name == null) &#123; // ä½¿ç”¨ç´¢å¼•å€¼use the parameter index as the name (\"0\", \"1\", ...) name = String.valueOf(map.size()); &#125; &#125;//è®°å½•åˆ°mapé›†åˆ map.put(paramIndex, name); &#125;//åˆå§‹åŒ–æˆä¸å¯å˜é›†åˆ names = Collections.unmodifiableSortedMap(map); &#125;//åˆ¤æ–­æ˜¯å¦æ˜¯RowBoundså’ŒResultHandlerä¸¤ç§ç±»å‹çš„å‚æ•° private static boolean isSpecialParameter(Class&lt;?&gt; clazz) &#123; return RowBounds.class.isAssignableFrom(clazz) || ResultHandler.class.isAssignableFrom(clazz); &#125;...&#125;package org.apache.ibatis.reflection;import ...//è·å–å‚æ•°åç§°çš„å·¥å…·ç±»public class ParamNameUtil &#123;//Methodå’ŒConstructorçš„çˆ¶ç±»éƒ½æ˜¯Executable public static List&lt;String&gt; getParamNames(Method method) &#123; return getParameterNames(method); &#125; public static List&lt;String&gt; getParamNames(Constructor&lt;?&gt; constructor) &#123; return getParameterNames(constructor); &#125; private static List&lt;String&gt; getParameterNames(Executable executable) &#123;//é€šè¿‡çˆ¶ç±»Executableè·å–å‚æ•°åˆ—è¡¨çš„åå­—é›†åˆ return Arrays.stream(executable.getParameters()).map(Parameter::getName).collect(Collectors.toList()); &#125; private ParamNameUtil() &#123; super(); &#125;&#125; è§£æå®ŒParamNameResolverçš„åŠŸèƒ½ï¼Œå›åˆ°MethodSignatureç»§ç»­ç ”ç©¶ã€‚MethodSignatureä¹Ÿæ˜¯MapperMethodä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œå…¶ä¸­å°è£…äº†Mapperæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public static class MethodSignature &#123;//...çœç•¥å­—æ®µä¸‹é¢ä»‹ç» public MethodSignature(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123; //è§£ææ–¹æ³•ç±»å‹ä¿¡æ¯ï¼Œå…·ä½“åœ¨ä¹‹å‰åå°„å·¥å…·ç®±ä¸€ç« æåŠ Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface); if (resolvedReturnType instanceof Class&lt;?&gt;) &#123; this.returnType = (Class&lt;?&gt;) resolvedReturnType; &#125; else if (resolvedReturnType instanceof ParameterizedType) &#123; this.returnType = (Class&lt;?&gt;) ((ParameterizedType) resolvedReturnType).getRawType(); &#125; else &#123; this.returnType = method.getReturnType(); &#125;//è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºvoid this.returnsVoid = void.class.equals(this.returnType);//è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºCollectionæˆ–è€…æ•°ç»„ this.returnsMany = configuration.getObjectFactory().isCollection(this.returnType) || this.returnType.isArray();//è¿”å›å€¼æ˜¯å¦ä¸ºCursorç±»å‹ this.returnsCursor = Cursor.class.equals(this.returnType);//æ˜¯å¦Optionalå€¼å®¹å™¨ this.returnsOptional = Optional.class.equals(this.returnType);//è‹¥Methodsignatureå¯¹åº”æ–¹æ³•çš„è¿”å›å€¼æ˜¯Mapä¸”æŒ‡å®šäº†@MapKey æ³¨è§£ï¼Œåˆ™ä½¿ç”¨getMapKeyï¼ˆï¼‰æ–¹æ³•å¤„ç† this.mapKey = getMapKey(method); this.returnsMap = this.mapKey != null;//rowBoundsIndex(RowBoundså‚æ•°ä½ç½®)å’Œ resultHandlerIndexï¼ˆResultHandlerå‚æ•°ä½ç½®ï¼‰å­—æ®µ this.rowBoundsIndex = getUniqueParamIndex(method, RowBounds.class); this.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler.class);//åˆ›å»ºParamNameResolverå¯¹è±¡,åé¢ä¼šé‡ç‚¹ä»‹ç»getNamedParamsæ–¹æ³• this.paramNameResolver = new ParamNameResolver(configuration, method); &#125;//getUniqueParamIndexä¸»è¦åŠŸèƒ½æ˜¯æŸ¥æ‰¾æŒ‡å®šå‚æ•°ç±»å‹åœ¨æ–¹æ³•å‚æ•°çš„ç´¢å¼•ä½ç½® private Integer getUniqueParamIndex(Method method, Class&lt;?&gt; paramType) &#123; Integer index = null; final Class&lt;?&gt;[] argTypes = method.getParameterTypes(); for (int i = 0; i &lt; argTypes.length; i++) &#123; if (paramType.isAssignableFrom(argTypes[i])) &#123; if (index == null) &#123; index = i; &#125; else &#123;//RowBoundså’ŒResultHandlerç±»å‹çš„å‚æ•°åªèƒ½æœ‰ä¸€ä¸ªï¼Œä¸èƒ½é‡å¤å‡ºç° throw new BindingException(method.getName() + \" cannot have multiple \" + paramType.getSimpleName() + \" parameters\"); &#125; &#125; &#125; return index; &#125;&#125; ä¸è¯­æ³•æœ‰é‡è¦å…³ç³»è¿‡ç¨‹å°±åœ¨è¿™é‡Œï¼ŒParamNameResolveræœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•getNamedParamsï¼Œè´Ÿè´£å°†args[]æ•°ç»„ï¼ˆç”¨æˆ·ä¼ å…¥çš„å®å‚åˆ—è¡¨ï¼‰è½¬æ¢æˆSQLè¯­å¥å¯¹åº”çš„å‚æ•°åˆ—è¡¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536/** * &lt;p&gt; * A single non-special parameter is returned without a name. * Multiple parameters are named using the naming rule. * In addition to the default names, this method also adds the generic names (param1, param2, * ...). * &lt;/p&gt; */ public Object getNamedParams(Object[] args) &#123; final int paramCount = names.size();//æ²¡æœ‰ä»»ä½•å‚æ•° if (args == null || paramCount == 0) &#123; return null;//å¦‚æœæ²¡æœ‰æŒ‡å®š@Paramæˆ–è€…å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå‚æ•° &#125; else if (!hasParamAnnotation &amp;&amp; paramCount == 1) &#123; return args[names.firstKey()]; &#125; else &#123; final Map&lt;String, Object&gt; param = new ParamMap&lt;&gt;(); int i = 0; for (Map.Entry&lt;Integer, String&gt; entry : names.entrySet()) &#123;//å°†nameså±æ€§SortedMap&lt;Integerï¼ŒString&gt;ç±»å‹åè½¬//namesçš„valueï¼ˆå‚æ•°åï¼‰ä¸ºparamæ–°é›†åˆçš„keyï¼Œnamesçš„keyï¼ˆå‚æ•°ç´¢å¼•ï¼‰ä¸ºparamæ–°é›†åˆçš„value param.put(entry.getValue(), args[entry.getKey()]); //å‚æ•°ç´¢å¼•æ·»åŠ å‰ç¼€ã€å¹¶ä¸”ä»i + 1ï¼ˆ1ã€2ã€3å¼€å§‹ï¼‰//ä¾‹å­ï¼šadd generic param names (param1, param2, ...) final String genericParamName = GENERIC_NAME_PREFIX + String.valueOf(i + 1); // ensure not to overwrite parameter named with @Param//ç¡®ä¿ä¸ä¼šè¦†ç›–@ParamæŒ‡å®šçš„ç‰¹æ®Šå‚æ•°åï¼Œæ¢è€Œè¨€ä¹‹å°±æ˜¯é€šè¿‡param1æˆ–è€…@Paraméƒ½å¯ä»¥å–åˆ°åŒæ ·çš„å‚æ•° if (!names.containsValue(genericParamName)) &#123; param.put(genericParamName, args[entry.getKey()]); &#125; i++; &#125; return param; &#125; &#125; æœ€åå°±æ˜¯ç»“æœé›†å¤„ç†ï¼Œä¹Ÿæ˜¯MapperMethodé‡è¦çš„æ–¹æ³•executeï¼Œå®ƒä¼šæ ¹æ®SQLè¯­å¥çš„ç±»å‹è°ƒç”¨SqlSessionå¯¹åº”çš„æ–¹æ³•å®Œæˆæ•°æ®åº“æ“ä½œã€‚å¦‚æœæ˜¯æ˜¯æŒ‡å®šäº†ResultHandlerï¼Œé‚£å°±é€šè¿‡org.apache.ibatis.binding.MapperMethod#executeWithResultHandlerå¤„ç†ç»“æœé›†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145public Object execute(SqlSession sqlSession, Object[] args) &#123; Object result; switch (command.getType()) &#123;//method.convertArgsToSqlCommandParamä¼šè°ƒç”¨ä¸Šé¢è§£é‡Šåˆ°çš„ParamNameResolver.getNamedParams//rowCountResultå¤„ç†æ–¹æ³•è¿”å›å€¼å½±å“è¡Œæ•°rowCountï¼Œè¿›è¡Œç»“æœç±»å‹è½¬æ¢ case INSERT: &#123; Object param = method.convertArgsToSqlCommandParam(args); result = rowCountResult(sqlSession.insert(command.getName(), param)); break; &#125; case UPDATE: &#123; Object param = method.convertArgsToSqlCommandParam(args); result = rowCountResult(sqlSession.update(command.getName(), param)); break; &#125; case DELETE: &#123; Object param = method.convertArgsToSqlCommandParam(args); result = rowCountResult(sqlSession.delete(command.getName(), param)); break; &#125; case SELECT: if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123; executeWithResultHandler(sqlSession, args); result = null;//è¿”å›çš„æ˜¯Collectionæ¥å£å®ç°ç±»æˆ–è€…æ•°ç»„ï¼Œç”±executeForManyæ–¹æ³•å¤„ç† &#125; else if (method.returnsMany()) &#123; result = executeForMany(sqlSession, args);//è¿”å›çš„æ˜¯Mapé›†åˆç»“æœï¼Œç”±executeForMapæ–¹æ³•å¤„ç† &#125; else if (method.returnsMap()) &#123; result = executeForMap(sqlSession, args);//è¿”å›çš„æ˜¯Cursorç»“æœ &#125; else if (method.returnsCursor()) &#123; result = executeForCursor(sqlSession, args); &#125; else &#123;//æœ€åæŸ¥è¯¢ç»“æœåªæœ‰ä¸€æ¡ Object param = method.convertArgsToSqlCommandParam(args); result = sqlSession.selectOne(command.getName(), param);//å¦‚æœæ˜¯OptionalåŒ…è£…è¿”å›å€¼ if (method.returnsOptional() &amp;&amp; (result == null || !method.getReturnType().equals(result.getClass()))) &#123;//é‚£å°±è¿›è¡ŒOptionalåŒ…è£… result = Optional.ofNullable(result); &#125; &#125; break; case FLUSH: result = sqlSession.flushStatements(); break; default: throw new BindingException(\"Unknown execution method for: \" + command.getName()); &#125;//è¾¹ç•Œæ£€æŸ¥ if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123; throw new BindingException(\"Mapper method '\" + command.getName() + \" attempted to return null from a method with a primitive return type (\" + method.getReturnType() + \").\"); &#125; return result; &#125;private void executeWithResultHandler(SqlSession sqlSession, Object[] args) &#123;//è·å–SOLè¯­å¥å¯¹åº”çš„MappedStatementå¯¹è±¡ï¼ŒMappedStatementä¸­è®°å½•äº†SQLè¯­å¥ç›¸å…³ä¿¡æ¯ï¼Œ MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(command.getName());//StatementTypeä¸æ˜¯å­˜å‚¨è¿‡ç¨‹ï¼ˆCALLABLEï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡å®šResultMapæˆ–ResultTypeï¼Œç›´æ¥æŠ›å‡ºBindingException if (!StatementType.CALLABLE.equals(ms.getStatementType()) &amp;&amp; void.class.equals(ms.getResultMaps().get(0).getType())) &#123; throw new BindingException(\"method \" + command.getName() + \" needs either a @ResultMap annotation, a @ResultType annotation,\" + \" or a resultType attribute in XML so a ResultHandler can be used as a parameter.\"); &#125; Object param = method.convertArgsToSqlCommandParam(args);//è¯¥æ–¹æ³•æ˜¯å¦æœ‰RowBoundsç±»å‹å‚æ•° if (method.hasRowBounds()) &#123;//è·å–æŒ‡å®šRowBoundsç±»å‹çš„å‚æ•° RowBounds rowBounds = method.extractRowBounds(args);//é€šè¿‡sqlSession.selectæŸ¥è¯¢æ–¹æ³•æŒ‡å®šæŸ¥è¯¢ï¼Œå¹¶ç”±æŒ‡å®šçš„ResultHandlerå¤„ç†ç»“æœå¯¹è±¡ sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args)); &#125; else &#123; sqlSession.select(command.getName(), param, method.extractResultHandler(args)); &#125; &#125;//Collectionæ¥å£å®ç°ç±»æˆ–è€…æ•°ç»„å¤„ç†è¿‡ç¨‹private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object[] args) &#123; List&lt;E&gt; result; Object param = method.convertArgsToSqlCommandParam(args);//å‚è€ƒä¸Šå‡ å¥ if (method.hasRowBounds()) &#123; RowBounds rowBounds = method.extractRowBounds(args); result = sqlSession.selectList(command.getName(), param, rowBounds); &#125; else &#123; result = sqlSession.selectList(command.getName(), param); &#125;//å°†ç»“æœé›†è½¬æ¢ä¸ºæ•°ç»„æˆ–Collectioné›†åˆ issue #510 Collections &amp; arrays support if (!method.getReturnType().isAssignableFrom(result.getClass())) &#123; if (method.getReturnType().isArray()) &#123; return convertToArray(result); &#125; else &#123;//æ ¹æ®Configurationå¯¹ç»“æœå¯¹è±¡çš„è½¬æ¢ç±»å‹ return convertToDeclaredCollection(sqlSession.getConfiguration(), result); &#125; &#125; return result; &#125;private &lt;E&gt; Object convertToDeclaredCollection(Configuration config, List&lt;E&gt; list) &#123;//ä½¿ç”¨å‰é¢ä»‹ç»çš„ObjectFactoryå¯¹è±¡å·¥å‚ï¼Œé€šè¿‡åå°„æ–¹å¼åˆ›å»ºé›†åˆå¯¹è±¡ Object collection = config.getObjectFactory().create(method.getReturnType());//åˆ›å»ºcollectioné›†åˆåå°„å¯¹è±¡MetaObjectï¼Œå®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨çš„CCollectionæ¥å£çš„addAllæ–¹æ³• MetaObject metaObject = config.newMetaObject(collection); metaObject.addAll(list); return collection; &#125; @SuppressWarnings(\"unchecked\") private &lt;E&gt; Object convertToArray(List&lt;E&gt; list) &#123;//è·å–æ•°ç»„çš„å…ƒç´ ç±»å‹ Class&lt;?&gt; arrayComponentType = method.getReturnType().getComponentType();//åˆ›å»ºæ•°ç»„å¯¹è±¡ Object array = Array.newInstance(arrayComponentType, list.size());//åˆ¤æ–­æ•°ç»„å…ƒç´ æ˜¯å¦åŸºæœ¬åŸå§‹ç±»å‹çš„ if (arrayComponentType.isPrimitive()) &#123;//å°†listæ¯ä¸€é¡¹æ•°æ®éƒ½æ”¾ç½®åˆ°æ•°ç»„ä¸­ for (int i = 0; i &lt; list.size(); i++) &#123; Array.set(array, i, list.get(i)); &#125; return array; &#125; else &#123;//å¦ç›´æ¥è½¬æ•°ç»„ return list.toArray((E[])array); &#125; &#125;//è¿”å›çš„æ˜¯Mapé›†åˆç»“æœï¼Œç”±executeForMapæ–¹æ³•å¤„ç†ï¼ŒCursorå¤„ç†æ–¹æ³•æ˜¯sqlSession.selectCursorprivate &lt;K, V&gt; Map&lt;K, V&gt; executeForMap(SqlSession sqlSession, Object[] args) &#123; Map&lt;K, V&gt; result;//è½¬åŒ–æˆå®å‚ Object param = method.convertArgsToSqlCommandParam(args); if (method.hasRowBounds()) &#123; RowBounds rowBounds = method.extractRowBounds(args);//è°ƒç”¨selectMapæ–¹æ³•è¿”å›ç»“æœå°±æ˜¯Mapç±»å‹ result = sqlSession.selectMap(command.getName(), param, method.getMapKey(), rowBounds); &#125; else &#123; result = sqlSession.selectMap(command.getName(), param, method.getMapKey()); &#125; return result; &#125;","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šTransactionäº‹åŠ¡","date":"2019-12-25T12:51:00.000Z","path":"2019/12/25/MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šTransactionäº‹åŠ¡/","text":"2.7ã€Transactionäº‹åŠ¡ æ§åˆ¶æ•°æ®åº“äº‹åŠ¡æ˜¯ä¸šåŠ¡å‹æ“ä½œï¼ˆCRUDï¼‰çš„åŸºæœ¬åŠŸï¼ŒMybatisæœ¬èº«é€šè¿‡Transaction(org.apache.ibatis.transaction)æ¥å£å¯¹æ•°æ®åº“è¿›è¡Œäº†æŠ½è±¡åŒ–ï¼Œå…·ä½“åˆ†æå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839package org.apache.ibatis.transaction;import java.sql.Connection;import java.sql.SQLException;/**åŒ…è£…æ•°æ®åº“è¿æ¥å…³äºåˆ›å»ºã€é¢„å¤„ç†ã€æäº¤/å›æ»šå’Œå…³é—­çš„ç”Ÿå‘½å‘¨æœŸ * Wraps a database connection. * Handles the connection lifecycle that comprises: * its creation, preparation, commit/rollback and close. */public interface Transaction &#123; /**è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡ * Retrieve inner database connection. * @return DataBase connection */ Connection getConnection() throws SQLException; /**æäº¤äº‹åŠ¡ * Commit inner database connection. */ void commit() throws SQLException; /**å›æ»šäº‹åŠ¡ * Rollback inner database connection. */ void rollback() throws SQLException; /**å…³é—­æ•°æ®åº“è¿æ¥ * Close inner database connection. */ void close() throws SQLException; /**è·å–äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ * Get transaction timeout if set. */ Integer getTimeout() throws SQLException;&#125; Transaction æ¥å£æœ‰JdbcTransactionã€ManagedTransactionä¸¤ä¸ªå®ç°ã€‚ManagedTransactionçš„å®ç°éå¸¸ç®€å•ï¼Œå®ƒåŒæ ·ä¾èµ–å…¶ä¸­çš„dataSourceå­—æ®µè·å–è¿æ¥ï¼Œä½†å…¶commitã€rollbackæ–¹æ³•éƒ½æ˜¯ç©ºå®ç°ï¼Œäº‹åŠ¡çš„æäº¤å’Œå›æ»šéƒ½æ˜¯ä¾é å®¹å™¨ç®¡ç†çš„ï¼Œå…³é—­æ–¹æ³•é€šè¿‡closeConnectionå­—æ®µçš„å€¼æ§åˆ¶æ•°æ®åº“è¿æ¥ã€‚JdbcTransactionä¾èµ–JDBC Connectionæ§åˆ¶æ•°æ®åº“äº‹åŠ¡ï¼Œæ¥ä¸‹å°±è¦è¿›å…¥å¯¹JdbcTransactionçš„åˆ†æï¼š 12345678910111213141516171819202122232425package org.apache.ibatis.transaction.jdbc;import.../**ä¸‹é¢æ“ä½œæ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨java.sql.Connectionç›´æ¥è¿›è¡Œæ“ä½œäº‹åŠ¡ï¼ŒgetTimeoutæ˜¯ç©ºå®ç° *å¦‚æœautocommitå·²ç»å¼€å¯ï¼Œé‚£ä¹ˆcommitå’Œrollbackæ–¹æ³•å°±ä¼šè¢«å¿½ç•¥æ‰ * &#123;@link Transaction&#125; that makes use of the JDBC commit and rollback facilities directly. * It relies on the connection retrieved from the dataSource to manage the scope of the transaction. * Delays connection retrieval until getConnection() is called. * Ignores commit or rollback requests when autocommit is on. * */public class JdbcTransaction implements Transaction &#123;//äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“è¿æ¥ protected Connection connection;//æ•°æ®åº“è¿æ¥å¯¹åº”çš„æ•°æ®æº protected DataSource dataSource;//äº‹åŠ¡çš„éš”ç¦»çº§åˆ« protected TransactionIsolationLevel level;//æ˜¯å¦è‡ªåŠ¨æäº¤ protected boolean autoCommit; ...çœç•¥ä¸‹é¢æ–¹æ³•å’Œæ„é€ å™¨&#125; JdbcTransactionã€ManagedTransactionä¸¤ä¸ªå®ç°ï¼Œå…¶å¯¹è±¡åˆ†åˆ«ç”±JdbcTransactionFactory å’ŒManaged TransactionFactoryè´Ÿè´£åˆ›å»ºã€‚è¿™é‡Œä¹Ÿä½¿ç”¨äº†å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚ä¸‹é¢å°±åˆ†æå·¥å‚åˆ›å»ºäº§å“UMLå’Œæ¥å£è§„èŒƒï¼š Transaction.png 123456789101112131415161718package org.apache.ibatis.transaction;import ...public interface TransactionFactory &#123;//æ¥å£é»˜è®¤æ–¹æ³•ï¼Œé€šå¸¸åœ¨åˆ›å»ºå®ŒTransactionåè¿›è¡Œè‡ªå®šä¹‰é…ç½®äº‹åŠ¡ default void setProperties(Properties props) &#123; // NOP &#125;//åœ¨æŒ‡å®šConnectionä¸Šåˆ›å»ºTransaction Transaction newTransaction(Connection conn);//ä»æŒ‡å®šçš„DataSourceè·å–æ•°æ®åº“è¿æ¥ï¼Œå¹¶åœ¨æ­¤è¿æ¥ä¹‹ä¸Šåˆ›å»ºäº‹åŠ¡å¯¹è±¡ï¼Œåé¢å°±ç®—é…ç½®TransactionIsolationLevelå’ŒautoCommit Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, boolean autoCommit);&#125; åœ¨å®è·µä¸­ï¼ŒMyBatisé€šå¸¸ä¼šä¸Springé›†æˆä½¿ç”¨ï¼Œæ•°æ®åº“çš„äº‹åŠ¡æ˜¯äº¤ç»™Springè¿›è¡Œç®¡ç†çš„ï¼Œä»¥åä¼šä»‹ç»Transactionæ¥å£çš„å¦ä¸€å®ç°SpringManagedTransactionã€‚","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è","date":"2019-12-24T09:33:00.000Z","path":"2019/12/24/ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨è/","text":"ideaæ’ä»¶ç¬¬äºŒå¼¹æ¨èå·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶ä¸€ã€æ¦‚å¿µ å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œåšä¸»æ˜¯ä¸ªæ­»å¿ å·¥å…·æ´¾ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªå¤§é—®é¢˜å¯èƒ½ä¼šæ”¶é›†å¤šä¸ªå·¥å…·å’Œæ–¹æ¡ˆï¼Œç„¶åæ±‚è¯å¯¹æ¯”å‡ºä½“éªŒæŠ¥å‘Šã€‚åç»­æ–‡ç« æœ‰ä¸€å¤§ç±»å°±æ˜¯å·¥å…·ç±»æ¨èï¼Œè€Œæœ¬ç¯‡æ–‡ç« é‡ç‚¹å°±æ˜¯idea å®‰è£…æ’ä»¶è®°å½•ï¼Œç®€è¦è®°å½•å®‰è£…æ–¹æ³•å¿«é€Ÿæ­å»ºä¸ªæ€§åŒ–ideaï¼Œè¿˜æœ‰ä¸€äº›å…³äºUIæ–¹é¢æ’ä»¶å¯è°“å¤šä¸èƒœæ•°ï¼Œè€Œä¸”æ¯ä¸ªäººå£å‘³ä¸ä¸€ï¼Œè¯·å„ä½è‡ªè¡Œé€‰æ‹©â€”â€”æ’ä»¶æœç´¢æŠ€å·§tagsä¸ºThemeæˆ–è€…UIã€‚ æ’ä»¶åˆ—è¡¨æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼ åç§° æè¿° JRebel ä»£æ›¿springboot devçƒ­éƒ¨ç½²æ–¹æ¡ˆï¼Œæœ€æ–¹ä¾¿æ¿€æ´»æ–¹å¼ Lombok ç²¾ç®€beanï¼Œå„ç§åŠŸèƒ½å¼ºå¤§åˆå®ç”¨æ³¨è§£ï¼Œæ¬ç –äººçš„MVPï¼Œç»“åˆHutoolå®åœ¨å®Œç¾ AceJump å…‰æ ‡è·³è·ƒï¼Œæ›¿ä»£vimä¸äºŒä¹‹é€‰ CodeGlance ä»£ç åœ°å›¾ï¼Œæ–¹ä¾¿æŸ¥é˜…è·³è½¬ MavenHelper å¿«é€Ÿåˆ†æmaven åŒ…å†²çªçš„é—®é¢˜ï¼Œæœç´¢åŒ…å MyBatis Log Plugin Restore the mybatis generate sql to original whole sql.ï¼ˆæ‹¼æ¥å®Œæ•´sqlï¼‰ Log Support 2 å¿«é€Ÿlog.info()ï¼Œç»“åˆLombokæ’ä»¶æ³¨è§£@Slf4jå¯ä»¥è¯´æ— æ•Œ Grep Console é’ˆå¯¹æ§åˆ¶å°æ—¥å¿—ä¸åŒç­‰çº§è¿›è¡ŒæŸ“è‰²é«˜äº® MyBatisCodeHelperPro å¯¹Mybatisæ”¯æŒéå¸¸å¼ºï¼Œè¯·è®¤çœŸå‚è€ƒhttps://gejun123456.github.io/MyBatisCodeHelper-Pro/#/READMEï¼Œæé«˜ç”Ÿäº§åŠ›çš„å·¥å…·å•Šï¼ˆæ”¶è´¹å¯ç ´è§£ï¼‰ï¼ Free Mybatis plugin Mybaitsæ”¯æŒè·³è½¬ï¼Œæœ‰é’±å¤§çˆ·è¯·æ”¶è´¹ç‰ˆMybatis pluginå¼ºå¤§ç ´è§£è¾ƒå°‘ï¼Œå·®è¯„ Rainbow Brackets å½©è™¹æ‹¬å·ï¼Œå¤šå±‚åµŒå¥—ä»£ç æ˜¾ç¤ºåŠ©æ‰‹ String Manipulation å¼ºå¤§çš„å­—ç¬¦ä¸²æ ¼å¼è½¬åŒ– GitToolBox gitçš„å¼ºå¤§åŠ©æ‰‹ï¼Œå®šæ—¶æ‹‰å–ä»£ç ã€ä»£ç é€è¡Œå±•ç¤ºæ—¥å¿—ï¼ˆå„ç§è¾…åŠ©é‡‘æ‰‹æŒ‡ï¼‰ RestfulToolkit è¾…åŠ©é€šè¿‡URLå®šä½Controllerï¼Œç®€æ´ç‰ˆçš„PostMan Alibaba Cloud Toolkit ç»“åˆé˜¿é‡Œäº‘ï¼ˆéé˜¿é‡Œä¹Ÿæ”¯æŒï¼‰ï¼Œå¤šèŠ‚ç‚¹å‘å¸ƒå·¥å…·åŠ å¼ºåŠ›linuxå®¢æˆ·ç«¯ stackoverflow stackoverflowå¿«é€Ÿæœç´¢bugæ’ä»¶ Translation æœ€å¼ºå¤§çš„ç¿»è¯‘æ’ä»¶ï¼Œæ”¯æŒä¸­æ–‡æ›¿æ¢è‹±æ–‡ï¼Œè§£å†³èµ·è‹±æ–‡å˜é‡åéš¾çš„é‡åº¦æ‚£è€… Key Promoter X æ‰€æœ‰æ“ä½œçš„å¿«æ·é”®æç¤ºï¼Œå¿˜è®°é¼ æ ‡çœŸçš„ Cyan Light Theme A light themeï¼Œåé’è‰²å¯¹çœ¼ç›å¾ˆæŸ”å’Œèˆ’æœï¼Œé»‘æš—ä¸»é¢˜å®åœ¨ä¸é€‚åº” Hiberbee theme é»‘æš—ä¸»é¢˜çš„è‰²å½©åˆ†æ˜ç‰ˆæœ¬ åé¦ˆä¸å»ºè®® 2012å¹´javaç¨‹åºå‘˜å¯ä»¥è¯´éå¸¸åƒé¦™ï¼Œä»Šå¹´2019ä»ä¸šäººæ•°æš´å¢ï¼ŒèŒä¸šå‘å±•æŒ‘æˆ˜å˜å¾—è¶Šæ¥è¶Šå¤§ï¼ç°åœ¨æµè¡Œè‡ªåŠ¨æ„å»ºå’Œè‡ªåŠ¨éƒ¨ç½²CIï¼Œå¼€å‘è¿ç»´ä¸€ä½“åŒ–dockerï¼Œæ•´ä¸ªäº’è”ç½‘éƒ½åœ¨è¿½æ±‚æ•æ·å¼€å‘çš„ä»Šå¤©ã€‚æŒæ¡ä¸€æ¬¾è¿½æ±‚æ•ˆç‡åŠŸèƒ½çš„IDEéå¸¸é‡è¦ï¼Œå¾ˆå¤šç¾¤å’Œå…¬ä¼—å·å¯¹ideå’ŒEclipseäº‰è®®å¾ˆå¤§ã€‚ä½†è¯·è®°ä½æ–¯å¤§æ—åè¨€â€”â€”è½åå°±è¦æŒ¨æ‰“ï¼Œideæœ¬èº«ä»£è¡¨é«˜æ•ˆï¼Œä½†æ˜¯æ’ä»¶ä¹Ÿåˆ«è£…å¤ªå¤šï¼Œå…å¾—å¯åŠ¨è¿˜è¦åŠå¤©å“ˆå“ˆå“ˆğŸ˜€ ï¼ˆé¦–æ¨ï¼‰æ…•è¯¾ç½‘å…è´¹æ•™ç¨‹ï¼šIntelliJ IDEAç¥å™¨ä½¿ç”¨æŠ€å·§ ï¼ˆæ¨èï¼‰å°šç¡…è°·IDEAè§†é¢‘æ•™ç¨‹ï¼šé“¾æ¥ï¼šhttps://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn çœ‹å®Œä¸Šé¢ä¸¤ä¸ªæ•™ç¨‹ï¼Œä½ ä¼šæ€€ç–‘è‡ªå·±ç”¨çš„ideaæ˜¯å‡çš„ï¼ŒåŸæ¥å†™ä»£ç è¿˜å¯ä»¥è¿™æ ·çš„ã€‚ é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"tool","slug":"tool","permalink":"https://caochikai.github.io/tags/tool/"},{"name":"plugin","slug":"plugin","permalink":"https://caochikai.github.io/tags/plugin/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šDataSourceæ•°æ®æº","date":"2019-12-23T10:20:00.000Z","path":"2019/12/23/MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šDataSourceæ•°æ®æº/","text":"2.6ã€DataSourceæ•°æ®æº æ•°æ®æºç»„ä»¶éƒ½è¦å®ç°javax.sql.DataSourceæ¥å£ï¼Œå¸¸è§çš„æœ‰Druidã€HikariCPå’ŒC3POã€‚Mybatisæä¾›ä¸¤ä¸ªå®ç°ï¼šPooledDataSourceå’ŒUnpooledDataSourceï¼Œé€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»ºã€‚ DataSourceFactory 123456789101112131415package org.apache.ibatis.datasource;import java.util.Properties;import javax.sql.DataSource;/** * @author Clinton Begin */public interface DataSourceFactory &#123; //é€šè¿‡Properties é…ç½®æ•°æ®æº void setProperties(Properties props); //å·¥å‚è·å–æ•°æ®æºå®ä¾‹æ¥å£ DataSource getDataSource();&#125; 2.6.2 DataSourceFactory æ•°æ®æºå·¥å‚æ¥å£çš„å®ç°ç±»æ˜¯DataSourceFactoryï¼ŒUnpooledDataSourceFactoryå’ŒPooledDataSourceæ˜¯å…·ä½“äº§å“å®ç°ç±»ï¼ŒJndiDataSourceFactoryæ˜¯ä¾èµ–JNDIæœåŠ¡ä»å®¹å™¨ä¸­è·å–ç”¨æˆ·é…ç½®çš„DataSourceï¼Œæˆ‘ä»¬ä»¥UnpooledDataSourceFactoryä¸¾ä¾‹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package org.apache.ibatis.datasource.unpooled;import java.util.Properties;import javax.sql.DataSource;import org.apache.ibatis.datasource.DataSourceException;import org.apache.ibatis.datasource.DataSourceFactory;import org.apache.ibatis.reflection.MetaObject;import org.apache.ibatis.reflection.SystemMetaObject;/** * @author Clinton Begin */public class UnpooledDataSourceFactory implements DataSourceFactory &#123; //å±æ€§å‰ç¼€ä¸ºdriver. private static final String DRIVER_PROPERTY_PREFIX = \"driver.\"; //driver.æ–‡å­—é•¿åº¦ private static final int DRIVER_PROPERTY_PREFIX_LENGTH = DRIVER_PROPERTY_PREFIX.length(); //æ•°æ®æºå±æ€§ protected DataSource dataSource; public UnpooledDataSourceFactory() &#123; this.dataSource = new UnpooledDataSource(); &#125; @Override public void setProperties(Properties properties) &#123; Properties driverProperties = new Properties(); //æ ¹æ®dataSourceåˆ›å»ºMetaObject ï¼ˆåå°„è·å–è¯¥å¯¹è±¡å…ƒæ•°æ®ï¼‰ MetaObject metaDataSource = SystemMetaObject.forObject(dataSource); for (Object key : properties.keySet()) &#123; String propertyName = (String) key; //æ£€æŸ¥å±æ€§åç§°æ˜¯å¦ä»¥driver.å¼€å¤´ if (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123; String value = properties.getProperty(propertyName); //æˆªå–driver.åè®°å½•åˆ°driverPropertiesæˆå‘˜å˜é‡ driverProperties.setProperty(propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value); &#125; else if (metaDataSource.hasSetter(propertyName)) &#123; //åˆ¤æ–­æ˜¯å¦æœ‰è¯¥å¯¹è±¡setå¯¹åº”çš„å±æ€§å String value = (String) properties.get(propertyName); //æ ¹æ®å±æ€§ç±»å‹è¿›è¡Œè½¬åŒ– Object convertedValue = convertValue(metaDataSource, propertyName, value); metaDataSource.setValue(propertyName, convertedValue); &#125; else &#123; throw new DataSourceException(\"Unknown DataSource property: \" + propertyName); &#125; &#125; if (driverProperties.size() &gt; 0) &#123; metaDataSource.setValue(\"driverProperties\", driverProperties); &#125; &#125; @Override public DataSource getDataSource() &#123; return dataSource; &#125;//æ”¯æŒå±æ€§ç±»å‹è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸»è¦æ˜¯Integerã€Longã€Booleanä¸‰ç§ç±»å‹çš„è½¬æ¢ private Object convertValue(MetaObject metaDataSource, String propertyName, String value) &#123; Object convertedValue = value; Class&lt;?&gt; targetType = metaDataSource.getSetterType(propertyName); if (targetType == Integer.class || targetType == int.class) &#123; convertedValue = Integer.valueOf(value); &#125; else if (targetType == Long.class || targetType == long.class) &#123; convertedValue = Long.valueOf(value); &#125; else if (targetType == Boolean.class || targetType == boolean.class) &#123; convertedValue = Boolean.valueOf(value); &#125; return convertedValue; &#125;&#125; 2.6.3 UnpooledDataSource javax.sql.DataSourceæ¥å£åœ¨æ•°æ®æºæ¨¡å—ä¸­æ‰®æ¼”äº†äº§å“æ¥å£çš„è§’è‰²ï¼ŒMyBatisæä¾›äº†ä¸¤ä¸ªDataSource æ¥å£çš„å®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯UnpooledDataSourceå’ŒPooledDataSourceï¼Œå®ƒä»¬æ‰®æ¼”ç€å…·ä½“äº§å“ç±»çš„è§’è‰²ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package org.apache.ibatis.datasource.unpooled;import ...public class UnpooledDataSource implements DataSource &#123;//æ•°æ®æºç±»åŠ è½½å™¨ private ClassLoader driverClassLoader;//é…ç½®å±æ€§å¯¹è±¡ private Properties driverProperties;//ç¼“å­˜æ³¨å†Œè¿‡çš„æ•°æ®æºé©±åŠ¨ private static Map&lt;String, Driver&gt; registeredDrivers = new ConcurrentHashMap&lt;&gt;();//é©±åŠ¨ private String driver;//æ•°æ®åº“URL private String url;//ç”¨æˆ·åå’Œå¯†ç  private String username; private String password;//æ˜¯å¦è‡ªåŠ¨æäº¤ private Boolean autoCommit;//é»˜è®¤äº‹åŠ¡éš”ç¦»ç­‰çº§ **private Integer defaultTransactionIsolationLevel;//ç½‘ç»œè¶…æ—¶æ—¶é—´ private Integer defaultNetworkTimeout; static &#123; Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers(); while (drivers.hasMoreElements()) &#123; Driver driver = drivers.nextElement();//å‘DriverManageræ·»åŠ JDBCé©±åŠ¨ registeredDrivers.put(driver.getClass().getName(), driver); &#125; &#125;... private Connection doGetConnection(Properties properties) throws SQLException &#123; //åˆå§‹åŒ–é©±åŠ¨Driverå¯¹è±¡ initializeDriver(); //åˆ›å»ºçœŸæ­£çš„æ•°æ®åº“é“¾æ¥å¯¹è±¡ Connection connection = DriverManager.getConnection(url, properties); //é…ç½®autoCommitã€defaultTransactionIsolationLevelå’ŒdefaultNetworkTimeout configureConnection(connection); return connection; &#125; private synchronized void initializeDriver() throws SQLException &#123;//åˆ¤æ–­æ³¨å†Œè¿‡ï¼Œé¿å…é‡å¤ if (!registeredDrivers.containsKey(driver)) &#123; Class&lt;?&gt; driverType; try &#123;//é€šè¿‡å¯¹åº”çš„ç±»åŠ è½½å™¨è·å¾—å¯¹åº”çš„driverType if (driverClassLoader != null) &#123; driverType = Class.forName(driver, true, driverClassLoader); &#125; else &#123; driverType = Resources.classForName(driver); &#125; // DriverManager requires the driver to be loaded via the system ClassLoader. // http://www.kfu.com/~nsayer/Java/dyn-jdbc.html//çœŸæ­£åˆ›å»ºDriverè¿‡ç¨‹ Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();//DriverProxyæ˜¯UnpooledDataSourceçš„å†…éƒ¨ç±»ï¼Œæ˜¯Driverçš„é™æ€ä»£ç†ç±» DriverManager.registerDriver(new DriverProxy(driverInstance)); registeredDrivers.put(driver, driverInstance); &#125; catch (Exception e) &#123; throw new SQLException(\"Error setting driver on UnpooledDataSource. Cause: \" + e); &#125; &#125; &#125;&#125; 2.6.4 PooledDataSource PooledDataSourceæ”¯æŒæ•°æ®åº“è¿æ¥æ± çš„æ•°æ®æºï¼Œä¾èµ–UnpooledDataSourceåˆ›å»ºæ•°æ®åº“è¿æ¥ã€‚è€Œä¸”PooledDataSource å¹¶ä¸ä¼šç›´æ¥ç®¡ç†java.sql.Connectionå¯¹è±¡ï¼Œè€Œæ˜¯ç®¡ç†PooledConnectionå¯¹è±¡ã€‚åœ¨PooledConnectionä¸­å°è£…äº†çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼ˆjava.sql.Connectionï¼‰ä»¥åŠå…¶ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œçš„ä»£ç†å¯¹è±¡æ˜¯é€šè¿‡JDKåŠ¨æ€ä»£ç†äº§ç”Ÿçš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162package org.apache.ibatis.datasource.pooled;import .../** * @author Clinton Begin */class PooledConnection implements InvocationHandler &#123;//å…³é—­çš„æ–¹æ³•åç§°ï¼Œå¹¶ä¸æ˜¯çœŸæ­£å…³é—­è€Œæ˜¯è¿”è¿˜åˆ°æ± å­ private static final String CLOSE = \"close\";//åŠ¨æ€ä»£ç†çš„ç±»Class private static final Class&lt;?&gt;[] IFACES = new Class&lt;?&gt;[] &#123; Connection.class &#125;;//connectionçš„å“ˆå¸Œå€¼ private final int hashCode; private final PooledDataSource dataSource;//çœŸæ­£çš„æ•°æ®åº“è¿æ¥ private final Connection realConnection;//æ•°æ®åº“è¿æ¥çš„ä»£ç†å¯¹è±¡ private final Connection proxyConnection;//å–å‡ºçš„æ—¶é—´æˆ³ private long checkoutTimestamp;//åˆ›å»ºçš„æ—¶é—´æˆ³ private long createdTimestamp;//æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´æˆ³ private long lastUsedTimestamp;//ç”±æ•°æ®åº“URLã€ç”¨æˆ·åå’Œå¯†ç è®¡ç®—å‡ºæ¥çš„hashå€¼ï¼Œå¯ç”¨äºæ ‡è¯†è¯¥è¿æ¥æ‰€åœ¨çš„è¿æ¥æ±  private int connectionTypeCode;//æ£€æŸ¥PooledConnectionæ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢å½’è¿˜ä¾ç„¶ä½¿ç”¨è¯¥è¿æ¥æ“ä½œæ•°æ®åº“ private boolean valid;...çœç•¥ä¸€å¤§å †geter/seteræ–¹æ³• /** * Required for InvocationHandler implementation. * * @param proxy - not used * @param method - the method to be executed * @param args - the parameters to be passed to the method * @see java.lang.reflect.InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[]) */ @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; String methodName = method.getName();//å¦‚æœæ˜¯CLOSEæ–¹æ³•å°±å‘dataSourceå½’è¿˜è¿æ¥æ± ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³é—­ if (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123; dataSource.pushConnection(this); return null; &#125; try &#123; if (!Object.class.equals(method.getDeclaringClass())) &#123; // issue #579 toString() should never fail // throw an SQLException instead of a Runtime//æ£€æŸ¥validæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆç›´æ¥æŠ›å‡ºå¼‚å¸¸SQLException checkConnection(); &#125;//è°ƒç”¨çœŸæ­£çš„æ•°æ®åº“å¯¹è±¡çš„æ–¹æ³• return method.invoke(realConnection, args); &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; &#125;&#125; PoolState ç®¡ç†PooledConnectionå¯¹è±¡çŠ¶æ€çš„ç»„ä»¶ï¼Œå®ƒé€šè¿‡ä¸¤ä¸ªArrayListé›†åˆåˆ†åˆ«ç®¡ç†ç©ºé—²çŠ¶æ€çš„è¿æ¥å’Œæ´»è·ƒçŠ¶æ€çš„è¿æ¥ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930package org.apache.ibatis.datasource.pooled;import ...public class PoolState &#123; protected PooledDataSource dataSource;//ç©ºé—²çŠ¶æ€çš„è¿æ¥ protected final List&lt;PooledConnection&gt; idleConnections = new ArrayList&lt;&gt;();//**æ´»è·ƒçŠ¶æ€**çš„è¿æ¥ protected final List&lt;PooledConnection&gt; activeConnections = new ArrayList&lt;&gt;();//ä»¥ä¸‹å°±æ˜¯ä¸€äº›ç»Ÿè®¡å­—æ®µ//è¯·æ±‚æ•°æ®åº“æ¬¡æ•° protected long requestCount = 0;//è·å–è¿æ¥ç´¯è®¡çš„æ—¶é—´ protected long accumulatedRequestTime = 0;//checkoutTimeè¡¨ç¤ºåº”ç”¨ä»è¿æ¥æ± ä¸­å–å‡ºè¿æ¥ï¼Œåˆ°å½’è¿˜è¿æ¥è¿™æ®µæ—¶é•¿ï¼Œ//accumulatedCheckoutTimeè®°å½•äº†æ‰€æœ‰è¿æ¥ç´¯ç§¯çš„checkoutTimeæ—¶é•¿ protected long accumulatedCheckoutTime = 0;//ç´¯è®¡è¶…æ—¶è¿æ¥ä¸ªæ•° protected long claimedOverdueConnectionCount = 0;//ç´¯è®¡è¶…æ—¶æ—¶é—´ protected long accumulatedCheckoutTimeOfOverdueConnections = 0;//ç´¯è®¡ç­‰å¾…æ—¶é—´ protected long accumulatedWaitTime = 0;//ç­‰å¾…æ¬¡æ•° protected long hadToWaitCount = 0;ã€//æ— æ•ˆçš„è¿æ¥æ•° protected long badConnectionCount = 0;...&#125; PooledDataSourceä¸­ç®¡ç†çš„çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¯¹è±¡æ˜¯ç”±PooledDataSourceä¸­å°è£…çš„UnpooledDataSourceå¯¹è±¡åˆ›å»ºçš„ï¼Œå¹¶ç”±PoolStateç®¡ç†æ‰€æœ‰è¿æ¥çš„çŠ¶æ€ã€‚PooledDataSourceä¸­æ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233package org.apache.ibatis.datasource.pooled;import .../** * This is a simple, synchronous, thread-safe database connection pool. */public class PooledDataSource implements DataSource &#123;//ç®¡ç†è¿æ¥æ± çŠ¶æ€ä»¥åŠç»Ÿè®¡ä¿¡æ¯ private final PoolState state = new PoolState(this);//UnpooledDataSourceå¯¹è±¡ï¼Œç”¨äºç”ŸæˆçœŸå®çš„æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œæ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ–è¯¥å­—æ®µ private final UnpooledDataSource dataSource;//é»˜è®¤çš„æœ€å¤§æ´»è·ƒè¿æ¥æ•°é‡ // OPTIONAL CONFIGURATION FIELDS protected int poolMaximumActiveConnections = 10;ã€//æœ€å¤§ç©ºé—²è¿æ¥æ•°é‡ protected int poolMaximumIdleConnections = 5;//æœ€é•¿çš„checkoutç­‰å¾…æ—¶é—´ protected int poolMaximumCheckoutTime = 20000;//åœ¨æ— æ³•è·å–è¿æ¥æ—¶å€™ï¼Œçº¿ç¨‹çš„ç­‰å¾…æ—¶é•¿ protected int poolTimeToWait = 20000;//æœ€å¤§å®¹å¿çš„æœ¬åœ°æ— æ•ˆè¿æ¥æ•°é‡ï¼Œå¦‚æœå¤§äºï¼ˆæœ€å¤§æ´»è·ƒè¿æ¥æ•°é‡ + æœ€å¤§ç©ºé—²è¿æ¥æ•°é‡ï¼‰,ç›´æ¥æŠ›å‡ºå¼‚å¸¸ protected int poolMaximumLocalBadConnectionTolerance = 3;//æ£€æŸ¥æ•°æ®åº“æ˜¯å¦SQLè¯­å¥ protected String poolPingQuery = \"NO PING QUERY SET\";//æ˜¯å¦å…è®¸å‘é€ä¸Šé¢çš„poolPingQuery æµ‹è¯•SQLè¯­å¥ protected boolean poolPingEnabled;//å½“è¿æ¥è¶…è¿‡poo1PingconnectionsNotUsedForæ¯«ç§’æœªä½¿ç”¨æ—¶ï¼Œä¼šå‘é€ä¸€æ¬¡æµ‹è¯•sQLè¯­å¥ï¼Œæ£€æµ‹è¿æ¥æ˜¯å¦æ­£å¸¸ protected int poolPingConnectionsNotUsedFor;//æ ¹æ®æ•°æ®åº“çš„URLã€ç”¨æˆ·åå’Œå¯†ç ç”Ÿæˆçš„ä¸€ä¸ªhashå€¼ï¼Œè¯¥å“ˆå¸Œå€¼ç”¨äºæ ‡å¿—ç€å½“å‰çš„è¿æ¥æ±  private int expectedConnectionTypeCode;...&#125; PooledDataSource.getConnection()æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨PooledDataSource.popConnection()æ–¹æ³•è·å–PooledConnectionå¯¹è±¡ï¼Œç„¶åé€šè¿‡PooledConnection.getProxyConnection()æ–¹æ³•è·å–æ•°æ®åº“è¿æ¥çš„ä»£ç†å¯¹è±¡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105private PooledConnection popConnection(String username, String password) throws SQLException &#123; boolean countedWait = false; PooledConnection conn = null; long t = System.currentTimeMillis(); int localBadConnectionCount = 0; while (conn == null) &#123; synchronized (state) &#123;//åŒæ­¥é”//æ£€æµ‹æ˜¯å¦æœ‰ç©ºé—²è¿æ¥ if (!state.idleConnections.isEmpty()) &#123; // Pool has available connection//è·å–ç©ºé—²è¿æ¥ conn = state.idleConnections.remove(0); if (log.isDebugEnabled()) &#123; log.debug(\"Checked out connection \" + conn.getRealHashCode() + \" from pool.\"); &#125; &#125; else &#123;//æ²¡æœ‰ç©ºé—²çš„ Pool does not have available connection//åˆ¤æ–­å½“å‰æ´»è·ƒè¿æ¥æ•°é‡æ˜¯å¦å·²ç»è¶…è¿‡çš„æœ€å¤§æ´»è·ƒæ•°é‡é™åˆ¶ if (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123; // æ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªå¹¶å°è£…æˆPooledConnection conn = new PooledConnection(dataSource.getConnection(), this); if (log.isDebugEnabled()) &#123; log.debug(\"Created connection \" + conn.getRealHashCode() + \".\"); &#125; &#125; else &#123;//è¶…è¿‡äº†é™åˆ¶ï¼Œè·å–æœ€å…ˆåˆ›å»ºçš„æ´»è·ƒè¿æ¥ PooledConnection oldestActiveConnection = state.activeConnections.get(0);//è·å–å…¶è¶…æ—¶æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¶…æ—¶ long longestCheckoutTime = oldestActiveConnection.getCheckoutTime(); if (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;// å¯¹è¶…æ—¶è¿æ¥è¿›è¡Œç»Ÿè®¡ state.claimedOverdueConnectionCount++; state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime; state.accumulatedCheckoutTime += longestCheckoutTime;//å¹¶ç§»å‡ºæ´»è·ƒè¿æ¥é›†åˆ state.activeConnections.remove(oldestActiveConnection);//å¦‚æœè¿æ¥è¶…æ—¶ä¸”æœªæäº¤ï¼Œåˆ™è‡ªåŠ¨å›æ»šï¼ˆçœç•¥try/catchä»£ç å—ï¼‰ if (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123; oldestActiveConnection.getRealConnection().rollback(); &#125;//åˆ›å»ºæ–°Pooledconnectionå¯¹è±¡ï¼Œä½†æ˜¯çœŸæ­£çš„æ•°æ®åº“è¿æ¥å¹¶æœªåˆ›å»ºæ–°çš„ conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this); conn.setCreatedTimestamp(oldestActiveConnection.getCreatedTimestamp()); conn.setLastUsedTimestamp(oldestActiveConnection.getLastUsedTimestamp());//å°†è¶…æ—¶è¿æ¥è®¾ç½®æˆä¸ºæ— æ•ˆçŠ¶æ€ oldestActiveConnection.invalidate(); if (log.isDebugEnabled()) &#123; log.debug(\"Claimed overdue connection \" + conn.getRealHashCode() + \".\"); &#125; &#125; else &#123; //æ— ç©ºé—²è¿æ¥ã€æ— æ³•åˆ›å»ºæ–°è¿æ¥ä¸”æ— è¶…æ—¶è¿æ¥ï¼Œåˆ™åªèƒ½é˜»å¡ç­‰å¾… try &#123; if (!countedWait) &#123; state.hadToWaitCount++;//ç»Ÿè®¡ç­‰å¾…ä¿¡æ¯ countedWait = true; &#125; if (log.isDebugEnabled()) &#123; log.debug(\"Waiting as long as \" + poolTimeToWait + \" milliseconds for connection.\"); &#125; long wt = System.currentTimeMillis();//é˜»å¡ç­‰å¾…poolTimeToWaitï¼Œä¸‹é¢å°±ç»Ÿè®¡ä¸€ä¸‹ç­‰å¾…ä¿¡æ¯ state.wait(poolTimeToWait); state.accumulatedWaitTime += System.currentTimeMillis() - wt; &#125; catch (InterruptedException e) &#123; break; &#125; &#125; &#125; &#125; if (conn != null) &#123; // ping to server and check the connection is valid or not if (conn.isValid()) &#123; if (!conn.getRealConnection().getAutoCommit()) &#123; conn.getRealConnection().rollback(); &#125;//é…ç½®PooledConnectionçš„å±æ€§ï¼ŒconnectionTypeCodeç”±url + username + passwordç»„æˆåçš„hashCode conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));//è®°å½•checkoutæ—¶é—´ conn.setCheckoutTimestamp(System.currentTimeMillis());//æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´ conn.setLastUsedTimestamp(System.currentTimeMillis());//è¿›è¡Œç›¸å…³ç»Ÿè®¡ state.activeConnections.add(conn); state.requestCount++; state.accumulatedRequestTime += System.currentTimeMillis() - t; &#125; else &#123; if (log.isDebugEnabled()) &#123; log.debug(\"A bad connection (\" + conn.getRealHashCode() + \") was returned from the pool, getting another connection.\"); &#125;//æ— æ•ˆè¿æ¥æ•°é‡ç»Ÿè®¡ state.badConnectionCount++; localBadConnectionCount++; conn = null; if (localBadConnectionCount &gt; (poolMaximumIdleConnections + poolMaximumLocalBadConnectionTolerance)) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"PooledDataSource: Could not get a good connection to the database.\"); &#125; throw new SQLException(\"PooledDataSource: Could not get a good connection to the database.\"); &#125; &#125; &#125; &#125; &#125; çœ‹åå­—å°±çŸ¥é“ï¼ˆPoolï¼‰æ˜¯æ”¯æŒè¿æ¥æ± ï¼Œé‚£é€šè¿‡å‰é¢å¯¹PooledConnection.invokeæ–¹æ³•çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼Œå½“è°ƒç”¨è¿æ¥çš„ä»£ç†å¯¹è±¡çš„closeæ–¹æ³•æ—¶ï¼Œå¹¶æœªå…³é—­çœŸæ­£çš„æ•°æ®è¿æ¥ï¼Œè€Œæ˜¯ä»£ç†è°ƒç”¨PooledDataSource.pushConnectionæ–¹æ³•å°†PooledConnection å¯¹è±¡å½’è¿˜ç»™è¿æ¥æ± ã€‚ä¸‹é¢å°±åˆ†æå½’è¿˜è§„ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849protected void pushConnection(PooledConnection conn) throws SQLException &#123;//åŒæ­¥state synchronized (state) &#123;//ä»activeConnectionsé›†åˆé‡Œé¢ç§»é™¤è¯¥å¯¹è±¡ state.activeConnections.remove(conn);//æ£€æŸ¥è¿æ¥å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ if (conn.isValid()) &#123;//è‹¥å½“å‰ç©ºé—²è¿æ¥é›†åˆæ•°é‡å°äºæœ€å¤§ç©ºé—²é˜ˆå€¼ï¼Œå¹¶ä¸”è¯¥è¿æ¥çš„connectionTypeCodeå’Œæ•°æ®æºæœ¬èº«çš„hashCodeä¸€è‡´ if (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123;//ç´¯è®¡checkoutæ—¶é•¿ state.accumulatedCheckoutTime += conn.getCheckoutTime(); if (!conn.getRealConnection().getAutoCommit()) &#123; conn.getRealConnection().rollback(); &#125;//ä¸ºè¿”è¿˜è¿æ¥å¯¹è±¡åŒ…è£…æˆPooledConnection PooledConnection newConn = new PooledConnection(conn.getRealConnection(), this); state.idleConnections.add(newConn);//æ·»åŠ åˆ°ç©ºé—²é›†åˆidleConnections newConn.setCreatedTimestamp(conn.getCreatedTimestamp()); newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());//å°†åŸPooledConnectionè®¾ç½®ä¸ºæ— æ•ˆ conn.invalidate(); if (log.isDebugEnabled()) &#123; log.debug(\"Returned connection \" + newConn.getRealHashCode() + \" to pool.\"); &#125;//å”¤é†’é€šçŸ¥å…¶ä»–ç­‰å¾…é˜»å¡çš„çº¿ç¨‹ state.notifyAll(); &#125; else &#123;//ç©ºé—²è¿æ¥åˆ°è¾¾ä¸Šé™æˆ–è€…hashCodeä¸åŒ¹é…ï¼ˆæ„å‘³ç€ä¸å±äºè¯¥è¿æ¥æ± ï¼‰ state.accumulatedCheckoutTime += conn.getCheckoutTime(); if (!conn.getRealConnection().getAutoCommit()) &#123; conn.getRealConnection().rollback(); &#125;//å…³é—­çœŸæ­£çš„æ•°æ®åº“è¿æ¥ conn.getRealConnection().close(); if (log.isDebugEnabled()) &#123; log.debug(\"Closed connection \" + conn.getRealHashCode() + \".\"); &#125;//è®¾ç½®æˆæ— æ•ˆ conn.invalidate(); &#125; &#125; else &#123; if (log.isDebugEnabled()) &#123; log.debug(\"A bad connection (\" + conn.getRealHashCode() + \") attempted to return to the pool, discarding connection.\"); &#125;//ç»Ÿè®¡æ— æ•ˆè¿æ¥æ•°é‡ state.badConnectionCount++; &#125; &#125; &#125; åœ¨ä¸Šé¢ä»£ç åˆ†æå½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šæ¬¡çœ‹è§isValid()æ–¹æ³•ï¼Œé™¤äº†æ ¡éªŒPooledConnection.validå±æ€§å¤–ï¼Œè¿˜ä¼šè°ƒç”¨dataSource.pingConnectionæ–¹æ³•è®©æ•°æ®åº“æ‰§è¡ŒpoolPingQueryçš„æµ‹è¯•SQLæ•°æ®åº“è¯­å¥ï¼Œä¸‹é¢è®©æˆ‘è®¨è®ºä¸‹å…³äºæ ¡éªŒè¿æ¥æœ‰æ•ˆçš„è¿‡ç¨‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364 /**æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§ * @return True if the connection is usable */ public boolean isValid() &#123; return valid &amp;&amp; realConnection != null &amp;&amp; dataSource.pingConnection(this); &#125;/**é€šè¿‡å‘é€pingæ£€æŸ¥SQLåˆ¤æ–­å½“å‰æ•°æ®åº“è¿æ¥æ˜¯å¦å·²ç»å¤±æ•ˆï¼Œæ¯•ç«Ÿæ•°æ®åº“å¯¹é•¿æ—¶é—´çš„é“¾æ¥ä¹Ÿä¼šåšå¤±æ•ˆå¤„ç† * Method to check to see if a connection is still usable * * @param conn - the connection to check * @return True if the connection is still usable */ protected boolean pingConnection(PooledConnection conn) &#123;//pingæ“ä½œæˆåŠŸçš„æ ‡å¿— boolean result = true; try &#123;//å…ˆæ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦å·²ç»å…³é—­ result = !conn.getRealConnection().isClosed(); &#125; catch (SQLException e) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Connection \" + conn.getRealHashCode() + \" is BAD: \" + e.getMessage()); &#125; result = false; &#125;//1ã€å¦‚æœæ²¡å…³é—­è¿›ä¸€æ­¥æ£€æŸ¥ if (result) &#123;//2ã€æ£€æŸ¥SQLæ£€æŸ¥çš„å¿ƒè·³å¼€å…³ if (poolPingEnabled) &#123;//3ã€æ£€æŸ¥poolPingConnectionsNotUsedForæ˜¯å¦å·²ç»è¶…è¿‡ï¼ˆå½“å‰æ—¶é—´è·ç¦»æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨çš„æ—¶é—´é—´è·ï¼‰ if (poolPingConnectionsNotUsedFor &gt;= 0 &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123; try &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Testing connection \" + conn.getRealHashCode() + \" ...\"); &#125; Connection realConn = conn.getRealConnection();//ä¸‹é¢æ˜¯æ‰§è¡ŒSQLæµ‹è¯•è¯­å¥ try (Statement statement = realConn.createStatement()) &#123; statement.executeQuery(poolPingQuery).close(); &#125; if (!realConn.getAutoCommit()) &#123; realConn.rollback(); &#125; result = true; if (log.isDebugEnabled()) &#123; log.debug(\"Connection \" + conn.getRealHashCode() + \" is GOOD!\"); &#125; &#125; catch (Exception e) &#123; log.warn(\"Execution of ping query '\" + poolPingQuery + \"' failed: \" + e.getMessage()); try &#123; conn.getRealConnection().close(); &#125; catch (Exception e2) &#123; //ignore &#125; result = false; if (log.isDebugEnabled()) &#123; log.debug(\"Connection \" + conn.getRealHashCode() + \" is BAD: \" + e.getMessage()); &#125; &#125; &#125; &#125; &#125; return result; &#125;","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"è®¾è®¡æ¨¡å¼åŸåˆ™","date":"2019-12-22T15:43:00.000Z","path":"2019/12/22/è®¾è®¡æ¨¡å¼åŸåˆ™/","text":"å¹•å¸ƒï¼šè½¯ä»¶è®¾è®¡åŸåˆ™ æ€ç»´å¯¼å›¾","tags":[{"name":"software engineering","slug":"software-engineering","permalink":"https://caochikai.github.io/tags/software-engineering/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šèµ„æºåŠ è½½","date":"2019-12-22T06:10:00.000Z","path":"2019/12/22/MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šèµ„æºåŠ è½½/","text":"2.5ã€èµ„æºåŠ è½½2.5.1ã€ç±»åŠ è½½å™¨ JVMç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰è´Ÿè´£åŠ è½½å„ç§èµ„æºï¼ˆä¸»è¦æ˜¯classå­—èŠ‚ç æ–‡ä»¶)ï¼Œæ¥æºæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œèµ„æºæˆ–è€…å…¶ä»–æ¥æºï¼Œä¸”é»˜è®¤ä½¿ç”¨çš„æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ã€‚ç±»åŠ è½½å™¨åŸºæœ¬ä¸‰å¤§ç‰¹æ€§ä¸ºå»¶è¿ŸåŠ è½½ã€èŒè´£åˆ†æ˜ã€ä¼ é€’æ€§ã€‚è€ŒJVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ ClassLoaderï¼š BootstrapClassLoaderã€ExtensionClassLoader å’Œ AppClassLoaderã€‚URLClassLoader ä¸ä½†å¯ä»¥åŠ è½½è¿œç¨‹ç±»åº“ï¼Œè¿˜å¯ä»¥åŠ è½½æœ¬åœ°è·¯å¾„çš„ç±»åº“ï¼Œå–å†³äºæ„é€ å™¨ä¸­ä¸åŒçš„åœ°å€å½¢å¼ã€‚ExtensionClassLoader å’Œ AppClassLoader éƒ½æ˜¯ URLClassLoader çš„å­ç±»ï¼Œå®ƒä»¬éƒ½æ˜¯ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿé‡ŒåŠ è½½ç±»åº“ã€‚ BootstrapClassLoaderï¼ˆæ ¹åŠ è½½å™¨ï¼‰ï¼šåŠ è½½JVMæ ¸å¿ƒç±»ï¼Œæ¯”å¦‚$JAVA_HOME/lib/rt.jarï¼› ExtensionClassLoaderï¼ˆæ‰©å±•åŠ è½½å™¨ï¼‰ï¼šåŠ è½½æ‰©å±•ç±»ï¼Œä»¥ javax å¼€å¤´çš„swing ç³»åˆ—ã€å†…ç½®çš„ js å¼•æ“ã€xml è§£æå™¨ç­‰ç­‰ï¼› AppClassLoaderï¼ˆç”¨æˆ·åŠ è½½å™¨ï¼‰ï¼šClassLoader.getSystemClassLoader()è·å¾—ï¼ŒåŠ è½½Classpath ç¯å¢ƒå˜é‡ä¸‹ç›®å½•å’Œjarï¼› Thread.contextClassLoaderï¼ˆçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼‰ï¼šä¸»è¦æ˜¯ç±»éš”ç¦»æˆ–è€…å…±äº«ï¼› åŒäº²å§”æ´¾æ¨¡å¼ï¼šç®€å•äº†æ¥è¯´å­ç±»æœ‰ä¸ªparent å±æ€§æŒ‡å‘å®ƒçš„çˆ¶åŠ è½½å™¨ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰ï¼Œå…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½è¿‡å°±ä¼˜å…ˆè®©çˆ¶ç±»å°è¯•åŠ è½½ï¼ˆç†è§£ä¸ºå¾ˆæ‡’éƒ½å‘çˆ¹ï¼‰ï¼Œå¦‚æœå·²ç»åŠ è½½æˆ–è€…å‘çˆ¹ä¸æˆé‚£å°±è‡ªå·±å¹²ã€‚ è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šç»§æ‰¿java.lang.ClassLoaderï¼Œæ¯”å¦‚Tomcatï¼ˆWebAppClassLoaderï¼‰ã€JBossç±»åŠ è½½å™¨ï¼› 12345678910package java.lang;...public abstract class ClassLoader &#123; // The parent class loader for delegation // Note: VM hardcoded the offset of this field, thus all new fields // must be added *after* it.//å¦‚æœparentä¸ºç©ºï¼ˆæ¯”å¦‚ExtensionClassLoaderï¼‰ï¼Œé‚£é»˜è®¤nullå°±æ˜¯æ ¹åŠ è½½å™¨BootstrapClassLoader private final ClassLoader parent; ...&#125; 2.5.2 ClassloaderWrapper çœ‹åå­—å°±çŸ¥é“æ˜¯ClassLoaderçš„åŒ…è£…å™¨ï¼Œorg.apache.ibatis.ioåŒ…å°±å°è£…äº†èµ„æºåŠ è½½æ–‡ä»¶çš„ç›¸å…³APIï¼Œé€šè¿‡ClassloaderWrapperåŒ…è£…å™¨å°±å¯ä»¥è°ƒæ•´å¤šä¸ªClassLoaderçš„ä½¿ç”¨é¡ºåºã€‚ClassLoaderWrapperçš„ä¸»è¦æ–¹æ³•å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯getResourceAsURLæ–¹æ³•ã€classForNameæ–¹æ³•ã€getResourceAsStreamæ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112package org.apache.ibatis.io;import java.io.InputStream;import java.net.URL;/** * A class to wrap access to multiple class loaders making them work as one * * @author Clinton Begin */public class ClassLoaderWrapper &#123; //æŒ‡å®šçš„é»˜è®¤ç±»åŠ è½½å™¨ ClassLoader defaultClassLoader; //SecurityManagerç³»ç»Ÿç±»åŠ è½½å™¨ ClassLoader systemClassLoader; ClassLoaderWrapper() &#123; try &#123; //åˆå§‹åŒ–ç±»åŠ è½½å™¨ systemClassLoader = ClassLoader.getSystemClassLoader(); &#125; catch (SecurityException ignored) &#123; // AccessControlException on Google App Engine &#125; &#125; ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123; return new ClassLoader[]&#123; classLoader,//å‚æ•°æŒ‡å®šåŠ è½½å™¨ defaultClassLoader,//é»˜è®¤åŠ è½½å™¨ Thread.currentThread().getContextClassLoader(),//çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ getClass().getClassLoader(),//å½“å‰ç±»æ‰€ä½¿ç”¨çš„ç±»åŠ è½½å™¨ systemClassLoader&#125;;//System ClassLoader &#125; ...çœç•¥éƒ¨åˆ†é‡è½½æ–¹æ³• /** * Try to get a resource from a group of classloaders * * @param resource - the resource to get * @param classLoader - the classloaders to examine * @return the resource or null */ InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123; for (ClassLoader cl : classLoader) &#123; if (null != cl) &#123; // try to find the resource as passed InputStream returnValue = cl.getResourceAsStream(resource); // now, some class loaders want this leading \"/\", so we'll add it and try again if we didn't find the resource if (null == returnValue) &#123; returnValue = cl.getResourceAsStream(\"/\" + resource); &#125; if (null != returnValue) &#123; return returnValue; &#125; &#125; &#125; return null; &#125; /** * Get a resource as a URL using the current class path * * @param resource - the resource to locate * @param classLoader - the class loaders to examine * @return the resource or null */ URL getResourceAsURL(String resource, ClassLoader[] classLoader) &#123; URL url; for (ClassLoader cl : classLoader) &#123; if (null != cl) &#123; // look for the resource as passed in... url = cl.getResource(resource); // ...but some class loaders want this leading \"/\", so we'll add it // and try again if we didn't find the resource if (null == url) &#123; url = cl.getResource(\"/\" + resource); &#125; // \"It's always in the last place I look for it!\" // ... because only an idiot would keep looking for it after finding it, so stop looking already. if (null != url) &#123; return url; &#125; &#125; &#125; // didn't find it anywhere. return null; &#125; /** * Attempt to load a class from a group of classloaders * * @param name - the class to load * @param classLoader - the group of classloaders to examine * @return the class * @throws ClassNotFoundException - Remember the wisdom of Judge Smails: Well, the world needs ditch diggers, too. */ Class&lt;?&gt; classForName(String name, ClassLoader[] classLoader) throws ClassNotFoundException &#123; for (ClassLoader cl : classLoader) &#123; if (null != cl) &#123; try &#123; Class&lt;?&gt; c = Class.forName(name, true, cl) if (null != c) &#123; return c; &#125; &#125; catch (ClassNotFoundException e) &#123; // we'll ignore this until all classloaders fail to locate the class &#125; &#125; &#125; throw new ClassNotFoundException(\"Cannot find class: \" + name); &#125;&#125; 2.5.3 ResolverUtil ResolverUtilæ ¹æ®æŒ‡å®šçš„æ¡ä»¶æŸ¥æ‰¾æŒ‡å®šåŒ…ä¸‹çš„ç±»ï¼Œå…¶ä¸­æ¡ä»¶ç”±Testæ¥å£ä¸­å®šä¹‰äº†matchesæ–¹æ³•æä¾›ã€‚ upload successful 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112package org.apache.ibatis.io;import ***import org.apache.ibatis.logging.Log;import org.apache.ibatis.logging.LogFactory;public class ResolverUtil&lt;T&gt; &#123; /** * A simple interface that specifies how to test classes to determine if they * are to be included in the results produced by the ResolverUtil. */ public interface Test &#123; /** * Will be called repeatedly with candidate classes. Must return True if a class * is to be included in the results, false otherwise. */ boolean matches(Class&lt;?&gt; type); &#125; /** * A Test that checks to see if each class is assignable to the provided class. Note * that this test will match the parent type itself if it is presented for matching. */ public static class IsA implements Test &#123; private Class&lt;?&gt; parent; //...æ„é€ æ–¹æ³•åˆå§‹åŒ–parent /** Returns true if type is assignable to the parent type supplied in the constructor. */ @Override public boolean matches(Class&lt;?&gt; type) &#123; //åˆ¤æ–­parentæ˜¯å¦æ˜¯typeçš„çˆ¶ç±»ï¼ˆç»§æ‰¿ï¼‰ return type != null &amp;&amp; parent.isAssignableFrom(type); &#125; &#125; /** * A Test that checks to see if each class is annotated with a specific annotation. If it * is, then the test returns true, otherwise false. */ public static class AnnotatedWith implements Test &#123; private Class&lt;? extends Annotation&gt; annotation; //...æ„é€ æ–¹æ³•åˆå§‹åŒ–annotation /** Returns true if the type is annotated with the class provided to the constructor. */ @Override public boolean matches(Class&lt;?&gt; type) &#123; //åˆ¤æ–­Typeç±»ä¸Šæ˜¯å¦æ·»åŠ äº†annotationæ³¨è§£ return type != null &amp;&amp; type.isAnnotationPresent(annotation); &#125; &#125; /** The set of matches being accumulated. */ private Set&lt;Class&lt;? extends T&gt;&gt; matches = new HashSet&lt;&gt;(); /** * The ClassLoader to use when looking for classes. If null then the ClassLoader returned * by Thread.currentThread().getContextClassLoader() will be used. */ private ClassLoader classloader; /** * Provides access to the classes discovered so far. If no calls have been made to * any of the &#123;@code find()&#125; methods, **this set will be empty**. * * @return åŒ¹é…çš„ç±». */ public Set&lt;Class&lt;? extends T&gt;&gt; getClasses() &#123; return matches; &#125; /** * Returns the classloader that will be used for scanning for classes. If no explicit * ClassLoader has been set by the calling,the context class loader will be used. * é»˜è®¤æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ */ public ClassLoader getClassLoader() &#123; return classloader == null ? Thread.currentThread().getContextClassLoader() : classloader; &#125; public void setClassLoader(ClassLoader classloader) &#123; this.classloader = classloader; &#125; /** * Scans for classes starting at the package provided and descending into subpackages. * Each class is offered up to the Test as it is discovered, and if the Test returns * true the class is retained. Accumulated classes can be fetched by calling * * @param test an instance of &#123;@link Test&#125; that will be used to filter classes * @param packageName the name of the package from which to start scanning for * classes, e.g. */ public ResolverUtil&lt;T&gt; find(Test test, String packageName) &#123; //æ ¹æ®åŒ…åè·å–å¯¹åº”çš„è·¯å¾„ String path = getPackagePath(packageName); try &#123; //æ ¹æ®VFSç»“æœé›†åˆæŸ¥æ‰¾ä¸Šé¢pathä¸‹çš„èµ„æº List&lt;String&gt; children = VFS.getInstance().list(path); for (String child : children) &#123; if (child.endsWith(\".class\")) &#123; //æ£€æŸ¥classæ˜¯å¦ç¬¦åˆç»“æœ addIfMatching(test, child); &#125; &#125; &#125; catch (IOException ioe) &#123; log.error(\"Could not read package: \" + packageName, ioe); &#125; return this; &#125; â€‹ 12345678910111213141516171819202122232425262728293031323334 /** * Add the class designated by the fully qualified class name provided to the set of * resolved classes if and only if it is approved by the Test supplied. * * @param test the test used to determine if the class matches æŸ¥æ‰¾æ¡ä»¶ * @param fqn the fully qualified name of a class ç±»çš„å®Œå…¨é™å®šåç§° */ @SuppressWarnings(\"unchecked\") protected void addIfMatching(Test test, String fqn) &#123; try &#123; String externalName = fqn.substring(0, fqn.indexOf('.')).replace('/', '.'); ClassLoader loader = getClassLoader(); if (log.isDebugEnabled()) &#123; log.debug(\"Checking to see if class \" + externalName + \" matches criteria [\" + test + \"]\"); &#125; Class&lt;?&gt; type = loader.loadClass(externalName);//åŠ è½½æŒ‡å®šçš„ç±» if (test.matches(type)) &#123; //å¦‚æœæ¡ä»¶è¿‡æ»¤åœ¨æ·»åŠ åˆ°åŒ¹é…ç»“æœé›†åˆmatches matches.add((Class&lt;T&gt;) type); &#125; &#125; catch (Throwable t) &#123; log.warn(\"Could not examine class '\" + fqn + \"'\" + \" due to a \" + t.getClass().getName() + \" with message: \" + t.getMessage()); &#125; &#125;&#125;//ä½¿ç”¨ä¾‹å­ï¼šåœ¨pkg1å’Œpkg2è¿™ä¸¤ä¸ªåŒ…ä¸‹æŸ¥æ‰¾å®ç°äº†ActionBeanè¿™ä¸ªç±»ResolverUtil&lt;ActionBean&gt; resolver = new ResolverUtil&lt;ActionBean&gt;();resolver.findImplementation(ActionBean.class, pkg1, pkg2);resolver.find(new CustomTest(), pkg1);resolver.find(new CustomTest(), pkg2);//è·å–ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•ä¸‰æ¬¡æŸ¥æ‰¾çš„ç»“æœé›†Collection&lt;ActionBean&gt; beans = resolver.getClasses(); 2.5.5 VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ VFSæ˜¯Virtual File Systemç¼©å†™ï¼Œç”¨æ¥æŸ¥æ‰¾æŒ‡å®šè·¯å¾„ä¸‹çš„èµ„æºã€‚VFSä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼ŒMybatisåœ¨org.apache.ibatis.ioä¸‹æœ‰DefaultVFSå’ŒJBoss6VFSçš„å®ç°ï¼ŒUMLå›¾å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485package org.apache.ibatis.io;import ...import org.apache.ibatis.logging.Log;import org.apache.ibatis.logging.LogFactory;/** * Provides a very simple API for accessing resources within an application server. * * @author Ben Gunter */public abstract class VFS &#123; /** The built-in implementations.è®°å½•äº†ä¸¤ä¸ªå®ç°ç±» */ public static final Class&lt;?&gt;[] IMPLEMENTATIONS = &#123; JBoss6VFS.class, DefaultVFS.class &#125;; /** The list to which implementations are added by &#123;@link #addImplClass(Class)&#125;. *ç”¨æˆ·è‡ªå®šä¹‰çš„VESå®ç°ç±»ã€‚addImplClassï¼ˆï¼‰æ–¹æ³•ä¼šå°†æŒ‡å®šçš„VESå®ç°Classå¯¹è±¡æ·»åŠ åˆ°é›†åˆã€‚ */ public static final List&lt;Class&lt;? extends VFS&gt;&gt; USER_IMPLEMENTATIONS = new ArrayList&lt;&gt;(); ... /** Singleton instance holder.å•ä¾‹ */ private static class VFSHolder &#123; static final VFS INSTANCE = createVFS(); @SuppressWarnings(\"unchecked\") static VFS createVFS() &#123; // Try the user implementations first, then the built-ins List&lt;Class&lt;? extends VFS&gt;&gt; impls = new ArrayList&lt;&gt;();//ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„VFSçš„å®ç°ç±» impls.addAll(USER_IMPLEMENTATIONS);//éšåä½¿ç”¨Mybatisæä¾›çš„JBoss6VFS.class, DefaultVFS.class impls.addAll(Arrays.asList((Class&lt;? extends VFS&gt;[]) IMPLEMENTATIONS));//éå†æ‰€æœ‰å®ç°ç±»ï¼Œä¾æ¬¡å®ä¾‹åŒ–VFSå¯¹è±¡å¹¶åˆ¤æ–­æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨å°±è¿”å›å¯¹è±¡ç»“æŸå¾ªç¯ // Try each implementation class until a valid one is found VFS vfs = null; for (int i = 0; vfs == null || !vfs.isValid(); i++) &#123; Class&lt;? extends VFS&gt; impl = impls.get(i); try &#123; vfs = impl.getDeclaredConstructor().newInstance(); if (!vfs.isValid()) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"VFS implementation \" + impl.getName() + \" is not valid in this environment.\"); &#125; &#125; &#125; catch (InstantiationException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e) &#123; log.error(\"Failed to instantiate \" + impl, e); return null; &#125; &#125; if (log.isDebugEnabled()) &#123; log.debug(\"Using VFS adapter \" + vfs.getClass().getName()); &#125; return vfs; &#125; &#125; /**å•ä¾‹æ¨¡å¼ä½“ç°ï¼Œé€šè¿‡é™æ€ç±»åˆ›å»º * Get the singleton &#123;@link VFS&#125; instance. If no &#123;@link VFS&#125; implementation can be found for the * current environment, then this method returns null. */ public static VFS getInstance() &#123; return VFSHolder.INSTANCE; &#125;//æŠ½è±¡æ–¹æ³• /*isValid()è´Ÿè´£æ£€æµ‹å½“å‰VFSå¯¹è±¡åœ¨å½“å‰ç¯å¢ƒä¸‹æ˜¯å¦æœ‰æ•ˆ* Return true if the &#123;@link VFS&#125; implementation is valid for the current environment. */ public abstract boolean isValid(); /**è´Ÿè´£æŸ¥æ‰¾æŒ‡å®šçš„èµ„æºåç§°åˆ—è¡¨ * Recursively list the full resource path of all the resources that are children of the * resource identified by a URL. * * @param url The URL that identifies the resource to list. * @param forPath The path to the resource that is identified by the URL. Generally, this is the * value passed to &#123;@link #getResources(String)&#125; to get the resource URL. * @return A list containing the names of the child resources. * @throws IOException If I/O errors occur */ protected abstract List&lt;String&gt; list(URL url, String forPath) throws IOException;&#125; VFSä¸­å®šä¹‰äº†listï¼ˆURLï¼ŒStringï¼‰å’ŒisValid()ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œåœ¨ResolverUtil.find()æ–¹æ³•æŸ¥æ‰¾ç±»æ–‡ä»¶æ—¶ä¼šè°ƒç”¨list()æ–¹æ³•çš„é‡è½½æ–¹æ³•ï¼Œè¯¥é‡è½½æœ€ç»ˆä¼šè°ƒç”¨listï¼ˆURLï¼ŒStringï¼‰è¿™ä¸ªé‡è½½ã€‚æˆ‘ä»¬ä»¥DefaultVFSä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œå®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173ackage org.apache.ibatis.io;import ***import org.apache.ibatis.logging.Log;import org.apache.ibatis.logging.LogFactory;/**VFSçš„é»˜è®¤å®ç°æ–¹æ³•ï¼Œé€‚ç”¨äºå¤§å¤šæ•°çš„åº”ç”¨æœåŠ¡ * A default implementation of &#123;@link VFS&#125; that works for most application servers. * * @author Ben Gunter */public class DefaultVFS extends VFS &#123; private static final Log log = LogFactory.getLog(DefaultVFS.class); //åˆ¤æ–­æ˜¯å¦æ˜¯jaræ–‡ä»¶çš„å­—èŠ‚ç‰¹å¾ /** The magic header that indicates a JAR (ZIP) file. */ private static final byte[] JAR_MAGIC = &#123; 'P', 'K', 3, 4 &#125;; @Override public boolean isValid() &#123; return true; &#125; @Override public List&lt;String&gt; list(URL url, String path) throws IOException &#123; InputStream is = null; try &#123; List&lt;String&gt; resources = new ArrayList&lt;&gt;(); // First, try to find the URL of a JAR file containing the requested resource. If a JAR // file is found, then we'll list child resources by reading the JAR. //å°è¯•è¯»å–jaræ–‡ä»¶ï¼Œè¿”å›å¯¹åº”çš„URLï¼Œå¦‚æœä¸ºç©ºé‚£å°±ä»£è¡¨ä¸æ˜¯jarèµ„æº URL jarUrl = findJarForResource(url); if (jarUrl != null) &#123; is = jarUrl.openStream(); if (log.isDebugEnabled()) &#123; log.debug(\"Listing \" + url); &#125; //éå†jaråŒ…ä¸­ä»¥pathå¼€å¤´çš„èµ„æºåˆ—è¡¨ resources = listResources(new JarInputStream(is), path); &#125; else &#123; //éå†urlçš„å­ç›®å½•å¹¶è®°å½•åˆ°children List&lt;String&gt; children = new ArrayList&lt;&gt;(); try &#123; if (isJar(url)) &#123; // Some versions of JBoss VFS might give a JAR stream even if the resource // referenced by the URL isn't actually a JAR is = url.openStream(); try (JarInputStream jarInput = new JarInputStream(is)) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Listing \" + url); &#125; for (JarEntry entry; (entry = jarInput.getNextJarEntry()) != null; ) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Jar entry: \" + entry.getName()); &#125; children.add(entry.getName()); &#125; &#125; &#125; else &#123; /* å¤§æ„æ˜¯éƒ¨åˆ†åº”ç”¨æ˜¯èµ„æºåˆ—è¡¨åœ¨æ–‡æœ¬æ–‡ä»¶çš„é‡Œï¼Œä¸‹é¢å°è¯•é€è¡Œè¯»å–èµ„æºï¼Œ *è·¯å¾„ä¸ºpath + \"/\" + lineï¼ˆæ¯è¡Œå†…å®¹ï¼‰è‹¥è¯»å–æˆåŠŸä¸ºæ–‡ä»¶ï¼Œå¦åˆ™ä¸ºæ–‡ä»¶å¤¹ * Some servlet containers allow reading from directory resources like a * text file, listing the child resources one per line. However, there is no * way to differentiate between directory and file resources just by reading * them. To work around that, as each line is read, try to look it up via * the class loader as a child of the current resource. If any line fails * then we assume the current resource is not a directory. */ is = url.openStream(); List&lt;String&gt; lines = new ArrayList&lt;&gt;(); try (BufferedReader reader = new BufferedReader(new InputStreamReader(is))) &#123; for (String line; (line = reader.readLine()) != null;) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Reader entry: \" + line); &#125; lines.add(line); if (getResources(path + \"/\" + line).isEmpty()) &#123; lines.clear(); break; &#125; &#125; &#125; if (!lines.isEmpty()) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Listing \" + url); &#125; children.addAll(lines); &#125; &#125; &#125; catch (FileNotFoundException e) &#123; /*è‹¥è¯»å–URLå¤±è´¥åˆ™ç›´æ¥æ•´ä¸ªæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„æ–‡ä»¶ * For file URLs the openStream() call might fail, depending on the servlet * container, because directories can't be opened for reading. If that happens, * then list the directory directly instead. */ if (\"file\".equals(url.getProtocol())) &#123; File file = new File(url.getFile()); if (log.isDebugEnabled()) &#123; log.debug(\"Listing directory \" + file.getAbsolutePath()); &#125; if (file.isDirectory()) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Listing \" + url); &#125; children = Arrays.asList(file.list()); &#125; &#125; else &#123; // No idea where the exception came from so rethrow it throw e; &#125; &#125; // The URL prefix to use when recursively listing child resources String prefix = url.toExternalForm(); if (!prefix.endsWith(\"/\")) &#123; prefix = prefix + \"/\"; &#125; // Iterate over immediate children, adding files and recursing into directories for (String child : children) &#123; String resourcePath = path + \"/\" + child; resources.add(resourcePath); URL childUrl = new URL(prefix + child); resources.addAll(list(childUrl, resourcePath)); &#125; &#125; return resources; &#125; finally &#123; ...å…³é—­æµ &#125; &#125; /** * List the names of the entries in the given &#123;@link JarInputStream&#125; that begin with the * specified &#123;@code path&#125;. Entries will match with or without a leading slash. * * @param jar The JAR input stream * @param path The leading path to match * @return The names of all the matching entries * @throws IOException If I/O errors occur */ protected List&lt;String&gt; listResources(JarInputStream jar, String path) throws IOException &#123; // Include the leading and trailing slash when matching names //...å¦‚æœpathä¸æ˜¯ä»¥/å¼€å§‹å’Œç»“æŸï¼Œåˆ™åœ¨å…¶å¼€å§‹å’Œç»“æŸä½ç½®æ·»åŠ /ï¼ˆç•¥ï¼‰ // Iterate over the entries and collect those that begin with the requested path List&lt;String&gt; resources = new ArrayList&lt;&gt;(); //éå†jaråŒ…,å°†ä»¥pathå¼€å¤´èµ„æºåŠ å…¥åˆ°resources é›†åˆ for (JarEntry entry; (entry = jar.getNextJarEntry()) != null;) &#123; if (!entry.isDirectory()) &#123; // Add leading slash if it's missing StringBuilder name = new StringBuilder(entry.getName()); if (name.charAt(0) != '/') &#123; name.insert(0, '/'); &#125; // Check file name-&gt;pathå¼€å¤´ if (name.indexOf(path) == 0) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"Found resource: \" + name); &#125; // Trim leading slash resources.add(name.substring(1)); &#125; &#125; &#125; return resources; &#125; ...&#125; å‚è€ƒæ–‡ç«  Oracle Location-Independent Access to Resources è€å¤§éš¾çš„ Java ClassLoader å†ä¸ç†è§£å°±è€äº†","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šæ—¥å¿—æ¨¡å—","date":"2019-12-21T13:19:00.000Z","path":"2019/12/21/MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šæ—¥å¿—æ¨¡å—/","text":"2.4ã€æ—¥å¿—æ¨¡å— Mybatisæ—¥å¿—æ¨¡å—ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œå†…éƒ¨è°ƒç”¨org.apache.ibatis.logging.Log æ¥å£ã€‚ä¸ºäº†æ•´åˆç¬¬ä¸‰æ–¹çš„æ—¥å¿—ç»„ä»¶Log4J2ã€Log4Jï¼Œmybatisæä¾›äº†å¤šç§Adapteré€‚é…è¿™äº›æ—¥å¿—ç»„ä»¶çš„APIï¼Œå¹¶éµå®ˆLog æ¥å£æ ‡å‡†ã€‚åœ¨æ—¥å¿—çº§åˆ«æ”¯æŒä¸­ï¼ŒMybatisæä¾›äº†traceã€debugã€warnã€erorå››ä¸ªçº§åˆ«ï¼Œåªèƒ½è¯´åŸºæœ¬æ»¡è¶³ç»å¤§å¤šæ•°åœºæ™¯çš„æ—¥å¿—ã€‚ 12345678910111213141516171819202122package org.apache.ibatis.logging;/** * @author Clinton Begin */public interface Log &#123; //iså¼€å¤´æ–¹æ³•ä¸ºåˆ¤æ–­ç™»è®°æ–¹æ³• boolean isDebugEnabled(); boolean isTraceEnabled(); //ä¸‹é¢å››ä¸ªåˆ†åˆ«æ”¯æŒå››ç§ç­‰çº§æ—¥å¿—è°ƒç”¨ void error(String s, Throwable e); void error(String s); void debug(String s); void trace(String s); void warn(String s);&#125; LogFactoryè´Ÿè´£åˆ›å»ºå¯¹åº”çš„æ—¥å¿—ç»„ä»¶çš„é€‚é…å™¨ï¼Œå…¶å†…éƒ¨é€»è¾‘åŸºæœ¬å…¬å…±é™æ€ä»£ç å—åŠ è½½æ”¯æŒçš„æ—¥å¿—é€‚é…å™¨ï¼Œç„¶åä½¿ç”¨logConstructoré›†åˆè®°å½•æ‰€æœ‰æ”¯æŒçš„æ—¥å¿—é€‚é…å™¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869package org.apache.ibatis.logging;import java.lang.reflect.Constructor;/** * @author Clinton Begin * @author Eduardo Macarron */public final class LogFactory &#123; /** * Marker to be used by logging implementations that support markers. */ public static final String MARKER = \"MYBATIS\"; //ç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶çš„é›†åˆ private static Constructor&lt;? extends Log&gt; logConstructor; static &#123; tryImplementation(LogFactory::useSlf4jLogging); tryImplementation(LogFactory::useCommonsLogging); tryImplementation(LogFactory::useLog4J2Logging); tryImplementation(LogFactory::useLog4JLogging); tryImplementation(LogFactory::useJdkLogging); tryImplementation(LogFactory::useNoLogging); &#125; private LogFactory() &#123; // disable construction &#125; public static Log getLog(Class&lt;?&gt; aClass) &#123; return getLog(aClass.getName()); &#125; public static Log getLog(String logger) &#123; try &#123; //è¿”å›loggerå¯¹è±¡ return logConstructor.newInstance(logger); &#125; catch (Throwable t) &#123; throw new LogException(\"Error creating logger for logger \" + logger + \". Cause: \" + t, t); &#125; &#125; ...useå¼€å¤´æ–¹æ³•çœç•¥éƒ½ä¼šèµ°ä¸‹é¢æ–¹æ³•setImplementationï¼ˆå¯¹åº”é€‚é…å™¨ç±»ï¼‰ private static void tryImplementation(Runnable runnable) &#123; if (logConstructor == null) &#123; try &#123; runnable.run(); &#125; catch (Throwable t) &#123; // ignore &#125; &#125; &#125; private static void setImplementation(Class&lt;? extends Log&gt; implClass) &#123; try &#123; //è·å–æŒ‡å®šé€‚é…å™¨çš„æ„é€ æ–¹æ³• Constructor&lt;? extends Log&gt; candidate = implClass.getConstructor(String.class); //å®ä¾‹åŒ–é€‚é…å™¨ Log log = candidate.newInstance(LogFactory.class.getName()); if (log.isDebugEnabled()) &#123; log.debug(\"Logging initialized using '\" + implClass + \"' adapter.\"); &#125; //åˆå§‹åŒ–logConstructor logConstructor = candidate; &#125; catch (Throwable t) &#123; throw new LogException(\"Error setting Log implementation. Cause: \" + t, t); &#125; &#125;&#125; 2.4.4ã€JDBCè°ƒè¯•æ—¥å¿— org.apache.ibatis.logging.jdbcæ˜¯Mybatisé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå°†JDBCæ“ä½œé€šè¿‡æŒ‡å®šçš„æ—¥å¿—æ¡†æ¶æ‰“å°å‡ºæ¥ï¼Œè¾“å‡ºå†…å®¹åŒ…å«sqlè¯­å¥ã€ç»‘å®šå‚æ•°ã€å½±å“è¡Œæ•°ç­‰ç­‰ã€‚BaseJdbcLoggeræ˜¯jdbcä¸‹æ‰€æœ‰loggerç±»çš„çˆ¶ç±»ï¼Œç»§æ‰¿æ ‘å¦‚ä¸‹ï¼š upload successful 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394package org.apache.ibatis.logging.jdbc;import ...çœç•¥éƒ¨åˆ†å¯¼å…¥import org.apache.ibatis.logging.Log;import org.apache.ibatis.reflection.ArrayUtil;/** * Base class for proxies to do logging. * * @author Clinton Begin * @author Eduardo Macarron */public abstract class BaseJdbcLogger &#123; //PreparedStatementæ¥å£ä¸­å®šä¹‰çš„å¸¸ç”¨çš„set*ï¼ˆï¼‰æ–¹æ³•å protected static final Set&lt;StrinSg&gt; SET_METHODS; //Statementæ¥å£å’ŒPreparedStatementæ¥å£ä¸­ä¸æ‰§è¡ŒSQLè¯­å¥ç›¸å…³çš„æ–¹æ³•å protected static final Set&lt;String&gt; EXECUTE_METHODS = new HashSet&lt;&gt;(); //PreparedStatement.set*ï¼ˆï¼‰æ–¹æ³•è®¾ç½®çš„é”®å€¼å¯¹ï¼Œkeyä¸ºparameterIndexä¸‹æ ‡ï¼Œvalueä¸ºåˆ—å€¼ private final Map&lt;Object, Object&gt; columnMap = new HashMap&lt;&gt;(); //parameterIndexé›†åˆ private final List&lt;Object&gt; columnNames = new ArrayList&lt;&gt;(); //valueé›†åˆ private final List&lt;Object&gt; columnValues = new ArrayList&lt;&gt;(); //å½“å‰æ”¯æŒçš„é€‚é…å™¨å®ä¾‹ protected final Log statementLog; //Sqlå±‚æ•°ï¼Œç”¨äºæ ¼å¼åŒ–sqlï¼Œbufferå †æ ˆçš„æ·±åº¦-&gt;char[] buffer = new char[queryStack * 2 + 2]; protected final int queryStack; /* * Default constructorï¼Œä¼ å…¥é€‚é…å™¨å®ä¾‹ */ public BaseJdbcLogger(Log log, int queryStack) &#123; this.statementLog = log; if (queryStack == 0) &#123; this.queryStack = 1; &#125; else &#123; this.queryStack = queryStack; &#125; &#125; static &#123; //lambadaè·å–PreparedStatementå¼€é€šsetXXXæ–¹æ³•åç§°é›†åˆ SET_METHODS = Arrays.stream(PreparedStatement.class.getDeclaredMethods()) .filter(method -&gt; method.getName().startsWith(\"set\")) .filter(method -&gt; method.getParameterCount() &gt; 1) .map(Method::getName) .collect(Collectors.toSet()); //æ‰§è¡Œæ–¹æ³•ä»£ç†ç›®æ ‡ EXECUTE_METHODS.add(\"execute\"); EXECUTE_METHODS.add(\"executeUpdate\"); EXECUTE_METHODS.add(\"executeQuery\"); EXECUTE_METHODS.add(\"addBatch\"); &#125; static &#123; //å¾€SET_METHODSé›†åˆæ·»åŠ è®°å½• SET_METHODS.add(\"setString\"); SET_METHODS.add(\"setNString\"); SET_METHODS.add(\"setInt\"); SET_METHODS.add(\"setByte\"); SET_METHODS.add(\"setShort\"); SET_METHODS.add(\"setLong\"); SET_METHODS.add(\"setDouble\"); SET_METHODS.add(\"setFloat\"); SET_METHODS.add(\"setTimestamp\"); SET_METHODS.add(\"setDate\"); SET_METHODS.add(\"setTime\"); SET_METHODS.add(\"setArray\"); SET_METHODS.add(\"setBigDecimal\"); SET_METHODS.add(\"setAsciiStream\"); SET_METHODS.add(\"setBinaryStream\"); SET_METHODS.add(\"setBlob\"); SET_METHODS.add(\"setBoolean\"); SET_METHODS.add(\"setBytes\"); SET_METHODS.add(\"setCharacterStream\"); SET_METHODS.add(\"setNCharacterStream\"); SET_METHODS.add(\"setClob\"); SET_METHODS.add(\"setNClob\"); SET_METHODS.add(\"setObject\"); SET_METHODS.add(\"setNull\"); EXECUTE_METHODS.add(\"execute\"); EXECUTE_METHODS.add(\"executeUpdate\"); EXECUTE_METHODS.add(\"executeQuery\"); EXECUTE_METHODS.add(\"addBatch\"); &#125; protected void setColumn(Object key, Object value) &#123; columnMap.put(key, value); columnNames.add(key); columnValues.add(value); &#125; ...&#125; PreparedStatementLoggerç»§æ‰¿äº†BaseJdbcLoggerå¹¶å®ç°äº†InvocationHandleræ¥å£ã€‚PreparedStatementLogger.invokeæ–¹æ³•ä¼šä¸ºEXECUTE_METHODSé›†åˆä¸­çš„æ–¹æ³•ã€SET_METHODSé›†åˆä¸­çš„æ–¹æ³•ã€getResultSetç­‰æ–¹æ³•æä¾›ä»£ç†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100package org.apache.ibatis.logging.jdbc;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.sql.CallableStatement;import java.sql.PreparedStatement;import java.sql.ResultSet;import org.apache.ibatis.logging.Log;import org.apache.ibatis.reflection.ExceptionUtil;/** * PreparedStatement proxy to add logging. * * @author Clinton Begin * @author Eduardo Macarron * */public final class PreparedStatementLogger extends BaseJdbcLogger implements InvocationHandler &#123; private final PreparedStatement statement; private PreparedStatementLogger(PreparedStatement stmt, Log statementLog, int queryStack) &#123; super(statementLog, queryStack); this.statement = stmt; &#125; @Override public Object invoke(Object proxy, Method method, Object[] params) throws Throwable &#123; try &#123; if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, params); &#125; //è°ƒç”¨äº†EXECUTE_METHODSé›†åˆä¸­çš„æ–¹æ³• if (EXECUTE_METHODS.contains(method.getName())) &#123; if (isDebugEnabled()) &#123; //æ—¥å¿—è¾“å‡ºï¼Œè¾“å‡ºçš„æ˜¯å‚æ•°å€¼ä»¥åŠå‚æ•°ç±»å‹-&gt;() debug(\"Parameters: \" + getParameterValueString(), true); &#125; clearColumnInfo();//æ¸…ç©ºBaseJdbcLoggerä¸­å®šä¹‰çš„ä¸‰ä¸ªcolumn*é›†åˆ //å¦‚æœæ˜¯executeQueryæ–¹æ³•ï¼Œåˆ™ä¸ºResultSetåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä¸æ˜¯åˆ™ç›´æ¥è¿”å›ç»“æœ if (\"executeQuery\".equals(method.getName())) &#123; ResultSet rs = (ResultSet) method.invoke(statement, params); return rs == null ? null : ResultSetLogger.newInstance(rs, statementLog, queryStack); &#125; else &#123; return method.invoke(statement, params); &#125; &#125; else if (SET_METHODS.contains(method.getName())) &#123; //å¦‚æœæ˜¯SET_METHODSé›†åˆä¸­çš„æ–¹æ³•ï¼Œåˆ™é€šè¿‡setColumnè®°å½•åˆ° //BaseJdbcLoggerçš„ä¸‰ä¸ªcolumn*é›†åˆ if (\"setNull\".equals(method.getName())) &#123; setColumn(params[0], null); &#125; else &#123; setColumn(params[0], params[1]); &#125; return method.invoke(statement, params); &#125; else if (\"getResultSet\".equals(method.getName())) &#123; //å¦‚æœè°ƒç”¨getResultSetï¼ˆï¼‰æ–¹æ³•ï¼Œåˆ™ä¸ºResultSetåˆ›å»ºä»£ç†å¯¹è±¡ ResultSet rs = (ResultSet) method.invoke(statement, params); return rs == null ? null : ResultSetLogger.newInstance(rs, statementLog, queryStack); &#125; else if (\"getUpdateCount\".equals(method.getName())) &#123; int updateCount = (Integer) method.invoke(statement, params); if (updateCount != -1) &#123; debug(\" Updates: \" + updateCount, false); &#125; //è¿”å›å½±å“æ¡æ•° return updateCount; &#125; else &#123; return method.invoke(statement, params); &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; &#125; /** * Creates a logging version of a PreparedStatement. * * @param stmt - the statement * @param statementLog - the statement log * @param queryStack - the query stack * @return - the proxy ä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„æ–¹å¼åˆ›å»ºä»£ç†å¯¹è±¡ */ public static PreparedStatement newInstance(PreparedStatement stmt, Log statementLog, int queryStack) &#123; InvocationHandler handler = new PreparedStatementLogger(stmt, statementLog, queryStack); ClassLoader cl = PreparedStatement.class.getClassLoader(); return (PreparedStatement) Proxy.newProxyInstance(cl, new Class[]&#123;PreparedStatement.class, CallableStatement.class&#125;, handler); &#125; /** * Return the wrapped prepared statement. * * @return the PreparedStatement */ public PreparedStatement getPreparedStatement() &#123; return statement; &#125;&#125; ResultSetLogger ä¸­å°è£…äº†ResultSetå¯¹è±¡ï¼Œä¹Ÿç»§æ‰¿äº†BaseldbcLoggeræŠ½è±¡ç±»å¹¶å®ç°äº†InvocationHandler æ¥å£ã€‚ResultSetLoggerä¸­å®šä¹‰çš„å­—æ®µå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124package org.apache.ibatis.logging.jdbc;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.sql.ResultSet;import java.sql.ResultSetMetaData;import java.sql.SQLException;import java.sql.Types;import java.util.HashSet;import java.util.Set;import org.apache.ibatis.logging.Log;import org.apache.ibatis.reflection.ExceptionUtil;/** * ResultSet proxy to add logging * * @author Clinton Begin * @author Eduardo Macarron * */public final class ResultSetLogger extends BaseJdbcLogger implements InvocationHandler &#123; //è®°å½•äº†è¶…å¤§é•¿åº¦çš„ç±»å‹ private static Set&lt;Integer&gt; BLOB_TYPES = new HashSet&lt;&gt;(); //æ˜¯å¦æ˜¯ResultSetç»“æœé›†çš„ç¬¬ä¸€è¡Œ private boolean first = true; //ç»Ÿè®¡è¡Œæ•° private int rows; private final ResultSet rs; //è®°å½•äº†è¶…å¤§å­—æ®µçš„åˆ—ç¼–å· private final Set&lt;Integer&gt; blobColumns = new HashSet&lt;&gt;(); static &#123; //æ‰€æœ‰è¶…å¤§é•¿åº¦çš„ç±»å‹ BLOB_TYPES.add(Types.BINARY); BLOB_TYPES.add(Types.BLOB); BLOB_TYPES.add(Types.CLOB); BLOB_TYPES.add(Types.LONGNVARCHAR); BLOB_TYPES.add(Types.LONGVARBINARY); BLOB_TYPES.add(Types.LONGVARCHAR); BLOB_TYPES.add(Types.NCLOB); BLOB_TYPES.add(Types.VARBINARY); &#125; @Override public Object invoke(Object proxy, Method method, Object[] params) throws Throwable &#123; try &#123; if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, params); &#125; Object o = method.invoke(rs, params); if (\"next\".equals(method.getName())) &#123; //æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€è¡Œ if ((Boolean) o) &#123; rows++; if (isTraceEnabled()) &#123; ResultSetMetaData rsmd = rs.getMetaData(); //è·å–æ•°æ®é›†çš„åˆ—æ•° final int columnCount = rsmd.getColumnCount(); if (first) &#123; first = false; //è¾“å‡ºè¡¨å¤´ï¼Œå¹¶å¡«å……è¶…å¤§é•¿åº¦çš„ç±»å‹åˆ°é›†åˆä¸­ printColumnHeaders(rsmd, columnCount); &#125; //è¾“å‡ºè¯¥è¡Œè®°å½•ï¼Œæ³¨æ„ä¼šè¿‡æ»¤æ‰blobColumnsä¸­è®°å½•çš„åˆ—ï¼Œ //è¿™äº›åˆ—çš„æ•°æ®è¾ƒå¤§ï¼Œä¸ä¼šè¾“å‡ºåˆ°æ—¥å¿— printColumnValues(columnCount); &#125; &#125; else &#123; //éå†ResultSetä¹‹åè¾“å‡ºæ€»ï¼Œå®Œä¾‹å­ï¼šTotal: 1 debug(\" Total: \" + rows, false); &#125; &#125; clearColumnInfo();//æ¸…ç©ºBaseJdbcLoggerçš„ä¸‰ä¸ªcolumn*é›†åˆ return o; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; &#125; //ä¾‹å­ï¼šHeader: [count(*)] private void printColumnHeaders(ResultSetMetaData rsmd, int columnCount) throws SQLException &#123; StringBuilder row = new StringBuilder(); row.append(\" Columns: \"); for (int i = 1; i &lt;= columnCount; i++) &#123; if (BLOB_TYPES.contains(rsmd.getColumnType(i))) &#123; blobColumns.add(i); &#125; String colname = rsmd.getColumnLabel(i); row.append(colname); if (i != columnCount) &#123; row.append(\", \"); &#125; &#125; trace(row.toString(), false); &#125; //ä¾‹å­ï¼šRow: 39 private void printColumnValues(int columnCount) &#123; StringBuilder row = new StringBuilder(); row.append(\" Row: \"); for (int i = 1; i &lt;= columnCount; i++) &#123; String colname; try &#123; if (blobColumns.contains(i)) &#123; colname = \"&lt;&lt;BLOB&gt;&gt;\"; &#125; else &#123; colname = rs.getString(i); &#125; &#125; catch (SQLException e) &#123; // generally can't call getString() on a BLOB column colname = \"&lt;&lt;Cannot Display&gt;&gt;\"; &#125; row.append(colname); if (i != columnCount) &#123; row.append(\", \"); &#125; &#125; trace(row.toString(), false); &#125;...&#125;","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šç±»å‹è½¬æ¢","date":"2019-12-20T12:40:00.000Z","path":"2019/12/20/MybatisæŠ€æœ¯å†…å¹•-ç¬¬äºŒç« ï¼š2-3ç±»å‹è½¬æ¢/","text":"2.3ã€ç±»å‹è½¬æ¢ JDBCæ•°æ®ç±»å‹ä¸Javaè¯­è¨€ä¸­çš„æ•°æ®ç±»å‹å¹¶ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨PreparedStatementä¸ºSOLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œéœ€è¦ä»Javaç±»å‹è½¬æ¢æˆJDBCç±»å‹ï¼Œè€Œä»ç»“æœé›†ä¸­è·å–æ•°æ®æ—¶ï¼Œåˆ™éœ€è¦ä»JDBCç±»å‹è½¬æ¢æˆJavaç±»å‹ã€‚MyBatisä½¿ç”¨ç±»å‹å¤„ç†å™¨å®Œæˆä¸Šè¿°ä¸¤ç§è½¬æ¢ã€‚ upload successful 2.3.1ã€TypeHandler Mybatiså½“ä¸­æ‰€æœ‰ç±»å‹è½¬åŒ–å™¨éƒ½ç»§æ‰¿BaseTypeHandlerï¼Œè€ŒBaseTypeHandleråˆå®ç°äº†TypeHandleræ¥å£ã€‚æ¥å£å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼Œåˆ†æˆä¸¤ç±»ï¼šsetParameter()æ–¹æ³•è´Ÿè´£å°†æ•°æ®ç”±JdbcType ç±»å‹è½¬æ¢æˆJavaç±»å‹ï¼›getResult()æ–¹æ³•åŠå…¶é‡è½½è´Ÿè´£å°†æ•°æ®ç”±Javaç±»å‹è½¬æ¢æˆJdbcTypeç±»å‹ã€‚ 1234567891011121314151617181920212223242526package org.apache.ibatis.type;import java.sql.CallableStatement;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.sql.SQLException;&#x2F;** * @author Clinton Begin *&#x2F;public interface TypeHandler&lt;T&gt; &#123; &#x2F;&#x2F;åœ¨é€šè¿‡Preparedstatementä¸ºSQLè¯­å¥ç»‘å®šå‚æ•°æ—¶ï¼Œä¼šå°†æ•°æ®ç”±JdbcTypeç±»å‹è½¬æ¢æˆJavaç±»å‹ void setParameter(PreparedStatement ps, int i, T parameter, JdbcType jdbcType) throws SQLException; &#x2F;** * @param columnName Colunm name, when configuration &lt;code&gt;useColumnLabel&lt;&#x2F;code&gt; is &lt;code&gt;false&lt;&#x2F;code&gt; *&#x2F; &#x2F;&#x2F;ä»ResultSetä¸­è·å–æ•°æ®ï¼Œé€šè¿‡å­—æ®µåç§°å°†æ•°æ®ç”±Javaç±»å‹è½¬æ¢æˆJdbcTypeç±»å‹ T getResult(ResultSet rs, String columnName) throws SQLException; &#x2F;&#x2F;ä»ResultSetä¸­è·å–æ•°æ®ï¼Œé€šè¿‡å­—æ®µä¸‹æ ‡ï¼ˆåŒä¸Šé¢getResultï¼‰ T getResult(ResultSet rs, int columnIndex) throws SQLException; &#x2F;&#x2F;CallableStatementä¸­é€šè¿‡ä¸‹æ ‡è·å–ç»“æœ T getResult(CallableStatement cs, int columnIndex) throws SQLException;&#125; ä¸€èˆ¬ç±»å‹è½¬æ¢å™¨é€‚ç”¨äºå•ä¸ªå‚æ•°æˆ–è€…å•ä¸ªåˆ—å€¼å®Œæˆç±»å‹è½¬æ¢ï¼Œå¤§å¤šæ•°æ˜¯ç›´æ¥è°ƒç”¨PreparedStatementã€ResultSetã€CallableStatementçš„å¯¹åº”æ–¹æ³•ï¼Œ ä»¥org.apache.ibatis.type.StringTypeHandlerä¸ºä¾‹å­å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829public class StringTypeHandler extends BaseTypeHandler&lt;String&gt; &#123; @Override public void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException &#123; //è°ƒç”¨PreparedStatement.setXXX(Type)ç»‘å®šå‚æ•° ps.setString(i, parameter); &#125; @Override public String getNullableResult(ResultSet rs, String columnName) throws SQLException &#123; //ResultSet.getXXX(Type)(åˆ—åç§°)è·å–åˆ—å€¼ return rs.getString(columnName); &#125; @Override public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException &#123; //ResultSet.getXXX(Type)(åˆ—ä¸‹æ ‡)è·å–åˆ—å€¼ return rs.getString(columnIndex); &#125; @Override public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException &#123; return cs.getString(columnIndex); &#125;&#125; 2.3.2ã€TypeHandlerRegistry TypeHandlerRegistryç®¡ç†æ‰€æœ‰çš„ç±»å‹è½¬åŒ–å™¨ï¼Œregister()æ–¹æ³•å®ç°äº†æ³¨å†ŒåŠŸèƒ½ï¼Œè¿‡ç¨‹ä¸­ä¼šå‘ä¸‹è¿°å­—æ®µé›†åˆæ·»åŠ TypeHandlerã€‚ 1234567891011121314151617181920212223package org.apache.ibatis.type;import .../** * @author Clinton Begin * @author Kazuki Shimizu */public final class TypeHandlerRegistry &#123; //åœ¨è¯»å–ç»“æœæ•°æ®æ—¶å€™ï¼Œä¾é è¯¥é›†åˆæ˜ å°„ä»jdbcTypeè½¬æ¢æˆjavaTypeï¼Œ //è€ŒJdbcTypeç±»å‹ä¸ºorg.apache.ibatis.type.JdbcTypeæšä¸¾ç±»å‹ private final Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; jdbcTypeHandlerMap = new EnumMap&lt;&gt;(JdbcType.class); //è®°å½•äº†Javaç±»å‹å‘æŒ‡å®šJdbcrypeè½¬æ¢æ—¶ï¼Œéœ€è¦ä½¿ç”¨çš„TypeHandlerå¯¹è±¡ã€‚ä¾‹å¦‚ï¼›Javaç±»å‹ä¸­çš„stringå¯èƒ½ //è½¬æ¢æˆæ•™æ®åº“çš„ charã€varcharç­‰å¤šç§ç±»å‹ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€å¯¹å¤šå…³ç³» private final Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; typeHandlerMap = new ConcurrentHashMap&lt;&gt;(); //Objectç±»å‹TypeHandlerå¤„ç†ç±» private final TypeHandler&lt;Object&gt; unknownTypeHandler = new UnknownTypeHandler(this); //å…¨éƒ¨Javaç±»å‹ä»¥åŠå¯¹åº”çš„TypeHandler private final Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; allTypeHandlersMap = new HashMap&lt;&gt;(); //ç©ºTypeHandleré›†åˆçš„æ ‡è¯† private static final Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; NULL_TYPE_HANDLER_MAP = Collections.emptyMap(); //æšä¸¾ç±»å‹çš„TypeHandleré›†åˆ private Class&lt;? extends TypeHandler&gt; defaultEnumTypeHandler = EnumTypeHandler.class;&#125;","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"MybatisæŠ€æœ¯å†…å¹•æºç è§£æï¼šåå°„å·¥å…·ç®±","date":"2019-12-19T13:24:00.000Z","path":"2019/12/19/MybatisæŠ€æœ¯å†…å¹•-ç¬¬äºŒç« ï¼šåŸºç¡€å±‚/","text":"ç¬¬äºŒç« ï¼šåŸºç¡€æ”¯æŒå±‚ Mybatisä»¥SqlSessionFactoryä¸ºæ ¸å¿ƒï¼Œé€šè¿‡SqlSessionFactoryBuilderè§£æxmlé…ç½®æ–‡ä»¶æˆ–Configrationå®ä¾‹æ„å»ºå‡ºSqlSessionFactoryçš„å®ä¾‹ã€‚ ä¸€ã€é‡è¦æ¦‚å¿µ å‘½åç©ºé—´ï¼ˆNamespacesï¼‰ï¼šé€šå¸¸åŒ…ååŠ ç±»ç›®ç»„æˆå®Œå…¨é™å®šåï¼ˆcom.MyMapper.selectAllï¼‰ï¼Œå®ç°è¯­å¥éš”ç¦»ç¡®å®šå”¯ä¸€æ€§ã€‚ ä½œç”¨åŸŸï¼ˆScopeï¼‰å’Œç”Ÿå‘½å‘¨æœŸ SqlSessionFactoryBuilderï¼šå®Œæˆåˆ›å»ºSqlSessionFactoryåå°±ä¸å†éœ€è¦ã€‚ SqlSessionFactoryï¼šæœ€ä½³ä½œç”¨åŸŸæ˜¯åº”ç”¨ä½œç”¨åŸŸï¼Œæœ€ä¼˜è§£æ˜¯ä½¿ç”¨å•ä¾‹æ¨¡å¼æˆ–è€…é™æ€å•ä¾‹æ¨¡å¼ã€‚ SqlSessionï¼šæœ€ä½³çš„ä½œç”¨åŸŸæ˜¯è¯·æ±‚æˆ–æ–¹æ³•ä½œç”¨åŸŸ 2.2ã€åå°„å·¥å…·ç®± Mybatisè¿›è¡Œå‚æ•°å¤„ç†ã€ç»“æœæ˜ å°„ä¼šæ¶‰åŠåˆ°å¤§é‡çš„åå°„æ“ä½œã€‚Javaåå°„åŠŸèƒ½è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯ä»£ç å¤æ‚æ˜“é”™ï¼Œæ‰€ä»¥åœ¨mybaitsæºç åŒ…org.apache.ibatis.reflectionæœ‰ä¸“é—¨çš„åå°„æ¨¡å—ã€‚ 2.2.1 Reflector&amp;ReflectorFactory Reflectoræ˜¯åå°„æ¨¡å—çš„åŸºç¡€ç±»ï¼Œä¸€ä¸ªreflecotrå®ä¾‹å¯¹åº”ä¸€ä¸ªç±»çš„å…ƒä¿¡æ¯ã€‚æ ¹æ®Java Beanè§„èŒƒï¼Œå°è£…çš„å¯¹getterã€setterå±æ€§æ–¹æ³•æ˜ å°„ã€‚ Reflectoræˆå‘˜å­—æ®µåˆ†æå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031package org.apache.ibatis.reflection;import ....ï¼ˆçœç•¥å¯¼å…¥ç±»ï¼‰&#x2F;** * This class represents a cached set of class definition information that * allows for easy mapping between property names and getter&#x2F;setter methods. * * @author Clinton Begin *&#x2F;public class Reflector &#123; &#x2F;&#x2F;å¯¹åº”çš„classç±»å‹ private final Class&lt;?&gt; type; &#x2F;&#x2F;getteræ–¹æ³•å¯¹åº”çš„å±æ€§åç§°æ•°ç»„ private final String[] readablePropertyNames; &#x2F;&#x2F;setteræ–¹æ³•å¯¹åº”çš„å±æ€§åç§°æ•°ç»„ private final String[] writablePropertyNames; &#x2F;&#x2F;å±æ€§å¯¹åº”çš„setteræ–¹æ³•é›†åˆï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯Invokerå¯¹è±¡ private final Map&lt;String, Invoker&gt; setMethods &#x3D; new HashMap&lt;&gt;(); &#x2F;&#x2F;å±æ€§å¯¹åº”çš„getteræ–¹æ³•é›†åˆï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯Invokerå¯¹è±¡ private final Map&lt;String, Invoker&gt; getMethods &#x3D; new HashMap&lt;&gt;(); &#x2F;&#x2F;è®°å½•äº†å±æ€§ç›¸åº”çš„setteræ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯setteræ–¹æ³•çš„å‚æ•°ç±»å‹ private final Map&lt;String, Class&lt;?&gt;&gt; setTypes &#x3D; new HashMap&lt;&gt;(); &#x2F;&#x2F;è®°å½•äº†å±æ€§ç›¸åº”çš„getteræ–¹æ³•çš„å‚æ•°å€¼ç±»å‹ï¼Œkeyæ˜¯å±æ€§åç§°ï¼Œvalueæ˜¯setteræ–¹æ³•çš„å‚æ•°ç±»å‹ private final Map&lt;String, Class&lt;?&gt;&gt; getTypes &#x3D; new HashMap&lt;&gt;(); &#x2F;&#x2F;è®°å½•é»˜è®¤æ„é€ å™¨ private Constructor&lt;?&gt; defaultConstructor; &#x2F;&#x2F;æ‰€æœ‰å±æ€§åç§°é›†åˆ private Map&lt;String, String&gt; caseInsensitivePropertyMap &#x3D; new HashMap&lt;&gt;(); &#125; ReflectorFactoryæ¥å£å®šä¹‰äº†Reflectorå¯¹è±¡åˆ›å»ºæˆ–è€…ç¼“å­˜ 12345678910package org.apache.ibatis.reflection;public interface ReflectorFactory &#123; &#x2F;&#x2F;ç¡®å®šæ˜¯å¦éœ€è¦ç¼“å­˜è¯¥Reflectorå¯¹è±¡ boolean isClassCacheEnabled(); &#x2F;&#x2F;è®¾ç½®æ˜¯å¦ç¼“å­˜è¯¥Reflectorå¯¹è±¡ void setClassCacheEnabled(boolean classCacheEnabled); &#x2F;&#x2F;åˆ˜å»ºæŒ‡å®šClasså¯¹åº”çš„Reflectorå¯¹è±¡ Reflector findForClass(Class&lt;?&gt; type);&#125; DefaultReflectorFactoryé»˜è®¤å®ç°ReflectorFactoryï¼Œè€ŒCustomReflectorFactoryç»§æ‰¿DefaultReflectorFactoryå¹¶ä¸”ç©ºå®ç°ï¼Œå…¶å…³ç³»å›¾å¦‚ä¸‹ DefaultReflectorFactory 12345678910111213141516171819202122232425262728293031323334353637package org.apache.ibatis.reflection;import java.util.concurrent.ConcurrentHashMap;import java.util.concurrent.ConcurrentMap;public class DefaultReflectorFactory implements ReflectorFactory &#123; &#x2F;&#x2F;è¯¥å­—æ®µå†³å®šæ˜¯å¦å¼€å¯å¯¹Reflectorå¯¹è±¡ private boolean classCacheEnabled &#x3D; true; &#x2F;&#x2F;ä½¿ç”¨ConcurrentMapé›†åˆå®ç°å¯¹Reflectorå¯¹è±¡çš„ç¼“å­˜ private final ConcurrentMap&lt;Class&lt;?&gt;, Reflector&gt; reflectorMap &#x3D; new ConcurrentHashMap&lt;&gt;(); public DefaultReflectorFactory() &#123; &#125; @Override public boolean isClassCacheEnabled() &#123; return classCacheEnabled; &#125; @Override public void setClassCacheEnabled(boolean classCacheEnabled) &#123; this.classCacheEnabled &#x3D; classCacheEnabled; &#125; @Override public Reflector findForClass(Class&lt;?&gt; type) &#123; if (classCacheEnabled) &#123;&#x2F;&#x2F;æ£€æµ‹æ˜¯å¦å¼€å¯ç¼“å­˜ &#x2F;&#x2F; synchronized (type) removed see issue #461 &#x2F;&#x2F;é€šè¿‡çº¿ç¨‹å®‰å…¨ConcurrentHashMapè·å–ç¼“å­˜Reflectorï¼Œæ²¡æœ‰åˆ™é€šè¿‡lambadaè°ƒç”¨æ„é€ æ–°å»ºå¯¹è±¡ return reflectorMap.computeIfAbsent(type, Reflector::new); &#125; else &#123; &#x2F;&#x2F;æœªå¼€å¯ç¼“å­˜åˆ™ç›´æ¥new Reflectorå¯¹è±¡ return new Reflector(type); &#125; &#125;&#125;","tags":[{"name":"Mybatis","slug":"Mybatis","permalink":"https://caochikai.github.io/tags/Mybatis/"}]},{"title":"HttpServletRequestæµé‡å¤è¯»","date":"2019-12-18T12:30:00.000Z","path":"2019/12/18/HttpServletRequestæµé‡å¤è¯»/","text":"HttpServletRequestæµé‡å¤è¯» springmvc controller @RequestBodyæ¥å—å‚æ•°æŠ¥é”™ï¼ŒåŸå› ä¸ºhttp POSTè¯·æ±‚æŠ¥æ–‡ä½“ä¸ºäºŒè¿›åˆ¶æµï¼Œåœ¨HttpServletRequest.getInputStream()ä¸­æµåªèƒ½è¢«è¯»å–ä¸€æ¬¡ï¼Œé‡å¤è¯»å–ä¼šæŠ¥å¦‚ä¸‹ï¼š 1getRead() has already been called for this request&#x2F;getInputStream() has already been called for this request ä¸€ã€è§£å†³æ–¹å¼ ç¬¬ä¸€ç§æ–¹å¼ï¼šé‡å†™HttpServletRequestWrapper å°†InputStream æ›¿æ¢æˆå¯é‡å¤è¯»çš„ByteArrayInputStreamï¼ŒåŸç†å°±æ˜¯åœ¨Filteræˆ–è€…springmvcçš„interceptorä¸­é€šè¿‡æ„é€ å™¨åŒ…è£…HttpServletRequestï¼Œå¹¶ä¸”æŠŠå½“å‰æµç¼“å­˜èµ·æ¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101import javax.servlet.ReadListener;import javax.servlet.ServletInputStream;import javax.servlet.ServletRequest;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletRequestWrapper;import java.io.BufferedReader;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.IOException;import java.io.InputStream;import java.io.InputStreamReader;import java.nio.charset.Charset;/** * è‡ªå®šä¹‰HttpServletRequestWrapper * è§£å†³InputStreamä¸èƒ½é‡å¤è¯»é—®é¢˜ * */public class BufferedServletRequestWrapper extends HttpServletRequestWrapper &#123; private final byte[] body; BufferedServletRequestWrapper(HttpServletRequest request) throws IOException &#123; super(request); String sessionStream = getBodyString(request); body = sessionStream.getBytes(Charset.forName(\"UTF-8\")); &#125; /** * è·å–è¯·æ±‚Body */ private String getBodyString(final ServletRequest request) &#123; StringBuilder sb = new StringBuilder(); InputStream inputStream = null; BufferedReader reader = null; try &#123; inputStream = cloneInputStream(request.getInputStream()); reader = new BufferedReader(new InputStreamReader(inputStream, Charset.forName(\"UTF-8\"))); String line = \"\"; while ((line = reader.readLine()) != null) &#123; sb.append(line); &#125; &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; finally &#123; if (inputStream != null) &#123; try &#123; inputStream.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; if (reader != null) &#123; try &#123; reader.close(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; &#125; &#125; return sb.toString(); &#125; /** * å¤åˆ¶è¾“å…¥æµ */ private InputStream cloneInputStream(ServletInputStream inputStream) &#123; ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); byte[] buffer = new byte[1024]; int len; try &#123; while ((len = inputStream.read(buffer)) &gt; -1) &#123; byteArrayOutputStream.write(buffer, 0, len); &#125; byteArrayOutputStream.flush(); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; return new ByteArrayInputStream(byteArrayOutputStream.toByteArray()); &#125; @Override public BufferedReader getReader() throws IOException &#123; return new BufferedReader(new InputStreamReader(getInputStream())); &#125; @Override public ServletInputStream getInputStream() throws IOException &#123; final ByteArrayInputStream bais = new ByteArrayInputStream(body); return new ServletInputStream() &#123; @Override public int read() throws IOException &#123; return bais.read(); &#125; &#125;; &#125;&#125; ç¬¬äºŒç§æ–¹å¼ï¼šSpringmvcæä¾›äº†è§£å†³æ–¹æ¡ˆContentCachingRequestWrapperï¼Œæ€è·¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ä»£ç æ›´åŠ ä¸¥è°¨ç‚¹ã€‚æºç æˆ‘å°±ä¸è´´äº†ï¼Œå¼€å¤´æ³¨é‡Šè¯´æ˜è´´ä¸€ä¸‹ï¼Œç„¶åéœ€è¦æ³¨æ„äº‹é¡¹å’Œæ­£ç¡®çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/** *ContentCachingRequestWrapperæºç æ³¨é‡Šå¦‚ä¸‹ * &#123;@link javax.servlet.http.HttpServletRequest&#125; wrapper that caches all content read from * the &#123;@linkplain #getInputStream() input stream&#125; and &#123;@linkplain #getReader() reader&#125;, * and allows this content to be retrieved via a &#123;@link #getContentAsByteArray() byte array&#125;. * * &lt;p&gt;Used e.g. by &#123;@link org.springframework.web.filter.AbstractRequestLoggingFilter&#125;. * * @author Juergen Hoeller * @author Brian Clozel * @since 4.1.3 * @see ContentCachingResponseWrapper */package com.qm.interceptor;import org.springframework.web.util.ContentCachingRequestWrapper;import javax.servlet.*;import javax.servlet.http.HttpServletRequest;import java.io.IOException;/** * é…ç½®å“ªäº›è¯·æ±‚å¯ä»¥è¿›è¡Œé‡å¤è¯»æ•°æ® * */public class cachingRequestBodyFilter implements Filter &#123; @Override public void init(FilterConfig filterConfig) throws ServletException &#123; &#125; @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; // é˜²æ­¢æµè¯»å–ä¸€æ¬¡åå°±æ²¡æœ‰äº†, æ‰€ä»¥éœ€è¦å°†æµç»§ç»­å†™å‡ºå» HttpServletRequest httpServletRequest = (HttpServletRequest) request; String requestURI = httpServletRequest.getRequestURI(); // è¿™é‡Œå°†åŸå§‹requestä¼ å…¥ï¼Œè¯»å‡ºæµå¹¶å­˜å‚¨ //PATH ä¸ºå¯é‡å¤è¯»çš„è·¯å¾„å¼€å§‹æˆ–è€…æ¥å—éƒ¨åˆ† ä¾‹å¦‚ï¼šcaching.do if (requestURI.endsWith(\"caching.do\")) &#123; // è¿™é‡Œå°†åŸå§‹requestä¼ å…¥ï¼Œè¯»å‡ºæµå¹¶å­˜å‚¨ ContentCachingRequestWrapper requestWrapper = new ContentCachingRequestWrapper(httpServletRequest); // è¿™é‡Œå°†åŸå§‹requestæ›¿æ¢ä¸ºåŒ…è£…åçš„requestï¼Œæ­¤åæ‰€æœ‰è¿›å…¥controllerçš„requestå‡ä¸ºåŒ…è£…åçš„request chain.doFilter(requestWrapper, response); &#125; else &#123;// ä¸è¦è¦†ç›–æ‰€æœ‰çš„è¯·æ±‚ï¼Œé˜²æ­¢è¦†ç›–å…¶ä»–äººè¯·æ±‚ chain.doFilter(request, response); &#125; &#125; @Override public void destroy() &#123; &#125;&#125; äºŒã€å‚è€ƒå¦‚ä¸‹ï¼šHttpServletRequestæ•°æ®æµé‡å¤è¯»é—®é¢˜","tags":[{"name":"Spring","slug":"Spring","permalink":"https://caochikai.github.io/tags/Spring/"}]},{"title":"BigDecimalé‡‘é¢è®¡ç®—","date":"2019-12-16T16:26:58.000Z","path":"2019/12/17/BigDecimalé‡‘é¢è®¡ç®—/","text":"å…³äºé‡‘é¢è®¡ç®—ï¼Œé€šå¸¸æœ‰åŠ å‡ä¹˜é™¤ï¼Œå››èˆäº”å…¥ç­‰ã€‚ add()åŠ æ³•å‡½æ•°ï¼šè¦æ³¨æ„BigDecimalåŠ æ³•å¾—åˆ°çš„ç»“æœä¸ºé›¶ï¼Œå› ä¸ºBigDecimalçš„åŠ æ³•éœ€è¦ä¸€ä¸ªå€¼å»æ¥æ”¶ï¼ŒåŠ æ³•ä¸ä¼šæ”¹å˜è°ƒç”¨è€…è‡ªèº«çš„å€¼ã€‚ subtract()å‡æ³•å‡½æ•°ï¼šåŒåŠ æ³•ï¼› multiply()ä¹˜æ³•å‡½æ•°ï¼šæ³¨æ„Doubleè½¬BigDecimalï¼Œå°½é‡ç”¨å­—ç¬¦ä¸²çš„å½¢å¼åˆå§‹åŒ–ã€‚å› ä¸ºä½¿ç”¨BigDecimalç±»æ„é€ æ–¹æ³•ä¼ å…¥doubleç±»å‹æ—¶ï¼Œè®¡ç®—çš„ç»“æœæ˜¯ä¸ç²¾ç¡®çš„ï¼ divide()é™¤æ³•å‡½æ•°ï¼šé¿å…æŠ›å‡ºé™¤é›¶å¼‚å¸¸ï¼Œæ–¹å¼å°†é™¤è¿ç®—å°½é‡è½¬æ¢æˆç­‰ä»·çš„ä¹˜è¿ç®—ã€‚ ä¿ç•™ä¸¤ä½å°æ•°ä¸”å››èˆäº”å…¥ï¼švalue.setScale(2, BigDecimal.ROUND_HALF_UP); BigDecimalé™æ€å¸¸é‡å€¼ï¼Œæ¯”å¦‚BigDecimal.ZEROç­‰ï¼› ä¾‹å­åˆ¨æï¼š1234567891011121314151617181920212223242526BigDecimal num1 = new BigDecimal(0.005); BigDecimal num2 = new BigDecimal(1000000); BigDecimal num3 = new BigDecimal(-1000000); //å°½é‡ç”¨å­—ç¬¦ä¸²çš„å½¢å¼åˆå§‹åŒ– BigDecimal num12 = new BigDecimal(\"0.005\"); BigDecimal num22 = new BigDecimal(\"1000000\"); BigDecimal num32 = new BigDecimal(\"-1000000\");//åŠ æ³• BigDecimal result1 = num1.add(num2); BigDecimal result12 = num12.add(num22); //å‡æ³• BigDecimal result2 = num1.subtract(num2); BigDecimal result22 = num12.subtract(num22); //ä¹˜æ³• BigDecimal result3 = num1.multiply(num2); BigDecimal result32 = num12.multiply(num22); //ç»å¯¹å€¼ BigDecimal result4 = num3.abs(); BigDecimal result42 = num32.abs(); //é™¤æ³• BigDecimal result5 = num2.divide(num1,20,BigDecimal.ROUND_HALF_UP); BigDecimal result52 = num22.divide(num12,20,BigDecimal.ROUND_HALF_UP); resultå…¨éƒ¨è¾“å‡ºç»“æœï¼Œåˆå§‹åŒ–å»ºè®®ä½¿ç”¨String ç»“æœ å‚è€ƒå¦‚ä¸‹BigDecimalåŠ å‡ä¹˜é™¤è®¡ç®—","tags":[]},{"title":"Springboot+vueéƒ¨ç½²è·¯ç”±404","date":"2019-12-15T08:32:00.000Z","path":"2019/12/15/hello-world/","text":"é—®é¢˜èƒŒæ™¯vueå•é¡µé¢è·¯ç”±ï¼Œåˆ·æ–°åœ°å€æˆ–è€…è¯·æ±‚é“¾æ¥ï¼Œéƒ½ä¼š404 user www; worker_processes auto; error_log /var/log/nginx/error.log; pid /run/nginx.pid; events { worker_connections 51200; multi_accept on; } http { include mime.types; default_type application/octet-stream; log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos; &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos; &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; #gzip on; gzip on; server { listen 80; root /www/app/; server_name gdhxy.cn; try_files $uri $uri/ /index.html; } server { listen 80; root /www/app/; server_name www.gdhxy.cn; try_files $uri $uri/ /index.html; } server { listen 80; server_name admin.gdhxy.cn; try_files $uri $uri/ /index.html; location / { proxy_redirect off; proxy_pass http://127.0.0.1:38806; } } }è§£å†³æ–¹å¼ 1ã€nginxé…ç½®ï¼štry_files $uri $uri/ /index.htmlï¼›2ã€springbootæŒ‡å®š404åˆ°index.html. import org.springframework.boot.web.servlet.error.ErrorController; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import javax.servlet.http.HttpServletRequest; @Controller public class MyErrorController implements ErrorController { @RequestMapping(&quot;/error&quot;) public String handleError(HttpServletRequest request) { //è·å–statusCode:404,é‡å®šå‘åˆ°é¦–é¡µ Integer statusCode = (Integer) request.getAttribute(&quot;javax.servlet.error.status_code&quot;); if (statusCode == 404) { return &quot;/index.html&quot;; } else { return &quot;/500&quot;; } } @Override public String getErrorPath() { return &quot;/error&quot;; } }","tags":[{"name":"Spring","slug":"Spring","permalink":"https://caochikai.github.io/tags/Spring/"}]},{"title":"æœåŠ¡å™¨é…ç½®è®°å½•","date":"2019-09-27T16:48:12.000Z","path":"2019/09/28/æœåŠ¡å™¨é…ç½®è®°å½•/","text":"æœåŠ¡å™¨é…ç½®è®°å½•ä¸€ã€èƒŒæ™¯ çœŸå®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼šnginxã€tomcaté…ç½®httpsè¯ä¹¦ äºŒã€nginxå®‰è£…è¿‡ç¨‹ï¼š123456789101112131415//ä¸€é”®å®‰è£…ä¸Šé¢å››ä¸ªä¾èµ–yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel//ä¸‹è½½taråŒ…wget http://nginx.org/download/nginx-1.16.1.tar.gztar xzf nginx-1.16.1.tar.gz -C /usr/local//æ–‡ä»¶åæ”¹nginx-1.16.1æˆnginx//è¿›å…¥nginxç›®å½•cd /usr/local/nginx//å…³è”ç¼–è¯‘httpsæ¨¡å— ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module//æ‰§è¡Œmakeå‘½ä»¤ç¼–è¯‘æºç make//æ‰§è¡Œmake installå®‰è£…å¯æ‰§è¡Œbinmake install//æ–°å»ºlogsï¼ˆæ—¥å¿—ï¼‰å’Œsslï¼ˆè¯ä¹¦ï¼‰æ–‡ä»¶å¤¹ httpsæµè§ˆå™¨å½±å“â€”â€”æ··åˆå†…å®¹ è§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™ï¼Œæµè§ˆå™¨è®¤ä¸ºhttpsè¯·æ±‚ä¸­èµ„æºæ˜¯httpçš„cssã€jså’Œå›¾ç‰‡éƒ½æ— æ³•æ­£å¸¸åŠ è½½ï¼Œé€ æˆæ— æ³•åŒåè®®å…¼å®¹ï¼ 12æµè§ˆå™¨è®¿é—®åå¼€å‘è€…æ¨¡å¼çœ‹åˆ°çš„æŠ¥é”™ä¿¡æ¯ï¼šMixed Content: The page at &#39;https:&#x2F;&#x2F;dashboard.domain.com&#x2F;wire&#39; was loaded over HTTPS, but requested an insecure stylesheet &#39;http:&#x2F;&#x2F;dashboard.domain.com&#x2F;static&#x2F;css&#x2F;flickity.css&#39;. This request has been blocked; the content must be served over HTTPS. nginxè§£å†³é…ç½®12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061user www;worker_processes auto;error_log /var/log/nginx/error.log;pid /run/nginx.pid;events &#123; worker_connections 51200; multi_accept on;&#125;http &#123; include mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; #gzip on; gzip on; server &#123; listen 80; listen 443 ssl; server_name chinaffxz.com; #charset koi8-r; ssl_certificate /usr/local/nginx/ssl/2879444_chinagzhxy.com.pem; ssl_certificate_key /usr/local/nginx/ssl/2879444_chinagzhxy.com.key; location / &#123; proxy_pass http://127.0.0.1:xxxx/; proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #è§£å†³å…¼å®¹é…ç½®è¦ç‚¹ proxy_set_header X-Forwarded-Proto $scheme; proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125;&#125; Tomcaté…ç½®1234567891011121314151617181920212223242526272829303132&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Server port=\"8006\" shutdown=\"SHUTDOWN\"&gt; &lt;Listener className=\"org.apache.catalina.core.JreMemoryLeakPreventionListener\" /&gt; &lt;Listener className=\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\" /&gt; &lt;Listener className=\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\" /&gt; &lt;Listener className=\"org.apache.catalina.core.AprLifecycleListener\" /&gt; &lt;GlobalNamingResources&gt; &lt;Resource name=\"UserDatabase\" auth=\"Container\" type=\"org.apache.catalina.UserDatabase\" description=\"User database that can be updated and saved\" factory=\"org.apache.catalina.users.MemoryUserDatabaseFactory\" pathname=\"conf/tomcat-users.xml\" /&gt; &lt;/GlobalNamingResources&gt; &lt;Service name=\"Catalina\"&gt; &lt;Connector port=\"38080\" protocol=\"HTTP/1.1\" connectionTimeout=\"20000\" redirectPort=\"8443\" maxThreads=\"1000\" minSpareThreads=\"20\" acceptCount=\"1000\" maxHttpHeaderSize=\"65536\" debug=\"0\" disableUploadTimeout=\"true\" useBodyEncodingForURI=\"true\" enableLookups=\"false\" URIEncoding=\"UTF-8\" /&gt; &lt;Engine name=\"Catalina\" defaultHost=\"localhost\"&gt; &lt;!-- è§£å†³å…¼å®¹è¦ç‚¹--&gt; &lt;Valve className=\"org.apache.catalina.valves.RemoteIpValve\" remoteIpHeader=\"X-Forwarded-For\" protocolHeader=\"X-Forwarded-Proto\" protocolHeaderHttpsValue=\"https\"/&gt; &lt;Realm className=\"org.apache.catalina.realm.LockOutRealm\"&gt; &lt;Realm className=\"org.apache.catalina.realm.UserDatabaseRealm\" resourceName=\"UserDatabase\" /&gt; &lt;/Realm&gt; &lt;Host name=\"localhost\" appBase=\"webapps\" unpackWARs=\"true\" autoDeploy=\"true\"&gt; &lt;!-- Access log processes all example. Documentation at: /docs/config/valve.html Note: The pattern used is equivalent to using pattern=\"common\" --&gt; &lt;Valve className=\"org.apache.catalina.valves.AccessLogValve\" directory=\"logs\" prefix=\"localhost_access_log\" suffix=\".txt\" pattern=\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\" /&gt; &lt;Context path=\"\" docBase =\"mall\" debug=\"0\" reloadable=\"true\" crossContext=\"false\"/&gt; &lt;/Host&gt; &lt;/Engine&gt; &lt;/Service&gt;&lt;/Server&gt; gitæŒç»­éƒ¨ç½²shellè„šæœ¬ è§£å†³Linux CentOSä¸­cp -f å¤åˆ¶å¼ºåˆ¶è¦†ç›–çš„å‘½ä»¤æ— æ•ˆçš„æ–¹æ³•ï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨cp -iä½¿ç”¨äº¤äº’æ–¹å¼é¿å…è¯¯æ“ä½œï¼Œä½†åœ¨è‡ªåŠ¨è„šæœ¬ä¸­åº”å½“é¿å…ï¼Œæ¨è\\cpã€‚ 123456789101112#update codecd /root/dowload/mall/duoshanghugit fetch origin git pull &gt; /root/dowload/mall/logs/mall_git.log &amp;#package mvn package -Dmaven.test.skip=truesleep 2s#cp war to tomcat webapp\\cp -fr /root/dowload/mall/duoshanghu/target/mall.war /usr/local/env/tomcat/webapps/mall.warsleep 1s#restart.shsh /usr/local/env/tomcat/bin/restart.sh tomcaté‡å¯è„šæœ¬1234567891011121314151617181920212223242526272829303132#!/bin/sh#åˆå§‹åŒ–å…¨å±€ç¯å¢ƒå˜é‡. /etc/profile#set java environmentexport CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib#æŸ¥æ‰¾tomcatçš„pidpid=`ps aux | grep tomcat | grep -v grep | grep -v Restart | grep -v restart | awk '&#123;print $2&#125;'`echo \"the tomcat pid is $pid\"#åˆ¤æ–­tomcatè¿›ç¨‹æ˜¯å¦å­˜åœ¨if [ -n \"$pid\" ];then sleep 1 pid=`ps aux | grep tomcat | grep -v grep | grep -v restart | grep -v Restart | awk '&#123;print $2&#125;'` if [ -n \"$pid\" ]; then sleep 1 echo \"tomcatè¿›ç¨‹å°†è¢«æ€?\" kill -9 $pid fi sleep 1 echo \"tomcatè¿›ç¨‹å·²ç»è¢«æ€æ­»ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat.\" service tomcat status sleep 1s service tomcat startelse echo \"tomcatè¿›ç¨‹ä¸å­˜åœ¨ï¼Œå…ˆé‡æ–°å¯åŠ¨tomcat.\" service tomcat status sleep 1s service tomcat startfi mavenç¼–è¯‘å®Œæ•´ä¾èµ–ç®¡ç†1ã€æ¥æº è§£å†³webapp/WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ…ï¼Œä¸”åœ¨linuxMavenç¼–è¯‘æŠ¥é”™[ERROR] Fatal Error: Unable to find package java.lang in classpath or bootclasspathï¼Œè‡´å‘½é”™è¯¯: åœ¨ç±»è·¯å¾„æˆ–å¼•å¯¼ç±»è·¯å¾„ä¸­æ‰¾ä¸åˆ°ç¨‹åºåŒ… java.lang 2ã€è§£å†³æ–¹æ³•Linuxè§£å†³åŠæ³•ï¼Œä½¿ç”¨mavenè‡ªå¸¦çš„å˜é‡${path.separator}è·¯å¾„åˆ†éš”ç¬¦ï¼ŒåŸå› æ˜¯åœ¨Windowsä¸‹æ˜¯åˆ†å·;ï¼Œåœ¨linuxä¸‹æ˜¯å†’å·: åŒæ—¶é…ç½®å¯¼å…¥webapp/WEB-INF/libå’Œjdkçš„rt.jarã€jce.jarï¼Œå®Œç¾è§£å†³ç¯å¢ƒé…ç½®å¸¦æ¥çš„æ— æ³•packageæ‰¾ä¸åˆ°ä¾èµ–é—®é¢˜ã€‚ pom.xmlï¼š12345678910111213141516171819202122232425262728293031323334&lt;build&gt; &lt;finalName&gt;$&#123;artifactId&#125;&lt;/finalName&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;1.8&lt;/source&gt; &lt;target&gt;1.8&lt;/target&gt; &lt;compilerArguments&gt; &lt;verbose /&gt; &lt;bootclasspath&gt;$&#123;java.home&#125;/lib/rt.jar$&#123;path.separator&#125;$&#123;java.home&#125;/lib/jce.jar&lt;/bootclasspath&gt; &lt;extdirs&gt;$&#123;basedir&#125;/src/main/webapp/WEB-INF/lib&lt;/extdirs&gt; &lt;/compilerArguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;resources&gt; &lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.*&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;false&lt;/filtering&gt; &lt;/resource&gt; &lt;resource&gt; &lt;directory&gt;src/main/java&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;false&lt;/filtering&gt; &lt;/resource&gt; &lt;/resources&gt; &lt;/build&gt; å‚è€ƒè§£å†³Nginxåä»£Tomcat Httpã€Httpsæ··åˆå†…å®¹æŠ¥é”™ è§£å†³WEB-INF/libç›®å½•ä¸‹çš„jaråŒ…æ— æ³•ç”¨mavenæ‰“åŒ… åé¦ˆä¸å»ºè®® å½“äº†ç»„é•¿é¢è¯•åŠ è¿ç»´ï¼Œå¯¹æ¥ä¸€å †æ”¯ä»˜å’Œç‰©æµã€çŸ­ä¿¡å’Œæ¨é€è´¦å·ï¼Œä»Šå¤©è®°å½•ä¸€ä¸‹é¢å‘DevOpsï¼ markdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚ é‚®ç®±ï¼šcaochikai@qq.comï¼Œæœ‰é—®é¢˜å‘é‚®ä»¶ã€‚","tags":[{"name":"Linux","slug":"Linux","permalink":"https://caochikai.github.io/tags/Linux/"},{"name":"nginx","slug":"nginx","permalink":"https://caochikai.github.io/tags/nginx/"},{"name":"tomcat","slug":"tomcat","permalink":"https://caochikai.github.io/tags/tomcat/"},{"name":"maven","slug":"maven","permalink":"https://caochikai.github.io/tags/maven/"}]},{"title":"JVMè®°å½•","date":"2019-09-14T04:32:49.000Z","path":"2019/09/14/JVMè®°å½•/","text":"JVMè®°å½•ä¸€ã€é”™è¯¯ èƒŒæ™¯ï¼šè‡ªåŠ¨ç­”é¢˜çˆ¬è™«ç”±äºä¹°çš„è…¾è®¯äº‘1æ ¸2G1Mï¼ŒJenkinsã€springbootçˆ¬è™«å’Œç«ç‹æµè§ˆå™¨é©±åŠ¨ã€‚ çŸ¥è¯†èƒŒæ™¯ï¼šJDWPï¼šè°ƒè¯•ç½‘ç»œåè®®(Java Debug Wire Protocol)ï¼›è°ƒè¯•çº¿åè®®ï¼›jvmtiï¼šï¼ˆJava Virtual Machine Tool Interfaceï¼‰jvmä»£ç†ï¼› çŒœæµ‹ï¼šSeleniumé€šè¿‡driveré©±åŠ¨Firefoxæµè§ˆå™¨ï¼Œå¤šæ¬¡æ— æ³•å…³é—­æµè§ˆå™¨é€ æˆå†…å­˜æ— æ³•é‡Šæ”¾æœ€åæº¢å‡ºï¼› å¼•ç”¨æ–‡ç« ï¼ˆæœ‰å…´è¶£å¯æ·±å…¥äº†è§£ï¼‰ï¼šjvmti agenté»‘ç§‘æŠ€ï¼Œé˜¿é‡Œäº‘äº‘ç›‘æ§ï¼› 1FATAL ERROR in native method: JDWP Can&#39;t allocate jvmti memory, jvmtiError&#x3D;JVMTI_ERROR_OUT_OF_MEMORY(110) åé¦ˆä¸å»ºè®® ç«‹ä¸ªflagï¼šä¸å®šæœŸæ›´æ–°ï¼Œä¸€æ›´ä¸€å‘¨ã€‚ markdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚ é‚®ç®±ï¼šcaochikai@qq.comï¼Œæœ‰é—®é¢˜å‘é‚®ä»¶ã€‚","tags":[{"name":"spring","slug":"spring","permalink":"https://caochikai.github.io/tags/spring/"},{"name":"JVM","slug":"JVM","permalink":"https://caochikai.github.io/tags/JVM/"}]},{"title":"å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶","date":"2019-05-22T12:34:48.000Z","path":"2019/05/22/å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶/","text":"å·¥å…·æ”¶è—â€”â€”ideaæ¨èæ’ä»¶ä¸€ã€æ¦‚å¿µ â€‹ å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œåšä¸»æ˜¯ä¸ªæ­»å¿ å·¥å…·æ´¾ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªå¤§é—®é¢˜å¯èƒ½ä¼šæ”¶é›†å¤šä¸ªå·¥å…·å’Œæ–¹æ¡ˆï¼Œç„¶åæ±‚è¯å¯¹æ¯”å‡ºä½“éªŒæŠ¥å‘Šã€‚åç»­æ–‡ç« æœ‰ä¸€å¤§ç±»å°±æ˜¯å·¥å…·ç±»æ¨èï¼Œè€Œæœ¬ç¯‡æ–‡ç« é‡ç‚¹å°±æ˜¯idea å®‰è£…æ’ä»¶è®°å½•ï¼Œç®€è¦è®°å½•å®‰è£…æ–¹æ³•å¿«é€Ÿæ­å»ºä¸ªæ€§åŒ–ideaï¼Œè¿˜æœ‰ä¸€äº›å…³äºUIæ–¹é¢æ’ä»¶å¯è°“å¤šä¸èƒœæ•°ï¼Œè€Œä¸”æ¯ä¸ªäººå£å‘³ä¸ä¸€ï¼Œè¯·å„ä½è‡ªè¡Œé€‰æ‹©â€”â€”æ’ä»¶æœç´¢æŠ€å·§tagsä¸ºThemeæˆ–è€…UIã€‚ æ’ä»¶åˆ—è¡¨æœ€å¼ºå¤§æ’ä»¶å«å†•ä¹‹ç‹â€”â€”lambdaè¡¨è¾¾å¼ åç§° æè¿° JRebel ä»£æ›¿springboot devçƒ­éƒ¨ç½²æ–¹æ¡ˆï¼Œæœ€æ–¹ä¾¿æ¿€æ´»æ–¹å¼ Lombok ç²¾ç®€beanï¼Œå„ç§åŠŸèƒ½å¼ºå¤§åˆå®ç”¨æ³¨è§£ï¼Œæ¬ç –äººçš„MVPï¼Œç»“åˆHutoolå®åœ¨å®Œç¾ AceJump å…‰æ ‡è·³è·ƒï¼Œæ›¿ä»£vimä¸äºŒä¹‹é€‰ MavenHelper å¿«é€Ÿåˆ†æmaven åŒ…å†²çªçš„é—®é¢˜ï¼Œæœç´¢åŒ…å MyBatis Log Plugin Restore the mybatis generate sql to original whole sql.ï¼ˆæ‹¼æ¥å®Œæ•´sqlï¼‰ Log Support 2 å¿«é€Ÿlog.info()ï¼Œç»“åˆLombokæ’ä»¶æ³¨è§£@Slf4jå¯ä»¥è¯´æ— æ•Œ Free Mybatis plugin Mybaitsæ”¯æŒè·³è½¬ï¼Œæœ‰é’±å¤§çˆ·è¯·æ”¶è´¹ç‰ˆMybatis pluginå¼ºå¤§ç ´è§£è¾ƒå°‘ï¼Œå·®è¯„ Rainbow Brackets å½©è™¹æ‹¬å·ï¼Œå¤šå±‚åµŒå¥—ä»£ç æ˜¾ç¤ºåŠ©æ‰‹ String Manipulation å„ç§å„æ ·å­—ç¬¦ä¸²æ ¼å¼è½¬åŒ– RestfulToolkit ä¸€å¥— RESTful æœåŠ¡å¼€å‘è¾…åŠ©å·¥å…·é›† Alibaba Cloud Toolkit ç»“åˆé˜¿é‡Œäº‘ï¼ˆéé˜¿é‡Œä¹Ÿæ”¯æŒï¼‰ï¼Œå¤šèŠ‚ç‚¹å‘å¸ƒå·¥å…·åŠ å¼ºåŠ›linuxå®¢æˆ·ç«¯ stackoverflow stackoverflowå¿«é€Ÿæœç´¢bugæ’ä»¶ Translation æœ€å¼ºå¤§çš„ç¿»è¯‘æ’ä»¶ï¼Œæ”¯æŒä¸­æ–‡æ›¿æ¢è‹±æ–‡ï¼Œè§£å†³èµ·è‹±æ–‡å˜é‡åéš¾çš„é‡åº¦æ‚£è€… Key Promoter X æ‰€æœ‰æ“ä½œçš„å¿«æ·é”®æç¤ºï¼Œå¿˜è®°é¼ æ ‡çœŸçš„ Cyan Light Theme A light themeï¼Œåé’è‰²å¯¹çœ¼ç›å¾ˆæŸ”å’Œèˆ’æœï¼Œé»‘æš—ä¸»é¢˜å®åœ¨ä¸é€‚åº” åé¦ˆä¸å»ºè®® 2012å¹´javaç¨‹åºå‘˜å¯ä»¥è¯´éå¸¸åƒé¦™ï¼Œä»Šå¹´2019ä»ä¸šäººæ•°æš´å¢ï¼ŒèŒä¸šå‘å±•æŒ‘æˆ˜å˜å¾—è¶Šæ¥è¶Šå¤§ï¼ç°åœ¨æµè¡Œè‡ªåŠ¨æ„å»ºå’Œè‡ªåŠ¨éƒ¨ç½²CIï¼Œå¼€å‘è¿ç»´ä¸€ä½“åŒ–dockerï¼Œæ•´ä¸ªäº’è”ç½‘éƒ½åœ¨è¿½æ±‚æ•æ·å¼€å‘çš„ä»Šå¤©ã€‚æŒæ¡ä¸€æ¬¾è¿½æ±‚æ•ˆç‡åŠŸèƒ½çš„IDEéå¸¸é‡è¦ï¼Œå¾ˆå¤šç¾¤å’Œå…¬ä¼—å·å¯¹ideå’ŒEclipseäº‰è®®å¾ˆå¤§ã€‚ä½†è¯·è®°ä½æ–¯å¤§æ—åè¨€â€”â€”è½åå°±è¦æŒ¨æ‰“ï¼Œideæœ¬èº«ä»£è¡¨é«˜æ•ˆï¼Œä½†æ˜¯æ’ä»¶ä¹Ÿåˆ«è£…å¤ªå¤šï¼Œå…å¾—å¯åŠ¨è¿˜è¦åŠå¤©å“ˆå“ˆå“ˆğŸ˜€ ï¼ˆé¦–æ¨ï¼‰æ…•è¯¾ç½‘å…è´¹æ•™ç¨‹ï¼šIntelliJ IDEAç¥å™¨ä½¿ç”¨æŠ€å·§ ï¼ˆæ¨èï¼‰å°šç¡…è°·IDEAè§†é¢‘æ•™ç¨‹ï¼šé“¾æ¥ï¼šhttps://pan.baidu.com/s/11biVBv9EI9yfL6Cee0r0LQï¼Œå¯†ç ï¼šn7hn çœ‹å®Œä¸Šé¢ä¸¤ä¸ªæ•™ç¨‹ï¼Œä½ ä¼šæ€€ç–‘è‡ªå·±ç”¨çš„ideaæ˜¯å‡çš„ï¼ŒåŸæ¥å†™ä»£ç è¿˜å¯ä»¥è¿™æ ·çš„ã€‚ é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"tool","slug":"tool","permalink":"https://caochikai.github.io/tags/tool/"},{"name":"plugin","slug":"plugin","permalink":"https://caochikai.github.io/tags/plugin/"},{"name":"idea","slug":"idea","permalink":"https://caochikai.github.io/tags/idea/"}]},{"title":"springbootæ•´åˆelasticsearch","date":"2019-05-21T13:40:31.000Z","path":"2019/05/21/springbootæ•´åˆelasticsearch/","text":"springbootæ•´åˆelasticsearchä¸€ã€æ¦‚å¿µ elasticsearchå®˜ç½‘æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å¤šç”¨æˆ·èƒ½åŠ›çš„å…¨æ–‡æœç´¢å¼•æ“ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå…·æœ‰RESTful webæ¥å£çš„javaåº”ç”¨ã€‚ç›®å‰å¼€æºè½¯ä»¶å•†ä¸šæ¯”è¾ƒä¸é”™çš„ä¾‹å­ï¼Œä¸Solrä¸€æ ·éƒ½æ˜¯åŸºäºLuceneï¼Œå¤§æ•°æ®hadoopä¹Ÿæ˜¯è„±èƒäºLuceneã€‚Solrå¼€æºè€Œä¸”ç”Ÿæ€æ¯”è¾ƒæˆç†Ÿï¼Œelasticsearchç›®å‰æœ€ç«ä¹Ÿæ˜¯å•†ä¸šåº”ç”¨æ–¹é¢éå¸¸å¥½çš„æœç´¢å¼•æ“ã€‚ 3wåŸåˆ™ï¼š question whatï¼šå¸¸è§ç«™å†…/appå†…æœç´¢æœåŠ¡éœ€æ±‚ï¼šå•†å“æ–‡ç« çš„æ¨¡ç³Šæœç´¢ï¼Œç²¾ç¡®æœç´¢ï¼Œæ‹¼éŸ³æœç´¢ ã€‚ question whyï¼šå€ŸåŠ©elasticsearchå’Œanalysis-ikä¸­æ–‡åˆ†è¯å™¨ï¼Œå¿«é€Ÿå®ç°æœç´¢æœåŠ¡åŠŸèƒ½ã€‚ howï¼šåœ¨å¾®æœåŠ¡å½“ä¸­ï¼Œé€šå¸¸åˆ©ç”¨mqæ¶ˆæ¯ä¸­é—´ä»¶æ¥åŒæ­¥æ•°æ®é›†ç¾¤æœç´¢æœåŠ¡ï¼ˆè„šæ‰‹æ¶é‡Œæ²¡æœ‰mqï¼‰ï¼Œå€ŸåŠ©ElasticsearchTemplateï¼ˆspring æ¨¡æ¿å·¥å…·ç±»å¼ºå¤§ï¼‰APIç»´æŠ¤ç´¢å¼•å’Œæœç´¢æŸ¥è¯¢ã€‚ äºŒã€è½åœ°å®ç° æ ¹æ®ç äº‘ä¼ä¸šçº§æœç´¢è„šæ‰‹æ¶çš„æ–‡æ¡£å¯çŸ¥ï¼Œæ³¨æ„ç‰ˆæœ¬ä¸ºSpringboot2.1.1+elasticsearch6.5.3ï¼Œelasticsearchå’Œanalysis-ikæ’ä»¶ç‰ˆæœ¬å¿…é¡»ç»Ÿä¸€ï¼Œè€Œä¸”æ–°ç‰ˆæœ¬elasticsearch 7ä¸é€‚ç”¨äºè¯¥å·¥ç¨‹ã€‚è¿™ä¸ªå‚è€ƒå·¥ç¨‹çš„ä¸­æ–‡åˆ†è¯æœç´¢æ•ˆæœä¸å¤ªç†æƒ³ï¼Œä¸€èˆ¬å¯Œæ–‡æœ¬çš„å†…å®¹è¿›å…¥ç´¢å¼•ä¹‹å‰è¦åˆ©ç”¨å­—ç¬¦è¿‡æ»¤å™¨æ¸…æ´—ä¸æ­£å¸¸çš„å­—ç¬¦ã€‚é€šå¸¸ä¸ºäº†ä¿è¯ç´¢å¼•æ—¶è¦†ç›–åº¦å’Œæœç´¢æ—¶å‡†ç¡®åº¦,ç´¢å¼•åˆ†è¯å™¨é‡‡ç”¨ik_max_word,æœç´¢åˆ†æå™¨é‡‡ç”¨ik_smartæ¨¡å¼ã€‚å…·ä½“elasticsearch6.5.3çš„å®‰è£…è¿‡ç¨‹è¯·å‚è€ƒç äº‘çš„README.mdï¼Œç›®å‰æ­£åœ¨åœ¨å…¬å¸é¡¹ç›®ä½¿ç”¨è¯·æ”¾å¿ƒï¼Œå•å…ƒæµ‹è¯•çš„æ•ˆæœä¹Ÿéå¸¸niceã€‚ 1ã€æ·»åŠ ä¾èµ–1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;&lt;/dependency&gt; 2ã€é…ç½®å¼•å¯¼ç±»12345#============================# é»˜è®¤çš„èŠ‚ç‚¹åç§°elasticsearchspring.data.elasticsearch.cluster-name=my-application# elasticsearch è°ƒç”¨åœ°å€ï¼Œå¤šä¸ªä½¿ç”¨â€œ,â€éš”å¼€spring.data.elasticsearch.cluster-nodes=localhost:9300 3ã€DWMQSenderåŒ…è£…rabbitTemplateå‘é€æ¶ˆæ¯åŒæ­¥æ•°æ®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778//æœåŠ¡ç±»çš„ç®€å†™å¦‚ä¸‹&#123;//æ³¨å…¥sender @AutowiredDWMQSender sender;//å‘é€å†™æ³•ArticlesMessage extends DWMQMessage&lt;æ¶ˆæ¯å†…å®¹ç±»å‹&gt;JSONObject jsonObject = JSON.parseObject(JSON.toJSONString(articles)); jsonObject.put(Groups.ACTION, Groups.ADD); sender.sendMessage(new ArticlesMessage(jsonObject));&#125;//å°è£…å‘é€mq messageimport com.alibaba.fastjson.JSON;import com.dwalk.common.exception.EU;import com.dwalk.common.mq.mto.DWMQMessage;import com.dwalk.common.utils.SU;import com.rabbitmq.client.Channel;import lombok.extern.slf4j.Slf4j;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.amqp.AmqpException;import org.springframework.amqp.core.Message;import org.springframework.amqp.core.MessagePostProcessor;import org.springframework.amqp.rabbit.annotation.RabbitHandler;import org.springframework.amqp.rabbit.core.RabbitTemplate;import org.springframework.amqp.rabbit.support.CorrelationData;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import java.time.LocalDateTime;import java.util.concurrent.atomic.AtomicLong;/** * æ¶ˆæ¯æˆåŠŸå‘é€åˆ°MQæœåŠ¡å™¨åçš„å›è°ƒç¡®è®¤ */@Slf4j@Componentpublic class DWMQSender &#123; @Autowired RabbitTemplate rabbitTemplate; @Autowired DWMQRetry retry; // public void sendMessage(DWMQMessage mto) &#123; if( mto.getObj()==null ) &#123; EU.te(\"æ¶ˆæ¯å†…å®¹ä¸ºç©º\"); &#125; if( SU.isNull( mto.getRoutingKey()) ) &#123; EU.te(\"è·¯ç”±è§„åˆ™ä¸ºç©º\"); &#125; log.info(String.format(\"å‡†å¤‡å‘é€ã€%sã€‘\", mto.getInfo())); mto.setId(retry.generateId()); if( SU.isNull(mto.getExchange()) &amp;&amp; mto.getExpire()&lt;1 ) &#123; //é»˜è®¤çš„æ²¡æœ‰äº¤æ¢å™¨ï¼Œåˆ™ç›´æ¥å‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ— rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), new CorrelationData(mto.getId())); &#125; else if (mto.getExpire()&lt;1)&#123; //ç»è¿‡äº¤æ¢å™¨ï¼ŒæŒ‰è·¯ç”±è§„åˆ™åŒ¹é…é˜Ÿåˆ— rabbitTemplate.convertAndSend(mto.getExchange(), mto.getRoutingKey(), mto.getObj(), new CorrelationData(mto.getId())); &#125; else &#123; //é»˜è®¤çš„æ²¡æœ‰äº¤æ¢å™¨ï¼Œåˆ™ç›´æ¥å‘é€åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯ rabbitTemplate.convertAndSend(mto.getRoutingKey(), mto.getObj(), message -&gt; &#123; message.getMessageProperties().setExpiration(mto.getExpire()+\"\"); return message; &#125;, new CorrelationData(mto.getId())); &#125; mto.setCtime(System.currentTimeMillis()); retry.add(mto, this); &#125;&#125; 4ã€RabbitListeneræ¥æ”¶åˆ°æ¶ˆæ¯åŒæ­¥æ•°æ®123456789101112131415161718192021222324252627282930313233343536373839/** * æœç´¢æœåŠ¡æ¥æ”¶åˆ°ç®¡ç†åå°ç”¨æˆ·ä¿®æ”¹æ–‡ç« åŒæ­¥æ¶ˆæ¯ */@Component@Slf4j//é…ç½®mqæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥æ”¶æ–‡ä»¶åŒæ­¥æ¶ˆæ¯@RabbitListener(queues = DirectMQConfig.DIRECT_ARTICLES_ELASTIC_QUEUE)public class ArticlesReceiver extends DWMQBaseReceiver&lt;String&gt; &#123; @Autowired private ArticleETOService etoService; @Override public Class getClazz() &#123; return String.class; &#125; @Override public boolean processMessage(String mto) &#123; log.info(\"Received ç®¡ç†åå°ç”¨æˆ·-ä¿®æ”¹æ–‡ç« åŒæ­¥æ¶ˆæ¯æ¥æ”¶:&#123;&#125;\", mto); JSONObject jsonObject = JSON.parseObject(mto); String action = jsonObject.getString(Groups.ACTION); //åˆ é™¤æ“ä½œè¦åˆ é™¤ç´¢å¼•ï¼Œæ›´æ–°æ“ä½œå…ˆåˆ é™¤å ArticleETO articles = JSON.parseObject(jsonObject.toJSONString(), ArticleETO.class); String articlesId = articles.getId(); switch (action) &#123; case Groups.ADD: etoService.save(articles); break; case Groups.UPDATE: etoService.delete(articlesId); etoService.save(articles); break; case Groups.DELETE: etoService.delete(articlesId); break; &#125; return true; &#125;&#125; 5ã€å…¬å…±æœç´¢æ–¹æ³•12345678910111213141516171819202122232425262728/** * é«˜äº®æ˜¾ç¤ºï¼Œè¿”å›åˆ†é¡µ * @auther: zhoudong * @date: 2018/12/18 10:29 */ @Override public IPage&lt;Map&lt;String, Object&gt;&gt; queryHitByPage(int pageNo, int pageSize, String keyword, String indexName, String... fieldNames) &#123; // æ„é€ æŸ¥è¯¢æ¡ä»¶,ä½¿ç”¨æ ‡å‡†åˆ†è¯å™¨. QueryBuilder matchQuery = createQueryBuilder(keyword, fieldNames); // è®¾ç½®é«˜äº®,ä½¿ç”¨é»˜è®¤çš„highlighteré«˜äº®å™¨ HighlightBuilder highlightBuilder = createHighlightBuilder(fieldNames); // è®¾ç½®æŸ¥è¯¢å­—æ®µ SearchResponse response = elasticsearchTemplate.getClient().prepareSearch(indexName) .setQuery(bool) .highlighter(highlightBuilder) .setFrom((pageNo - 1) * pageSize) .setSize(pageNo * pageSize) // è®¾ç½®ä¸€æ¬¡è¿”å›çš„æ–‡æ¡£æ•°é‡ï¼Œæœ€å¤§å€¼ï¼š10000 .get(); // è¿”å›æœç´¢ç»“æœ SearchHits hits = response.getHits(); Long totalCount = hits.getTotalHits(); IPage&lt;Map&lt;String, Object&gt;&gt; page = new Page&lt;&gt;(pageNo, pageSize, totalCount); page.setRecords(getHitList(hits)); return page; &#125; åé¦ˆä¸å»ºè®® ä»Šå¤©ç»ˆäºå‡ºäº†elasticsearchæ–‡ç« ï¼Œä»¥åæˆ‘ä¼šåœ¨å¯¹åº”ä¸“é¢˜çš„æ–‡ç« æ”¾å‡ºç›¸å…³çš„ç™¾åº¦äº‘èµ„æºï¼Œè¿™äº›éƒ½æ˜¯ç½‘ä¸Šæµä¼ æ¯”è¾ƒå¹¿çš„èµ„æºï¼Œæƒ³æ‰¾å¥½çš„å­¦ä¹ èµ„æºä¹Ÿå¯ä»¥ä¸æˆ‘åˆä¼™ä¹°ç»ç‰ˆè§†é¢‘ï¼Œæœ‰é’±ä¹°æ­£ç‰ˆå§ï¼ˆä½œè€…å¾ˆç©·ï¼Œæ‰¾å·¥ä½œä»æ¥æ²¡æœ‰é€ å‡åŒ…è£…ï¼Œåªèƒ½æ··æˆè¿™ä¸ªåµæ ·ğŸ˜­ï¼Œä¸–é“ç»´è‰°ï¼Œå¦‚æœä¸æ˜¯æ„Ÿè§‰åšç å†œè¿˜ç®—æœ‰ç‚¹å¤©èµ‹ï¼Œæ—©å°±è½¬è¡Œäº†ï¼‰ã€‚ ç™¾åº¦äº‘ :ä¸‹è½½è¡—/01.Elasticsearché¡¶å°–é«˜æ‰‹ç³»åˆ—è¯¾ç¨‹ï¼Œå¯†ç ï¼šiw7f é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"spring","slug":"spring","permalink":"https://caochikai.github.io/tags/spring/"},{"name":"elasticsearch","slug":"elasticsearch","permalink":"https://caochikai.github.io/tags/elasticsearch/"}]},{"title":"Springbootæ•´åˆQuartzå®šæ—¶å™¨","date":"2019-05-20T12:25:37.000Z","path":"2019/05/20/Spring bootæ•´åˆQuartzå®šæ—¶å™¨/","text":"Spring bootæ•´åˆQuartzå®šæ—¶å™¨ä¸€ã€æ¦‚å¿µ quartzå®˜ç½‘æ˜¯ä¸€ä¸ªå®Œå…¨ç”± Java ç¼–å†™çš„å¼€æºä½œä¸šè°ƒåº¦æ¡†æ¶ï¼Œç»“åˆæ•°æ®åº“ç”šè‡³å¯ä»¥åšåˆ°åˆ†å¸ƒå¼è°ƒåº¦ã€‚ç›®å‰å‚è€ƒçš„RuoYiåå°è„šæ‰‹æ¶çš„å®šæ—¶ä»»åŠ¡æ¨¡å—ï¼Œæ”¯æŒåœ¨çº¿ï¼ˆæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤)ä»»åŠ¡è°ƒåº¦ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¥å¿—ä½œä¸šç»“æœã€‚ 3wåŸåˆ™ï¼š question whatï¼šå®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚å®šæ—¶ç­”é¢˜ã€å•†å®¶ç»“ç®—ç­‰éœ€æ±‚ï¼Œå¹¶ä¸”æ”¯æŒç«‹å³è¿è¡Œã€æš‚åœå’Œç¦æ­¢ã€‚ question whyï¼šå€ŸåŠ©quartz springbootç”Ÿæ€å’Œåå°è„šæ‰‹æ¶ï¼Œå¿«é€Ÿå®ç°å®šæ—¶è°ƒåº¦åŠŸèƒ½ã€‚ howï¼šå®ç°JobDetailè¿è¡Œä»»åŠ¡è¯¦æƒ…ï¼ŒTrigger è§¦å‘å™¨å®šä¹‰è§¦å‘è§„åˆ™ï¼ŒScheduler è°ƒåº¦ä¸­å¿ƒ/å®¹å™¨æ³¨å†Œå¤šä¸ª JobDetail å’Œ Triggerã€‚Trigger ä¸ JobDetail ç»„åˆå³å¯è¢«Schedulerè°ƒç”¨ã€‚ äºŒã€è½åœ°å®ç° æ ¹æ®è‹¥ä¾è„šæ‰‹æ¶çš„æ–‡æ¡£å¯çŸ¥ï¼Œå®šæ—¶ä»»åŠ¡å·¥ç¨‹æ¨¡å—ä¸ºruoyi-quartzï¼Œç»“åˆsql/quartz.sqlå¯¼å…¥å…³äºå®šæ—¶å™¨æ•°æ®åº“è¡¨ã€‚å½“ç„¶è¿™ç§åšæ³•éœ€è¦æ•°æ®åº“å’Œbootstrapï¼Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘é‡‡å–çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ä¿ç•™å®šæ—¶å’Œç«‹å³æ‰§è¡ŒåŠŸèƒ½ï¼ŒæŠ›å¼ƒæ‰‹åŠ¨åœ¨ä»£ç ç¡¬ç¼–ç æ–°åŠ å®šæ—¶å™¨ï¼Œwebç®¡ç†é¢æ¿åˆ™é€šè¿‡swaggerè§¦å‘ä»»åŠ¡è°ƒåº¦ç«‹å³æ‰§è¡Œä¸€æ¬¡ã€‚æç«¯å·æ‡’æ–¹å¼ï¼Œ@Scheduled(cron = â€œâ€)æ”¾åœ¨åœ¨cotrolleræ–¹æ³•ï¼ŒåŒäº‹æ¨èç»™æˆ‘çš„ğŸ˜€ã€‚ 1ã€æ·»åŠ ä¾èµ–1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;&lt;/dependency&gt; 2ã€é…ç½®å¼•å¯¼ç±»1234567//æ¨¡å—åŠ è½½@EnableScheduling@EnableSwagger2@SpringBootApplicationpublic class WeixinApplication &#123;......&#125; 3ã€æ³¨å†ŒJobDetailå’ŒTrigger1234567891011121314151617181920212223/** * åœ¨çº¿è¡¨è¾¾å¼ï¼šhttp://cron.qqe2.com/ */@Slf4j@Configurationpublic class QuartzConfig &#123; public static final String TASK_CLASS_NAME = \"reportNowTask\"; @Bean public JobDetail reportNowTask() &#123; return JobBuilder.newJob(reportNowTask.class).withIdentity(TASK_CLASS_NAME).storeDurably().build(); &#125; @Bean public Trigger reportNowTaskTrigger(JobDetail reportNowTask) &#123; //cronScheduleç­‰äº@Scheduled(cron = \"\"),ä½†æ˜¯é€šè¿‡æ³¨è§£æ— æ³•é…ç½®jobkey return TriggerBuilder.newTrigger().forJob(reportNowTask) .withIdentity(\"reportNowTaskTrigger\") .withSchedule(CronScheduleBuilder.cronSchedule(\"9 0 19 * * ?\")) .build(); &#125;&#125; 4ã€ä»»åŠ¡è¯¦æƒ…ç»§æ‰¿QuartzJobBeanæˆ–è€…å®ç°Jobæ¥å£12345678@Slf4jpublic class reportNowTask extends QuartzJobBean &#123; @Override protected void executeInternal(JobExecutionContext context) throws JobExecutionException &#123; ......//ä»»åŠ¡å†…å®¹ &#125;&#125; 5ã€ç«‹å³æ‰§è¡Œ123456789101112131415161718@Slf4j@Api(tags = \"é—®é¢˜æ¨¡å—\")@RequestMapping(value = \"question\")@RestControllerpublic class QuestionController &#123; /** * ä»»åŠ¡è°ƒåº¦ç«‹å³æ‰§è¡Œä¸€æ¬¡ */ @PostMapping(\"/run\") @ResponseBody public ResponseEntity run() throws SchedulerException &#123; //apiç§˜è¯€å°±åœ¨è¿™é‡Œæ ¹æ®QuartzConfig jobKeyè§¦å‘ä½œä¸šè°ƒåº¦ scheduler.triggerJob(JobKey.jobKey(QuartzConfig.TASK_CLASS_NAME)); return ResponseEntity.ok(\"æ‰§è¡ŒæˆåŠŸï¼\"); &#125;&#125; åé¦ˆä¸å»ºè®® ä»Šå¤©ç²—ç•¥ç®€æ˜“ç‰ˆçš„å®šæ—¶ä»»åŠ¡,åŠŸèƒ½å¼ºå¤§çš„è¯·æŸ¥çœ‹è‹¥ä¾åå°è„šæ‰‹æ¶,githubå’Œç äº‘æœ‰å¾ˆå¤šç±»ä¼¼è„šæ‰‹æ¶,ä½†æ˜¯æˆ‘ä»¬æœ‰é€‰æ‹©æ€§copyå­¦ä¹ æ‰æ˜¯é‡ç‚¹ğŸ˜Šã€‚ é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"spring","slug":"spring","permalink":"https://caochikai.github.io/tags/spring/"},{"name":"quartz","slug":"quartz","permalink":"https://caochikai.github.io/tags/quartz/"}]},{"title":"springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹","date":"2019-05-19T13:50:35.000Z","path":"2019/05/19/springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹/","text":"springbootæºç åˆ†æä¹‹å¯åŠ¨è¿‡ç¨‹ä¸€ã€æ¦‚å¿µ è®¡åˆ’å†™ä¸€æ³¢springboot 2.xæºç åˆ†æï¼Œåªå†™å®ç”¨æ€§æ¯”è¾ƒé«˜çš„ç‰¹æ€§ï¼Œä»GitHubä¸Šçœ‹å‡ºæ›´æ–°é¢‘ç‡åœ¨ä¸€ä¸ªæœˆå·¦å³ï¼Œæ›´æ–°æå¿«éå¸¸æ´»è·ƒã€‚ ç‰ˆæœ¬å‘è¡Œ: ç‰ˆæœ¬ æ—¶é—´çº¿ è¯´æ˜ v0.5.0.M1 2013-08-06 ç¬¬ä¸€ä¸ªç‰ˆæœ¬ v2.2.0.M3 2019-05-15 å½“å‰æœ€æ–°ç‰ˆæœ¬ äºŒã€æºç åˆ†æ SpringBootçš„å¯åŠ¨å¼•å¯¼ç±»å†™æ³•å¤šæ ·ï¼Œæ ‡è®°äº†@SpringBootApplicationçš„classä½œä¸ºæºç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253//ç®€æ˜“ç‰ˆ@SpringBootApplication public class MyApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(MyApplication.class, args); &#125; &#125;//é€šè¿‡ SpringApplicationBuilder API@SpringBootApplicationpublic class DiveInSpringBootApplication &#123; public static void main(String[] args) &#123; new SpringApplicationBuilder(DiveInSpringBootApplication.class) .bannerMode(Banner.Mode.CONSOLE) .web(WebApplicationType.NONE) .profiles(\"prod\") .headless(true) .run(args); &#125;&#125;//å£°æ˜newpublic class SpringApplicationBootstrap &#123; public static void main(String[] args) &#123;// SpringApplication.run(ApplicationConfiguration.class,args); Set sources = new HashSet(); // é…ç½®Class åç§° sources.add(ApplicationConfiguration.class.getName()); SpringApplication springApplication = new SpringApplication(); //é…ç½®æº springApplication.setSources(sources); //é…ç½®æ§åˆ¶å°banner springApplication.setBannerMode(Banner.Mode.CONSOLE); //å£°æ˜webç±»å‹ springApplication.setWebApplicationType(WebApplicationType.NONE); //å¤šç¯å¢ƒé…ç½®æ¿€æ´» springApplication.setAdditionalProfiles(\"prod\"); //java.awt.headlessç¦ç”¨æ¨¡å¼ springApplication.setHeadless(true); springApplication.run(args); &#125; @SpringBootApplication public static class ApplicationConfiguration &#123; &#125;&#125; ä»ä»£ç ä¸Šå¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨äº†SpringApplicationçš„é™æ€æ–¹æ³•runã€‚è¿™ä¸ªrunæ–¹æ³•ä¼šæ„é€ ä¸€ä¸ªSpringApplicationçš„å®ä¾‹ï¼Œç„¶åå†è°ƒç”¨è¿™é‡Œå®ä¾‹çš„runæ–¹æ³•å°±è¡¨ç¤ºå¯åŠ¨SpringBootã€‚å› æ­¤ï¼Œæƒ³è¦åˆ†æSpringBootçš„å¯åŠ¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰SpringApplicationçš„æ„é€ è¿‡ç¨‹ä»¥åŠSpringApplicationçš„runæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å³å¯ã€‚ SpringApplicationçš„å‡†å¤‡è¿‡ç¨‹ é…ç½® Spring Boot Bean æºï¼šJava é…ç½® Class æˆ– XML ä¸Šä¸‹æ–‡é…ç½®æ–‡ä»¶é›†åˆï¼Œç”¨äº Spring Boot BeanDefinitionLoader è¯»å– ï¼Œå¹¶ä¸”å°†é…ç½®æºè§£æåŠ è½½ä¸ºSpring Bean å®šä¹‰ã€‚ æ¨æ–­ Web åº”ç”¨ç±»å‹ï¼šæ ¹æ®å½“å‰åº”ç”¨ ClassPath ä¸­æ˜¯å¦å­˜åœ¨ç›¸å…³å®ç°ç±»æ¥æ¨æ–­ Web åº”ç”¨çš„ç±»å‹ã€‚å‚è€ƒæ–¹æ³•ï¼šorg.springframework.boot.SpringApplication#deduceWebApplicationTypeã€‚ 123456789101112private WebApplicationType deduceWebApplicationType() &#123; if (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, null) &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, null)) &#123; return WebApplicationType.REACTIVE; &#125; for (String className : WEB_ENVIRONMENT_CLASSES) &#123; if (!ClassUtils.isPresent(className, null)) &#123; return WebApplicationType.NONE; &#125; &#125; return WebApplicationType.SERVLET;&#125; æ¨æ–­å¼•å¯¼ç±»ï¼ˆMain Classï¼‰ï¼šæ ¹æ® Main çº¿ç¨‹æ‰§è¡Œå †æ ˆåˆ¤æ–­å®é™…çš„å¼•å¯¼ç±»ã€‚å‚è€ƒæ–¹æ³•ï¼š org.springframework.boot.SpringApplication#deduceMainApplicationClass 123456789101112131415private Class deduceMainApplicationClass() &#123; try &#123;//è·å–å †æ ˆè¾“å‡ºæ–¹æ³•åç§° StackTraceElement[] stackTrace = new RuntimeException().getStackTrace(); for (StackTraceElement stackTraceElement : stackTrace) &#123; if (\"main\".equals(stackTraceElement.getMethodName())) &#123; return Class.forName(stackTraceElement.getClassName()); &#125; &#125; &#125; catch (ClassNotFoundException ex) &#123; // Swallow and continue &#125; return null; &#125; åŠ è½½åº”ç”¨ä¸Šä¸‹æ–‡åˆå§‹å™¨ ï¼ˆ ApplicationContextInitializer ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œå®ä¾‹åŒ– ApplicationContextInitializer å®ç°ç±»ï¼Œå¹¶æ’åºå¯¹è±¡é›†åˆã€‚ 1234567891011121314//å®ç°ç±»ï¼š org.springframework.core.io.support.SpringFactoriesLoader//é…ç½®èµ„æºï¼š META-INF/spring.factories//æ’åºï¼š AnnotationAwareOrderComparator#sortprivate Collection getSpringFactoriesInstances(Class type, Class[] parameterTypes, Object... args) &#123; ClassLoader classLoader = Thread.currentThread().getContextClassLoader(); // Use names and ensure unique to protect against duplicates Set names = new LinkedHashSet&lt;&gt;( SpringFactoriesLoader.loadFactoryNames(type, classLoader)); List instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names); AnnotationAwareOrderComparator.sort(instances); return instances; &#125;Â· åŠ è½½åº”ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆ ApplicationListener ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œå®ä¾‹åŒ– ApplicationListener å®ç°ç±»ï¼Œå¹¶æ’åºå¯¹è±¡é›†åˆã€‚ SpringApplication è¿è¡Œé˜¶æ®µ åŠ è½½ SpringApplication è¿è¡Œç›‘å¬å™¨ï¼ˆ SpringApplicationRunListeners ï¼‰ï¼šåˆ©ç”¨ Spring å·¥å‚åŠ è½½æœºåˆ¶ï¼Œè¯»å– SpringApplicationRunListener å¯¹è±¡é›†åˆï¼Œå¹¶ä¸”å°è£…åˆ°ç»„åˆç±»SpringApplicationRunListenersã€‚ è¿è¡Œ SpringApplication è¿è¡Œç›‘å¬å™¨ï¼ˆ SpringApplicationRunListeners ï¼‰ï¼š started(runæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ç«‹é©¬æ‰§è¡Œï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationStartedEvent) environmentPrepared(ApplicationContextåˆ›å»ºä¹‹å‰å¹¶ä¸”ç¯å¢ƒä¿¡æ¯å‡†å¤‡å¥½çš„æ—¶å€™è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationEnvironmentPreparedEvent) contextPrepared(ApplicationContextåˆ›å»ºå¥½å¹¶ä¸”åœ¨sourceåŠ è½½ä¹‹å‰è°ƒç”¨ä¸€æ¬¡ï¼›æ²¡æœ‰å…·ä½“çš„å¯¹åº”äº‹ä»¶) contextLoaded(ApplicationContextåˆ›å»ºå¹¶åŠ è½½ä¹‹åå¹¶åœ¨refreshä¹‹å‰è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationPreparedEvent) finished(runæ–¹æ³•ç»“æŸä¹‹å‰è°ƒç”¨ï¼›å¯¹åº”äº‹ä»¶çš„ç±»å‹æ˜¯ApplicationReadyEventæˆ–ApplicationFailedEvent) åˆ›å»º Spring åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆ ConfigurableApplicationContext ï¼‰:æ ¹æ®å‡†å¤‡é˜¶æ®µçš„æ¨æ–­ Web åº”ç”¨ç±»å‹åˆ›å»ºå¯¹åº”ConfigurableApplicationContext å®ä¾‹ï¼š Web Reactiveï¼š AnnotationConfigReactiveWebServerApplicationContext Web Servletï¼š AnnotationConfigServletWebServerApplicationContext é Webï¼š AnnotationConfigApplicationContext åˆ›å»º Environmentï¼šæ ¹æ®å‡†å¤‡é˜¶æ®µçš„æ¨æ–­ Web åº”ç”¨ç±»å‹åˆ›å»ºå¯¹åº”çš„ ConfigurableEnvironment å®ä¾‹ã€‚ Web Reactiveï¼š StandardEnvironment Web Servletï¼š StandardServletEnvironment é Webï¼š StandardEnvironment runæ–¹æ³•åˆ†æ1234567891011121314151617181920212223242526272829303132public ConfigurableApplicationContext run(String... args) &#123; StopWatch stopWatch = new StopWatch(); // æ„é€ ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œè§‚å¯Ÿå™¨ stopWatch.start(); // å¼€å§‹æ‰§è¡Œï¼Œè®°å½•å¼€å§‹æ—¶é—´ ConfigurableApplicationContext context = null; configureHeadlessProperty(); // è·å–SpringApplicationRunListenersï¼Œå†…éƒ¨åªæœ‰ä¸€ä¸ªEventPublishingRunListener SpringApplicationRunListeners listeners = getRunListeners(args); // ä¸Šé¢åˆ†æè¿‡ï¼Œä¼šå°è£…æˆSpringApplicationEventäº‹ä»¶ç„¶åå¹¿æ’­å‡ºå»ç»™SpringApplicationä¸­çš„listenersæ‰€ç›‘å¬ // è¿™é‡Œæ¥å—ApplicationStartedEventäº‹ä»¶çš„listenerä¼šæ‰§è¡Œç›¸åº”çš„æ“ä½œ listeners.started(); try &#123; // æ„é€ ä¸€ä¸ªåº”ç”¨ç¨‹åºå‚æ•°æŒæœ‰ç±» ApplicationArguments applicationArguments = new DefaultApplicationArguments( args); // åˆ›å»ºSpringå®¹å™¨ context = createAndRefreshContext(listeners, applicationArguments); // å®¹å™¨åˆ›å»ºå®Œæˆä¹‹åæ‰§è¡Œé¢å¤–ä¸€äº›æ“ä½œ afterRefresh(context, applicationArguments); // å¹¿æ’­å‡ºApplicationReadyEventäº‹ä»¶ç»™ç›¸åº”çš„ç›‘å¬å™¨æ‰§è¡Œ listeners.finished(context, null); stopWatch.stop(); // æ‰§è¡Œç»“æŸï¼Œè®°å½•æ‰§è¡Œæ—¶é—´ if (this.logStartupInfo) &#123; new StartupInfoLogger(this.mainApplicationClass) .logStarted(getApplicationLog(), stopWatch); &#125; return context; // è¿”å›Springå®¹å™¨ &#125; catch (Throwable ex) &#123; handleRunFailure(context, listeners, ex); // è¿™ä¸ªè¿‡ç¨‹æŠ¥é”™çš„è¯ä¼šæ‰§è¡Œä¸€äº›å¼‚å¸¸æ“ä½œã€ç„¶åå¹¿æ’­å‡ºApplicationFailedEventäº‹ä»¶ç»™ç›¸åº”çš„ç›‘å¬å™¨æ‰§è¡Œ throw new IllegalStateException(ex); &#125;&#125; åé¦ˆä¸å»ºè®® ä¸ºäº†å¿«å¤§å¤šåˆ†æçš„ä¸å¥½å†™çš„å¾ˆä¹±ï¼Œå‡‘åˆçœ‹ä¸‹æˆ‘ä»¥åæ”¹ä¸‹æ’ç‰ˆğŸ˜‚ã€‚ é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"spring","slug":"spring","permalink":"https://caochikai.github.io/tags/spring/"},{"name":"quartz","slug":"quartz","permalink":"https://caochikai.github.io/tags/quartz/"}]},{"title":"åœ°ç†å®šä½ä¸šåŠ¡å®ç°","date":"2019-05-18T12:19:01.000Z","path":"2019/05/18/åœ°ç†å®šä½ä¸šåŠ¡å®ç°/","text":"åœ°ç†å®šä½ä¸šåŠ¡å®ç°ä¸€ã€æ¦‚å¿µ3wåŸåˆ™ï¼š question whatï¼šaã€é™„è¿‘ä¸€å®šèŒƒå›´çš„ç›®æ ‡ï¼ˆç”µå­å›´æ ï¼‰ï¼›bã€è¯¥ç»çº¬åº¦çš„åœ°ç†ä½ç½®åç§°ï¼ˆçœå¸‚å¿è¡—é“ï¼‰ã€‚ whyï¼šè§£å†³ä¸Šè¿°é—®é¢˜çš„æœ¬è´¨æ˜¯è·å¾—ç»çº¬åº¦ï¼Œé€”å¾„ä¸ºç¡¬ä»¶ã€GPSå®šä½æœåŠ¡ã€åŸºç«™å®šä½ï¼Œåœ°ç†ä½ç½®é€šè¿‡ç™¾åº¦ã€è°·æ­Œã€è…¾è®¯åœ°å›¾ï¼ŒåŸºæœ¬æ‰€æœ‰åœ°å›¾å…è´¹ç‰ˆéƒ½æœ‰æ—¥è®¿é—®é‡é™åˆ¶ã€‚ howï¼šé€šè¿‡å®‰å“æˆ–è€…IOSè·å–ç»çº¬åº¦ï¼Œå†å€ŸåŠ©ç™¾åº¦åœ°å›¾æ¥å£è·å–åœ°ç†ä½ç½®ï¼Œè·ç¦»ä¹Ÿå¯é€šè¿‡æ¥å£æˆ–è€…è°·æ­Œåœ°å›¾ç®—æ³•ã€‚ GPSæ˜¯è‹±æ–‡Global Positioning Systemï¼ˆå…¨çƒå®šä½ç³»ç»Ÿï¼‰çš„ç®€ç§°ã€‚ äºŒã€è§£å†³æ–¹å¼ åœºæ™¯ï¼šå°ç¨‹åºè·å–é™„è¿‘çš„å¥½å‹ï¼Œå¾®ä¿¡å®˜æ–¹æ–‡æ¡£ wx.getLocation(Object object)ã€‚ ç°è±¡ï¼šéœ€è¦ç”¨æˆ·æˆæƒï¼Œå‰ç«¯è·å¾—gps åæ ‡é€šè¿‡æ¥å£ä¼ æ•°æ®åå°ï¼Œä¿å­˜åˆ°ç”¨æˆ·è¡¨ï¼ˆ1ï¼š1å…³ç³»ï¼‰ã€‚ åœ°å›¾é€‰æ‹©ï¼šå…¶å®çº¯å‰ç«¯åŸºæœ¬ä¹Ÿèƒ½è§£å†³åŸºæœ¬é—®é¢˜ï¼Œè…¾è®¯åœ°å›¾å¯¹å°ç¨‹åºæ”¯æŒæœ€å¥½ï¼Œæ ¹æ®JavaScript SDKæ–‡æ¡£å¯ä»¥æ‹¥æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼šç»˜åˆ¶åœ°å›¾ï¼Œåœ°ç‚¹æœç´¢ï¼Œå…³é”®è¯è¾“å…¥æç¤ºï¼Œé€†åœ°å€è§£æï¼ˆåæ ‡ä½ç½®æè¿°ï¼‰ï¼Œåœ°å€è§£æï¼ˆåœ°å€è½¬åæ ‡ï¼Œè·¯çº¿è§„åˆ’ï¼Œè·ç¦»è®¡ç®—ï¼Œè·å–åŸå¸‚åˆ—è¡¨ï¼Œè·å–åŸå¸‚åŒºå¿ã€‚ ä¸šåŠ¡å‰æï¼šç”¨æˆ·å¿…é¡»æˆæƒæ‰èƒ½ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œå½“æ‹¥æœ‰æ‰€æœ‰ç”¨æˆ·ç»çº¬åº¦ï¼Œé€šè¿‡æ•°æ®åº“è¯­å¥è·å–å½“å‰ç”¨æˆ·ç»çº¬åº¦åœ¨ä¸€å®šè·ç¦»ï¼Œå¹¶ä¸”å¯ä»¥æ’è¡Œã€‚ ä¸‰ã€è½åœ°ç¼–ç sqlç‰ˆä¾‹å­ï¼š123456789101112131415161718192021222324252627#mysqlç‰ˆï¼Œæ ¹æ®è°·æ­Œåœ°å›¾å…¬å¼è®¡ç®—ç‚¹æ­Œç»çº¬åº¦ä¹‹é—´è·ç¦»ï¼Œå•ä½ä¸ºmï¼ˆç±³ï¼‰select e.id, e.longitude, e.latitude, ROUND( 6378.138 * 2 * ASIN( SQRT( POW( SIN( ( e.latitude * PI() / 180 - 23.12463 * PI() / 180 ) / 2 ), 2 ) + COS(e.latitude * PI() / 180) * COS(23.12463 * PI() / 180) * POW( SIN( ( e.longitude * PI() / 180 - 113.36189 * PI() / 180 ) / 2 ), 2 ) ) ) * 1000 ) AS distanceFROM dw_dbei_user ehaving distance &lt; 4000 å·¥å…·ç±»ï¼ˆè·å–ä¸¤ç‚¹è·ç¦»ï¼‰ï¼š12345678910111213141516171819202122232425262728293031323334public class MapUtils &#123; //private static double EARTH_RADIUS = 6378.137; private static double EARTH_RADIUS = 6371.393; private static double rad(double d) &#123; return d * Math.PI / 180.0; &#125; /** * è®¡ç®—ä¸¤ä¸ªç»çº¬åº¦ä¹‹é—´çš„è·ç¦» * * @param lat1 çº¬åº¦1 * @param lng1 ç»åº¦1 * @param lat2 çº¬åº¦2 * @param lng2 ç»åº¦2 * @return è®¡ç®—ç»“æœå•ä½ï¼šç±³ */ public static double GetDistance(double lat1, double lng1, double lat2, double lng2) &#123; double radLat1 = rad(lat1); double radLat2 = rad(lat2); double a = radLat1 - radLat2; double b = rad(lng1) - rad(lng2); double s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2))); s = s * EARTH_RADIUS; s = Math.round(s * 1000); return s; &#125; public static void main(String[] args) &#123; double v = GetDistance(113.36199, 23.12463, 113.36189, 23.12463); System.out.println(v); &#125;&#125; åé¦ˆä¸å»ºè®® å°½é‡æ¯å¤©ä¸æ–­æ›´ï¼Œåšä¸ªè‡ªå¾‹è€…ï¼ŒmarkdownåŸæ–‡ä»¶åœ¨githubé‡Œé¢ï¼Œæ„Ÿè°¢å„ä½å¤§ä½¬çœ‹å®˜starï¼Œé¢è¯•æˆ‘è¦å¾€è„¸ä¸Šè´´é‡‘å“ˆå“ˆå“ˆğŸ˜‚ã€‚ é‚®ç®±ï¼šcaochikai@qq.com","tags":[{"name":"sql","slug":"sql","permalink":"https://caochikai.github.io/tags/sql/"},{"name":"im","slug":"im","permalink":"https://caochikai.github.io/tags/im/"}]},{"title":"åˆæ¢ç¼“å­˜","date":"2019-05-17T15:34:21.000Z","path":"2019/05/17/åˆæ¢ç¼“å­˜/","text":"å¤šçº§ç¼“å­˜æ¶æ„ç¼“å­˜è®¾è®¡ç†å¿µï¼š ç¼“å­˜å¸¸ç”¨çš„å¯¹è±¡æˆ–è€…æ•°æ®ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€æé«˜æ•ˆç‡ã€‚ ç¼“å­˜å‘½ä¸­ç‡ å³ä»ç¼“å­˜ä¸­è¯»å–æ•°æ®çš„æ¬¡æ•° ä¸ æ€»è¯»å–æ¬¡æ•°çš„æ¯”ç‡ï¼Œå‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ï¼š ç¼“å­˜ç­–ç•¥ï¼š ç§»é™¤ç­–ç•¥ï¼šFIFOï¼ˆFirst In First Outï¼‰ï¼ŒLRUï¼ˆLeast Recently Usedï¼‰ï¼ŒLFUï¼ˆLeast Frequently Usedï¼‰ã€‚ TTLï¼ˆTime To Liveï¼‰ï¼šç¼“å­˜å­˜æ´»æœŸ TTIï¼ˆTime To Idleï¼‰ï¼šç©ºé—²å­˜æ´»æœŸ spring cache ä¸€ã€æ¦‚å¿µ è‡ªSpring 3.1èµ·ï¼Œæä¾›æ³¨è§£ç¼“å­˜ï¼Œå¹¶ä¸”æä¾›äº‹åŠ¡å›æ»šæ—¶ä¹Ÿè‡ªåŠ¨å›æ»šç¼“å­˜ï¼Œå¹¶ä¸”æ”¯æŒSPELè¡¨è¾¾å¼ã€‚ äºŒã€å…¥é—¨ä»£ç 1ã€æ·»åŠ ä¾èµ–ï¼Œä¾‹å¦‚mavençš„pom.xml(Springboot); 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt; &lt;artifactId&gt;spring-boot-starter-cache&lt;&#x2F;artifactId&gt;&lt;&#x2F;dependency&gt; 2ã€æ·»åŠ ä¸€ç§cacheManagerçš„beanå®ç°ç±»ï¼Œå¸¸è§ConcurrentMapCacheã€EhCacheCacheã€RedisCacheï¼› 123456@Beanpublic CacheManager cacheManager() &#123; SimpleCacheManager cacheManager &#x3D; new SimpleCacheManager(); cacheManager.setCaches(Collections.singletonList(new ConcurrentMapCache(&quot;models&quot;))); return cacheManager;&#125; 3ã€é…ç½®æ¨¡å—åŠ è½½æ³¨è§£@EnableCaching ä¸‰ã€ä¸»è¦æ³¨è§£1ã€@Cacheableï¼šå°†æ–¹æ³•è¿”å›å€¼ä½œä¸ºç¼“å­˜ value (ä¹Ÿå¯ä½¿ç”¨ cacheNames) : å¯çœ‹åšå‘½åç©ºé—´ï¼Œè¡¨ç¤ºå­˜åˆ°å“ªä¸ªç¼“å­˜é‡Œäº†ã€‚ key : è¡¨ç¤ºå‘½åç©ºé—´ä¸‹ç¼“å­˜å”¯ä¸€key,ä½¿ç”¨Spring Expression Language(ç®€ç§°SpEL,è¯¦è§å‚è€ƒæ–‡çŒ®[5])ç”Ÿæˆã€‚ condition : è¡¨ç¤ºåœ¨å“ªç§æƒ…å†µä¸‹æ‰ç¼“å­˜ç»“æœ(å¯¹åº”çš„è¿˜æœ‰unless,å“ªç§æƒ…å†µä¸ç¼“å­˜),åŒæ ·ä½¿ç”¨SpEL 2ã€@CacheEvictï¼šåˆ é™¤ç¼“å­˜æ³¨è§£ 3ã€@CachePutï¼šåˆ·æ–°æ³¨è§£ ehcache ä¸€ã€æ¦‚å¿µäºŒã€å…¥é—¨ä»£ç 1ã€ç¼“å­˜åˆ†ç»„ï¼Œè¦å¯¹åˆ†ç»„è¿›è¡Œå…¨æ–°CacheConfiguration ï¼Œä¸ºäº†é«˜æ•ˆä½¿ç”¨é…ç½®è‡ªå®šä¹‰å±æ€§æå–å™¨ã€‚é»˜è®¤çš„å±æ€§å¤„ç†å™¨æ˜¯JavaBeanAttributeExtractorã€‚ 123456789101112131415161718192021222324252627282930@Bean public EhCacheGroupBeanPostProcessor addCache() &#123; System.out.println(&quot;.......æ·»åŠ ç¼“å­˜ç»„........&quot;); return new EhCacheGroupBeanPostProcessor(); &#125; &#x2F;&#x2F;åç½®å¤„ç†å™¨ public static class EhCacheGroupBeanPostProcessor implements BeanPostProcessor &#123; @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; &#x2F;&#x2F;æ ¹æ®å‰é¢åˆå§‹åŒ–å®Œæˆçš„beanNameè¿›ä¸€æ­¥æ“ä½œ if(beanName.equals(&quot;appEhCacheCacheManager&quot;) ) &#123; EhCacheCacheManager manager &#x3D; (EhCacheCacheManager)bean; CacheManager cacheManager &#x3D; manager.getCacheManager();&#x2F;&#x2F; æ–‡ç« ç¼“å­˜å‘½ä¸­é…ç½®needUpdate CacheConfiguration configuration &#x3D; new CacheConfiguration(ReadCacheNames.æ–‡ç« ç¼“å­˜,10000); Searchable searchable &#x3D; new Searchable(); searchable.setKeys(false); searchable.setValues(false); &#x2F;&#x2F;åŠ¨æ€ç´¢å¼• searchable.setAllowDynamicIndexing(true); searchable.addSearchAttribute(new SearchAttribute().name(&quot;needUpdate&quot;).className(&quot;com.dwalk.social.common.util.ArticlesAttributeExtractor&quot;)); configuration.eternal(true).addSearchable(searchable); Cache articlesCache &#x3D; new Cache(configuration); cacheManager.addCache(articlesCache); cacheManager.addCache(ReadCacheNames.çƒ­ç‚¹æ–‡ç« ç¼“å­˜); &#125; return bean; &#125; &#125; 2ã€ä½¿ç”¨springå†…ç½®å®šæ—¶å™¨ï¼Œå¹¶ä½¿ç”¨ehcacheæŸ¥è¯¢apiè¿›è¡Œç¼“å­˜æŸ¥è¯¢ã€‚ 123456789101112131415161718192021222324 @Scheduled(cron &#x3D; &quot;0 0&#x2F;1 * * * ?&quot;) private void synchronize() &#123; Cache cache &#x3D; cacheManager.getCache(ReadCacheNames.æ–‡ç« ç¼“å­˜); int size &#x3D; cache.getSize(); if (size &gt; 0) &#123; Query query &#x3D; cache.createQuery(); Attribute searchAttribute &#x3D; cache.getSearchAttribute(&quot;needUpdate&quot;); &#x2F;&#x2F;æŒ‡å®šæŸ¥è¯¢çš„ query.includeAttribute(searchAttribute); query.includeValues(); Results execute &#x3D; query.addCriteria(searchAttribute.eq(true)).execute(); List all &#x3D; execute.all(); log.info(&quot;æŸ¥è¯¢æ–‡ç« ç¼“å­˜çš„å¤§å°ï¼š&#123;&#125;&quot;, all.size()); for (Result result : all) &#123; ArticlesDTO articles &#x3D; (ArticlesDTO) result.getValue(); articles.setNeedUpdate(false); Articles target &#x3D; new Articles();&#x2F;&#x2F; åŒæ­¥æµè§ˆé‡ã€è§†é¢‘æ’­æ”¾é‡ã€è¯„è®ºæ•°ã€ç‚¹èµæ•°ã€æ”¶è—æ•° target.setVisitorNum(articles.getVisitorNum()).setCommentNum(articles.getCommentNum()). setPlayNum(articles.getPlayNum()).setLikeNum(articles.getLikeNum()).setCollectNum(articles.getCollectNum()); articlesService.updateById(target); &#125; &#125; &#125; ä¸‰ã€æ€»ç»“1ã€éœ€è¦ç†Ÿæ‚‰springæ¥å£è®¾è®¡ï¼Œä»¥æ¥å£ä½¿ç”¨æ¡†æ¶ï¼Œè¦ä¸ç„¶å®˜æ–¹apiä½¿ç”¨éœ€äº†è§£è¯¸å¤šç»†èŠ‚ã€‚ å››ã€ä¸€äºŒçº§ç¼“å­˜ å½“é‡åˆ°@Cacheableè¿”å›ä¸ºnullè®°å½•ï¼Œä¸ºäº†æˆåŠŸåºåˆ—åŒ–nullï¼Œä½¿ç”¨äº†org.springframework.cache.support.NullValueå¯¹è±¡ä»£æ›¿nullã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889com.alibaba.fastjson.JSONException: autoType is not support. org.springframework.cache.support.NullValue1ã€èµ·æºä¸€äºŒçº§ç¼“å­˜é‡å†™get()æ–¹æ³•public class EhRedisCache extends AbstractValueAdaptingCache &#123; éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦ @Override public T get(Object key, Callable valueLoader) &#123; try &#123; lock.lock(); value &#x3D; lookup(key); if(value !&#x3D; null) &#123; return (T) value; &#125; value &#x3D; valueLoader.call(); &#x2F;&#x2F;toStoreValueæ˜¯AbstractValueAdaptingCacheæŠ½è±¡ç±»çš„æ–¹æ³• Object storeValue &#x3D; toStoreValue(value); put(key, storeValue); return (T) value; &#125; catch (Exception e) &#123; throw new ValueRetrievalException(key, valueLoader, e.getCause()); &#125; finally &#123; lock.unlock(); &#125; &#125;&#125;2ã€toStoreValueåˆ¤æ–­userValue &#x3D;&#x3D; null åˆ™return NullValue.INSTANCE -&gt; public static final Object INSTANCE &#x3D; new NullValue();public abstract class AbstractValueAdaptingCache implements Cache &#123; protected Object toStoreValue(@Nullable Object userValue) &#123; if (userValue &#x3D;&#x3D; null) &#123; if (this.allowNullValues) &#123; return NullValue.INSTANCE; &#125; throw new IllegalArgumentException( &quot;Cache &#39;&quot; + getName() + &quot;&#39; is configured to not allow null values but null was provided&quot;); &#125; return userValue; &#125;&#125;3ã€åºåˆ—åŒ–ååºåˆ—åŒ–public class FastJsonRedisSerializer implements RedisSerializer &#123; @Override public T deserialize(byte[] bytes) throws SerializationException &#123; if (null &#x3D;&#x3D; bytes || bytes.length &lt;&#x3D; 0) &#123; return null; &#125; String str &#x3D; new String(bytes, DEFAULT_CHARSET); return (T) JSON.parseObject(str, clazz); &#125;&#125;4ã€jsonParserè§£æç±»å‹public class com.alibaba.fastjson.parser.DefaultJSONParser implements Closeable &#123; public final Object parseObject(final Map object, Object fieldName) &#123; éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦ Class clazz &#x3D; null; if (object !&#x3D; null &amp;&amp; object.getClass().getName().equals(typeName)) &#123; clazz &#x3D; object.getClass(); &#125; else &#123; &#x2F;&#x2F;com.alibaba.fastjson.parser.DefaultJSONParser#configæ‰§è¡Œ clazz &#x3D; config.checkAutoType(typeName, null, lexer.getFeatures()); &#125; &#125;&#125;5ã€å¼‚å¸¸æŠ›å‡ºç‚¹TypeUtils.getClassFromMapping(typeName) -ã€‹ typeNameä¸ºorg.springframework.cache.support.NullValuepublic Class checkAutoType(String typeName, Class expectClass, int features) &#123; if (Arrays.binarySearch(denyHashCodes, hash) &gt;&#x3D; 0 &amp;&amp; TypeUtils.getClassFromMapping(typeName) &#x3D;&#x3D; null) &#123; throw new JSONException(&quot;autoType is not support. &quot; + typeName); &#125;&#125;6ã€TypeUtilsçš„getClassFromMappingæ–¹æ³•è¿”å›null public static Class getClassFromMapping(String className)&#123; return mappings.get(className); &#125;7ã€TypeUtilsä¸æ”¯æŒorg.springframework.cache.support.NullValueprivate static ConcurrentMap&gt; mappings &#x3D; new ConcurrentHashMap&gt;(16, 0.75f, 1);&#x2F;&#x2F;mappingsç±»å‹ç™½åå•private static void addBaseClassMappings()&#123; mappings.put(&quot;byte&quot;, byte.class); mappings.put(&quot;short&quot;, short.class); mappings.put(&quot;int&quot;, int.class); mappings.put(&quot;long&quot;, long.class); mappings.put(&quot;float&quot;, float.class); mappings.put(&quot;double&quot;, double.class); mappings.put(&quot;boolean&quot;, boolean.class); éƒ¨åˆ†ä»£ç çœç•¥â€¦â€¦ fastJsonå®˜æ–¹æ²¡æœ‰æ”¯æŒorg.springframework.cache.support.NullValue&#125; åé¦ˆä¸å»ºè®® ä»Šå¤©å¤å‡ºå†™åšå®¢ï¼Œä¸€æ˜¯æ„Ÿè§‰æ‡’äº†æœŸæœ›è¿›æ­¥ï¼ŒäºŒæ˜¯ä¸ºäº†ç§¯ç´¯çŸ¥è¯†æ–¹ä¾¿copyğŸ˜‚ã€‚ é‚®ç®±ï¼š&#x63;&#97;&#x6f;&#x63;&#x68;&#x69;&#107;&#x61;&#105;&#x40;&#x71;&#x71;&#x2e;&#99;&#111;&#x6d;","tags":[{"name":"spring","slug":"spring","permalink":"https://caochikai.github.io/tags/spring/"}]},{"title":"AndroidAdb","date":"2017-02-05T12:49:09.000Z","path":"2017/02/05/AndroidAdb/","text":"Android adbè°ƒè¯•å·¥å…·â€“æ¸…é™¤é”å±å¯†ç è¯¯è§£@(Android)[è°ƒè¯•å·¥å…·|å®ç”¨æ•™ç¨‹|adbå‘½ä»¤] Android Studio ADBå®˜æ–¹æ–‡æ¡£ ADBå…¨ç§°ä¸º Android Debug Bridge, æ˜¯android é‡Œçš„ä¸€ä¸ªè°ƒè¯•å·¥å…·, ç”¨è¿™ä¸ªå·¥å…·å¯ä»¥ç›´æ¥æ“ä½œç®¡ç†androidæ¨¡æ‹Ÿå™¨æˆ–è€…çœŸå®çš„andriodè®¾å¤‡æ‰‹æœºã€‚å¦‚æœä½ å®‰è£…äº†Android SDKï¼ˆæˆ–è€…ä¸‹è½½adbå·¥å…·åŒ…ï¼Œä½“ç§¯å°ï¼‰,å­˜æ”¾sdkçš„platform-toolsç›®å½•ä¸‹ï¼Œåœ¨ å‘½ä»¤è¡Œcmdä½¿ç”¨éœ€è¦é…ç½®è·¯å¾„ï¼ˆandroid_sdk/platform-tools/adb.exe ï¼‰åˆ°ç¯å¢ƒå˜é‡é‡Œã€‚å®ƒå¯ä¸ºå„ç§è®¾å¤‡æ“ä½œæä¾›ä¾¿åˆ©ï¼Œå¦‚å®‰è£…å’Œè°ƒè¯•åº”ç”¨ï¼Œä¾‹å¦‚æŸ¥çœ‹androidä¸­çš„æ•°æ®åº“ï¼Œæä¾›å¯¹ Unix shellï¼ˆå¯ç”¨æ¥åœ¨æ¨¡æ‹Ÿå™¨æˆ–è¿æ¥çš„è®¾å¤‡ä¸Šè¿è¡Œå„ç§å‘½ä»¤ï¼‰çš„è®¿é—®ã€‚è¯¥å·¥å…·ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨ç¨‹åºï¼ŒåŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š å®¢æˆ·ç«¯ ï¼šè¯¥ç»„ä»¶å‘é€å‘½ä»¤ã€‚å®¢æˆ·ç«¯åœ¨å¼€å‘è®¡ç®—æœºä¸Šè¿è¡Œã€‚æ‚¨å¯ä»¥é€šè¿‡å‘å‡º adb å‘½ä»¤ä»å‘½ä»¤è¡Œç»ˆç«¯è°ƒç”¨å®¢æˆ·ç«¯ï¼› åå°ç¨‹åº ï¼šè¯¥ç»„ä»¶åœ¨è®¾å¤‡ä¸Šè¿è¡Œå‘½ä»¤ã€‚åå°ç¨‹åºåœ¨æ¯ä¸ªæ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡å®ä¾‹ä¸Šä½œä¸ºåå°è¿›ç¨‹è¿è¡Œï¼› æœåŠ¡å™¨ ï¼šè¯¥ç»„ä»¶ç®¡ç†å®¢æˆ·ç«¯å’Œåå°ç¨‹åºä¹‹é—´çš„é€šä¿¡ã€‚æœåŠ¡å™¨åœ¨å¼€å‘è®¡ç®—æœºä¸Šä½œä¸ºåå°è¿›ç¨‹è¿è¡Œã€‚ å…³äºæ¸…é™¤è§£é”å›¾æ¡ˆ ç”¨æˆ·ç›¸å…³çš„æ–‡ä»¶accounts.dbï¼ˆgmailè´¦å·ç®¡ç†ï¼‰ï¼Œgesture.keyï¼ˆæ‰‹åŠ¿è¯†åˆ«æ–‡ä»¶ï¼‰ï¼Œpassword.keyï¼ˆå¯†ç æ–‡ä»¶ï¼‰ã€‚ä¸åŒå“ç‰Œæ‰‹æœºç³»ç»Ÿç›¸å…³æ–‡ä»¶åä¹Ÿä¼šä¸åŒ,ä¾‹å¦‚æˆ‘çš„æ‰‹æœºï¼Œåä¸º4xæ–‡ä»¶ä¸ºlocksettings.dbï¼ˆæ•°æ®åº“æ–‡ä»¶ï¼‰ã€‚ä¿®ç†åº—é‡Œçš„å¸ˆå‚…ä½¿ç”¨ä¸€ä¸ªå·¥å…·å«æ˜Ÿæµ·ç¥å™¨ï¼ˆé«˜é€šå¹³å°å¼ºåˆ·ï¼‰ï¼ŒåŠŸèƒ½è¶…ä¹æƒ³è±¡ï¼Œå‡ ä¹æ”¯æŒæ‰€æœ‰æ‰‹æœºå“ç‰Œï¼ˆç‰¹åˆ«æ˜¯è‹¹æœï¼‰æ·˜å®ä¸Šæœ‰å–ï¼Œç½‘ä¸Šå¤§éƒ¨åˆ†åŠ å¯†è¿‡ï¼å°ç±³æ‰‹æœºå«ä¸¢å¤±è§£é”ç¥å™¨ï¼ 1. ç ´è§£æ¡ä»¶ æ‰‹æœºæ‰“å¼€USBå¹¶è¿æ¥ç”µè„‘ æ‰‹æœºè¢«ROOTï¼Œå¹¶ä¸”ADBå¯ä»¥ç›´æ¥å‡çº§ä¸ºROOTç”¨æˆ· é…ç½®adbè·¯å¾„åˆ°ç¯å¢ƒå˜é‡æˆ–è€…ç›´æ¥åœ¨cmdå‘½ä»¤è¡Œé‡Œé¢åˆ‡æ¢åˆ°adbæ‰€åœ¨è·¯å¾„ 2. ç ´è§£æ­¥éª¤ *æ‰“å¼€cmdå‘½ä»¤è¡Œï¼Œç”¨ã€adb shellã€‘å‘½ä»¤è¿›å…¥shell * åˆ©ç”¨suå‘½ä»¤å°†adbæå‡ä¸ºrootç”¨æˆ·ï¼Œå¦‚æœæˆåŠŸï¼Œè¡Œé¦–ç”±$å˜æˆ #ï¼Œ#è¡¨ç¤ºrootç”¨æˆ· *è¿›å…¥data/systemç›®å½• * *lsæŸ¥çœ‹å½“å‰ç›®å½• * *ç”¨lså‘½ä»¤æŸ¥çœ‹å¯†ç æ–‡ä»¶ * ç”¨rmå‘½ä»¤åˆ é™¤å¯†ç æ–‡ä»¶ï¼Œè‹¥æ˜¯$ï¼ˆä¸æ˜¯rootï¼‰ï¼Œåˆ™ä¼šæç¤ºâ€rm failed for â€¦ Permission deniedâ€ï¼Œæƒé™ä¸è¶³ 12345$ adb shell $ su# cd /data/system# ls# rm locksettings.db è¾“å…¥rebootæˆ–æ‰‹åŠ¨é‡å¯æ‰‹æœºç”Ÿæ•ˆã€‚äº²æµ‹åä¸ºè£è€€4Xæœ‰æ•ˆï¼Œåˆ é™¤é”å±å¯†ç åï¼ŒæŒ‡çº¹è§£é”è‡ªåŠ¨å¤±æ•ˆï¼Œæ‰€ä»¥æ­¤æ–¹æ³•ä¹Ÿå¯ä»¥ç ´è§£æŒ‡çº¹è§£é”ï¼ï¼é‡æ–°è®¾ç½®é”å±å¯†ç åï¼Œä»¥å‰è®¾ç½®çš„æŒ‡çº¹è§£é”åˆå¯ä»¥ç”¨äº†ã€‚ 3. æ³¨æ„äº‹é¡¹çœ‹åˆ°è¿™å„¿å°±æ˜ç™½äº†ï¼Œå³ä¾¿æ‰‹æœºRoot+æ‰“å¼€USBè°ƒè¯•ï¼Œä¹Ÿæ˜¯æ— æ³•é€šè¿‡ADBè§£é”æ‰‹æœºçš„ã€‚å› ä¸ºæƒ³è¦æƒ³è¦è§£é”ï¼Œå°±å¾—åˆ é™¤/data/system ä¸‹çš„ç›¸å…³æ–‡ä»¶ï¼Œå¯åˆ é™¤éœ€è¦ç”±Superuseræˆ–è€…kingrootæˆäºˆADB shellæƒé™ï¼Œè€Œæˆæƒéœ€è¦è§£é”æ‰“å¼€æ‰‹æœºåæ“ä½œSuperuserç¨‹åºã€‚å³è§£é”éœ€è¦ç”¨åˆ°è§£é”åçš„æ‰‹æœºæ“ä½œï¼Œå°±åƒæ˜¥æ™šå°å“ã€Šå¼€é”ã€‹ä¸­ï¼Œä¸šä¸»é»„å®è¦æ±‚å¼€é”å¸ˆå‚…æ—æ°¸å¥å¼€é”ï¼Œæ—æ°¸å¥è¦æ±‚é»„å®å‡ºç¤ºæœ‰æ•ˆè¯ä»¶ï¼Œå¯è¯ä»¶å°±åœ¨é”ç€çš„ç®±å­é‡Œå¤´ã€‚ æˆ‘è¿›è¡Œäº†æµ‹è¯•åå‘ç°ï¼Œåœ¨æˆæƒè¿‡ä¸€æ¬¡åï¼Œä¸‹æ¬¡æ‰‹æœºç”¨USBæ•°æ®çº¿è¿æ¥ç”µè„‘ï¼Œå†æ¬¡è¿›è¡Œè§£é”ï¼Œå³ä¾¿åŒå°ç”µè„‘ï¼Œä¹Ÿæ˜¯éœ€è¦å†æ¬¡æˆæƒçš„ã€‚è¿™å°±è¯´æ˜ï¼Œå³ä¾¿ä½ ç”¨ä½ çš„ç”µè„‘ç»è¿‡æ‰‹æœºæˆæƒè§£é”è¿‡ï¼Œè¿‡åæƒ³è¦åœ¨å¿˜è®°å¯†ç æ—¶ä½¿ç”¨ADBæ–¹å¼è§£é”ï¼Œä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚ æˆ‘è§‰å¾—è¿™æ˜¯é«˜ç‰ˆæœ¬çš„å®‰å“ç³»ç»Ÿï¼ˆeg. Android 4.2 Jelly Bean å®‰å“æœå†»è±†ï¼‰æ–°æœ‰çš„å®‰å…¨ç‰¹æ€§ï¼Œä½ç‰ˆæœ¬çš„Androidå¦‚å®‰å“2.3.8æ˜¯å¯ä»¥é€šè¿‡è¿™ç§æ–¹æ³•è§£é”çš„ã€‚å› ä¸ºæˆ‘å®é™…æµ‹è¯•ï¼Œæˆ‘çš„å›ºä»¶ç‰ˆæœ¬ä¸ºå®‰å“2.3.8çš„ä¸‰æ˜ŸS5570ï¼ˆå·²ç»Rootï¼Œæ‰“å¼€USBè°ƒè¯•ï¼‰ï¼Œæ‰§è¡Œå‘½ä»¤rm gesture.keyï¼Œæ— éœ€æˆæƒï¼Œç›´æ¥å³å¯è§£é”ã€‚ç°åœ¨æˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œä½ç‰ˆæœ¬å®‰å“ç³»ç»Ÿå¦‚ Android2.3.8çš„æ‰‹æœºè§£é”å±å¹•é”å®šå¯†ç ï¼Œæ˜¯å¦çš„ç¡®å¿…é¡»Rootï¼Œè¿˜æ˜¯åªè¦æ‰“å¼€USBè°ƒè¯•å³å¯ï¼Ÿæˆ‘æ‰‹å¤´æ²¡æœ‰æ²¡Rootçš„Android2.3æ‰‹æœºï¼Œä¹Ÿæ‡’å¾—æŠ˜è…¾äº†ï¼Œå°±ä¸ç®¡å®ƒäº†ã€‚ è¿™æ ·çœ‹æ¥ï¼Œé«˜ç‰ˆæœ¬çš„å®‰å“ç³»ç»Ÿä¹Ÿå°±ä¸å­˜åœ¨è¢«éæ‰‹æœºæ‰€æœ‰è€…æ¶æ„è§£é”çš„BUGäº†ã€‚4. é¢˜å¤–è¯ï¼ˆä»Šå¹´å¥½ä¸œè¥¿éƒ½æŒ‚äº†ï¼‰æ”¶è´¹éŸ³ä¹ç¥å™¨å®˜ç½‘ï¼ŒæœåŠ¡å™¨æ¥å£å¹³å°AnyListen éŸ³ä¹é—´è°ä¸ºwindow PCç‰ˆï¼ŒéŸ³ä¹åŠ©æ‰‹Androidç‰ˆï¼ŒShelherå¾®åšåˆ†äº«å‡ºæ¥3.3ç‰ˆæºç ç™¾åº¦äº‘ â€‹â€‹â€‹â€‹å¯†ç griaï¼å°´å°¬çš„æ˜¯æœ‹å‹äº‘å…æµé‡ä¹Ÿä¸å¹²äº†ï¼","tags":[]},{"title":"SpiderWebMagic","date":"2017-01-30T12:50:27.000Z","path":"2017/01/30/SpiderWebMagic/","text":"WebMagicçˆ¬è™«æ¡†æ¶â€“äº¬ä¸œå›¾ä¹¦@(çˆ¬è™«)[æ¡†æ¶|çˆ¬è™«|Demoæ€»ç»“] WebMagic!é¡¹ç›®ä»£ç åˆ†ä¸ºæ ¸å¿ƒ(webmagic-core)å’Œæ‰©å±•(webmagic-extension)ä¸¤éƒ¨åˆ†(jaråŒ…)ã€‚Downloaderã€PageProcessorã€Schedulerã€Pipelineè¿™å››å¤§ç»„ä»¶å¯¹åº”çˆ¬è™«ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸‹è½½ã€å¤„ç†ã€ç®¡ç†å’ŒæŒä¹…åŒ–ç­‰åŠŸèƒ½ã€‚ åç§° åŠŸèƒ½ Downloader åŸºç¡€ã€‚åˆ©ç”¨httpClientä½œä¸ºä¸‹è½½å·¥å…·ï¼Œä¸‹è½½é¡µé¢å†…å®¹ä¾¿äºåç»­å¤„ç†è§£æ; Page ç½‘é¡µå†…å®¹å¯¹è±¡ã€‚ æŒ‡æ ¹æ®urlä¸‹è½½åˆ°çš„é¡µé¢å†…å®¹ï¼ŒåŒ…æ‹¬é¡µé¢domå…ƒç´ ï¼Œcssæ ·å¼ï¼Œjavascriptç­‰; Pageprocess çˆ¬è™«çš„æ ¸å¿ƒã€‚ è´Ÿè´£è§£æé¡µé¢ï¼ŒæŠ½å–æœ‰ç”¨ä¿¡æ¯ï¼Œå¯é‡‡ç”¨css(),$(),xpath()æ–¹æ³•å¯¹ç‰¹å®šé¡µé¢å…ƒç´ è¿›è¡ŒæŠ½å–; Site ç½‘ç«™è®¾ç½®ã€‚è®¾ç½®ç½‘ç«™domainï¼Œcookies,header,é‡è¯•æ¬¡æ•°,è®¿é—®é—´éš”æ—¶é—´ç­‰; Scheduler æŠ“å–é¡µé¢é˜Ÿåˆ—ã€‚ ç®¡ç†å¾…æŠ“å–çš„URLï¼Œä»¥åŠä¸€äº›å»é‡çš„å·¥ä½œï¼Œå°†ç›®æ ‡urlå†…å®¹pushåˆ°æŠ“å–é˜Ÿåˆ—ä¸­; Pipeline è¾“å‡ºï¼Œæ”¶å°¾ã€‚ è´Ÿè´£æŠ½å–ç»“æœçš„å¤„ç†ï¼ŒåŒ…æ‹¬è®¡ç®—ã€æŒä¹…åŒ–åˆ°æ–‡ä»¶ã€æ•°æ®åº“; Spider çˆ¬è™«çš„å…¥å£ç±» é‡‡ç”¨é“¾å¼è®¾è®¡ï¼Œé€šè¿‡å®ƒæ¥è®¾å®šå¤šçº¿ç¨‹ï¼Œé¡µé¢è§£æå™¨ï¼Œè°ƒåº¦ä»¥åŠè¾“å‡ºæ–¹å¼ç­‰ã€‚ WebMagicå®˜æ–¹é“¾æ¥ï¼š å®˜ç½‘ åŒ…å«å®˜æ–¹æ–‡æ¡£å’Œæºç ,ä»¥åŠç›¸åº”çš„å®ä¾‹ï¼› github ä»“åº“ä¿å­˜æœ€æ–°ç‰ˆæœ¬ï¼› oschinamayunç äº‘ åŒ…å«æ‰€æœ‰ç¼–è¯‘å¥½çš„ä¾èµ–åŒ…ï¼› çˆ¬å–äº¬ä¸œå›¾ä¹¦(https://book.jd.com/)åœ¨å•†å“åˆ—è¡¨ç½‘é¡µæŠ“å–å¦‚ä¸‹å•†å“ä¿¡æ¯ å•†å“åï¼šå•†å“åç§° å•†å“ç½‘é¡µï¼šæ˜¾ç¤ºå•†å“è¯¦ç»†ä¿¡æ¯çš„ç½‘é¡µåœ°å€ã€‚ å¸‚åœºä»·æ ¼ï¼šäº¬ä¸œç»™å‡ºçš„å¸‚é¢ä»·æ ¼ äº¬ä¸œä»·æ ¼ï¼šäº¬ä¸œçš„ä¼˜æƒ ä»·ã€‚ å…³äºajaxä»·æ ¼é“¾æ¥åœ°å€æ ¼å¼ï¼šhttp://p.3.cn/prices/mgets?skuIds=J_ + å•†å“IDï¼ŒæŠ“å–æ ¼å¼ä¸ºjsonã€‚ https://item.jd.com/12087016.html ï¼šå›¾ä¹¦è¯¦æƒ…é¡µï¼› http://p.3.cn/prices/mgets?skuIds=J_12087016 ï¼ˆä¾‹ï¼‰ä»·æ ¼ajaxè¯·æ±‚é“¾æ¥ï¼› [{â€œidâ€:â€J_12087016â€,â€pâ€:â€60.80â€,â€mâ€:â€90.00â€,â€opâ€:â€60.80â€}] æŠ“å–ç»“æœ id + äº¬ä¸œå®é™…ä»·æ ¼+å¸‚åœºä»·æ ¼ ä»£ç å—123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778import us.codecraft.webmagic.Page;import us.codecraft.webmagic.Site;import us.codecraft.webmagic.Spider;import us.codecraft.webmagic.processor.PageProcessor;import java.util.ArrayList;import java.util.List;public class JDPageProcesser implements PageProcessor &#123; private Site site = Site.me().setRetryTimes(3).setSleepTime(3000).setCharset(\"GBK\"); private static int size = 0;// å…±æŠ“å–åˆ°çš„å›¾ä¹¦æ•°é‡ //æŠ“å–å•†å“ä¿¡æ¯é›†åˆ private static List&lt;String&gt; name = new ArrayList&lt;String&gt;();//æ‰€æœ‰çš„ä¹¦å private static List&lt;String&gt; author = new ArrayList&lt;String&gt;();//æ‰€æœ‰çš„ä½œè€… private static List&lt;Double&gt; prices = new ArrayList&lt;Double&gt;();//æ‰€æœ‰çš„ä»·æ ¼ @Override public void process(Page page) &#123; //å›¾ä¹¦ä¸»é¡µ // https://item.jd.com/12004057.html if (!page.getUrl().regex(\"https://item.jd.com/\\\\d&#123;8&#125;.html\").match()&amp;!page.getUrl().regex(\"p.3.cn/prices/mgets\").match()) &#123; // ä¸»é¡µä¸­æ·»åŠ å•†å“è¯¦æƒ…é¡µåˆ°è®¡åˆ’url List&lt;String&gt; detail = page.getHtml().links().regex(\"//item.jd.com/\\\\d&#123;8&#125;.html\").replace(\"//\", \"https://\").all(); //æ§åˆ¶æŠ“å–å•†å“çš„æ•°é‡ if (detail.size()&gt;0) &#123; for (int i = 0; i &lt; 4; i++) &#123; String url = detail.get(i); System.out.println(\"url:\" + url.replace(\"https://item.jd.com\", \"\").replace(\"/\", \"http://p.3.cn/prices/mgets?skuIds=J_\").replace(\".html\", \"\")); //åˆ—é˜Ÿæ·»åŠ ä¸€æ¡è¯¦æƒ…é¡µåé¢è¿½åŠ ä¸€æ¡ä»·æ ¼ajaxé“¾æ¥ page.addTargetRequest(url); page.addTargetRequest(url.replace(\"https://item.jd.com\", \"\").replace(\"/\", \"http://p.3.cn/prices/mgets?skuIds=J_\").replace(\".html\", \"\")); &#125; &#125; &#125; if (page.getUrl().regex(\"https://item.jd.com/\\\\d&#123;8&#125;.html\").match()) &#123; // å•†å“è¯¦æƒ…é¡µ size++; name.add(page.getHtml().xpath(\"//div[@id=name]/h1/text()\").get());//æ·»åŠ ä¹¦å author.add(page.getHtml().xpath(\"//div[@id=p-author]/a/text()\").get());//æ·»åŠ ä½œè€… &#125; if (page.getUrl().regex(\"p.3.cn/prices/mgets\").match()) &#123; //ajaxå•†å“idå¯¹åº”ä»·æ ¼jsonæ¥å£ prices.add(Double.parseDouble(page.getHtml().replace(\"&amp;quot\", \"\").regex(\"p;:;.+;,;m\").regex(\"\\\\d+\\\\.\\\\d+\").get()));//æ·»åŠ ä»·æ ¼ &#125; &#125; @Override public Site getSite() &#123; return site; &#125; //è·å–æ‰€æœ‰ä¿¡æ¯å¯¼å…¥DAO,æŒä¹…åŒ–å±‚å¾…å®ç° private static void getAll() &#123; System.out.println(\"Size\" + name.size() + author.size() + prices.size()); for (int i = 0; i &lt; name.size(); i++) &#123; JDLog model = new JDLog(); model.setName(name.get(i)); model.setAuthor(author.get(i)); model.setPrices(prices.get(i)); System.out.println(\"ä¹¦å:\" + model.getName()); System.out.println(\"ä½œè€…:\" + model.getAuthor()); System.out.println(\"ä»·æ ¼:\" + model.getPrices()); &#125; &#125; public static void main(String[] args) &#123; long startTime, endTime; System.out.println(\"ã€çˆ¬è™«å¼€å§‹ã€‘è¯·è€å¿ƒç­‰å¾…ä¸€å¤§æ³¢æ•°æ®åˆ°ä½ ç¢—é‡Œæ¥...\"); startTime = System.currentTimeMillis(); // ä»äº¬ä¸œå›¾ä¹¦å¼€å§‹æŠ“ï¼Œå¼€å¯5ä¸ªçº¿ç¨‹ï¼Œå¯åŠ¨çˆ¬è™« Spider.create(new JDPageProcesser()).addUrl(\"https://book.jd.com/\").thread(3).run(); endTime = System.currentTimeMillis(); getAll(); System.out.println(\"ã€çˆ¬è™«ç»“æŸã€‘å…±æŠ“å–\" + size + \"æœ¬å›¾ä¹¦ï¼Œè€—æ—¶çº¦\" + ((endTime - startTime) / 1000) + \"ç§’ï¼Œå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¯·æŸ¥æ”¶ï¼\"); &#125;&#125; ä»¥åå°†ä¼šåšæŒæ›´æ–°!åé¦ˆä¸å»ºè®® é‚®ç®±ï¼š&#x63;&#97;&#111;&#x63;&#104;&#x69;&#107;&#x61;&#x69;&#64;&#x71;&#113;&#x2e;&#x63;&#111;&#x6d;","tags":[]},{"title":"My New Post","date":"2016-12-24T13:46:06.000Z","path":"2016/12/24/First Wirte/","text":"Markdownåˆæ¬¡ä½¿ç”¨Markdownæ˜¯ä¸€é—¨è½»é‡çº§è¯­æ³•,ä»…ä»…éœ€è¦5åˆ†é’Ÿä½ å°±èƒ½ææ‡‚! æœŸæœ«åˆ·jspä½œä¸šå¿ƒå¾— DAOå±‚å°è£…æˆå·¥å…·ç±» ï¼šæŒä¹…å±‚å¤„ç†ä¸šåŠ¡,å°½é‡æŠŠå˜åŒ–ä¸œè¥¿é‡‡ç”¨æ•°ç»„éå†,çº¦å®šæˆä¿—ç®€åŒ–æˆé…ç½®åŒ–å†™ï¼› ç™»é™†æ³¨å†Œæ¨¡å—é‡ç”¨ ï¼šå‰ç«¯æ ·å¼å˜åŒ–,ä½†å°½é‡ä¸è¦ä¿®æ”¹æäº¤å‚æ•°åç§°å’Œä¸ªæ•°ï¼› å•å…ƒæµ‹è¯•ç±» ï¼šä½¿ç”¨ junitæµ‹è¯•æ¡†æ¶æ£€æŸ¥é€»è¾‘æ˜¯å¦æœ‰è¯¯,æ–¹ä¾¿éƒ¨ç½²è°ƒè¯• ã€‚ ä»£ç å—1234567891011121314151617// æ‰§è¡Œæ›´æ–°æ“ä½œ----å¸¦é¢„ç¼–è¯‘å‚æ•°public int excuteUpdate(String sql, String[] params) &#123; int result = 0; try &#123; pstmt = getCon().prepareStatement(sql); for (int i = 0; i &lt; params.length; i++) &#123; pstmt.setString(i + 1, params[i]); &#125; result = pstmt.executeUpdate(); &#125; catch (SQLException e) &#123; e.printStackTrace(); &#125; finally &#123; pstmtClose(); conClose(); &#125; return result;&#125; ##ä»¥åå°†ä¼šæŒç»­æ›´æ–°,é¢„å‘Š webmagic æ¡†æ¶çˆ¬è™«ä¸‹æ¬¡å‡º åé¦ˆä¸å»ºè®® é‚®ç®±ï¼š&#99;&#97;&#x6f;&#x63;&#x68;&#x69;&#x6b;&#x61;&#x69;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;","tags":[]}]